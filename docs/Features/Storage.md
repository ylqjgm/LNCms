# 存储模块功能概述

此文档为手动编写文档，用以提供 AI 对存储模块功能进行了解，文档将对存储模块功能进行详细说明。

## 目录

- [模块概述](#模块概述)
- [开发技术](#开发技术)
  - [API 接口](#api-接口)
  - [gRPC 通信](#grpc-通信)
- [功能描述](#功能描述)
  - [1. 文件存储](#1-文件存储)
    - [1.1 文件上传](#11-文件上传)
    - [1.2 远程存储](#12-远程存储)
    - [1.3 文件迁移](#13-文件迁移)
  - [2. 文件预览](#2-文件预览)
  - [3. 文件管理](#3-文件管理)
  - [4. 统计数据](#4-统计数据)
  - [5. 健康检查](#5-健康检查)

## 模块概述

**Storage** 为程序存储模块，负责提供项目文件远端存储、转码、预览等功能。

## 开发技术

- **开发语言**: Golang 1.24+
- **开发框架**: Gin
- **数据库**: PostgreSQL
- **缓存**: Redis
- **API**: OpenAPI 3.1.1

### API 接口

- 对外提供 RESTful HTTP API 接口服务
- 所有 API 遵循 OpenAPI 3.1.1 规范
- 所有响应统一遵循 Envelope 响应格式
- 前端模块通过 RESTful HTTP API 接口与核心模块进行通信

### gRPC 通信

- 对外提供 gRPC 接口服务
- 核心模块、日志模块、采集模块通过 gRPC 接口与存储模块进行通信
- 模块间使用 gRPC 均支持双向通信

## 功能描述

### 1. 文件存储

#### 1.1 文件上传

前端用户通过核心模块将文件上传至存储模块中。
所有上传均遵循唯一性原则，同文件仅存储一份，数据库仅存储一条记录。

上传流程:

1. 上传初始化: 前端用户提交文件名称、文件大小、文件哈希值到后端初始化上传；
2. 唯一性检测: 后端通过所提交的哈希值进行查询，若存在相同文件，则实现秒传，返回已有文件信息，流程结束；
3. 缓存数据存储: 唯一性检测未通过，则自动生成上传ID信息，并将ID、文件名、文件大小、哈希值写入 Redis 缓存记录；
4. 返回初始化信息: 后端返回上传ID、上传类型（小文件上传、分片上传）；
5. 开始上传: 前端获取到初始化信息，使用初始化信息进行文件上传，同时依据返回的上传类型使用不同的上传接口；
6. 上传过程: 针对小文件上传与分片上传，拥有不同处理流程，小文件上传直接一次性上传即可；分片上传则会在前端将文件以每个文件2至10MB左右进行分片，每个分片上传时会同步提交分片哈希值；
7. 上传完成: 小文件上传完成后等待后端处理；分片上传完成后，前端发起分片合并请求，提交上传ID，后端通过上传ID查询缓存记录进行分片合并；
8. 文件校验: 上传或合并完成后，后端通过缓存中的哈希值进行文件校验，确保文件正确；
9. 文件处理: 根据核心模块中附件转码设置，后端检测文件是否需要进行转码，需要转码则添加至 Redis 队列进行排队处理；
10. 处理结束: 当文件转码结束，根据核心模块中的附件存储路径配置，自动将转码后的文件存储到对应路径；
11. 写入数据: 获取转码后的文件信息，并将数据写入数据库中，哈希值写入原始文件哈希值；
12. 返回数据: 将写入的数据信息返回前端，完成文件上传；
13. 进度查询: 在转码过程中，前端可通过上传ID进行转码进度查询，转码结束后会写入转码记录中。

#### 1.2 远程存储

采集模块通过远程提交文件到存储模块。

远程存储流程:

1. 接收请求: 采集模块通过远程下载方式，将采集到的文件临时存储到采集模块本地，并提交存储请求，提交文件名、文件大小、文件哈希值；
2. 唯一性检测: 存储模块通过所提交的哈希值进行查询，若存在相同文件，则实现秒传，返回已有文件信息，流程结束；
3. 缓存数据存储: 唯一性检测未通过，则自动生成上传ID信息，并将ID、文件名、文件大小、哈希值写入 Redis 缓存记录；
4. 请求回馈: 存储模块返回上传ID至采集模块；
5. 开始上传: 采集模块提交上传ID与上传文件进行上传；
6. 文件校验: 上传完成后，存储模块通过缓存中的哈希值进行文件校验，确保文件正确；
7. 文件处理: 根据核心模块中附件转码设置，后端检测文件是否需要进行转码，需要转码则添加至 Redis 队列进行排队处理；
8. 处理结束: 当文件转码结束，根据核心模块中的附件存储路径配置，自动将转码后的文件存储到对应路径；
9. 写入数据: 获取转码后的文件信息，并将数据写入数据库中，哈希值写入原始文件哈希值；
10. 完成通知: 将写入的数据信息通知采集模块，完成远程存储。

#### 1.3 文件迁移

针对现有的核心模块本地存储、云存储、其他存储模块数据，进行存储迁移。

文件迁移流程:

1. 接收请求: 存储模块接收核心模块发送的迁移请求，请求包括迁移类型（远端到本地、本地到远端）、远端连接信息、远端数据库信息、迁移文件列表、是否转码（仅远端到本地有效）、转码方式（同步转码、迁移后转码）等；
2. 连接远端: 通过核心模块发送的远端连接信息、远端数据库信息进行远程连接，验证连接可用性；
3. 初始化迁移: 生成迁移ID，并将迁移ID、迁移文件列表写入缓存；
4. 请求回馈: 返回迁移ID至核心模块；
5. 数据迁移: 存储模块先进行数据库迁移，并在迁移的同时修正为当前存储模块信息；
6. 文件迁移: 根据请求信息，存储模块进行文件迁移，文件迁移完成，会自动修改缓存中迁移文件列表对应文件状态；
7. 文件转码: 根据请求信息，若当前为远端到本地，且配置了转码请求，则进行文件转码，若为同步转码，则在文件迁移完成的同时，根据核心模块附件转码设置中的配置，同步提交此文件至队列排队，若为迁移后转码，则等待所有文件迁移完成后，再将需要转码的文件一次性提交至队列排队；
8. 转码完成: 文件转码完成后，自动对数据库中的文件信息进行修改，修改为新的文件信息；
9. 迁移完成: 等待所有文件转码结束，迁移正式完成；
10. 完成通知: 发送迁移成功信息至核心模块，结束本次文件迁移；
11. 进度查询: 核心模块可通过迁移ID对本次迁移进度进行查询。

### 2. 文件预览

通过 API 调用存储模块中的文件进行在线预览。

文件预览流程:

1. 接收请求: 核心模块通过 gRPC 获取存储模块文件预览链接；
2. 预览初始化: 存储模块根据配置的 API 地址，自动生成预览链接、时效 Token，完成链接组合，并将时效 Token 写入缓存；
3. 返回信息: 存储模块将预览链接、文件名称、文件类型返回核心模块，核心模块返回前端提供给前端使用；
4. 预览访问: 前端通过预览链接访问文件，存储模块接收到预览请求，获取时效 Token，并进行缓存查询，若 Token 时效则返回错误，否则返回文件信息；
5. 防文件下载: 前端访问预览链接时，存储模块进行安全验证，避免文件被直接下载。

### 3. 文件管理

通过核心模块对存储模块中的文件进行管理。

- 文件分页列表
- 文件查询
- 文件筛选
- 文件删除

### 4. 统计数据

通过核心模块对存储模块中的文件进行统计分析。

- 文件统计
- 文件分析
- 预览分析
- 空间分析

### 5. 健康检查

提供核心模块健康检查接口。

- 运行状态
- 存储状况
- 连接数值