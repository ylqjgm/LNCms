# 采集模块功能概述

此文档为手动编写文档，用以提供 AI 对采集模块功能进行了解，文档将对采集模块功能进行详细说明。

## 目录

- [模块概述](#模块概述)
- [开发技术](#开发技术)
  - [gRPC 通信](#grpc-通信)
- [功能描述](#功能描述)
  - [1. 规则管理](#1-规则管理)
    - [1.1 规则创建](#11-规则创建)
    - [1.2 规则编辑](#12-规则编辑)
    - [1.3 规则删除](#13-规则删除)
  - [2. 任务管理](#2-任务管理)
    - [2.1 任务创建](#21-任务创建)
    - [2.2 任务编辑](#22-任务编辑)
    - [2.3 任务删除](#23-任务删除)
  - [3. 进度管理](#3-进度管理)
  - [4. 采集统计](#4-采集统计)
  - [5. 健康检查](#5-健康检查)

## 模块概述

**Crawler** 为程序采集模块，负责提供远端信息采集、入库、远程文件下载等功能。

## 开发技术

- **开发语言**: Golang 1.24+
- **开发框架**: Gin
- **数据库**: PostgreSQL
- **缓存**: Redis

### gRPC 通信

- 对外提供 gRPC 接口服务
- 核心模块、存储模块、日志模块通过 gRPC 接口与采集模块进行通信
- 模块间使用 gRPC 均支持双向通信

## 功能描述

### 1. 规则管理

#### 1.1 规则创建

核心模块为采集模块创建采集规则。

规则创建流程:

1. 接收请求: 采集模块接收核心模块提交的规则创建请求，请求包含规则唯一名称、网站名称、网站地址；
2. 创建初始化: 采集模块接收到创建请求，将请求信息写入缓存，并返回创建成功信息；
3. 规则定制: 核心模块接收到创建反馈，开始制定规则，每次制定规则，均会发起一次规则验证请求；
4. 规则验证: 采集模块接收到规则验证请求，根据规则信息发起远程访问请求、数据处理等，并将最终处理结果反馈给核心模块以供确认；
5. 规则确认: 核心模块接收到规则验证数据，确认规则无误，发送规则确认请求，采集模块将此条规则写入缓存；
6. 规则完成: 核心模块完成所有规则创建后，发送规则完成请求，采集模块接收到请求，将缓存中的采集规则信息写入数据库，并返回完成信息。

特殊说明:

1. 流程记录: 采集规则以核心模块发起的规则定制顺序为标准，后续采集模块进行数据采集时，以此顺序完成数据采集；
2. 规则定制: 规则定制可为三种类型（发起请求、数据处理、文件下载），发起请求为对制定 URL 发起访问请求，获取远端 HTML 数据，数据处理则是对上一次的请求结果进行数据处理，文件下载则是对远程文件进行下载；
3. 标签处理: 才规则定制中，允许使用标签处理，通过使用 {$xxx} 的格式，可对获取到的结果进行数据替换、过滤、使用等，标签需要先制定标签名称及所代表的数据（可为采集到的数据），后续在使用标签时，自动将标签替换为对应数据进行使用；
4. 数据匹配: 采集模块使用特殊的占位符形式对远程数据进行匹配、获取，占位符有（`{{*}}`、`{{**}}`、`{{!}}`、`{{!!}}`、`{{~}}`、`{{~~}}`、`{{^}}`、`{{^^}}`、`{{$}}`、`{{$$}}`）
   - `{{*}}` 表示匹配任意字符串；
   - `{{**}}` 表示获取任意字符串；
   - `{{!}}` 表示匹配除了<和>以外的任意字符串；
   - `{{!!}}` 表示获取除了<和>以外的任意字符串；
   - `{{~}}` 表示匹配除了<>'"以外的任意字符串；
   - `{{~~}}` 表示获取除了<>'"以外的任意字符串;
   - `{{^}}` 表示匹配除了数字和<>之外字符串；
   - `{{^^}}` 表示获取除了数字和<>之外字符串；
   - `{{$}}` 表示匹配数字字符串；
   - `{{$$}}` 表示获取数字字符串。

#### 1.2 规则编辑

核心模块为采集模块修改采集规则。

采集规则修改流程与规则创建流程一致。

#### 1.3 规则删除

核心模块为采集模块删除采集规则。

### 2. 任务管理

#### 2.1 任务创建

核心模块为采集模块创建采集任务。

- 任务名称
- 采集规则
- 任务类型: 一次性任务、循环任务、定时任务
- 采集目标: 单一ID、批量ID、范围ID、页面列表、分页列表等
- 数据处理: 当远端数据与本地数据不一致，且无法自动处理时的操作方式；一般出现在分卷、分季、章节、分集列表，如本地小说与远端小说章节列表无法对应，可选挑过、清空本地重新采集等方式
- 文件处理: 选择是否将远端文件下载至本地（此处的本地，会根据核心模块中的附件配置，提交到对应的存储目的地）

#### 2.2 任务编辑

核心模块为采集模块编辑采集任务。

#### 2.3 任务删除

核心模块为采集模块删除采集任务。

### 3. 进度管理

核心模块可对任务执行情况进行管理。

- 进度查询
- 进度执行
- 进度暂停
- 进度终止

### 4. 采集统计

采集模块提供核心模块进行采集统计功能。

- 采集统计
- 采集分析

### 5. 健康检查

提供核心模块健康检查接口。

- 运行状态
- 连接数值