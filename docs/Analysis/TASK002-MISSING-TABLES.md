# TASK002 缺失数据库设计任务分析报告

## 文档信息

**分析时间**: 2026-01-03 08:58:06 CST  
**分析依据**: 
- [核心模块需求文档](../../Requirements/Core.md)
- [核心模块功能描述文档](../../Features/Core.md)
- [数据库设计任务文档](../TASKS/TASK002/TASK002.md)

## 分析概述

通过对比需求文档、功能描述文档和当前 TASK002.md 中的数据库设计任务，发现以下功能模块的数据库设计任务缺失：

1. **模块管理** - 完全缺失
2. **上架设置** - 完全缺失
3. **管理中心** - 完全缺失
4. **备份恢复** - 完全缺失

此外，在**互动管理**模块中，还缺少一些关联表的设计任务。

## 详细分析

### 1. 模块管理（缺失）

**功能描述**: 对系统模块进行管理，包括模块注册、启用、禁用和检查。

**需求文档位置**: `docs/Requirements/Core.md` 第 2 节

**需要的数据表**:

#### 1.1 模块表（modules）

**功能描述**: 存储系统模块信息

**字段需求**:
- 模块ID（主键）
- 模块名称
- 模块类型（存储模块、日志模块、采集模块等）
- 模块标识（唯一标识符）
- 模块地址（gRPC 服务地址）
- 模块状态（已注册、已启用、已禁用、未连接等）
- 模块版本
- 模块描述
- 注册时间
- 最后心跳时间
- 创建时间
- 更新时间

**建议任务编号**: TASK002-62

---

### 2. 上架设置（缺失）

**功能描述**: 对网站内作品上架后的收费标准和作者收益进行配置。

**需求文档位置**: `docs/Requirements/Core.md` 第 3 节

**需要的数据表**:

#### 2.1 付费规则表（pricing_rules）

**功能描述**: 存储读者阅读时的收费标准配置

**字段需求**:
- 规则ID（主键）
- 内容类型（小说、漫画、音频、视频）
- 收费类型（按字数、按章节、按图片、按时长等）
- 收费标准（数值，单位：消费货币）
- 规则状态（启用、禁用）
- 规则描述
- 创建时间
- 更新时间

**建议任务编号**: TASK002-63

#### 2.2 收益规则表（revenue_rules）

**功能描述**: 存储作者收益配置规则

**字段需求**:
- 规则ID（主键）
- 收益类型（全勤收益、订阅收益、阅读收益、收藏收益、票务收益、打赏收益、新手鼓励）
- 内容类型（小说、漫画、音频、视频）
- 规则配置（JSONB 类型，根据不同的收益类型存储不同的配置项）
  - 全勤收益：全勤类型、全勤天数、更新数量、收益金额
  - 订阅收益：订阅起点、收益金额
  - 阅读收益：收益比例
  - 收藏收益：收藏起点、收益金额
  - 票务收益：投票起点、收益比例
  - 打赏收益：收益比例
  - 新手鼓励：期限类型、期限数值、收益类型、收益激励
- 规则状态（启用、禁用）
- 规则描述
- 创建时间
- 更新时间

**建议任务编号**: TASK002-64

#### 2.3 结算设置表（settlement_configs）

**功能描述**: 存储作者结算周期配置

**字段需求**:
- 配置ID（主键）
- 内容类型（小说、漫画、音频、视频）
- 结算类型（按周期结算、按最低支付金额结算）
- 结算时间（JSONB，按周期结算时存储 Cron 表达式或具体时间）
- 最低支付金额（按最低支付金额结算时有效，单位：消费货币）
- 结算比例（每一元现实金额对应多少消费货币）
- 配置状态（启用、禁用）
- 创建时间
- 更新时间

**建议任务编号**: TASK002-65

---

### 3. 管理中心（缺失）

**功能描述**: 针对拥有管理权限的角色用户操作中心，包括组织架构管理、作者管理、作品管理、结算管理。

**需求文档位置**: `docs/Requirements/Core.md` 第 10 节

**需要的数据表**:

#### 3.1 组织架构表（organizations）

**功能描述**: 存储管理组织架构信息

**字段需求**:
- 架构ID（主键）
- 架构名称
- 所属上级（自关联，可为空表示顶级架构）
- 架构类型（部门、小组、个人等）
- 内容类型（小说、漫画、音频、视频，可为空表示通用）
- 架构负责人ID（关联用户表）
- 架构描述
- 排序顺序
- 创建时间
- 更新时间

**建议任务编号**: TASK002-66

#### 3.2 作者架构关联表（author_organizations）

**功能描述**: 存储作者与组织架构的关联关系

**字段需求**:
- 关联ID（主键）
- 作者ID（外键关联作者表）
- 架构ID（外键关联组织架构表）
- 分配时间
- 分配人员ID（关联用户表，记录是谁分配的作者）
- 备注
- 创建时间

**建议任务编号**: TASK002-67

#### 3.3 作品审核记录表（content_audits）

**功能描述**: 存储作品审核记录

**字段需求**:
- 审核ID（主键）
- 内容类型（小说、漫画、音频、视频）
- 内容ID（关联对应内容表）
- 审核类型（基本信息、分卷/分季、章节/分集、附件等）
- 审核状态（待审核、已通过、已拒绝）
- 审核人员ID（关联用户表）
- 审核时间
- 审核意见
- 创建时间
- 更新时间

**建议任务编号**: TASK002-68

#### 3.4 作品隐藏记录表（content_hides）

**功能描述**: 存储作品隐藏记录

**字段需求**:
- 隐藏ID（主键）
- 内容类型（小说、漫画、音频、视频）
- 内容ID（关联对应内容表）
- 隐藏类型（基本信息、分卷/分季、章节/分集、附件等）
- 隐藏说明
- 隐藏人员ID（关联用户表）
- 隐藏时间
- 解除时间
- 解除人员ID（关联用户表）
- 创建时间
- 更新时间

**建议任务编号**: TASK002-69

#### 3.5 推荐位表（recommend_positions）

**功能描述**: 存储推荐位信息

**字段需求**:
- 推荐位ID（主键）
- 推荐位名称
- 推荐位代码（唯一标识）
- 推荐位类型（首页推荐、分类推荐、排行榜等）
- 推荐位描述
- 排序顺序
- 创建时间
- 更新时间

**建议任务编号**: TASK002-70

#### 3.6 作品推荐关联表（content_recommendations）

**功能描述**: 存储作品与推荐位的关联关系

**字段需求**:
- 关联ID（主键）
- 内容类型（小说、漫画、音频、视频）
- 内容ID（关联对应内容表）
- 推荐位ID（外键关联推荐位表）
- 推荐顺序
- 推荐开始时间
- 推荐结束时间
- 推荐人员ID（关联用户表）
- 创建时间
- 更新时间

**建议任务编号**: TASK002-71

#### 3.7 结算审核记录表（settlement_audits）

**功能描述**: 存储作者结算审核记录

**字段需求**:
- 审核ID（主键）
- 作者ID（外键关联作者表）
- 结算周期开始时间
- 结算周期结束时间
- 结算金额（单位：消费货币）
- 实际支付金额（单位：现实货币）
- 审核级别（编辑审核、组长审核、部长审核）
- 审核状态（待审核、编辑已审核、组长已审核、部长已审核、已支付）
- 审核人员ID（关联用户表）
- 审核时间
- 审核意见
- 创建时间
- 更新时间

**建议任务编号**: TASK002-72

#### 3.8 结算变更记录表（settlement_changes）

**功能描述**: 存储结算变更记录

**字段需求**:
- 变更ID（主键）
- 结算审核ID（外键关联结算审核记录表）
- 变更类型（增加、减少）
- 变更金额（单位：消费货币）
- 变更原因
- 变更人员ID（关联用户表）
- 确认状态（待确认、已确认、已拒绝）
- 确认时间
- 创建时间
- 更新时间

**建议任务编号**: TASK002-73

---

### 4. 备份恢复（缺失）

**功能描述**: 提供数据备份和恢复功能。

**需求文档位置**: `docs/Requirements/Core.md` 第 11 节

**需要的数据表**:

#### 4.1 备份渠道表（backup_channels）

**功能描述**: 存储备份渠道配置

**字段需求**:
- 渠道ID（主键）
- 渠道名称
- 渠道类型（本地存储、存储模块、云存储、FTP服务器、SMB共享服务器、Rsync同步服务器）
- 渠道配置（JSONB，根据不同渠道类型存储不同配置）
- 渠道状态（启用、禁用）
- 创建时间
- 更新时间

**建议任务编号**: TASK002-74

#### 4.2 自动备份配置表（backup_configs）

**功能描述**: 存储自动备份配置

**字段需求**:
- 配置ID（主键）
- 配置名称
- 数据类型（数据备份、文件备份、选择备份、全量备份）
- 备份类型（一次性备份、定时备份）
- 定时设定（JSONB，定时备份时存储 Cron 表达式）
- 备份渠道ID（外键关联备份渠道表）
- 存储路径
- 备份保留次数
- 配置状态（启用、禁用）
- 最后备份时间
- 下次备份时间
- 创建时间
- 更新时间

**建议任务编号**: TASK002-75

#### 4.3 备份记录表（backup_records）

**功能描述**: 存储备份执行记录

**字段需求**:
- 记录ID（主键）
- 配置ID（外键关联自动备份配置表）
- 备份类型（手动备份、自动备份）
- 备份状态（进行中、已完成、已失败）
- 备份文件路径
- 备份文件大小
- 备份开始时间
- 备份结束时间
- 备份说明
- 错误信息
- 创建时间
- 更新时间

**建议任务编号**: TASK002-76

#### 4.4 恢复记录表（restore_records）

**功能描述**: 存储数据恢复记录

**字段需求**:
- 记录ID（主键）
- 备份记录ID（外键关联备份记录表）
- 恢复类型（数据恢复、文件恢复、选择恢复、全量恢复）
- 恢复目标（JSONB，根据恢复类型存储不同的目标配置）
- 恢复状态（进行中、已完成、已失败）
- 恢复开始时间
- 恢复结束时间
- 恢复说明
- 错误信息
- 操作人员ID（关联用户表）
- 创建时间
- 更新时间

**建议任务编号**: TASK002-77

---

### 5. 互动管理补充（部分缺失）

**功能描述**: 评论管理功能中，还需要一些关联表和统计表。

**需要的数据表**:

#### 5.1 订阅记录表（subscriptions）

**功能描述**: 存储用户订阅作品记录（用于收益计算）

**字段需求**:
- 订阅ID（主键）
- 用户ID（外键关联用户表）
- 内容类型（小说、漫画、音频、视频）
- 内容ID（关联对应内容表）
- 订阅状态（已订阅、已取消）
- 订阅开始时间
- 订阅结束时间
- 创建时间
- 更新时间

**建议任务编号**: TASK002-78

#### 5.2 收藏记录表（favorites）

**功能描述**: 存储用户收藏作品记录（用于收益计算）

**字段需求**:
- 收藏ID（主键）
- 用户ID（外键关联用户表）
- 内容类型（小说、漫画、音频、视频）
- 内容ID（关联对应内容表）
- 收藏时间
- 创建时间

**建议任务编号**: TASK002-79

#### 5.3 投票记录表（votes）

**功能描述**: 存储用户投票记录（用于收益计算）

**字段需求**:
- 投票ID（主键）
- 用户ID（外键关联用户表）
- 内容类型（小说、漫画、音频、视频）
- 内容ID（关联对应内容表）
- 票务ID（外键关联票务表，如果使用票务投票）
- 投票数量
- 投票时间
- 创建时间

**建议任务编号**: TASK002-80

#### 5.4 打赏记录表（tips）

**功能描述**: 存储用户打赏记录（用于收益计算）

**字段需求**:
- 打赏ID（主键）
- 用户ID（外键关联用户表）
- 内容类型（小说、漫画、音频、视频）
- 内容ID（关联对应内容表）
- 虚拟物品ID（外键关联虚拟物品表）
- 打赏数量
- 打赏金额（单位：消费货币）
- 打赏时间
- 创建时间

**建议任务编号**: TASK002-81

---

### 6. 消费管理补充（部分缺失）

**功能描述**: 消费管理功能中，还需要一些关联表。

**需要的数据表**:

#### 6.1 用户票务表（user_tickets）

**功能描述**: 存储用户拥有的票务记录

**字段需求**:
- 记录ID（主键）
- 用户ID（外键关联用户表）
- 票务ID（外键关联票务表）
- 获取方式（购买、自动获取等）
- 获取时间
- 过期时间
- 使用状态（未使用、已使用、已过期）
- 使用时间
- 创建时间
- 更新时间

**建议任务编号**: TASK002-82

#### 6.2 用户虚拟物品表（user_virtual_items）

**功能描述**: 存储用户拥有的虚拟物品记录

**字段需求**:
- 记录ID（主键）
- 用户ID（外键关联用户表）
- 虚拟物品ID（外键关联虚拟物品表）
- 获取方式（购买、赠送等）
- 获取时间
- 过期时间
- 使用状态（未使用、已使用、已过期）
- 使用时间
- 创建时间
- 更新时间

**建议任务编号**: TASK002-83

---

## 缺失任务汇总

### 核心模块数据库设计缺失（共 22 个任务）

1. **模块管理（1个任务）**
   - TASK002-62: 数据库设计 - 核心模块 - 模块表

2. **上架设置（3个任务）**
   - TASK002-63: 数据库设计 - 核心模块 - 付费规则表
   - TASK002-64: 数据库设计 - 核心模块 - 收益规则表
   - TASK002-65: 数据库设计 - 核心模块 - 结算设置表

3. **管理中心（8个任务）**
   - TASK002-66: 数据库设计 - 核心模块 - 组织架构表
   - TASK002-67: 数据库设计 - 核心模块 - 作者架构关联表
   - TASK002-68: 数据库设计 - 核心模块 - 作品审核记录表
   - TASK002-69: 数据库设计 - 核心模块 - 作品隐藏记录表
   - TASK002-70: 数据库设计 - 核心模块 - 推荐位表
   - TASK002-71: 数据库设计 - 核心模块 - 作品推荐关联表
   - TASK002-72: 数据库设计 - 核心模块 - 结算审核记录表
   - TASK002-73: 数据库设计 - 核心模块 - 结算变更记录表

4. **备份恢复（4个任务）**
   - TASK002-74: 数据库设计 - 核心模块 - 备份渠道表
   - TASK002-75: 数据库设计 - 核心模块 - 自动备份配置表
   - TASK002-76: 数据库设计 - 核心模块 - 备份记录表
   - TASK002-77: 数据库设计 - 核心模块 - 恢复记录表

5. **互动管理补充（4个任务）**
   - TASK002-78: 数据库设计 - 核心模块 - 订阅记录表
   - TASK002-79: 数据库设计 - 核心模块 - 收藏记录表
   - TASK002-80: 数据库设计 - 核心模块 - 投票记录表
   - TASK002-81: 数据库设计 - 核心模块 - 打赏记录表

6. **消费管理补充（2个任务）**
   - TASK002-82: 数据库设计 - 核心模块 - 用户票务表
   - TASK002-83: 数据库设计 - 核心模块 - 用户虚拟物品表

---

## 依赖关系分析

### 新任务的依赖关系

1. **TASK002-62**（模块表）
   - 依赖任务: 无

2. **TASK002-63**（付费规则表）
   - 依赖任务: 无

3. **TASK002-64**（收益规则表）
   - 依赖任务: 无

4. **TASK002-65**（结算设置表）
   - 依赖任务: 无

5. **TASK002-66**（组织架构表）
   - 依赖任务: TASK002-10（用户表）

6. **TASK002-67**（作者架构关联表）
   - 依赖任务: TASK002-13（作者表）、TASK002-66（组织架构表）

7. **TASK002-68**（作品审核记录表）
   - 依赖任务: TASK002-10（用户表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

8. **TASK002-69**（作品隐藏记录表）
   - 依赖任务: TASK002-10（用户表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

9. **TASK002-70**（推荐位表）
   - 依赖任务: 无

10. **TASK002-71**（作品推荐关联表）
    - 依赖任务: TASK002-10（用户表）、TASK002-70（推荐位表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

11. **TASK002-72**（结算审核记录表）
    - 依赖任务: TASK002-13（作者表）、TASK002-10（用户表）

12. **TASK002-73**（结算变更记录表）
    - 依赖任务: TASK002-72（结算审核记录表）、TASK002-10（用户表）

13. **TASK002-74**（备份渠道表）
    - 依赖任务: 无

14. **TASK002-75**（自动备份配置表）
    - 依赖任务: TASK002-74（备份渠道表）

15. **TASK002-76**（备份记录表）
    - 依赖任务: TASK002-75（自动备份配置表）

16. **TASK002-77**（恢复记录表）
    - 依赖任务: TASK002-76（备份记录表）、TASK002-10（用户表）

17. **TASK002-78**（订阅记录表）
    - 依赖任务: TASK002-10（用户表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

18. **TASK002-79**（收藏记录表）
    - 依赖任务: TASK002-10（用户表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

19. **TASK002-80**（投票记录表）
    - 依赖任务: TASK002-10（用户表）、TASK002-35（票务表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

20. **TASK002-81**（打赏记录表）
    - 依赖任务: TASK002-10（用户表）、TASK002-34（虚拟物品表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

21. **TASK002-82**（用户票务表）
    - 依赖任务: TASK002-10（用户表）、TASK002-35（票务表）

22. **TASK002-83**（用户虚拟物品表）
    - 依赖任务: TASK002-10（用户表）、TASK002-34（虚拟物品表）

---

## 影响评估

### 对现有任务的影响

1. **TASK002-51**（数据库迁移脚本 - 核心模块）
   - 需要更新，包含新增的 22 个表的迁移脚本

2. **TASK002-55 到 TASK002-60**（基础数据初始化脚本）
   - 可能需要添加新表的基础数据初始化脚本

### 对后续开发的影响

1. 这些缺失的表都是核心业务功能的基础，缺失会导致相关功能无法实现
2. 特别是**上架设置**和**管理中心**模块，是系统的重要功能模块
3. **备份恢复**功能对于生产环境的数据安全至关重要

---

## 建议

1. **立即补充缺失任务**: 建议尽快补充这 22 个缺失的数据库设计任务
2. **更新依赖关系**: 在 TASK002.md 中更新任务依赖关系
3. **调整任务顺序**: 根据依赖关系合理安排任务执行顺序
4. **更新迁移脚本**: 在 TASK002-51 中包含所有新增表的迁移脚本
5. **补充初始化脚本**: 根据需要为新增表创建基础数据初始化脚本

---

## 总结

经过详细分析，发现 TASK002.md 中缺少 **22 个核心模块数据库设计任务**，涉及：

- **模块管理**: 1 个任务
- **上架设置**: 3 个任务
- **管理中心**: 8 个任务
- **备份恢复**: 4 个任务
- **互动管理补充**: 4 个任务
- **消费管理补充**: 2 个任务

这些缺失的任务都是系统核心功能的重要基础，建议尽快补充完善。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 08:58:06 CST

