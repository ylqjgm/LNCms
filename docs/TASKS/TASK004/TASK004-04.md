# TASK004-04: 创建RoleService接口和实现

## 任务信息

**任务编号**: TASK004-04  
**父任务**: TASK004  
**任务名称**: 创建RoleService接口和实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:54:20 CST

## 任务描述

创建RoleService接口和实现，提供角色的业务逻辑处理。包括：1) 定义RoleService接口；2) 实现角色的创建、查询、更新、删除方法；3) 实现业务逻辑处理（输入验证、业务规则验证等）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK004-02: 实现RoleRepository接口和实现

## 实现指南

### 1. 定义RoleService接口

在 `internal/pkg/service/role_service.go` 文件中定义接口：

```go
package service

import (
    "context"
    "yourproject/internal/pkg/model"
)

// RoleService 角色服务接口
type RoleService interface {
    // GetByID 根据ID获取角色
    GetByID(ctx context.Context, id int64) (*model.Role, error)
    
    // GetAll 获取所有角色
    GetAll(ctx context.Context) ([]*model.Role, error)
    
    // Create 创建角色
    Create(ctx context.Context, req *CreateRoleRequest) (*model.Role, error)
    
    // Update 更新角色
    Update(ctx context.Context, id int64, req *UpdateRoleRequest) (*model.Role, error)
    
    // Delete 删除角色
    Delete(ctx context.Context, id int64) error
}

// CreateRoleRequest 创建角色请求
type CreateRoleRequest struct {
    RoleName        string  `json:"role_name" binding:"required,min=1,max=100"`
    RoleDescription *string `json:"role_description,omitempty"`
    IsActive        bool    `json:"is_active"`
}

// UpdateRoleRequest 更新角色请求
type UpdateRoleRequest struct {
    RoleName        string  `json:"role_name" binding:"required,min=1,max=100"`
    RoleDescription *string `json:"role_description,omitempty"`
    IsActive        bool    `json:"is_active"`
}
```

### 2. 实现roleService结构体

在同一个文件中实现角色服务：

```go
import (
    "context"
    "fmt"
    "yourproject/internal/pkg/model"
    "yourproject/internal/pkg/repository"
)

// roleService 角色服务实现
type roleService struct {
    roleRepo repository.RoleRepository
}

// NewRoleService 创建角色服务实例
func NewRoleService(roleRepo repository.RoleRepository) RoleService {
    return &roleService{
        roleRepo: roleRepo,
    }
}
```

### 3. 实现GetByID方法

实现根据ID获取角色的方法：

```go
// GetByID 根据ID获取角色
func (s *roleService) GetByID(ctx context.Context, id int64) (*model.Role, error) {
    if id <= 0 {
        return nil, fmt.Errorf("角色ID无效")
    }
    
    role, err := s.roleRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("获取角色失败: %w", err)
    }
    
    return role, nil
}
```

### 4. 实现GetAll方法

实现获取所有角色的方法：

```go
// GetAll 获取所有角色
func (s *roleService) GetAll(ctx context.Context) ([]*model.Role, error) {
    roles, err := s.roleRepo.GetAll(ctx)
    if err != nil {
        return nil, fmt.Errorf("获取角色列表失败: %w", err)
    }
    
    return roles, nil
}
```

### 5. 实现Create方法

实现创建角色的方法，包含输入验证和业务规则验证：

```go
// Create 创建角色
func (s *roleService) Create(ctx context.Context, req *CreateRoleRequest) (*model.Role, error) {
    // 输入验证
    if err := s.validateCreateRequest(req); err != nil {
        return nil, err
    }
    
    // 检查角色名称是否已存在
    existing, err := s.roleRepo.GetByRoleName(ctx, req.RoleName)
    if err == nil && existing != nil {
        return nil, fmt.Errorf("角色名称已存在")
    }
    
    // 创建角色
    role := &model.Role{
        RoleName:        req.RoleName,
        RoleDescription: req.RoleDescription,
        IsActive:        req.IsActive,
        IsSystem:        false, // 新建角色默认为非系统角色
    }
    
    if err := s.roleRepo.Create(ctx, role); err != nil {
        return nil, fmt.Errorf("创建角色失败: %w", err)
    }
    
    return role, nil
}

// validateCreateRequest 验证创建请求
func (s *roleService) validateCreateRequest(req *CreateRoleRequest) error {
    if req == nil {
        return fmt.Errorf("请求参数不能为空")
    }
    if req.RoleName == "" {
        return fmt.Errorf("角色名称不能为空")
    }
    if len(req.RoleName) > 100 {
        return fmt.Errorf("角色名称长度不能超过100个字符")
    }
    return nil
}
```

### 6. 实现Update方法

实现更新角色的方法：

```go
// Update 更新角色
func (s *roleService) Update(ctx context.Context, id int64, req *UpdateRoleRequest) (*model.Role, error) {
    if id <= 0 {
        return nil, fmt.Errorf("角色ID无效")
    }
    
    // 输入验证
    if err := s.validateUpdateRequest(req); err != nil {
        return nil, err
    }
    
    // 检查角色是否存在
    role, err := s.roleRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("角色不存在")
    }
    
    // 检查是否为系统角色（系统角色不允许修改）
    if role.IsSystem {
        return nil, fmt.Errorf("系统角色不允许修改")
    }
    
    // 检查角色名称是否与其他角色重复
    existing, err := s.roleRepo.GetByRoleName(ctx, req.RoleName)
    if err == nil && existing != nil && existing.ID != id {
        return nil, fmt.Errorf("角色名称已存在")
    }
    
    // 更新角色
    role.RoleName = req.RoleName
    role.RoleDescription = req.RoleDescription
    role.IsActive = req.IsActive
    
    if err := s.roleRepo.Update(ctx, role); err != nil {
        return nil, fmt.Errorf("更新角色失败: %w", err)
    }
    
    return role, nil
}

// validateUpdateRequest 验证更新请求
func (s *roleService) validateUpdateRequest(req *UpdateRoleRequest) error {
    if req == nil {
        return fmt.Errorf("请求参数不能为空")
    }
    if req.RoleName == "" {
        return fmt.Errorf("角色名称不能为空")
    }
    if len(req.RoleName) > 100 {
        return fmt.Errorf("角色名称长度不能超过100个字符")
    }
    return nil
}
```

### 7. 实现Delete方法

实现删除角色的方法：

```go
// Delete 删除角色
func (s *roleService) Delete(ctx context.Context, id int64) error {
    if id <= 0 {
        return fmt.Errorf("角色ID无效")
    }
    
    // 检查角色是否存在
    role, err := s.roleRepo.GetByID(ctx, id)
    if err != nil {
        return fmt.Errorf("角色不存在")
    }
    
    // 检查是否为系统角色（系统角色不允许删除）
    if role.IsSystem {
        return fmt.Errorf("系统角色不允许删除")
    }
    
    // 删除角色
    if err := s.roleRepo.Delete(ctx, id); err != nil {
        return fmt.Errorf("删除角色失败: %w", err)
    }
    
    return nil
}
```

### 8. 代码规范要求

- 所有错误消息使用中文
- 实现输入验证和业务规则验证
- 使用context.Context传递上下文
- 所有方法都有清晰的注释（使用中文）
- 业务逻辑与数据访问分离

## 验收标准

1. **接口定义完整**
   - RoleService接口包含所有必需的方法
   - 请求结构体定义完整，包含验证标签
   - 接口注释完整，使用中文

2. **业务逻辑实现完整**
   - 所有接口方法都有对应的实现
   - 实现了输入验证逻辑
   - 实现了业务规则验证（如系统角色不允许删除、角色名称唯一性检查等）
   - 错误处理正确，错误消息使用中文

3. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范
   - 业务逻辑与数据访问层分离

4. **功能正确性**
   - GetByID方法正确处理参数验证和错误
   - GetAll方法正确返回角色列表
   - Create方法正确验证输入并创建角色
   - Update方法正确验证输入并更新角色（包括系统角色检查）
   - Delete方法正确验证并删除角色（包括系统角色检查）

## 相关文件

- `internal/pkg/service/role_service.go` - 角色服务接口和实现
- `internal/pkg/repository/role_repository.go` - 角色仓储接口
- `docs/TASKS/TASK004/TASK004-02.md` - 实现RoleRepository接口任务文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 14:54:20 CST

