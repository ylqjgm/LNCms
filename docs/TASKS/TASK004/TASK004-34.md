# TASK004-34: 创建AuthorLevelService接口和实现

## 任务信息

**任务编号**: TASK004-34  
**父任务**: TASK004  
**任务名称**: 创建AuthorLevelService接口和实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:34:33 CST

## 任务描述

创建AuthorLevelService接口和实现，提供作者等级的业务逻辑处理。包括：1) 定义AuthorLevelService接口；2) 实现作者等级的创建、查询、更新、删除方法；3) 实现业务逻辑处理（输入验证、作者等级达成条件验证等）；4) 实现作者等级达成条件的解析和验证逻辑。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK004-31: 实现作者等级达成条件枚举和常量定义
- TASK004-32: 实现AuthorLevelRepository接口和实现

## 实现指南

### 1. 定义AuthorLevelService接口

在 `internal/pkg/service/author_level_service.go` 文件中定义接口：

```go
package service

import (
    "context"
    "yourproject/internal/pkg/model"
)

// AuthorLevelService 作者等级服务接口
type AuthorLevelService interface {
    // GetByID 根据ID获取作者等级
    GetByID(ctx context.Context, id int64) (*model.AuthorLevel, error)
    
    // GetAll 获取所有作者等级
    GetAll(ctx context.Context) ([]*model.AuthorLevel, error)
    
    // Create 创建作者等级
    Create(ctx context.Context, req *CreateAuthorLevelRequest) (*model.AuthorLevel, error)
    
    // Update 更新作者等级
    Update(ctx context.Context, id int64, req *UpdateAuthorLevelRequest) (*model.AuthorLevel, error)
    
    // Delete 删除作者等级
    Delete(ctx context.Context, id int64) error
}

// CreateAuthorLevelRequest 创建作者等级请求
type CreateAuthorLevelRequest struct {
    Name        string                        `json:"name" binding:"required,min=1,max=100"`
    Description *string                       `json:"description,omitempty"`
    Conditions  model.AuthorLevelConditions   `json:"conditions" binding:"required"`
}

// UpdateAuthorLevelRequest 更新作者等级请求
type UpdateAuthorLevelRequest struct {
    Name        string                        `json:"name" binding:"required,min=1,max=100"`
    Description *string                       `json:"description,omitempty"`
    Conditions  model.AuthorLevelConditions   `json:"conditions" binding:"required"`
}
```

### 2. 实现authorLevelService结构体

在同一个文件中实现作者等级服务：

```go
import (
    "context"
    "fmt"
    "yourproject/internal/pkg/enum"
    "yourproject/internal/pkg/model"
    "yourproject/internal/pkg/repository"
    "yourproject/internal/pkg/constant"
)

// authorLevelService 作者等级服务实现
type authorLevelService struct {
    authorLevelRepo repository.AuthorLevelRepository
}

// NewAuthorLevelService 创建作者等级服务实例
func NewAuthorLevelService(authorLevelRepo repository.AuthorLevelRepository) AuthorLevelService {
    return &authorLevelService{
        authorLevelRepo: authorLevelRepo,
    }
}
```

### 3. 实现GetByID方法

实现根据ID获取作者等级的方法：

```go
// GetByID 根据ID获取作者等级
func (s *authorLevelService) GetByID(ctx context.Context, id int64) (*model.AuthorLevel, error) {
    if id <= 0 {
        return nil, fmt.Errorf("作者等级ID无效")
    }
    
    authorLevel, err := s.authorLevelRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("获取作者等级失败: %w", err)
    }
    
    return authorLevel, nil
}
```

### 4. 实现GetAll方法

实现获取所有作者等级的方法：

```go
// GetAll 获取所有作者等级
func (s *authorLevelService) GetAll(ctx context.Context) ([]*model.AuthorLevel, error) {
    authorLevels, err := s.authorLevelRepo.GetAll(ctx)
    if err != nil {
        return nil, fmt.Errorf("获取作者等级列表失败: %w", err)
    }
    
    return authorLevels, nil
}
```

### 5. 实现Create方法

实现创建作者等级的方法，包含输入验证和作者等级达成条件验证：

```go
// Create 创建作者等级
func (s *authorLevelService) Create(ctx context.Context, req *CreateAuthorLevelRequest) (*model.AuthorLevel, error) {
    // 输入验证
    if err := s.validateCreateRequest(req); err != nil {
        return nil, err
    }
    
    // 验证作者等级达成条件
    if err := s.validateAuthorLevelConditions(req.Conditions); err != nil {
        return nil, err
    }
    
    // 检查作者等级名称是否已存在
    existing, err := s.authorLevelRepo.GetByName(ctx, req.Name)
    if err == nil && existing != nil {
        return nil, fmt.Errorf("作者等级名称已存在")
    }
    
    // 创建作者等级
    authorLevel := &model.AuthorLevel{
        Name:        req.Name,
        Description: req.Description,
        Conditions:  req.Conditions,
    }
    
    if err := s.authorLevelRepo.Create(ctx, authorLevel); err != nil {
        return nil, fmt.Errorf("创建作者等级失败: %w", err)
    }
    
    return authorLevel, nil
}
```

### 6. 实现Update方法

实现更新作者等级的方法：

```go
// Update 更新作者等级
func (s *authorLevelService) Update(ctx context.Context, id int64, req *UpdateAuthorLevelRequest) (*model.AuthorLevel, error) {
    if id <= 0 {
        return nil, fmt.Errorf("作者等级ID无效")
    }
    
    // 输入验证
    if err := s.validateUpdateRequest(req); err != nil {
        return nil, err
    }
    
    // 验证作者等级达成条件
    if err := s.validateAuthorLevelConditions(req.Conditions); err != nil {
        return nil, err
    }
    
    // 检查作者等级是否存在
    existing, err := s.authorLevelRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("作者等级不存在")
    }
    
    // 检查名称是否与其他作者等级冲突
    if req.Name != existing.Name {
        nameExists, err := s.authorLevelRepo.GetByName(ctx, req.Name)
        if err == nil && nameExists != nil && nameExists.ID != id {
            return nil, fmt.Errorf("作者等级名称已存在")
        }
    }
    
    // 更新作者等级
    existing.Name = req.Name
    existing.Description = req.Description
    existing.Conditions = req.Conditions
    
    if err := s.authorLevelRepo.Update(ctx, existing); err != nil {
        return nil, fmt.Errorf("更新作者等级失败: %w", err)
    }
    
    return existing, nil
}
```

### 7. 实现Delete方法

实现删除作者等级的方法：

```go
// Delete 删除作者等级
func (s *authorLevelService) Delete(ctx context.Context, id int64) error {
    if id <= 0 {
        return fmt.Errorf("作者等级ID无效")
    }
    
    // 检查作者等级是否存在
    _, err := s.authorLevelRepo.GetByID(ctx, id)
    if err != nil {
        return fmt.Errorf("作者等级不存在")
    }
    
    // 删除作者等级
    if err := s.authorLevelRepo.Delete(ctx, id); err != nil {
        return fmt.Errorf("删除作者等级失败: %w", err)
    }
    
    return nil
}
```

### 8. 实现验证方法

实现输入验证和作者等级达成条件验证方法：

```go
// validateCreateRequest 验证创建请求
func (s *authorLevelService) validateCreateRequest(req *CreateAuthorLevelRequest) error {
    if req.Name == "" {
        return fmt.Errorf("作者等级名称不能为空")
    }
    
    if len(req.Name) < constant.MinAuthorLevelNameLength || len(req.Name) > constant.MaxAuthorLevelNameLength {
        return fmt.Errorf("作者等级名称长度必须在%d-%d个字符之间", constant.MinAuthorLevelNameLength, constant.MaxAuthorLevelNameLength)
    }
    
    if req.Description != nil && len(*req.Description) > constant.MaxAuthorLevelDescriptionLength {
        return fmt.Errorf("作者等级描述长度不能超过%d个字符", constant.MaxAuthorLevelDescriptionLength)
    }
    
    return nil
}

// validateUpdateRequest 验证更新请求
func (s *authorLevelService) validateUpdateRequest(req *UpdateAuthorLevelRequest) error {
    return s.validateCreateRequest(&CreateAuthorLevelRequest{
        Name:        req.Name,
        Description: req.Description,
        Conditions:  req.Conditions,
    })
}

// validateAuthorLevelConditions 验证作者等级达成条件
func (s *authorLevelService) validateAuthorLevelConditions(conditions model.AuthorLevelConditions) error {
    // 验证条件类型
    conditionType := enum.AuthorLevelConditionType(conditions.ConditionType)
    if !conditionType.IsValid() {
        return fmt.Errorf("无效的作者等级达成条件类型: %s", conditions.ConditionType)
    }
    
    // 验证条件值
    if conditions.ConditionValue < constant.MinAuthorLevelConditionValue {
        return fmt.Errorf("作者等级达成条件值不能小于%d", constant.MinAuthorLevelConditionValue)
    }
    
    if conditions.ConditionValue > constant.MaxAuthorLevelConditionValue {
        return fmt.Errorf("作者等级达成条件值不能大于%d", constant.MaxAuthorLevelConditionValue)
    }
    
    // 如果是平均评分类型，验证评分范围
    if conditionType == enum.AuthorLevelConditionTypeAvgRating {
        rating := float64(conditions.ConditionValue) / 10.0 // 假设存储为整数，需要除以10
        if rating < constant.MinAuthorLevelAvgRating || rating > constant.MaxAuthorLevelAvgRating {
            return fmt.Errorf("平均评分必须在%.1f-%.1f之间", constant.MinAuthorLevelAvgRating, constant.MaxAuthorLevelAvgRating)
        }
    }
    
    return nil
}
```

### 9. 代码规范要求

- 所有错误消息使用中文
- 使用context.Context传递上下文
- 实现完整的输入验证
- 实现作者等级达成条件的验证逻辑
- 检查名称唯一性
- 所有方法都有清晰的注释（使用中文）

## 验收标准

1. **接口定义完整**
   - AuthorLevelService接口包含所有必需的方法：GetByID、GetAll、Create、Update、Delete
   - 定义了CreateAuthorLevelRequest和UpdateAuthorLevelRequest结构体
   - 接口注释完整，使用中文

2. **实现完整**
   - authorLevelService结构体正确实现AuthorLevelService接口
   - 所有接口方法都有对应的实现
   - 实现了输入验证逻辑
   - 实现了作者等级达成条件验证逻辑

3. **错误处理正确**
   - 所有错误都使用中文错误消息
   - 错误消息清晰，包含上下文信息
   - 正确处理各种异常情况

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范
   - 遵循项目代码组织结构

5. **功能正确性**
   - GetByID方法正确获取作者等级
   - GetAll方法正确返回所有作者等级列表
   - Create方法正确创建作者等级（包括验证）
   - Update方法正确更新作者等级（包括验证）
   - Delete方法正确删除作者等级
   - 作者等级达成条件验证逻辑正确

## 相关文件

- `internal/pkg/service/author_level_service.go` - 作者等级服务接口和实现
- `internal/pkg/repository/author_level_repository.go` - 作者等级仓储接口
- `internal/pkg/model/author_level.go` - 作者等级模型定义
- `internal/pkg/enum/author_level_condition_type.go` - 作者等级达成条件类型枚举
- `internal/pkg/constant/author_level.go` - 作者等级相关常量
- `docs/TASKS/TASK004/TASK004-31.md` - 实现作者等级达成条件枚举任务文档
- `docs/TASKS/TASK004/TASK004-32.md` - 实现AuthorLevelRepository任务文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:34:33 CST

