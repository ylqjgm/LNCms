# TASK004-47: 创建PermissionHandler接口和实现

## 任务信息

**任务编号**: TASK004-47  
**父任务**: TASK004  
**任务名称**: 创建PermissionHandler接口和实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:00:00 CST

## 任务描述

创建PermissionHandler接口和实现，提供权限的HTTP API处理。包括：1) 定义PermissionHandler接口；2) 实现获取权限列表HTTP处理函数（GET /api/v1/permissions）；3) 实现获取组权限HTTP处理函数（GET /api/v1/permissions/groups/{group_id}）；4) 实现更新组权限HTTP处理函数（PUT /api/v1/permissions/groups/{group_id}）；5) 实现请求参数绑定和响应格式化（Envelope格式）。所有代码必须遵循Golang编码规范和API设计规范，错误消息使用中文。

## 依赖任务

- TASK004-45: 创建PermissionService接口和实现

## 实现指南

### 1. 定义PermissionHandler接口

在 `internal/pkg/handler/permission_handler.go` 文件中定义接口：

```go
package handler

import (
    "github.com/gin-gonic/gin"
)

// PermissionHandler 权限处理器接口
type PermissionHandler interface {
    // GetPermissions 获取权限列表
    GetPermissions(c *gin.Context)
    
    // GetGroupPermissions 获取用户组权限列表
    GetGroupPermissions(c *gin.Context)
    
    // UpdateGroupPermissions 更新用户组权限
    UpdateGroupPermissions(c *gin.Context)
}
```

### 2. 实现permissionHandler结构体

在同一个文件中实现权限处理器：

```go
import (
    "net/http"
    "strconv"
    
    "github.com/gin-gonic/gin"
    "yourproject/internal/pkg/service"
    "yourproject/pkg/response"
)

// permissionHandler 权限处理器实现
type permissionHandler struct {
    permissionService service.PermissionService
}

// NewPermissionHandler 创建权限处理器实例
func NewPermissionHandler(permissionService service.PermissionService) PermissionHandler {
    return &permissionHandler{
        permissionService: permissionService,
    }
}
```

### 3. 实现GetPermissions方法

实现获取权限列表的HTTP处理函数：

```go
// GetPermissions 获取权限列表
// @Summary 获取权限列表
// @Description 获取所有权限列表
// @Tags 权限管理
// @Accept json
// @Produce json
// @Success 200 {object} response.Envelope "成功响应"
// @Failure 500 {object} response.Envelope "服务器内部错误"
// @Router /api/v1/permissions [get]
func (h *permissionHandler) GetPermissions(c *gin.Context) {
    permissions, err := h.permissionService.GetAll(c.Request.Context())
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "INTERNAL_ERROR", err.Error(), nil)
        return
    }
    
    response.Success(c, http.StatusOK, permissions)
}
```

### 4. 实现GetGroupPermissions方法

实现获取用户组权限列表的HTTP处理函数：

```go
// GetGroupPermissions 获取用户组权限列表
// @Summary 获取用户组权限列表
// @Description 根据用户组ID获取权限列表
// @Tags 权限管理
// @Accept json
// @Produce json
// @Param group_id path int true "用户组ID"
// @Success 200 {object} response.Envelope "成功响应"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 404 {object} response.Envelope "用户组不存在"
// @Failure 500 {object} response.Envelope "服务器内部错误"
// @Router /api/v1/permissions/groups/{group_id} [get]
func (h *permissionHandler) GetGroupPermissions(c *gin.Context) {
    groupIDStr := c.Param("group_id")
    groupID, err := strconv.ParseInt(groupIDStr, 10, 64)
    if err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_PARAM", "用户组ID无效", nil)
        return
    }
    
    permissions, err := h.permissionService.GetUserGroupPermissions(c.Request.Context(), groupID)
    if err != nil {
        if err.Error() == "用户组ID无效" {
            response.Error(c, http.StatusBadRequest, "INVALID_PARAM", err.Error(), nil)
            return
        }
        response.Error(c, http.StatusInternalServerError, "INTERNAL_ERROR", err.Error(), nil)
        return
    }
    
    response.Success(c, http.StatusOK, permissions)
}
```

### 5. 实现UpdateGroupPermissions方法

实现更新用户组权限的HTTP处理函数：

```go
// UpdateGroupPermissions 更新用户组权限
// @Summary 更新用户组权限
// @Description 更新用户组的权限列表
// @Tags 权限管理
// @Accept json
// @Produce json
// @Param group_id path int true "用户组ID"
// @Param request body UpdateGroupPermissionsRequest true "更新用户组权限请求"
// @Success 200 {object} response.Envelope "更新成功"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 404 {object} response.Envelope "用户组不存在"
// @Failure 500 {object} response.Envelope "服务器内部错误"
// @Router /api/v1/permissions/groups/{group_id} [put]
func (h *permissionHandler) UpdateGroupPermissions(c *gin.Context) {
    groupIDStr := c.Param("group_id")
    groupID, err := strconv.ParseInt(groupIDStr, 10, 64)
    if err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_PARAM", "用户组ID无效", nil)
        return
    }
    
    var req UpdateGroupPermissionsRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_PARAM", "请求参数错误", nil)
        return
    }
    
    // 更新用户组权限（先移除所有权限，再添加新权限）
    // 获取当前权限
    currentPermissions, err := h.permissionService.GetUserGroupPermissions(c.Request.Context(), groupID)
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "INTERNAL_ERROR", err.Error(), nil)
        return
    }
    
    // 获取要移除的权限ID
    currentPermissionIDs := make([]int64, 0, len(currentPermissions))
    for _, p := range currentPermissions {
        currentPermissionIDs = append(currentPermissionIDs, p.ID)
    }
    
    // 移除所有现有权限
    if len(currentPermissionIDs) > 0 {
        if err := h.permissionService.RemovePermissionsFromUserGroup(c.Request.Context(), groupID, currentPermissionIDs); err != nil {
            response.Error(c, http.StatusInternalServerError, "INTERNAL_ERROR", err.Error(), nil)
            return
        }
    }
    
    // 添加新权限
    if len(req.PermissionIDs) > 0 {
        if err := h.permissionService.AssignPermissionsToUserGroup(c.Request.Context(), groupID, req.PermissionIDs); err != nil {
            response.Error(c, http.StatusInternalServerError, "INTERNAL_ERROR", err.Error(), nil)
            return
        }
    }
    
    // 返回更新后的权限列表
    permissions, err := h.permissionService.GetUserGroupPermissions(c.Request.Context(), groupID)
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "INTERNAL_ERROR", err.Error(), nil)
        return
    }
    
    response.Success(c, http.StatusOK, permissions)
}

// UpdateGroupPermissionsRequest 更新用户组权限请求
type UpdateGroupPermissionsRequest struct {
    PermissionIDs []int64 `json:"permission_ids" binding:"required"`
}
```

### 6. 代码规范要求

- 所有错误消息使用中文
- 使用Envelope格式返回响应
- 使用适当的HTTP状态码
- 实现请求参数验证
- 使用Gin的ShouldBindJSON绑定JSON请求体
- 所有方法都有Swagger注释
- 遵循OpenAPI 3.1.1规范

## 验收标准

1. **接口定义完整**
   - PermissionHandler接口包含所有必需的方法
   - 接口注释完整，使用中文

2. **HTTP处理函数实现完整**
   - 所有接口方法都有对应的HTTP处理函数实现
   - 正确解析路径参数和请求体
   - 正确调用Service层方法
   - 正确格式化响应（Envelope格式）

3. **错误处理正确**
   - 所有错误都使用中文错误消息
   - 使用适当的HTTP状态码
   - 错误响应符合Envelope格式

4. **API规范符合要求**
   - 遵循OpenAPI 3.1.1规范
   - 所有接口都有Swagger注释
   - 响应格式符合Envelope格式
   - 路径参数和请求体验证正确

5. **代码规范符合要求**
   - 代码通过golangci-lint检查
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/handler/permission_handler.go` - 权限处理器接口和实现
- `internal/pkg/service/permission_service.go` - 权限服务接口
- `pkg/response/response.go` - 响应格式化工具
- `docs/TASKS/TASK004/TASK004-45.md` - 创建PermissionService接口任务文档
- `.cursor/rules/api-design.mdc` - API设计规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:00:00 CST

