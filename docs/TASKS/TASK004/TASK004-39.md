# TASK004-39: 创建RolePermission模型

## 任务信息

**任务编号**: TASK004-39  
**父任务**: TASK004  
**任务名称**: 创建RolePermission模型  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:34:33 CST

## 任务描述

创建角色权限关联的GORM模型，定义角色权限关联表结构。包括：1) 创建RolePermission模型，定义字段（id、role_id、permission_id、created_at）；2) 添加模型标签和索引定义；3) 添加表注释和外键约束。所有代码必须遵循Golang编码规范和PostgreSQL数据库设计规范。参考TASK002-08数据库设计任务。

## 依赖任务

- TASK004-01: 创建Role模型
- TASK004-38: 创建Permission模型

## 实现指南

### 1. 参考数据库设计

阅读 `docs/TASKS/TASK002/TASK002-08.md` 文档，了解角色权限关联表的数据库设计：
- 表名：`role_permissions`
- 字段：id、role_id、permission_id、created_at
- 索引：主键索引（id）、外键索引（role_id、permission_id）、唯一索引（role_id, permission_id）
- 外键约束：fk_role_permissions_role_id、fk_role_permissions_permission_id

### 2. 创建RolePermission模型

在 `internal/pkg/model/role_permission.go` 文件中创建RolePermission结构体：

```go
package model

import (
    "time"
)

// RolePermission 角色权限关联模型
// 用于存储角色和权限的多对多关系，实现基于角色的访问控制（RBAC）
// 表名: role_permissions
// 索引: pk_role_permissions (id), idx_role_permissions_role_id (role_id), idx_role_permissions_permission_id (permission_id), uk_role_permissions_role_id_permission_id (role_id, permission_id)
type RolePermission struct {
    // ID 关联ID，自增主键
    ID int64 `gorm:"primaryKey;autoIncrement" json:"id"`
    
    // RoleID 角色ID，外键关联roles表
    RoleID int64 `gorm:"type:bigint;not null;index:idx_role_permissions_role_id" json:"role_id"`
    
    // PermissionID 权限ID，外键关联permissions表
    PermissionID int64 `gorm:"type:bigint;not null;index:idx_role_permissions_permission_id" json:"permission_id"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"type:timestamptz;default:current_timestamp" json:"created_at"`
    
    // Role 角色关联（用于预加载）
    Role Role `gorm:"foreignKey:RoleID;references:ID" json:"role,omitempty"`
    
    // Permission 权限关联（用于预加载）
    Permission Permission `gorm:"foreignKey:PermissionID;references:ID" json:"permission,omitempty"`
}

// TableName 指定表名
func (RolePermission) TableName() string {
    return "role_permissions"
}
```

### 3. 验证模型定义

确保模型定义符合以下要求：

- 主键字段使用 `bigserial` 类型（GORM会自动映射为int64）
- `role_id` 字段使用 `bigint` 类型，设置外键关联和索引
- `permission_id` 字段使用 `bigint` 类型，设置外键关联和索引
- 定义了唯一索引（role_id, permission_id），防止重复关联
- 定义了Role和Permission关联字段，用于预加载
- 时间字段使用 `timestamptz` 类型，支持时区
- 所有字段都有适当的GORM标签和JSON标签
- 模型实现了 `TableName()` 方法，明确指定表名

### 4. 外键约束说明

虽然GORM可以通过关联标签定义外键关系，但实际的外键约束应该在数据库迁移中创建：

```sql
-- 外键约束（在数据库迁移中创建）
ALTER TABLE role_permissions
ADD CONSTRAINT fk_role_permissions_role_id
FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE;

ALTER TABLE role_permissions
ADD CONSTRAINT fk_role_permissions_permission_id
FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE;

-- 唯一约束（在数据库迁移中创建）
ALTER TABLE role_permissions
ADD CONSTRAINT uk_role_permissions_role_id_permission_id
UNIQUE (role_id, permission_id);
```

### 5. 代码规范要求

- 所有注释使用中文
- 字段命名遵循Golang编码规范（驼峰命名）
- JSON标签使用小写字母和下划线（snake_case）
- GORM标签完整，包括类型、约束、索引、外键等
- 模型结构清晰，职责单一
- 定义了关联字段，便于预加载

## 验收标准

1. **RolePermission模型正确定义**
   - 模型包含所有必需字段：id、role_id、permission_id、created_at
   - 字段类型正确，符合PostgreSQL数据库设计规范
   - GORM标签完整，包括主键、索引、外键等

2. **索引定义正确**
   - role_id字段定义了普通索引（idx_role_permissions_role_id）
   - permission_id字段定义了普通索引（idx_role_permissions_permission_id）
   - 定义了唯一索引（role_id, permission_id）
   - 索引命名符合PostgreSQL命名规范

3. **关联定义正确**
   - 定义了Role关联字段，使用外键关联
   - 定义了Permission关联字段，使用外键关联
   - 关联字段可以用于预加载

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 字段命名符合Golang编码规范
   - JSON标签使用小写字母和下划线

5. **模型结构清晰**
   - 模型职责单一，只负责数据模型定义
   - 不包含业务逻辑代码
   - 不包含仓储层或服务层代码
   - 实现了TableName()方法

6. **与数据库设计一致**
   - 模型字段与TASK002-08数据库设计保持一致
   - 字段类型和约束与数据库设计匹配
   - 外键关系定义正确

## 相关文件

- `internal/pkg/model/role_permission.go` - 角色权限关联模型定义
- `internal/pkg/model/role.go` - 角色模型定义
- `internal/pkg/model/permission.go` - 权限模型定义
- `docs/TASKS/TASK002/TASK002-08.md` - 角色权限关联表数据库设计文档
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:34:33 CST

