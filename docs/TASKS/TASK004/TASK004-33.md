# TASK004-33: 编写AuthorLevelRepository单元测试

## 任务信息

**任务编号**: TASK004-33  
**父任务**: TASK004  
**任务名称**: 编写AuthorLevelRepository单元测试  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:34:33 CST

## 任务描述

编写作者等级仓储层单元测试。包括：1) 测试AuthorLevelRepository的所有方法；2) 测试正常情况、边界情况和异常情况；3) 测试JSONB字段的存储和读取；4) 使用Mock数据库进行测试；5) 确保测试覆盖率达标。所有测试用例描述和错误消息必须使用中文。

## 依赖任务

- TASK004-32: 实现AuthorLevelRepository接口和实现

## 实现指南

### 1. 设置测试环境

在 `internal/pkg/repository/author_level_repository_test.go` 文件中创建测试文件：

```go
package repository

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    "github.com/stretchr/testify/suite"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "yourproject/internal/pkg/model"
)

// AuthorLevelRepositoryTestSuite 作者等级仓储测试套件
type AuthorLevelRepositoryTestSuite struct {
    suite.Suite
    db     *gorm.DB
    repo   AuthorLevelRepository
    ctx    context.Context
}

// SetupTest 每个测试前的设置
func (s *AuthorLevelRepositoryTestSuite) SetupTest() {
    // 使用SQLite内存数据库进行测试
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    require.NoError(s.T(), err)
    
    // 自动迁移表结构
    err = db.AutoMigrate(&model.AuthorLevel{})
    require.NoError(s.T(), err)
    
    s.db = db
    s.repo = NewAuthorLevelRepository(db)
    s.ctx = context.Background()
}

// TearDownTest 每个测试后的清理
func (s *AuthorLevelRepositoryTestSuite) TearDownTest() {
    if s.db != nil {
        sqlDB, _ := s.db.DB()
        if sqlDB != nil {
            sqlDB.Close()
        }
    }
}
```

### 2. 测试GetByID方法

测试GetByID方法的正常情况和异常情况：

```go
// TestGetByID 测试GetByID方法
func (s *AuthorLevelRepositoryTestSuite) TestGetByID() {
    // 创建测试数据
    authorLevel := &model.AuthorLevel{
        Name:        "测试作者等级",
        Description: stringPtr("测试作者等级描述"),
        Conditions: model.AuthorLevelConditions{
            ConditionType:  "works_count",
            ConditionValue: 10,
        },
    }
    err := s.repo.Create(s.ctx, authorLevel)
    require.NoError(s.T(), err)
    
    tests := []struct {
        name    string
        id      int64
        wantErr bool
        errMsg  string
    }{
        {
            name:    "正常情况：获取存在的作者等级",
            id:      authorLevel.ID,
            wantErr: false,
        },
        {
            name:    "异常情况：获取不存在的作者等级",
            id:      99999,
            wantErr: true,
            errMsg:  "作者等级不存在",
        },
        {
            name:    "异常情况：ID为0",
            id:      0,
            wantErr: true,
            errMsg:  "作者等级不存在",
        },
    }
    
    for _, tt := range tests {
        s.Run(tt.name, func() {
            result, err := s.repo.GetByID(s.ctx, tt.id)
            if tt.wantErr {
                assert.Error(s.T(), err)
                if tt.errMsg != "" {
                    assert.Contains(s.T(), err.Error(), tt.errMsg)
                }
                assert.Nil(s.T(), result)
            } else {
                assert.NoError(s.T(), err)
                assert.NotNil(s.T(), result)
                assert.Equal(s.T(), authorLevel.ID, result.ID)
                assert.Equal(s.T(), authorLevel.Name, result.Name)
            }
        })
    }
}
```

### 3. 测试GetAll方法

测试GetAll方法：

```go
// TestGetAll 测试GetAll方法
func (s *AuthorLevelRepositoryTestSuite) TestGetAll() {
    // 创建多个测试数据
    authorLevels := []*model.AuthorLevel{
        {
            Name: "等级1",
            Conditions: model.AuthorLevelConditions{
                ConditionType:  "works_count",
                ConditionValue: 5,
            },
        },
        {
            Name: "等级2",
            Conditions: model.AuthorLevelConditions{
                ConditionType:  "works_count",
                ConditionValue: 10,
            },
        },
    }
    
    for _, al := range authorLevels {
        err := s.repo.Create(s.ctx, al)
        require.NoError(s.T(), err)
    }
    
    // 测试获取所有作者等级
    results, err := s.repo.GetAll(s.ctx)
    assert.NoError(s.T(), err)
    assert.Len(s.T(), results, len(authorLevels))
}
```

### 4. 测试Create方法

测试Create方法，包括JSONB字段的处理：

```go
// TestCreate 测试Create方法
func (s *AuthorLevelRepositoryTestSuite) TestCreate() {
    tests := []struct {
        name        string
        authorLevel *model.AuthorLevel
        wantErr     bool
    }{
        {
            name: "正常情况：创建作者等级",
            authorLevel: &model.AuthorLevel{
                Name: "测试等级",
                Conditions: model.AuthorLevelConditions{
                    ConditionType:  "works_count",
                    ConditionValue: 10,
                },
            },
            wantErr: false,
        },
        {
            name: "正常情况：创建带描述的作者等级",
            authorLevel: &model.AuthorLevel{
                Name:        "测试等级2",
                Description: stringPtr("测试描述"),
                Conditions: model.AuthorLevelConditions{
                    ConditionType:  "avg_rating",
                    ConditionValue: 8,
                },
            },
            wantErr: false,
        },
    }
    
    for _, tt := range tests {
        s.Run(tt.name, func() {
            err := s.repo.Create(s.ctx, tt.authorLevel)
            if tt.wantErr {
                assert.Error(s.T(), err)
            } else {
                assert.NoError(s.T(), err)
                assert.Greater(s.T(), tt.authorLevel.ID, int64(0))
                
                // 验证JSONB字段是否正确存储
                result, err := s.repo.GetByID(s.ctx, tt.authorLevel.ID)
                assert.NoError(s.T(), err)
                assert.Equal(s.T(), tt.authorLevel.Conditions.ConditionType, result.Conditions.ConditionType)
                assert.Equal(s.T(), tt.authorLevel.Conditions.ConditionValue, result.Conditions.ConditionValue)
            }
        })
    }
}
```

### 5. 测试Update方法

测试Update方法，包括JSONB字段的更新：

```go
// TestUpdate 测试Update方法
func (s *AuthorLevelRepositoryTestSuite) TestUpdate() {
    // 创建测试数据
    authorLevel := &model.AuthorLevel{
        Name: "原始等级",
        Conditions: model.AuthorLevelConditions{
            ConditionType:  "works_count",
            ConditionValue: 5,
        },
    }
    err := s.repo.Create(s.ctx, authorLevel)
    require.NoError(s.T(), err)
    
    // 更新作者等级
    authorLevel.Name = "更新后的等级"
    authorLevel.Conditions = model.AuthorLevelConditions{
        ConditionType:  "works_count",
        ConditionValue: 20,
    }
    
    err = s.repo.Update(s.ctx, authorLevel)
    assert.NoError(s.T(), err)
    
    // 验证更新结果
    result, err := s.repo.GetByID(s.ctx, authorLevel.ID)
    assert.NoError(s.T(), err)
    assert.Equal(s.T(), "更新后的等级", result.Name)
    assert.Equal(s.T(), int64(20), result.Conditions.ConditionValue)
}
```

### 6. 测试Delete方法

测试Delete方法（软删除）：

```go
// TestDelete 测试Delete方法
func (s *AuthorLevelRepositoryTestSuite) TestDelete() {
    // 创建测试数据
    authorLevel := &model.AuthorLevel{
        Name: "待删除等级",
        Conditions: model.AuthorLevelConditions{
            ConditionType:  "works_count",
            ConditionValue: 5,
        },
    }
    err := s.repo.Create(s.ctx, authorLevel)
    require.NoError(s.T(), err)
    
    // 删除作者等级
    err = s.repo.Delete(s.ctx, authorLevel.ID)
    assert.NoError(s.T(), err)
    
    // 验证已删除（软删除，查询不到）
    result, err := s.repo.GetByID(s.ctx, authorLevel.ID)
    assert.Error(s.T(), err)
    assert.Nil(s.T(), result)
}
```

### 7. 测试GetByName方法

测试GetByName方法：

```go
// TestGetByName 测试GetByName方法
func (s *AuthorLevelRepositoryTestSuite) TestGetByName() {
    // 创建测试数据
    authorLevel := &model.AuthorLevel{
        Name: "唯一等级名称",
        Conditions: model.AuthorLevelConditions{
            ConditionType:  "works_count",
            ConditionValue: 5,
        },
    }
    err := s.repo.Create(s.ctx, authorLevel)
    require.NoError(s.T(), err)
    
    // 测试根据名称查询
    result, err := s.repo.GetByName(s.ctx, "唯一等级名称")
    assert.NoError(s.T(), err)
    assert.NotNil(s.T(), result)
    assert.Equal(s.T(), authorLevel.ID, result.ID)
    
    // 测试查询不存在的名称
    result, err = s.repo.GetByName(s.ctx, "不存在的名称")
    assert.Error(s.T(), err)
    assert.Nil(s.T(), result)
}
```

### 8. 运行测试套件

在文件末尾添加测试运行函数：

```go
// TestAuthorLevelRepositoryTestSuite 运行测试套件
func TestAuthorLevelRepositoryTestSuite(t *testing.T) {
    suite.Run(t, new(AuthorLevelRepositoryTestSuite))
}

// stringPtr 辅助函数，返回字符串指针
func stringPtr(s string) *string {
    return &s
}
```

### 9. 代码规范要求

- 所有测试用例描述使用中文
- 使用testify/suite组织测试
- 使用testify/assert和testify/require进行断言
- 测试覆盖正常情况、边界情况和异常情况
- 测试JSONB字段的存储和读取
- 确保测试覆盖率达标（80%以上）

## 验收标准

1. **测试覆盖完整**
   - 测试了AuthorLevelRepository的所有方法：GetByID、GetAll、Create、Update、Delete、GetByName
   - 测试了正常情况、边界情况和异常情况
   - 测试了JSONB字段的存储和读取

2. **测试质量**
   - 使用testify/suite组织测试
   - 测试用例描述清晰（使用中文）
   - 断言使用正确，错误消息清晰

3. **测试覆盖率达标**
   - 代码覆盖率达到80%以上
   - 所有关键路径都有测试覆盖

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 测试代码注释完整，使用中文
   - 遵循Golang编码规范和测试规范

## 相关文件

- `internal/pkg/repository/author_level_repository_test.go` - 作者等级仓储测试文件
- `internal/pkg/repository/author_level_repository.go` - 作者等级仓储实现
- `internal/pkg/model/author_level.go` - 作者等级模型定义
- `docs/TASKS/TASK004/TASK004-32.md` - 实现AuthorLevelRepository任务文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:34:33 CST

