# TASK004-44: 编写权限相关Repository单元测试

## 任务信息

**任务编号**: TASK004-44  
**父任务**: TASK004  
**任务名称**: 编写权限相关Repository单元测试  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:00:00 CST

## 任务描述

编写权限相关仓储层单元测试。包括：1) 测试PermissionRepository的所有方法；2) 测试RolePermissionRepository的所有方法；3) 测试UserGroupPermissionRepository的所有方法；4) 测试正常情况、边界情况和异常情况；5) 使用Mock数据库进行测试；6) 确保测试覆盖率达标。所有测试用例描述和错误消息必须使用中文。

## 依赖任务

- TASK004-41: 实现PermissionRepository接口和实现
- TASK004-42: 实现RolePermissionRepository接口和实现
- TASK004-43: 实现UserGroupPermissionRepository接口和实现

## 实现指南

### 1. 测试文件组织

创建以下测试文件：
- `internal/pkg/repository/permission_repository_test.go` - PermissionRepository测试
- `internal/pkg/repository/role_permission_repository_test.go` - RolePermissionRepository测试
- `internal/pkg/repository/user_group_permission_repository_test.go` - UserGroupPermissionRepository测试

### 2. 测试辅助函数

在每个测试文件中创建测试辅助函数：

```go
package repository

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "yourproject/internal/pkg/model"
)

// setupTestDB 设置测试数据库
func setupTestDB(t *testing.T) *gorm.DB {
    t.Helper()
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    require.NoError(t, err)
    
    // 自动迁移
    err = db.AutoMigrate(
        &model.Permission{},
        &model.RolePermission{},
        &model.UserGroupPermission{},
    )
    require.NoError(t, err)
    
    return db
}

// teardownTestDB 清理测试数据库
func teardownTestDB(t *testing.T, db *gorm.DB) {
    t.Helper()
    sqlDB, _ := db.DB()
    sqlDB.Close()
}
```

### 3. 测试PermissionRepository

在 `permission_repository_test.go` 中编写测试：

```go
func TestPermissionRepository_GetByID(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewPermissionRepository(db)
    ctx := context.Background()
    
    // 创建测试数据
    permission := &model.Permission{
        PermissionName: "test.permission",
        PermissionTarget: "test",
        IsActive: true,
    }
    err := repo.Create(ctx, permission)
    require.NoError(t, err)
    
    tests := []struct {
        name    string
        id      int64
        wantErr bool
        errMsg  string
    }{
        {
            name:    "有效权限ID",
            id:      permission.ID,
            wantErr: false,
        },
        {
            name:    "无效权限ID",
            id:      999,
            wantErr: true,
            errMsg:  "权限不存在",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got, err := repo.GetByID(ctx, tt.id)
            if tt.wantErr {
                assert.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                assert.Nil(t, got)
            } else {
                assert.NoError(t, err)
                assert.NotNil(t, got)
                assert.Equal(t, permission.ID, got.ID)
            }
        })
    }
}

func TestPermissionRepository_GetAll(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewPermissionRepository(db)
    ctx := context.Background()
    
    // 创建测试数据
    permissions := []*model.Permission{
        {PermissionName: "permission1", PermissionTarget: "test1", IsActive: true},
        {PermissionName: "permission2", PermissionTarget: "test2", IsActive: true},
    }
    for _, p := range permissions {
        err := repo.Create(ctx, p)
        require.NoError(t, err)
    }
    
    got, err := repo.GetAll(ctx)
    assert.NoError(t, err)
    assert.Len(t, got, 2)
}

func TestPermissionRepository_Create(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewPermissionRepository(db)
    ctx := context.Background()
    
    tests := []struct {
        name    string
        permission *model.Permission
        wantErr bool
    }{
        {
            name: "创建有效权限",
            permission: &model.Permission{
                PermissionName: "test.permission",
                PermissionTarget: "test",
                IsActive: true,
            },
            wantErr: false,
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := repo.Create(ctx, tt.permission)
            if tt.wantErr {
                assert.Error(t, err)
            } else {
                assert.NoError(t, err)
                assert.Greater(t, tt.permission.ID, int64(0))
            }
        })
    }
}

// 继续编写其他方法的测试...
```

### 4. 测试RolePermissionRepository

在 `role_permission_repository_test.go` 中编写测试：

```go
func TestRolePermissionRepository_Create(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewRolePermissionRepository(db)
    ctx := context.Background()
    
    // 创建测试数据（需要先创建Role和Permission）
    // ...
    
    rolePermission := &model.RolePermission{
        RoleID: 1,
        PermissionID: 1,
    }
    
    err := repo.Create(ctx, rolePermission)
    assert.NoError(t, err)
    assert.Greater(t, rolePermission.ID, int64(0))
}

func TestRolePermissionRepository_GetByRoleID(t *testing.T) {
    // 测试实现...
}

func TestRolePermissionRepository_BatchCreate(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewRolePermissionRepository(db)
    ctx := context.Background()
    
    rolePermissions := []*model.RolePermission{
        {RoleID: 1, PermissionID: 1},
        {RoleID: 1, PermissionID: 2},
    }
    
    err := repo.BatchCreate(ctx, rolePermissions)
    assert.NoError(t, err)
    
    // 验证批量创建结果
    got, err := repo.GetByRoleID(ctx, 1)
    assert.NoError(t, err)
    assert.Len(t, got, 2)
}

// 继续编写其他方法的测试...
```

### 5. 测试UserGroupPermissionRepository

在 `user_group_permission_repository_test.go` 中编写测试，测试结构与RolePermissionRepository类似。

### 6. 测试边界情况

为每个Repository编写边界情况测试：

```go
func TestPermissionRepository_GetByID_EmptyDatabase(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewPermissionRepository(db)
    ctx := context.Background()
    
    _, err := repo.GetByID(ctx, 1)
    assert.Error(t, err)
    assert.Contains(t, err.Error(), "权限不存在")
}

func TestRolePermissionRepository_BatchCreate_EmptyList(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewRolePermissionRepository(db)
    ctx := context.Background()
    
    err := repo.BatchCreate(ctx, []*model.RolePermission{})
    assert.NoError(t, err) // 空列表应该不报错
}
```

### 7. 测试异常情况

为每个Repository编写异常情况测试：

```go
func TestPermissionRepository_Update_NotExists(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewPermissionRepository(db)
    ctx := context.Background()
    
    permission := &model.Permission{
        ID: 999,
        PermissionName: "test",
    }
    
    err := repo.Update(ctx, permission)
    assert.Error(t, err)
    assert.Contains(t, err.Error(), "权限不存在")
}
```

### 8. 代码规范要求

- 所有测试用例描述使用中文
- 使用表驱动测试处理多个测试场景
- 使用testify的assert和require包
- 使用t.Helper()标记辅助函数
- 每个测试用例独立，不依赖其他测试
- 测试覆盖率应达到80%以上

## 验收标准

1. **测试覆盖完整**
   - PermissionRepository的所有方法都有测试用例
   - RolePermissionRepository的所有方法都有测试用例
   - UserGroupPermissionRepository的所有方法都有测试用例
   - 测试覆盖正常情况、边界情况和异常情况

2. **测试用例质量**
   - 测试用例描述清晰，使用中文
   - 使用表驱动测试处理多个场景
   - 测试用例独立，不依赖执行顺序
   - 使用适当的断言和验证

3. **测试覆盖率达标**
   - 代码覆盖率应达到80%以上
   - 关键路径覆盖率应达到90%以上
   - 使用go test -cover检查覆盖率

4. **代码规范符合要求**
   - 代码通过golangci-lint检查
   - 测试代码注释完整，使用中文
   - 遵循Golang编码规范和测试规范
   - 使用testify等测试工具

5. **测试正确性**
   - 所有测试用例都能正确执行
   - 测试结果符合预期
   - 边界情况和异常情况测试正确

## 相关文件

- `internal/pkg/repository/permission_repository_test.go` - PermissionRepository测试
- `internal/pkg/repository/role_permission_repository_test.go` - RolePermissionRepository测试
- `internal/pkg/repository/user_group_permission_repository_test.go` - UserGroupPermissionRepository测试
- `internal/pkg/repository/permission_repository.go` - PermissionRepository实现
- `internal/pkg/repository/role_permission_repository.go` - RolePermissionRepository实现
- `internal/pkg/repository/user_group_permission_repository.go` - UserGroupPermissionRepository实现
- `.cursor/rules/testing.mdc` - 单元测试规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:00:00 CST

