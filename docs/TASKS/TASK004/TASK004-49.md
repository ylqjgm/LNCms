# TASK004-49: 创建权限检查中间件结构

## 任务信息

**任务编号**: TASK004-49  
**父任务**: TASK004  
**任务名称**: 创建权限检查中间件结构  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:00:00 CST

## 任务描述

创建权限检查中间件结构。包括：1) 定义权限检查中间件接口；2) 创建权限检查中间件结构体，包含PermissionService和Redis客户端字段；3) 定义权限检查配置结构（支持角色权限检查、用户组权限检查等）。所有代码必须遵循Golang编码规范。

## 依赖任务

- TASK004-45: 创建PermissionService接口和实现

## 实现指南

### 1. 定义权限检查中间件接口

在 `internal/pkg/middleware/permission_middleware.go` 文件中定义接口：

```go
package middleware

import (
    "github.com/gin-gonic/gin"
)

// PermissionMiddleware 权限检查中间件接口
type PermissionMiddleware interface {
    // RequirePermission 要求用户具有指定权限
    RequirePermission(permissionName string) gin.HandlerFunc
    
    // RequireAnyPermission 要求用户具有任意一个指定权限
    RequireAnyPermission(permissionNames ...string) gin.HandlerFunc
    
    // RequireAllPermissions 要求用户具有所有指定权限
    RequireAllPermissions(permissionNames ...string) gin.HandlerFunc
    
    // RequireRole 要求用户具有指定角色
    RequireRole(roleName string) gin.HandlerFunc
    
    // RequireUserGroup 要求用户属于指定用户组
    RequireUserGroup(userGroupName string) gin.HandlerFunc
}
```

### 2. 定义权限检查配置结构

在同一个文件中定义配置结构：

```go
// PermissionCheckConfig 权限检查配置
type PermissionCheckConfig struct {
    // CheckType 检查类型：role-角色权限，group-用户组权限，both-两者都检查
    CheckType string
    
    // PermissionName 权限名称（用于角色权限检查）
    PermissionName string
    
    // PermissionNames 权限名称列表（用于多权限检查）
    PermissionNames []string
    
    // RoleName 角色名称（用于角色检查）
    RoleName string
    
    // UserGroupName 用户组名称（用于用户组检查）
    UserGroupName string
    
    // RequireAll 是否要求所有权限（用于多权限检查）
    RequireAll bool
}
```

### 3. 创建权限检查中间件结构体

在同一个文件中创建中间件结构体：

```go
import (
    "context"
    "github.com/gin-gonic/gin"
    "github.com/redis/go-redis/v9"
    "yourproject/internal/pkg/service"
)

// permissionMiddleware 权限检查中间件实现
type permissionMiddleware struct {
    permissionService service.PermissionService
    redisClient       *redis.Client
    cacheExpiration   time.Duration
}

// NewPermissionMiddleware 创建权限检查中间件实例
func NewPermissionMiddleware(
    permissionService service.PermissionService,
    redisClient *redis.Client,
) PermissionMiddleware {
    return &permissionMiddleware{
        permissionService: permissionService,
        redisClient:       redisClient,
        cacheExpiration:   1 * time.Hour, // 缓存1小时
    }
}
```

### 4. 定义权限检查结果结构

定义权限检查结果结构，用于存储检查结果：

```go
// PermissionCheckResult 权限检查结果
type PermissionCheckResult struct {
    // HasPermission 是否具有权限
    HasPermission bool
    
    // MissingPermissions 缺失的权限列表
    MissingPermissions []string
    
    // HasRole 是否具有角色
    HasRole bool
    
    // MissingRoles 缺失的角色列表
    MissingRoles []string
    
    // InUserGroup 是否在用户组中
    InUserGroup bool
    
    // MissingUserGroups 缺失的用户组列表
    MissingUserGroups []string
}
```

### 5. 定义用户上下文结构

定义用户上下文结构，用于从Gin上下文中获取用户信息：

```go
// UserContext 用户上下文
type UserContext struct {
    // UserID 用户ID
    UserID int64
    
    // RoleID 角色ID
    RoleID *int64
    
    // UserGroupIDs 用户组ID列表
    UserGroupIDs []int64
    
    // Username 用户名
    Username string
}

// GetUserContext 从Gin上下文中获取用户上下文
func GetUserContext(c *gin.Context) (*UserContext, error) {
    // 从上下文中获取用户信息
    // 这里需要根据实际的身份认证实现来获取
    userID, exists := c.Get("user_id")
    if !exists {
        return nil, fmt.Errorf("用户未登录")
    }
    
    ctx := &UserContext{
        UserID: userID.(int64),
    }
    
    // 获取角色ID
    if roleID, exists := c.Get("role_id"); exists {
        id := roleID.(int64)
        ctx.RoleID = &id
    }
    
    // 获取用户组ID列表
    if userGroupIDs, exists := c.Get("user_group_ids"); exists {
        ctx.UserGroupIDs = userGroupIDs.([]int64)
    }
    
    // 获取用户名
    if username, exists := c.Get("username"); exists {
        ctx.Username = username.(string)
    }
    
    return ctx, nil
}
```

### 6. 代码规范要求

- 接口定义清晰，职责单一
- 结构体字段命名符合Golang规范
- 所有注释使用中文
- 遵循中间件设计模式
- 支持多种权限检查方式

## 验收标准

1. **接口定义完整**
   - PermissionMiddleware接口包含所有必需的方法
   - 接口方法签名正确
   - 接口注释完整，使用中文

2. **结构体定义完整**
   - permissionMiddleware结构体包含所有必需字段
   - PermissionCheckConfig结构体定义完整
   - PermissionCheckResult结构体定义完整
   - UserContext结构体定义完整

3. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范
   - 结构体字段命名规范

4. **设计合理**
   - 中间件结构设计合理
   - 支持多种权限检查方式
   - 配置结构灵活，易于扩展

## 相关文件

- `internal/pkg/middleware/permission_middleware.go` - 权限检查中间件接口和结构定义
- `internal/pkg/service/permission_service.go` - 权限服务接口
- `docs/TASKS/TASK004/TASK004-45.md` - 创建PermissionService接口任务文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:00:00 CST

