# TASK004-41: 实现PermissionRepository接口和实现

## 任务信息

**任务编号**: TASK004-41  
**父任务**: TASK004  
**任务名称**: 实现PermissionRepository接口和实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:00:00 CST

## 任务描述

实现PermissionRepository接口，提供权限的CRUD操作。包括：1) 定义PermissionRepository接口；2) 实现权限的创建、查询、更新、删除方法（Create、GetByID、GetAll、Update、Delete）；3) 实现数据库操作逻辑。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK004-38: 创建Permission模型

## 实现指南

### 1. 参考数据库设计

阅读 `docs/TASKS/TASK002/TASK002-07.md` 文档，了解权限表的数据库设计：
- 表名：`permissions`
- 字段：id、permission_name、permission_target、permission_description、is_active、created_at、updated_at
- 索引：主键索引（id）、唯一索引（permission_name）、普通索引（permission_target、is_active）

### 2. 定义PermissionRepository接口

在 `internal/pkg/repository/permission_repository.go` 文件中定义接口：

```go
package repository

import (
    "context"
    "yourproject/internal/pkg/model"
)

// PermissionRepository 权限仓储接口
type PermissionRepository interface {
    // GetByID 根据ID获取权限
    GetByID(ctx context.Context, id int64) (*model.Permission, error)
    
    // GetAll 获取所有权限
    GetAll(ctx context.Context) ([]*model.Permission, error)
    
    // GetByPermissionName 根据权限名称获取权限
    GetByPermissionName(ctx context.Context, permissionName string) (*model.Permission, error)
    
    // GetByTarget 根据权限目标获取权限列表
    GetByTarget(ctx context.Context, target string) ([]*model.Permission, error)
    
    // Create 创建权限
    Create(ctx context.Context, permission *model.Permission) error
    
    // Update 更新权限
    Update(ctx context.Context, permission *model.Permission) error
    
    // Delete 删除权限（软删除）
    Delete(ctx context.Context, id int64) error
}
```

### 3. 实现permissionRepository结构体

在同一个文件中实现权限仓储：

```go
import (
    "context"
    "fmt"
    "gorm.io/gorm"
    "yourproject/internal/pkg/model"
)

// permissionRepository 权限仓储实现
type permissionRepository struct {
    db *gorm.DB
}

// NewPermissionRepository 创建权限仓储实例
func NewPermissionRepository(db *gorm.DB) PermissionRepository {
    return &permissionRepository{db: db}
}
```

### 4. 实现GetByID方法

实现根据ID获取权限的方法：

```go
// GetByID 根据ID获取权限
func (r *permissionRepository) GetByID(ctx context.Context, id int64) (*model.Permission, error) {
    var permission model.Permission
    err := r.db.WithContext(ctx).
        Where("id = ?", id).
        First(&permission).Error
    if err != nil {
        if err == gorm.ErrRecordNotFound {
            return nil, fmt.Errorf("权限不存在")
        }
        return nil, fmt.Errorf("查询权限失败: %w", err)
    }
    return &permission, nil
}
```

### 5. 实现GetAll方法

实现获取所有权限的方法：

```go
// GetAll 获取所有权限
func (r *permissionRepository) GetAll(ctx context.Context) ([]*model.Permission, error) {
    var permissions []*model.Permission
    err := r.db.WithContext(ctx).
        Order("created_at DESC").
        Find(&permissions).Error
    if err != nil {
        return nil, fmt.Errorf("查询权限列表失败: %w", err)
    }
    return permissions, nil
}
```

### 6. 实现GetByPermissionName方法

实现根据权限名称获取权限的方法：

```go
// GetByPermissionName 根据权限名称获取权限
func (r *permissionRepository) GetByPermissionName(ctx context.Context, permissionName string) (*model.Permission, error) {
    var permission model.Permission
    err := r.db.WithContext(ctx).
        Where("permission_name = ?", permissionName).
        First(&permission).Error
    if err != nil {
        if err == gorm.ErrRecordNotFound {
            return nil, fmt.Errorf("权限不存在")
        }
        return nil, fmt.Errorf("查询权限失败: %w", err)
    }
    return &permission, nil
}
```

### 7. 实现GetByTarget方法

实现根据权限目标获取权限列表的方法：

```go
// GetByTarget 根据权限目标获取权限列表
func (r *permissionRepository) GetByTarget(ctx context.Context, target string) ([]*model.Permission, error) {
    var permissions []*model.Permission
    err := r.db.WithContext(ctx).
        Where("permission_target = ?", target).
        Order("created_at DESC").
        Find(&permissions).Error
    if err != nil {
        return nil, fmt.Errorf("查询权限列表失败: %w", err)
    }
    return permissions, nil
}
```

### 8. 实现Create方法

实现创建权限的方法：

```go
// Create 创建权限
func (r *permissionRepository) Create(ctx context.Context, permission *model.Permission) error {
    if err := r.db.WithContext(ctx).Create(permission).Error; err != nil {
        return fmt.Errorf("创建权限失败: %w", err)
    }
    return nil
}
```

### 9. 实现Update方法

实现更新权限的方法：

```go
// Update 更新权限
func (r *permissionRepository) Update(ctx context.Context, permission *model.Permission) error {
    result := r.db.WithContext(ctx).
        Model(&model.Permission{}).
        Where("id = ?", permission.ID).
        Updates(permission)
    if result.Error != nil {
        return fmt.Errorf("更新权限失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("权限不存在")
    }
    return nil
}
```

### 10. 实现Delete方法

实现删除权限的方法（软删除）：

```go
// Delete 删除权限（软删除）
func (r *permissionRepository) Delete(ctx context.Context, id int64) error {
    result := r.db.WithContext(ctx).
        Where("id = ?", id).
        Delete(&model.Permission{})
    if result.Error != nil {
        return fmt.Errorf("删除权限失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("权限不存在")
    }
    return nil
}
```

### 11. 代码规范要求

- 所有错误消息使用中文
- 使用context.Context传递上下文
- 使用GORM的WithContext方法
- 处理GORM错误，包括RecordNotFound错误
- 在Update和Delete方法中检查RowsAffected
- 所有方法都有清晰的注释（使用中文）

## 验收标准

1. **接口定义完整**
   - PermissionRepository接口包含所有必需的方法：GetByID、GetAll、GetByPermissionName、GetByTarget、Create、Update、Delete
   - 方法签名正确，参数和返回值类型正确
   - 接口注释完整，使用中文

2. **实现完整**
   - permissionRepository结构体正确实现PermissionRepository接口
   - 所有接口方法都有对应的实现
   - 使用GORM进行数据库操作
   - 使用context.Context传递上下文

3. **错误处理正确**
   - 所有错误都使用中文错误消息
   - 正确处理GORM的RecordNotFound错误
   - Update和Delete方法检查RowsAffected
   - 错误消息清晰，包含上下文信息

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范
   - 遵循项目代码组织结构

5. **功能正确性**
   - GetByID方法正确查询权限
   - GetAll方法正确返回所有权限列表
   - GetByPermissionName方法正确根据名称查询权限
   - GetByTarget方法正确根据目标查询权限列表
   - Create方法正确创建权限
   - Update方法正确更新权限
   - Delete方法正确删除权限（软删除）

## 相关文件

- `internal/pkg/repository/permission_repository.go` - 权限仓储接口和实现
- `internal/pkg/model/permission.go` - 权限模型定义
- `docs/TASKS/TASK004/TASK004-38.md` - 创建Permission模型任务文档
- `docs/TASKS/TASK002/TASK002-07.md` - 权限表数据库设计文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:00:00 CST

