# TASK004-06: 创建RoleHandler接口和实现

## 任务信息

**任务编号**: TASK004-06  
**父任务**: TASK004  
**任务名称**: 创建RoleHandler接口和实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:54:20 CST

## 任务描述

创建RoleHandler接口和实现，提供角色的HTTP API处理。包括：1) 定义RoleHandler接口；2) 实现角色的创建、查询、更新、删除HTTP处理函数；3) 实现请求参数绑定和响应格式化（Envelope格式）。所有代码必须遵循Golang编码规范和API设计规范，错误消息使用中文。

## 依赖任务

- TASK004-04: 创建RoleService接口和实现

## 实现指南

### 1. 定义RoleHandler接口

在 `internal/pkg/handler/role_handler.go` 文件中定义接口：

```go
package handler

import (
    "github.com/gin-gonic/gin"
)

// RoleHandler 角色处理器接口
type RoleHandler interface {
    // GetByID 根据ID获取角色
    GetByID(c *gin.Context)
    
    // GetAll 获取所有角色
    GetAll(c *gin.Context)
    
    // Create 创建角色
    Create(c *gin.Context)
    
    // Update 更新角色
    Update(c *gin.Context)
    
    // Delete 删除角色
    Delete(c *gin.Context)
}
```

### 2. 实现roleHandler结构体

在同一个文件中实现角色处理器：

```go
import (
    "net/http"
    "strconv"
    
    "github.com/gin-gonic/gin"
    "yourproject/internal/pkg/service"
    "yourproject/pkg/response"
)

// roleHandler 角色处理器实现
type roleHandler struct {
    roleService service.RoleService
}

// NewRoleHandler 创建角色处理器实例
func NewRoleHandler(roleService service.RoleService) RoleHandler {
    return &roleHandler{
        roleService: roleService,
    }
}
```

### 3. 实现GetByID方法

实现根据ID获取角色的HTTP处理函数：

```go
// GetByID 根据ID获取角色
// @Summary 获取角色详情
// @Description 根据角色ID获取角色详细信息
// @Tags 角色管理
// @Accept json
// @Produce json
// @Param id path int true "角色ID"
// @Success 200 {object} response.Envelope "成功响应"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 404 {object} response.Envelope "角色不存在"
// @Failure 500 {object} response.Envelope "服务器内部错误"
// @Router /api/v1/roles/{id} [get]
func (h *roleHandler) GetByID(c *gin.Context) {
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_PARAM", "角色ID无效", nil)
        return
    }
    
    role, err := h.roleService.GetByID(c.Request.Context(), id)
    if err != nil {
        response.Error(c, http.StatusNotFound, "ROLE_NOT_FOUND", err.Error(), nil)
        return
    }
    
    response.Success(c, http.StatusOK, role)
}
```

### 4. 实现GetAll方法

实现获取所有角色的HTTP处理函数：

```go
// GetAll 获取所有角色
// @Summary 获取角色列表
// @Description 获取所有角色列表
// @Tags 角色管理
// @Accept json
// @Produce json
// @Success 200 {object} response.Envelope "成功响应"
// @Failure 500 {object} response.Envelope "服务器内部错误"
// @Router /api/v1/roles [get]
func (h *roleHandler) GetAll(c *gin.Context) {
    roles, err := h.roleService.GetAll(c.Request.Context())
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "INTERNAL_ERROR", err.Error(), nil)
        return
    }
    
    response.Success(c, http.StatusOK, roles)
}
```

### 5. 实现Create方法

实现创建角色的HTTP处理函数：

```go
// Create 创建角色
// @Summary 创建角色
// @Description 创建新的角色
// @Tags 角色管理
// @Accept json
// @Produce json
// @Param request body service.CreateRoleRequest true "创建角色请求"
// @Success 201 {object} response.Envelope "创建成功"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 409 {object} response.Envelope "角色名称已存在"
// @Failure 500 {object} response.Envelope "服务器内部错误"
// @Router /api/v1/roles [post]
func (h *roleHandler) Create(c *gin.Context) {
    var req service.CreateRoleRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_PARAM", "请求参数错误", nil)
        return
    }
    
    role, err := h.roleService.Create(c.Request.Context(), &req)
    if err != nil {
        if err.Error() == "角色名称已存在" {
            response.Error(c, http.StatusConflict, "ROLE_NAME_EXISTS", err.Error(), nil)
            return
        }
        response.Error(c, http.StatusBadRequest, "CREATE_FAILED", err.Error(), nil)
        return
    }
    
    response.Success(c, http.StatusCreated, role)
}
```

### 6. 实现Update方法

实现更新角色的HTTP处理函数：

```go
// Update 更新角色
// @Summary 更新角色
// @Description 更新角色信息
// @Tags 角色管理
// @Accept json
// @Produce json
// @Param id path int true "角色ID"
// @Param request body service.UpdateRoleRequest true "更新角色请求"
// @Success 200 {object} response.Envelope "更新成功"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 404 {object} response.Envelope "角色不存在"
// @Failure 500 {object} response.Envelope "服务器内部错误"
// @Router /api/v1/roles/{id} [put]
func (h *roleHandler) Update(c *gin.Context) {
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_PARAM", "角色ID无效", nil)
        return
    }
    
    var req service.UpdateRoleRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_PARAM", "请求参数错误", nil)
        return
    }
    
    role, err := h.roleService.Update(c.Request.Context(), id, &req)
    if err != nil {
        if err.Error() == "角色不存在" || err.Error() == "系统角色不允许修改" {
            response.Error(c, http.StatusBadRequest, "UPDATE_FAILED", err.Error(), nil)
            return
        }
        response.Error(c, http.StatusBadRequest, "UPDATE_FAILED", err.Error(), nil)
        return
    }
    
    response.Success(c, http.StatusOK, role)
}
```

### 7. 实现Delete方法

实现删除角色的HTTP处理函数：

```go
// Delete 删除角色
// @Summary 删除角色
// @Description 删除角色
// @Tags 角色管理
// @Accept json
// @Produce json
// @Param id path int true "角色ID"
// @Success 204 "删除成功"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 404 {object} response.Envelope "角色不存在"
// @Failure 500 {object} response.Envelope "服务器内部错误"
// @Router /api/v1/roles/{id} [delete]
func (h *roleHandler) Delete(c *gin.Context) {
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_PARAM", "角色ID无效", nil)
        return
    }
    
    err = h.roleService.Delete(c.Request.Context(), id)
    if err != nil {
        if err.Error() == "角色不存在" || err.Error() == "系统角色不允许删除" {
            response.Error(c, http.StatusBadRequest, "DELETE_FAILED", err.Error(), nil)
            return
        }
        response.Error(c, http.StatusInternalServerError, "DELETE_FAILED", err.Error(), nil)
        return
    }
    
    c.Status(http.StatusNoContent)
}
```

### 8. 代码规范要求

- 所有错误消息使用中文
- 使用Envelope格式返回响应
- 使用适当的HTTP状态码
- 实现请求参数验证
- 使用Gin的ShouldBindJSON绑定JSON请求体
- 所有方法都有Swagger注释

## 验收标准

1. **接口定义完整**
   - RoleHandler接口包含所有必需的方法
   - 接口注释完整，使用中文

2. **HTTP处理函数实现完整**
   - 所有接口方法都有对应的HTTP处理函数实现
   - 正确解析路径参数和请求体
   - 正确调用Service层方法
   - 正确格式化响应（Envelope格式）

3. **错误处理正确**
   - 所有错误都使用中文错误消息
   - 使用适当的HTTP状态码
   - 错误响应符合Envelope格式

4. **API规范符合要求**
   - 遵循OpenAPI 3.1.1规范
   - 所有接口都有Swagger注释
   - 响应格式符合Envelope格式
   - 路径参数和请求体验证正确

5. **代码规范符合要求**
   - 代码通过golangci-lint检查
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/handler/role_handler.go` - 角色处理器接口和实现
- `internal/pkg/service/role_service.go` - 角色服务接口
- `pkg/response/response.go` - 响应格式化工具
- `docs/TASKS/TASK004/TASK004-04.md` - 创建RoleService接口任务文档
- `.cursor/rules/api-design.mdc` - API设计规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 14:54:20 CST

