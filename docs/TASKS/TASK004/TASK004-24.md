# TASK004-24: 实现AuthorTypeRepository接口和实现

## 任务信息

**任务编号**: TASK004-24  
**父任务**: TASK004  
**任务名称**: 实现AuthorTypeRepository接口和实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:25:47 CST

## 任务描述

实现AuthorTypeRepository接口，提供作者类型的CRUD操作。包括：1) 定义AuthorTypeRepository接口；2) 实现作者类型的创建、查询、更新、删除方法（Create、GetByID、GetAll、Update、Delete）；3) 实现数据库操作逻辑，支持按sort_order排序查询。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK004-23: 创建AuthorType模型

## 实现指南

### 1. 定义AuthorTypeRepository接口

在 `internal/pkg/repository/author_type_repository.go` 文件中定义接口：

```go
package repository

import (
    "context"
    "yourproject/internal/pkg/model"
)

// AuthorTypeRepository 作者类型仓储接口
type AuthorTypeRepository interface {
    // GetByID 根据ID获取作者类型
    GetByID(ctx context.Context, id int64) (*model.AuthorType, error)
    
    // GetAll 获取所有作者类型，按sort_order排序
    GetAll(ctx context.Context) ([]*model.AuthorType, error)
    
    // Create 创建作者类型
    Create(ctx context.Context, authorType *model.AuthorType) error
    
    // Update 更新作者类型
    Update(ctx context.Context, authorType *model.AuthorType) error
    
    // Delete 删除作者类型（软删除）
    Delete(ctx context.Context, id int64) error
    
    // GetByCode 根据代码获取作者类型
    GetByCode(ctx context.Context, code string) (*model.AuthorType, error)
}
```

### 2. 实现authorTypeRepository结构体

在同一个文件中实现作者类型仓储：

```go
import (
    "context"
    "fmt"
    "gorm.io/gorm"
    "yourproject/internal/pkg/model"
)

// authorTypeRepository 作者类型仓储实现
type authorTypeRepository struct {
    db *gorm.DB
}

// NewAuthorTypeRepository 创建作者类型仓储实例
func NewAuthorTypeRepository(db *gorm.DB) AuthorTypeRepository {
    return &authorTypeRepository{db: db}
}
```

### 3. 实现GetByID方法

实现根据ID获取作者类型的方法：

```go
// GetByID 根据ID获取作者类型
func (r *authorTypeRepository) GetByID(ctx context.Context, id int64) (*model.AuthorType, error) {
    var authorType model.AuthorType
    err := r.db.WithContext(ctx).
        Where("id = ?", id).
        First(&authorType).Error
    if err != nil {
        if err == gorm.ErrRecordNotFound {
            return nil, fmt.Errorf("作者类型不存在")
        }
        return nil, fmt.Errorf("查询作者类型失败: %w", err)
    }
    return &authorType, nil
}
```

### 4. 实现GetAll方法

实现获取所有作者类型的方法，按sort_order排序：

```go
// GetAll 获取所有作者类型，按sort_order排序
func (r *authorTypeRepository) GetAll(ctx context.Context) ([]*model.AuthorType, error) {
    var authorTypes []*model.AuthorType
    err := r.db.WithContext(ctx).
        Order("sort_order ASC, id ASC").
        Find(&authorTypes).Error
    if err != nil {
        return nil, fmt.Errorf("查询作者类型列表失败: %w", err)
    }
    return authorTypes, nil
}
```

### 5. 实现Create方法

实现创建作者类型的方法：

```go
// Create 创建作者类型
func (r *authorTypeRepository) Create(ctx context.Context, authorType *model.AuthorType) error {
    if err := r.db.WithContext(ctx).Create(authorType).Error; err != nil {
        return fmt.Errorf("创建作者类型失败: %w", err)
    }
    return nil
}
```

### 6. 实现Update方法

实现更新作者类型的方法：

```go
// Update 更新作者类型
func (r *authorTypeRepository) Update(ctx context.Context, authorType *model.AuthorType) error {
    result := r.db.WithContext(ctx).
        Model(&model.AuthorType{}).
        Where("id = ?", authorType.ID).
        Updates(authorType)
    if result.Error != nil {
        return fmt.Errorf("更新作者类型失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("作者类型不存在")
    }
    return nil
}
```

### 7. 实现Delete方法

实现删除作者类型的方法（软删除）：

```go
// Delete 删除作者类型（软删除）
func (r *authorTypeRepository) Delete(ctx context.Context, id int64) error {
    result := r.db.WithContext(ctx).
        Where("id = ?", id).
        Delete(&model.AuthorType{})
    if result.Error != nil {
        return fmt.Errorf("删除作者类型失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("作者类型不存在")
    }
    return nil
}
```

### 8. 实现GetByCode方法

实现根据代码获取作者类型的方法：

```go
// GetByCode 根据代码获取作者类型
func (r *authorTypeRepository) GetByCode(ctx context.Context, code string) (*model.AuthorType, error) {
    var authorType model.AuthorType
    err := r.db.WithContext(ctx).
        Where("code = ?", code).
        First(&authorType).Error
    if err != nil {
        if err == gorm.ErrRecordNotFound {
            return nil, fmt.Errorf("作者类型不存在")
        }
        return nil, fmt.Errorf("查询作者类型失败: %w", err)
    }
    return &authorType, nil
}
```

### 9. 代码规范要求

- 所有错误消息使用中文
- 使用GORM进行数据库操作
- 使用Context传递上下文
- 实现软删除功能
- GetAll方法按sort_order排序

## 验收标准

1. **接口定义完整**
   - AuthorTypeRepository接口包含所有必需的方法
   - 接口注释完整，使用中文

2. **方法实现完整**
   - 所有接口方法都有对应的实现
   - GetByID方法正确查询单条记录
   - GetAll方法正确查询所有记录，按sort_order排序
   - Create方法正确创建记录
   - Update方法正确更新记录
   - Delete方法正确删除记录（软删除）
   - GetByCode方法正确根据代码查询记录

3. **错误处理正确**
   - 所有错误都使用中文错误消息
   - 正确处理记录不存在的情况
   - 正确处理数据库错误

4. **代码规范符合要求**
   - 代码通过golangci-lint检查
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

5. **功能正确性**
   - GetAll方法按sort_order ASC, id ASC排序
   - 软删除功能正常工作
   - 唯一索引约束正确处理

## 相关文件

- `internal/pkg/repository/author_type_repository.go` - 作者类型仓储接口和实现
- `internal/pkg/model/author_type.go` - 作者类型模型定义
- `docs/TASKS/TASK004/TASK004-23.md` - 创建AuthorType模型任务文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:25:47 CST

