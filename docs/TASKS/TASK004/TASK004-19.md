# TASK004-19: 创建LevelService接口和实现

## 任务信息

**任务编号**: TASK004-19  
**父任务**: TASK004  
**任务名称**: 创建LevelService接口和实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:54:20 CST

## 任务描述

创建LevelService接口和实现，提供等级的业务逻辑处理。包括：1) 定义LevelService接口；2) 实现等级的创建、查询、更新、删除方法；3) 实现业务逻辑处理（输入验证、等级达成条件验证等）；4) 实现等级达成条件的解析和验证逻辑。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK004-16: 实现等级达成条件枚举和常量定义
- TASK004-17: 实现LevelRepository接口和实现

## 实现指南

### 1. 定义LevelService接口

在 `internal/pkg/service/level_service.go` 文件中定义接口：

```go
package service

import (
    "context"
    "yourproject/internal/pkg/model"
)

// LevelService 等级服务接口
type LevelService interface {
    // GetByID 根据ID获取等级
    GetByID(ctx context.Context, id int64) (*model.Level, error)
    
    // GetAll 获取所有等级
    GetAll(ctx context.Context) ([]*model.Level, error)
    
    // Create 创建等级
    Create(ctx context.Context, req *CreateLevelRequest) (*model.Level, error)
    
    // Update 更新等级
    Update(ctx context.Context, id int64, req *UpdateLevelRequest) (*model.Level, error)
    
    // Delete 删除等级
    Delete(ctx context.Context, id int64) error
}

// CreateLevelRequest 创建等级请求
type CreateLevelRequest struct {
    Name        string                  `json:"name" binding:"required,min=1,max=100"`
    Description *string                  `json:"description,omitempty"`
    Conditions  model.LevelConditions   `json:"conditions" binding:"required"`
}

// UpdateLevelRequest 更新等级请求
type UpdateLevelRequest struct {
    Name        string                  `json:"name" binding:"required,min=1,max=100"`
    Description *string                  `json:"description,omitempty"`
    Conditions  model.LevelConditions   `json:"conditions" binding:"required"`
}
```

### 2. 实现levelService结构体

在同一个文件中实现等级服务：

```go
import (
    "context"
    "fmt"
    "yourproject/internal/pkg/enum"
    "yourproject/internal/pkg/model"
    "yourproject/internal/pkg/repository"
)

// levelService 等级服务实现
type levelService struct {
    levelRepo repository.LevelRepository
}

// NewLevelService 创建等级服务实例
func NewLevelService(levelRepo repository.LevelRepository) LevelService {
    return &levelService{
        levelRepo: levelRepo,
    }
}
```

### 3. 实现GetByID方法

实现根据ID获取等级的方法：

```go
// GetByID 根据ID获取等级
func (s *levelService) GetByID(ctx context.Context, id int64) (*model.Level, error) {
    if id <= 0 {
        return nil, fmt.Errorf("等级ID无效")
    }
    
    level, err := s.levelRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("获取等级失败: %w", err)
    }
    
    return level, nil
}
```

### 4. 实现GetAll方法

实现获取所有等级的方法：

```go
// GetAll 获取所有等级
func (s *levelService) GetAll(ctx context.Context) ([]*model.Level, error) {
    levels, err := s.levelRepo.GetAll(ctx)
    if err != nil {
        return nil, fmt.Errorf("获取等级列表失败: %w", err)
    }
    
    return levels, nil
}
```

### 5. 实现Create方法

实现创建等级的方法，包含输入验证和等级达成条件验证：

```go
// Create 创建等级
func (s *levelService) Create(ctx context.Context, req *CreateLevelRequest) (*model.Level, error) {
    // 输入验证
    if err := s.validateCreateRequest(req); err != nil {
        return nil, err
    }
    
    // 验证等级达成条件
    if err := s.validateLevelConditions(req.Conditions); err != nil {
        return nil, err
    }
    
    // 检查等级名称是否已存在
    existing, err := s.levelRepo.GetByName(ctx, req.Name)
    if err == nil && existing != nil {
        return nil, fmt.Errorf("等级名称已存在")
    }
    
    // 创建等级
    level := &model.Level{
        Name:        req.Name,
        Description: req.Description,
        Conditions:  req.Conditions,
    }
    
    if err := s.levelRepo.Create(ctx, level); err != nil {
        return nil, fmt.Errorf("创建等级失败: %w", err)
    }
    
    return level, nil
}

// validateCreateRequest 验证创建请求
func (s *levelService) validateCreateRequest(req *CreateLevelRequest) error {
    if req == nil {
        return fmt.Errorf("请求参数不能为空")
    }
    if req.Name == "" {
        return fmt.Errorf("等级名称不能为空")
    }
    if len(req.Name) > 100 {
        return fmt.Errorf("等级名称长度不能超过100个字符")
    }
    return nil
}

// validateLevelConditions 验证等级达成条件
func (s *levelService) validateLevelConditions(conditions model.LevelConditions) error {
    // 验证条件类型
    if err := enum.ValidateLevelConditionType(conditions.ConditionType); err != nil {
        return fmt.Errorf("等级达成条件类型无效: %w", err)
    }
    
    // 验证条件值
    if conditions.ConditionValue < 0 {
        return fmt.Errorf("等级达成条件值不能为负数")
    }
    if conditions.ConditionValue > 999999999 {
        return fmt.Errorf("等级达成条件值不能超过999999999")
    }
    
    return nil
}
```

### 6. 实现Update方法

实现更新等级的方法：

```go
// Update 更新等级
func (s *levelService) Update(ctx context.Context, id int64, req *UpdateLevelRequest) (*model.Level, error) {
    if id <= 0 {
        return nil, fmt.Errorf("等级ID无效")
    }
    
    // 输入验证
    if err := s.validateUpdateRequest(req); err != nil {
        return nil, err
    }
    
    // 验证等级达成条件
    if err := s.validateLevelConditions(req.Conditions); err != nil {
        return nil, err
    }
    
    // 检查等级是否存在
    level, err := s.levelRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("等级不存在")
    }
    
    // 检查等级名称是否与其他等级重复
    existing, err := s.levelRepo.GetByName(ctx, req.Name)
    if err == nil && existing != nil && existing.ID != id {
        return nil, fmt.Errorf("等级名称已存在")
    }
    
    // 更新等级
    level.Name = req.Name
    level.Description = req.Description
    level.Conditions = req.Conditions
    
    if err := s.levelRepo.Update(ctx, level); err != nil {
        return nil, fmt.Errorf("更新等级失败: %w", err)
    }
    
    return level, nil
}

// validateUpdateRequest 验证更新请求
func (s *levelService) validateUpdateRequest(req *UpdateLevelRequest) error {
    if req == nil {
        return fmt.Errorf("请求参数不能为空")
    }
    if req.Name == "" {
        return fmt.Errorf("等级名称不能为空")
    }
    if len(req.Name) > 100 {
        return fmt.Errorf("等级名称长度不能超过100个字符")
    }
    return nil
}
```

### 7. 实现Delete方法

实现删除等级的方法：

```go
// Delete 删除等级
func (s *levelService) Delete(ctx context.Context, id int64) error {
    if id <= 0 {
        return fmt.Errorf("等级ID无效")
    }
    
    // 检查等级是否存在
    _, err := s.levelRepo.GetByID(ctx, id)
    if err != nil {
        return fmt.Errorf("等级不存在")
    }
    
    // 删除等级
    if err := s.levelRepo.Delete(ctx, id); err != nil {
        return fmt.Errorf("删除等级失败: %w", err)
    }
    
    return nil
}
```

### 8. 代码规范要求

- 所有错误消息使用中文
- 实现输入验证和业务规则验证
- 实现等级达成条件的验证逻辑
- 使用context.Context传递上下文
- 所有方法都有清晰的注释（使用中文）
- 业务逻辑与数据访问分离

## 验收标准

1. **接口定义完整**
   - LevelService接口包含所有必需的方法
   - 请求结构体定义完整，包含验证标签
   - 接口注释完整，使用中文

2. **业务逻辑实现完整**
   - 所有接口方法都有对应的实现
   - 实现了输入验证逻辑
   - 实现了等级达成条件验证逻辑
   - 实现了业务规则验证（如等级名称唯一性检查等）
   - 错误处理正确，错误消息使用中文

3. **等级达成条件验证**
   - 验证条件类型是否有效
   - 验证条件值是否在有效范围内
   - 验证条件值不能为负数
   - 验证条件值不能超过最大值

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范
   - 业务逻辑与数据访问层分离

5. **功能正确性**
   - GetByID方法正确处理参数验证和错误
   - GetAll方法正确返回等级列表
   - Create方法正确验证输入并创建等级（包括等级达成条件验证）
   - Update方法正确验证输入并更新等级（包括等级达成条件验证）
   - Delete方法正确验证并删除等级

## 相关文件

- `internal/pkg/service/level_service.go` - 等级服务接口和实现
- `internal/pkg/repository/level_repository.go` - 等级仓储接口
- `internal/pkg/enum/level_condition_type.go` - 等级达成条件类型枚举
- `docs/TASKS/TASK004/TASK004-16.md` - 实现等级达成条件枚举任务文档
- `docs/TASKS/TASK004/TASK004-17.md` - 实现LevelRepository接口任务文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 14:54:20 CST

