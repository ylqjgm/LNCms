# TASK004-30: 创建AuthorLevel模型

## 任务信息

**任务编号**: TASK004-30  
**父任务**: TASK004  
**任务名称**: 创建AuthorLevel模型  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:25:47 CST

## 任务描述

创建作者等级管理的GORM模型，定义作者等级表结构。包括：1) 创建AuthorLevel模型，定义字段（id、name、description、conditions、created_at、updated_at）；2) 添加模型标签和索引定义；3) 添加表注释。conditions字段使用JSONB类型存储作者等级达成条件。所有代码必须遵循Golang编码规范和PostgreSQL数据库设计规范。参考TASK002-06数据库设计任务。

## 依赖任务

无

## 实现指南

### 1. 参考数据库设计

阅读 `docs/TASKS/TASK002/TASK002-06.md` 文档，了解作者等级表的数据库设计：
- 表名：`author_levels`
- 字段：id、name、description、conditions、created_at、updated_at
- 索引：主键索引（id）、普通索引（name）
- conditions字段使用JSONB类型存储作者等级达成条件

### 2. 创建AuthorLevel模型

在 `internal/pkg/model/author_level.go` 文件中创建AuthorLevel结构体：

```go
package model

import (
    "database/sql/driver"
    "encoding/json"
    "time"
    "gorm.io/gorm"
)

// AuthorLevelConditions 作者等级达成条件结构
type AuthorLevelConditions struct {
    // ConditionType 条件类型：works_count-作品数、avg_rating-平均评分、recommend_count-推荐数、vote_count-投票数、comment_count-评论数、tip_count-打赏数
    ConditionType string `json:"condition_type"`
    
    // ConditionValue 条件值
    ConditionValue int64 `json:"condition_value"`
}

// Value 实现driver.Valuer接口，用于数据库存储
func (alc AuthorLevelConditions) Value() (driver.Value, error) {
    return json.Marshal(alc)
}

// Scan 实现sql.Scanner接口，用于数据库读取
func (alc *AuthorLevelConditions) Scan(value interface{}) error {
    if value == nil {
        return nil
    }
    bytes, ok := value.([]byte)
    if !ok {
        return fmt.Errorf("无法将 %T 转换为 []byte", value)
    }
    return json.Unmarshal(bytes, alc)
}

// AuthorLevel 作者等级模型
// 用于存储作者等级信息，包括等级名称、描述和达成条件
// 表名: author_levels
// 索引: pk_author_levels (id), idx_author_levels_name (name)
type AuthorLevel struct {
    // ID 作者等级ID，自增主键
    ID int64 `gorm:"primaryKey;autoIncrement" json:"id"`
    
    // Name 作者等级名称，用于标识等级
    Name string `gorm:"type:varchar(100);not null;index:idx_author_levels_name" json:"name"`
    
    // Description 作者等级描述，说明等级的用途和特点
    Description *string `gorm:"type:text" json:"description,omitempty"`
    
    // Conditions 作者等级达成条件，使用JSONB类型存储
    // 存储格式：{"condition_type": "works_count", "condition_value": 10}
    Conditions AuthorLevelConditions `gorm:"type:jsonb" json:"conditions"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"type:timestamptz;default:current_timestamp" json:"created_at"`
    
    // UpdatedAt 更新时间，自动设置为当前时间
    UpdatedAt time.Time `gorm:"type:timestamptz;default:current_timestamp" json:"updated_at"`
    
    // DeletedAt 软删除时间（GORM软删除支持）
    DeletedAt gorm.DeletedAt `gorm:"index" json:"deleted_at,omitempty"`
}

// TableName 指定表名
func (AuthorLevel) TableName() string {
    return "author_levels"
}
```

### 3. 验证模型定义

确保模型定义符合以下要求：

- 主键字段使用 `bigserial` 类型（GORM会自动映射为int64）
- `name` 字段使用 `varchar(100)` 类型，设置索引
- `description` 字段使用 `text` 类型，允许为空
- `conditions` 字段使用 `jsonb` 类型，存储作者等级达成条件
- `AuthorLevelConditions` 结构体实现了 `driver.Valuer` 和 `sql.Scanner` 接口
- 时间字段使用 `timestamptz` 类型，支持时区
- 所有字段都有适当的GORM标签和JSON标签
- 模型实现了 `TableName()` 方法，明确指定表名
- 支持GORM软删除功能（DeletedAt字段）

### 4. 代码规范要求

- 所有注释使用中文
- 字段命名遵循Golang编码规范（驼峰命名）
- JSON标签使用小写字母和下划线（snake_case）
- GORM标签完整，包括类型、约束、索引等
- 模型结构清晰，职责单一

## 验收标准

1. **AuthorLevel模型正确定义**
   - 模型包含所有必需字段：id、name、description、conditions、created_at、updated_at
   - 字段类型正确，符合PostgreSQL数据库设计规范
   - GORM标签完整，包括主键、索引、类型等

2. **AuthorLevelConditions结构体正确定义**
   - AuthorLevelConditions结构体包含condition_type和condition_value字段
   - 实现了driver.Valuer接口（Value方法）
   - 实现了sql.Scanner接口（Scan方法）
   - JSON序列化和反序列化正常工作

3. **索引定义正确**
   - name字段定义了普通索引（idx_author_levels_name）
   - 索引命名符合PostgreSQL命名规范

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 字段命名符合Golang编码规范
   - JSON标签使用小写字母和下划线

5. **模型结构清晰**
   - 模型职责单一，只负责数据模型定义
   - 不包含业务逻辑代码
   - 不包含仓储层或服务层代码
   - 实现了TableName()方法

6. **与数据库设计一致**
   - 模型字段与TASK002-06数据库设计保持一致
   - 字段类型和约束与数据库设计匹配
   - conditions字段使用JSONB类型存储

## 相关文件

- `internal/pkg/model/author_level.go` - 作者等级模型定义
- `docs/TASKS/TASK002/TASK002-06.md` - 作者等级表数据库设计文档
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:25:47 CST

