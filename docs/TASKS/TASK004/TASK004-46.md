# TASK004-46: 编写PermissionService单元测试

## 任务信息

**任务编号**: TASK004-46  
**父任务**: TASK004  
**任务名称**: 编写PermissionService单元测试  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:00:00 CST

## 任务描述

编写权限服务层单元测试。包括：1) 测试PermissionService的所有方法；2) 测试权限分配功能；3) 测试权限查询功能；4) 测试权限缓存功能；5) 使用Mock Repository和Mock Redis进行测试；6) 确保测试覆盖率达标。所有测试用例描述和错误消息必须使用中文。

## 依赖任务

- TASK004-45: 创建PermissionService接口和实现

## 实现指南

### 1. 测试文件组织

创建测试文件：
- `internal/pkg/service/permission_service_test.go` - PermissionService测试

### 2. 测试辅助函数和Mock

在测试文件中创建Mock Repository和Mock Redis：

```go
package service

import (
    "context"
    "encoding/json"
    "testing"
    "time"
    
    "github.com/redis/go-redis/v9"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/require"
    "yourproject/internal/pkg/model"
    "yourproject/internal/pkg/repository"
)

// MockPermissionRepository Mock权限仓储
type MockPermissionRepository struct {
    mock.Mock
}

func (m *MockPermissionRepository) GetByID(ctx context.Context, id int64) (*model.Permission, error) {
    args := m.Called(ctx, id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*model.Permission), args.Error(1)
}

func (m *MockPermissionRepository) GetAll(ctx context.Context) ([]*model.Permission, error) {
    args := m.Called(ctx)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).([]*model.Permission), args.Error(1)
}

func (m *MockPermissionRepository) GetByPermissionName(ctx context.Context, permissionName string) (*model.Permission, error) {
    args := m.Called(ctx, permissionName)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*model.Permission), args.Error(1)
}

func (m *MockPermissionRepository) Create(ctx context.Context, permission *model.Permission) error {
    args := m.Called(ctx, permission)
    return args.Error(0)
}

func (m *MockPermissionRepository) Update(ctx context.Context, permission *model.Permission) error {
    args := m.Called(ctx, permission)
    return args.Error(0)
}

func (m *MockPermissionRepository) Delete(ctx context.Context, id int64) error {
    args := m.Called(ctx, id)
    return args.Error(0)
}

// MockRolePermissionRepository Mock角色权限关联仓储
type MockRolePermissionRepository struct {
    mock.Mock
}

func (m *MockRolePermissionRepository) GetByRoleID(ctx context.Context, roleID int64) ([]*model.RolePermission, error) {
    args := m.Called(ctx, roleID)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).([]*model.RolePermission), args.Error(1)
}

func (m *MockRolePermissionRepository) BatchCreate(ctx context.Context, rolePermissions []*model.RolePermission) error {
    args := m.Called(ctx, rolePermissions)
    return args.Error(0)
}

func (m *MockRolePermissionRepository) BatchDelete(ctx context.Context, roleID int64, permissionIDs []int64) error {
    args := m.Called(ctx, roleID, permissionIDs)
    return args.Error(0)
}

// MockRedisClient Mock Redis客户端
type MockRedisClient struct {
    mock.Mock
    data map[string]string
}

func NewMockRedisClient() *MockRedisClient {
    return &MockRedisClient{
        data: make(map[string]string),
    }
}

func (m *MockRedisClient) Get(ctx context.Context, key string) *redis.StringCmd {
    args := m.Called(ctx, key)
    cmd := redis.NewStringCmd(ctx)
    if val, ok := m.data[key]; ok {
        cmd.SetVal(val)
    } else {
        cmd.SetErr(redis.Nil)
    }
    return cmd
}

func (m *MockRedisClient) Set(ctx context.Context, key string, value interface{}, expiration time.Duration) *redis.StatusCmd {
    args := m.Called(ctx, key, value, expiration)
    cmd := redis.NewStatusCmd(ctx)
    if str, ok := value.(string); ok {
        m.data[key] = str
    } else if bytes, ok := value.([]byte); ok {
        m.data[key] = string(bytes)
    }
    cmd.SetVal("OK")
    return cmd
}

func (m *MockRedisClient) Del(ctx context.Context, keys ...string) *redis.IntCmd {
    args := m.Called(ctx, keys)
    cmd := redis.NewIntCmd(ctx)
    deleted := int64(0)
    for _, key := range keys {
        if _, ok := m.data[key]; ok {
            delete(m.data, key)
            deleted++
        }
    }
    cmd.SetVal(deleted)
    return cmd
}
```

### 3. 测试权限CRUD方法

```go
func TestPermissionService_GetByID(t *testing.T) {
    mockPermissionRepo := new(MockPermissionRepository)
    mockRolePermissionRepo := new(MockRolePermissionRepository)
    mockUserGroupPermissionRepo := new(MockUserGroupPermissionRepository)
    mockRedis := NewMockRedisClient()
    
    service := NewPermissionService(
        mockPermissionRepo,
        mockRolePermissionRepo,
        mockUserGroupPermissionRepo,
        mockRedis,
    )
    
    ctx := context.Background()
    
    tests := []struct {
        name    string
        id      int64
        setup   func()
        wantErr bool
        errMsg  string
    }{
        {
            name: "有效权限ID",
            id:  1,
            setup: func() {
                permission := &model.Permission{
                    ID: 1,
                    PermissionName: "test.permission",
                }
                mockPermissionRepo.On("GetByID", ctx, int64(1)).Return(permission, nil)
            },
            wantErr: false,
        },
        {
            name: "无效权限ID",
            id:  0,
            setup: func() {},
            wantErr: true,
            errMsg: "权限ID无效",
        },
        {
            name: "权限不存在",
            id:  999,
            setup: func() {
                mockPermissionRepo.On("GetByID", ctx, int64(999)).Return(nil, fmt.Errorf("权限不存在"))
            },
            wantErr: true,
            errMsg: "权限不存在",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            tt.setup()
            got, err := service.GetByID(ctx, tt.id)
            if tt.wantErr {
                assert.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                assert.Nil(t, got)
            } else {
                assert.NoError(t, err)
                assert.NotNil(t, got)
            }
            mockPermissionRepo.AssertExpectations(t)
        })
    }
}

// 继续编写其他CRUD方法的测试...
```

### 4. 测试权限分配功能

```go
func TestPermissionService_AssignPermissionsToRole(t *testing.T) {
    mockPermissionRepo := new(MockPermissionRepository)
    mockRolePermissionRepo := new(MockRolePermissionRepository)
    mockUserGroupPermissionRepo := new(MockUserGroupPermissionRepository)
    mockRedis := NewMockRedisClient()
    
    service := NewPermissionService(
        mockPermissionRepo,
        mockRolePermissionRepo,
        mockUserGroupPermissionRepo,
        mockRedis,
    )
    
    ctx := context.Background()
    
    tests := []struct {
        name         string
        roleID       int64
        permissionIDs []int64
        setup        func()
        wantErr      bool
        errMsg       string
    }{
        {
            name: "成功分配权限",
            roleID: 1,
            permissionIDs: []int64{1, 2},
            setup: func() {
                permission1 := &model.Permission{ID: 1}
                permission2 := &model.Permission{ID: 2}
                mockPermissionRepo.On("GetByID", ctx, int64(1)).Return(permission1, nil)
                mockPermissionRepo.On("GetByID", ctx, int64(2)).Return(permission2, nil)
                mockRolePermissionRepo.On("BatchCreate", ctx, mock.Anything).Return(nil)
                mockRedis.On("Del", ctx, []string{"permission:role:1"}).Return(redis.NewIntCmd(ctx))
            },
            wantErr: false,
        },
        {
            name: "无效角色ID",
            roleID: 0,
            permissionIDs: []int64{1},
            setup: func() {},
            wantErr: true,
            errMsg: "角色ID无效",
        },
        {
            name: "权限不存在",
            roleID: 1,
            permissionIDs: []int64{999},
            setup: func() {
                mockPermissionRepo.On("GetByID", ctx, int64(999)).Return(nil, fmt.Errorf("权限不存在"))
            },
            wantErr: true,
            errMsg: "权限ID 999 不存在",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            tt.setup()
            err := service.AssignPermissionsToRole(ctx, tt.roleID, tt.permissionIDs)
            if tt.wantErr {
                assert.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
            } else {
                assert.NoError(t, err)
            }
        })
    }
}
```

### 5. 测试权限查询功能（包括缓存）

```go
func TestPermissionService_GetRolePermissions(t *testing.T) {
    mockPermissionRepo := new(MockPermissionRepository)
    mockRolePermissionRepo := new(MockRolePermissionRepository)
    mockUserGroupPermissionRepo := new(MockUserGroupPermissionRepository)
    mockRedis := NewMockRedisClient()
    
    service := NewPermissionService(
        mockPermissionRepo,
        mockRolePermissionRepo,
        mockUserGroupPermissionRepo,
        mockRedis,
    )
    
    ctx := context.Background()
    
    // 测试从缓存获取
    t.Run("从缓存获取权限", func(t *testing.T) {
        permissions := []*model.Permission{
            {ID: 1, PermissionName: "permission1"},
            {ID: 2, PermissionName: "permission2"},
        }
        data, _ := json.Marshal(permissions)
        mockRedis.data["permission:role:1"] = string(data)
        
        got, err := service.GetRolePermissions(ctx, 1)
        assert.NoError(t, err)
        assert.Len(t, got, 2)
    })
    
    // 测试从数据库获取并缓存
    t.Run("从数据库获取并缓存", func(t *testing.T) {
        rolePermissions := []*model.RolePermission{
            {RoleID: 2, PermissionID: 3},
            {RoleID: 2, PermissionID: 4},
        }
        permission3 := &model.Permission{ID: 3, PermissionName: "permission3"}
        permission4 := &model.Permission{ID: 4, PermissionName: "permission4"}
        
        mockRolePermissionRepo.On("GetByRoleID", ctx, int64(2)).Return(rolePermissions, nil)
        mockPermissionRepo.On("GetByID", ctx, int64(3)).Return(permission3, nil)
        mockPermissionRepo.On("GetByID", ctx, int64(4)).Return(permission4, nil)
        mockRedis.On("Set", ctx, "permission:role:2", mock.Anything, mock.Anything).Return(redis.NewStatusCmd(ctx))
        
        got, err := service.GetRolePermissions(ctx, 2)
        assert.NoError(t, err)
        assert.Len(t, got, 2)
        
        // 验证已缓存
        _, ok := mockRedis.data["permission:role:2"]
        assert.True(t, ok)
    })
}
```

### 6. 测试缓存清除功能

```go
func TestPermissionService_ClearCache(t *testing.T) {
    mockPermissionRepo := new(MockPermissionRepository)
    mockRolePermissionRepo := new(MockRolePermissionRepository)
    mockUserGroupPermissionRepo := new(MockUserGroupPermissionRepository)
    mockRedis := NewMockRedisClient()
    
    service := NewPermissionService(
        mockPermissionRepo,
        mockRolePermissionRepo,
        mockUserGroupPermissionRepo,
        mockRedis,
    )
    
    ctx := context.Background()
    
    // 测试更新权限时清除缓存
    t.Run("更新权限时清除缓存", func(t *testing.T) {
        permission := &model.Permission{
            ID: 1,
            PermissionName: "test.permission",
        }
        req := &UpdatePermissionRequest{
            PermissionName: "updated.permission",
            IsActive: true,
        }
        
        mockPermissionRepo.On("GetByID", ctx, int64(1)).Return(permission, nil)
        mockPermissionRepo.On("GetByPermissionName", ctx, "updated.permission").Return(nil, fmt.Errorf("权限不存在"))
        mockPermissionRepo.On("Update", ctx, mock.Anything).Return(nil)
        mockRedis.On("Del", ctx, mock.Anything).Return(redis.NewIntCmd(ctx))
        
        _, err := service.Update(ctx, 1, req)
        assert.NoError(t, err)
    })
}
```

### 7. 测试边界情况和异常情况

```go
func TestPermissionService_AssignPermissionsToRole_EmptyList(t *testing.T) {
    mockPermissionRepo := new(MockPermissionRepository)
    mockRolePermissionRepo := new(MockRolePermissionRepository)
    mockUserGroupPermissionRepo := new(MockUserGroupPermissionRepository)
    mockRedis := NewMockRedisClient()
    
    service := NewPermissionService(
        mockPermissionRepo,
        mockRolePermissionRepo,
        mockUserGroupPermissionRepo,
        mockRedis,
    )
    
    ctx := context.Background()
    
    // 空权限列表应该不报错
    err := service.AssignPermissionsToRole(ctx, 1, []int64{})
    assert.NoError(t, err)
}
```

### 8. 代码规范要求

- 所有测试用例描述使用中文
- 使用表驱动测试处理多个测试场景
- 使用testify的assert和require包
- 使用Mock Repository和Mock Redis
- 每个测试用例独立，不依赖其他测试
- 测试覆盖率应达到80%以上

## 验收标准

1. **测试覆盖完整**
   - PermissionService的所有方法都有测试用例
   - 测试覆盖正常情况、边界情况和异常情况
   - 测试覆盖权限分配功能
   - 测试覆盖权限查询功能（包括缓存）
   - 测试覆盖缓存清除功能

2. **测试用例质量**
   - 测试用例描述清晰，使用中文
   - 使用表驱动测试处理多个场景
   - 测试用例独立，不依赖执行顺序
   - 使用适当的断言和验证

3. **Mock使用正确**
   - 正确使用Mock Repository
   - 正确使用Mock Redis
   - Mock设置和验证正确

4. **测试覆盖率达标**
   - 代码覆盖率应达到80%以上
   - 关键路径覆盖率应达到90%以上
   - 使用go test -cover检查覆盖率

5. **代码规范符合要求**
   - 代码通过golangci-lint检查
   - 测试代码注释完整，使用中文
   - 遵循Golang编码规范和测试规范

## 相关文件

- `internal/pkg/service/permission_service_test.go` - PermissionService测试
- `internal/pkg/service/permission_service.go` - PermissionService实现
- `.cursor/rules/testing.mdc` - 单元测试规范
- `docs/TASKS/TASK004/TASK004-45.md` - 创建PermissionService接口任务文档
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:00:00 CST

