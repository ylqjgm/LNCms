# TASK004-05: 编写RoleService单元测试

## 任务信息

**任务编号**: TASK004-05  
**父任务**: TASK004  
**任务名称**: 编写RoleService单元测试  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:54:20 CST

## 任务描述

编写角色服务层单元测试。包括：1) 测试RoleService的所有方法；2) 测试输入验证功能；3) 使用Mock Repository进行测试；4) 确保测试覆盖率达标。所有测试用例描述和错误消息必须使用中文。

## 依赖任务

- TASK004-04: 创建RoleService接口和实现

## 实现指南

### 1. 设置测试环境

在 `internal/pkg/service/role_service_test.go` 文件中创建测试文件，使用Mock Repository：

```go
package service

import (
    "context"
    "errors"
    "testing"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/suite"
    "yourproject/internal/pkg/model"
)

// MockRoleRepository Mock角色仓储
type MockRoleRepository struct {
    mock.Mock
}

func (m *MockRoleRepository) GetByID(ctx context.Context, id int64) (*model.Role, error) {
    args := m.Called(ctx, id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*model.Role), args.Error(1)
}

func (m *MockRoleRepository) GetAll(ctx context.Context) ([]*model.Role, error) {
    args := m.Called(ctx)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).([]*model.Role), args.Error(1)
}

func (m *MockRoleRepository) Create(ctx context.Context, role *model.Role) error {
    args := m.Called(ctx, role)
    return args.Error(0)
}

func (m *MockRoleRepository) Update(ctx context.Context, role *model.Role) error {
    args := m.Called(ctx, role)
    return args.Error(0)
}

func (m *MockRoleRepository) Delete(ctx context.Context, id int64) error {
    args := m.Called(ctx, id)
    return args.Error(0)
}

func (m *MockRoleRepository) GetByRoleName(ctx context.Context, roleName string) (*model.Role, error) {
    args := m.Called(ctx, roleName)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*model.Role), args.Error(1)
}

// RoleServiceTestSuite 角色服务测试套件
type RoleServiceTestSuite struct {
    suite.Suite
    mockRepo *MockRoleRepository
    service  RoleService
    ctx      context.Context
}

// SetupTest 每个测试前的设置
func (s *RoleServiceTestSuite) SetupTest() {
    s.mockRepo = new(MockRoleRepository)
    s.service = NewRoleService(s.mockRepo)
    s.ctx = context.Background()
}

// TearDownTest 每个测试后的清理
func (s *RoleServiceTestSuite) TearDownTest() {
    s.mockRepo.AssertExpectations(s.T())
}
```

### 2. 测试GetByID方法

测试GetByID方法的正常情况和异常情况：

```go
// TestGetByID 测试GetByID方法
func (s *RoleServiceTestSuite) TestGetByID() {
    tests := []struct {
        name    string
        id      int64
        mockFn  func()
        wantErr bool
        errMsg  string
    }{
        {
            name: "正常情况：获取存在的角色",
            id:   1,
            mockFn: func() {
                s.mockRepo.On("GetByID", s.ctx, int64(1)).
                    Return(&model.Role{ID: 1, RoleName: "测试角色"}, nil)
            },
            wantErr: false,
        },
        {
            name: "异常情况：角色ID无效",
            id:   0,
            mockFn: func() {
                // 不需要Mock调用
            },
            wantErr: true,
            errMsg:  "角色ID无效",
        },
        {
            name: "异常情况：角色不存在",
            id:   999,
            mockFn: func() {
                s.mockRepo.On("GetByID", s.ctx, int64(999)).
                    Return(nil, errors.New("角色不存在"))
            },
            wantErr: true,
        },
    }
    
    for _, tt := range tests {
        s.T().Run(tt.name, func(t *testing.T) {
            tt.mockFn()
            got, err := s.service.GetByID(s.ctx, tt.id)
            if tt.wantErr {
                assert.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                assert.Nil(t, got)
            } else {
                assert.NoError(t, err)
                assert.NotNil(t, got)
                assert.Equal(t, tt.id, got.ID)
            }
        })
    }
}
```

### 3. 测试Create方法

测试Create方法的输入验证和业务逻辑：

```go
// TestCreate 测试Create方法
func (s *RoleServiceTestSuite) TestCreate() {
    tests := []struct {
        name    string
        req     *CreateRoleRequest
        mockFn  func()
        wantErr bool
        errMsg  string
    }{
        {
            name: "正常情况：创建角色",
            req: &CreateRoleRequest{
                RoleName:        "新角色",
                RoleDescription: stringPtr("角色描述"),
                IsActive:        true,
            },
            mockFn: func() {
                s.mockRepo.On("GetByRoleName", s.ctx, "新角色").
                    Return(nil, errors.New("角色不存在"))
                s.mockRepo.On("Create", s.ctx, mock.AnythingOfType("*model.Role")).
                    Return(nil)
            },
            wantErr: false,
        },
        {
            name: "异常情况：请求参数为空",
            req:  nil,
            mockFn: func() {
                // 不需要Mock调用
            },
            wantErr: true,
            errMsg:  "请求参数不能为空",
        },
        {
            name: "异常情况：角色名称为空",
            req: &CreateRoleRequest{
                RoleName: "",
            },
            mockFn: func() {
                // 不需要Mock调用
            },
            wantErr: true,
            errMsg:  "角色名称不能为空",
        },
        {
            name: "异常情况：角色名称已存在",
            req: &CreateRoleRequest{
                RoleName: "已存在角色",
            },
            mockFn: func() {
                s.mockRepo.On("GetByRoleName", s.ctx, "已存在角色").
                    Return(&model.Role{ID: 1, RoleName: "已存在角色"}, nil)
            },
            wantErr: true,
            errMsg:  "角色名称已存在",
        },
    }
    
    for _, tt := range tests {
        s.T().Run(tt.name, func(t *testing.T) {
            tt.mockFn()
            got, err := s.service.Create(s.ctx, tt.req)
            if tt.wantErr {
                assert.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                assert.Nil(t, got)
            } else {
                assert.NoError(t, err)
                assert.NotNil(t, got)
            }
        })
    }
}
```

### 4. 测试Update方法

测试Update方法，包括系统角色检查：

```go
// TestUpdate 测试Update方法
func (s *RoleServiceTestSuite) TestUpdate() {
    tests := []struct {
        name    string
        id      int64
        req     *UpdateRoleRequest
        mockFn  func()
        wantErr bool
        errMsg  string
    }{
        {
            name: "正常情况：更新角色",
            id:   1,
            req: &UpdateRoleRequest{
                RoleName:        "更新后的角色名",
                RoleDescription: stringPtr("更新后的描述"),
                IsActive:        true,
            },
            mockFn: func() {
                s.mockRepo.On("GetByID", s.ctx, int64(1)).
                    Return(&model.Role{ID: 1, RoleName: "原角色名", IsSystem: false}, nil)
                s.mockRepo.On("GetByRoleName", s.ctx, "更新后的角色名").
                    Return(nil, errors.New("角色不存在"))
                s.mockRepo.On("Update", s.ctx, mock.AnythingOfType("*model.Role")).
                    Return(nil)
            },
            wantErr: false,
        },
        {
            name: "异常情况：系统角色不允许修改",
            id:   1,
            req: &UpdateRoleRequest{
                RoleName: "新角色名",
            },
            mockFn: func() {
                s.mockRepo.On("GetByID", s.ctx, int64(1)).
                    Return(&model.Role{ID: 1, RoleName: "系统角色", IsSystem: true}, nil)
            },
            wantErr: true,
            errMsg:  "系统角色不允许修改",
        },
    }
    
    for _, tt := range tests {
        s.T().Run(tt.name, func(t *testing.T) {
            tt.mockFn()
            got, err := s.service.Update(s.ctx, tt.id, tt.req)
            if tt.wantErr {
                assert.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                assert.Nil(t, got)
            } else {
                assert.NoError(t, err)
                assert.NotNil(t, got)
            }
        })
    }
}
```

### 5. 测试Delete方法

测试Delete方法，包括系统角色检查：

```go
// TestDelete 测试Delete方法
func (s *RoleServiceTestSuite) TestDelete() {
    tests := []struct {
        name    string
        id      int64
        mockFn  func()
        wantErr bool
        errMsg  string
    }{
        {
            name: "正常情况：删除角色",
            id:   1,
            mockFn: func() {
                s.mockRepo.On("GetByID", s.ctx, int64(1)).
                    Return(&model.Role{ID: 1, RoleName: "测试角色", IsSystem: false}, nil)
                s.mockRepo.On("Delete", s.ctx, int64(1)).
                    Return(nil)
            },
            wantErr: false,
        },
        {
            name: "异常情况：系统角色不允许删除",
            id:   1,
            mockFn: func() {
                s.mockRepo.On("GetByID", s.ctx, int64(1)).
                    Return(&model.Role{ID: 1, RoleName: "系统角色", IsSystem: true}, nil)
            },
            wantErr: true,
            errMsg:  "系统角色不允许删除",
        },
    }
    
    for _, tt := range tests {
        s.T().Run(tt.name, func(t *testing.T) {
            tt.mockFn()
            err := s.service.Delete(s.ctx, tt.id)
            if tt.wantErr {
                assert.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
            } else {
                assert.NoError(t, err)
            }
        })
    }
}

// stringPtr 辅助函数
func stringPtr(s string) *string {
    return &s
}

// TestRoleServiceTestSuite 运行测试套件
func TestRoleServiceTestSuite(t *testing.T) {
    suite.Run(t, new(RoleServiceTestSuite))
}
```

## 验收标准

1. **测试覆盖完整**
   - 测试覆盖RoleService的所有方法
   - 每个方法都测试了正常情况和异常情况
   - 测试覆盖输入验证逻辑
   - 测试覆盖业务规则验证（如系统角色检查、角色名称唯一性检查等）

2. **Mock使用正确**
   - 使用Mock Repository替代真实数据库
   - Mock设置正确，覆盖所有测试场景
   - 使用testify/mock进行Mock

3. **测试用例质量**
   - 使用表驱动测试处理多个测试场景
   - 测试用例名称清晰描述测试场景（使用中文）
   - 测试用例独立，不依赖执行顺序
   - 使用testify/suite组织测试代码

4. **代码覆盖率达标**
   - 测试覆盖率应达到80%以上
   - 关键业务逻辑路径都有测试覆盖
   - 错误处理路径都有测试覆盖

5. **代码规范符合要求**
   - 测试代码通过golangci-lint检查
   - 测试用例描述和错误消息使用中文
   - 遵循Golang单元测试规范

## 相关文件

- `internal/pkg/service/role_service_test.go` - 角色服务单元测试文件
- `internal/pkg/service/role_service.go` - 角色服务接口和实现
- `docs/TASKS/TASK004/TASK004-04.md` - 创建RoleService接口任务文档
- `.cursor/rules/testing.mdc` - 单元测试规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 14:54:20 CST

