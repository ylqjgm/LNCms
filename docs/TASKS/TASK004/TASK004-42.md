# TASK004-42: 实现RolePermissionRepository接口和实现

## 任务信息

**任务编号**: TASK004-42  
**父任务**: TASK004  
**任务名称**: 实现RolePermissionRepository接口和实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 15:00:00 CST

## 任务描述

实现RolePermissionRepository接口，提供角色权限关联的CRUD操作。包括：1) 定义RolePermissionRepository接口；2) 实现角色权限关联的创建、查询、删除方法（Create、GetByRoleID、GetByPermissionID、Delete）；3) 实现批量操作方法（BatchCreate、BatchDelete）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK004-39: 创建RolePermission模型

## 实现指南

### 1. 参考数据库设计

阅读 `docs/TASKS/TASK002/TASK002-08.md` 文档，了解角色权限关联表的数据库设计：
- 表名：`role_permissions`
- 字段：id、role_id、permission_id、created_at
- 外键：role_id关联roles表，permission_id关联permissions表
- 唯一约束：role_id和permission_id的组合唯一

### 2. 定义RolePermissionRepository接口

在 `internal/pkg/repository/role_permission_repository.go` 文件中定义接口：

```go
package repository

import (
    "context"
    "yourproject/internal/pkg/model"
)

// RolePermissionRepository 角色权限关联仓储接口
type RolePermissionRepository interface {
    // Create 创建角色权限关联
    Create(ctx context.Context, rolePermission *model.RolePermission) error
    
    // GetByRoleID 根据角色ID获取权限列表
    GetByRoleID(ctx context.Context, roleID int64) ([]*model.RolePermission, error)
    
    // GetByPermissionID 根据权限ID获取角色列表
    GetByPermissionID(ctx context.Context, permissionID int64) ([]*model.RolePermission, error)
    
    // GetByRoleIDAndPermissionID 根据角色ID和权限ID获取关联
    GetByRoleIDAndPermissionID(ctx context.Context, roleID, permissionID int64) (*model.RolePermission, error)
    
    // Delete 删除角色权限关联
    Delete(ctx context.Context, id int64) error
    
    // DeleteByRoleIDAndPermissionID 根据角色ID和权限ID删除关联
    DeleteByRoleIDAndPermissionID(ctx context.Context, roleID, permissionID int64) error
    
    // BatchCreate 批量创建角色权限关联
    BatchCreate(ctx context.Context, rolePermissions []*model.RolePermission) error
    
    // BatchDelete 批量删除角色权限关联
    BatchDelete(ctx context.Context, roleID int64, permissionIDs []int64) error
}
```

### 3. 实现rolePermissionRepository结构体

在同一个文件中实现角色权限关联仓储：

```go
import (
    "context"
    "fmt"
    "gorm.io/gorm"
    "yourproject/internal/pkg/model"
)

// rolePermissionRepository 角色权限关联仓储实现
type rolePermissionRepository struct {
    db *gorm.DB
}

// NewRolePermissionRepository 创建角色权限关联仓储实例
func NewRolePermissionRepository(db *gorm.DB) RolePermissionRepository {
    return &rolePermissionRepository{db: db}
}
```

### 4. 实现Create方法

实现创建角色权限关联的方法：

```go
// Create 创建角色权限关联
func (r *rolePermissionRepository) Create(ctx context.Context, rolePermission *model.RolePermission) error {
    if err := r.db.WithContext(ctx).Create(rolePermission).Error; err != nil {
        return fmt.Errorf("创建角色权限关联失败: %w", err)
    }
    return nil
}
```

### 5. 实现GetByRoleID方法

实现根据角色ID获取权限列表的方法：

```go
// GetByRoleID 根据角色ID获取权限列表
func (r *rolePermissionRepository) GetByRoleID(ctx context.Context, roleID int64) ([]*model.RolePermission, error) {
    var rolePermissions []*model.RolePermission
    err := r.db.WithContext(ctx).
        Where("role_id = ?", roleID).
        Find(&rolePermissions).Error
    if err != nil {
        return nil, fmt.Errorf("查询角色权限关联失败: %w", err)
    }
    return rolePermissions, nil
}
```

### 6. 实现GetByPermissionID方法

实现根据权限ID获取角色列表的方法：

```go
// GetByPermissionID 根据权限ID获取角色列表
func (r *rolePermissionRepository) GetByPermissionID(ctx context.Context, permissionID int64) ([]*model.RolePermission, error) {
    var rolePermissions []*model.RolePermission
    err := r.db.WithContext(ctx).
        Where("permission_id = ?", permissionID).
        Find(&rolePermissions).Error
    if err != nil {
        return nil, fmt.Errorf("查询角色权限关联失败: %w", err)
    }
    return rolePermissions, nil
}
```

### 7. 实现GetByRoleIDAndPermissionID方法

实现根据角色ID和权限ID获取关联的方法：

```go
// GetByRoleIDAndPermissionID 根据角色ID和权限ID获取关联
func (r *rolePermissionRepository) GetByRoleIDAndPermissionID(ctx context.Context, roleID, permissionID int64) (*model.RolePermission, error) {
    var rolePermission model.RolePermission
    err := r.db.WithContext(ctx).
        Where("role_id = ? AND permission_id = ?", roleID, permissionID).
        First(&rolePermission).Error
    if err != nil {
        if err == gorm.ErrRecordNotFound {
            return nil, fmt.Errorf("角色权限关联不存在")
        }
        return nil, fmt.Errorf("查询角色权限关联失败: %w", err)
    }
    return &rolePermission, nil
}
```

### 8. 实现Delete方法

实现删除角色权限关联的方法：

```go
// Delete 删除角色权限关联
func (r *rolePermissionRepository) Delete(ctx context.Context, id int64) error {
    result := r.db.WithContext(ctx).
        Where("id = ?", id).
        Delete(&model.RolePermission{})
    if result.Error != nil {
        return fmt.Errorf("删除角色权限关联失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("角色权限关联不存在")
    }
    return nil
}
```

### 9. 实现DeleteByRoleIDAndPermissionID方法

实现根据角色ID和权限ID删除关联的方法：

```go
// DeleteByRoleIDAndPermissionID 根据角色ID和权限ID删除关联
func (r *rolePermissionRepository) DeleteByRoleIDAndPermissionID(ctx context.Context, roleID, permissionID int64) error {
    result := r.db.WithContext(ctx).
        Where("role_id = ? AND permission_id = ?", roleID, permissionID).
        Delete(&model.RolePermission{})
    if result.Error != nil {
        return fmt.Errorf("删除角色权限关联失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("角色权限关联不存在")
    }
    return nil
}
```

### 10. 实现BatchCreate方法

实现批量创建角色权限关联的方法：

```go
// BatchCreate 批量创建角色权限关联
func (r *rolePermissionRepository) BatchCreate(ctx context.Context, rolePermissions []*model.RolePermission) error {
    if len(rolePermissions) == 0 {
        return nil
    }
    if err := r.db.WithContext(ctx).CreateInBatches(rolePermissions, 100).Error; err != nil {
        return fmt.Errorf("批量创建角色权限关联失败: %w", err)
    }
    return nil
}
```

### 11. 实现BatchDelete方法

实现批量删除角色权限关联的方法：

```go
// BatchDelete 批量删除角色权限关联
func (r *rolePermissionRepository) BatchDelete(ctx context.Context, roleID int64, permissionIDs []int64) error {
    if len(permissionIDs) == 0 {
        return nil
    }
    result := r.db.WithContext(ctx).
        Where("role_id = ? AND permission_id IN ?", roleID, permissionIDs).
        Delete(&model.RolePermission{})
    if result.Error != nil {
        return fmt.Errorf("批量删除角色权限关联失败: %w", result.Error)
    }
    return nil
}
```

### 12. 代码规范要求

- 所有错误消息使用中文
- 使用context.Context传递上下文
- 使用GORM的WithContext方法
- 处理GORM错误，包括RecordNotFound错误
- 在Delete方法中检查RowsAffected
- 批量操作使用CreateInBatches提高性能
- 所有方法都有清晰的注释（使用中文）

## 验收标准

1. **接口定义完整**
   - RolePermissionRepository接口包含所有必需的方法：Create、GetByRoleID、GetByPermissionID、GetByRoleIDAndPermissionID、Delete、DeleteByRoleIDAndPermissionID、BatchCreate、BatchDelete
   - 方法签名正确，参数和返回值类型正确
   - 接口注释完整，使用中文

2. **实现完整**
   - rolePermissionRepository结构体正确实现RolePermissionRepository接口
   - 所有接口方法都有对应的实现
   - 使用GORM进行数据库操作
   - 使用context.Context传递上下文

3. **错误处理正确**
   - 所有错误都使用中文错误消息
   - 正确处理GORM的RecordNotFound错误
   - Delete方法检查RowsAffected
   - 错误消息清晰，包含上下文信息

4. **批量操作实现正确**
   - BatchCreate方法使用CreateInBatches进行批量创建
   - BatchDelete方法正确批量删除关联
   - 批量操作处理空列表情况

5. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范
   - 遵循项目代码组织结构

6. **功能正确性**
   - Create方法正确创建角色权限关联
   - GetByRoleID方法正确查询角色的权限列表
   - GetByPermissionID方法正确查询权限的角色列表
   - GetByRoleIDAndPermissionID方法正确查询特定关联
   - Delete方法正确删除关联
   - DeleteByRoleIDAndPermissionID方法正确删除特定关联
   - BatchCreate方法正确批量创建关联
   - BatchDelete方法正确批量删除关联

## 相关文件

- `internal/pkg/repository/role_permission_repository.go` - 角色权限关联仓储接口和实现
- `internal/pkg/model/role_permission.go` - 角色权限关联模型定义
- `docs/TASKS/TASK004/TASK004-39.md` - 创建RolePermission模型任务文档
- `docs/TASKS/TASK002/TASK002-08.md` - 角色权限关联表数据库设计文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `docs/TASKS/TASK004/TASK004.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1.0  
**最后更新**: 2026-01-03 15:00:00 CST

