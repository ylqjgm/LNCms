# TASK001-39: 实现认证拦截器

## 任务信息

**任务编号**: TASK001-39  
**父任务**: TASK001  
**任务名称**: 实现认证拦截器  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现gRPC认证拦截器，在gRPC请求处理前进行身份认证，验证请求的认证信息（如Token、API Key等），认证失败时返回相应的错误。

## 依赖任务

- TASK001-37: 初始化gRPC服务器

## 实现指南

### 1. 创建认证拦截器文件

创建 `internal/grpc/interceptors/auth.go` 文件，实现认证拦截器。

### 2. 实现AuthUnaryInterceptor函数

实现 `AuthUnaryInterceptor` 函数（一元RPC拦截器）：

```go
// AuthUnaryInterceptor 认证拦截器（一元RPC）
func AuthUnaryInterceptor() grpc.UnaryServerInterceptor {
    return func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {
        // 从metadata中提取认证信息
        md, ok := metadata.FromIncomingContext(ctx)
        if !ok {
            return nil, status.Error(codes.Unauthenticated, "未找到认证信息")
        }
        
        // 提取Token或API Key
        tokens := md.Get("authorization")
        if len(tokens) == 0 {
            return nil, status.Error(codes.Unauthenticated, "未提供认证信息")
        }
        
        // 验证Token
        token := tokens[0]
        if !strings.HasPrefix(token, "Bearer ") {
            return nil, status.Error(codes.Unauthenticated, "认证信息格式错误")
        }
        
        token = strings.TrimPrefix(token, "Bearer ")
        
        // 验证Token有效性（根据实际需求实现）
        // userID, err := validateToken(token)
        // if err != nil {
        //     return nil, status.Error(codes.Unauthenticated, "认证失败")
        // }
        
        // 将用户信息设置到context
        // ctx = context.WithValue(ctx, "user_id", userID)
        
        // 继续处理请求
        return handler(ctx, req)
    }
}
```

### 3. 从context中提取认证信息

从context中提取认证信息（metadata），获取Token或API Key。

### 4. 验证认证信息的有效性

验证认证信息的有效性（Token验证等），根据实际需求实现验证逻辑。

### 5. 认证成功时将用户信息设置到context

认证成功时将用户信息设置到context，供后续处理器使用。

### 6. 认证失败时返回gRPC错误

认证失败时返回gRPC错误（codes.Unauthenticated），错误消息使用中文。

### 7. 错误消息使用中文

所有错误消息使用中文，确保错误信息清晰。

### 8. 调用handler继续处理请求

认证成功时调用handler继续处理请求，确保请求流程正常进行。

## 验收标准

1. **认证拦截器可以正确拦截请求**
   - 拦截器可以正确拦截所有gRPC请求
   - 拦截器执行顺序正确

2. **认证信息可以正确提取和验证**
   - 可以从metadata提取认证信息
   - Token验证逻辑正确
   - 认证信息格式验证正确

3. **认证失败时返回正确错误**
   - 返回codes.Unauthenticated错误码
   - 错误消息使用中文
   - 错误信息清晰

4. **认证成功时请求可以继续处理**
   - 用户信息正确设置到context
   - 请求可以正常处理
   - 后续处理器可以获取用户信息

5. **错误消息使用中文**
   - 所有错误消息使用中文
   - 错误消息清晰、具体

## 相关文件

- `internal/grpc/interceptors/auth.go` - 认证拦截器实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

