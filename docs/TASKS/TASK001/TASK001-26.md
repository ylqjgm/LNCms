# TASK001-26: 实现错误响应构建函数

## 任务信息

**任务编号**: TASK001-26  
**父任务**: TASK001  
**任务名称**: 实现错误响应构建函数  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现错误响应构建函数，将错误转换为Envelope格式，包含meta、errors字段，支持单个错误和多个错误（如验证错误），错误消息使用中文。

## 依赖任务

- TASK001-25: 定义Envelope响应结构体
- TASK001-23: 定义错误码常量

## 实现指南

### 1. 创建错误响应构建文件

创建 `internal/response/error.go` 文件，实现错误响应构建函数。

### 2. 实现BuildErrorResponse函数

实现BuildErrorResponse函数，构建单个错误响应：

```go
// BuildErrorResponse 构建单个错误响应
func BuildErrorResponse(err error, requestID string) *Envelope {
    // 提取错误码和错误消息
    code, message := extractErrorInfo(err)
    
    // 构建Error结构体
    errorItem := Error{
        Code:    code,
        Message: message,
    }
    
    // 如果是ValidationError，提取字段名
    if validationErr, ok := err.(*errors.ValidationError); ok {
        errorItem.Field = validationErr.Field
    }
    
    // 构建Meta结构体
    meta := Meta{
        Success:   false,
        Code:      errorCodeToInt(code),
        Message:   message,
        Timestamp: time.Now().UTC().Format(time.RFC3339),
        RequestID: requestID,
    }
    
    return &Envelope{
        Meta:   meta,
        Data:   nil,
        Errors: []Error{errorItem},
    }
}
```

### 3. 实现BuildMultipleErrorsResponse函数

实现BuildMultipleErrorsResponse函数，构建多个错误响应：

```go
// BuildMultipleErrorsResponse 构建多个错误响应
func BuildMultipleErrorsResponse(errs []error, requestID string) *Envelope {
    var errorItems []Error
    
    for _, err := range errs {
        code, message := extractErrorInfo(err)
        errorItem := Error{
            Code:    code,
            Message: message,
        }
        
        // 如果是ValidationError，提取字段名
        if validationErr, ok := err.(*errors.ValidationError); ok {
            errorItem.Field = validationErr.Field
        }
        
        errorItems = append(errorItems, errorItem)
    }
    
    // 构建Meta结构体
    meta := Meta{
        Success:   false,
        Code:      422, // 多个错误通常使用422状态码
        Message:   "验证失败",
        Timestamp: time.Now().UTC().Format(time.RFC3339),
        RequestID: requestID,
    }
    
    return &Envelope{
        Meta:   meta,
        Data:   nil,
        Errors: errorItems,
    }
}
```

### 4. 从错误中提取错误码和错误消息

实现extractErrorInfo函数，从错误中提取错误码和错误消息：

```go
// extractErrorInfo 从错误中提取错误码和错误消息
func extractErrorInfo(err error) (string, string) {
    // 根据错误类型提取错误码和消息
    switch e := err.(type) {
    case *errors.AppError:
        return e.Code, e.Message
    case *errors.ValidationError:
        return errors.ErrCodeValidationError, e.Message
    case *errors.NotFoundError:
        return errors.ErrCodeNotFound, e.Error()
    case *errors.UnauthorizedError:
        return errors.ErrCodeUnauthorized, e.Message
    case *errors.ForbiddenError:
        return errors.ErrCodeForbidden, e.Message
    default:
        return errors.ErrCodeInternalServerError, err.Error()
    }
}
```

### 5. 将错误转换为Error结构体

将不同类型的错误转换为Error结构体，提取错误码、消息和字段名。

### 6. 构建Meta结构体

构建Meta结构体，设置success=false、code、message等字段。

### 7. 设置RequestID和Timestamp

设置RequestID和Timestamp字段：
- RequestID从context或参数获取
- Timestamp使用当前UTC时间（ISO 8601格式）

### 8. 返回Envelope格式的响应

返回Envelope格式的响应，包含meta和errors字段。

### 9. 所有错误消息使用中文

确保所有错误消息使用中文，错误消息清晰、具体。

## 验收标准

1. **可以构建单个错误响应**
   - BuildErrorResponse函数正常工作
   - 错误响应符合Envelope格式
   - 错误信息正确提取

2. **可以构建多个错误响应**
   - BuildMultipleErrorsResponse函数正常工作
   - 多个错误正确转换为错误数组
   - 错误响应符合Envelope格式

3. **错误响应符合Envelope格式**
   - 包含meta字段
   - 包含errors字段
   - data字段为null

4. **错误消息使用中文**
   - 所有错误消息使用中文
   - 错误消息清晰、具体

5. **Meta字段设置正确**
   - success字段设置为false
   - code字段设置为错误码对应的HTTP状态码
   - message字段设置为错误消息
   - RequestID和Timestamp正确设置

## 相关文件

- `internal/response/error.go` - 错误响应构建函数实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

