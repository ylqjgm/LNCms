# TASK001-06: 实现配置验证功能

## 任务信息

**任务编号**: TASK001-06  
**父任务**: TASK001  
**任务名称**: 实现配置验证功能  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现配置验证功能，验证配置项的必填性、格式正确性、数值范围等。验证失败时返回清晰的错误信息。

## 依赖任务

- TASK001-03: 定义配置结构体

## 实现指南

### 1. 创建配置验证文件

创建 `internal/config/validator.go` 文件，实现配置验证功能。

### 2. 实现Validate函数

实现 `Validate` 函数，验证配置结构体：

```go
// Validate 验证配置
func Validate(config *Config) []ValidationError {
    var errors []ValidationError
    
    // 验证服务器配置
    if err := validateServerConfig(&config.Server); err != nil {
        errors = append(errors, err...)
    }
    
    // 验证数据库配置
    if err := validateDatabaseConfig(&config.Database); err != nil {
        errors = append(errors, err...)
    }
    
    // 验证Redis配置
    if err := validateRedisConfig(&config.Redis); err != nil {
        errors = append(errors, err...)
    }
    
    // 验证Elasticsearch配置
    if err := validateElasticsearchConfig(&config.Elasticsearch); err != nil {
        errors = append(errors, err...)
    }
    
    // 验证日志配置
    if err := validateLogConfig(&config.Log); err != nil {
        errors = append(errors, err...)
    }
    
    return errors
}
```

### 3. 验证服务器配置

验证服务器配置的端口范围、模式值等：

```go
func validateServerConfig(config *ServerConfig) []ValidationError {
    var errors []ValidationError
    
    // 验证HTTP端口范围
    if config.HTTPPort < 1 || config.HTTPPort > 65535 {
        errors = append(errors, ValidationError{
            Field:   "server.http_port",
            Message: "HTTP端口必须在1-65535之间",
        })
    }
    
    // 验证运行模式
    validModes := []string{"dev", "test", "prod"}
    if !contains(validModes, config.Mode) {
        errors = append(errors, ValidationError{
            Field:   "server.mode",
            Message: fmt.Sprintf("运行模式必须是以下值之一: %v", validModes),
        })
    }
    
    return errors
}
```

### 4. 验证数据库配置

验证数据库配置的必填项、连接参数格式等：

```go
func validateDatabaseConfig(config *DatabaseConfig) []ValidationError {
    var errors []ValidationError
    
    // 验证必填项
    if config.Host == "" {
        errors = append(errors, ValidationError{
            Field:   "database.host",
            Message: "数据库主机不能为空",
        })
    }
    
    // 验证端口范围
    if config.Port < 1 || config.Port > 65535 {
        errors = append(errors, ValidationError{
            Field:   "database.port",
            Message: "数据库端口必须在1-65535之间",
        })
    }
    
    // 验证连接池参数
    if config.MaxOpenConns < 1 {
        errors = append(errors, ValidationError{
            Field:   "database.max_open_conns",
            Message: "最大打开连接数必须大于0",
        })
    }
    
    return errors
}
```

### 5. 验证Redis配置

验证Redis配置的必填项、连接参数格式等：

```go
func validateRedisConfig(config *RedisConfig) []ValidationError {
    var errors []ValidationError
    
    // 验证必填项
    if config.Host == "" {
        errors = append(errors, ValidationError{
            Field:   "redis.host",
            Message: "Redis主机不能为空",
        })
    }
    
    // 验证端口范围
    if config.Port < 1 || config.Port > 65535 {
        errors = append(errors, ValidationError{
            Field:   "redis.port",
            Message: "Redis端口必须在1-65535之间",
        })
    }
    
    return errors
}
```

### 6. 验证Elasticsearch配置

验证Elasticsearch配置的URL格式、必填项等：

```go
func validateElasticsearchConfig(config *ElasticsearchConfig) []ValidationError {
    var errors []ValidationError
    
    // 验证URL列表
    if len(config.URLs) == 0 {
        errors = append(errors, ValidationError{
            Field:   "elasticsearch.urls",
            Message: "Elasticsearch URL列表不能为空",
        })
    }
    
    // 验证URL格式
    for i, url := range config.URLs {
        if _, err := url.Parse(url); err != nil {
            errors = append(errors, ValidationError{
                Field:   fmt.Sprintf("elasticsearch.urls[%d]", i),
                Message: fmt.Sprintf("无效的URL格式: %s", url),
            })
        }
    }
    
    return errors
}
```

### 7. 验证日志配置

验证日志配置的日志级别、输出方式等：

```go
func validateLogConfig(config *LogConfig) []ValidationError {
    var errors []ValidationError
    
    // 验证日志级别
    validLevels := []string{"debug", "info", "warn", "error"}
    if !contains(validLevels, config.Level) {
        errors = append(errors, ValidationError{
            Field:   "log.level",
            Message: fmt.Sprintf("日志级别必须是以下值之一: %v", validLevels),
        })
    }
    
    // 验证输出方式
    validOutputs := []string{"stdout", "file"}
    if !contains(validOutputs, config.Output) {
        errors = append(errors, ValidationError{
            Field:   "log.output",
            Message: fmt.Sprintf("输出方式必须是以下值之一: %v", validOutputs),
        })
    }
    
    // 如果输出方式为file，验证路径
    if config.Output == "file" && config.Path == "" {
        errors = append(errors, ValidationError{
            Field:   "log.path",
            Message: "当日志输出方式为file时，日志路径不能为空",
        })
    }
    
    return errors
}
```

### 8. 定义ValidationError结构体

定义验证错误结构体：

```go
// ValidationError 验证错误
type ValidationError struct {
    Field   string // 字段路径
    Message string // 错误消息
}
```

### 9. 返回验证错误列表

返回包含字段名和错误消息的验证错误列表，所有错误消息使用中文。

## 验收标准

1. **可以验证所有配置项**
   - 服务器配置验证正确
   - 数据库配置验证正确
   - Redis配置验证正确
   - Elasticsearch配置验证正确
   - 日志配置验证正确

2. **必填项验证正确**
   - 必填项为空时返回错误
   - 错误消息清晰且使用中文

3. **格式验证正确**
   - URL格式验证正确
   - 端口范围验证正确
   - 枚举值验证正确

4. **验证错误消息清晰且使用中文**
   - 错误消息包含字段路径
   - 错误消息说明具体错误原因
   - 所有错误消息使用中文

5. **返回多个验证错误时格式正确**
   - 可以返回多个验证错误
   - 错误列表格式统一

## 相关文件

- `internal/config/validator.go` - 配置验证功能实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST
