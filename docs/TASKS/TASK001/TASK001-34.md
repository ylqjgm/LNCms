# TASK001-34: 实现日志中间件

## 任务信息

**任务编号**: TASK001-34  
**父任务**: TASK001  
**任务名称**: 实现日志中间件  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现日志中间件，记录HTTP请求和响应的详细信息，包括请求方法、路径、参数、响应状态码、响应时间等，便于问题排查和性能分析。

## 依赖任务

- TASK001-33: 实现请求ID中间件

## 实现指南

### 1. 创建日志中间件文件

创建 `internal/http/middleware/logger.go` 文件，实现日志中间件。

### 2. 实现LoggerMiddleware函数

实现 `LoggerMiddleware` 函数：

```go
// LoggerMiddleware 日志中间件
func LoggerMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 记录请求开始时间
        startTime := time.Now()
        
        // 记录请求信息
        requestInfo := map[string]interface{}{
            "method":      c.Request.Method,
            "path":        c.Request.URL.Path,
            "query":       c.Request.URL.RawQuery,
            "remote_addr": c.ClientIP(),
            "user_agent":  c.Request.UserAgent(),
        }
        
        // 获取RequestID
        requestID, _ := c.Get("request_id")
        if requestID != nil {
            requestInfo["request_id"] = requestID
        }
        
        // 记录请求日志
        log.Printf("[请求] %+v", requestInfo)
        
        // 处理请求
        c.Next()
        
        // 计算响应时间
        latency := time.Since(startTime)
        
        // 记录响应信息
        responseInfo := map[string]interface{}{
            "status_code": c.Writer.Status(),
            "latency":     latency.String(),
            "size":        c.Writer.Size(),
        }
        
        // 根据状态码设置日志级别
        if c.Writer.Status() >= 400 {
            log.Printf("[错误响应] %+v %+v", requestInfo, responseInfo)
        } else {
            log.Printf("[响应] %+v %+v", requestInfo, responseInfo)
        }
    }
}
```

### 3. 记录请求开始时间

记录请求开始时间，用于计算响应时间。

### 4. 记录请求信息

记录请求信息（方法、路径、参数、请求头等）：
- 请求方法（GET、POST等）
- 请求路径
- 查询参数
- 客户端IP
- User-Agent

### 5. 调用c.Next()处理请求

调用c.Next()处理请求，继续请求处理流程。

### 6. 记录响应信息

记录响应信息（状态码、响应时间、响应大小等）：
- HTTP状态码
- 响应时间（latency）
- 响应大小

### 7. 从context获取RequestID并记录

从context获取RequestID并记录，便于日志关联。

### 8. 使用结构化日志记录

使用结构化日志记录（JSON格式），便于日志分析和查询。

### 9. 所有日志消息使用中文

所有日志消息使用中文，确保日志可读性。

## 验收标准

1. **可以正确记录请求信息**
   - 请求方法正确记录
   - 请求路径正确记录
   - 请求参数正确记录
   - 客户端信息正确记录

2. **可以正确记录响应信息**
   - 响应状态码正确记录
   - 响应时间正确计算
   - 响应大小正确记录

3. **响应时间计算正确**
   - 响应时间计算准确
   - 时间单位正确（毫秒或秒）

4. **RequestID正确记录**
   - RequestID在请求日志中记录
   - RequestID在响应日志中记录
   - RequestID值一致

5. **日志格式结构化且使用中文**
   - 日志格式结构化（JSON格式）
   - 所有日志消息使用中文
   - 日志易于分析和查询

## 相关文件

- `internal/http/middleware/logger.go` - 日志中间件实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

