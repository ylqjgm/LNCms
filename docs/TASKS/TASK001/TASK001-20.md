# TASK001-20: 实现Elasticsearch连接初始化

## 任务信息

**任务编号**: TASK001-20  
**父任务**: TASK001  
**任务名称**: 实现Elasticsearch连接初始化  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现Elasticsearch搜索连接初始化功能，使用olivere/elastic建立Elasticsearch连接，处理连接错误，返回可用的Elasticsearch客户端实例。

## 依赖任务

- TASK001-19: 定义Elasticsearch连接配置结构体

## 实现指南

### 1. 创建Elasticsearch连接初始化文件

创建 `internal/search/elasticsearch.go` 文件，实现Elasticsearch连接初始化功能。

### 2. 实现NewElasticsearch函数

实现 `NewElasticsearch` 函数，初始化Elasticsearch连接：

```go
// NewElasticsearch 创建Elasticsearch搜索连接
func NewElasticsearch(config *ElasticsearchConfig) (*elastic.Client, error) {
    // 构建客户端选项
    options := []elastic.ClientOptionFunc{
        elastic.SetURL(config.URLs...),
    }
    
    // 如果设置了用户名和密码，添加认证
    if config.Username != "" && config.Password != "" {
        options = append(options, elastic.SetBasicAuth(config.Username, config.Password))
    }
    
    // 设置超时时间
    if config.Timeout > 0 {
        options = append(options, elastic.SetHealthcheckTimeout(config.Timeout))
    }
    
    // 设置节点嗅探
    options = append(options, elastic.SetSniff(config.Sniff))
    
    // 创建客户端
    client, err := elastic.NewClient(options...)
    if err != nil {
        return nil, fmt.Errorf("创建Elasticsearch客户端失败: %w", err)
    }
    
    // 测试连接
    info, code, err := client.Ping(config.URLs[0]).Do(context.Background())
    if err != nil {
        return nil, fmt.Errorf("Elasticsearch连接测试失败: %w", err)
    }
    
    log.Printf("Elasticsearch连接成功: %s (版本: %s)", info.ClusterName, info.Version.Number)
    
    return client, nil
}
```

### 3. 使用github.com/olivere/elastic/v7客户端

导入并使用github.com/olivere/elastic/v7客户端：

```go
import (
    "github.com/olivere/elastic/v7"
)
```

### 4. 构建Elasticsearch客户端选项

构建Elasticsearch客户端选项（elastic.SetURL、elastic.SetBasicAuth等）。

### 5. 使用elastic.NewClient创建客户端

使用elastic.NewClient创建Elasticsearch客户端实例。

### 6. 处理连接错误

处理连接错误，返回清晰的错误信息（中文）：

```go
if err != nil {
    return nil, fmt.Errorf("创建Elasticsearch客户端失败: %w", err)
}
```

### 7. 返回*elastic.Client实例

返回*elastic.Client实例，供后续使用。

### 8. 实现连接测试功能

实现连接测试功能（ping Elasticsearch集群），确保连接可用：

```go
info, code, err := client.Ping(config.URLs[0]).Do(context.Background())
if err != nil {
    return nil, fmt.Errorf("Elasticsearch连接测试失败: %w", err)
}
```

## 验收标准

1. **可以成功建立Elasticsearch连接**
   - 使用正确的连接参数
   - 支持多个节点URL
   - 连接成功建立

2. **连接错误处理正确**
   - 连接失败时返回错误
   - 错误信息清晰且使用中文
   - 错误信息包含上下文

3. **返回的Elasticsearch客户端实例可用**
   - 返回*elastic.Client实例
   - 实例可以正常使用
   - 可以执行Elasticsearch操作

4. **连接测试功能正常**
   - ping Elasticsearch集群成功
   - 连接测试失败时返回错误
   - 错误信息清晰

## 相关文件

- `internal/search/elasticsearch.go` - Elasticsearch连接初始化实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

