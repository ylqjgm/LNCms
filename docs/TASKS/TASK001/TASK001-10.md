# TASK001-10: 实现PostgreSQL连接初始化

## 任务信息

**任务编号**: TASK001-10  
**父任务**: TASK001  
**任务名称**: 实现PostgreSQL连接初始化  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现PostgreSQL数据库连接初始化功能，使用GORM建立数据库连接，处理连接错误，返回可用的数据库连接实例。

## 依赖任务

- TASK001-09: 定义PostgreSQL连接配置结构体

## 实现指南

### 1. 创建PostgreSQL连接初始化文件

创建 `internal/database/postgres.go` 文件，实现PostgreSQL连接初始化功能。

### 2. 实现NewPostgreSQL函数

实现 `NewPostgreSQL` 函数，初始化数据库连接：

```go
// NewPostgreSQL 创建PostgreSQL数据库连接
func NewPostgreSQL(config *PostgreSQLConfig) (*gorm.DB, error) {
    // 构建数据库连接字符串（DSN）
    dsn := buildDSN(config)
    
    // 使用gorm.Open建立连接
    db, err := gorm.Open(postgres.Open(dsn), &gorm.Config{
        Logger: logger.Default.LogMode(logger.Info),
    })
    if err != nil {
        return nil, fmt.Errorf("连接PostgreSQL数据库失败: %w", err)
    }
    
    // 测试连接
    sqlDB, err := db.DB()
    if err != nil {
        return nil, fmt.Errorf("获取数据库实例失败: %w", err)
    }
    
    if err := sqlDB.Ping(); err != nil {
        return nil, fmt.Errorf("数据库连接测试失败: %w", err)
    }
    
    return db, nil
}
```

### 3. 使用gorm.io/driver/postgres驱动

导入并使用gorm.io/driver/postgres驱动：

```go
import (
    "gorm.io/driver/postgres"
    "gorm.io/gorm"
)
```

### 4. 构建数据库连接字符串（DSN）

构建标准PostgreSQL DSN格式的连接字符串：

```go
// buildDSN 构建PostgreSQL连接字符串
func buildDSN(config *PostgreSQLConfig) string {
    dsn := fmt.Sprintf(
        "host=%s port=%d user=%s password=%s dbname=%s sslmode=%s TimeZone=%s",
        config.Host,
        config.Port,
        config.User,
        config.Password,
        config.Database,
        config.SSLMode,
        config.TimeZone,
    )
    return dsn
}
```

### 5. 使用gorm.Open建立连接

使用gorm.Open建立数据库连接，配置GORM选项。

### 6. 处理连接错误

处理连接错误，返回清晰的错误信息（中文）：

```go
if err != nil {
    return nil, fmt.Errorf("连接PostgreSQL数据库失败: %w", err)
}
```

### 7. 返回*gorm.DB实例

返回*gorm.DB实例，供后续使用。

### 8. 实现连接测试功能

实现连接测试功能（ping数据库），确保连接可用：

```go
sqlDB, err := db.DB()
if err != nil {
    return nil, fmt.Errorf("获取数据库实例失败: %w", err)
}

if err := sqlDB.Ping(); err != nil {
    return nil, fmt.Errorf("数据库连接测试失败: %w", err)
}
```

## 验收标准

1. **可以成功建立数据库连接**
   - 使用正确的DSN格式
   - 连接参数正确
   - 连接成功建立

2. **连接错误处理正确**
   - 连接失败时返回错误
   - 错误信息清晰且使用中文
   - 错误信息包含上下文

3. **返回的数据库实例可用**
   - 返回*gorm.DB实例
   - 实例可以正常使用
   - 可以执行数据库操作

4. **连接测试功能正常**
   - ping数据库成功
   - 连接测试失败时返回错误
   - 错误信息清晰

## 相关文件

- `internal/database/postgres.go` - PostgreSQL连接初始化实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST
