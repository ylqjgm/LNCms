# TASK001-31: 实现Envelope响应封装中间件

## 任务信息

**任务编号**: TASK001-31  
**父任务**: TASK001  
**任务名称**: 实现Envelope响应封装中间件  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现Envelope响应封装中间件，自动将响应数据封装为Envelope格式，设置Meta字段（success、code、message、timestamp、request_id等），确保所有API响应符合Envelope格式。

## 依赖任务

- TASK001-25: 定义Envelope响应结构体
- TASK001-30: 实现中间件链注册机制

## 实现指南

### 1. 创建Envelope响应封装中间件文件

创建 `internal/http/middleware/response.go` 文件，实现Envelope响应封装中间件。

### 2. 实现EnvelopeResponseMiddleware函数

实现 `EnvelopeResponseMiddleware` 函数：

```go
// EnvelopeResponseMiddleware Envelope响应封装中间件
func EnvelopeResponseMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 获取原始响应写入器
        c.Writer = &envelopeWriter{
            ResponseWriter: c.Writer,
            context:        c,
        }
        
        c.Next()
        
        // 如果响应尚未封装，进行封装
        if !c.Writer.(*envelopeWriter).enveloped {
            wrapResponse(c)
        }
    }
}

// wrapResponse 封装响应为Envelope格式
func wrapResponse(c *gin.Context) {
    // 获取响应数据
    data := c.Get("response_data")
    
    // 获取RequestID
    requestID, _ := c.Get("request_id")
    if requestID == nil {
        requestID = ""
    }
    
    // 构建Meta结构体
    meta := response.Meta{
        Success:   true,
        Code:      0,
        Message:   "ok",
        Timestamp: time.Now().UTC().Format(time.RFC3339),
        RequestID: requestID.(string),
    }
    
    // 构建Envelope响应
    envelope := &response.Envelope{
        Meta:   meta,
        Data:   data,
        Errors: []response.Error{},
    }
    
    // 返回Envelope格式的响应
    c.JSON(http.StatusOK, envelope)
}
```

### 3. 拦截响应数据

拦截响应数据，封装为Envelope格式。

### 4. 自动设置Meta字段

自动设置Meta字段：
- success=true（成功响应）
- code=0（成功代码）
- message="ok"（成功消息）
- timestamp=当前UTC时间
- request_id=从context获取

### 5. 从context中获取RequestID

从context中获取RequestID并设置到Meta字段。

### 6. 设置Timestamp为当前时间

设置Timestamp为当前UTC时间（ISO 8601格式）。

### 7. 支持分页信息的自动设置

支持分页信息的自动设置（如需要），从context或响应数据中提取分页信息。

### 8. 使用gin的响应写入机制

使用gin的响应写入机制，确保响应正确封装和返回。

## 验收标准

1. **响应可以正确封装为Envelope格式**
   - 成功响应封装正确
   - 响应包含meta、data、errors字段
   - 响应格式符合Envelope规范

2. **Meta字段设置正确**
   - success字段设置为true
   - code字段设置为0
   - message字段设置为"ok"
   - timestamp字段正确设置
   - request_id字段正确设置

3. **RequestID和Timestamp正确设置**
   - RequestID从context正确获取
   - Timestamp使用UTC时间
   - 时间格式符合ISO 8601

4. **所有API响应都符合Envelope格式**
   - 所有成功响应都封装为Envelope格式
   - 响应格式统一
   - 符合OpenAPI 3.1.1规范

## 相关文件

- `internal/http/middleware/response.go` - Envelope响应封装中间件实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

