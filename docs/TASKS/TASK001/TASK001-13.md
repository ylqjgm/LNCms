# TASK001-13: 实现PostgreSQL连接重试机制

## 任务信息

**任务编号**: TASK001-13  
**父任务**: TASK001  
**任务名称**: 实现PostgreSQL连接重试机制  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现PostgreSQL数据库连接重试机制，在连接失败时自动重试，支持配置重试次数、重试间隔等参数，提高系统容错能力。

## 依赖任务

- TASK001-10: 实现PostgreSQL连接初始化

## 实现指南

### 1. 实现RetryConnect函数

在 `internal/database/postgres.go` 中实现 `RetryConnect` 函数。

### 2. 实现重试逻辑

实现重试逻辑（循环重试指定次数）：

```go
// RetryConnect 带重试机制的数据库连接
func RetryConnect(config *PostgreSQLConfig, maxRetries int, retryInterval time.Duration) (*gorm.DB, error) {
    var lastErr error
    
    for i := 0; i < maxRetries; i++ {
        db, err := NewPostgreSQL(config)
        if err == nil {
            // 连接成功
            if i > 0 {
                log.Printf("数据库连接成功（重试 %d 次后）", i)
            }
            return db, nil
        }
        
        lastErr = err
        log.Printf("数据库连接失败（第 %d 次尝试）: %v", i+1, err)
        
        // 如果不是最后一次重试，等待后继续
        if i < maxRetries-1 {
            time.Sleep(retryInterval)
            // 可选：使用指数退避策略
            retryInterval = time.Duration(float64(retryInterval) * 1.5)
        }
    }
    
    return nil, fmt.Errorf("数据库连接失败（已重试 %d 次）: %w", maxRetries, lastErr)
}
```

### 3. 支持配置重试次数

支持配置重试次数（默认3次）：

```go
maxRetries := 3 // 默认值
if config.MaxRetries > 0 {
    maxRetries = config.MaxRetries
}
```

### 4. 支持配置重试间隔

支持配置重试间隔（默认1秒）：

```go
retryInterval := 1 * time.Second // 默认值
if config.RetryInterval > 0 {
    retryInterval = config.RetryInterval
}
```

### 5. 使用指数退避策略（可选）

可选：使用指数退避策略，每次重试间隔逐渐增加。

### 6. 记录重试日志

记录重试日志，包含重试次数和错误信息：

```go
log.Printf("数据库连接失败（第 %d 次尝试）: %v", i+1, err)
```

### 7. 重试失败后返回最终错误

重试失败后返回最终错误，包含重试次数和最后一次错误信息。

## 验收标准

1. **连接失败时可以自动重试**
   - 连接失败时自动进行重试
   - 重试逻辑正确执行
   - 重试次数符合配置

2. **重试次数和间隔可配置**
   - 重试次数可以从配置读取
   - 重试间隔可以从配置读取
   - 默认值合理

3. **重试日志记录正确**
   - 每次重试都记录日志
   - 日志包含重试次数
   - 日志包含错误信息

4. **重试失败后返回正确错误**
   - 返回包含重试次数的错误信息
   - 返回最后一次连接错误
   - 错误信息使用中文

## 相关文件

- `internal/database/postgres.go` - PostgreSQL连接重试机制实现（修改）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

