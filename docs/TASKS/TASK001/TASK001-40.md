# TASK001-40: 实现日志拦截器

## 任务信息

**任务编号**: TASK001-40  
**父任务**: TASK001  
**任务名称**: 实现日志拦截器  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现gRPC日志拦截器，记录gRPC请求和响应的详细信息，包括方法名、请求参数、响应结果、处理时间等，便于问题排查和性能分析。

## 依赖任务

- TASK001-37: 初始化gRPC服务器

## 实现指南

### 1. 创建日志拦截器文件

创建 `internal/grpc/interceptors/logger.go` 文件，实现日志拦截器。

### 2. 实现LoggerUnaryInterceptor函数

实现 `LoggerUnaryInterceptor` 函数（一元RPC拦截器）：

```go
// LoggerUnaryInterceptor 日志拦截器（一元RPC）
func LoggerUnaryInterceptor() grpc.UnaryServerInterceptor {
    return func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {
        // 记录请求开始时间
        startTime := time.Now()
        
        // 记录请求信息
        requestInfo := map[string]interface{}{
            "method": info.FullMethod,
            "request": req,
        }
        
        log.Printf("[gRPC请求] %+v", requestInfo)
        
        // 处理请求
        resp, err := handler(ctx, req)
        
        // 计算处理时间
        latency := time.Since(startTime)
        
        // 记录响应信息
        responseInfo := map[string]interface{}{
            "method":  info.FullMethod,
            "latency": latency.String(),
        }
        
        if err != nil {
            responseInfo["error"] = err.Error()
            log.Printf("[gRPC错误响应] %+v", responseInfo)
        } else {
            responseInfo["response"] = resp
            log.Printf("[gRPC响应] %+v", responseInfo)
        }
        
        return resp, err
    }
}
```

### 3. 记录请求开始时间

记录请求开始时间，用于计算处理时间。

### 4. 记录请求信息

记录请求信息（方法名、请求参数等）：
- 方法名（FullMethod）
- 请求参数

### 5. 调用handler处理请求

调用handler处理请求，继续请求处理流程。

### 6. 记录响应信息

记录响应信息（响应结果、处理时间、错误信息等）：
- 响应结果
- 处理时间（latency）
- 错误信息（如果有）

### 7. 使用结构化日志记录

使用结构化日志记录（JSON格式），便于日志分析和查询。

### 8. 所有日志消息使用中文

所有日志消息使用中文，确保日志可读性。

## 验收标准

1. **可以正确记录请求信息**
   - 方法名正确记录
   - 请求参数正确记录
   - 请求信息完整

2. **可以正确记录响应信息**
   - 响应结果正确记录
   - 处理时间正确计算
   - 错误信息正确记录

3. **处理时间计算正确**
   - 处理时间计算准确
   - 时间单位正确（毫秒或秒）

4. **日志格式结构化且使用中文**
   - 日志格式结构化（JSON格式）
   - 所有日志消息使用中文
   - 日志易于分析和查询

## 相关文件

- `internal/grpc/interceptors/logger.go` - 日志拦截器实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

