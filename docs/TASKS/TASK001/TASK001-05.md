# TASK001-05: 实现配置文件读取功能

## 任务信息

**任务编号**: TASK001-05  
**父任务**: TASK001  
**任务名称**: 实现配置文件读取功能  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现从配置文件（YAML/JSON）读取配置的功能，使用viper库支持多种配置文件格式，支持配置文件热加载。

## 依赖任务

- TASK001-03: 定义配置结构体

## 实现指南

### 1. 创建配置文件读取文件

创建 `internal/config/file_loader.go` 文件，实现配置文件读取功能。

### 2. 实现LoadFromFile函数

实现 `LoadFromFile` 函数，从配置文件读取配置：

```go
// LoadFromFile 从配置文件读取配置
func LoadFromFile(filePath string) (*Config, error) {
    viper.SetConfigType("yaml") // 默认使用YAML格式
    
    // 如果指定了文件路径，使用指定路径
    if filePath != "" {
        viper.SetConfigFile(filePath)
    } else {
        // 否则查找配置文件
        viper.SetConfigName("config")
        viper.AddConfigPath(".")
        viper.AddConfigPath("./config")
    }
    
    // 读取配置文件
    if err := viper.ReadInConfig(); err != nil {
        return nil, fmt.Errorf("读取配置文件失败: %w", err)
    }
    
    // 解析配置到结构体
    var config Config
    if err := viper.Unmarshal(&config); err != nil {
        return nil, fmt.Errorf("解析配置文件失败: %w", err)
    }
    
    return &config, nil
}
```

### 3. 支持YAML和JSON格式

使用viper库支持YAML和JSON格式：

```go
// 根据文件扩展名自动识别格式
ext := filepath.Ext(filePath)
switch ext {
case ".yaml", ".yml":
    viper.SetConfigType("yaml")
case ".json":
    viper.SetConfigType("json")
default:
    viper.SetConfigType("yaml") // 默认使用YAML
}
```

### 4. 支持配置文件路径配置

支持通过环境变量或参数指定配置文件路径：

```go
// 优先使用环境变量CONFIG_FILE
if filePath == "" {
    filePath = os.Getenv("CONFIG_FILE")
}

// 如果仍未指定，使用默认查找逻辑
if filePath == "" {
    // 查找config.yaml、config.yml、config.json
}
```

### 5. 实现配置文件查找逻辑

实现配置文件查找逻辑，按优先级查找：
1. 当前目录
2. config目录
3. 用户主目录（可选）

### 6. 处理配置文件不存在的情况

当配置文件不存在时，返回错误或使用默认配置：

```go
if err := viper.ReadInConfig(); err != nil {
    if _, ok := err.(viper.ConfigFileNotFoundError); ok {
        // 配置文件不存在，返回错误
        return nil, fmt.Errorf("配置文件不存在: %s", filePath)
    }
    // 其他错误
    return nil, fmt.Errorf("读取配置文件失败: %w", err)
}
```

### 7. 实现配置文件的解析和映射

使用viper的Unmarshal功能将配置文件解析到配置结构体：

```go
if err := viper.Unmarshal(&config); err != nil {
    return nil, fmt.Errorf("解析配置文件失败: %w", err)
}
```

## 验收标准

1. **可以从YAML配置文件读取配置**
   - 可以读取config.yaml文件
   - 可以读取config.yml文件
   - 配置值正确映射到结构体

2. **可以从JSON配置文件读取配置**
   - 可以读取config.json文件
   - 配置值正确映射到结构体

3. **配置文件路径可以正确指定**
   - 可以通过参数指定路径
   - 可以通过环境变量CONFIG_FILE指定路径
   - 可以自动查找配置文件

4. **配置文件不存在时正确处理错误**
   - 返回清晰的错误信息
   - 错误信息使用中文

## 相关文件

- `internal/config/file_loader.go` - 配置文件读取功能实现文件
- `config/config.yaml.example` - 配置文件示例（参考）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST
