# TASK001-36: 实现CORS中间件

## 任务信息

**任务编号**: TASK001-36  
**父任务**: TASK001  
**任务名称**: 实现CORS中间件  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现CORS（跨域资源共享）中间件，配置允许的源、方法、头部等CORS策略，支持跨域请求，确保前端可以正常访问API。

## 依赖任务

- TASK001-28: 初始化Gin引擎

## 实现指南

### 1. 创建CORS中间件文件

创建 `internal/http/middleware/cors.go` 文件，实现CORS中间件。

### 2. 实现CORSMiddleware函数

实现 `CORSMiddleware` 函数：

```go
// CORSMiddleware CORS中间件
func CORSMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 配置允许的源
        origin := c.GetHeader("Origin")
        if origin != "" {
            c.Header("Access-Control-Allow-Origin", origin)
        } else {
            c.Header("Access-Control-Allow-Origin", "*")
        }
        
        // 配置允许的方法
        c.Header("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, PATCH, OPTIONS")
        
        // 配置允许的头部
        c.Header("Access-Control-Allow-Headers", "Content-Type, Authorization, X-Request-ID")
        
        // 配置允许的凭证
        c.Header("Access-Control-Allow-Credentials", "true")
        
        // 配置预检请求缓存时间
        c.Header("Access-Control-Max-Age", "3600")
        
        // 处理OPTIONS预检请求
        if c.Request.Method == "OPTIONS" {
            c.AbortWithStatus(http.StatusNoContent)
            return
        }
        
        // 继续处理请求
        c.Next()
    }
}
```

### 3. 配置允许的源

配置允许的源（Access-Control-Allow-Origin）：
- 开发环境：可以使用"*"允许所有源
- 生产环境：应限制允许的源，避免安全风险

### 4. 配置允许的方法

配置允许的方法（Access-Control-Allow-Methods）：
- GET、POST、PUT、DELETE、PATCH、OPTIONS

### 5. 配置允许的头部

配置允许的头部（Access-Control-Allow-Headers）：
- Content-Type
- Authorization
- X-Request-ID

### 6. 配置允许的凭证

配置允许的凭证（Access-Control-Allow-Credentials）：
- 设置为true，支持携带凭证的跨域请求

### 7. 处理OPTIONS预检请求

处理OPTIONS预检请求：
- 返回204 No Content状态码
- 包含所有CORS响应头

### 8. 从配置读取CORS策略（如需要）

可选：从配置读取CORS策略，支持动态配置允许的源。

### 9. 调用c.Next()继续处理请求

调用c.Next()继续处理请求，确保请求流程正常进行。

## 验收标准

1. **CORS中间件可以正确配置**
   - 允许的源配置正确
   - 允许的方法配置正确
   - 允许的头部配置正确

2. **跨域请求可以正常处理**
   - 跨域GET请求可以正常处理
   - 跨域POST请求可以正常处理
   - 跨域请求响应包含CORS头

3. **OPTIONS预检请求正确处理**
   - OPTIONS请求返回204状态码
   - OPTIONS响应包含所有CORS头
   - 预检请求不会影响正常请求

4. **CORS响应头设置正确**
   - Access-Control-Allow-Origin设置正确
   - Access-Control-Allow-Methods设置正确
   - Access-Control-Allow-Headers设置正确
   - Access-Control-Allow-Credentials设置正确

## 相关文件

- `internal/http/middleware/cors.go` - CORS中间件实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

