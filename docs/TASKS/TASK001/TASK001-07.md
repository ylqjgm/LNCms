# TASK001-07: 实现配置合并逻辑

## 任务信息

**任务编号**: TASK001-07  
**父任务**: TASK001  
**任务名称**: 实现配置合并逻辑  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现配置合并逻辑，支持环境变量优先于配置文件，配置文件优先于默认值的优先级规则。合并后的配置应通过验证。

## 依赖任务

- TASK001-04: 实现环境变量读取功能
- TASK001-05: 实现配置文件读取功能
- TASK001-06: 实现配置验证功能

## 实现指南

### 1. 创建配置合并文件

创建 `internal/config/merger.go` 文件，实现配置合并逻辑。

### 2. 实现Merge函数

实现 `Merge` 函数，合并多个配置源：

```go
// Merge 合并多个配置源
func Merge(envConfig, fileConfig, defaultConfig *Config) (*Config, error) {
    // 从默认配置开始
    merged := defaultConfig
    
    // 合并配置文件（配置文件优先于默认值）
    if fileConfig != nil {
        merged = mergeConfig(merged, fileConfig)
    }
    
    // 合并环境变量（环境变量优先于配置文件）
    if envConfig != nil {
        merged = mergeConfig(merged, envConfig)
    }
    
    // 验证合并后的配置
    if errors := Validate(merged); len(errors) > 0 {
        return nil, fmt.Errorf("配置验证失败: %v", errors)
    }
    
    return merged, nil
}
```

### 3. 定义配置优先级

定义配置优先级：环境变量 > 配置文件 > 默认值

### 4. 实现配置合并算法

实现深度合并结构体的算法：

```go
// mergeConfig 深度合并配置
func mergeConfig(base, override *Config) *Config {
    merged := *base
    
    // 合并服务器配置
    if override.Server.HTTPPort != 0 {
        merged.Server.HTTPPort = override.Server.HTTPPort
    }
    if override.Server.GRPCPort != 0 {
        merged.Server.GRPCPort = override.Server.GRPCPort
    }
    if override.Server.Mode != "" {
        merged.Server.Mode = override.Server.Mode
    }
    
    // 合并数据库配置
    if override.Database.Host != "" {
        merged.Database.Host = override.Database.Host
    }
    if override.Database.Port != 0 {
        merged.Database.Port = override.Database.Port
    }
    // ... 更多字段合并
    
    return &merged
}
```

### 5. 处理配置冲突

处理配置冲突，环境变量覆盖配置文件：

```go
// 使用反射或手动合并，确保环境变量值覆盖配置文件值
// 对于零值判断，需要根据字段类型处理
```

### 6. 合并后调用配置验证函数

合并后调用配置验证函数，确保合并后的配置有效：

```go
if errors := Validate(merged); len(errors) > 0 {
    return nil, fmt.Errorf("配置验证失败: %v", errors)
}
```

### 7. 返回合并后的配置和验证错误

返回合并后的配置，如果有验证错误，返回错误信息。

## 验收标准

1. **配置合并优先级正确**
   - 环境变量优先于配置文件
   - 配置文件优先于默认值
   - 优先级规则正确执行

2. **嵌套结构体可以正确合并**
   - 服务器配置可以正确合并
   - 数据库配置可以正确合并
   - Redis配置可以正确合并
   - Elasticsearch配置可以正确合并
   - 日志配置可以正确合并

3. **合并后的配置通过验证**
   - 合并后的配置符合验证规则
   - 验证错误正确返回

4. **配置冲突处理正确**
   - 环境变量值正确覆盖配置文件值
   - 配置文件值正确覆盖默认值
   - 零值处理正确

## 相关文件

- `internal/config/merger.go` - 配置合并逻辑实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST
