# TASK001-32: 实现健康检查端点

## 任务信息

**任务编号**: TASK001-32  
**父任务**: TASK001  
**任务名称**: 实现健康检查端点  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现健康检查端点（/health），检查数据库、Redis、Elasticsearch等服务的健康状态，返回系统整体健康状态，用于监控和负载均衡。

## 依赖任务

- TASK001-12: 实现PostgreSQL健康检查功能
- TASK001-17: 实现Redis健康检查功能
- TASK001-21: 实现Elasticsearch健康检查功能
- TASK001-29: 实现路由注册机制

## 实现指南

### 1. 创建健康检查端点文件

在 `internal/http/handlers/health.go` 中实现健康检查端点。

### 2. 实现HealthCheckHandler函数

实现 `HealthCheckHandler` 函数：

```go
// HealthCheckHandler 健康检查处理器
func HealthCheckHandler(db *gorm.DB, redisClient *redis.Client, esClient *elastic.Client) gin.HandlerFunc {
    return func(c *gin.Context) {
        // 检查数据库健康状态
        dbHealthy, dbErr := database.HealthCheck(db)
        
        // 检查Redis健康状态
        redisHealthy, redisErr := cache.HealthCheck(redisClient)
        
        // 检查Elasticsearch健康状态
        esHealthy, esErr := search.HealthCheck(esClient)
        
        // 汇总健康状态
        allHealthy := dbHealthy && redisHealthy && esHealthy
        
        // 构建健康检查响应
        healthData := map[string]interface{}{
            "status": "healthy",
            "services": map[string]interface{}{
                "database": map[string]interface{}{
                    "status": getStatusString(dbHealthy),
                    "error":  getErrorString(dbErr),
                },
                "redis": map[string]interface{}{
                    "status": getStatusString(redisHealthy),
                    "error":  getErrorString(redisErr),
                },
                "elasticsearch": map[string]interface{}{
                    "status": getStatusString(esHealthy),
                    "error":  getErrorString(esErr),
                },
            },
        }
        
        if !allHealthy {
            healthData["status"] = "unhealthy"
            c.JSON(http.StatusServiceUnavailable, response.BuildSuccessResponse(c, healthData))
            return
        }
        
        c.JSON(http.StatusOK, response.BuildSuccessResponse(c, healthData))
    }
}
```

### 3. 注册/health路由

注册/health路由（GET方法），使用路由注册机制。

### 4. 调用数据库健康检查

调用数据库健康检查函数，获取数据库健康状态。

### 5. 调用Redis健康检查

调用Redis健康检查函数，获取Redis健康状态。

### 6. 调用Elasticsearch健康检查

调用Elasticsearch健康检查函数，获取Elasticsearch健康状态。

### 7. 汇总所有服务的健康状态

汇总所有服务的健康状态，确定系统整体健康状态。

### 8. 返回Envelope格式的健康检查响应

返回Envelope格式的健康检查响应，包含各服务的详细状态。

## 验收标准

1. **健康检查端点可以正确访问**
   - /health路由可以正确访问
   - GET请求可以正确处理
   - 响应格式正确

2. **可以检查所有服务的健康状态**
   - 数据库健康状态可以检查
   - Redis健康状态可以检查
   - Elasticsearch健康状态可以检查

3. **健康检查响应格式正确（Envelope格式）**
   - 响应符合Envelope格式
   - 包含各服务的详细状态
   - 响应格式符合OpenAPI 3.1.1规范

4. **健康检查执行快速（<500ms）**
   - 正常情况下的健康检查在500ms内完成
   - 可以使用goroutine并行检查多个服务

## 相关文件

- `internal/http/handlers/health.go` - 健康检查端点实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

