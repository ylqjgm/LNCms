# TASK001-41: 实现错误处理拦截器

## 任务信息

**任务编号**: TASK001-41  
**父任务**: TASK001  
**任务名称**: 实现错误处理拦截器  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现gRPC错误处理拦截器，统一处理gRPC请求中的错误，将应用错误转换为gRPC标准错误，确保错误响应格式统一。

## 依赖任务

- TASK001-22: 定义错误类型结构体
- TASK001-27: 实现错误码到HTTP状态码映射

## 实现指南

### 1. 创建错误处理拦截器文件

创建 `internal/grpc/interceptors/error.go` 文件，实现错误处理拦截器。

### 2. 实现ErrorUnaryInterceptor函数

实现 `ErrorUnaryInterceptor` 函数（一元RPC拦截器）：

```go
// ErrorUnaryInterceptor 错误处理拦截器（一元RPC）
func ErrorUnaryInterceptor() grpc.UnaryServerInterceptor {
    return func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {
        // 处理请求
        resp, err := handler(ctx, req)
        
        // 如果返回错误，转换为gRPC错误
        if err != nil {
            return nil, convertToGRPCError(err)
        }
        
        return resp, nil
    }
}

// convertToGRPCError 将应用错误转换为gRPC错误
func convertToGRPCError(err error) error {
    // 根据错误类型转换为gRPC错误
    switch e := err.(type) {
    case *errors.NotFoundError:
        return status.Error(codes.NotFound, e.Error())
    case *errors.UnauthorizedError:
        return status.Error(codes.Unauthenticated, e.Error())
    case *errors.ForbiddenError:
        return status.Error(codes.PermissionDenied, e.Error())
    case *errors.ValidationError:
        return status.Error(codes.InvalidArgument, e.Error())
    default:
        return status.Error(codes.Internal, fmt.Sprintf("服务器内部错误: %v", err))
    }
}
```

### 3. 捕获handler返回的错误

捕获handler返回的错误，检查是否有错误发生。

### 4. 将应用错误转换为gRPC错误

将应用错误转换为gRPC错误（使用status.Error），设置正确的gRPC错误码。

### 5. 设置gRPC错误码

设置gRPC错误码（codes.Internal、codes.NotFound等）：
- NotFoundError → codes.NotFound
- UnauthorizedError → codes.Unauthenticated
- ForbiddenError → codes.PermissionDenied
- ValidationError → codes.InvalidArgument
- 其他错误 → codes.Internal

### 6. 错误消息使用中文

所有错误消息使用中文，确保错误信息清晰。

### 7. 记录错误详细信息

记录错误详细信息（如需要），便于问题排查。

### 8. 返回gRPC错误

返回gRPC错误，确保错误响应格式统一。

## 验收标准

1. **可以正确捕获和处理错误**
   - handler返回的错误可以正确捕获
   - 错误处理逻辑正确

2. **应用错误可以正确转换为gRPC错误**
   - NotFoundError正确转换为codes.NotFound
   - UnauthorizedError正确转换为codes.Unauthenticated
   - ForbiddenError正确转换为codes.PermissionDenied
   - ValidationError正确转换为codes.InvalidArgument
   - 其他错误正确转换为codes.Internal

3. **gRPC错误码设置正确**
   - 错误码映射正确
   - 错误码符合gRPC标准

4. **错误消息使用中文**
   - 所有错误消息使用中文
   - 错误消息清晰、具体

5. **错误信息详细记录**
   - 错误信息正确记录
   - 错误信息有助于问题排查

## 相关文件

- `internal/grpc/interceptors/error.go` - 错误处理拦截器实现文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

