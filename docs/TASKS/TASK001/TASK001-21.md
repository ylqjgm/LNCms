# TASK001-21: 实现Elasticsearch健康检查功能

## 任务信息

**任务编号**: TASK001-21  
**父任务**: TASK001  
**任务名称**: 实现Elasticsearch健康检查功能  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

实现Elasticsearch搜索健康检查功能，通过检查集群健康状态来验证Elasticsearch连接是否正常，返回健康状态和错误信息。

## 依赖任务

- TASK001-20: 实现Elasticsearch连接初始化

## 实现指南

### 1. 实现HealthCheck函数

在 `internal/search/elasticsearch.go` 中实现 `HealthCheck` 函数。

### 2. 使用client.ClusterHealth方法检查集群健康状态

使用client.ClusterHealth方法检查集群健康状态：

```go
// HealthCheck 检查Elasticsearch连接健康状态
func HealthCheck(client *elastic.Client) (bool, error) {
    // 创建带超时的context
    ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
    defer cancel()
    
    // 检查集群健康状态
    health, err := client.ClusterHealth().Do(ctx)
    if err != nil {
        return false, fmt.Errorf("Elasticsearch健康检查失败: %w", err)
    }
    
    // 检查集群状态（green或yellow时认为健康）
    if health.Status == "red" {
        return false, fmt.Errorf("Elasticsearch集群状态为red，不健康")
    }
    
    return true, nil
}
```

### 3. 检查集群状态

检查集群状态（green、yellow、red）：
- green：所有主分片和副本分片都正常
- yellow：所有主分片正常，但部分副本分片不可用
- red：部分主分片不可用

### 4. 返回健康状态和错误信息

返回健康状态（健康/不健康）和错误信息（如果有）：
- green或yellow状态：返回健康
- red状态：返回不健康

### 5. 实现超时机制

实现超时机制，避免健康检查阻塞：

```go
ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
defer cancel()
```

### 6. 错误信息使用中文

所有错误信息使用中文，包含清晰的错误描述。

## 验收标准

1. **可以正确检查Elasticsearch连接健康状态**
   - 连接正常时返回健康状态
   - 连接异常时返回不健康状态
   - 健康检查结果准确

2. **健康检查执行快速（<100ms）**
   - 正常情况下的健康检查在100ms内完成
   - 超时机制正常工作

3. **错误信息清晰且使用中文**
   - 错误信息包含具体错误原因
   - 所有错误信息使用中文
   - 错误信息有助于问题排查

4. **超时机制正常工作**
   - 超时时间设置合理（如10秒）
   - 超时后正确返回错误
   - 不会导致健康检查永久阻塞

5. **集群状态判断正确**
   - green状态判断为健康
   - yellow状态判断为健康
   - red状态判断为不健康

## 相关文件

- `internal/search/elasticsearch.go` - Elasticsearch健康检查功能实现（修改）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

