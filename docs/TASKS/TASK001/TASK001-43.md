# TASK001-43: 创建主程序入口

## 任务信息

**任务编号**: TASK001-43  
**父任务**: TASK001  
**任务名称**: 创建主程序入口  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:44:12 CST

## 任务描述

创建cmd/core/main.go主程序入口，整合所有组件（配置、数据库、Redis、Elasticsearch、HTTP服务器、gRPC服务器），实现服务器启动逻辑。

## 依赖任务

- TASK001-07: 实现配置合并逻辑
- TASK001-10: 实现PostgreSQL连接初始化
- TASK001-15: 实现Redis连接初始化
- TASK001-20: 实现Elasticsearch连接初始化
- TASK001-29: 实现路由注册机制
- TASK001-38: 实现服务注册机制

## 实现指南

### 1. 创建主程序入口文件

创建 `cmd/core/main.go` 文件，实现主程序入口。

### 2. 实现main函数

实现main函数，整合所有组件：

```go
func main() {
    // 加载配置
    config, err := loadConfig()
    if err != nil {
        log.Fatalf("加载配置失败: %v", err)
    }
    
    // 初始化数据库连接
    db, err := database.NewPostgreSQL(config.Database)
    if err != nil {
        log.Fatalf("初始化数据库连接失败: %v", err)
    }
    defer db.Close()
    
    // 初始化Redis连接
    redisClient, err := cache.NewRedis(config.Redis)
    if err != nil {
        log.Fatalf("初始化Redis连接失败: %v", err)
    }
    defer redisClient.Close()
    
    // 初始化Elasticsearch连接
    esClient, err := search.NewElasticsearch(config.Elasticsearch)
    if err != nil {
        log.Fatalf("初始化Elasticsearch连接失败: %v", err)
    }
    defer esClient.Close()
    
    // 初始化HTTP服务器
    httpServer := http.NewServer(config, db, redisClient, esClient)
    
    // 初始化gRPC服务器
    grpcServer := grpc.NewServer(config, db, redisClient, esClient)
    
    // 启动HTTP服务器
    go func() {
        if err := httpServer.Start(); err != nil {
            log.Fatalf("启动HTTP服务器失败: %v", err)
        }
    }()
    
    // 启动gRPC服务器
    go func() {
        if err := grpcServer.Start(); err != nil {
            log.Fatalf("启动gRPC服务器失败: %v", err)
        }
    }()
    
    // 等待信号
    // 优雅关闭逻辑在TASK001-44中实现
}
```

### 3. 加载配置

加载配置（调用配置加载和合并函数），从环境变量和配置文件读取配置。

### 4. 初始化数据库连接

初始化数据库连接，使用PostgreSQL连接初始化函数。

### 5. 初始化Redis连接

初始化Redis连接，使用Redis连接初始化函数。

### 6. 初始化Elasticsearch连接

初始化Elasticsearch连接，使用Elasticsearch连接初始化函数。

### 7. 初始化HTTP服务器

初始化HTTP服务器（Gin引擎、路由、中间件），使用HTTP服务器初始化函数。

### 8. 初始化gRPC服务器

初始化gRPC服务器（服务注册、拦截器），使用gRPC服务器初始化函数。

### 9. 启动HTTP服务器和gRPC服务器

启动HTTP服务器和gRPC服务器，使用goroutine并行启动。

### 10. 实现启动错误处理

实现启动错误处理，启动失败时返回清晰的错误信息（中文）。

### 11. 所有错误消息和日志使用中文

所有错误消息和日志使用中文，确保信息清晰易懂。

## 验收标准

1. **主程序可以成功启动**
   - main函数可以正常执行
   - 所有组件可以正确初始化
   - 启动流程正确

2. **所有组件可以正确初始化**
   - 配置加载成功
   - 数据库连接初始化成功
   - Redis连接初始化成功
   - Elasticsearch连接初始化成功
   - HTTP服务器初始化成功
   - gRPC服务器初始化成功

3. **HTTP服务器和gRPC服务器可以正常启动**
   - HTTP服务器可以正常启动
   - gRPC服务器可以正常启动
   - 服务器可以正常监听端口

4. **启动错误处理正确**
   - 启动失败时返回错误
   - 错误信息清晰且使用中文
   - 错误信息有助于问题排查

5. **所有消息使用中文**
   - 所有错误消息使用中文
   - 所有日志消息使用中文
   - 信息清晰易懂

## 相关文件

- `cmd/core/main.go` - 主程序入口文件

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:44:12 CST

