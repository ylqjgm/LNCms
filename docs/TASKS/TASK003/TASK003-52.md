# TASK003-52: 编写模块管理仓储层单元测试

## 任务信息

**任务编号**: TASK003-52  
**父任务**: TASK003  
**任务名称**: 编写模块管理仓储层单元测试  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:06:02 CST

## 任务描述

编写模块管理仓储层单元测试。包括：1) 测试ModuleRepository的所有方法；2) 测试正常情况、边界情况和异常情况；3) 使用Mock数据库进行测试；4) 确保测试覆盖率达标。所有测试用例描述和错误消息必须使用中文。

## 依赖任务

- TASK003-50: 实现ModuleRepository接口

## 实现指南

### 1. 创建测试文件

在 `internal/pkg/repository/module_repository_test.go` 文件中创建测试：

```go
package repository

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
    "yourproject/internal/pkg/model"
)

// setupTestDB 设置测试数据库
func setupTestDB(t *testing.T) *gorm.DB {
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    require.NoError(t, err)
    
    // 自动迁移
    err = db.AutoMigrate(&model.Module{})
    require.NoError(t, err)
    
    return db
}

// teardownTestDB 清理测试数据库
func teardownTestDB(t *testing.T, db *gorm.DB) {
    sqlDB, err := db.DB()
    require.NoError(t, err)
    require.NoError(t, sqlDB.Close())
}
```

### 2. 测试Create方法

编写Create方法的测试用例：

```go
func TestModuleRepository_Create(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewModuleRepository(db)
    ctx := context.Background()
    
    tests := []struct {
        name    string
        module  *model.Module
        wantErr bool
        errMsg  string
    }{
        {
            name: "正常创建模块",
            module: &model.Module{
                ModuleID:       "test-module-001",
                ModuleName:     "测试模块",
                ModuleType:     "storage",
                ModuleURL:      "http://localhost:8080",
                ModuleStatus:   "inactive",
                HealthCheckURL: "http://localhost:8080/health",
            },
            wantErr: false,
        },
        {
            name: "创建模块-模块ID重复",
            module: &model.Module{
                ModuleID:     "test-module-001",
                ModuleName:   "测试模块2",
                ModuleType:   "storage",
                ModuleURL:    "http://localhost:8081",
                ModuleStatus: "inactive",
            },
            wantErr: true,
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := repo.Create(ctx, tt.module)
            if (err != nil) != tt.wantErr {
                t.Errorf("Create() error = %v, wantErr %v", err, tt.wantErr)
                return
            }
            if !tt.wantErr {
                assert.NotZero(t, tt.module.ID, "创建后模块ID应该不为0")
            }
        })
    }
}
```

### 3. 测试GetByID方法

编写GetByID方法的测试用例：

```go
func TestModuleRepository_GetByID(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewModuleRepository(db)
    ctx := context.Background()
    
    // 创建测试数据
    module := &model.Module{
        ModuleID:     "test-module-001",
        ModuleName:   "测试模块",
        ModuleType:   "storage",
        ModuleURL:    "http://localhost:8080",
        ModuleStatus: "inactive",
    }
    err := repo.Create(ctx, module)
    require.NoError(t, err)
    
    tests := []struct {
        name    string
        id      int64
        wantErr bool
        errMsg  string
    }{
        {
            name:    "正常获取模块",
            id:      module.ID,
            wantErr: false,
        },
        {
            name:    "模块不存在",
            id:      99999,
            wantErr: true,
            errMsg:  "模块不存在",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got, err := repo.GetByID(ctx, tt.id)
            if (err != nil) != tt.wantErr {
                t.Errorf("GetByID() error = %v, wantErr %v", err, tt.wantErr)
                return
            }
            if !tt.wantErr {
                assert.NotNil(t, got)
                assert.Equal(t, tt.id, got.ID)
            } else if err != nil {
                assert.Contains(t, err.Error(), tt.errMsg)
            }
        })
    }
}
```

### 4. 测试GetByModuleID方法

编写GetByModuleID方法的测试用例：

```go
func TestModuleRepository_GetByModuleID(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewModuleRepository(db)
    ctx := context.Background()
    
    // 创建测试数据
    module := &model.Module{
        ModuleID:     "test-module-001",
        ModuleName:   "测试模块",
        ModuleType:   "storage",
        ModuleURL:    "http://localhost:8080",
        ModuleStatus: "inactive",
    }
    err := repo.Create(ctx, module)
    require.NoError(t, err)
    
    tests := []struct {
        name     string
        moduleID string
        wantErr  bool
        errMsg   string
    }{
        {
            name:     "正常获取模块",
            moduleID: "test-module-001",
            wantErr:  false,
        },
        {
            name:     "模块不存在",
            moduleID: "non-existent-module",
            wantErr:  true,
            errMsg:   "模块不存在",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got, err := repo.GetByModuleID(ctx, tt.moduleID)
            if (err != nil) != tt.wantErr {
                t.Errorf("GetByModuleID() error = %v, wantErr %v", err, tt.wantErr)
                return
            }
            if !tt.wantErr {
                assert.NotNil(t, got)
                assert.Equal(t, tt.moduleID, got.ModuleID)
            } else if err != nil {
                assert.Contains(t, err.Error(), tt.errMsg)
            }
        })
    }
}
```

### 5. 测试List方法

编写List方法的测试用例：

```go
func TestModuleRepository_List(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewModuleRepository(db)
    ctx := context.Background()
    
    // 创建测试数据
    modules := []*model.Module{
        {ModuleID: "module-001", ModuleName: "模块1", ModuleType: "storage", ModuleURL: "http://localhost:8080", ModuleStatus: "active"},
        {ModuleID: "module-002", ModuleName: "模块2", ModuleType: "storage", ModuleURL: "http://localhost:8081", ModuleStatus: "inactive"},
        {ModuleID: "module-003", ModuleName: "模块3", ModuleType: "log", ModuleURL: "http://localhost:8082", ModuleStatus: "active"},
    }
    for _, m := range modules {
        err := repo.Create(ctx, m)
        require.NoError(t, err)
    }
    
    tests := []struct {
        name         string
        page         int
        limit        int
        moduleType   string
        moduleStatus string
        wantCount    int
        wantTotal    int64
        wantErr      bool
    }{
        {
            name:      "正常获取模块列表-无筛选",
            page:      1,
            limit:     10,
            moduleType: "",
            moduleStatus: "",
            wantCount: 3,
            wantTotal: 3,
            wantErr:   false,
        },
        {
            name:      "正常获取模块列表-按类型筛选",
            page:      1,
            limit:     10,
            moduleType: "storage",
            moduleStatus: "",
            wantCount: 2,
            wantTotal: 2,
            wantErr:   false,
        },
        {
            name:      "正常获取模块列表-按状态筛选",
            page:      1,
            limit:     10,
            moduleType: "",
            moduleStatus: "active",
            wantCount: 2,
            wantTotal: 2,
            wantErr:   false,
        },
        {
            name:      "正常获取模块列表-分页",
            page:      1,
            limit:     2,
            moduleType: "",
            moduleStatus: "",
            wantCount: 2,
            wantTotal: 3,
            wantErr:   false,
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got, total, err := repo.List(ctx, tt.page, tt.limit, tt.moduleType, tt.moduleStatus)
            if (err != nil) != tt.wantErr {
                t.Errorf("List() error = %v, wantErr %v", err, tt.wantErr)
                return
            }
            if !tt.wantErr {
                assert.Equal(t, tt.wantCount, len(got))
                assert.Equal(t, tt.wantTotal, total)
            }
        })
    }
}
```

### 6. 测试Update和Delete方法

编写Update和Delete方法的测试用例：

```go
func TestModuleRepository_Update(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewModuleRepository(db)
    ctx := context.Background()
    
    // 创建测试数据
    module := &model.Module{
        ModuleID:     "test-module-001",
        ModuleName:   "测试模块",
        ModuleType:   "storage",
        ModuleURL:    "http://localhost:8080",
        ModuleStatus: "inactive",
    }
    err := repo.Create(ctx, module)
    require.NoError(t, err)
    
    // 更新模块
    module.ModuleName = "更新后的模块名"
    module.ModuleStatus = "active"
    err = repo.Update(ctx, module)
    require.NoError(t, err)
    
    // 验证更新
    updated, err := repo.GetByID(ctx, module.ID)
    require.NoError(t, err)
    assert.Equal(t, "更新后的模块名", updated.ModuleName)
    assert.Equal(t, "active", updated.ModuleStatus)
}

func TestModuleRepository_Delete(t *testing.T) {
    db := setupTestDB(t)
    defer teardownTestDB(t, db)
    
    repo := NewModuleRepository(db)
    ctx := context.Background()
    
    // 创建测试数据
    module := &model.Module{
        ModuleID:     "test-module-001",
        ModuleName:   "测试模块",
        ModuleType:   "storage",
        ModuleURL:    "http://localhost:8080",
        ModuleStatus: "inactive",
    }
    err := repo.Create(ctx, module)
    require.NoError(t, err)
    
    tests := []struct {
        name    string
        id      int64
        wantErr bool
        errMsg  string
    }{
        {
            name:    "正常删除模块",
            id:      module.ID,
            wantErr: false,
        },
        {
            name:    "删除不存在的模块",
            id:      99999,
            wantErr: true,
            errMsg:  "模块不存在",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := repo.Delete(ctx, tt.id)
            if (err != nil) != tt.wantErr {
                t.Errorf("Delete() error = %v, wantErr %v", err, tt.wantErr)
                return
            }
            if !tt.wantErr {
                // 验证模块已删除
                _, err := repo.GetByID(ctx, tt.id)
                assert.Error(t, err)
                assert.Contains(t, err.Error(), "模块不存在")
            } else if err != nil {
                assert.Contains(t, err.Error(), tt.errMsg)
            }
        })
    }
}
```

### 7. 运行测试并检查覆盖率

运行测试并检查覆盖率：

```bash
# 运行测试
go test ./internal/pkg/repository -v -run TestModuleRepository

# 生成覆盖率报告
go test ./internal/pkg/repository -coverprofile=coverage.out -run TestModuleRepository

# 查看覆盖率
go tool cover -func=coverage.out

# 查看HTML覆盖率报告
go tool cover -html=coverage.out
```

## 验收标准

1. **测试覆盖所有方法**
   - Create方法有完整的测试用例
   - GetByID方法有完整的测试用例
   - GetByModuleID方法有完整的测试用例
   - List方法有完整的测试用例（包括分页和筛选）
   - Update方法有完整的测试用例
   - Delete方法有完整的测试用例

2. **测试覆盖所有场景**
   - 正常情况测试通过
   - 边界情况测试通过（分页、筛选等）
   - 异常情况测试通过（记录不存在、唯一约束冲突等）

3. **测试覆盖率达标**
   - 代码覆盖率达到80%以上
   - 关键路径覆盖率达到100%

4. **测试代码规范**
   - 使用表驱动测试
   - 测试用例描述清晰，使用中文
   - 使用testify库进行断言
   - 测试代码遵循Golang编码规范

## 相关文件

- `internal/pkg/repository/module_repository_test.go` - 模块仓储单元测试
- `internal/pkg/repository/module_repository.go` - ModuleRepository实现
- `internal/pkg/model/module.go` - Module模型定义
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/testing.mdc` - 单元测试规范
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:06:02 CST

