# TASK003-32: 实现获取图片附件设置API（GET）

## 任务信息

**任务编号**: TASK003-32  
**父任务**: TASK003  
**任务名称**: 实现获取图片附件设置API（GET）  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 13:56:32 CST

## 任务描述

实现获取图片附件设置API接口。包括：1) 实现 GET /api/v1/system/config/attachment/image 端点；2) 实现请求处理和响应构建；3) 遵循OpenAPI 3.1.1规范和Envelope响应格式。所有错误消息必须使用中文。

## 依赖任务

- TASK003-09: 实现系统配置热更新机制

## 实现指南

### 1. 定义响应结构体

在 `internal/api/v1/dto/config_dto.go` 文件中定义图片附件设置响应结构体：

```go
package dto

// ImageThumbnail 图片缩略图配置
type ImageThumbnail struct {
    Name   string `json:"name"`   // 缩略图名称
    Width  int    `json:"width"`  // 宽度
    Height int    `json:"height"` // 高度
    Quality int   `json:"quality"` // 质量，范围1-100
}

// ImageAttachmentConfigResponse 图片附件设置响应
type ImageAttachmentConfigResponse struct {
    Enabled          bool            `json:"enabled"`           // 附件开关
    StorageChannelID int             `json:"storage_channel_id"` // 存储对象（渠道ID）
    AllowedTypes     []string        `json:"allowed_types"`     // 上传类型
    MaxSize          int64           `json:"max_size"`          // 上传大小，单位字节
    StoragePath      string          `json:"storage_path"`      // 存储路径
    ConvertFormat    string          `json:"convert_format"`    // 转换格式
    Quality          int             `json:"quality"`           // 图片质量，范围1-100
    WatermarkEnabled bool            `json:"watermark_enabled"` // 水印开关
    WatermarkType    string          `json:"watermark_type"`    // 水印类型：text、image
    WatermarkPosition string         `json:"watermark_position"` // 水印位置
    WatermarkOpacity float64         `json:"watermark_opacity"`  // 水印透明度，范围0.0-1.0
    Thumbnails       []ImageThumbnail `json:"thumbnails"`        // 图片缩略图
}
```

### 2. 实现GetImageAttachmentConfig方法

在ConfigHandler中实现GetImageAttachmentConfig方法：

```go
// GetImageAttachmentConfig 获取图片附件设置
// @Summary 获取图片附件设置
// @Description 获取图片附件配置信息
// @Tags 系统配置
// @Accept json
// @Produce json
// @Success 200 {object} response.Envelope{data=dto.ImageAttachmentConfigResponse} "成功响应"
// @Failure 500 {object} response.Envelope "服务器错误"
// @Router /api/v1/system/config/attachment/image [get]
func (h *ConfigHandler) GetImageAttachmentConfig(c *gin.Context) {
    ctx := c.Request.Context()
    
    // 从服务层获取配置
    configData, err := h.configService.GetConfig(ctx, string(model.ConfigTypeAttachment))
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_GET_FAILED", "获取附件设置失败", err)
        return
    }
    
    // 解析配置数据，获取image部分
    configMap, ok := configData.(map[string]interface{})
    if !ok {
        response.Error(c, http.StatusInternalServerError, "CONFIG_PARSE_FAILED", "解析附件设置失败", nil)
        return
    }
    
    imageConfig, ok := configMap["image"].(map[string]interface{})
    if !ok {
        response.Error(c, http.StatusInternalServerError, "CONFIG_PARSE_FAILED", "解析图片附件设置失败", nil)
        return
    }
    
    // 将配置数据转换为响应结构体
    var imageAttachmentConfig dto.ImageAttachmentConfigResponse
    if err := mapToImageAttachmentConfig(imageConfig, &imageAttachmentConfig); err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_PARSE_FAILED", "解析图片附件设置失败", err)
        return
    }
    
    // 返回成功响应
    response.Success(c, imageAttachmentConfig)
}

// mapToImageAttachmentConfig 将配置数据映射到ImageAttachmentConfigResponse
func mapToImageAttachmentConfig(data map[string]interface{}, config *dto.ImageAttachmentConfigResponse) error {
    // 映射基本字段
    if v, ok := data["enabled"].(bool); ok {
        config.Enabled = v
    }
    if v, ok := data["storage_channel_id"].(float64); ok {
        config.StorageChannelID = int(v)
    }
    if v, ok := data["allowed_types"].([]interface{}); ok {
        config.AllowedTypes = make([]string, 0, len(v))
        for _, item := range v {
            if str, ok := item.(string); ok {
                config.AllowedTypes = append(config.AllowedTypes, str)
            }
        }
    }
    if v, ok := data["max_size"].(float64); ok {
        config.MaxSize = int64(v)
    }
    if v, ok := data["storage_path"].(string); ok {
        config.StoragePath = v
    }
    if v, ok := data["convert_format"].(string); ok {
        config.ConvertFormat = v
    }
    if v, ok := data["quality"].(float64); ok {
        config.Quality = int(v)
    }
    if v, ok := data["watermark_enabled"].(bool); ok {
        config.WatermarkEnabled = v
    }
    if v, ok := data["watermark_type"].(string); ok {
        config.WatermarkType = v
    }
    if v, ok := data["watermark_position"].(string); ok {
        config.WatermarkPosition = v
    }
    if v, ok := data["watermark_opacity"].(float64); ok {
        config.WatermarkOpacity = v
    }
    
    // 映射缩略图数组
    if v, ok := data["thumbnails"].([]interface{}); ok {
        config.Thumbnails = make([]dto.ImageThumbnail, 0, len(v))
        for _, item := range v {
            thumbnailMap, ok := item.(map[string]interface{})
            if !ok {
                continue
            }
            thumbnail := dto.ImageThumbnail{}
            if name, ok := thumbnailMap["name"].(string); ok {
                thumbnail.Name = name
            }
            if width, ok := thumbnailMap["width"].(float64); ok {
                thumbnail.Width = int(width)
            }
            if height, ok := thumbnailMap["height"].(float64); ok {
                thumbnail.Height = int(height)
            }
            if quality, ok := thumbnailMap["quality"].(float64); ok {
                thumbnail.Quality = int(quality)
            }
            config.Thumbnails = append(config.Thumbnails, thumbnail)
        }
    }
    
    return nil
}
```

### 3. 注册路由

在 `internal/api/v1/router/router.go` 文件中注册路由：

```go
// RegisterConfigRoutes 注册配置相关路由
func RegisterConfigRoutes(r *gin.RouterGroup, configHandler *handler.ConfigHandler) {
    config := r.Group("/system/config")
    {
        // ... 其他路由 ...
        attachment := config.Group("/attachment")
        {
            attachment.GET("/image", configHandler.GetImageAttachmentConfig) // 添加图片附件设置GET路由
        }
    }
}
```

## 验收标准

1. **API端点正确实现**
   - GET /api/v1/system/config/attachment/image 端点正确实现
   - 路由正确注册

2. **响应格式符合要求**
   - 响应使用Envelope格式
   - meta字段包含success、code、message、timestamp、request_id
   - data字段包含ImageAttachmentConfigResponse结构体
   - errors字段为空数组

3. **错误处理正确**
   - 配置获取失败时返回适当的错误响应
   - 数据解析失败时返回适当的错误响应
   - 所有错误消息使用中文

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/api/v1/handler/config_handler.go` - 配置处理器实现
- `internal/api/v1/dto/config_dto.go` - 配置DTO定义
- `internal/api/v1/router/router.go` - 路由注册
- `internal/pkg/service/config_service.go` - 配置服务层实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/api.mdc` - API设计规范
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 13:56:32 CST

