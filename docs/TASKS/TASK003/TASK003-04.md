# TASK003-04: 系统配置管理API - 高级配置

## 任务信息

**任务编号**: TASK003-04  
**父任务**: TASK003  
**任务名称**: 系统配置管理API - 高级配置  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:30:48 CST

## 任务描述

实现系统配置管理的高级配置API接口。包括：1) 附件设置API（GET/PUT /api/v1/system/config/attachment/image、audio、video，存储渠道管理接口）；2) 邮箱设置API（GET/PUT /api/v1/system/config/email，包括测试邮箱配置接口）；3) 屏蔽设置API（GET/PUT /api/v1/system/config/shield）。所有API必须遵循OpenAPI 3.1.1规范和Envelope响应格式，需要管理员权限的接口必须进行权限验证。编写API测试验证接口功能。

## 依赖任务

TASK003-03: 系统配置管理API - 基础配置

## 实现指南

### 1. 扩展ConfigHandler

在 `internal/api/v1/handler/config_handler.go` 文件中扩展处理器方法：

```go
// GetAttachmentConfig 获取附件设置
func (h *ConfigHandler) GetAttachmentConfig(c *gin.Context) {
    attachmentType := c.Param("type") // image、audio、video
    configType := model.ConfigTypeAttachment
    // 根据类型获取对应配置
}

// UpdateAttachmentConfig 更新附件设置
func (h *ConfigHandler) UpdateAttachmentConfig(c *gin.Context) {
    attachmentType := c.Param("type")
    var req UpdateAttachmentConfigRequest
    // 验证和更新配置
}

// GetStorageChannels 获取存储渠道列表
func (h *ConfigHandler) GetStorageChannels(c *gin.Context) {
    // 实现存储渠道列表查询（支持分页）
}

// CreateStorageChannel 创建存储渠道
func (h *ConfigHandler) CreateStorageChannel(c *gin.Context) {
    var req CreateStorageChannelRequest
    // 验证和创建存储渠道
}

// GetEmailConfig 获取邮箱设置
func (h *ConfigHandler) GetEmailConfig(c *gin.Context) {
    // 实现邮箱配置获取
}

// UpdateEmailConfig 更新邮箱设置
func (h *ConfigHandler) UpdateEmailConfig(c *gin.Context) {
    var req UpdateEmailConfigRequest
    // 验证和更新邮箱配置
}

// TestEmailConfig 测试邮箱配置
func (h *ConfigHandler) TestEmailConfig(c *gin.Context) {
    // 发送测试邮件
}

// GetShieldConfig 获取屏蔽设置
func (h *ConfigHandler) GetShieldConfig(c *gin.Context) {
    // 实现屏蔽配置获取
}

// UpdateShieldConfig 更新屏蔽设置
func (h *ConfigHandler) UpdateShieldConfig(c *gin.Context) {
    var req UpdateShieldConfigRequest
    // 验证和更新屏蔽配置
}
```

### 2. 扩展路由注册

在 `internal/api/v1/route/config_route.go` 文件中扩展路由：

```go
// 附件设置
configGroup.GET("/attachment/:type", configHandler.GetAttachmentConfig)
configGroup.PUT("/attachment/:type", authMiddleware, middleware.RequireAdmin(), configHandler.UpdateAttachmentConfig)

// 存储渠道管理
configGroup.GET("/storage/channels", configHandler.GetStorageChannels)
configGroup.POST("/storage/channels", authMiddleware, middleware.RequireAdmin(), configHandler.CreateStorageChannel)
configGroup.PUT("/storage/channels/:channel_id", authMiddleware, middleware.RequireAdmin(), configHandler.UpdateStorageChannel)
configGroup.DELETE("/storage/channels/:channel_id", authMiddleware, middleware.RequireAdmin(), configHandler.DeleteStorageChannel)

// 邮箱设置
configGroup.GET("/email", configHandler.GetEmailConfig)
configGroup.PUT("/email", authMiddleware, middleware.RequireAdmin(), configHandler.UpdateEmailConfig)
configGroup.POST("/email/test", authMiddleware, middleware.RequireAdmin(), configHandler.TestEmailConfig)

// 屏蔽设置
configGroup.GET("/shield", configHandler.GetShieldConfig)
configGroup.PUT("/shield", authMiddleware, middleware.RequireAdmin(), configHandler.UpdateShieldConfig)
```

## 验收标准

1. 所有高级配置API接口正确实现
2. 附件配置验证逻辑正确实现，覆盖所有配置项
3. 邮箱测试功能正确实现，能够发送测试邮件
4. API测试通过，覆盖所有接口
5. 复杂配置结构的序列化和反序列化正确
6. 错误处理完善，错误消息使用中文

## 相关文件

- `internal/api/v1/handler/config_handler.go` - 扩展配置API处理器
- `internal/api/v1/route/config_route.go` - 扩展配置API路由
- `internal/pkg/validator/attachment_validator.go` - 附件配置验证器
- `docs/Requirements/Core.md` - 核心模块需求文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:30:48 CST

