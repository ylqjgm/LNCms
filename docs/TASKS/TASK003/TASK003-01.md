# TASK003-01: 系统配置数据库模型和仓储层实现

## 任务信息

**任务编号**: TASK003-01  
**父任务**: TASK003  
**任务名称**: 系统配置数据库模型和仓储层实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:30:48 CST

## 任务描述

创建系统配置的GORM模型和仓储层实现。包括：1) 创建SystemConfig模型，定义配置表结构（id、config_type、config_data、created_at、updated_at）；2) 实现ConfigRepository接口，提供配置的CRUD操作（Create、GetByType、Update、Delete）；3) 实现配置类型枚举和常量定义；4) 编写单元测试验证仓储层功能。所有代码必须遵循Golang编码规范和PostgreSQL数据库设计规范。

## 依赖任务

无

## 实现指南

### 1. 创建SystemConfig模型

在 `internal/pkg/model/system_config.go` 文件中创建SystemConfig结构体：

```go
package model

import (
    "time"
    "gorm.io/datatypes"
)

// ConfigType 配置类型
type ConfigType string

const (
    ConfigTypeSite       ConfigType = "site"
    ConfigTypeRegister   ConfigType = "register"
    ConfigTypeCluster    ConfigType = "cluster"
    ConfigTypePoints     ConfigType = "points"
    ConfigTypeAttachment ConfigType = "attachment"
    ConfigTypeEmail      ConfigType = "email"
    ConfigTypeShield     ConfigType = "shield"
)

// SystemConfig 系统配置模型
type SystemConfig struct {
    ID         int64          `gorm:"primaryKey;autoIncrement" json:"id"`
    ConfigType ConfigType     `gorm:"type:varchar(50);not null;uniqueIndex:uk_configs_config_type" json:"config_type"`
    ConfigData datatypes.JSON `gorm:"type:jsonb;not null" json:"config_data"`
    CreatedAt  time.Time      `gorm:"type:timestamptz;default:current_timestamp" json:"created_at"`
    UpdatedAt  time.Time      `gorm:"type:timestamptz;default:current_timestamp" json:"updated_at"`
}

// TableName 指定表名
func (SystemConfig) TableName() string {
    return "system_configs"
}
```

### 2. 创建ConfigRepository接口

在 `internal/pkg/repository/config_repository.go` 文件中定义接口和实现：

```go
package repository

import (
    "context"
    "yourproject/internal/pkg/model"
)

// ConfigRepository 配置仓储接口
type ConfigRepository interface {
    // GetByType 根据配置类型获取配置
    GetByType(ctx context.Context, configType model.ConfigType) (*model.SystemConfig, error)
    
    // Create 创建配置
    Create(ctx context.Context, config *model.SystemConfig) error
    
    // Update 更新配置
    Update(ctx context.Context, config *model.SystemConfig) error
    
    // Delete 删除配置
    Delete(ctx context.Context, configType model.ConfigType) error
}

// configRepository 配置仓储实现
type configRepository struct {
    db *gorm.DB
}

// NewConfigRepository 创建配置仓储实例
func NewConfigRepository(db *gorm.DB) ConfigRepository {
    return &configRepository{db: db}
}

// GetByType 实现接口方法
func (r *configRepository) GetByType(ctx context.Context, configType model.ConfigType) (*model.SystemConfig, error) {
    var config model.SystemConfig
    err := r.db.WithContext(ctx).
        Where("config_type = ?", configType).
        First(&config).Error
    if err != nil {
        return nil, err
    }
    return &config, nil
}

// Create 实现接口方法
func (r *configRepository) Create(ctx context.Context, config *model.SystemConfig) error {
    return r.db.WithContext(ctx).Create(config).Error
}

// Update 实现接口方法
func (r *configRepository) Update(ctx context.Context, config *model.SystemConfig) error {
    return r.db.WithContext(ctx).
        Model(&model.SystemConfig{}).
        Where("config_type = ?", config.ConfigType).
        Updates(map[string]interface{}{
            "config_data": config.ConfigData,
            "updated_at":  time.Now(),
        }).Error
}

// Delete 实现接口方法
func (r *configRepository) Delete(ctx context.Context, configType model.ConfigType) error {
    return r.db.WithContext(ctx).
        Where("config_type = ?", configType).
        Delete(&model.SystemConfig{}).Error
}
```

### 3. 编写单元测试

在 `internal/pkg/repository/config_repository_test.go` 文件中编写测试：

```go
package repository

import (
    "context"
    "testing"
    "yourproject/internal/pkg/model"
    // 测试框架导入
)

func TestConfigRepository_GetByType(t *testing.T) {
    // 测试用例
}

func TestConfigRepository_Create(t *testing.T) {
    // 测试用例
}

func TestConfigRepository_Update(t *testing.T) {
    // 测试用例
}

func TestConfigRepository_Delete(t *testing.T) {
    // 测试用例
}
```

## 验收标准

1. SystemConfig模型正确定义，包含所有必需字段和GORM标签
2. ConfigRepository接口完整实现，支持所有CRUD操作
3. 单元测试通过，覆盖所有仓储层方法
4. 代码通过golangci-lint检查，无错误和警告
5. 代码注释完整，使用中文

## 相关文件

- `internal/pkg/model/system_config.go` - 系统配置模型定义
- `internal/pkg/repository/config_repository.go` - 配置仓储层实现
- `internal/pkg/repository/config_repository_test.go` - 配置仓储层单元测试
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:30:48 CST

