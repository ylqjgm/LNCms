# TASK003-03: 系统配置管理API - 基础配置

## 任务信息

**任务编号**: TASK003-03  
**父任务**: TASK003  
**任务名称**: 系统配置管理API - 基础配置  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:30:48 CST

## 任务描述

实现系统配置管理的基础配置API接口。包括：1) 网站设置API（GET/PUT /api/v1/system/config/site）；2) 注册设置API（GET/PUT /api/v1/system/config/register）；3) 站群设置API（GET/PUT /api/v1/system/config/cluster，包括节点管理接口）；4) 积分设置API（GET/PUT /api/v1/system/config/points）。所有API必须遵循OpenAPI 3.1.1规范和Envelope响应格式，需要管理员权限的接口必须进行权限验证。编写API测试验证接口功能。

## 依赖任务

TASK003-02: 系统配置管理核心服务实现

## 实现指南

### 1. 创建ConfigHandler

在 `internal/api/v1/handler/config_handler.go` 文件中创建处理器：

```go
package handler

import (
    "net/http"
    "yourproject/internal/pkg/service"
    "yourproject/internal/pkg/response"
)

// ConfigHandler 配置处理器
type ConfigHandler struct {
    configService service.ConfigService
}

// NewConfigHandler 创建配置处理器实例
func NewConfigHandler(configService service.ConfigService) *ConfigHandler {
    return &ConfigHandler{configService: configService}
}

// GetSiteConfig 获取网站设置
func (h *ConfigHandler) GetSiteConfig(c *gin.Context) {
    config, err := h.configService.GetConfig(c.Request.Context(), model.ConfigTypeSite)
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "获取网站设置失败", err)
        return
    }
    response.Success(c, config)
}

// UpdateSiteConfig 更新网站设置
func (h *ConfigHandler) UpdateSiteConfig(c *gin.Context) {
    var req UpdateSiteConfigRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "请求参数错误", err)
        return
    }
    
    if err := h.configService.UpdateConfig(c.Request.Context(), model.ConfigTypeSite, req); err != nil {
        response.Error(c, http.StatusInternalServerError, "更新网站设置失败", err)
        return
    }
    
    response.Success(c, nil)
}
```

### 2. 注册路由

在 `internal/api/v1/route/config_route.go` 文件中注册路由：

```go
package route

import (
    "yourproject/internal/api/v1/handler"
    "yourproject/internal/middleware"
)

// RegisterConfigRoutes 注册配置路由
func RegisterConfigRoutes(r *gin.RouterGroup, configHandler *handler.ConfigHandler, authMiddleware gin.HandlerFunc) {
    configGroup := r.Group("/system/config")
    {
        // 网站设置
        configGroup.GET("/site", configHandler.GetSiteConfig)
        configGroup.PUT("/site", authMiddleware, middleware.RequireAdmin(), configHandler.UpdateSiteConfig)
        
        // 注册设置
        configGroup.GET("/register", configHandler.GetRegisterConfig)
        configGroup.PUT("/register", authMiddleware, middleware.RequireAdmin(), configHandler.UpdateRegisterConfig)
        
        // 站群设置
        configGroup.GET("/cluster", configHandler.GetClusterConfig)
        configGroup.PUT("/cluster", authMiddleware, middleware.RequireAdmin(), configHandler.UpdateClusterConfig)
        configGroup.POST("/cluster/nodes", authMiddleware, middleware.RequireAdmin(), configHandler.AddClusterNode)
        configGroup.PUT("/cluster/nodes/:node_id", authMiddleware, middleware.RequireAdmin(), configHandler.UpdateClusterNode)
        configGroup.DELETE("/cluster/nodes/:node_id", authMiddleware, middleware.RequireAdmin(), configHandler.DeleteClusterNode)
        
        // 积分设置
        configGroup.GET("/points", configHandler.GetPointsConfig)
        configGroup.PUT("/points", authMiddleware, middleware.RequireAdmin(), configHandler.UpdatePointsConfig)
    }
}
```

## 验收标准

1. 所有API接口正确实现，遵循Envelope响应格式
2. 权限验证正确实现，管理员接口需要权限验证
3. 请求验证正确实现，验证请求参数
4. API测试通过，覆盖所有接口
5. 响应格式符合OpenAPI 3.1.1规范
6. 错误消息使用中文

## 相关文件

- `internal/api/v1/handler/config_handler.go` - 配置API处理器
- `internal/api/v1/route/config_route.go` - 配置API路由注册
- `internal/api/v1/handler/config_handler_test.go` - 配置API测试
- `docs/Requirements/Core.md` - 核心模块需求文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:30:48 CST

