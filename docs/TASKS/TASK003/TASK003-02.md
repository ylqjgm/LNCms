# TASK003-02: 实现ConfigRepository接口

## 任务信息

**任务编号**: TASK003-02  
**父任务**: TASK003  
**任务名称**: 实现ConfigRepository接口  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 13:31:24 CST

## 任务描述

实现ConfigRepository接口，提供配置的CRUD操作。包括：1) 定义ConfigRepository接口；2) 实现配置的创建、查询、更新、删除方法（Create、GetByType、Update、Delete）；3) 实现数据库操作逻辑。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK003-01: 创建SystemConfig模型

## 实现指南

### 1. 定义ConfigRepository接口

在 `internal/pkg/repository/config_repository.go` 文件中定义接口：

```go
package repository

import (
    "context"
    "yourproject/internal/pkg/model"
)

// ConfigRepository 配置仓储接口
type ConfigRepository interface {
    // GetByType 根据配置类型获取配置
    GetByType(ctx context.Context, configType string) (*model.SystemConfig, error)
    
    // Create 创建配置
    Create(ctx context.Context, config *model.SystemConfig) error
    
    // Update 更新配置
    Update(ctx context.Context, config *model.SystemConfig) error
    
    // Delete 删除配置
    Delete(ctx context.Context, configType string) error
}
```

### 2. 实现configRepository结构体

在同一个文件中实现配置仓储：

```go
import (
    "context"
    "time"
    "gorm.io/gorm"
    "yourproject/internal/pkg/model"
)

// configRepository 配置仓储实现
type configRepository struct {
    db *gorm.DB
}

// NewConfigRepository 创建配置仓储实例
func NewConfigRepository(db *gorm.DB) ConfigRepository {
    return &configRepository{db: db}
}
```

### 3. 实现GetByType方法

实现根据配置类型获取配置的方法：

```go
// GetByType 根据配置类型获取配置
func (r *configRepository) GetByType(ctx context.Context, configType string) (*model.SystemConfig, error) {
    var config model.SystemConfig
    err := r.db.WithContext(ctx).
        Where("config_type = ?", configType).
        First(&config).Error
    if err != nil {
        if err == gorm.ErrRecordNotFound {
            return nil, fmt.Errorf("配置类型 %s 不存在", configType)
        }
        return nil, fmt.Errorf("查询配置失败: %w", err)
    }
    return &config, nil
}
```

### 4. 实现Create方法

实现创建配置的方法：

```go
// Create 创建配置
func (r *configRepository) Create(ctx context.Context, config *model.SystemConfig) error {
    if config == nil {
        return fmt.Errorf("配置不能为空")
    }
    config.CreatedAt = time.Now()
    config.UpdatedAt = time.Now()
    if err := r.db.WithContext(ctx).Create(config).Error; err != nil {
        return fmt.Errorf("创建配置失败: %w", err)
    }
    return nil
}
```

### 5. 实现Update方法

实现更新配置的方法：

```go
// Update 更新配置
func (r *configRepository) Update(ctx context.Context, config *model.SystemConfig) error {
    if config == nil {
        return fmt.Errorf("配置不能为空")
    }
    config.UpdatedAt = time.Now()
    result := r.db.WithContext(ctx).
        Model(&model.SystemConfig{}).
        Where("config_type = ?", config.ConfigType).
        Updates(map[string]interface{}{
            "config_data": config.ConfigData,
            "updated_at":  config.UpdatedAt,
        })
    if result.Error != nil {
        return fmt.Errorf("更新配置失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("配置类型 %s 不存在", config.ConfigType)
    }
    return nil
}
```

### 6. 实现Delete方法

实现删除配置的方法：

```go
// Delete 删除配置
func (r *configRepository) Delete(ctx context.Context, configType string) error {
    result := r.db.WithContext(ctx).
        Where("config_type = ?", configType).
        Delete(&model.SystemConfig{})
    if result.Error != nil {
        return fmt.Errorf("删除配置失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("配置类型 %s 不存在", configType)
    }
    return nil
}
```

## 验收标准

1. **ConfigRepository接口正确定义**
   - 接口包含所有必需的方法：GetByType、Create、Update、Delete
   - 方法签名正确，参数和返回值类型明确
   - 接口注释完整，使用中文

2. **configRepository实现完整**
   - 所有接口方法都已实现
   - 实现逻辑正确，处理了错误情况
   - 错误消息使用中文，清晰明确

3. **数据库操作正确**
   - 使用GORM进行数据库操作
   - 正确使用context传递上下文
   - 正确处理记录不存在的情况
   - 正确设置时间字段（created_at、updated_at）

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/repository/config_repository.go` - 配置仓储层实现
- `internal/pkg/model/system_config.go` - 系统配置模型定义
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 13:31:24 CST
