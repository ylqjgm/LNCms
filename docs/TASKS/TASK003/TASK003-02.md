# TASK003-02: 系统配置管理核心服务实现

## 任务信息

**任务编号**: TASK003-02  
**父任务**: TASK003  
**任务名称**: 系统配置管理核心服务实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:30:48 CST

## 任务描述

实现系统配置管理的核心业务逻辑。包括：1) 创建ConfigService接口和实现，提供配置的读取、更新、验证功能；2) 实现Redis缓存管理，配置读取优先从缓存获取，更新时清除缓存；3) 实现配置验证器，为每种配置类型提供验证规则；4) 实现配置热更新机制；5) 编写单元测试验证服务层功能。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK003-01: 系统配置数据库模型和仓储层实现

## 实现指南

### 1. 创建ConfigService接口

在 `internal/pkg/service/config_service.go` 文件中定义接口和实现：

```go
package service

import (
    "context"
    "yourproject/internal/pkg/model"
)

// ConfigService 配置服务接口
type ConfigService interface {
    // GetConfig 获取配置（优先从缓存读取）
    GetConfig(ctx context.Context, configType model.ConfigType) (interface{}, error)
    
    // UpdateConfig 更新配置（验证、保存、清除缓存）
    UpdateConfig(ctx context.Context, configType model.ConfigType, data interface{}) error
    
    // ValidateConfig 验证配置数据
    ValidateConfig(ctx context.Context, configType model.ConfigType, data interface{}) error
}

// configService 配置服务实现
type configService struct {
    repo  repository.ConfigRepository
    cache cache.Cache
    validator validator.ConfigValidator
}

// NewConfigService 创建配置服务实例
func NewConfigService(repo repository.ConfigRepository, cache cache.Cache, validator validator.ConfigValidator) ConfigService {
    return &configService{
        repo:      repo,
        cache:     cache,
        validator: validator,
    }
}
```

### 2. 实现缓存管理

实现配置的缓存读取和更新逻辑：

```go
// GetConfig 实现接口方法
func (s *configService) GetConfig(ctx context.Context, configType model.ConfigType) (interface{}, error) {
    // 1. 尝试从缓存读取
    cacheKey := fmt.Sprintf("config:%s", configType)
    var configData interface{}
    if err := s.cache.Get(ctx, cacheKey, &configData); err == nil {
        return configData, nil
    }
    
    // 2. 缓存未命中，从数据库读取
    config, err := s.repo.GetByType(ctx, configType)
    if err != nil {
        return nil, fmt.Errorf("获取配置失败: %w", err)
    }
    
    // 3. 解析配置数据
    if err := json.Unmarshal(config.ConfigData, &configData); err != nil {
        return nil, fmt.Errorf("解析配置数据失败: %w", err)
    }
    
    // 4. 写入缓存（过期时间24小时）
    s.cache.Set(ctx, cacheKey, configData, 24*time.Hour)
    
    return configData, nil
}

// UpdateConfig 实现接口方法
func (s *configService) UpdateConfig(ctx context.Context, configType model.ConfigType, data interface{}) error {
    // 1. 验证配置数据
    if err := s.ValidateConfig(ctx, configType, data); err != nil {
        return err
    }
    
    // 2. 序列化配置数据
    configData, err := json.Marshal(data)
    if err != nil {
        return fmt.Errorf("序列化配置数据失败: %w", err)
    }
    
    // 3. 更新数据库
    config := &model.SystemConfig{
        ConfigType: configType,
        ConfigData: configData,
    }
    if err := s.repo.Update(ctx, config); err != nil {
        return fmt.Errorf("更新配置失败: %w", err)
    }
    
    // 4. 清除缓存
    cacheKey := fmt.Sprintf("config:%s", configType)
    s.cache.Delete(ctx, cacheKey)
    
    return nil
}
```

### 3. 实现配置验证器

在 `internal/pkg/validator/config_validator.go` 文件中实现验证器：

```go
package validator

import "yourproject/internal/pkg/model"

// ConfigValidator 配置验证器接口
type ConfigValidator interface {
    Validate(configType model.ConfigType, data interface{}) error
}

// configValidator 配置验证器实现
type configValidator struct {
    // 验证器实现
}

// Validate 实现接口方法
func (v *configValidator) Validate(configType model.ConfigType, data interface{}) error {
    switch configType {
    case model.ConfigTypeSite:
        return v.validateSiteConfig(data)
    case model.ConfigTypeRegister:
        return v.validateRegisterConfig(data)
    // ... 其他配置类型
    default:
        return fmt.Errorf("不支持的配置类型: %s", configType)
    }
}
```

## 验收标准

1. ConfigService接口完整实现，支持配置读取、更新、验证
2. 缓存机制正确实现，读取优先从缓存获取
3. 配置验证器正确实现，覆盖所有配置类型
4. 单元测试通过，覆盖所有服务方法，包括缓存和验证逻辑
5. 代码覆盖率达到80%以上
6. 错误处理完善，错误消息使用中文

## 相关文件

- `internal/pkg/service/config_service.go` - 配置服务实现
- `internal/pkg/validator/config_validator.go` - 配置验证器实现
- `internal/pkg/service/config_service_test.go` - 配置服务单元测试
- `docs/Requirements/Core.md` - 核心模块需求文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:30:48 CST

