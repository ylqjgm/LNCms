# TASK003-05: 创建ConfigService接口和实现

## 任务信息

**任务编号**: TASK003-05  
**父任务**: TASK003  
**任务名称**: 创建ConfigService接口和实现  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 13:31:24 CST

## 任务描述

创建ConfigService接口和实现，提供配置的读取、更新功能。包括：1) 定义ConfigService接口；2) 实现配置的读取、更新方法；3) 实现业务逻辑处理。所有代码必须遵循Golang编码规范，错误消息使用中文。

**注意**：本任务只实现核心服务功能，不包含Redis缓存管理和热更新机制，这些功能将在后续任务中实现。

## 依赖任务

- TASK003-02: 实现ConfigRepository接口

## 实现指南

### 1. 定义ConfigService接口

在 `internal/pkg/service/config_service.go` 文件中定义接口：

```go
package service

import (
    "context"
    "yourproject/internal/pkg/model"
)

// ConfigService 配置服务接口
type ConfigService interface {
    // GetConfig 获取配置
    GetConfig(ctx context.Context, configType string) (interface{}, error)
    
    // UpdateConfig 更新配置
    UpdateConfig(ctx context.Context, configType string, data interface{}) error
}
```

### 2. 实现configService结构体

在同一个文件中实现配置服务：

```go
import (
    "context"
    "encoding/json"
    "fmt"
    "yourproject/internal/pkg/model"
    "yourproject/internal/pkg/repository"
    "gorm.io/datatypes"
)

// configService 配置服务实现
type configService struct {
    repo repository.ConfigRepository
}

// NewConfigService 创建配置服务实例
func NewConfigService(repo repository.ConfigRepository) ConfigService {
    return &configService{
        repo: repo,
    }
}
```

### 3. 实现GetConfig方法

实现获取配置的方法：

```go
// GetConfig 获取配置
func (s *configService) GetConfig(ctx context.Context, configType string) (interface{}, error) {
    // 从仓储层获取配置
    config, err := s.repo.GetByType(ctx, configType)
    if err != nil {
        return nil, fmt.Errorf("获取配置失败: %w", err)
    }
    
    // 解析配置数据
    var configData interface{}
    if err := json.Unmarshal(config.ConfigData, &configData); err != nil {
        return nil, fmt.Errorf("解析配置数据失败: %w", err)
    }
    
    return configData, nil
}
```

### 4. 实现UpdateConfig方法

实现更新配置的方法：

```go
// UpdateConfig 更新配置
func (s *configService) UpdateConfig(ctx context.Context, configType string, data interface{}) error {
    // 序列化配置数据
    configData, err := json.Marshal(data)
    if err != nil {
        return fmt.Errorf("序列化配置数据失败: %w", err)
    }
    
    // 检查配置是否存在
    existingConfig, err := s.repo.GetByType(ctx, configType)
    if err != nil {
        // 如果配置不存在，创建新配置
        newConfig := &model.SystemConfig{
            ConfigType: configType,
            ConfigData: datatypes.JSON(configData),
        }
        if err := s.repo.Create(ctx, newConfig); err != nil {
            return fmt.Errorf("创建配置失败: %w", err)
        }
        return nil
    }
    
    // 更新现有配置
    existingConfig.ConfigData = datatypes.JSON(configData)
    if err := s.repo.Update(ctx, existingConfig); err != nil {
        return fmt.Errorf("更新配置失败: %w", err)
    }
    
    return nil
}
```

### 5. 添加服务注释

为接口和方法添加注释：

```go
// ConfigService 配置服务接口
// 提供配置的读取和更新功能
type ConfigService interface {
    // GetConfig 获取指定类型的配置
    // 参数: configType - 配置类型
    // 返回: 配置数据的interface{}和错误
    GetConfig(ctx context.Context, configType string) (interface{}, error)
    
    // UpdateConfig 更新指定类型的配置
    // 参数: configType - 配置类型, data - 配置数据
    // 如果配置不存在，将创建新配置；如果存在，将更新现有配置
    UpdateConfig(ctx context.Context, configType string, data interface{}) error
}
```

## 验收标准

1. **ConfigService接口正确定义**
   - 接口包含所有必需的方法：GetConfig、UpdateConfig
   - 方法签名正确，参数和返回值类型明确
   - 接口注释完整，使用中文

2. **configService实现完整**
   - 所有接口方法都已实现
   - 实现逻辑正确，处理了错误情况
   - 错误消息使用中文，清晰明确

3. **业务逻辑处理正确**
   - GetConfig方法正确从仓储层获取配置并解析数据
   - UpdateConfig方法正确处理配置的创建和更新
   - 正确使用context传递上下文

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/service/config_service.go` - 配置服务层实现
- `internal/pkg/repository/config_repository.go` - 配置仓储层实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 13:31:24 CST
