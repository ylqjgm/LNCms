# TASK003-27: 实现获取存储渠道列表API（GET）

## 任务信息

**任务编号**: TASK003-27  
**父任务**: TASK003  
**任务名称**: 实现获取存储渠道列表API（GET）  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 13:40:54 CST

## 任务描述

实现获取存储渠道列表API接口。包括：1) 实现 GET /api/v1/system/config/storage/channels 端点；2) 实现分页支持；3) 实现请求处理和响应构建；4) 遵循OpenAPI 3.1.1规范和Envelope响应格式。所有错误消息必须使用中文。

## 依赖任务

- TASK003-09: 实现系统配置热更新机制

## 实现指南

### 1. 定义响应结构体

在 `internal/api/v1/dto/config_dto.go` 文件中定义存储渠道响应结构体：

```go
package dto

// StorageChannelResponse 存储渠道响应
type StorageChannelResponse struct {
    ChannelID     int                    `json:"channel_id"`     // 渠道ID（索引）
    ChannelName   string                 `json:"channel_name"`   // 渠道名称
    StorageType   string                 `json:"storage_type"`   // 存储类型：local、storage_module、cloud
    StorageConfig map[string]interface{} `json:"storage_config"` // 服务器配置
}

// StorageChannelListResponse 存储渠道列表响应（用于分页）
type StorageChannelListResponse struct {
    Items []StorageChannelResponse `json:"items"`
}
```

### 2. 实现GetStorageChannels方法

在ConfigHandler中实现GetStorageChannels方法：

```go
// GetStorageChannels 获取存储渠道列表
// @Summary 获取存储渠道列表
// @Description 获取附件存储渠道列表，支持分页
// @Tags 系统配置
// @Accept json
// @Produce json
// @Param page query int false "页码" default(1)
// @Param limit query int false "每页数量" default(20)
// @Success 200 {object} response.Envelope{data=dto.StorageChannelListResponse} "成功响应"
// @Failure 500 {object} response.Envelope "服务器错误"
// @Router /api/v1/system/config/storage/channels [get]
func (h *ConfigHandler) GetStorageChannels(c *gin.Context) {
    ctx := c.Request.Context()
    
    // 获取分页参数
    page, limit := getPaginationParams(c)
    
    // 从服务层获取配置
    configData, err := h.configService.GetConfig(ctx, string(model.ConfigTypeAttachment))
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_GET_FAILED", "获取附件设置失败", err)
        return
    }
    
    // 解析配置数据
    configMap, ok := configData.(map[string]interface{})
    if !ok {
        response.Error(c, http.StatusInternalServerError, "CONFIG_PARSE_FAILED", "解析附件设置失败", nil)
        return
    }
    
    // 获取存储渠道列表
    channels, ok := configMap["storage_channels"].([]interface{})
    if !ok {
        channels = []interface{}{}
    }
    
    // 转换为响应结构体
    allChannels := make([]dto.StorageChannelResponse, 0, len(channels))
    for i, channelInterface := range channels {
        channelMap, ok := channelInterface.(map[string]interface{})
        if !ok {
            continue
        }
        
        channel := dto.StorageChannelResponse{
            ChannelID: i,
        }
        if v, ok := channelMap["channel_name"].(string); ok {
            channel.ChannelName = v
        }
        if v, ok := channelMap["storage_type"].(string); ok {
            channel.StorageType = v
        }
        if v, ok := channelMap["storage_config"].(map[string]interface{}); ok {
            channel.StorageConfig = v
        }
        allChannels = append(allChannels, channel)
    }
    
    // 分页处理
    total := len(allChannels)
    start := (page - 1) * limit
    end := start + limit
    if start > total {
        start = total
    }
    if end > total {
        end = total
    }
    
    paginatedChannels := allChannels[start:end]
    
    // 构建响应
    listResponse := dto.StorageChannelListResponse{
        Items: paginatedChannels,
    }
    
    // 返回分页响应
    response.Paginated(c, listResponse.Items, page, limit, total)
}
```

### 3. 注册路由

在 `internal/api/v1/router/router.go` 文件中注册路由：

```go
// RegisterConfigRoutes 注册配置相关路由
func RegisterConfigRoutes(r *gin.RouterGroup, configHandler *handler.ConfigHandler) {
    config := r.Group("/system/config")
    {
        // ... 其他路由 ...
        storage := config.Group("/storage")
        {
            channels := storage.Group("/channels")
            {
                channels.GET("", configHandler.GetStorageChannels) // 添加GET路由
            }
        }
    }
}
```

## 验收标准

1. **API端点正确实现**
   - GET /api/v1/system/config/storage/channels 端点正确实现
   - 路由正确注册

2. **分页功能正确实现**
   - 分页参数正确解析（page、limit）
   - 分页逻辑正确
   - 分页响应格式符合Envelope格式（包含pagination和links）

3. **响应格式符合要求**
   - 响应使用Envelope格式
   - meta字段包含success、code、message、timestamp、request_id、pagination
   - data字段包含StorageChannelListResponse结构体
   - links字段包含分页链接信息
   - errors字段为空数组

4. **错误处理正确**
   - 配置获取失败时返回适当的错误响应
   - 数据解析失败时返回适当的错误响应
   - 所有错误消息使用中文

5. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/api/v1/handler/config_handler.go` - 配置处理器实现
- `internal/api/v1/dto/config_dto.go` - 配置DTO定义
- `internal/api/v1/router/router.go` - 路由注册
- `internal/pkg/service/config_service.go` - 配置服务层实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/api.mdc` - API设计规范
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 13:40:54 CST

