# TASK003-06: 实现配置验证器

## 任务信息

**任务编号**: TASK003-06  
**父任务**: TASK003  
**任务名称**: 实现配置验证器  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 13:31:24 CST

## 任务描述

实现配置验证器，为每种配置类型提供验证规则。包括：1) 定义配置验证器接口；2) 为每种配置类型实现验证规则；3) 实现验证逻辑。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK003-03: 实现配置类型枚举和常量定义

## 实现指南

### 1. 定义ConfigValidator接口

在 `internal/pkg/validator/config_validator.go` 文件中定义接口：

```go
package validator

// ConfigValidator 配置验证器接口
type ConfigValidator interface {
    // Validate 验证配置数据
    Validate(configType string, data interface{}) error
}
```

### 2. 实现configValidator结构体

在同一个文件中实现配置验证器：

```go
import (
    "fmt"
    "yourproject/internal/pkg/model"
)

// configValidator 配置验证器实现
type configValidator struct {
    validators map[string]func(interface{}) error
}

// NewConfigValidator 创建配置验证器实例
func NewConfigValidator() ConfigValidator {
    cv := &configValidator{
        validators: make(map[string]func(interface{}) error),
    }
    cv.registerValidators()
    return cv
}

// registerValidators 注册所有配置类型的验证器
func (cv *configValidator) registerValidators() {
    cv.validators[string(model.ConfigTypeSite)] = cv.validateSiteConfig
    cv.validators[string(model.ConfigTypeRegister)] = cv.validateRegisterConfig
    cv.validators[string(model.ConfigTypeCluster)] = cv.validateClusterConfig
    cv.validators[string(model.ConfigTypePoints)] = cv.validatePointsConfig
    cv.validators[string(model.ConfigTypeEmail)] = cv.validateEmailConfig
    cv.validators[string(model.ConfigTypeShield)] = cv.validateShieldConfig
    // 其他配置类型的验证器...
}
```

### 3. 实现Validate方法

实现通用的验证方法：

```go
// Validate 验证配置数据
func (cv *configValidator) Validate(configType string, data interface{}) error {
    if data == nil {
        return fmt.Errorf("配置数据不能为空")
    }
    
    validator, exists := cv.validators[configType]
    if !exists {
        return fmt.Errorf("不支持的配置类型: %s", configType)
    }
    
    return validator(data)
}
```

### 4. 实现各配置类型的验证方法

实现每种配置类型的验证逻辑（示例：网站配置验证）：

```go
// validateSiteConfig 验证网站配置
func (cv *configValidator) validateSiteConfig(data interface{}) error {
    config, ok := data.(map[string]interface{})
    if !ok {
        return fmt.Errorf("网站配置数据格式错误")
    }
    
    // 验证网站名称
    siteName, ok := config["site_name"].(string)
    if !ok || len(siteName) == 0 {
        return fmt.Errorf("网站名称不能为空")
    }
    if len(siteName) > 100 {
        return fmt.Errorf("网站名称长度不能超过100个字符")
    }
    
    // 验证网站地址
    siteURL, ok := config["site_url"].(string)
    if !ok || len(siteURL) == 0 {
        return fmt.Errorf("网站地址不能为空")
    }
    // URL格式验证可以通过正则表达式或使用net/url包
    
    // 验证网站关键字
    if keywords, ok := config["site_keywords"].(string); ok {
        if len(keywords) > 500 {
            return fmt.Errorf("网站关键字长度不能超过500个字符")
        }
    }
    
    // 验证网站描述
    if description, ok := config["site_description"].(string); ok {
        if len(description) > 1000 {
            return fmt.Errorf("网站描述长度不能超过1000个字符")
        }
    }
    
    // 验证网站开关和关闭提示
    siteEnabled, ok := config["site_enabled"].(bool)
    if ok && !siteEnabled {
        closedMessage, ok := config["site_closed_message"].(string)
        if !ok || len(closedMessage) == 0 {
            return fmt.Errorf("网站关闭时，关闭提示不能为空")
        }
        if len(closedMessage) > 1000 {
            return fmt.Errorf("关闭提示长度不能超过1000个字符")
        }
    }
    
    return nil
}
```

### 5. 实现其他配置类型的验证方法

为其他配置类型实现验证方法（注册配置、站群配置、积分配置、邮箱配置、屏蔽配置等），验证规则应参考需求文档中的定义。

## 验收标准

1. **ConfigValidator接口正确定义**
   - 接口包含Validate方法
   - 方法签名正确，参数和返回值类型明确
   - 接口注释完整，使用中文

2. **配置验证器实现完整**
   - 所有配置类型的验证器都已注册
   - 每种配置类型都有对应的验证方法
   - 验证逻辑正确，覆盖所有验证规则

3. **验证规则完整**
   - 所有配置项的验证规则都已实现
   - 验证错误消息清晰，使用中文
   - 验证逻辑符合需求文档要求

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/validator/config_validator.go` - 配置验证器实现
- `internal/pkg/model/config_type.go` - 配置类型枚举定义
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 13:31:24 CST
