# TASK003-06: 模块管理核心服务实现

## 任务信息

**任务编号**: TASK003-06  
**父任务**: TASK003  
**任务名称**: 模块管理核心服务实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:30:48 CST

## 任务描述

实现模块管理的核心业务逻辑。包括：1) 创建ModuleService接口和实现，提供模块注册、启用、禁用、健康检查功能；2) 实现模块状态管理，支持状态转换和验证；3) 实现gRPC健康检查机制，使用grpc_health_v1.HealthClient检查模块健康状态；4) 实现定时健康检查任务（使用goroutine）；5) 实现健康检查重试和超时机制；6) 编写单元测试验证服务层功能。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK003-05: 模块管理数据库模型和仓储层实现

## 实现指南

### 1. 创建ModuleService接口

在 `internal/pkg/service/module_service.go` 文件中定义接口和实现：

```go
package service

import (
    "context"
    "yourproject/internal/pkg/model"
)

// ModuleService 模块服务接口
type ModuleService interface {
    // RegisterModule 注册模块
    RegisterModule(ctx context.Context, module *model.Module) error
    
    // EnableModule 启用模块
    EnableModule(ctx context.Context, moduleID string) error
    
    // DisableModule 禁用模块
    DisableModule(ctx context.Context, moduleID string) error
    
    // CheckModuleHealth 检查模块健康状态
    CheckModuleHealth(ctx context.Context, moduleID string) (*HealthStatus, error)
    
    // ListModules 获取模块列表
    ListModules(ctx context.Context, page, limit int) ([]*model.Module, int64, error)
}

// moduleService 模块服务实现
type moduleService struct {
    repo          repository.ModuleRepository
    healthChecker health.HealthChecker
}

// NewModuleService 创建模块服务实例
func NewModuleService(repo repository.ModuleRepository, healthChecker health.HealthChecker) ModuleService {
    return &moduleService{
        repo:          repo,
        healthChecker: healthChecker,
    }
}
```

### 2. 实现健康检查器

在 `internal/pkg/health/health_checker.go` 文件中实现：

```go
package health

import (
    "context"
    "time"
    "google.golang.org/grpc"
    "google.golang.org/grpc/health/grpc_health_v1"
)

// HealthChecker 健康检查器接口
type HealthChecker interface {
    Check(ctx context.Context, moduleURL string) (*HealthStatus, error)
}

// gRPCHealthChecker gRPC健康检查器实现
type gRPCHealthChecker struct {
    timeout time.Duration
    retries int
}

// Check 实现接口方法
func (c *gRPCHealthChecker) Check(ctx context.Context, moduleURL string) (*HealthStatus, error) {
    // 1. 建立gRPC连接
    conn, err := grpc.DialContext(ctx, moduleURL, grpc.WithInsecure())
    if err != nil {
        return nil, fmt.Errorf("连接模块失败: %w", err)
    }
    defer conn.Close()
    
    // 2. 创建健康检查客户端
    client := grpc_health_v1.NewHealthClient(conn)
    
    // 3. 执行健康检查（带超时）
    checkCtx, cancel := context.WithTimeout(ctx, c.timeout)
    defer cancel()
    
    resp, err := client.Check(checkCtx, &grpc_health_v1.HealthCheckRequest{})
    if err != nil {
        return nil, fmt.Errorf("健康检查失败: %w", err)
    }
    
    // 4. 返回健康状态
    return &HealthStatus{
        Status: resp.Status.String(),
        Time:   time.Now(),
    }, nil
}
```

### 3. 实现定时健康检查

在 `internal/pkg/service/module_service.go` 中实现定时任务：

```go
// StartHealthCheckTask 启动定时健康检查任务
func (s *moduleService) StartHealthCheckTask(ctx context.Context, interval time.Duration) {
    ticker := time.NewTicker(interval)
    defer ticker.Stop()
    
    for {
        select {
        case <-ctx.Done():
            return
        case <-ticker.C:
            s.checkAllActiveModules(ctx)
        }
    }
}

// checkAllActiveModules 检查所有活跃模块
func (s *moduleService) checkAllActiveModules(ctx context.Context) {
    modules, _, err := s.repo.List(ctx, 1, 1000)
    if err != nil {
        log.Printf("获取模块列表失败: %v", err)
        return
    }
    
    for _, module := range modules {
        if module.ModuleStatus == model.ModuleStatusActive {
            go s.checkModuleHealthAsync(ctx, module)
        }
    }
}
```

## 验收标准

1. ModuleService接口完整实现，支持所有模块管理功能
2. 健康检查机制正确实现，支持gRPC健康检查
3. 定时健康检查任务正确实现，能够定期检查模块状态
4. 状态管理正确实现，支持状态转换和验证
5. 单元测试通过，使用mock模拟gRPC客户端
6. 代码覆盖率达到80%以上
7. 错误处理完善，错误消息使用中文

## 相关文件

- `internal/pkg/service/module_service.go` - 模块服务实现
- `internal/pkg/health/health_checker.go` - 健康检查器实现
- `internal/pkg/service/module_service_test.go` - 模块服务单元测试
- `docs/Requirements/Core.md` - 核心模块需求文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:30:48 CST

