# TASK003-14: 实现获取注册设置API（GET）

## 任务信息

**任务编号**: TASK003-14  
**父任务**: TASK003  
**任务名称**: 实现获取注册设置API（GET）  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 13:40:54 CST

## 任务描述

实现获取注册设置API接口。包括：1) 实现 GET /api/v1/system/config/register 端点；2) 实现请求处理和响应构建；3) 遵循OpenAPI 3.1.1规范和Envelope响应格式。所有错误消息必须使用中文。

## 依赖任务

- TASK003-09: 实现系统配置热更新机制

## 实现指南

### 1. 定义响应结构体

在 `internal/api/v1/dto/config_dto.go` 文件中定义注册设置响应结构体：

```go
package dto

// PasswordRequirements 用户密码要求
type PasswordRequirements struct {
    MinLength       int  `json:"min_length"`        // 最小长度，默认8，范围6-128
    MaxLength       int  `json:"max_length"`        // 最大长度，默认128，范围8-128
    RequireUppercase bool `json:"require_uppercase"` // 必须包含大写字母，默认false
    RequireLowercase bool `json:"require_lowercase"` // 必须包含小写字母，默认false
    RequireNumber    bool `json:"require_number"`    // 必须包含数字，默认false
    RequireSpecial   bool `json:"require_special"`   // 必须包含特殊字符，默认false
}

// RegisterConfigResponse 注册设置响应
type RegisterConfigResponse struct {
    RegisterEnabled      bool                `json:"register_enabled"`       // 注册开关
    CaptchaEnabled       bool                `json:"captcha_enabled"`        // 验证码开关
    PasswordRequirements PasswordRequirements `json:"password_requirements"` // 用户密码要求
    DuplicateRegister    string              `json:"duplicate_register"`     // 重复注册设置：allow、deny、require_approval
}
```

### 2. 实现GetRegisterConfig方法

在ConfigHandler中实现GetRegisterConfig方法：

```go
// GetRegisterConfig 获取注册设置
// @Summary 获取注册设置
// @Description 获取用户注册信息配置
// @Tags 系统配置
// @Accept json
// @Produce json
// @Success 200 {object} response.Envelope{data=dto.RegisterConfigResponse} "成功响应"
// @Failure 500 {object} response.Envelope "服务器错误"
// @Router /api/v1/system/config/register [get]
func (h *ConfigHandler) GetRegisterConfig(c *gin.Context) {
    ctx := c.Request.Context()
    
    // 从服务层获取配置
    configData, err := h.configService.GetConfig(ctx, string(model.ConfigTypeRegister))
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_GET_FAILED", "获取注册设置失败", err)
        return
    }
    
    // 将配置数据转换为响应结构体
    var registerConfig dto.RegisterConfigResponse
    if err := mapToRegisterConfig(configData, &registerConfig); err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_PARSE_FAILED", "解析注册设置失败", err)
        return
    }
    
    // 返回成功响应
    response.Success(c, registerConfig)
}

// mapToRegisterConfig 将配置数据映射到RegisterConfigResponse
func mapToRegisterConfig(data interface{}, registerConfig *dto.RegisterConfigResponse) error {
    configMap, ok := data.(map[string]interface{})
    if !ok {
        return fmt.Errorf("配置数据格式错误")
    }
    
    // 映射基本字段
    if v, ok := configMap["register_enabled"].(bool); ok {
        registerConfig.RegisterEnabled = v
    }
    if v, ok := configMap["captcha_enabled"].(bool); ok {
        registerConfig.CaptchaEnabled = v
    }
    if v, ok := configMap["duplicate_register"].(string); ok {
        registerConfig.DuplicateRegister = v
    }
    
    // 映射密码要求
    if passwordReq, ok := configMap["password_requirements"].(map[string]interface{}); ok {
        if v, ok := passwordReq["min_length"].(float64); ok {
            registerConfig.PasswordRequirements.MinLength = int(v)
        }
        if v, ok := passwordReq["max_length"].(float64); ok {
            registerConfig.PasswordRequirements.MaxLength = int(v)
        }
        if v, ok := passwordReq["require_uppercase"].(bool); ok {
            registerConfig.PasswordRequirements.RequireUppercase = v
        }
        if v, ok := passwordReq["require_lowercase"].(bool); ok {
            registerConfig.PasswordRequirements.RequireLowercase = v
        }
        if v, ok := passwordReq["require_number"].(bool); ok {
            registerConfig.PasswordRequirements.RequireNumber = v
        }
        if v, ok := passwordReq["require_special"].(bool); ok {
            registerConfig.PasswordRequirements.RequireSpecial = v
        }
    }
    
    return nil
}
```

### 3. 注册路由

在 `internal/api/v1/router/router.go` 文件中注册路由：

```go
// RegisterConfigRoutes 注册配置相关路由
func RegisterConfigRoutes(r *gin.RouterGroup, configHandler *handler.ConfigHandler) {
    config := r.Group("/system/config")
    {
        config.GET("/site", configHandler.GetSiteConfig)
        config.PUT("/site", configHandler.UpdateSiteConfig)
        config.GET("/register", configHandler.GetRegisterConfig) // 添加注册设置GET路由
    }
}
```

## 验收标准

1. **API端点正确实现**
   - GET /api/v1/system/config/register 端点正确实现
   - 路由正确注册

2. **响应格式符合要求**
   - 响应使用Envelope格式
   - meta字段包含success、code、message、timestamp、request_id
   - data字段包含RegisterConfigResponse结构体
   - errors字段为空数组

3. **错误处理正确**
   - 配置获取失败时返回适当的错误响应
   - 数据解析失败时返回适当的错误响应
   - 所有错误消息使用中文

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/api/v1/handler/config_handler.go` - 配置处理器实现
- `internal/api/v1/dto/config_dto.go` - 配置DTO定义
- `internal/api/v1/router/router.go` - 路由注册
- `internal/pkg/service/config_service.go` - 配置服务层实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/api.mdc` - API设计规范
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 13:40:54 CST
