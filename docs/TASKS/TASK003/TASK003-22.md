# TASK003-22: 实现删除站群节点API（DELETE）

## 任务信息

**任务编号**: TASK003-22  
**父任务**: TASK003  
**任务名称**: 实现删除站群节点API（DELETE）  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 13:40:54 CST

## 任务描述

实现删除站群节点API接口。包括：1) 实现 DELETE /api/v1/system/config/cluster/nodes/{node_id} 端点；2) 实现请求参数验证和权限验证（需要管理员权限）；3) 实现业务逻辑处理和响应构建；4) 遵循OpenAPI 3.1.1规范和Envelope响应格式。所有错误消息必须使用中文。

## 依赖任务

- TASK003-20: 实现添加站群节点API（POST）

## 实现指南

### 1. 实现DeleteClusterNode方法

在ConfigHandler中实现DeleteClusterNode方法：

```go
// DeleteClusterNode 删除站群节点
// @Summary 删除站群节点
// @Description 删除集群节点，需要管理员权限
// @Tags 系统配置
// @Accept json
// @Produce json
// @Param node_id path string true "节点标识"
// @Success 200 {object} response.Envelope "成功响应"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 401 {object} response.Envelope "未授权"
// @Failure 403 {object} response.Envelope "权限不足"
// @Failure 404 {object} response.Envelope "节点不存在"
// @Failure 500 {object} response.Envelope "服务器错误"
// @Router /api/v1/system/config/cluster/nodes/{node_id} [delete]
// @Security BearerAuth
func (h *ConfigHandler) DeleteClusterNode(c *gin.Context) {
    ctx := c.Request.Context()
    
    // 权限验证（需要管理员权限）
    // 注意：权限验证逻辑应该在中间件中实现
    
    // 获取路径参数
    nodeID := c.Param("node_id")
    if nodeID == "" {
        response.Error(c, http.StatusBadRequest, "INVALID_REQUEST", "节点标识不能为空", nil)
        return
    }
    
    // 获取当前站群配置
    configData, err := h.configService.GetConfig(ctx, string(model.ConfigTypeCluster))
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_GET_FAILED", "获取站群设置失败", err)
        return
    }
    
    // 解析当前配置
    configMap, ok := configData.(map[string]interface{})
    if !ok {
        response.Error(c, http.StatusInternalServerError, "CONFIG_PARSE_FAILED", "解析站群设置失败", nil)
        return
    }
    
    // 获取集群节点列表
    clusterNodes, ok := configMap["cluster_nodes"].([]interface{})
    if !ok {
        response.Error(c, http.StatusNotFound, "NODE_NOT_FOUND", fmt.Sprintf("节点 %s 不存在", nodeID), nil)
        return
    }
    
    // 查找并删除节点
    nodeFound := false
    newClusterNodes := make([]interface{}, 0, len(clusterNodes))
    for _, nodeInterface := range clusterNodes {
        nodeMap, ok := nodeInterface.(map[string]interface{})
        if !ok {
            continue
        }
        
        if existingNodeID, ok := nodeMap["node_id"].(string); ok && existingNodeID == nodeID {
            nodeFound = true
            continue // 跳过该节点，不添加到新列表
        }
        newClusterNodes = append(newClusterNodes, nodeMap)
    }
    
    if !nodeFound {
        response.Error(c, http.StatusNotFound, "NODE_NOT_FOUND", fmt.Sprintf("节点 %s 不存在", nodeID), nil)
        return
    }
    
    // 更新配置
    configMap["cluster_nodes"] = newClusterNodes
    if err := h.configService.UpdateConfig(ctx, string(model.ConfigTypeCluster), configMap); err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_UPDATE_FAILED", "删除站群节点失败", err)
        return
    }
    
    // 返回成功响应（204 No Content或200 OK）
    response.Success(c, nil)
}
```

### 2. 注册路由

在 `internal/api/v1/router/router.go` 文件中注册路由：

```go
// RegisterConfigRoutes 注册配置相关路由
func RegisterConfigRoutes(r *gin.RouterGroup, configHandler *handler.ConfigHandler) {
    config := r.Group("/system/config")
    {
        config.GET("/site", configHandler.GetSiteConfig)
        config.PUT("/site", configHandler.UpdateSiteConfig)
        config.GET("/register", configHandler.GetRegisterConfig)
        config.PUT("/register", configHandler.UpdateRegisterConfig)
        config.GET("/cluster", configHandler.GetClusterConfig)
        config.PUT("/cluster", configHandler.UpdateClusterConfig)
        clusterNodes := config.Group("/cluster/nodes")
        {
            clusterNodes.POST("", configHandler.AddClusterNode)
            clusterNodes.PUT("/:node_id", configHandler.UpdateClusterNode)
            clusterNodes.DELETE("/:node_id", configHandler.DeleteClusterNode) // 添加DELETE路由
        }
    }
}
```

### 3. 处理删除响应

根据API设计规范，DELETE操作可以返回204 No Content或200 OK。这里使用Envelope格式返回200 OK：

```go
// DeleteClusterNode 删除站群节点
func (h *ConfigHandler) DeleteClusterNode(c *gin.Context) {
    // ... 删除逻辑 ...
    
    // 返回成功响应
    // 方式1：返回200 OK with Envelope（推荐，保持一致性）
    response.Success(c, nil)
    
    // 方式2：返回204 No Content（如果API规范要求）
    // c.Status(http.StatusNoContent)
}
```

## 验收标准

1. **API端点正确实现**
   - DELETE /api/v1/system/config/cluster/nodes/{node_id} 端点正确实现
   - 路由正确注册，路径参数正确绑定
   - 权限验证中间件正确配置

2. **请求参数验证正确**
   - 路径参数验证正确
   - 节点不存在时返回404错误

3. **权限验证正确**
   - 非管理员用户访问时返回403错误
   - 权限验证错误消息使用中文

4. **业务逻辑正确**
   - 节点查找逻辑正确
   - 节点删除逻辑正确（从数组中移除）
   - 配置更新逻辑正确

5. **响应格式符合要求**
   - 响应使用Envelope格式
   - 成功响应状态码正确
   - 错误响应包含适当的错误信息

6. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/api/v1/handler/config_handler.go` - 配置处理器实现
- `internal/api/v1/router/router.go` - 路由注册
- `internal/pkg/service/config_service.go` - 配置服务层实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/api.mdc` - API设计规范
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 13:40:54 CST
