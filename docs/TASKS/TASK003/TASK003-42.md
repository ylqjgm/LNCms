# TASK003-42: 实现更新邮箱设置API（PUT）

## 任务信息

**任务编号**: TASK003-42  
**父任务**: TASK003  
**任务名称**: 实现更新邮箱设置API（PUT）  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:06:02 CST

## 任务描述

实现更新邮箱设置API接口。包括：1) 实现 PUT /api/v1/system/config/email 端点；2) 实现请求参数验证和权限验证（需要管理员权限）；3) 实现业务逻辑处理和响应构建；4) 遵循OpenAPI 3.1.1规范和Envelope响应格式。所有错误消息必须使用中文。

**注意**：密码字段在更新时，如果为空字符串，则保持原密码不变；如果有值，则更新为新密码。密码应加密存储。

## 依赖任务

- TASK003-41: 实现获取邮箱设置API（GET）

## 实现指南

### 1. 定义请求结构体

在 `internal/api/v1/dto/config_dto.go` 文件中定义更新邮箱设置请求结构体：

```go
package dto

// UpdateEmailConfigRequest 更新邮箱设置请求
type UpdateEmailConfigRequest struct {
    SMTPHost   string `json:"smtp_host" binding:"required"`    // SMTP服务器，必填
    SMTPPort   int    `json:"smtp_port" binding:"required,min=1,max=65535"` // SMTP端口，必填，范围1-65535
    TLSEnabled bool   `json:"tls_enabled"`                     // TLS开关，可选
    Username   string `json:"username" binding:"required"`     // 登录用户名，必填
    Password   string `json:"password"`                        // 登录密码，可选（为空则不更新密码）
    FromEmail  string `json:"from_email" binding:"required,email"` // 发件人邮箱，必填，邮箱格式
}
```

### 2. 实现UpdateEmailConfig方法

在ConfigHandler中实现UpdateEmailConfig方法：

```go
// UpdateEmailConfig 更新邮箱设置
// @Summary 更新邮箱设置
// @Description 更新邮箱信息配置，需要管理员权限。密码字段为空则不更新，有值则更新。密码应加密存储。
// @Tags 系统配置
// @Accept json
// @Produce json
// @Param request body dto.UpdateEmailConfigRequest true "更新邮箱设置请求"
// @Success 200 {object} response.Envelope{data=dto.EmailConfigResponse} "成功响应"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 401 {object} response.Envelope "未授权"
// @Failure 403 {object} response.Envelope "权限不足"
// @Failure 500 {object} response.Envelope "服务器错误"
// @Router /api/v1/system/config/email [put]
// @Security BearerAuth
func (h *ConfigHandler) UpdateEmailConfig(c *gin.Context) {
    ctx := c.Request.Context()
    
    // 权限验证（需要管理员权限）
    // 注意：权限验证逻辑应该在中间件中实现
    
    // 绑定请求参数
    var req dto.UpdateEmailConfigRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_REQUEST", "请求参数错误", err)
        return
    }
    
    // 业务验证：SMTP端口范围
    if req.SMTPPort < 1 || req.SMTPPort > 65535 {
        response.Error(c, http.StatusBadRequest, "VALIDATION_ERROR", "SMTP端口必须在1-65535之间", nil)
        return
    }
    
    // 获取当前邮箱配置
    configData, err := h.configService.GetConfig(ctx, string(model.ConfigTypeEmail))
    if err != nil {
        // 如果配置不存在，创建新配置
        configData = map[string]interface{}{}
    }
    
    // 解析当前配置
    configMap, ok := configData.(map[string]interface{})
    if !ok {
        configMap = make(map[string]interface{})
    }
    
    // 构建配置数据
    emailConfigData := map[string]interface{}{
        "smtp_host":   req.SMTPHost,
        "smtp_port":   req.SMTPPort,
        "tls_enabled": req.TLSEnabled,
        "username":    req.Username,
        "from_email":  req.FromEmail,
    }
    
    // 处理密码字段：如果请求中的密码不为空，则更新密码（应该加密存储）
    if req.Password != "" {
        // 注意：密码应该加密后存储，这里仅作示例
        // 实际实现中应该使用加密算法（如bcrypt）对密码进行加密
        // encryptedPassword, err := encryptPassword(req.Password)
        // if err != nil {
        //     response.Error(c, http.StatusInternalServerError, "PASSWORD_ENCRYPT_FAILED", "密码加密失败", err)
        //     return
        // }
        emailConfigData["password"] = req.Password // 实际应该存储加密后的密码
    } else {
        // 如果密码为空，保持原密码不变
        if existingPassword, ok := configMap["password"].(string); ok && existingPassword != "" {
            emailConfigData["password"] = existingPassword
        }
    }
    
    // 更新配置
    if err := h.configService.UpdateConfig(ctx, string(model.ConfigTypeEmail), emailConfigData); err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_UPDATE_FAILED", "更新邮箱设置失败", err)
        return
    }
    
    // 获取更新后的配置并返回
    updatedData, err := h.configService.GetConfig(ctx, string(model.ConfigTypeEmail))
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_GET_FAILED", "获取更新后的邮箱设置失败", err)
        return
    }
    
    var emailConfig dto.EmailConfigResponse
    if err := mapToEmailConfig(updatedData, &emailConfig); err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_PARSE_FAILED", "解析邮箱设置失败", err)
        return
    }
    
    // 出于安全考虑，密码字段不返回明文
    if emailConfig.Password != "" {
        emailConfig.Password = "***"
    }
    
    // 返回成功响应
    response.Success(c, emailConfig)
}
```

### 3. 注册路由

在 `internal/api/v1/router/router.go` 文件中注册路由：

```go
// RegisterConfigRoutes 注册配置相关路由
func RegisterConfigRoutes(r *gin.RouterGroup, configHandler *handler.ConfigHandler) {
    config := r.Group("/system/config")
    {
        // ... 其他路由 ...
        config.GET("/email", configHandler.GetEmailConfig)
        config.PUT("/email", configHandler.UpdateEmailConfig) // 添加PUT路由
    }
}
```

## 验收标准

1. **API端点正确实现**
   - PUT /api/v1/system/config/email 端点正确实现
   - 路由正确注册
   - 权限验证中间件正确配置

2. **请求参数验证正确**
   - 请求参数绑定验证正确
   - 业务规则验证正确（SMTP端口范围、邮箱格式等）
   - 验证失败时返回适当的错误响应

3. **密码处理正确**
   - 密码为空时不更新密码
   - 密码有值时更新密码（应加密存储）
   - 响应中不返回密码明文

4. **权限验证正确**
   - 非管理员用户访问时返回403错误
   - 权限验证错误消息使用中文

5. **响应格式符合要求**
   - 响应使用Envelope格式
   - 成功响应包含更新后的配置数据（密码字段不返回明文）
   - 错误响应包含适当的错误信息

6. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/api/v1/handler/config_handler.go` - 配置处理器实现
- `internal/api/v1/dto/config_dto.go` - 配置DTO定义
- `internal/api/v1/router/router.go` - 路由注册
- `internal/pkg/service/config_service.go` - 配置服务层实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/api.mdc` - API设计规范
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:06:02 CST

