# TASK003-50: 实现ModuleRepository接口

## 任务信息

**任务编号**: TASK003-50  
**父任务**: TASK003  
**任务名称**: 实现ModuleRepository接口  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:06:02 CST

## 任务描述

实现ModuleRepository接口，提供模块的CRUD操作。包括：1) 定义ModuleRepository接口；2) 实现模块的创建、查询、更新、删除方法（Create、GetByID、GetByModuleID、List、Update、Delete）；3) 实现数据库操作逻辑。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK003-49: 创建Module模型

## 实现指南

### 1. 定义ModuleRepository接口

在 `internal/pkg/repository/module_repository.go` 文件中定义ModuleRepository接口：

```go
package repository

import (
    "context"
    "yourproject/internal/pkg/model"
)

// ModuleRepository 模块仓储接口
type ModuleRepository interface {
    // Create 创建模块
    Create(ctx context.Context, module *model.Module) error
    
    // GetByID 根据ID获取模块
    GetByID(ctx context.Context, id int64) (*model.Module, error)
    
    // GetByModuleID 根据模块ID获取模块
    GetByModuleID(ctx context.Context, moduleID string) (*model.Module, error)
    
    // List 获取模块列表（支持分页）
    List(ctx context.Context, page, limit int, moduleType, moduleStatus string) ([]*model.Module, int64, error)
    
    // Update 更新模块
    Update(ctx context.Context, module *model.Module) error
    
    // Delete 删除模块
    Delete(ctx context.Context, id int64) error
}
```

### 2. 实现moduleRepository结构体

实现ModuleRepository接口：

```go
package repository

import (
    "context"
    "fmt"
    
    "gorm.io/gorm"
    "yourproject/internal/pkg/model"
)

// moduleRepository 模块仓储实现
type moduleRepository struct {
    db *gorm.DB
}

// NewModuleRepository 创建模块仓储实例
func NewModuleRepository(db *gorm.DB) ModuleRepository {
    return &moduleRepository{db: db}
}

// Create 创建模块
func (r *moduleRepository) Create(ctx context.Context, module *model.Module) error {
    if err := r.db.WithContext(ctx).Create(module).Error; err != nil {
        return fmt.Errorf("创建模块失败: %w", err)
    }
    return nil
}

// GetByID 根据ID获取模块
func (r *moduleRepository) GetByID(ctx context.Context, id int64) (*model.Module, error) {
    var module model.Module
    if err := r.db.WithContext(ctx).Where("id = ?", id).First(&module).Error; err != nil {
        if err == gorm.ErrRecordNotFound {
            return nil, fmt.Errorf("模块不存在")
        }
        return nil, fmt.Errorf("查询模块失败: %w", err)
    }
    return &module, nil
}

// GetByModuleID 根据模块ID获取模块
func (r *moduleRepository) GetByModuleID(ctx context.Context, moduleID string) (*model.Module, error) {
    var module model.Module
    if err := r.db.WithContext(ctx).Where("module_id = ?", moduleID).First(&module).Error; err != nil {
        if err == gorm.ErrRecordNotFound {
            return nil, fmt.Errorf("模块不存在")
        }
        return nil, fmt.Errorf("查询模块失败: %w", err)
    }
    return &module, nil
}

// List 获取模块列表（支持分页）
func (r *moduleRepository) List(ctx context.Context, page, limit int, moduleType, moduleStatus string) ([]*model.Module, int64, error) {
    var modules []*model.Module
    var total int64
    
    query := r.db.WithContext(ctx).Model(&model.Module{})
    
    // 按模块类型筛选
    if moduleType != "" {
        query = query.Where("module_type = ?", moduleType)
    }
    
    // 按模块状态筛选
    if moduleStatus != "" {
        query = query.Where("module_status = ?", moduleStatus)
    }
    
    // 统计总数
    if err := query.Count(&total).Error; err != nil {
        return nil, 0, fmt.Errorf("统计模块数量失败: %w", err)
    }
    
    // 分页查询
    offset := (page - 1) * limit
    if err := query.Offset(offset).Limit(limit).Order("created_at DESC").Find(&modules).Error; err != nil {
        return nil, 0, fmt.Errorf("查询模块列表失败: %w", err)
    }
    
    return modules, total, nil
}

// Update 更新模块
func (r *moduleRepository) Update(ctx context.Context, module *model.Module) error {
    if err := r.db.WithContext(ctx).Save(module).Error; err != nil {
        return fmt.Errorf("更新模块失败: %w", err)
    }
    return nil
}

// Delete 删除模块
func (r *moduleRepository) Delete(ctx context.Context, id int64) error {
    result := r.db.WithContext(ctx).Delete(&model.Module{}, id)
    if result.Error != nil {
        return fmt.Errorf("删除模块失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("模块不存在")
    }
    return nil
}
```

### 3. 错误处理

所有错误消息必须使用中文，并使用错误包装保留错误链：

```go
// 好的做法：使用中文错误消息并保留错误链
if err != nil {
    return fmt.Errorf("创建模块失败: %w", err)
}

// 不好的做法：使用英文错误消息
if err != nil {
    return fmt.Errorf("failed to create module: %w", err)
}
```

## 验收标准

1. **接口定义正确**
   - ModuleRepository接口正确定义
   - 所有方法签名正确
   - 方法参数和返回值类型正确

2. **实现完整**
   - 所有接口方法都已实现
   - 数据库操作逻辑正确
   - 错误处理正确

3. **分页功能正确**
   - List方法支持分页参数
   - 分页逻辑正确（page、limit、offset）
   - 返回总记录数正确

4. **查询筛选功能正确**
   - 支持按模块类型筛选
   - 支持按模块状态筛选
   - 筛选逻辑正确

5. **错误处理正确**
   - 所有错误消息使用中文
   - 错误包装保留错误链
   - 处理记录不存在的情况

6. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/repository/module_repository.go` - ModuleRepository接口和实现
- `internal/pkg/model/module.go` - Module模型定义
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:06:02 CST

