# TASK003-54: 实现模块状态管理

## 任务信息

**任务编号**: TASK003-54  
**父任务**: TASK003  
**任务名称**: 实现模块状态管理  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:22:42 CST

## 任务描述

实现模块状态管理，支持状态转换和验证。包括：1) 定义状态转换规则；2) 实现状态转换验证逻辑；3) 实现状态管理方法。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK003-51: 实现模块类型和状态枚举定义

## 实现指南

### 1. 定义状态转换规则

在 `internal/pkg/service/module_state.go` 文件中定义状态转换规则：

```go
package service

import (
    "errors"
    "yourproject/internal/pkg/model"
)

// 状态转换规则映射
var stateTransitionRules = map[model.ModuleStatus][]model.ModuleStatus{
    model.ModuleStatusInactive: {model.ModuleStatusActive, model.ModuleStatusError},
    model.ModuleStatusActive:    {model.ModuleStatusInactive, model.ModuleStatusError},
    model.ModuleStatusError:     {model.ModuleStatusInactive, model.ModuleStatusActive},
}

// ValidateStateTransition 验证状态转换是否合法
func ValidateStateTransition(from, to model.ModuleStatus) error {
    if from == to {
        return nil // 相同状态，允许
    }
    
    allowedStates, exists := stateTransitionRules[from]
    if !exists {
        return errors.New("无效的源状态")
    }
    
    for _, allowedState := range allowedStates {
        if allowedState == to {
            return nil // 状态转换合法
        }
    }
    
    return errors.New("不允许的状态转换")
}
```

### 2. 实现状态转换方法

在 `internal/pkg/service/module_state.go` 文件中实现状态转换方法：

```go
// TransitionState 执行状态转换
func (s *moduleService) TransitionState(ctx context.Context, moduleID string, newStatus model.ModuleStatus) error {
    // 获取模块
    module, err := s.repo.GetByModuleID(ctx, moduleID)
    if err != nil {
        return fmt.Errorf("获取模块失败: %w", err)
    }
    
    // 获取当前状态
    currentStatus := model.ModuleStatus(module.ModuleStatus)
    
    // 验证状态转换
    if err := ValidateStateTransition(currentStatus, newStatus); err != nil {
        return fmt.Errorf("状态转换验证失败: %w", err)
    }
    
    // 更新状态
    module.ModuleStatus = string(newStatus)
    if err := s.repo.Update(ctx, module); err != nil {
        return fmt.Errorf("更新模块状态失败: %w", err)
    }
    
    return nil
}
```

### 3. 实现状态查询方法

在 `internal/pkg/service/module_state.go` 文件中实现状态查询方法：

```go
// GetModuleStatus 获取模块状态
func (s *moduleService) GetModuleStatus(ctx context.Context, moduleID string) (model.ModuleStatus, error) {
    module, err := s.repo.GetByModuleID(ctx, moduleID)
    if err != nil {
        return "", fmt.Errorf("获取模块失败: %w", err)
    }
    
    return model.ModuleStatus(module.ModuleStatus), nil
}
```

### 4. 实现状态验证方法

在 `internal/pkg/service/module_state.go` 文件中实现状态验证方法：

```go
// IsModuleActive 检查模块是否处于激活状态
func (s *moduleService) IsModuleActive(ctx context.Context, moduleID string) (bool, error) {
    status, err := s.GetModuleStatus(ctx, moduleID)
    if err != nil {
        return false, err
    }
    
    return status == model.ModuleStatusActive, nil
}

// IsModuleInactive 检查模块是否处于非激活状态
func (s *moduleService) IsModuleInactive(ctx context.Context, moduleID string) (bool, error) {
    status, err := s.GetModuleStatus(ctx, moduleID)
    if err != nil {
        return false, err
    }
    
    return status == model.ModuleStatusInactive, nil
}

// IsModuleError 检查模块是否处于错误状态
func (s *moduleService) IsModuleError(ctx context.Context, moduleID string) (bool, error) {
    status, err := s.GetModuleStatus(ctx, moduleID)
    if err != nil {
        return false, err
    }
    
    return status == model.ModuleStatusError, nil
}
```

## 验收标准

1. **状态转换规则正确定义**
   - 状态转换规则映射完整
   - 所有状态转换规则都符合业务逻辑
   - 状态转换验证逻辑正确

2. **状态管理方法完整**
   - TransitionState方法正确实现
   - GetModuleStatus方法正确实现
   - 状态查询方法正确实现

3. **错误处理正确**
   - 所有错误消息使用中文
   - 错误包装保留错误链
   - 处理无效状态转换

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/service/module_state.go` - 模块状态管理实现
- `internal/pkg/service/module_service.go` - ModuleService接口和实现
- `internal/pkg/model/module.go` - Module模型定义
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:22:42 CST

