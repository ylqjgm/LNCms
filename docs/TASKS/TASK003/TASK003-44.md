# TASK003-44: 实现邮箱配置测试API（POST）

## 任务信息

**任务编号**: TASK003-44  
**父任务**: TASK003  
**任务名称**: 实现邮箱配置测试API（POST）  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:06:02 CST

## 任务描述

实现邮箱配置测试API接口。包括：1) 实现 POST /api/v1/system/config/email/test 端点；2) 实现请求参数验证和权限验证（需要管理员权限）；3) 实现邮箱连接测试逻辑和响应构建；4) 遵循OpenAPI 3.1.1规范和Envelope响应格式。所有错误消息必须使用中文。

**注意**：邮箱配置测试功能用于验证邮箱配置是否正确，可以通过发送测试邮件或连接测试来验证。测试邮件应发送到指定的测试邮箱地址。

## 依赖任务

- TASK003-42: 实现更新邮箱设置API（PUT）

## 实现指南

### 1. 定义请求和响应结构体

在 `internal/api/v1/dto/config_dto.go` 文件中定义邮箱配置测试请求和响应结构体：

```go
package dto

// TestEmailConfigRequest 邮箱配置测试请求
type TestEmailConfigRequest struct {
    TestEmail string `json:"test_email" binding:"required,email"` // 测试邮箱地址，必填，邮箱格式
}

// TestEmailConfigResponse 邮箱配置测试响应
type TestEmailConfigResponse struct {
    Success bool   `json:"success"` // 测试是否成功
    Message string `json:"message"` // 测试结果消息
}
```

### 2. 实现TestEmailConfig方法

在ConfigHandler中实现TestEmailConfig方法：

```go
// TestEmailConfig 测试邮箱配置
// @Summary 测试邮箱配置
// @Description 测试邮箱配置是否正确，发送测试邮件到指定邮箱地址，需要管理员权限
// @Tags 系统配置
// @Accept json
// @Produce json
// @Param request body dto.TestEmailConfigRequest true "邮箱配置测试请求"
// @Success 200 {object} response.Envelope{data=dto.TestEmailConfigResponse} "成功响应"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 401 {object} response.Envelope "未授权"
// @Failure 403 {object} response.Envelope "权限不足"
// @Failure 500 {object} response.Envelope "服务器错误"
// @Router /api/v1/system/config/email/test [post]
// @Security BearerAuth
func (h *ConfigHandler) TestEmailConfig(c *gin.Context) {
    ctx := c.Request.Context()
    
    // 权限验证（需要管理员权限）
    // 注意：权限验证逻辑应该在中间件中实现
    
    // 绑定请求参数
    var req dto.TestEmailConfigRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_REQUEST", "请求参数错误", err)
        return
    }
    
    // 获取当前邮箱配置
    configData, err := h.configService.GetConfig(ctx, string(model.ConfigTypeEmail))
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "CONFIG_GET_FAILED", "获取邮箱设置失败", err)
        return
    }
    
    // 解析配置数据
    configMap, ok := configData.(map[string]interface{})
    if !ok {
        response.Error(c, http.StatusInternalServerError, "CONFIG_PARSE_FAILED", "解析邮箱设置失败", nil)
        return
    }
    
    // 提取邮箱配置信息
    smtpHost, _ := configMap["smtp_host"].(string)
    smtpPort, _ := configMap["smtp_port"].(float64)
    tlsEnabled, _ := configMap["tls_enabled"].(bool)
    username, _ := configMap["username"].(string)
    password, _ := configMap["password"].(string)
    fromEmail, _ := configMap["from_email"].(string)
    
    // 验证配置是否完整
    if smtpHost == "" || smtpPort == 0 || username == "" || password == "" || fromEmail == "" {
        response.Error(c, http.StatusBadRequest, "CONFIG_INCOMPLETE", "邮箱配置不完整，请先配置邮箱设置", nil)
        return
    }
    
    // 执行邮箱连接测试
    // 注意：实际实现中应该使用邮件发送库（如net/smtp或第三方库）进行连接测试
    // 这里仅作示例说明
    testSuccess, testMessage := testEmailConnection(
        smtpHost,
        int(smtpPort),
        tlsEnabled,
        username,
        password,
        fromEmail,
        req.TestEmail,
    )
    
    // 构建响应
    testResponse := dto.TestEmailConfigResponse{
        Success: testSuccess,
        Message: testMessage,
    }
    
    // 返回成功响应
    response.Success(c, testResponse)
}

// testEmailConnection 测试邮箱连接
// 注意：这是一个辅助函数，实际实现中应该使用邮件发送库进行连接测试
func testEmailConnection(smtpHost string, smtpPort int, tlsEnabled bool, username, password, fromEmail, testEmail string) (bool, string) {
    // 实际实现中应该：
    // 1. 使用net/smtp或第三方邮件库（如gomail）创建SMTP客户端
    // 2. 尝试连接到SMTP服务器
    // 3. 进行身份验证
    // 4. 发送测试邮件到testEmail
    // 5. 返回测试结果
    
    // 示例代码（伪代码）：
    // client, err := smtp.NewClient(smtpHost, smtpPort)
    // if err != nil {
    //     return false, fmt.Sprintf("连接SMTP服务器失败: %v", err)
    // }
    // defer client.Close()
    //
    // if tlsEnabled {
    //     if err := client.StartTLS(); err != nil {
    //         return false, fmt.Sprintf("TLS握手失败: %v", err)
    //     }
    // }
    //
    // auth := smtp.PlainAuth("", username, password, smtpHost)
    // if err := client.Auth(auth); err != nil {
    //     return false, fmt.Sprintf("身份验证失败: %v", err)
    // }
    //
    // // 发送测试邮件
    // msg := fmt.Sprintf("Subject: 邮箱配置测试\n\n这是一封测试邮件，用于验证邮箱配置是否正确。")
    // if err := client.SendMail(smtpHost, auth, fromEmail, []string{testEmail}, []byte(msg)); err != nil {
    //     return false, fmt.Sprintf("发送测试邮件失败: %v", err)
    // }
    //
    // return true, "测试邮件已成功发送"
    
    // 这里仅返回示例响应
    return true, "邮箱配置测试成功（示例实现）"
}
```

### 3. 注册路由

在 `internal/api/v1/router/router.go` 文件中注册路由：

```go
// RegisterConfigRoutes 注册配置相关路由
func RegisterConfigRoutes(r *gin.RouterGroup, configHandler *handler.ConfigHandler) {
    config := r.Group("/system/config")
    {
        // ... 其他路由 ...
        config.GET("/email", configHandler.GetEmailConfig)
        config.PUT("/email", configHandler.UpdateEmailConfig)
        email := config.Group("/email")
        {
            email.POST("/test", configHandler.TestEmailConfig) // 添加邮箱配置测试POST路由
        }
    }
}
```

### 4. 实际实现建议

在实际实现中，建议使用成熟的邮件发送库，例如：

```go
import (
    "net/smtp"
    "crypto/tls"
    "fmt"
)

// 使用net/smtp实现邮箱连接测试
func testEmailConnectionWithSMTP(smtpHost string, smtpPort int, tlsEnabled bool, username, password, fromEmail, testEmail string) (bool, string) {
    addr := fmt.Sprintf("%s:%d", smtpHost, smtpPort)
    
    // 创建TLS配置
    tlsConfig := &tls.Config{
        ServerName: smtpHost,
    }
    
    // 连接SMTP服务器
    conn, err := tls.Dial("tcp", addr, tlsConfig)
    if err != nil {
        return false, fmt.Sprintf("连接SMTP服务器失败: %v", err)
    }
    defer conn.Close()
    
    // 创建SMTP客户端
    client, err := smtp.NewClient(conn, smtpHost)
    if err != nil {
        return false, fmt.Sprintf("创建SMTP客户端失败: %v", err)
    }
    defer client.Close()
    
    // 身份验证
    auth := smtp.PlainAuth("", username, password, smtpHost)
    if err := client.Auth(auth); err != nil {
        return false, fmt.Sprintf("身份验证失败: %v", err)
    }
    
    // 设置发件人和收件人
    if err := client.Mail(fromEmail); err != nil {
        return false, fmt.Sprintf("设置发件人失败: %v", err)
    }
    if err := client.Rcpt(testEmail); err != nil {
        return false, fmt.Sprintf("设置收件人失败: %v", err)
    }
    
    // 发送邮件内容
    writer, err := client.Data()
    if err != nil {
        return false, fmt.Sprintf("准备发送邮件失败: %v", err)
    }
    
    msg := fmt.Sprintf("Subject: 邮箱配置测试\n\n这是一封测试邮件，用于验证邮箱配置是否正确。")
    if _, err := writer.Write([]byte(msg)); err != nil {
        return false, fmt.Sprintf("写入邮件内容失败: %v", err)
    }
    if err := writer.Close(); err != nil {
        return false, fmt.Sprintf("关闭邮件写入器失败: %v", err)
    }
    
    return true, "测试邮件已成功发送"
}
```

## 验收标准

1. **API端点正确实现**
   - POST /api/v1/system/config/email/test 端点正确实现
   - 路由正确注册
   - 权限验证中间件正确配置

2. **请求参数验证正确**
   - 请求参数绑定验证正确（测试邮箱地址格式验证）
   - 邮箱配置完整性验证正确
   - 验证失败时返回适当的错误响应

3. **邮箱连接测试功能正确**
   - 邮箱连接测试逻辑正确
   - 测试邮件发送功能正确（如果实现）
   - 错误处理正确

4. **权限验证正确**
   - 非管理员用户访问时返回403错误
   - 权限验证错误消息使用中文

5. **响应格式符合要求**
   - 响应使用Envelope格式
   - 成功响应包含测试结果
   - 错误响应包含适当的错误信息

6. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/api/v1/handler/config_handler.go` - 配置处理器实现
- `internal/api/v1/dto/config_dto.go` - 配置DTO定义
- `internal/api/v1/router/router.go` - 路由注册
- `internal/pkg/service/config_service.go` - 配置服务层实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/api.mdc` - API设计规范
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:06:02 CST

