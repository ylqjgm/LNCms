# TASK003-07: 模块管理API实现

## 任务信息

**任务编号**: TASK003-07  
**父任务**: TASK003  
**任务名称**: 模块管理API实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 21:30:48 CST

## 任务描述

实现模块管理的API接口。包括：1) 获取模块列表API（GET /api/v1/modules，支持分页）；2) 获取模块详情API（GET /api/v1/modules/{module_id}）；3) 注册模块API（POST /api/v1/modules，需要管理员权限）；4) 启用模块API（PUT /api/v1/modules/{module_id}/enable，需要管理员权限）；5) 禁用模块API（PUT /api/v1/modules/{module_id}/disable，需要管理员权限）；6) 检查模块健康状态API（GET /api/v1/modules/{module_id}/health）。所有API必须遵循OpenAPI 3.1.1规范和Envelope响应格式。编写API测试验证接口功能。

## 依赖任务

TASK003-06: 模块管理核心服务实现

## 实现指南

### 1. 创建ModuleHandler

在 `internal/api/v1/handler/module_handler.go` 文件中创建处理器：

```go
package handler

import (
    "net/http"
    "strconv"
    "yourproject/internal/pkg/service"
    "yourproject/internal/pkg/response"
)

// ModuleHandler 模块处理器
type ModuleHandler struct {
    moduleService service.ModuleService
}

// NewModuleHandler 创建模块处理器实例
func NewModuleHandler(moduleService service.ModuleService) *ModuleHandler {
    return &ModuleHandler{moduleService: moduleService}
}

// ListModules 获取模块列表
func (h *ModuleHandler) ListModules(c *gin.Context) {
    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    limit, _ := strconv.Atoi(c.DefaultQuery("limit", "20"))
    
    modules, total, err := h.moduleService.ListModules(c.Request.Context(), page, limit)
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "获取模块列表失败", err)
        return
    }
    
    response.SuccessWithPagination(c, modules, page, limit, total)
}

// GetModule 获取模块详情
func (h *ModuleHandler) GetModule(c *gin.Context) {
    moduleID := c.Param("module_id")
    
    module, err := h.moduleService.GetModuleByID(c.Request.Context(), moduleID)
    if err != nil {
        response.Error(c, http.StatusNotFound, "模块不存在", err)
        return
    }
    
    response.Success(c, module)
}

// RegisterModule 注册模块
func (h *ModuleHandler) RegisterModule(c *gin.Context) {
    var req RegisterModuleRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "请求参数错误", err)
        return
    }
    
    module := &model.Module{
        ModuleID:   req.ModuleID,
        ModuleName: req.ModuleName,
        ModuleType: req.ModuleType,
        ModuleURL:  req.ModuleURL,
    }
    
    if err := h.moduleService.RegisterModule(c.Request.Context(), module); err != nil {
        response.Error(c, http.StatusInternalServerError, "注册模块失败", err)
        return
    }
    
    response.Success(c, module)
}

// EnableModule 启用模块
func (h *ModuleHandler) EnableModule(c *gin.Context) {
    moduleID := c.Param("module_id")
    
    if err := h.moduleService.EnableModule(c.Request.Context(), moduleID); err != nil {
        response.Error(c, http.StatusInternalServerError, "启用模块失败", err)
        return
    }
    
    response.Success(c, nil)
}

// DisableModule 禁用模块
func (h *ModuleHandler) DisableModule(c *gin.Context) {
    moduleID := c.Param("module_id")
    
    if err := h.moduleService.DisableModule(c.Request.Context(), moduleID); err != nil {
        response.Error(c, http.StatusInternalServerError, "禁用模块失败", err)
        return
    }
    
    response.Success(c, nil)
}

// CheckModuleHealth 检查模块健康状态
func (h *ModuleHandler) CheckModuleHealth(c *gin.Context) {
    moduleID := c.Param("module_id")
    
    healthStatus, err := h.moduleService.CheckModuleHealth(c.Request.Context(), moduleID)
    if err != nil {
        response.Error(c, http.StatusInternalServerError, "健康检查失败", err)
        return
    }
    
    response.Success(c, healthStatus)
}
```

### 2. 注册路由

在 `internal/api/v1/route/module_route.go` 文件中注册路由：

```go
package route

import (
    "yourproject/internal/api/v1/handler"
    "yourproject/internal/middleware"
)

// RegisterModuleRoutes 注册模块路由
func RegisterModuleRoutes(r *gin.RouterGroup, moduleHandler *handler.ModuleHandler, authMiddleware gin.HandlerFunc) {
    moduleGroup := r.Group("/modules")
    {
        moduleGroup.GET("", moduleHandler.ListModules)
        moduleGroup.GET("/:module_id", moduleHandler.GetModule)
        moduleGroup.POST("", authMiddleware, middleware.RequireAdmin(), moduleHandler.RegisterModule)
        moduleGroup.PUT("/:module_id/enable", authMiddleware, middleware.RequireAdmin(), moduleHandler.EnableModule)
        moduleGroup.PUT("/:module_id/disable", authMiddleware, middleware.RequireAdmin(), moduleHandler.DisableModule)
        moduleGroup.GET("/:module_id/health", moduleHandler.CheckModuleHealth)
    }
}
```

## 验收标准

1. 所有模块管理API接口正确实现，遵循Envelope响应格式
2. 权限验证正确实现，管理员接口需要权限验证
3. 分页功能正确实现
4. API测试通过，覆盖所有接口
5. 响应格式符合OpenAPI 3.1.1规范
6. 错误消息使用中文

## 相关文件

- `internal/api/v1/handler/module_handler.go` - 模块API处理器
- `internal/api/v1/route/module_route.go` - 模块API路由注册
- `internal/api/v1/handler/module_handler_test.go` - 模块API测试
- `docs/Requirements/Core.md` - 核心模块需求文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 21:30:48 CST

