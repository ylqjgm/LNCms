# TASK003-31: 编写存储渠道管理API测试

## 任务信息

**任务编号**: TASK003-31  
**父任务**: TASK003  
**任务名称**: 编写存储渠道管理API测试  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 13:56:32 CST

## 任务描述

编写存储渠道管理API测试。包括：1) 测试GET、POST、PUT和DELETE端点；2) 测试正常情况、边界情况和异常情况；3) 测试分页功能；4) 测试权限验证；5) 确保所有测试用例通过。所有测试用例描述和错误消息必须使用中文。

## 依赖任务

- TASK003-28: 实现创建存储渠道API（POST）
- TASK003-29: 实现更新存储渠道API（PUT）
- TASK003-30: 实现删除存储渠道API（DELETE）

## 实现指南

### 1. 测试GetStorageChannels方法

在 `internal/api/v1/handler/config_handler_test.go` 文件中添加GetStorageChannels的测试用例：

```go
func TestConfigHandler_GetStorageChannels(t *testing.T) {
    tests := []struct {
        name           string
        setupService   func() service.ConfigService
        queryParams    string
        expectedStatus int
        expectedCount  int
        expectedError  string
    }{
        {
            name: "正常获取存储渠道列表-无分页",
            setupService: func() service.ConfigService {
                mockService := &MockConfigService{}
                mockService.On("GetConfig", mock.Anything, "attachment").Return(map[string]interface{}{
                    "storage_channels": []interface{}{
                        map[string]interface{}{
                            "channel_name":   "本地存储",
                            "storage_type":   "local",
                            "storage_config": map[string]interface{}{},
                        },
                        map[string]interface{}{
                            "channel_name":   "云存储",
                            "storage_type":   "cloud",
                            "storage_config": map[string]interface{}{
                                "endpoint": "https://oss.example.com",
                            },
                        },
                    },
                }, nil)
                return mockService
            },
            queryParams:    "",
            expectedStatus: http.StatusOK,
            expectedCount:  2,
        },
        {
            name: "正常获取存储渠道列表-带分页",
            setupService: func() service.ConfigService {
                mockService := &MockConfigService{}
                channels := make([]interface{}, 0)
                for i := 0; i < 25; i++ {
                    channels = append(channels, map[string]interface{}{
                        "channel_name":   fmt.Sprintf("渠道%d", i),
                        "storage_type":   "local",
                        "storage_config": map[string]interface{}{},
                    })
                }
                mockService.On("GetConfig", mock.Anything, "attachment").Return(map[string]interface{}{
                    "storage_channels": channels,
                }, nil)
                return mockService
            },
            queryParams:    "?page=1&limit=10",
            expectedStatus: http.StatusOK,
            expectedCount:  10,
        },
        {
            name: "配置不存在",
            setupService: func() service.ConfigService {
                mockService := &MockConfigService{}
                mockService.On("GetConfig", mock.Anything, "attachment").Return(nil, fmt.Errorf("配置类型 attachment 不存在"))
                return mockService
            },
            queryParams:    "",
            expectedStatus: http.StatusInternalServerError,
            expectedError:  "获取附件设置失败",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            router := setupTestRouter(tt.setupService())
            
            req := httptest.NewRequest(http.MethodGet, "/api/v1/system/config/storage/channels"+tt.queryParams, nil)
            w := httptest.NewRecorder()
            router.ServeHTTP(w, req)
            
            assert.Equal(t, tt.expectedStatus, w.Code)
            
            var response map[string]interface{}
            err := json.Unmarshal(w.Body.Bytes(), &response)
            require.NoError(t, err)
            
            if tt.expectedError != "" {
                errors, ok := response["errors"].([]interface{})
                assert.True(t, ok)
                assert.NotEmpty(t, errors)
            } else {
                data, ok := response["data"].(map[string]interface{})
                assert.True(t, ok)
                items, ok := data["items"].([]interface{})
                assert.True(t, ok)
                assert.Equal(t, tt.expectedCount, len(items))
            }
        })
    }
}
```

### 2. 测试CreateStorageChannel方法

编写CreateStorageChannel方法的测试用例：

```go
func TestConfigHandler_CreateStorageChannel(t *testing.T) {
    tests := []struct {
        name           string
        setupService   func() service.ConfigService
        requestBody    interface{}
        expectedStatus int
        expectedError  string
    }{
        {
            name: "正常创建存储渠道",
            setupService: func() service.ConfigService {
                mockService := &MockConfigService{}
                mockService.On("GetConfig", mock.Anything, "attachment").Return(map[string]interface{}{
                    "storage_channels": []interface{}{},
                }, nil)
                mockService.On("UpdateConfig", mock.Anything, "attachment", mock.Anything).Return(nil)
                return mockService
            },
            requestBody: dto.CreateStorageChannelRequest{
                ChannelName: "新渠道",
                StorageType: "local",
                StorageConfig: map[string]interface{}{},
            },
            expectedStatus: http.StatusOK,
        },
        {
            name: "请求参数验证失败-渠道名称为空",
            setupService: func() service.ConfigService {
                return &MockConfigService{}
            },
            requestBody: dto.CreateStorageChannelRequest{
                ChannelName: "",
                StorageType: "local",
                StorageConfig: map[string]interface{}{},
            },
            expectedStatus: http.StatusBadRequest,
            expectedError:  "请求参数错误",
        },
        {
            name: "业务验证失败-渠道名称已存在",
            setupService: func() service.ConfigService {
                mockService := &MockConfigService{}
                mockService.On("GetConfig", mock.Anything, "attachment").Return(map[string]interface{}{
                    "storage_channels": []interface{}{
                        map[string]interface{}{
                            "channel_name":   "已存在渠道",
                            "storage_type":   "local",
                            "storage_config": map[string]interface{}{},
                        },
                    },
                }, nil)
                return mockService
            },
            requestBody: dto.CreateStorageChannelRequest{
                ChannelName: "已存在渠道",
                StorageType: "local",
                StorageConfig: map[string]interface{}{},
            },
            expectedStatus: http.StatusBadRequest,
            expectedError:  "渠道名称 已存在渠道 已存在",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            router := setupTestRouter(tt.setupService())
            
            requestBodyBytes, err := json.Marshal(tt.requestBody)
            require.NoError(t, err)
            
            req := httptest.NewRequest(http.MethodPost, "/api/v1/system/config/storage/channels", bytes.NewBuffer(requestBodyBytes))
            req.Header.Set("Content-Type", "application/json")
            w := httptest.NewRecorder()
            router.ServeHTTP(w, req)
            
            assert.Equal(t, tt.expectedStatus, w.Code)
            
            var response map[string]interface{}
            err = json.Unmarshal(w.Body.Bytes(), &response)
            require.NoError(t, err)
            
            if tt.expectedError != "" {
                errors, ok := response["errors"].([]interface{})
                assert.True(t, ok)
                assert.NotEmpty(t, errors)
                errorMsg := errors[0].(map[string]interface{})["message"].(string)
                assert.Contains(t, errorMsg, tt.expectedError)
            } else {
                data, ok := response["data"].(map[string]interface{})
                assert.True(t, ok)
                assert.NotNil(t, data["channel_name"])
            }
        })
    }
}
```

### 3. 测试UpdateStorageChannel方法

编写UpdateStorageChannel方法的测试用例：

```go
func TestConfigHandler_UpdateStorageChannel(t *testing.T) {
    tests := []struct {
        name           string
        setupService   func() service.ConfigService
        channelID      string
        requestBody    interface{}
        expectedStatus int
        expectedError  string
    }{
        {
            name:      "正常更新存储渠道",
            channelID: "0",
            setupService: func() service.ConfigService {
                mockService := &MockConfigService{}
                mockService.On("GetConfig", mock.Anything, "attachment").Return(map[string]interface{}{
                    "storage_channels": []interface{}{
                        map[string]interface{}{
                            "channel_name":   "原渠道名",
                            "storage_type":   "local",
                            "storage_config": map[string]interface{}{},
                        },
                    },
                }, nil)
                mockService.On("UpdateConfig", mock.Anything, "attachment", mock.Anything).Return(nil)
                return mockService
            },
            requestBody: dto.UpdateStorageChannelRequest{
                ChannelName: "更新后的渠道名",
                StorageType: "cloud",
                StorageConfig: map[string]interface{}{
                    "endpoint": "https://oss.example.com",
                },
            },
            expectedStatus: http.StatusOK,
        },
        {
            name:      "渠道不存在",
            channelID: "999",
            setupService: func() service.ConfigService {
                mockService := &MockConfigService{}
                mockService.On("GetConfig", mock.Anything, "attachment").Return(map[string]interface{}{
                    "storage_channels": []interface{}{},
                }, nil)
                return mockService
            },
            requestBody: dto.UpdateStorageChannelRequest{
                ChannelName: "新渠道名",
                StorageType: "local",
                StorageConfig: map[string]interface{}{},
            },
            expectedStatus: http.StatusNotFound,
            expectedError:  "渠道 999 不存在",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            router := setupTestRouter(tt.setupService())
            
            requestBodyBytes, err := json.Marshal(tt.requestBody)
            require.NoError(t, err)
            
            req := httptest.NewRequest(http.MethodPut, fmt.Sprintf("/api/v1/system/config/storage/channels/%s", tt.channelID), bytes.NewBuffer(requestBodyBytes))
            req.Header.Set("Content-Type", "application/json")
            w := httptest.NewRecorder()
            router.ServeHTTP(w, req)
            
            assert.Equal(t, tt.expectedStatus, w.Code)
            
            var response map[string]interface{}
            err = json.Unmarshal(w.Body.Bytes(), &response)
            require.NoError(t, err)
            
            if tt.expectedError != "" {
                errors, ok := response["errors"].([]interface{})
                assert.True(t, ok)
                assert.NotEmpty(t, errors)
                errorMsg := errors[0].(map[string]interface{})["message"].(string)
                assert.Contains(t, errorMsg, tt.expectedError)
            } else {
                data, ok := response["data"].(map[string]interface{})
                assert.True(t, ok)
                assert.NotNil(t, data["channel_name"])
            }
        })
    }
}
```

### 4. 测试DeleteStorageChannel方法

编写DeleteStorageChannel方法的测试用例：

```go
func TestConfigHandler_DeleteStorageChannel(t *testing.T) {
    tests := []struct {
        name           string
        setupService   func() service.ConfigService
        channelID      string
        expectedStatus int
        expectedError  string
    }{
        {
            name:      "正常删除存储渠道",
            channelID: "0",
            setupService: func() service.ConfigService {
                mockService := &MockConfigService{}
                mockService.On("GetConfig", mock.Anything, "attachment").Return(map[string]interface{}{
                    "storage_channels": []interface{}{
                        map[string]interface{}{
                            "channel_name":   "渠道1",
                            "storage_type":   "local",
                            "storage_config": map[string]interface{}{},
                        },
                        map[string]interface{}{
                            "channel_name":   "渠道2",
                            "storage_type":   "cloud",
                            "storage_config": map[string]interface{}{},
                        },
                    },
                }, nil)
                mockService.On("UpdateConfig", mock.Anything, "attachment", mock.Anything).Return(nil)
                return mockService
            },
            expectedStatus: http.StatusOK,
        },
        {
            name:      "渠道不存在",
            channelID: "999",
            setupService: func() service.ConfigService {
                mockService := &MockConfigService{}
                mockService.On("GetConfig", mock.Anything, "attachment").Return(map[string]interface{}{
                    "storage_channels": []interface{}{},
                }, nil)
                return mockService
            },
            expectedStatus: http.StatusNotFound,
            expectedError:  "渠道 999 不存在",
        },
        {
            name:      "渠道ID格式错误",
            channelID: "invalid",
            setupService: func() service.ConfigService {
                return &MockConfigService{}
            },
            expectedStatus: http.StatusBadRequest,
            expectedError:  "渠道ID格式错误",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            router := setupTestRouter(tt.setupService())
            
            req := httptest.NewRequest(http.MethodDelete, fmt.Sprintf("/api/v1/system/config/storage/channels/%s", tt.channelID), nil)
            w := httptest.NewRecorder()
            router.ServeHTTP(w, req)
            
            assert.Equal(t, tt.expectedStatus, w.Code)
            
            var response map[string]interface{}
            err := json.Unmarshal(w.Body.Bytes(), &response)
            require.NoError(t, err)
            
            if tt.expectedError != "" {
                errors, ok := response["errors"].([]interface{})
                assert.True(t, ok)
                assert.NotEmpty(t, errors)
                errorMsg := errors[0].(map[string]interface{})["message"].(string)
                assert.Contains(t, errorMsg, tt.expectedError)
            }
        })
    }
}
```

### 5. 运行测试并检查覆盖率

运行测试并检查覆盖率：

```bash
# 运行测试
go test ./internal/api/v1/handler -v -run TestConfigHandler_GetStorageChannels
go test ./internal/api/v1/handler -v -run TestConfigHandler_CreateStorageChannel
go test ./internal/api/v1/handler -v -run TestConfigHandler_UpdateStorageChannel
go test ./internal/api/v1/handler -v -run TestConfigHandler_DeleteStorageChannel

# 生成覆盖率报告
go test ./internal/api/v1/handler -coverprofile=coverage.out -run TestConfigHandler

# 查看覆盖率
go tool cover -func=coverage.out
```

## 验收标准

1. **测试覆盖所有方法**
   - GetStorageChannels方法有完整的测试用例（包括分页测试）
   - CreateStorageChannel方法有完整的测试用例
   - UpdateStorageChannel方法有完整的测试用例
   - DeleteStorageChannel方法有完整的测试用例

2. **测试覆盖所有场景**
   - 正常情况测试通过
   - 边界情况测试通过（参数验证、业务规则验证、分页等）
   - 异常情况测试通过（配置不存在、服务错误等）

3. **测试覆盖率达标**
   - 代码覆盖率达到80%以上
   - 关键路径覆盖率达到100%

4. **测试代码规范**
   - 使用表驱动测试
   - 测试用例描述清晰，使用中文
   - 使用testify库进行断言和Mock
   - 测试代码遵循Golang编码规范

## 相关文件

- `internal/api/v1/handler/config_handler_test.go` - 配置处理器单元测试
- `internal/api/v1/handler/config_handler.go` - 配置处理器实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/testing.mdc` - 单元测试规范
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 13:56:32 CST

