# TASK003-58: 实现健康检查重试和超时机制

## 任务信息

**任务编号**: TASK003-58  
**父任务**: TASK003  
**任务名称**: 实现健康检查重试和超时机制  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:22:42 CST

## 任务描述

实现健康检查重试和超时机制。包括：1) 实现重试逻辑；2) 实现超时控制；3) 实现错误处理。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK003-56: 实现gRPC健康检查机制

## 实现指南

### 1. 定义重试配置

在 `internal/pkg/service/health_checker.go` 文件中定义重试配置：

```go
package service

import "time"

// RetryConfig 重试配置
type RetryConfig struct {
    MaxRetries int           // 最大重试次数
    RetryDelay time.Duration // 重试延迟
    Timeout    time.Duration // 超时时间
}

// DefaultRetryConfig 默认重试配置
func DefaultRetryConfig() RetryConfig {
    return RetryConfig{
        MaxRetries: 3,
        RetryDelay: 1 * time.Second,
        Timeout:    5 * time.Second,
    }
}
```

### 2. 更新HealthChecker接口

在 `internal/pkg/service/health_checker.go` 文件中更新接口：

```go
// HealthChecker 健康检查接口
type HealthChecker interface {
    // CheckHealth 检查模块健康状态（带重试和超时）
    CheckHealth(ctx context.Context, healthCheckURL string, config RetryConfig) (grpc_health_v1.HealthCheckResponse_ServingStatus, error)
}
```

### 3. 实现重试逻辑

在 `internal/pkg/service/grpc_health_checker.go` 文件中实现重试逻辑：

```go
// CheckHealth 检查模块健康状态（带重试和超时）
func (c *grpcHealthChecker) CheckHealth(ctx context.Context, healthCheckURL string, config RetryConfig) (grpc_health_v1.HealthCheckResponse_ServingStatus, error) {
    var lastErr error
    
    for attempt := 0; attempt <= config.MaxRetries; attempt++ {
        if attempt > 0 {
            // 重试前等待
            select {
            case <-ctx.Done():
                return grpc_health_v1.HealthCheckResponse_UNKNOWN, ctx.Err()
            case <-time.After(config.RetryDelay):
            }
        }
        
        // 创建带超时的上下文
        checkCtx, cancel := context.WithTimeout(ctx, config.Timeout)
        
        // 执行健康检查
        status, err := c.doCheckHealth(checkCtx, healthCheckURL)
        cancel()
        
        if err == nil {
            return status, nil
        }
        
        lastErr = err
        
        // 如果是最后一次尝试，不再重试
        if attempt == config.MaxRetries {
            break
        }
    }
    
    return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("健康检查失败（已重试%d次）: %w", config.MaxRetries, lastErr)
}

// doCheckHealth 执行单次健康检查
func (c *grpcHealthChecker) doCheckHealth(ctx context.Context, healthCheckURL string) (grpc_health_v1.HealthCheckResponse_ServingStatus, error) {
    // 建立gRPC连接
    conn, err := grpc.DialContext(
        ctx,
        healthCheckURL,
        grpc.WithTransportCredentials(insecure.NewCredentials()),
        grpc.WithBlock(),
    )
    if err != nil {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("连接gRPC服务失败: %w", err)
    }
    defer conn.Close()
    
    // 创建健康检查客户端
    client := grpc_health_v1.NewHealthClient(conn)
    
    // 执行健康检查
    resp, err := client.Check(ctx, &grpc_health_v1.HealthCheckRequest{
        Service: "", // 空字符串表示检查整个服务
    })
    if err != nil {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("健康检查请求失败: %w", err)
    }
    
    return resp.Status, nil
}
```

### 4. 更新ModuleService使用重试配置

在 `internal/pkg/service/module_service.go` 文件中更新CheckModuleHealth方法：

```go
// CheckModuleHealth 检查模块健康状态
func (s *moduleService) CheckModuleHealth(ctx context.Context, moduleID string) (grpc_health_v1.HealthCheckResponse_ServingStatus, error) {
    // 获取模块
    module, err := s.repo.GetByModuleID(ctx, moduleID)
    if err != nil {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("获取模块失败: %w", err)
    }
    
    // 检查健康状态
    if module.HealthCheckURL == "" {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("模块未配置健康检查URL")
    }
    
    // 使用默认重试配置
    config := DefaultRetryConfig()
    
    status, err := s.healthChecker.CheckHealth(ctx, module.HealthCheckURL, config)
    if err != nil {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("健康检查失败: %w", err)
    }
    
    return status, nil
}
```

### 5. 实现指数退避重试

可选：实现指数退避重试策略：

```go
// ExponentialBackoffRetryConfig 指数退避重试配置
type ExponentialBackoffRetryConfig struct {
    MaxRetries int           // 最大重试次数
    InitialDelay time.Duration // 初始延迟
    MaxDelay     time.Duration // 最大延迟
    Timeout      time.Duration // 超时时间
}

// CalculateDelay 计算重试延迟（指数退避）
func (c ExponentialBackoffRetryConfig) CalculateDelay(attempt int) time.Duration {
    delay := c.InitialDelay * time.Duration(1<<uint(attempt))
    if delay > c.MaxDelay {
        delay = c.MaxDelay
    }
    return delay
}

// CheckHealthWithExponentialBackoff 使用指数退避重试检查健康状态
func (c *grpcHealthChecker) CheckHealthWithExponentialBackoff(ctx context.Context, healthCheckURL string, config ExponentialBackoffRetryConfig) (grpc_health_v1.HealthCheckResponse_ServingStatus, error) {
    var lastErr error
    
    for attempt := 0; attempt <= config.MaxRetries; attempt++ {
        if attempt > 0 {
            // 计算重试延迟
            delay := config.CalculateDelay(attempt - 1)
            
            // 重试前等待
            select {
            case <-ctx.Done():
                return grpc_health_v1.HealthCheckResponse_UNKNOWN, ctx.Err()
            case <-time.After(delay):
            }
        }
        
        // 创建带超时的上下文
        checkCtx, cancel := context.WithTimeout(ctx, config.Timeout)
        
        // 执行健康检查
        status, err := c.doCheckHealth(checkCtx, healthCheckURL)
        cancel()
        
        if err == nil {
            return status, nil
        }
        
        lastErr = err
        
        // 如果是最后一次尝试，不再重试
        if attempt == config.MaxRetries {
            break
        }
    }
    
    return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("健康检查失败（已重试%d次）: %w", config.MaxRetries, lastErr)
}
```

## 验收标准

1. **重试机制正确实现**
   - 重试逻辑正确
   - 重试次数可配置
   - 重试延迟可配置

2. **超时控制正确实现**
   - 超时时间可配置
   - 超时后正确返回错误
   - 超时不影响重试逻辑

3. **错误处理正确**
   - 所有错误消息使用中文
   - 错误包装保留错误链
   - 正确处理超时和重试错误

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/service/health_checker.go` - 健康检查接口和配置
- `internal/pkg/service/grpc_health_checker.go` - gRPC健康检查实现
- `internal/pkg/service/module_service.go` - ModuleService接口和实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:22:42 CST

