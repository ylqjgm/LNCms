# TASK003-53: 创建ModuleService接口和实现

## 任务信息

**任务编号**: TASK003-53  
**父任务**: TASK003  
**任务名称**: 创建ModuleService接口和实现  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:16:45 CST

## 任务描述

创建ModuleService接口和实现，提供模块注册、启用、禁用功能。包括：1) 定义ModuleService接口；2) 实现模块注册、启用、禁用方法；3) 实现业务逻辑处理。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK003-50: 实现ModuleRepository接口

## 实现指南

### 1. 定义ModuleService接口

在 `internal/pkg/service/module_service.go` 文件中定义接口：

```go
package service

import (
    "context"
    "yourproject/internal/pkg/model"
)

// ModuleService 模块服务接口
type ModuleService interface {
    // RegisterModule 注册模块
    RegisterModule(ctx context.Context, moduleID, moduleName, moduleType, moduleURL, healthCheckURL string, configData map[string]interface{}) (*model.Module, error)
    
    // EnableModule 启用模块
    EnableModule(ctx context.Context, moduleID string) error
    
    // DisableModule 禁用模块
    DisableModule(ctx context.Context, moduleID string) error
}
```

### 2. 实现moduleService结构体

在同一个文件中实现模块服务：

```go
import (
    "context"
    "encoding/json"
    "fmt"
    "gorm.io/datatypes"
    "yourproject/internal/pkg/model"
    "yourproject/internal/pkg/repository"
)

// moduleService 模块服务实现
type moduleService struct {
    repo repository.ModuleRepository
}

// NewModuleService 创建模块服务实例
func NewModuleService(repo repository.ModuleRepository) ModuleService {
    return &moduleService{
        repo: repo,
    }
}
```

### 3. 实现RegisterModule方法

实现模块注册方法：

```go
// RegisterModule 注册模块
func (s *moduleService) RegisterModule(ctx context.Context, moduleID, moduleName, moduleType, moduleURL, healthCheckURL string, configData map[string]interface{}) (*model.Module, error) {
    // 验证模块ID是否已存在
    existing, err := s.repo.GetByModuleID(ctx, moduleID)
    if err == nil && existing != nil {
        return nil, fmt.Errorf("模块ID %s 已存在", moduleID)
    }
    
    // 构建配置数据
    var configDataJSON datatypes.JSON
    if configData != nil {
        configBytes, err := json.Marshal(configData)
        if err != nil {
            return nil, fmt.Errorf("序列化配置数据失败: %w", err)
        }
        configDataJSON = configBytes
    }
    
    // 创建模块
    module := &model.Module{
        ModuleID:       moduleID,
        ModuleName:     moduleName,
        ModuleType:     moduleType,
        ModuleURL:      moduleURL,
        ModuleStatus:   string(model.ModuleStatusInactive),
        HealthCheckURL: healthCheckURL,
        ConfigData:     configDataJSON,
    }
    
    if err := s.repo.Create(ctx, module); err != nil {
        return nil, fmt.Errorf("创建模块失败: %w", err)
    }
    
    return module, nil
}
```

### 4. 实现EnableModule方法

实现启用模块方法：

```go
// EnableModule 启用模块
func (s *moduleService) EnableModule(ctx context.Context, moduleID string) error {
    // 获取模块
    module, err := s.repo.GetByModuleID(ctx, moduleID)
    if err != nil {
        return fmt.Errorf("获取模块失败: %w", err)
    }
    
    // 更新模块状态
    module.ModuleStatus = string(model.ModuleStatusActive)
    if err := s.repo.Update(ctx, module); err != nil {
        return fmt.Errorf("启用模块失败: %w", err)
    }
    
    return nil
}
```

### 5. 实现DisableModule方法

实现禁用模块方法：

```go
// DisableModule 禁用模块
func (s *moduleService) DisableModule(ctx context.Context, moduleID string) error {
    // 获取模块
    module, err := s.repo.GetByModuleID(ctx, moduleID)
    if err != nil {
        return fmt.Errorf("获取模块失败: %w", err)
    }
    
    // 更新模块状态
    module.ModuleStatus = string(model.ModuleStatusInactive)
    if err := s.repo.Update(ctx, module); err != nil {
        return fmt.Errorf("禁用模块失败: %w", err)
    }
    
    return nil
}
```

## 验收标准

1. **接口定义正确**
   - ModuleService接口正确定义
   - 所有方法签名正确
   - 方法参数和返回值类型正确

2. **实现完整**
   - 所有接口方法都已实现
   - 业务逻辑处理正确
   - 错误处理正确

3. **错误处理正确**
   - 所有错误消息使用中文
   - 错误包装保留错误链
   - 处理业务规则验证（如模块ID重复检查）

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/service/module_service.go` - ModuleService接口和实现
- `internal/pkg/repository/module_repository.go` - ModuleRepository接口
- `internal/pkg/model/module.go` - Module模型定义
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:16:45 CST

