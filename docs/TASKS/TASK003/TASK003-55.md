# TASK003-55: 编写模块服务层单元测试

## 任务信息

**任务编号**: TASK003-55  
**父任务**: TASK003  
**任务名称**: 编写模块服务层单元测试  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:22:42 CST

## 任务描述

编写模块服务层单元测试。包括：1) 测试ModuleService的所有方法；2) 测试模块状态管理功能；3) 使用Mock Repository进行测试；4) 确保测试覆盖率达标。所有测试用例描述和错误消息必须使用中文。

## 依赖任务

- TASK003-53: 创建ModuleService接口和实现
- TASK003-54: 实现模块状态管理

## 实现指南

### 1. 创建测试文件

在 `internal/pkg/service/module_service_test.go` 文件中创建测试：

```go
package service

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/require"
    "gorm.io/datatypes"
    "yourproject/internal/pkg/model"
    "yourproject/internal/pkg/repository"
)
```

### 2. 创建Mock Repository

使用testify/mock创建Mock Repository：

```go
// MockModuleRepository Mock模块仓储
type MockModuleRepository struct {
    mock.Mock
}

func (m *MockModuleRepository) Create(ctx context.Context, module *model.Module) error {
    args := m.Called(ctx, module)
    return args.Error(0)
}

func (m *MockModuleRepository) GetByID(ctx context.Context, id int64) (*model.Module, error) {
    args := m.Called(ctx, id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*model.Module), args.Error(1)
}

func (m *MockModuleRepository) GetByModuleID(ctx context.Context, moduleID string) (*model.Module, error) {
    args := m.Called(ctx, moduleID)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*model.Module), args.Error(1)
}

func (m *MockModuleRepository) List(ctx context.Context, limit, offset int) ([]*model.Module, int64, error) {
    args := m.Called(ctx, limit, offset)
    if args.Get(0) == nil {
        return nil, int64(0), args.Error(2)
    }
    return args.Get(0).([]*model.Module), args.Get(1).(int64), args.Error(2)
}

func (m *MockModuleRepository) Update(ctx context.Context, module *model.Module) error {
    args := m.Called(ctx, module)
    return args.Error(0)
}

func (m *MockModuleRepository) Delete(ctx context.Context, id int64) error {
    args := m.Called(ctx, id)
    return args.Error(0)
}
```

### 3. 测试RegisterModule方法

编写RegisterModule方法的测试用例：

```go
func TestModuleService_RegisterModule(t *testing.T) {
    tests := []struct {
        name        string
        moduleID    string
        moduleName  string
        moduleType  string
        moduleURL   string
        healthURL   string
        configData  map[string]interface{}
        setupMock   func(*MockModuleRepository)
        wantErr     bool
        errContains string
    }{
        {
            name:       "成功注册模块",
            moduleID:   "test-module",
            moduleName: "测试模块",
            moduleType: "crawler",
            moduleURL:  "http://localhost:8080",
            healthURL:  "http://localhost:8080/health",
            configData: map[string]interface{}{"key": "value"},
            setupMock: func(m *MockModuleRepository) {
                m.On("GetByModuleID", mock.Anything, "test-module").Return(nil, repository.ErrNotFound)
                m.On("Create", mock.Anything, mock.AnythingOfType("*model.Module")).Return(nil)
            },
            wantErr: false,
        },
        {
            name:       "模块ID已存在",
            moduleID:   "existing-module",
            moduleName: "已存在模块",
            moduleType: "crawler",
            moduleURL:  "http://localhost:8080",
            healthURL:  "http://localhost:8080/health",
            setupMock: func(m *MockModuleRepository) {
                existingModule := &model.Module{
                    ID:         1,
                    ModuleID:   "existing-module",
                    ModuleName: "已存在模块",
                }
                m.On("GetByModuleID", mock.Anything, "existing-module").Return(existingModule, nil)
            },
            wantErr:     true,
            errContains: "已存在",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockRepo := new(MockModuleRepository)
            tt.setupMock(mockRepo)
            
            service := NewModuleService(mockRepo)
            ctx := context.Background()
            
            module, err := service.RegisterModule(ctx, tt.moduleID, tt.moduleName, tt.moduleType, tt.moduleURL, tt.healthURL, tt.configData)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errContains != "" {
                    assert.Contains(t, err.Error(), tt.errContains)
                }
            } else {
                require.NoError(t, err)
                require.NotNil(t, module)
                assert.Equal(t, tt.moduleID, module.ModuleID)
                assert.Equal(t, tt.moduleName, module.ModuleName)
            }
            
            mockRepo.AssertExpectations(t)
        })
    }
}
```

### 4. 测试EnableModule方法

编写EnableModule方法的测试用例：

```go
func TestModuleService_EnableModule(t *testing.T) {
    tests := []struct {
        name        string
        moduleID    string
        setupMock   func(*MockModuleRepository)
        wantErr     bool
        errContains string
    }{
        {
            name:     "成功启用模块",
            moduleID: "test-module",
            setupMock: func(m *MockModuleRepository) {
                module := &model.Module{
                    ID:           1,
                    ModuleID:     "test-module",
                    ModuleStatus: string(model.ModuleStatusInactive),
                }
                m.On("GetByModuleID", mock.Anything, "test-module").Return(module, nil)
                m.On("Update", mock.Anything, mock.AnythingOfType("*model.Module")).Return(nil)
            },
            wantErr: false,
        },
        {
            name:     "模块不存在",
            moduleID: "non-existent",
            setupMock: func(m *MockModuleRepository) {
                m.On("GetByModuleID", mock.Anything, "non-existent").Return(nil, repository.ErrNotFound)
            },
            wantErr:     true,
            errContains: "获取模块失败",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockRepo := new(MockModuleRepository)
            tt.setupMock(mockRepo)
            
            service := NewModuleService(mockRepo)
            ctx := context.Background()
            
            err := service.EnableModule(ctx, tt.moduleID)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errContains != "" {
                    assert.Contains(t, err.Error(), tt.errContains)
                }
            } else {
                require.NoError(t, err)
            }
            
            mockRepo.AssertExpectations(t)
        })
    }
}
```

### 5. 测试DisableModule方法

编写DisableModule方法的测试用例：

```go
func TestModuleService_DisableModule(t *testing.T) {
    tests := []struct {
        name        string
        moduleID    string
        setupMock   func(*MockModuleRepository)
        wantErr     bool
        errContains string
    }{
        {
            name:     "成功禁用模块",
            moduleID: "test-module",
            setupMock: func(m *MockModuleRepository) {
                module := &model.Module{
                    ID:           1,
                    ModuleID:     "test-module",
                    ModuleStatus: string(model.ModuleStatusActive),
                }
                m.On("GetByModuleID", mock.Anything, "test-module").Return(module, nil)
                m.On("Update", mock.Anything, mock.AnythingOfType("*model.Module")).Return(nil)
            },
            wantErr: false,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockRepo := new(MockModuleRepository)
            tt.setupMock(mockRepo)
            
            service := NewModuleService(mockRepo)
            ctx := context.Background()
            
            err := service.DisableModule(ctx, tt.moduleID)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errContains != "" {
                    assert.Contains(t, err.Error(), tt.errContains)
                }
            } else {
                require.NoError(t, err)
            }
            
            mockRepo.AssertExpectations(t)
        })
    }
}
```

### 6. 测试状态管理方法

编写状态管理方法的测试用例：

```go
func TestModuleService_TransitionState(t *testing.T) {
    tests := []struct {
        name        string
        moduleID    string
        newStatus   model.ModuleStatus
        setupMock   func(*MockModuleRepository)
        wantErr     bool
        errContains string
    }{
        {
            name:      "成功转换状态：非激活到激活",
            moduleID:  "test-module",
            newStatus: model.ModuleStatusActive,
            setupMock: func(m *MockModuleRepository) {
                module := &model.Module{
                    ID:           1,
                    ModuleID:     "test-module",
                    ModuleStatus: string(model.ModuleStatusInactive),
                }
                m.On("GetByModuleID", mock.Anything, "test-module").Return(module, nil)
                m.On("Update", mock.Anything, mock.AnythingOfType("*model.Module")).Return(nil)
            },
            wantErr: false,
        },
        {
            name:      "无效的状态转换",
            moduleID:  "test-module",
            newStatus: model.ModuleStatusActive,
            setupMock: func(m *MockModuleRepository) {
                module := &model.Module{
                    ID:           1,
                    ModuleID:     "test-module",
                    ModuleStatus: string(model.ModuleStatusActive),
                }
                m.On("GetByModuleID", mock.Anything, "test-module").Return(module, nil)
            },
            wantErr:     true,
            errContains: "状态转换验证失败",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockRepo := new(MockModuleRepository)
            tt.setupMock(mockRepo)
            
            service := NewModuleService(mockRepo)
            ctx := context.Background()
            
            err := service.TransitionState(ctx, tt.moduleID, tt.newStatus)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errContains != "" {
                    assert.Contains(t, err.Error(), tt.errContains)
                }
            } else {
                require.NoError(t, err)
            }
            
            mockRepo.AssertExpectations(t)
        })
    }
}
```

## 验收标准

1. **测试覆盖完整**
   - 所有ModuleService方法都有测试用例
   - 测试覆盖正常情况、边界情况和异常情况
   - 测试覆盖率达标（核心业务逻辑80%以上）

2. **测试用例质量**
   - 使用表驱动测试
   - 测试用例名称清晰（使用中文）
   - 测试独立，不依赖执行顺序

3. **Mock使用正确**
   - 正确使用Mock Repository
   - Mock期望设置正确
   - 验证Mock调用

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 测试用例描述和错误消息使用中文
   - 遵循Golang单元测试规范

## 相关文件

- `internal/pkg/service/module_service_test.go` - 模块服务层单元测试
- `internal/pkg/service/module_service.go` - ModuleService接口和实现
- `internal/pkg/service/module_state.go` - 模块状态管理实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `.cursor/rules/testing.mdc` - 单元测试规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:22:42 CST

