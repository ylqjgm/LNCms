# TASK003-64: 实现注册模块API（POST）

## 任务信息

**任务编号**: TASK003-64  
**父任务**: TASK003  
**任务名称**: 实现注册模块API（POST）  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:22:42 CST

## 任务描述

实现注册模块API接口。包括：1) 实现 POST /api/v1/modules 端点；2) 实现请求参数验证和权限验证（需要管理员权限）；3) 实现业务逻辑处理和响应构建；4) 遵循OpenAPI 3.1.1规范和Envelope响应格式。所有错误消息必须使用中文。

## 依赖任务

- TASK003-59: 编写模块健康检查单元测试

## 实现指南

### 1. 定义请求结构体

在 `internal/api/v1/dto/module_dto.go` 文件中定义注册模块请求结构体：

```go
// RegisterModuleRequest 注册模块请求
type RegisterModuleRequest struct {
    ModuleID       string                 `json:"module_id" binding:"required"`        // 模块标识符
    ModuleName     string                 `json:"module_name" binding:"required"`      // 模块名称
    ModuleType     string                 `json:"module_type" binding:"required"`      // 模块类型
    ModuleURL      string                 `json:"module_url" binding:"required,url"`   // 模块URL
    HealthCheckURL string                 `json:"health_check_url" binding:"required,url"` // 健康检查URL
    ConfigData     map[string]interface{} `json:"config_data"`                         // 配置数据
}
```

### 2. 实现RegisterModule方法

在 `internal/api/v1/handler/module_handler.go` 文件中实现RegisterModule方法：

```go
// RegisterModule 注册模块
// @Summary 注册模块
// @Description 注册新的模块到系统
// @Tags 模块管理
// @Accept json
// @Produce json
// @Param request body dto.RegisterModuleRequest true "注册模块请求"
// @Success 201 {object} response.Envelope{data=dto.ModuleDetailResponse} "成功响应"
// @Failure 400 {object} response.Envelope "请求参数错误"
// @Failure 401 {object} response.Envelope "未授权"
// @Failure 403 {object} response.Envelope "权限不足"
// @Failure 409 {object} response.Envelope "模块已存在"
// @Failure 500 {object} response.Envelope "服务器错误"
// @Router /api/v1/modules [post]
// @Security BearerAuth
func (h *ModuleHandler) RegisterModule(c *gin.Context) {
    ctx := c.Request.Context()
    
    // 权限验证（需要管理员权限）
    // TODO: 实现权限验证中间件
    
    var req dto.RegisterModuleRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "INVALID_PARAM", "请求参数验证失败", err)
        return
    }
    
    // 从服务层注册模块
    module, err := h.moduleService.RegisterModule(
        ctx,
        req.ModuleID,
        req.ModuleName,
        req.ModuleType,
        req.ModuleURL,
        req.HealthCheckURL,
        req.ConfigData,
    )
    if err != nil {
        if strings.Contains(err.Error(), "已存在") {
            response.Error(c, http.StatusConflict, "MODULE_EXISTS", "模块已存在", err)
            return
        }
        response.Error(c, http.StatusInternalServerError, "MODULE_REGISTER_FAILED", "注册模块失败", err)
        return
    }
    
    // 解析配置数据
    var configData map[string]interface{}
    if len(module.ConfigData) > 0 {
        if err := json.Unmarshal(module.ConfigData, &configData); err != nil {
            configData = make(map[string]interface{})
        }
    }
    
    // 转换为响应结构体
    detail := dto.ModuleDetailResponse{
        ID:              module.ID,
        ModuleID:        module.ModuleID,
        ModuleName:      module.ModuleName,
        ModuleType:      module.ModuleType,
        ModuleURL:       module.ModuleURL,
        ModuleStatus:    module.ModuleStatus,
        HealthCheckURL:  module.HealthCheckURL,
        ConfigData:      configData,
        LastHealthCheck: module.LastHealthCheck.Format("2006-01-02 15:04:05"),
        CreatedAt:       module.CreatedAt.Format("2006-01-02 15:04:05"),
        UpdatedAt:       module.UpdatedAt.Format("2006-01-02 15:04:05"),
    }
    
    // 返回成功响应（201 Created）
    response.SuccessWithStatus(c, http.StatusCreated, detail)
}
```

### 3. 注册路由

在 `internal/api/v1/router/router.go` 文件中注册路由：

```go
// RegisterModuleRoutes 注册模块相关路由
func RegisterModuleRoutes(r *gin.RouterGroup, moduleHandler *handler.ModuleHandler) {
    modules := r.Group("/modules")
    {
        modules.GET("", moduleHandler.GetModuleList)
        modules.GET("/:module_id", moduleHandler.GetModuleDetail)
        modules.POST("", moduleHandler.RegisterModule) // 需要管理员权限
    }
}
```

## 验收标准

1. **API端点正确实现**
   - POST /api/v1/modules 端点正确实现
   - 路由正确注册
   - 权限验证正确

2. **请求参数验证正确**
   - 必填字段验证
   - URL格式验证
   - 参数绑定正确

3. **响应格式符合要求**
   - 响应使用Envelope格式
   - 成功时返回201状态码
   - 错误时返回适当的HTTP状态码

4. **错误处理正确**
   - 参数验证失败时返回400错误
   - 模块已存在时返回409错误
   - 权限不足时返回403错误
   - 所有错误消息使用中文

5. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范和API设计规范

## 相关文件

- `internal/api/v1/handler/module_handler.go` - 模块处理器实现
- `internal/api/v1/dto/module_dto.go` - 模块DTO定义
- `internal/api/v1/router/router.go` - 路由注册
- `internal/pkg/service/module_service.go` - ModuleService接口和实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/api.mdc` - API设计规范
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:22:42 CST

