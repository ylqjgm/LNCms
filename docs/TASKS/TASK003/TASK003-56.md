# TASK003-56: 实现gRPC健康检查机制

## 任务信息

**任务编号**: TASK003-56  
**父任务**: TASK003  
**任务名称**: 实现gRPC健康检查机制  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:22:42 CST

## 任务描述

实现gRPC健康检查机制，使用grpc_health_v1.HealthClient检查模块健康状态。包括：1) 实现gRPC健康检查客户端；2) 实现健康状态检查逻辑；3) 实现健康状态结果处理。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

- TASK003-53: 创建ModuleService接口和实现

## 实现指南

### 1. 定义健康检查接口

在 `internal/pkg/service/health_checker.go` 文件中定义健康检查接口：

```go
package service

import (
    "context"
    "google.golang.org/grpc/health/grpc_health_v1"
)

// HealthChecker 健康检查接口
type HealthChecker interface {
    // CheckHealth 检查模块健康状态
    CheckHealth(ctx context.Context, healthCheckURL string) (grpc_health_v1.HealthCheckResponse_ServingStatus, error)
}
```

### 2. 实现gRPC健康检查客户端

在 `internal/pkg/service/grpc_health_checker.go` 文件中实现gRPC健康检查客户端：

```go
package service

import (
    "context"
    "fmt"
    "time"
    
    "google.golang.org/grpc"
    "google.golang.org/grpc/credentials/insecure"
    "google.golang.org/grpc/health/grpc_health_v1"
)

// grpcHealthChecker gRPC健康检查实现
type grpcHealthChecker struct {
    timeout time.Duration
}

// NewGRPCHealthChecker 创建gRPC健康检查客户端
func NewGRPCHealthChecker(timeout time.Duration) HealthChecker {
    return &grpcHealthChecker{
        timeout: timeout,
    }
}

// CheckHealth 检查模块健康状态
func (c *grpcHealthChecker) CheckHealth(ctx context.Context, healthCheckURL string) (grpc_health_v1.HealthCheckResponse_ServingStatus, error) {
    // 创建带超时的上下文
    checkCtx, cancel := context.WithTimeout(ctx, c.timeout)
    defer cancel()
    
    // 建立gRPC连接
    conn, err := grpc.DialContext(
        checkCtx,
        healthCheckURL,
        grpc.WithTransportCredentials(insecure.NewCredentials()),
        grpc.WithBlock(),
    )
    if err != nil {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("连接gRPC服务失败: %w", err)
    }
    defer conn.Close()
    
    // 创建健康检查客户端
    client := grpc_health_v1.NewHealthClient(conn)
    
    // 执行健康检查
    resp, err := client.Check(checkCtx, &grpc_health_v1.HealthCheckRequest{
        Service: "", // 空字符串表示检查整个服务
    })
    if err != nil {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("健康检查请求失败: %w", err)
    }
    
    return resp.Status, nil
}
```

### 3. 在ModuleService中集成健康检查

在 `internal/pkg/service/module_service.go` 文件中集成健康检查：

```go
// moduleService 模块服务实现
type moduleService struct {
    repo          repository.ModuleRepository
    healthChecker HealthChecker
}

// NewModuleService 创建模块服务实例
func NewModuleService(repo repository.ModuleRepository, healthChecker HealthChecker) ModuleService {
    return &moduleService{
        repo:          repo,
        healthChecker: healthChecker,
    }
}

// CheckModuleHealth 检查模块健康状态
func (s *moduleService) CheckModuleHealth(ctx context.Context, moduleID string) (grpc_health_v1.HealthCheckResponse_ServingStatus, error) {
    // 获取模块
    module, err := s.repo.GetByModuleID(ctx, moduleID)
    if err != nil {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("获取模块失败: %w", err)
    }
    
    // 检查健康状态
    if module.HealthCheckURL == "" {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("模块未配置健康检查URL")
    }
    
    status, err := s.healthChecker.CheckHealth(ctx, module.HealthCheckURL)
    if err != nil {
        return grpc_health_v1.HealthCheckResponse_UNKNOWN, fmt.Errorf("健康检查失败: %w", err)
    }
    
    return status, nil
}
```

### 4. 更新ModuleService接口

在 `internal/pkg/service/module_service.go` 文件中更新接口：

```go
// ModuleService 模块服务接口
type ModuleService interface {
    // RegisterModule 注册模块
    RegisterModule(ctx context.Context, moduleID, moduleName, moduleType, moduleURL, healthCheckURL string, configData map[string]interface{}) (*model.Module, error)
    
    // EnableModule 启用模块
    EnableModule(ctx context.Context, moduleID string) error
    
    // DisableModule 禁用模块
    DisableModule(ctx context.Context, moduleID string) error
    
    // CheckModuleHealth 检查模块健康状态
    CheckModuleHealth(ctx context.Context, moduleID string) (grpc_health_v1.HealthCheckResponse_ServingStatus, error)
}
```

### 5. 处理健康状态结果

在 `internal/pkg/service/module_service.go` 文件中实现健康状态结果处理：

```go
// UpdateModuleHealthStatus 更新模块健康状态
func (s *moduleService) UpdateModuleHealthStatus(ctx context.Context, moduleID string) error {
    // 检查健康状态
    status, err := s.CheckModuleHealth(ctx, moduleID)
    if err != nil {
        // 健康检查失败，更新状态为错误
        module, err := s.repo.GetByModuleID(ctx, moduleID)
        if err != nil {
            return fmt.Errorf("获取模块失败: %w", err)
        }
        
        module.ModuleStatus = string(model.ModuleStatusError)
        if err := s.repo.Update(ctx, module); err != nil {
            return fmt.Errorf("更新模块状态失败: %w", err)
        }
        
        return nil
    }
    
    // 根据健康状态更新模块状态
    module, err := s.repo.GetByModuleID(ctx, moduleID)
    if err != nil {
        return fmt.Errorf("获取模块失败: %w", err)
    }
    
    switch status {
    case grpc_health_v1.HealthCheckResponse_SERVING:
        if module.ModuleStatus != string(model.ModuleStatusActive) {
            module.ModuleStatus = string(model.ModuleStatusActive)
            if err := s.repo.Update(ctx, module); err != nil {
                return fmt.Errorf("更新模块状态失败: %w", err)
            }
        }
    case grpc_health_v1.HealthCheckResponse_NOT_SERVING:
        if module.ModuleStatus != string(model.ModuleStatusError) {
            module.ModuleStatus = string(model.ModuleStatusError)
            if err := s.repo.Update(ctx, module); err != nil {
                return fmt.Errorf("更新模块状态失败: %w", err)
            }
        }
    default:
        // UNKNOWN状态，不更新模块状态
    }
    
    return nil
}
```

## 验收标准

1. **健康检查接口正确定义**
   - HealthChecker接口正确定义
   - 方法签名正确

2. **gRPC健康检查客户端正确实现**
   - 正确建立gRPC连接
   - 正确调用健康检查服务
   - 正确处理超时和错误

3. **健康检查集成正确**
   - ModuleService正确集成健康检查
   - CheckModuleHealth方法正确实现
   - UpdateModuleHealthStatus方法正确实现

4. **错误处理正确**
   - 所有错误消息使用中文
   - 错误包装保留错误链
   - 处理连接失败、超时等异常情况

5. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 代码注释完整，使用中文
   - 遵循Golang编码规范

## 相关文件

- `internal/pkg/service/health_checker.go` - 健康检查接口定义
- `internal/pkg/service/grpc_health_checker.go` - gRPC健康检查实现
- `internal/pkg/service/module_service.go` - ModuleService接口和实现
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:22:42 CST

