# TASK003-59: 编写模块健康检查单元测试

## 任务信息

**任务编号**: TASK003-59  
**父任务**: TASK003  
**任务名称**: 编写模块健康检查单元测试  
**版本信息**: v2.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 14:22:42 CST

## 任务描述

编写模块健康检查单元测试。包括：1) 测试gRPC健康检查机制；2) 测试定时健康检查任务；3) 测试重试和超时机制；4) 使用Mock gRPC客户端进行测试；5) 确保测试覆盖率达标。所有测试用例描述和错误消息必须使用中文。

## 依赖任务

- TASK003-57: 实现定时健康检查任务
- TASK003-58: 实现健康检查重试和超时机制

## 实现指南

### 1. 创建测试文件

在 `internal/pkg/service/grpc_health_checker_test.go` 文件中创建测试：

```go
package service

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    "google.golang.org/grpc/health/grpc_health_v1"
)
```

### 2. 测试健康检查基本功能

编写健康检查基本功能的测试用例：

```go
func TestGRPCHealthChecker_CheckHealth(t *testing.T) {
    tests := []struct {
        name           string
        healthCheckURL string
        config         RetryConfig
        wantStatus     grpc_health_v1.HealthCheckResponse_ServingStatus
        wantErr        bool
        errContains    string
    }{
        {
            name:           "成功检查健康状态",
            healthCheckURL:  "localhost:50051",
            config:         DefaultRetryConfig(),
            wantStatus:     grpc_health_v1.HealthCheckResponse_SERVING,
            wantErr:        false,
        },
        {
            name:           "连接失败",
            healthCheckURL:  "invalid-url",
            config:         DefaultRetryConfig(),
            wantStatus:     grpc_health_v1.HealthCheckResponse_UNKNOWN,
            wantErr:        true,
            errContains:    "连接gRPC服务失败",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            checker := NewGRPCHealthChecker(5 * time.Second)
            ctx := context.Background()
            
            status, err := checker.CheckHealth(ctx, tt.healthCheckURL, tt.config)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errContains != "" {
                    assert.Contains(t, err.Error(), tt.errContains)
                }
            } else {
                require.NoError(t, err)
                assert.Equal(t, tt.wantStatus, status)
            }
        })
    }
}
```

### 3. 测试重试机制

编写重试机制的测试用例：

```go
func TestGRPCHealthChecker_Retry(t *testing.T) {
    tests := []struct {
        name        string
        config      RetryConfig
        wantRetries int
    }{
        {
            name: "重试3次",
            config: RetryConfig{
                MaxRetries: 3,
                RetryDelay: 100 * time.Millisecond,
                Timeout:    1 * time.Second,
            },
            wantRetries: 3,
        },
        {
            name: "不重试",
            config: RetryConfig{
                MaxRetries: 0,
                RetryDelay: 100 * time.Millisecond,
                Timeout:    1 * time.Second,
            },
            wantRetries: 0,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            checker := NewGRPCHealthChecker(5 * time.Second)
            ctx := context.Background()
            
            // 使用无效URL触发重试
            _, err := checker.CheckHealth(ctx, "invalid-url", tt.config)
            
            require.Error(t, err)
            assert.Contains(t, err.Error(), "已重试")
        })
    }
}
```

### 4. 测试超时机制

编写超时机制的测试用例：

```go
func TestGRPCHealthChecker_Timeout(t *testing.T) {
    tests := []struct {
        name    string
        config  RetryConfig
        wantErr bool
    }{
        {
            name: "超时测试",
            config: RetryConfig{
                MaxRetries: 1,
                RetryDelay: 100 * time.Millisecond,
                Timeout:    100 * time.Millisecond, // 很短的超时时间
            },
            wantErr: true,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            checker := NewGRPCHealthChecker(5 * time.Second)
            ctx := context.Background()
            
            // 使用无效URL触发超时
            _, err := checker.CheckHealth(ctx, "invalid-url", tt.config)
            
            if tt.wantErr {
                require.Error(t, err)
            }
        })
    }
}
```

### 5. 测试定时健康检查任务

在 `internal/pkg/service/health_check_task_test.go` 文件中创建测试：

```go
package service

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/require"
)

func TestHealthCheckTask_StartStop(t *testing.T) {
    tests := []struct {
        name    string
        wantErr bool
    }{
        {
            name:    "成功启动和停止任务",
            wantErr: false,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockModuleService := new(MockModuleService)
            mockRepo := new(MockModuleRepository)
            
            task := NewHealthCheckTask(mockModuleService, mockRepo, 100*time.Millisecond)
            
            ctx := context.Background()
            
            // 启动任务
            err := task.Start(ctx)
            if tt.wantErr {
                require.Error(t, err)
            } else {
                require.NoError(t, err)
                assert.True(t, task.IsRunning())
                
                // 等待一段时间让任务执行
                time.Sleep(200 * time.Millisecond)
                
                // 停止任务
                err = task.Stop()
                require.NoError(t, err)
                assert.False(t, task.IsRunning())
            }
        })
    }
}
```

### 6. 测试健康状态更新

编写健康状态更新的测试用例：

```go
func TestModuleService_UpdateModuleHealthStatus(t *testing.T) {
    tests := []struct {
        name        string
        moduleID    string
        setupMock   func(*MockModuleRepository, *MockHealthChecker)
        wantErr     bool
        errContains string
    }{
        {
            name:     "成功更新健康状态",
            moduleID: "test-module",
            setupMock: func(mRepo *MockModuleRepository, mChecker *MockHealthChecker) {
                module := &model.Module{
                    ID:             1,
                    ModuleID:       "test-module",
                    ModuleStatus:   string(model.ModuleStatusActive),
                    HealthCheckURL: "http://localhost:8080/health",
                }
                mRepo.On("GetByModuleID", mock.Anything, "test-module").Return(module, nil).Once()
                mChecker.On("CheckHealth", mock.Anything, "http://localhost:8080/health", mock.Anything).Return(grpc_health_v1.HealthCheckResponse_SERVING, nil)
                mRepo.On("Update", mock.Anything, mock.AnythingOfType("*model.Module")).Return(nil)
            },
            wantErr: false,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockRepo := new(MockModuleRepository)
            mockChecker := new(MockHealthChecker)
            tt.setupMock(mockRepo, mockChecker)
            
            service := NewModuleService(mockRepo, mockChecker)
            ctx := context.Background()
            
            err := service.UpdateModuleHealthStatus(ctx, tt.moduleID)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errContains != "" {
                    assert.Contains(t, err.Error(), tt.errContains)
                }
            } else {
                require.NoError(t, err)
            }
            
            mockRepo.AssertExpectations(t)
            mockChecker.AssertExpectations(t)
        })
    }
}
```

## 验收标准

1. **测试覆盖完整**
   - 所有健康检查相关方法都有测试用例
   - 测试覆盖正常情况、边界情况和异常情况
   - 测试覆盖率达标（核心业务逻辑80%以上）

2. **测试用例质量**
   - 使用表驱动测试
   - 测试用例名称清晰（使用中文）
   - 测试独立，不依赖执行顺序

3. **Mock使用正确**
   - 正确使用Mock gRPC客户端
   - Mock期望设置正确
   - 验证Mock调用

4. **代码规范符合要求**
   - 代码通过golangci-lint检查，无错误和警告
   - 测试用例描述和错误消息使用中文
   - 遵循Golang单元测试规范

## 相关文件

- `internal/pkg/service/grpc_health_checker_test.go` - gRPC健康检查单元测试
- `internal/pkg/service/health_check_task_test.go` - 定时健康检查任务单元测试
- `internal/pkg/service/module_service_test.go` - 模块服务层单元测试
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/golang.mdc` - Golang编码规范
- `.cursor/rules/testing.mdc` - 单元测试规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.0.0  
**最后更新**: 2026-01-03 14:22:42 CST

