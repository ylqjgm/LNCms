# TASK007-37: 创建CategoryService接口和实现

## 任务信息

**任务编号**: TASK007-37  
**父任务**: TASK007  
**任务名称**: 创建CategoryService接口和实现  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:36:14 CST

## 任务描述

创建分类服务，提供分类管理的业务逻辑。包括：1) 定义CategoryService接口（GetCategory、GetCategories、GetCategoryTree、CreateCategory、UpdateCategory、DeleteCategory等方法）；2) 实现分类查询（单个分类、分类列表、树形结构查询）；3) 实现分类创建、更新、删除；4) 实现业务验证逻辑。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK007-19（实现CategoryRepository接口和实现）

## 实现指南

### 1. 创建CategoryService接口文件

在 `internal/service/` 目录下创建 `category_service.go` 文件，定义CategoryService接口：

```go
package service

import (
    "context"
    "yourproject/internal/models"
)

// CategoryService 分类服务接口
// 提供分类管理的业务逻辑
type CategoryService interface {
    // GetCategory 根据ID获取分类
    GetCategory(ctx context.Context, id int64) (*models.Category, error)
    
    // GetCategories 获取分类列表（支持筛选）
    GetCategories(ctx context.Context, categoryType string) ([]*models.Category, error)
    
    // GetCategoryTree 获取分类树（树形结构）
    GetCategoryTree(ctx context.Context, categoryType string) ([]*models.Category, error)
    
    // CreateCategory 创建分类
    CreateCategory(ctx context.Context, category *models.Category) error
    
    // UpdateCategory 更新分类
    UpdateCategory(ctx context.Context, category *models.Category) error
    
    // DeleteCategory 删除分类
    DeleteCategory(ctx context.Context, id int64) error
}
```

### 2. 实现CategoryService接口

在同一个文件中实现CategoryService接口：

```go
// categoryService CategoryService的实现
type categoryService struct {
    categoryRepo repository.CategoryRepository
}

// NewCategoryService 创建CategoryService实例
func NewCategoryService(categoryRepo repository.CategoryRepository) CategoryService {
    return &categoryService{
        categoryRepo: categoryRepo,
    }
}

// GetCategory 根据ID获取分类
func (s *categoryService) GetCategory(ctx context.Context, id int64) (*models.Category, error) {
    if id <= 0 {
        return nil, errors.New("分类ID无效")
    }
    
    category, err := s.categoryRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("获取分类失败: %w", err)
    }
    
    return category, nil
}

// GetCategories 获取分类列表
func (s *categoryService) GetCategories(ctx context.Context, categoryType string) ([]*models.Category, error) {
    // 验证分类类型
    if categoryType != "" {
        validTypes := []string{"novel", "comic", "audio", "video"}
        isValid := false
        for _, validType := range validTypes {
            if categoryType == validType {
                isValid = true
                break
            }
        }
        if !isValid {
            return nil, errors.New("无效的分类类型")
        }
    }
    
    var categories []*models.Category
    var err error
    
    if categoryType != "" {
        categories, err = s.categoryRepo.GetByType(ctx, categoryType)
    } else {
        categories, err = s.categoryRepo.GetAll(ctx)
    }
    
    if err != nil {
        return nil, fmt.Errorf("获取分类列表失败: %w", err)
    }
    
    return categories, nil
}

// GetCategoryTree 获取分类树
func (s *categoryService) GetCategoryTree(ctx context.Context, categoryType string) ([]*models.Category, error) {
    // 获取所有分类
    allCategories, err := s.GetCategories(ctx, categoryType)
    if err != nil {
        return nil, err
    }
    
    // 如果指定了分类类型，只返回该类型的分类树
    if categoryType != "" {
        // 过滤出指定类型的分类
        filteredCategories := make([]*models.Category, 0)
        for _, category := range allCategories {
            if category.CategoryType == categoryType {
                filteredCategories = append(filteredCategories, category)
            }
        }
        allCategories = filteredCategories
    }
    
    // 构建分类树
    tree := s.buildCategoryTree(allCategories, nil)
    
    return tree, nil
}

// CreateCategory 创建分类
func (s *categoryService) CreateCategory(ctx context.Context, category *models.Category) error {
    // 业务验证
    if err := s.validateCategory(category); err != nil {
        return err
    }
    
    // 验证父分类是否存在
    if category.ParentID != nil {
        parent, err := s.categoryRepo.GetByID(ctx, *category.ParentID)
        if err != nil {
            return errors.New("父分类不存在")
        }
        // 验证父分类类型是否一致
        if parent.CategoryType != category.CategoryType {
            return errors.New("父分类类型与子分类类型不一致")
        }
    }
    
    // 创建分类
    if err := s.categoryRepo.Create(ctx, category); err != nil {
        return fmt.Errorf("创建分类失败: %w", err)
    }
    
    return nil
}

// UpdateCategory 更新分类
func (s *categoryService) UpdateCategory(ctx context.Context, category *models.Category) error {
    // 业务验证
    if err := s.validateCategory(category); err != nil {
        return err
    }
    
    // 检查分类是否存在
    existing, err := s.categoryRepo.GetByID(ctx, category.ID)
    if err != nil {
        return errors.New("分类不存在")
    }
    
    // 验证父分类（不能将自己设为父分类）
    if category.ParentID != nil && *category.ParentID == category.ID {
        return errors.New("不能将自己设为父分类")
    }
    
    // 验证父分类是否存在
    if category.ParentID != nil {
        parent, err := s.categoryRepo.GetByID(ctx, *category.ParentID)
        if err != nil {
            return errors.New("父分类不存在")
        }
        // 验证父分类类型是否一致
        if parent.CategoryType != category.CategoryType {
            return errors.New("父分类类型与子分类类型不一致")
        }
    }
    
    // 更新分类
    if err := s.categoryRepo.Update(ctx, category); err != nil {
        return fmt.Errorf("更新分类失败: %w", err)
    }
    
    return nil
}

// DeleteCategory 删除分类
func (s *categoryService) DeleteCategory(ctx context.Context, id int64) error {
    if id <= 0 {
        return errors.New("分类ID无效")
    }
    
    // 检查分类是否存在
    category, err := s.categoryRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("分类不存在")
    }
    
    // 检查是否有子分类
    children, err := s.categoryRepo.GetByParentID(ctx, &id)
    if err != nil {
        return fmt.Errorf("检查子分类失败: %w", err)
    }
    if len(children) > 0 {
        return errors.New("存在子分类，无法删除")
    }
    
    // 删除分类
    if err := s.categoryRepo.Delete(ctx, id); err != nil {
        return fmt.Errorf("删除分类失败: %w", err)
    }
    
    return nil
}

// validateCategory 验证分类数据
func (s *categoryService) validateCategory(category *models.Category) error {
    if category.CategoryName == "" {
        return errors.New("分类名称不能为空")
    }
    if len(category.CategoryName) > 100 {
        return errors.New("分类名称长度不能超过100个字符")
    }
    
    // 验证分类类型
    validTypes := []string{"novel", "comic", "audio", "video"}
    isValid := false
    for _, validType := range validTypes {
        if category.CategoryType == validType {
            isValid = true
            break
        }
    }
    if !isValid {
        return errors.New("无效的分类类型")
    }
    
    return nil
}

// buildCategoryTree 构建分类树
func (s *categoryService) buildCategoryTree(categories []*models.Category, parentID *int64) []*models.Category {
    var tree []*models.Category
    
    for _, category := range categories {
        var catParentID *int64
        if category.ParentID != nil {
            catParentID = category.ParentID
        }
        
        // 判断是否为当前父节点的子节点
        if (parentID == nil && catParentID == nil) || 
           (parentID != nil && catParentID != nil && *parentID == *catParentID) {
            // 递归构建子树
            category.Children = s.buildCategoryTree(categories, &category.ID)
            tree = append(tree, category)
        }
    }
    
    return tree
}
```

### 3. 添加必要的导入

```go
package service

import (
    "context"
    "errors"
    "fmt"
    
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 4. 注意事项

- **业务验证**：在Service层进行业务逻辑验证，包括数据有效性、业务规则等
- **错误处理**：所有错误消息必须使用中文
- **上下文传递**：所有方法都接受context.Context参数
- **树形结构**：实现分类树的构建逻辑
- **关联验证**：创建和更新时验证父分类的存在性和类型一致性
- **删除保护**：删除前检查是否存在子分类

## 验收标准

1. **接口定义完整**
   - CategoryService接口包含所有必需方法
   - 方法签名正确，参数和返回值类型正确

2. **实现完整**
   - 所有接口方法都已实现
   - 业务逻辑正确实现

3. **业务验证**
   - 分类数据验证正确
   - 父分类验证正确
   - 删除保护逻辑正确

4. **树形结构**
   - GetCategoryTree方法能正确构建分类树
   - 支持按分类类型筛选

5. **错误处理**
   - 所有错误消息使用中文
   - 错误处理完整、清晰

6. **代码规范**
   - 遵循Golang编码规范
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK007/TASK007-19.md` - CategoryRepository实现文档
- `docs/TASKS/TASK007/TASK007-01.md` - Category模型实现文档
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/category_service.go` - CategoryService接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:36:14 CST

