# TASK007-41: 创建NovelService接口和实现 - 状态和统计管理

## 任务信息

**任务编号**: TASK007-41  
**父任务**: TASK007  
**任务名称**: 创建NovelService接口和实现 - 状态和统计管理  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:43:24 CST

## 任务描述

扩展小说服务，提供小说状态管理和统计功能。包括：1) 扩展NovelService接口（UpdateStatus、UpdateWordCount、GetStatistics等方法）；2) 实现状态更新（草稿、审核中、已发布、已下架等）；3) 实现字数统计（自动计算总字数）；4) 实现统计信息查询。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK007-40（创建NovelService接口和实现 - 基础CRUD）、TASK007-24（实现NovelChapterRepository接口和实现）

## 实现指南

### 1. 扩展NovelService接口

在 `internal/service/novel_service.go` 文件中扩展NovelService接口，添加状态管理和统计方法：

```go
// NovelService 小说服务接口
// 提供小说管理的业务逻辑
type NovelService interface {
    // ... 基础CRUD方法（已在TASK007-40中定义）
    
    // UpdateStatus 更新小说状态
    UpdateStatus(ctx context.Context, id int64, status string) error
    
    // UpdateWordCount 更新小说字数（自动计算）
    UpdateWordCount(ctx context.Context, id int64) error
    
    // GetStatistics 获取小说统计信息
    GetStatistics(ctx context.Context, id int64) (*NovelStatistics, error)
}

// NovelStatistics 小说统计信息
type NovelStatistics struct {
    NovelID          int64 // 小说ID
    TotalChapters    int64 // 总章节数
    TotalWordCount   int64 // 总字数
    PublishedChapters int64 // 已发布章节数
    DraftChapters    int64 // 草稿章节数
    VipChapters      int64 // VIP章节数
}
```

### 2. 实现状态管理方法

在 `novel_service.go` 文件中扩展 `novelService` 结构体，添加状态管理方法实现：

```go
// UpdateStatus 更新小说状态
func (s *novelService) UpdateStatus(ctx context.Context, id int64, status string) error {
    if id <= 0 {
        return errors.New("小说ID无效")
    }
    
    // 验证状态
    validStatuses := []string{"draft", "reviewing", "published", "archived"}
    isValid := false
    for _, validStatus := range validStatuses {
        if status == validStatus {
            isValid = true
            break
        }
    }
    if !isValid {
        return errors.New("无效的小说状态")
    }
    
    // 检查小说是否存在
    _, err := s.novelRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("小说不存在")
    }
    
    // 更新状态
    if err := s.novelRepo.UpdateStatus(ctx, id, status); err != nil {
        return fmt.Errorf("更新小说状态失败: %w", err)
    }
    
    return nil
}

// UpdateWordCount 更新小说字数（自动计算）
func (s *novelService) UpdateWordCount(ctx context.Context, id int64) error {
    if id <= 0 {
        return errors.New("小说ID无效")
    }
    
    // 检查小说是否存在
    novel, err := s.novelRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("小说不存在")
    }
    
    // 获取所有已发布的章节
    chapterRepo := s.chapterRepo // 需要注入NovelChapterRepository
    chapters, _, err := chapterRepo.GetByNovelID(ctx, id, &repository.NovelChapterQueryParams{
        Page:     1,
        Limit:    10000, // 获取所有章节
        Status:   "published",
        OrderBy:  "sort_order",
        OrderDir: "asc",
    })
    if err != nil {
        return fmt.Errorf("查询章节失败: %w", err)
    }
    
    // 计算总字数
    var totalWordCount int64
    for _, chapter := range chapters {
        totalWordCount += chapter.WordCount
    }
    
    // 更新小说字数
    if err := s.novelRepo.UpdateWordCount(ctx, id, totalWordCount); err != nil {
        return fmt.Errorf("更新小说字数失败: %w", err)
    }
    
    return nil
}

// GetStatistics 获取小说统计信息
func (s *novelService) GetStatistics(ctx context.Context, id int64) (*NovelStatistics, error) {
    if id <= 0 {
        return nil, errors.New("小说ID无效")
    }
    
    // 检查小说是否存在
    novel, err := s.novelRepo.GetByID(ctx, id)
    if err != nil {
        return nil, errors.New("小说不存在")
    }
    
    // 获取所有章节
    chapterRepo := s.chapterRepo // 需要注入NovelChapterRepository
    chapters, _, err := chapterRepo.GetByNovelID(ctx, id, &repository.NovelChapterQueryParams{
        Page:     1,
        Limit:    10000, // 获取所有章节
        OrderBy:  "sort_order",
        OrderDir: "asc",
    })
    if err != nil {
        return nil, fmt.Errorf("查询章节失败: %w", err)
    }
    
    // 统计信息
    stats := &NovelStatistics{
        NovelID:          id,
        TotalWordCount:   novel.WordCount,
        TotalChapters:    int64(len(chapters)),
        PublishedChapters: 0,
        DraftChapters:    0,
        VipChapters:      0,
    }
    
    // 统计各状态章节数
    for _, chapter := range chapters {
        switch chapter.Status {
        case "published":
            stats.PublishedChapters++
        case "draft":
            stats.DraftChapters++
        }
        if chapter.IsVip {
            stats.VipChapters++
        }
    }
    
    return stats, nil
}
```

### 3. 更新novelService结构体

需要在 `novelService` 结构体中添加 `chapterRepo` 字段：

```go
// novelService NovelService的实现
type novelService struct {
    novelRepo    repository.NovelRepository
    chapterRepo  repository.NovelChapterRepository // 新增字段
    categorySvc  CategoryService
    tagSvc       TagService
}

// NewNovelService 创建NovelService实例
func NewNovelService(
    novelRepo repository.NovelRepository,
    chapterRepo repository.NovelChapterRepository, // 新增参数
    categorySvc CategoryService,
    tagSvc TagService,
) NovelService {
    return &novelService{
        novelRepo:   novelRepo,
        chapterRepo: chapterRepo, // 新增字段赋值
        categorySvc: categorySvc,
        tagSvc:      tagSvc,
    }
}
```

### 4. 注意事项

- **状态验证**：更新状态前验证状态值是否有效
- **字数统计**：自动计算所有已发布章节的总字数
- **统计信息**：提供完整的统计信息，包括章节数、字数、状态分布等
- **错误处理**：所有错误消息必须使用中文
- **依赖注入**：需要注入NovelChapterRepository以查询章节信息
- **性能考虑**：对于大量章节，考虑使用数据库聚合查询优化性能

## 验收标准

1. **接口扩展完整**
   - NovelService接口已扩展状态管理和统计方法
   - 方法签名正确，参数和返回值类型正确
   - NovelStatistics结构体定义完整

2. **状态管理实现**
   - UpdateStatus方法能正确更新小说状态
   - 状态验证逻辑正确
   - 错误处理完善

3. **字数统计实现**
   - UpdateWordCount方法能自动计算总字数
   - 正确统计所有已发布章节的字数
   - 更新操作正确执行

4. **统计信息实现**
   - GetStatistics方法能正确获取统计信息
   - 统计信息完整、准确
   - 包含所有必要的统计指标

5. **错误处理**
   - 所有错误消息使用中文
   - 错误处理完整、清晰

6. **代码规范**
   - 遵循Golang编码规范
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK007/TASK007-40.md` - NovelService基础CRUD实现文档
- `docs/TASKS/TASK007/TASK007-24.md` - NovelChapterRepository实现文档
- `docs/TASKS/TASK007/TASK007-22.md` - NovelRepository实现文档
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/novel_service.go` - NovelService接口和实现文件（待扩展）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:43:24 CST

