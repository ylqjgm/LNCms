# TASK007-39: 创建TagService接口和实现

## 任务信息

**任务编号**: TASK007-39  
**父任务**: TASK007  
**任务名称**: 创建TagService接口和实现  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:36:14 CST

## 任务描述

创建标签服务，提供标签管理的业务逻辑。包括：1) 定义TagService接口（GetTag、GetTags、CreateTag、UpdateTag、DeleteTag等方法）；2) 实现标签查询（单个标签、标签列表，支持分页和筛选）；3) 实现标签创建、更新、删除；4) 实现业务验证逻辑。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK007-21（实现TagRepository接口和实现）

## 实现指南

### 1. 创建TagService接口文件

在 `internal/service/` 目录下创建 `tag_service.go` 文件，定义TagService接口：

```go
package service

import (
    "context"
    "yourproject/internal/models"
)

// TagService 标签服务接口
// 提供标签管理的业务逻辑
type TagService interface {
    // GetTag 根据ID获取标签
    GetTag(ctx context.Context, id int64) (*models.Tag, error)
    
    // GetTags 获取标签列表（支持分页、筛选）
    GetTags(ctx context.Context, params *TagQueryParams) ([]*models.Tag, int64, error)
    
    // CreateTag 创建标签
    CreateTag(ctx context.Context, tag *models.Tag) error
    
    // UpdateTag 更新标签
    UpdateTag(ctx context.Context, tag *models.Tag) error
    
    // DeleteTag 删除标签
    DeleteTag(ctx context.Context, id int64) error
}

// TagQueryParams 标签查询参数
type TagQueryParams struct {
    Page     int    // 页码，从1开始
    Limit    int    // 每页数量
    Name     string // 标签名筛选（模糊匹配）
    IsActive *bool  // 是否启用筛选
    OrderBy  string // 排序字段（name、created_at、updated_at）
    OrderDir string // 排序方向（asc、desc）
}
```

### 2. 实现TagService接口

在同一个文件中实现TagService接口：

```go
// tagService TagService的实现
type tagService struct {
    tagRepo repository.TagRepository
}

// NewTagService 创建TagService实例
func NewTagService(tagRepo repository.TagRepository) TagService {
    return &tagService{
        tagRepo: tagRepo,
    }
}

// GetTag 根据ID获取标签
func (s *tagService) GetTag(ctx context.Context, id int64) (*models.Tag, error) {
    if id <= 0 {
        return nil, errors.New("标签ID无效")
    }
    
    tag, err := s.tagRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("获取标签失败: %w", err)
    }
    
    return tag, nil
}

// GetTags 获取标签列表
func (s *tagService) GetTags(ctx context.Context, params *TagQueryParams) ([]*models.Tag, int64, error) {
    // 构建查询参数
    queryParams := &repository.TagQueryParams{
        Page:     params.Page,
        Limit:    params.Limit,
        Name:     params.Name,
        IsActive: params.IsActive,
        OrderBy:  params.OrderBy,
        OrderDir: params.OrderDir,
    }
    
    // 验证和设置默认值
    if queryParams.Page < 1 {
        queryParams.Page = 1
    }
    if queryParams.Limit < 1 {
        queryParams.Limit = 20
    }
    if queryParams.Limit > 100 {
        queryParams.Limit = 100
    }
    if queryParams.OrderBy == "" {
        queryParams.OrderBy = "created_at"
    }
    if queryParams.OrderDir == "" {
        queryParams.OrderDir = "desc"
    }
    
    tags, total, err := s.tagRepo.GetAll(ctx, queryParams)
    if err != nil {
        return nil, 0, fmt.Errorf("获取标签列表失败: %w", err)
    }
    
    return tags, total, nil
}

// CreateTag 创建标签
func (s *tagService) CreateTag(ctx context.Context, tag *models.Tag) error {
    // 业务验证
    if err := s.validateTag(tag); err != nil {
        return err
    }
    
    // 检查标签名是否已存在
    existing, err := s.tagRepo.GetByName(ctx, tag.TagName)
    if err == nil && existing != nil {
        return errors.New("标签名已存在")
    }
    
    // 创建标签
    if err := s.tagRepo.Create(ctx, tag); err != nil {
        return fmt.Errorf("创建标签失败: %w", err)
    }
    
    return nil
}

// UpdateTag 更新标签
func (s *tagService) UpdateTag(ctx context.Context, tag *models.Tag) error {
    // 业务验证
    if err := s.validateTag(tag); err != nil {
        return err
    }
    
    // 检查标签是否存在
    existing, err := s.tagRepo.GetByID(ctx, tag.ID)
    if err != nil {
        return errors.New("标签不存在")
    }
    
    // 如果标签名改变，检查新标签名是否已存在
    if tag.TagName != existing.TagName {
        duplicate, err := s.tagRepo.GetByName(ctx, tag.TagName)
        if err == nil && duplicate != nil && duplicate.ID != tag.ID {
            return errors.New("标签名已存在")
        }
    }
    
    // 更新标签
    if err := s.tagRepo.Update(ctx, tag); err != nil {
        return fmt.Errorf("更新标签失败: %w", err)
    }
    
    return nil
}

// DeleteTag 删除标签
func (s *tagService) DeleteTag(ctx context.Context, id int64) error {
    if id <= 0 {
        return errors.New("标签ID无效")
    }
    
    // 检查标签是否存在
    tag, err := s.tagRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("标签不存在")
    }
    
    // 删除标签
    if err := s.tagRepo.Delete(ctx, id); err != nil {
        return fmt.Errorf("删除标签失败: %w", err)
    }
    
    return nil
}

// validateTag 验证标签数据
func (s *tagService) validateTag(tag *models.Tag) error {
    if tag.TagName == "" {
        return errors.New("标签名不能为空")
    }
    if len(tag.TagName) > 50 {
        return errors.New("标签名长度不能超过50个字符")
    }
    
    return nil
}
```

### 3. 添加必要的导入

```go
package service

import (
    "context"
    "errors"
    "fmt"
    
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 4. 注意事项

- **业务验证**：在Service层进行业务逻辑验证，包括数据有效性、业务规则等
- **错误处理**：所有错误消息必须使用中文
- **上下文传递**：所有方法都接受context.Context参数
- **唯一性验证**：创建和更新时验证标签名的唯一性
- **分页处理**：GetTags方法支持分页，需要验证分页参数

## 验收标准

1. **接口定义完整**
   - TagService接口包含所有必需方法
   - 方法签名正确，参数和返回值类型正确
   - TagQueryParams结构体定义完整

2. **实现完整**
   - 所有接口方法都已实现
   - 业务逻辑正确实现

3. **业务验证**
   - 标签数据验证正确
   - 标签名唯一性验证正确

4. **查询功能**
   - GetTags方法支持分页、筛选、排序
   - 分页参数验证正确

5. **错误处理**
   - 所有错误消息使用中文
   - 错误处理完整、清晰

6. **代码规范**
   - 遵循Golang编码规范
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK007/TASK007-21.md` - TagRepository实现文档
- `docs/TASKS/TASK007/TASK007-03.md` - Tag模型实现文档
- `docs/TASKS/TASK007/TASK007-37.md` - CategoryService实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/tag_service.go` - TagService接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:36:14 CST

