# TASK007-09: 创建ComicChapter模型

## 任务信息

**任务编号**: TASK007-09  
**父任务**: TASK007  
**任务名称**: 创建ComicChapter模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 22:57:58 CST

## 任务描述

创建漫画章节管理的GORM模型，定义漫画章节表结构。包括：1) 创建ComicChapter模型，定义字段（包含comic_id、title、description、sort_order、status、is_vip等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范。

## 依赖任务

TASK007-08（Comic模型）

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-24.md` 文档，了解comic_chapters表的完整设计：
- 表结构：id、comic_id、chapter_name、chapter_description、chapter_order、image_count、is_published、is_vip、published_at、view_count、created_at、updated_at
- 外键关联：comic_id 关联 comics 表
- 唯一约束：comic_id + chapter_order 必须唯一
- 索引：comic_id、chapter_order、is_published、is_vip、published_at

### 2. 创建ComicChapter模型文件

在 `internal/models/` 目录下创建 `comic_chapter.go` 文件，定义ComicChapter模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// ComicChapter 漫画章节模型
// 存储漫画章节信息，包括章节名称、描述、排序等
// 关联漫画信息
type ComicChapter struct {
    ID                int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    ComicID           int64          `gorm:"column:comic_id;type:BIGINT;not null;index:idx_comic_chapters_comic_id;uniqueIndex:uk_comic_chapters_comic_id_chapter_order" json:"comic_id"`
    ChapterName       string         `gorm:"column:chapter_name;type:VARCHAR(200);not null" json:"chapter_name"`
    ChapterDescription *string        `gorm:"column:chapter_description;type:TEXT" json:"chapter_description,omitempty"`
    ChapterOrder      int            `gorm:"column:chapter_order;type:INTEGER;not null;default:0;index:idx_comic_chapters_chapter_order;uniqueIndex:uk_comic_chapters_comic_id_chapter_order" json:"chapter_order"`
    ImageCount        int            `gorm:"column:image_count;type:INTEGER;default:0" json:"image_count"`
    IsPublished        bool           `gorm:"column:is_published;type:BOOLEAN;default:false;index:idx_comic_chapters_is_published" json:"is_published"`
    IsVip            bool           `gorm:"column:is_vip;type:BOOLEAN;default:false;index:idx_comic_chapters_is_vip" json:"is_vip"`
    PublishedAt       *time.Time     `gorm:"column:published_at;type:TIMESTAMPTZ;index:idx_comic_chapters_published_at" json:"published_at,omitempty"`
    ViewCount         int64          `gorm:"column:view_count;type:BIGINT;default:0" json:"view_count"`
    CreatedAt         time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    UpdatedAt         time.Time      `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    Comic *Comic `gorm:"foreignKey:ComicID;references:ID" json:"comic,omitempty"`
}

// TableName 指定表名
func (ComicChapter) TableName() string {
    return "comic_chapters"
}

// BeforeCreate 创建前钩子
func (cc *ComicChapter) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if cc.CreatedAt.IsZero() {
        cc.CreatedAt = now
    }
    if cc.UpdatedAt.IsZero() {
        cc.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (cc *ComicChapter) BeforeUpdate(tx *gorm.DB) error {
    cc.UpdatedAt = time.Now()
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// ComicChapter 漫画章节模型
// 存储漫画章节信息，包括章节名称、描述、排序等
// 关联漫画信息
// 同一漫画的章节排序必须唯一
type ComicChapter struct {
    // ID 章节ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // ComicID 漫画ID，外键关联comics表，必填字段
    ComicID int64 `gorm:"column:comic_id;type:BIGINT;not null;index:idx_comic_chapters_comic_id;uniqueIndex:uk_comic_chapters_comic_id_chapter_order" json:"comic_id"`
    
    // ChapterName 章节名称，必填字段
    ChapterName string `gorm:"column:chapter_name;type:VARCHAR(200);not null" json:"chapter_name"`
    
    // ChapterDescription 章节描述，可选字段
    ChapterDescription *string `gorm:"column:chapter_description;type:TEXT" json:"chapter_description,omitempty"`
    
    // ChapterOrder 章节排序，数字越小越靠前，用于排序显示，默认值为0
    // 同一漫画的章节排序必须唯一
    ChapterOrder int `gorm:"column:chapter_order;type:INTEGER;not null;default:0;index:idx_comic_chapters_chapter_order;uniqueIndex:uk_comic_chapters_comic_id_chapter_order" json:"chapter_order"`
    
    // ImageCount 图片数量，章节包含的图片数量，默认值为0
    ImageCount int `gorm:"column:image_count;type:INTEGER;default:0" json:"image_count"`
    
    // IsPublished 是否发布，TRUE-已发布，FALSE-未发布，默认值为FALSE
    IsPublished bool `gorm:"column:is_published;type:BOOLEAN;default:false;index:idx_comic_chapters_is_published" json:"is_published"`
    
    // IsVip 是否VIP章节，TRUE-VIP章节需要付费，FALSE-免费章节，默认值为FALSE
    IsVip bool `gorm:"column:is_vip;type:BOOLEAN;default:false;index:idx_comic_chapters_is_vip" json:"is_vip"`
    
    // PublishedAt 发布时间，可选字段
    PublishedAt *time.Time `gorm:"column:published_at;type:TIMESTAMPTZ;index:idx_comic_chapters_published_at" json:"published_at,omitempty"`
    
    // ViewCount 浏览次数，默认值为0
    ViewCount int64 `gorm:"column:view_count;type:BIGINT;default:0" json:"view_count"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    // Comic 漫画，多对一关系
    Comic *Comic `gorm:"foreignKey:ComicID;references:ID" json:"comic,omitempty"`
}
```

### 4. 定义模型方法

为ComicChapter模型添加常用的辅助方法：

```go
// IsPublishedStatus 检查是否已发布
func (cc *ComicChapter) IsPublishedStatus() bool {
    return cc.IsPublished
}

// IsVipChapter 检查是否为VIP章节
func (cc *ComicChapter) IsVipChapter() bool {
    return cc.IsVip
}

// HasDescription 检查是否有章节描述
func (cc *ComicChapter) HasDescription() bool {
    return cc.ChapterDescription != nil && *cc.ChapterDescription != ""
}

// HasImages 检查是否有图片
func (cc *ComicChapter) HasImages() bool {
    return cc.ImageCount > 0
}
```

### 5. 注意事项

- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **唯一索引**：comic_id + chapter_order 使用uniqueIndex标签定义复合唯一索引，确保同一漫画的章节排序唯一
- **索引定义**：在GORM标签中定义索引，包括唯一索引和普通索引
- **外键关联**：使用GORM的foreignKey和references标签定义关联关系
- **JSON标签**：所有字段都应有JSON标签，可选字段使用omitempty
- **指针类型**：可选字段（如ChapterDescription、PublishedAt）使用指针类型，支持NULL值
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **唯一约束**：comic_id + chapter_order 的复合唯一约束需要在应用层进行验证

## 验收标准

1. **模型结构完整**
   - ComicChapter模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 外键索引：comic_id
   - 普通索引：chapter_order、is_published、is_vip、published_at
   - 复合唯一索引：comic_id + chapter_order
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - Comic关联关系正确

4. **唯一约束正确**
   - comic_id + chapter_order 使用uniqueIndex标签，确保唯一性

5. **模型方法完整**
   - IsPublishedStatus方法实现正确
   - IsVipChapter方法实现正确
   - HasDescription方法实现正确
   - HasImages方法实现正确

6. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

7. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/TASK002-24.md` - 漫画章节表数据库设计文档
- `docs/TASKS/TASK007/TASK007-08.md` - Comic模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/comic_chapter.go` - ComicChapter模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 22:57:58 CST

