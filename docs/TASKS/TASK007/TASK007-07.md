# TASK007-07: 创建NovelChapterAttachment模型

## 任务信息

**任务编号**: TASK007-07  
**父任务**: TASK007  
**任务名称**: 创建NovelChapterAttachment模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 22:57:58 CST

## 任务描述

创建小说章节附件管理的GORM模型，定义小说章节附件表结构。包括：1) 创建NovelChapterAttachment模型，定义字段（包含chapter_id、file_id、file_name、file_type、file_size、sort_order等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范。注意：附件表关联核心模块的files表（而非存储模块的files表），以支持存储模块可选性。

## 依赖任务

TASK007-06（NovelChapter模型）

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-22.md` 文档，了解novel_chapter_attachments表的完整设计：
- 表结构：id、chapter_id、file_id、attachment_type、attachment_order、created_at
- 外键关联：chapter_id 关联 novel_chapters 表、file_id 关联核心模块 files 表
- 检查约束：attachment_type 必须是 'image'、'audio'、'video'、'document' 之一
- 索引：chapter_id、file_id、attachment_type、attachment_order、复合索引 (chapter_id, attachment_order)

### 2. 创建NovelChapterAttachment模型文件

在 `internal/models/` 目录下创建 `novel_chapter_attachment.go` 文件，定义NovelChapterAttachment模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// NovelChapterAttachment 小说章节附件模型
// 存储小说章节附件信息，包括图片、音频、视频、文档等附件
// 附件关联核心模块的files表（而非存储模块的files表），以支持存储模块可选性
type NovelChapterAttachment struct {
    ID              int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    ChapterID       int64          `gorm:"column:chapter_id;type:BIGINT;not null;index:idx_novel_chapter_attachments_chapter_id;index:idx_novel_chapter_attachments_chapter_order" json:"chapter_id"`
    FileID          int64          `gorm:"column:file_id;type:BIGINT;not null;index:idx_novel_chapter_attachments_file_id" json:"file_id"`
    AttachmentType  string         `gorm:"column:attachment_type;type:VARCHAR(50);not null;index:idx_novel_chapter_attachments_attachment_type" json:"attachment_type"`
    AttachmentOrder int            `gorm:"column:attachment_order;type:INTEGER;not null;default:0;index:idx_novel_chapter_attachments_attachment_order;index:idx_novel_chapter_attachments_chapter_order" json:"attachment_order"`
    CreatedAt       time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // 关联关系
    Chapter *NovelChapter `gorm:"foreignKey:ChapterID;references:ID" json:"chapter,omitempty"`
    File    *File         `gorm:"foreignKey:FileID;references:ID" json:"file,omitempty"`
}

// TableName 指定表名
func (NovelChapterAttachment) TableName() string {
    return "novel_chapter_attachments"
}

// BeforeCreate 创建前钩子
func (nca *NovelChapterAttachment) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if nca.CreatedAt.IsZero() {
        nca.CreatedAt = now
    }
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// NovelChapterAttachment 小说章节附件模型
// 存储小说章节附件信息，包括图片、音频、视频、文档等附件
// 附件关联核心模块的files表（而非存储模块的files表），以支持存储模块可选性
// 文件URL通过files表的storage_url字段获取，不在附件表中重复存储
type NovelChapterAttachment struct {
    // ID 附件ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // ChapterID 章节ID，外键关联novel_chapters表，必填字段
    ChapterID int64 `gorm:"column:chapter_id;type:BIGINT;not null;index:idx_novel_chapter_attachments_chapter_id;index:idx_novel_chapter_attachments_chapter_order" json:"chapter_id"`
    
    // FileID 文件ID，外键关联核心模块files表，必填字段
    // 注意：关联核心模块的files表，而非存储模块的files表
    FileID int64 `gorm:"column:file_id;type:BIGINT;not null;index:idx_novel_chapter_attachments_file_id" json:"file_id"`
    
    // AttachmentType 附件类型：image-图片、audio-音频、video-视频、document-文档
    // 必须符合检查约束：IN ('image', 'audio', 'video', 'document')
    AttachmentType string `gorm:"column:attachment_type;type:VARCHAR(50);not null;index:idx_novel_chapter_attachments_attachment_type" json:"attachment_type"`
    
    // AttachmentOrder 附件排序，数字越小越靠前，用于排序显示，默认值为0
    AttachmentOrder int `gorm:"column:attachment_order;type:INTEGER;not null;default:0;index:idx_novel_chapter_attachments_attachment_order;index:idx_novel_chapter_attachments_chapter_order" json:"attachment_order"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // 关联关系
    // Chapter 章节，多对一关系
    Chapter *NovelChapter `gorm:"foreignKey:ChapterID;references:ID" json:"chapter,omitempty"`
    
    // File 文件，多对一关系，关联核心模块files表
    File *File `gorm:"foreignKey:FileID;references:ID" json:"file,omitempty"`
}
```

### 4. 定义模型方法

为NovelChapterAttachment模型添加常用的辅助方法：

```go
// ValidateAttachmentType 验证附件类型是否有效
func (nca *NovelChapterAttachment) ValidateAttachmentType() bool {
    validTypes := []string{"image", "audio", "video", "document"}
    for _, validType := range validTypes {
        if nca.AttachmentType == validType {
            return true
        }
    }
    return false
}

// GetAttachmentTypeName 获取附件类型的中文名称
func (nca *NovelChapterAttachment) GetAttachmentTypeName() string {
    typeNames := map[string]string{
        "image":    "图片",
        "audio":    "音频",
        "video":    "视频",
        "document": "文档",
    }
    if name, ok := typeNames[nca.AttachmentType]; ok {
        return name
    }
    return "未知"
}

// IsImage 检查是否为图片附件
func (nca *NovelChapterAttachment) IsImage() bool {
    return nca.AttachmentType == "image"
}

// IsAudio 检查是否为音频附件
func (nca *NovelChapterAttachment) IsAudio() bool {
    return nca.AttachmentType == "audio"
}

// IsVideo 检查是否为视频附件
func (nca *NovelChapterAttachment) IsVideo() bool {
    return nca.AttachmentType == "video"
}

// IsDocument 检查是否为文档附件
func (nca *NovelChapterAttachment) IsDocument() bool {
    return nca.AttachmentType == "document"
}
```

### 5. 注意事项

- **文件表关联**：附件表关联核心模块的files表（而非存储模块的files表），以支持存储模块可选性
- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **索引定义**：在GORM标签中定义索引，包括普通索引和复合索引
- **外键关联**：使用GORM的foreignKey和references标签定义关联关系
- **检查约束**：attachment_type字段需要在应用层进行验证，确保符合数据库约束
- **JSON标签**：所有字段都应有JSON标签
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **文件URL获取**：文件URL通过files表的storage_url字段获取，不在附件表中重复存储
- **存储模块支持**：如果使用存储模块，文件信息通过gRPC同步到核心模块files表

## 验收标准

1. **模型结构完整**
   - NovelChapterAttachment模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 外键索引：chapter_id、file_id
   - 普通索引：attachment_type、attachment_order
   - 复合索引：chapter_id + attachment_order
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - Chapter关联关系正确
   - File关联关系正确（关联核心模块files表）

4. **检查约束处理**
   - attachment_type字段在应用层进行验证

5. **模型方法完整**
   - ValidateAttachmentType方法实现正确
   - GetAttachmentTypeName方法实现正确
   - IsImage方法实现正确
   - IsAudio方法实现正确
   - IsVideo方法实现正确
   - IsDocument方法实现正确

6. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

7. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/TASK002-22.md` - 小说章节附件表数据库设计文档
- `docs/TASKS/TASK007/TASK007-06.md` - NovelChapter模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/novel_chapter_attachment.go` - NovelChapterAttachment模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 22:57:58 CST

