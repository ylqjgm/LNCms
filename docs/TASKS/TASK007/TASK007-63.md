# TASK007-63: 创建ComicHandler接口和实现 - 创建、更新和删除API

## 任务信息

**任务编号**: TASK007-63  
**父任务**: TASK007  
**任务名称**: 创建ComicHandler接口和实现 - 创建、更新和删除API  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-04 00:01:47 CST

## 任务描述

扩展漫画控制器，提供漫画创建、更新、状态管理和删除的HTTP API处理。包括：1) 扩展ComicHandler接口；2) 实现CreateComic、UpdateComic、UpdateComicStatus、DeleteComic方法；3) 调用ComicService；4) 格式化响应（Envelope格式）。所有代码必须遵循API设计规范。

## 依赖任务

TASK007-62（创建ComicHandler接口和实现 - 列表和详情API）、TASK007-44（创建ComicService接口和实现 - 基础CRUD）、TASK007-45（创建ComicService接口和实现 - 状态管理）

## 实现指南

### 1. 扩展ComicHandler接口

在 `internal/handler/comic_handler.go` 文件中扩展ComicHandler接口：

```go
// ComicHandler 漫画控制器接口
// 提供漫画管理的HTTP API处理
type ComicHandler interface {
    // GetComics 获取漫画列表（支持分页、筛选、排序）
    GetComics(c *gin.Context)
    
    // GetComic 根据ID获取漫画
    GetComic(c *gin.Context)
    
    // CreateComic 创建漫画（需要作者或管理员权限）
    CreateComic(c *gin.Context)
    
    // UpdateComic 更新漫画（需要作者或管理员权限）
    UpdateComic(c *gin.Context)
    
    // UpdateComicStatus 更新漫画状态（需要作者或管理员权限）
    UpdateComicStatus(c *gin.Context)
    
    // DeleteComic 删除漫画（需要作者或管理员权限）
    DeleteComic(c *gin.Context)
}
```

### 2. 定义请求结构体

在同一个文件中添加请求结构体：

```go
// CreateComicRequest 创建漫画请求
type CreateComicRequest struct {
    Title        string   `json:"title" binding:"required"`
    Description  *string  `json:"description,omitempty"`
    AuthorID     int64    `json:"author_id" binding:"required"`
    RegionID     *int64   `json:"region_id,omitempty"`
    TagIDs       []int64  `json:"tag_ids,omitempty"`
    CoverURL     *string  `json:"cover_url,omitempty"`
    Status       string   `json:"status"`
    SerialStatus string   `json:"serial_status"`
    Rating       float64  `json:"rating"`
    IsActive     *bool    `json:"is_active"`
}

// UpdateComicRequest 更新漫画请求
type UpdateComicRequest struct {
    Title        string   `json:"title" binding:"required"`
    Description  *string  `json:"description,omitempty"`
    AuthorID     int64    `json:"author_id" binding:"required"`
    RegionID     *int64   `json:"region_id,omitempty"`
    TagIDs       []int64  `json:"tag_ids,omitempty"`
    CoverURL     *string  `json:"cover_url,omitempty"`
    Status       string   `json:"status"`
    SerialStatus string   `json:"serial_status"`
    Rating       float64  `json:"rating"`
    IsActive     *bool    `json:"is_active"`
}

// UpdateComicStatusRequest 更新漫画状态请求
type UpdateComicStatusRequest struct {
    Status string `json:"status" binding:"required"`
}
```

### 3. 实现CreateComic方法

在 `comicHandler` 结构体中实现 `CreateComic` 方法：

```go
// CreateComic 创建漫画
func (h *comicHandler) CreateComic(c *gin.Context) {
    var req CreateComicRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "VALIDATION_ERROR", "请求参数验证失败", "")
        return
    }
    
    ctx := c.Request.Context()
    
    // 获取当前用户信息（从JWT token中获取）
    userID, exists := c.Get("user_id")
    if !exists {
        response.BuildErrorResponse(c, http.StatusUnauthorized, "UNAUTHORIZED", "未授权", "")
        return
    }
    
    // 检查权限：只有作者或管理员可以创建漫画
    userRole, exists := c.Get("user_role")
    if !exists {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足", "")
        return
    }
    
    role := userRole.(string)
    if role != "author" && role != "admin" {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足：需要作者或管理员权限", "")
        return
    }
    
    // 构建漫画模型
    comic := &models.Comic{
        Title:        req.Title,
        Description:  req.Description,
        AuthorID:     req.AuthorID,
        RegionID:     req.RegionID,
        TagIDs:       req.TagIDs,
        CoverURL:     req.CoverURL,
        Status:       req.Status,
        SerialStatus: req.SerialStatus,
        Rating:       req.Rating,
        IsActive:     req.IsActive,
    }
    
    if err := h.comicSvc.CreateComic(ctx, comic); err != nil {
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("创建漫画失败: %v", err), "")
        return
    }
    
    response.BuildSuccessResponse(c, comic)
}
```

### 4. 实现UpdateComic方法

在 `comicHandler` 结构体中实现 `UpdateComic` 方法：

```go
// UpdateComic 更新漫画
func (h *comicHandler) UpdateComic(c *gin.Context) {
    // 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "漫画ID无效", "id")
        return
    }
    
    var req UpdateComicRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "VALIDATION_ERROR", "请求参数验证失败", "")
        return
    }
    
    ctx := c.Request.Context()
    
    // 获取当前用户信息（从JWT token中获取）
    userID, exists := c.Get("user_id")
    if !exists {
        response.BuildErrorResponse(c, http.StatusUnauthorized, "UNAUTHORIZED", "未授权", "")
        return
    }
    
    // 检查权限：只有作者或管理员可以更新漫画
    userRole, exists := c.Get("user_role")
    if !exists {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足", "")
        return
    }
    
    role := userRole.(string)
    if role != "author" && role != "admin" {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足：需要作者或管理员权限", "")
        return
    }
    
    // 检查漫画是否存在
    existing, err := h.comicSvc.GetComic(ctx, id)
    if err != nil {
        if errors.Is(err, repository.ErrComicNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "COMIC_NOT_FOUND", "漫画不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", "获取漫画失败", "")
        return
    }
    
    // 检查权限：作者只能更新自己的漫画，管理员可以更新所有漫画
    if role == "author" && existing.AuthorID != userID.(int64) {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足：只能更新自己的漫画", "")
        return
    }
    
    // 构建漫画模型
    comic := &models.Comic{
        ID:           id,
        Title:        req.Title,
        Description:  req.Description,
        AuthorID:     req.AuthorID,
        RegionID:     req.RegionID,
        TagIDs:       req.TagIDs,
        CoverURL:     req.CoverURL,
        Status:       req.Status,
        SerialStatus: req.SerialStatus,
        Rating:       req.Rating,
        IsActive:     req.IsActive,
    }
    
    if err := h.comicSvc.UpdateComic(ctx, comic); err != nil {
        if errors.Is(err, repository.ErrComicNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "COMIC_NOT_FOUND", "漫画不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("更新漫画失败: %v", err), "")
        return
    }
    
    response.BuildSuccessResponse(c, comic)
}
```

### 5. 实现UpdateComicStatus方法

在 `comicHandler` 结构体中实现 `UpdateComicStatus` 方法：

```go
// UpdateComicStatus 更新漫画状态
func (h *comicHandler) UpdateComicStatus(c *gin.Context) {
    // 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "漫画ID无效", "id")
        return
    }
    
    var req UpdateComicStatusRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "VALIDATION_ERROR", "请求参数验证失败", "")
        return
    }
    
    ctx := c.Request.Context()
    
    // 获取当前用户信息（从JWT token中获取）
    userID, exists := c.Get("user_id")
    if !exists {
        response.BuildErrorResponse(c, http.StatusUnauthorized, "UNAUTHORIZED", "未授权", "")
        return
    }
    
    // 检查权限：只有作者或管理员可以更新漫画状态
    userRole, exists := c.Get("user_role")
    if !exists {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足", "")
        return
    }
    
    role := userRole.(string)
    if role != "author" && role != "admin" {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足：需要作者或管理员权限", "")
        return
    }
    
    // 检查漫画是否存在
    existing, err := h.comicSvc.GetComic(ctx, id)
    if err != nil {
        if errors.Is(err, repository.ErrComicNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "COMIC_NOT_FOUND", "漫画不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", "获取漫画失败", "")
        return
    }
    
    // 检查权限：作者只能更新自己的漫画状态，管理员可以更新所有漫画状态
    if role == "author" && existing.AuthorID != userID.(int64) {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足：只能更新自己的漫画状态", "")
        return
    }
    
    // 更新漫画状态
    if err := h.comicSvc.UpdateStatus(ctx, id, req.Status); err != nil {
        if errors.Is(err, repository.ErrComicNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "COMIC_NOT_FOUND", "漫画不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("更新漫画状态失败: %v", err), "")
        return
    }
    
    // 获取更新后的漫画信息
    comic, err := h.comicSvc.GetComic(ctx, id)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", "获取漫画失败", "")
        return
    }
    
    response.BuildSuccessResponse(c, comic)
}
```

### 6. 实现DeleteComic方法

在 `comicHandler` 结构体中实现 `DeleteComic` 方法：

```go
// DeleteComic 删除漫画
func (h *comicHandler) DeleteComic(c *gin.Context) {
    // 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "漫画ID无效", "id")
        return
    }
    
    ctx := c.Request.Context()
    
    // 获取当前用户信息（从JWT token中获取）
    userID, exists := c.Get("user_id")
    if !exists {
        response.BuildErrorResponse(c, http.StatusUnauthorized, "UNAUTHORIZED", "未授权", "")
        return
    }
    
    // 检查权限：只有作者或管理员可以删除漫画
    userRole, exists := c.Get("user_role")
    if !exists {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足", "")
        return
    }
    
    role := userRole.(string)
    if role != "author" && role != "admin" {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足：需要作者或管理员权限", "")
        return
    }
    
    // 检查漫画是否存在
    existing, err := h.comicSvc.GetComic(ctx, id)
    if err != nil {
        if errors.Is(err, repository.ErrComicNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "COMIC_NOT_FOUND", "漫画不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", "获取漫画失败", "")
        return
    }
    
    // 检查权限：作者只能删除自己的漫画，管理员可以删除所有漫画
    if role == "author" && existing.AuthorID != userID.(int64) {
        response.BuildErrorResponse(c, http.StatusForbidden, "FORBIDDEN", "权限不足：只能删除自己的漫画", "")
        return
    }
    
    // 删除漫画
    if err := h.comicSvc.DeleteComic(ctx, id); err != nil {
        if errors.Is(err, repository.ErrComicNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "COMIC_NOT_FOUND", "漫画不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("删除漫画失败: %v", err), "")
        return
    }
    
    response.BuildSuccessResponse(c, nil)
}
```

### 7. 添加必要的导入

确保文件包含以下导入：

```go
package handler

import (
    "errors"
    "fmt"
    "net/http"
    "strconv"
    
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/models"
    "yourproject/internal/repository"
    "yourproject/internal/response"
    "yourproject/internal/service"
)
```

### 8. 注意事项

- **API规范**：所有API必须遵循OpenAPI 3.1.1规范
- **响应格式**：所有响应必须使用Envelope格式
- **权限验证**：创建、更新、删除操作需要作者或管理员权限（通过中间件和Handler中验证）
- **资源权限**：作者只能操作自己的漫画，管理员可以操作所有漫画
- **参数验证**：使用Gin的binding进行请求参数验证
- **错误处理**：所有错误消息必须使用中文
- **JWT认证**：从JWT token中获取用户ID和角色信息

## 验收标准

1. **接口扩展完整**
   - ComicHandler接口包含CreateComic、UpdateComic、UpdateComicStatus和DeleteComic方法
   - 方法签名正确

2. **请求处理完整**
   - CreateComic方法正确创建漫画
   - UpdateComic方法正确更新漫画
   - UpdateComicStatus方法正确更新漫画状态
   - DeleteComic方法正确删除漫画
   - 权限验证正确

3. **权限控制**
   - 创建操作需要作者或管理员权限
   - 更新操作需要作者或管理员权限
   - 状态更新操作需要作者或管理员权限
   - 删除操作需要作者或管理员权限
   - 作者只能操作自己的漫画
   - 管理员可以操作所有漫画

4. **响应格式**
   - 所有响应使用Envelope格式
   - 成功响应格式正确
   - 错误响应格式正确

5. **错误处理**
   - 所有错误消息使用中文
   - HTTP状态码使用正确
   - 错误代码定义清晰

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK007/TASK007-62.md` - ComicHandler列表和详情API实现文档
- `docs/TASKS/TASK007/TASK007-44.md` - ComicService实现文档
- `docs/TASKS/TASK007/TASK007-45.md` - ComicService状态管理实现文档
- `docs/TASKS/TASK007/TASK007-59.md` - NovelHandler创建和更新API实现参考
- `.cursor/rules/api-design.mdc` - API设计规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/handler/comic_handler.go` - ComicHandler接口和实现文件（待扩展）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-04 00:01:47 CST

