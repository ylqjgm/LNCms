# TASK007-14: 创建AudioFile模型

## 任务信息

**任务编号**: TASK007-14  
**父任务**: TASK007  
**任务名称**: 创建AudioFile模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:05:05 CST

## 任务描述

创建音频文件管理的GORM模型，定义音频文件表结构。包括：1) 创建AudioFile模型，定义字段（包含episode_id、file_id、file_name、file_type、file_size、duration、codec_info等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范。

## 依赖任务

TASK007-13（创建AudioEpisode模型）

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/` 文档，了解audio_files表的完整设计：
- 表结构：id、episode_id、file_id、file_name、file_type、file_size、duration、codec_info、created_at、updated_at
- 外键关联：episode_id 关联 audio_episodes 表，file_id 关联 files 表
- 索引：episode_id、file_id、file_type

### 2. 创建AudioFile模型文件

在 `internal/models/` 目录下创建 `audio_file.go` 文件，定义AudioFile模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// AudioFile 音频文件模型
// 存储音频分集的文件信息，关联文件存储系统中的文件
// 一个音频分集可以包含多个文件（如不同格式、不同码率）
type AudioFile struct {
    ID         int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    EpisodeID  int64          `gorm:"column:episode_id;type:BIGINT;not null;index:idx_audio_files_episode_id" json:"episode_id"`
    FileID     int64          `gorm:"column:file_id;type:BIGINT;not null;index:idx_audio_files_file_id" json:"file_id"`
    FileName   string         `gorm:"column:file_name;type:VARCHAR(255);not null" json:"file_name"`
    FileType   string         `gorm:"column:file_type;type:VARCHAR(50);not null;index:idx_audio_files_file_type" json:"file_type"`
    FileSize   int64          `gorm:"column:file_size;type:BIGINT;not null;default:0" json:"file_size"`
    Duration   int            `gorm:"column:duration;type:INTEGER;default:0" json:"duration"`
    CodecInfo  *string        `gorm:"column:codec_info;type:JSONB" json:"codec_info,omitempty"`
    CreatedAt  time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    UpdatedAt  time.Time      `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    Episode *AudioEpisode `gorm:"foreignKey:EpisodeID;references:ID" json:"episode,omitempty"`
    File    *File        `gorm:"foreignKey:FileID;references:ID" json:"file,omitempty"`
}

// TableName 指定表名
func (AudioFile) TableName() string {
    return "audio_files"
}

// BeforeCreate 创建前钩子
func (af *AudioFile) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if af.CreatedAt.IsZero() {
        af.CreatedAt = now
    }
    if af.UpdatedAt.IsZero() {
        af.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (af *AudioFile) BeforeUpdate(tx *gorm.DB) error {
    af.UpdatedAt = time.Now()
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// AudioFile 音频文件模型
// 存储音频分集的文件信息，关联文件存储系统中的文件
// 一个音频分集可以包含多个文件（如不同格式、不同码率）
type AudioFile struct {
    // ID 文件关联ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // EpisodeID 分集ID，外键关联audio_episodes表，必填字段
    EpisodeID int64 `gorm:"column:episode_id;type:BIGINT;not null;index:idx_audio_files_episode_id" json:"episode_id"`
    
    // FileID 文件ID，外键关联files表，必填字段
    FileID int64 `gorm:"column:file_id;type:BIGINT;not null;index:idx_audio_files_file_id" json:"file_id"`
    
    // FileName 文件名，必填字段，最大长度255字符
    FileName string `gorm:"column:file_name;type:VARCHAR(255);not null" json:"file_name"`
    
    // FileType 文件类型，如mp3、wav、flac等，必填字段，最大长度50字符
    FileType string `gorm:"column:file_type;type:VARCHAR(50);not null;index:idx_audio_files_file_type" json:"file_type"`
    
    // FileSize 文件大小（字节），必填字段，默认值为0
    FileSize int64 `gorm:"column:file_size;type:BIGINT;not null;default:0" json:"file_size"`
    
    // Duration 时长（秒），默认值为0
    Duration int `gorm:"column:duration;type:INTEGER;default:0" json:"duration"`
    
    // CodecInfo 编解码信息，JSON格式，存储音频编码参数（如采样率、比特率、声道数等），可选字段
    CodecInfo *string `gorm:"column:codec_info;type:JSONB" json:"codec_info,omitempty"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    // Episode 分集信息，外键关联audio_episodes表
    Episode *AudioEpisode `gorm:"foreignKey:EpisodeID;references:ID" json:"episode,omitempty"`
    
    // File 文件信息，外键关联files表
    File *File `gorm:"foreignKey:FileID;references:ID" json:"file,omitempty"`
}
```

### 4. 定义模型方法

为AudioFile模型添加常用的辅助方法：

```go
// GetFileSizeMB 获取文件大小（MB）
func (af *AudioFile) GetFileSizeMB() float64 {
    return float64(af.FileSize) / (1024 * 1024)
}

// GetDurationMinutes 获取时长（分钟）
func (af *AudioFile) GetDurationMinutes() float64 {
    return float64(af.Duration) / 60.0
}

// ValidateFileType 验证文件类型是否有效
func (af *AudioFile) ValidateFileType() bool {
    validTypes := []string{"mp3", "wav", "flac", "aac", "ogg", "m4a"}
    for _, validType := range validTypes {
        if af.FileType == validType {
            return true
        }
    }
    return false
}
```

### 5. 注意事项

- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **索引定义**：在GORM标签中定义索引，包括episode_id、file_id、file_type
- **外键关联**：使用GORM的foreignKey和references标签定义与AudioEpisode和File的关联关系
- **JSON标签**：所有字段都应有JSON标签，可选字段使用omitempty
- **指针类型**：可选字段（如CodecInfo）使用指针类型，支持NULL值
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **JSONB字段**：codec_info使用JSONB类型存储结构化数据
- **文件大小**：file_size使用BIGINT类型，支持大文件

## 验收标准

1. **模型结构完整**
   - AudioFile模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 普通索引：episode_id、file_id、file_type
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - AudioEpisode外键关联关系正确
   - File外键关联关系正确

4. **模型方法完整**
   - GetFileSizeMB方法实现正确
   - GetDurationMinutes方法实现正确
   - ValidateFileType方法实现正确

5. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/` - 音频文件表数据库设计文档
- `docs/TASKS/TASK007/TASK007-13.md` - AudioEpisode模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/audio_file.go` - AudioFile模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:05:05 CST

