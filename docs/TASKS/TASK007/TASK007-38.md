# TASK007-38: 创建RegionService接口和实现

## 任务信息

**任务编号**: TASK007-38  
**父任务**: TASK007  
**任务名称**: 创建RegionService接口和实现  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:36:14 CST

## 任务描述

创建地区服务，提供地区管理的业务逻辑。包括：1) 定义RegionService接口（GetRegion、GetRegions、GetRegionTree、CreateRegion、UpdateRegion、DeleteRegion等方法）；2) 实现地区查询（单个地区、地区列表、树形结构查询）；3) 实现地区创建、更新、删除；4) 实现业务验证逻辑。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK007-20（实现RegionRepository接口和实现）

## 实现指南

### 1. 创建RegionService接口文件

在 `internal/service/` 目录下创建 `region_service.go` 文件，定义RegionService接口：

```go
package service

import (
    "context"
    "yourproject/internal/models"
)

// RegionService 地区服务接口
// 提供地区管理的业务逻辑
type RegionService interface {
    // GetRegion 根据ID获取地区
    GetRegion(ctx context.Context, id int64) (*models.Region, error)
    
    // GetRegions 获取地区列表
    GetRegions(ctx context.Context) ([]*models.Region, error)
    
    // GetRegionTree 获取地区树（树形结构）
    GetRegionTree(ctx context.Context) ([]*models.Region, error)
    
    // CreateRegion 创建地区
    CreateRegion(ctx context.Context, region *models.Region) error
    
    // UpdateRegion 更新地区
    UpdateRegion(ctx context.Context, region *models.Region) error
    
    // DeleteRegion 删除地区
    DeleteRegion(ctx context.Context, id int64) error
}
```

### 2. 实现RegionService接口

在同一个文件中实现RegionService接口：

```go
// regionService RegionService的实现
type regionService struct {
    regionRepo repository.RegionRepository
}

// NewRegionService 创建RegionService实例
func NewRegionService(regionRepo repository.RegionRepository) RegionService {
    return &regionService{
        regionRepo: regionRepo,
    }
}

// GetRegion 根据ID获取地区
func (s *regionService) GetRegion(ctx context.Context, id int64) (*models.Region, error) {
    if id <= 0 {
        return nil, errors.New("地区ID无效")
    }
    
    region, err := s.regionRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("获取地区失败: %w", err)
    }
    
    return region, nil
}

// GetRegions 获取地区列表
func (s *regionService) GetRegions(ctx context.Context) ([]*models.Region, error) {
    regions, err := s.regionRepo.GetAll(ctx)
    if err != nil {
        return nil, fmt.Errorf("获取地区列表失败: %w", err)
    }
    
    return regions, nil
}

// GetRegionTree 获取地区树
func (s *regionService) GetRegionTree(ctx context.Context) ([]*models.Region, error) {
    // 获取所有地区
    allRegions, err := s.regionRepo.GetAll(ctx)
    if err != nil {
        return nil, err
    }
    
    // 构建地区树
    tree := s.buildRegionTree(allRegions, nil)
    
    return tree, nil
}

// CreateRegion 创建地区
func (s *regionService) CreateRegion(ctx context.Context, region *models.Region) error {
    // 业务验证
    if err := s.validateRegion(region); err != nil {
        return err
    }
    
    // 验证父地区是否存在
    if region.ParentID != nil {
        parent, err := s.regionRepo.GetByID(ctx, *region.ParentID)
        if err != nil {
            return errors.New("父地区不存在")
        }
    }
    
    // 创建地区
    if err := s.regionRepo.Create(ctx, region); err != nil {
        return fmt.Errorf("创建地区失败: %w", err)
    }
    
    return nil
}

// UpdateRegion 更新地区
func (s *regionService) UpdateRegion(ctx context.Context, region *models.Region) error {
    // 业务验证
    if err := s.validateRegion(region); err != nil {
        return err
    }
    
    // 检查地区是否存在
    existing, err := s.regionRepo.GetByID(ctx, region.ID)
    if err != nil {
        return errors.New("地区不存在")
    }
    
    // 验证父地区（不能将自己设为父地区）
    if region.ParentID != nil && *region.ParentID == region.ID {
        return errors.New("不能将自己设为父地区")
    }
    
    // 验证父地区是否存在
    if region.ParentID != nil {
        parent, err := s.regionRepo.GetByID(ctx, *region.ParentID)
        if err != nil {
            return errors.New("父地区不存在")
        }
    }
    
    // 更新地区
    if err := s.regionRepo.Update(ctx, region); err != nil {
        return fmt.Errorf("更新地区失败: %w", err)
    }
    
    return nil
}

// DeleteRegion 删除地区
func (s *regionService) DeleteRegion(ctx context.Context, id int64) error {
    if id <= 0 {
        return errors.New("地区ID无效")
    }
    
    // 检查地区是否存在
    region, err := s.regionRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("地区不存在")
    }
    
    // 检查是否有子地区
    children, err := s.regionRepo.GetByParentID(ctx, &id)
    if err != nil {
        return fmt.Errorf("检查子地区失败: %w", err)
    }
    if len(children) > 0 {
        return errors.New("存在子地区，无法删除")
    }
    
    // 删除地区
    if err := s.regionRepo.Delete(ctx, id); err != nil {
        return fmt.Errorf("删除地区失败: %w", err)
    }
    
    return nil
}

// validateRegion 验证地区数据
func (s *regionService) validateRegion(region *models.Region) error {
    if region.RegionName == "" {
        return errors.New("地区名称不能为空")
    }
    if len(region.RegionName) > 100 {
        return errors.New("地区名称长度不能超过100个字符")
    }
    
    return nil
}

// buildRegionTree 构建地区树
func (s *regionService) buildRegionTree(regions []*models.Region, parentID *int64) []*models.Region {
    var tree []*models.Region
    
    for _, region := range regions {
        var regParentID *int64
        if region.ParentID != nil {
            regParentID = region.ParentID
        }
        
        // 判断是否为当前父节点的子节点
        if (parentID == nil && regParentID == nil) || 
           (parentID != nil && regParentID != nil && *parentID == *regParentID) {
            // 递归构建子树
            region.Children = s.buildRegionTree(regions, &region.ID)
            tree = append(tree, region)
        }
    }
    
    return tree
}
```

### 3. 添加必要的导入

```go
package service

import (
    "context"
    "errors"
    "fmt"
    
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 4. 注意事项

- **业务验证**：在Service层进行业务逻辑验证，包括数据有效性、业务规则等
- **错误处理**：所有错误消息必须使用中文
- **上下文传递**：所有方法都接受context.Context参数
- **树形结构**：实现地区树的构建逻辑
- **关联验证**：创建和更新时验证父地区的存在性
- **删除保护**：删除前检查是否存在子地区

## 验收标准

1. **接口定义完整**
   - RegionService接口包含所有必需方法
   - 方法签名正确，参数和返回值类型正确

2. **实现完整**
   - 所有接口方法都已实现
   - 业务逻辑正确实现

3. **业务验证**
   - 地区数据验证正确
   - 父地区验证正确
   - 删除保护逻辑正确

4. **树形结构**
   - GetRegionTree方法能正确构建地区树

5. **错误处理**
   - 所有错误消息使用中文
   - 错误处理完整、清晰

6. **代码规范**
   - 遵循Golang编码规范
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK007/TASK007-20.md` - RegionRepository实现文档
- `docs/TASKS/TASK007/TASK007-02.md` - Region模型实现文档
- `docs/TASKS/TASK007/TASK007-37.md` - CategoryService实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/region_service.go` - RegionService接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:36:14 CST

