# TASK007-10: 创建ComicChapterImage模型

## 任务信息

**任务编号**: TASK007-10  
**父任务**: TASK007  
**任务名称**: 创建ComicChapterImage模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 22:57:58 CST

## 任务描述

创建漫画章节图片管理的GORM模型，定义漫画章节图片表结构。包括：1) 创建ComicChapterImage模型，定义字段（包含chapter_id、file_id、file_name、file_type、file_size、sort_order等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范。注意：根据数据库设计，图片表关联核心模块的files表（而非存储模块的files表），以支持存储模块可选性。

## 依赖任务

TASK007-09（ComicChapter模型）

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-25.md` 文档，了解comic_chapter_images表的完整设计：
- 表结构：id、chapter_id、file_id、image_order、created_at
- 外键关联：chapter_id 关联 comic_chapters 表、file_id 关联核心模块 files 表
- 唯一约束：chapter_id + image_order 必须唯一
- 索引：chapter_id、file_id、image_order、复合唯一索引 (chapter_id, image_order)

### 2. 创建ComicChapterImage模型文件

在 `internal/models/` 目录下创建 `comic_chapter_image.go` 文件，定义ComicChapterImage模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// ComicChapterImage 漫画章节图片模型
// 存储漫画章节图片信息，包括图片文件、图片排序等
// 图片关联核心模块的files表（而非存储模块的files表），以支持存储模块可选性
type ComicChapterImage struct {
    ID          int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    ChapterID   int64          `gorm:"column:chapter_id;type:BIGINT;not null;index:idx_comic_chapter_images_chapter_id;uniqueIndex:uk_comic_chapter_images_chapter_id_image_order" json:"chapter_id"`
    FileID      int64          `gorm:"column:file_id;type:BIGINT;not null;index:idx_comic_chapter_images_file_id" json:"file_id"`
    ImageOrder  int            `gorm:"column:image_order;type:INTEGER;not null;default:0;index:idx_comic_chapter_images_image_order;uniqueIndex:uk_comic_chapter_images_chapter_id_image_order" json:"image_order"`
    CreatedAt   time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // 关联关系
    Chapter *ComicChapter `gorm:"foreignKey:ChapterID;references:ID" json:"chapter,omitempty"`
    File    *File         `gorm:"foreignKey:FileID;references:ID" json:"file,omitempty"`
}

// TableName 指定表名
func (ComicChapterImage) TableName() string {
    return "comic_chapter_images"
}

// BeforeCreate 创建前钩子
func (cci *ComicChapterImage) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if cci.CreatedAt.IsZero() {
        cci.CreatedAt = now
    }
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// ComicChapterImage 漫画章节图片模型
// 存储漫画章节图片信息，包括图片文件、图片排序等
// 图片关联核心模块的files表（而非存储模块的files表），以支持存储模块可选性
// 文件URL通过files表的storage_url字段获取，不在图片表中重复存储
// 同一章节的图片排序必须唯一
type ComicChapterImage struct {
    // ID 图片ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // ChapterID 章节ID，外键关联comic_chapters表，必填字段
    ChapterID int64 `gorm:"column:chapter_id;type:BIGINT;not null;index:idx_comic_chapter_images_chapter_id;uniqueIndex:uk_comic_chapter_images_chapter_id_image_order" json:"chapter_id"`
    
    // FileID 文件ID，外键关联核心模块files表，必填字段
    // 注意：关联核心模块的files表，而非存储模块的files表
    FileID int64 `gorm:"column:file_id;type:BIGINT;not null;index:idx_comic_chapter_images_file_id" json:"file_id"`
    
    // ImageOrder 图片排序，数字越小越靠前，用于排序显示，默认值为0
    // 同一章节的图片排序必须唯一
    ImageOrder int `gorm:"column:image_order;type:INTEGER;not null;default:0;index:idx_comic_chapter_images_image_order;uniqueIndex:uk_comic_chapter_images_chapter_id_image_order" json:"image_order"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // 关联关系
    // Chapter 章节，多对一关系
    Chapter *ComicChapter `gorm:"foreignKey:ChapterID;references:ID" json:"chapter,omitempty"`
    
    // File 文件，多对一关系，关联核心模块files表
    File *File `gorm:"foreignKey:FileID;references:ID" json:"file,omitempty"`
}
```

### 4. 定义模型方法

为ComicChapterImage模型添加常用的辅助方法：

```go
// GetImageURL 获取图片URL（通过关联的File模型获取storage_url）
// 注意：需要在查询时预加载File关联
func (cci *ComicChapterImage) GetImageURL() string {
    if cci.File != nil && cci.File.StorageURL != nil {
        return *cci.File.StorageURL
    }
    return ""
}

// HasFile 检查是否有关联的文件
func (cci *ComicChapterImage) HasFile() bool {
    return cci.File != nil
}
```

### 5. 注意事项

- **文件表关联**：图片表关联核心模块的files表（而非存储模块的files表），以支持存储模块可选性
- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **唯一索引**：chapter_id + image_order 使用uniqueIndex标签定义复合唯一索引，确保同一章节的图片排序唯一
- **索引定义**：在GORM标签中定义索引，包括唯一索引和普通索引
- **外键关联**：使用GORM的foreignKey和references标签定义关联关系
- **JSON标签**：所有字段都应有JSON标签
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **文件URL获取**：文件URL通过files表的storage_url字段获取，不在图片表中重复存储
- **存储模块支持**：如果使用存储模块，文件信息通过gRPC同步到核心模块files表
- **唯一约束**：chapter_id + image_order 的复合唯一约束需要在应用层进行验证

## 验收标准

1. **模型结构完整**
   - ComicChapterImage模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 外键索引：chapter_id、file_id
   - 普通索引：image_order
   - 复合唯一索引：chapter_id + image_order
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - Chapter关联关系正确
   - File关联关系正确（关联核心模块files表）

4. **唯一约束正确**
   - chapter_id + image_order 使用uniqueIndex标签，确保唯一性

5. **模型方法完整**
   - GetImageURL方法实现正确
   - HasFile方法实现正确

6. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

7. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/TASK002-25.md` - 漫画章节图片表数据库设计文档
- `docs/TASKS/TASK007/TASK007-09.md` - ComicChapter模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/comic_chapter_image.go` - ComicChapterImage模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 22:57:58 CST

