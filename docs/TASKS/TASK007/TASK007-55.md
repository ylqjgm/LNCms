# TASK007-55: 创建CategoryHandler接口和实现

## 任务信息

**任务编号**: TASK007-55  
**父任务**: TASK007  
**任务名称**: 创建CategoryHandler接口和实现  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:53:38 CST

## 任务描述

创建分类控制器，提供分类管理的HTTP API处理。包括：1) 定义CategoryHandler接口；2) 实现GetCategories方法（处理GET /api/v1/categories请求，支持树形结构查询）；3) 实现GetCategory方法（处理GET /api/v1/categories/{id}请求）；4) 实现CreateCategory方法（处理POST /api/v1/categories请求，需要管理员权限）；5) 实现UpdateCategory方法（处理PUT /api/v1/categories/{id}请求，需要管理员权限）；6) 实现DeleteCategory方法（处理DELETE /api/v1/categories/{id}请求，需要管理员权限）；7) 格式化响应（Envelope格式）。所有代码必须遵循Golang编码规范和API设计规范，错误消息使用中文。

## 依赖任务

TASK007-37（创建CategoryService接口和实现）

## 实现指南

### 1. 创建CategoryHandler接口文件

在 `internal/handler/` 目录下创建 `category_handler.go` 文件，定义CategoryHandler接口：

```go
package handler

import (
    "github.com/gin-gonic/gin"
)

// CategoryHandler 分类控制器接口
// 提供分类管理的HTTP API处理
type CategoryHandler interface {
    // GetCategories 获取分类列表（支持树形结构查询）
    GetCategories(c *gin.Context)
    
    // GetCategory 根据ID获取分类
    GetCategory(c *gin.Context)
    
    // CreateCategory 创建分类（需要管理员权限）
    CreateCategory(c *gin.Context)
    
    // UpdateCategory 更新分类（需要管理员权限）
    UpdateCategory(c *gin.Context)
    
    // DeleteCategory 删除分类（需要管理员权限）
    DeleteCategory(c *gin.Context)
}
```

### 2. 定义请求和响应结构体

```go
// CreateCategoryRequest 创建分类请求
type CreateCategoryRequest struct {
    CategoryName        string  `json:"category_name" binding:"required"`
    CategoryDescription *string `json:"category_description,omitempty"`
    ParentID            *int64  `json:"parent_id,omitempty"`
    CategoryType        string  `json:"category_type" binding:"required"`
    CategoryOrder       int     `json:"category_order"`
    IsActive            bool    `json:"is_active"`
}

// UpdateCategoryRequest 更新分类请求
type UpdateCategoryRequest struct {
    CategoryName        string  `json:"category_name" binding:"required"`
    CategoryDescription *string `json:"category_description,omitempty"`
    ParentID            *int64  `json:"parent_id,omitempty"`
    CategoryType        string  `json:"category_type" binding:"required"`
    CategoryOrder       int     `json:"category_order"`
    IsActive            bool    `json:"is_active"`
}
```

### 3. 实现CategoryHandler接口

在同一个文件中实现CategoryHandler接口：

```go
// categoryHandler CategoryHandler的实现
type categoryHandler struct {
    categorySvc service.CategoryService
}

// NewCategoryHandler 创建CategoryHandler实例
func NewCategoryHandler(categorySvc service.CategoryService) CategoryHandler {
    return &categoryHandler{
        categorySvc: categorySvc,
    }
}

// GetCategories 获取分类列表
func (h *categoryHandler) GetCategories(c *gin.Context) {
    // 获取查询参数
    tree := c.Query("tree") == "true"
    categoryType := c.Query("category_type")
    
    ctx := c.Request.Context()
    
    var categories interface{}
    var err error
    
    if tree {
        // 获取树形结构
        categories, err = h.categorySvc.GetCategoryTree(ctx, categoryType)
    } else {
        // 获取列表
        categories, err = h.categorySvc.GetCategories(ctx)
    }
    
    if err != nil {
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", "获取分类列表失败", "")
        return
    }
    
    response.BuildSuccessResponse(c, categories)
}

// GetCategory 根据ID获取分类
func (h *categoryHandler) GetCategory(c *gin.Context) {
    // 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "分类ID无效", "id")
        return
    }
    
    ctx := c.Request.Context()
    
    category, err := h.categorySvc.GetCategory(ctx, id)
    if err != nil {
        if errors.Is(err, repository.ErrCategoryNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "CATEGORY_NOT_FOUND", "分类不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", "获取分类失败", "")
        return
    }
    
    response.BuildSuccessResponse(c, category)
}

// CreateCategory 创建分类
func (h *categoryHandler) CreateCategory(c *gin.Context) {
    var req CreateCategoryRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "VALIDATION_ERROR", "请求参数验证失败", "")
        return
    }
    
    ctx := c.Request.Context()
    
    // 构建分类模型
    category := &models.Category{
        CategoryName:        req.CategoryName,
        CategoryDescription: req.CategoryDescription,
        ParentID:            req.ParentID,
        CategoryType:        req.CategoryType,
        CategoryOrder:       req.CategoryOrder,
        IsActive:            req.IsActive,
    }
    
    if err := h.categorySvc.CreateCategory(ctx, category); err != nil {
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("创建分类失败: %v", err), "")
        return
    }
    
    response.BuildSuccessResponse(c, category)
}

// UpdateCategory 更新分类
func (h *categoryHandler) UpdateCategory(c *gin.Context) {
    // 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "分类ID无效", "id")
        return
    }
    
    var req UpdateCategoryRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "VALIDATION_ERROR", "请求参数验证失败", "")
        return
    }
    
    ctx := c.Request.Context()
    
    // 构建分类模型
    category := &models.Category{
        ID:                  id,
        CategoryName:        req.CategoryName,
        CategoryDescription: req.CategoryDescription,
        ParentID:            req.ParentID,
        CategoryType:        req.CategoryType,
        CategoryOrder:       req.CategoryOrder,
        IsActive:            req.IsActive,
    }
    
    if err := h.categorySvc.UpdateCategory(ctx, category); err != nil {
        if errors.Is(err, repository.ErrCategoryNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "CATEGORY_NOT_FOUND", "分类不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("更新分类失败: %v", err), "")
        return
    }
    
    response.BuildSuccessResponse(c, category)
}

// DeleteCategory 删除分类
func (h *categoryHandler) DeleteCategory(c *gin.Context) {
    // 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "分类ID无效", "id")
        return
    }
    
    ctx := c.Request.Context()
    
    if err := h.categorySvc.DeleteCategory(ctx, id); err != nil {
        if errors.Is(err, repository.ErrCategoryNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "CATEGORY_NOT_FOUND", "分类不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("删除分类失败: %v", err), "")
        return
    }
    
    response.BuildSuccessResponse(c, nil)
}
```

### 4. 添加必要的导入

```go
package handler

import (
    "errors"
    "fmt"
    "net/http"
    "strconv"
    
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/models"
    "yourproject/internal/repository"
    "yourproject/internal/response"
    "yourproject/internal/service"
)
```

### 5. 注意事项

- **API规范**：所有API必须遵循OpenAPI 3.1.1规范
- **响应格式**：所有响应必须使用Envelope格式
- **错误处理**：所有错误消息必须使用中文
- **权限验证**：创建、更新、删除操作需要管理员权限（通过中间件实现）
- **参数验证**：使用Gin的binding进行请求参数验证
- **路径参数**：使用c.Param获取路径参数
- **查询参数**：使用c.Query获取查询参数

## 验收标准

1. **接口定义完整**
   - CategoryHandler接口包含所有必需方法
   - 方法签名正确

2. **请求处理完整**
   - GetCategories方法支持树形结构查询
   - GetCategory方法正确获取分类详情
   - CreateCategory方法正确创建分类
   - UpdateCategory方法正确更新分类
   - DeleteCategory方法正确删除分类

3. **响应格式**
   - 所有响应使用Envelope格式
   - 成功响应格式正确
   - 错误响应格式正确

4. **错误处理**
   - 所有错误消息使用中文
   - HTTP状态码使用正确
   - 错误代码定义清晰

5. **参数验证**
   - 请求参数验证正确
   - 路径参数验证正确
   - 查询参数处理正确

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK007/TASK007-37.md` - CategoryService实现文档
- `docs/TASKS/TASK007/TASK007-01.md` - Category模型实现文档
- `.cursor/rules/api-design.mdc` - API设计规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/handler/category_handler.go` - CategoryHandler接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:53:38 CST

