# TASK007-01: 创建Category模型

## 任务信息

**任务编号**: TASK007-01  
**父任务**: TASK007  
**任务名称**: 创建Category模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 22:52:51 CST

## 任务描述

创建分类管理的GORM模型，定义分类表结构。包括：1) 创建Category模型，定义字段（基于TASK002-16数据库设计，包含category_name、category_description、parent_id、category_type、category_order、is_active等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范和PostgreSQL数据库设计规范。分类支持树形结构，parent_id为自关联外键。

## 依赖任务

无

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-16.md` 文档，了解categories表的完整设计：
- 表结构：id、category_name、category_description、parent_id、category_type、category_order、is_active、created_at、updated_at
- 外键关联：parent_id 关联 categories 表（自引用，支持树形结构）
- 检查约束：category_type 必须是 'novel'、'comic'、'audio'、'video' 之一
- 索引：category_name、parent_id、category_type、category_order、is_active、复合索引 (category_type, parent_id)

### 2. 创建Category模型文件

在 `internal/models/` 目录下创建 `category.go` 文件，定义Category模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// Category 分类模型
// 存储内容分类信息，支持树形结构，支持多级分类
// 分类类型包括：小说、漫画、音频、视频
type Category struct {
    ID                int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    CategoryName      string         `gorm:"column:category_name;type:VARCHAR(100);not null;index:idx_categories_category_name" json:"category_name"`
    CategoryDescription *string       `gorm:"column:category_description;type:TEXT" json:"category_description,omitempty"`
    ParentID          *int64         `gorm:"column:parent_id;type:BIGINT;index:idx_categories_parent_id" json:"parent_id,omitempty"`
    CategoryType      string         `gorm:"column:category_type;type:VARCHAR(50);not null;index:idx_categories_category_type;index:idx_categories_type_parent" json:"category_type"`
    CategoryOrder     int            `gorm:"column:category_order;type:INTEGER;not null;default:0;index:idx_categories_category_order" json:"category_order"`
    IsActive          bool           `gorm:"column:is_active;type:BOOLEAN;default:true;index:idx_categories_is_active" json:"is_active"`
    CreatedAt         time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    UpdatedAt         time.Time      `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    Parent   *Category   `gorm:"foreignKey:ParentID;references:ID" json:"parent,omitempty"`
    Children []Category  `gorm:"foreignKey:ParentID;references:ID" json:"children,omitempty"`
}

// TableName 指定表名
func (Category) TableName() string {
    return "categories"
}

// BeforeCreate 创建前钩子
func (c *Category) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if c.CreatedAt.IsZero() {
        c.CreatedAt = now
    }
    if c.UpdatedAt.IsZero() {
        c.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (c *Category) BeforeUpdate(tx *gorm.DB) error {
    c.UpdatedAt = time.Now()
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// Category 分类模型
// 存储内容分类信息，支持树形结构，支持多级分类
// 分类类型包括：novel-小说、comic-漫画、audio-音频、video-视频
// parent_id为自关联外键，支持树形结构，NULL表示顶级分类
type Category struct {
    // ID 分类ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // CategoryName 分类名称，必填字段
    CategoryName string `gorm:"column:category_name;type:VARCHAR(100);not null;index:idx_categories_category_name" json:"category_name"`
    
    // CategoryDescription 分类描述，说明分类的用途和范围，可选字段
    CategoryDescription *string `gorm:"column:category_description;type:TEXT" json:"category_description,omitempty"`
    
    // ParentID 上级分类ID，外键关联categories表，支持树形结构，NULL表示顶级分类
    ParentID *int64 `gorm:"column:parent_id;type:BIGINT;index:idx_categories_parent_id;index:idx_categories_type_parent" json:"parent_id,omitempty"`
    
    // CategoryType 分类类型：novel-小说、comic-漫画、audio-音频、video-视频
    // 必须符合检查约束：IN ('novel', 'comic', 'audio', 'video')
    CategoryType string `gorm:"column:category_type;type:VARCHAR(50);not null;index:idx_categories_category_type;index:idx_categories_type_parent" json:"category_type"`
    
    // CategoryOrder 分类排序，数字越小越靠前，用于排序显示，默认值为0
    CategoryOrder int `gorm:"column:category_order;type:INTEGER;not null;default:0;index:idx_categories_category_order" json:"category_order"`
    
    // IsActive 是否启用，TRUE-启用，FALSE-禁用，默认值为TRUE
    IsActive bool `gorm:"column:is_active;type:BOOLEAN;default:true;index:idx_categories_is_active" json:"is_active"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    // Parent 上级分类，自关联
    Parent *Category `gorm:"foreignKey:ParentID;references:ID" json:"parent,omitempty"`
    
    // Children 子分类列表，自关联
    Children []Category `gorm:"foreignKey:ParentID;references:ID" json:"children,omitempty"`
}
```

### 4. 定义模型方法

为Category模型添加常用的辅助方法：

```go
// IsRoot 检查是否为顶级分类（没有父分类）
func (c *Category) IsRoot() bool {
    return c.ParentID == nil
}

// IsValid 检查分类是否有效（启用状态）
func (c *Category) IsValid() bool {
    return c.IsActive
}

// GetCategoryTypeName 获取分类类型的中文名称
func (c *Category) GetCategoryTypeName() string {
    typeNames := map[string]string{
        "novel": "小说",
        "comic": "漫画",
        "audio": "音频",
        "video": "视频",
    }
    if name, ok := typeNames[c.CategoryType]; ok {
        return name
    }
    return "未知"
}

// ValidateCategoryType 验证分类类型是否有效
func (c *Category) ValidateCategoryType() bool {
    validTypes := []string{"novel", "comic", "audio", "video"}
    for _, validType := range validTypes {
        if c.CategoryType == validType {
            return true
        }
    }
    return false
}
```

### 5. 注意事项

- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **索引定义**：在GORM标签中定义索引，包括唯一索引和普通索引，注意复合索引的定义
- **外键关联**：使用GORM的foreignKey和references标签定义自关联关系
- **JSON标签**：所有字段都应有JSON标签，可选字段使用omitempty
- **指针类型**：可选字段（如CategoryDescription、ParentID等）使用指针类型，支持NULL值
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **检查约束**：category_type字段需要在应用层进行验证，确保符合数据库约束
- **树形结构**：parent_id为自关联外键，支持树形结构查询

## 验收标准

1. **模型结构完整**
   - Category模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 普通索引：category_name、parent_id、category_type、category_order、is_active
   - 复合索引：category_type + parent_id
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - Parent自关联关系正确
   - Children自关联关系正确

4. **模型方法完整**
   - IsRoot方法实现正确
   - IsValid方法实现正确
   - GetCategoryTypeName方法实现正确
   - ValidateCategoryType方法实现正确

5. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/TASK002-16.md` - 分类表数据库设计文档
- `docs/TASKS/TASK006/TASK006-01.md` - Author模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/category.go` - Category模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 22:52:51 CST

