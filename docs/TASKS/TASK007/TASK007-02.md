# TASK007-02: 创建Region模型

## 任务信息

**任务编号**: TASK007-02  
**父任务**: TASK007  
**任务名称**: 创建Region模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 22:52:51 CST

## 任务描述

创建地区管理的GORM模型，定义地区表结构。包括：1) 创建Region模型，定义字段（包含region_name、region_description、parent_id、region_order、region_code、is_active等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范。地区支持树形结构，parent_id为自关联外键。

## 依赖任务

无

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-17.md` 文档，了解regions表的完整设计：
- 表结构：id、region_name、region_description、parent_id、region_order、region_code、is_active、created_at、updated_at
- 外键关联：parent_id 关联 regions 表（自引用，支持树形结构）
- 索引：region_name、parent_id、region_order、region_code、is_active、复合索引 (parent_id, region_order)

### 2. 创建Region模型文件

在 `internal/models/` 目录下创建 `region.go` 文件，定义Region模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// Region 地区模型
// 存储地区信息，支持树形结构，支持多级地区（国家、省、市、区等）
type Region struct {
    ID                int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    RegionName        string         `gorm:"column:region_name;type:VARCHAR(100);not null;index:idx_regions_region_name" json:"region_name"`
    RegionDescription *string        `gorm:"column:region_description;type:TEXT" json:"region_description,omitempty"`
    ParentID          *int64         `gorm:"column:parent_id;type:BIGINT;index:idx_regions_parent_id;index:idx_regions_parent_order" json:"parent_id,omitempty"`
    RegionOrder       int            `gorm:"column:region_order;type:INTEGER;not null;default:0;index:idx_regions_region_order;index:idx_regions_parent_order" json:"region_order"`
    RegionCode        *string        `gorm:"column:region_code;type:VARCHAR(50);index:idx_regions_region_code" json:"region_code,omitempty"`
    IsActive          bool           `gorm:"column:is_active;type:BOOLEAN;default:true;index:idx_regions_is_active" json:"is_active"`
    CreatedAt         time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    UpdatedAt         time.Time      `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    Parent   *Region   `gorm:"foreignKey:ParentID;references:ID" json:"parent,omitempty"`
    Children []Region  `gorm:"foreignKey:ParentID;references:ID" json:"children,omitempty"`
}

// TableName 指定表名
func (Region) TableName() string {
    return "regions"
}

// BeforeCreate 创建前钩子
func (r *Region) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if r.CreatedAt.IsZero() {
        r.CreatedAt = now
    }
    if r.UpdatedAt.IsZero() {
        r.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (r *Region) BeforeUpdate(tx *gorm.DB) error {
    r.UpdatedAt = time.Now()
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// Region 地区模型
// 存储地区信息，支持树形结构，支持多级地区（国家、省、市、区等）
// parent_id为自关联外键，支持树形结构，NULL表示顶级地区
type Region struct {
    // ID 地区ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // RegionName 地区名称，必填字段
    RegionName string `gorm:"column:region_name;type:VARCHAR(100);not null;index:idx_regions_region_name" json:"region_name"`
    
    // RegionDescription 地区描述，说明地区的范围和特点，可选字段
    RegionDescription *string `gorm:"column:region_description;type:TEXT" json:"region_description,omitempty"`
    
    // ParentID 上级地区ID，外键关联regions表，支持树形结构，NULL表示顶级地区
    ParentID *int64 `gorm:"column:parent_id;type:BIGINT;index:idx_regions_parent_id;index:idx_regions_parent_order" json:"parent_id,omitempty"`
    
    // RegionOrder 地区排序，数字越小越靠前，用于排序显示，默认值为0
    RegionOrder int `gorm:"column:region_order;type:INTEGER;not null;default:0;index:idx_regions_region_order;index:idx_regions_parent_order" json:"region_order"`
    
    // RegionCode 地区代码，如行政区划代码，用于标识和查询，可选字段
    RegionCode *string `gorm:"column:region_code;type:VARCHAR(50);index:idx_regions_region_code" json:"region_code,omitempty"`
    
    // IsActive 是否启用，TRUE-启用，FALSE-禁用，默认值为TRUE
    IsActive bool `gorm:"column:is_active;type:BOOLEAN;default:true;index:idx_regions_is_active" json:"is_active"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    // Parent 上级地区，自关联
    Parent *Region `gorm:"foreignKey:ParentID;references:ID" json:"parent,omitempty"`
    
    // Children 子地区列表，自关联
    Children []Region `gorm:"foreignKey:ParentID;references:ID" json:"children,omitempty"`
}
```

### 4. 定义模型方法

为Region模型添加常用的辅助方法：

```go
// IsRoot 检查是否为顶级地区（没有父地区）
func (r *Region) IsRoot() bool {
    return r.ParentID == nil
}

// IsValid 检查地区是否有效（启用状态）
func (r *Region) IsValid() bool {
    return r.IsActive
}

// HasRegionCode 检查是否有地区代码
func (r *Region) HasRegionCode() bool {
    return r.RegionCode != nil && *r.RegionCode != ""
}
```

### 5. 注意事项

- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **索引定义**：在GORM标签中定义索引，包括普通索引和复合索引
- **外键关联**：使用GORM的foreignKey和references标签定义自关联关系
- **JSON标签**：所有字段都应有JSON标签，可选字段使用omitempty
- **指针类型**：可选字段（如RegionDescription、ParentID、RegionCode等）使用指针类型，支持NULL值
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **树形结构**：parent_id为自关联外键，支持树形结构查询

## 验收标准

1. **模型结构完整**
   - Region模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 普通索引：region_name、parent_id、region_order、region_code、is_active
   - 复合索引：parent_id + region_order
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - Parent自关联关系正确
   - Children自关联关系正确

4. **模型方法完整**
   - IsRoot方法实现正确
   - IsValid方法实现正确
   - HasRegionCode方法实现正确

5. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/TASK002-17.md` - 地区表数据库设计文档
- `docs/TASKS/TASK007/TASK007-01.md` - Category模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/region.go` - Region模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 22:52:51 CST

