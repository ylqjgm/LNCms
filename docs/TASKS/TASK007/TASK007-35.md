# TASK007-35: 实现VideoEpisodeRepository接口和实现

## 任务信息

**任务编号**: TASK007-35  
**父任务**: TASK007  
**任务名称**: 实现VideoEpisodeRepository接口和实现  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:36:14 CST

## 任务描述

实现VideoEpisodeRepository接口，提供视频分集数据的CRUD操作。包括：1) 定义VideoEpisodeRepository接口（Create、GetByID、GetByVideoID、GetBySeasonID、Update、Delete、UpdateStatus等方法）；2) 实现VideoEpisodeRepository接口（使用GORM进行数据库操作）；3) 实现条件查询方法（支持分页、排序）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK007-17（创建VideoEpisode模型）

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-30.md` 文档，了解video_episodes表的完整设计：
- 表结构：id、video_id、season_id、episode_title、episode_description、duration、sort_order、status、is_vip、created_at、updated_at
- 外键关联：video_id 关联 videos 表，season_id 关联 video_seasons 表
- 索引：video_id、season_id、status、sort_order、复合索引等

### 2. 创建VideoEpisodeRepository接口文件

在 `internal/repository/` 目录下创建 `video_episode_repository.go` 文件，定义VideoEpisodeRepository接口：

```go
package repository

import (
    "context"
    "yourproject/internal/models"
)

// VideoEpisodeRepository 视频分集仓储接口
// 提供视频分集数据的CRUD操作和条件查询
type VideoEpisodeRepository interface {
    // Create 创建视频分集
    Create(ctx context.Context, episode *models.VideoEpisode) error
    
    // GetByID 根据ID获取视频分集
    GetByID(ctx context.Context, id int64) (*models.VideoEpisode, error)
    
    // GetByVideoID 根据视频ID获取分集列表（支持分页、排序）
    GetByVideoID(ctx context.Context, videoID int64, params *VideoEpisodeQueryParams) ([]*models.VideoEpisode, int64, error)
    
    // GetBySeasonID 根据分季ID获取分集列表（支持分页、排序）
    GetBySeasonID(ctx context.Context, seasonID int64, params *VideoEpisodeQueryParams) ([]*models.VideoEpisode, int64, error)
    
    // Update 更新视频分集
    Update(ctx context.Context, episode *models.VideoEpisode) error
    
    // Delete 删除视频分集
    Delete(ctx context.Context, id int64) error
    
    // UpdateStatus 更新视频分集状态
    UpdateStatus(ctx context.Context, id int64, status string) error
}

// VideoEpisodeQueryParams 视频分集查询参数
type VideoEpisodeQueryParams struct {
    Page     int    // 页码，从1开始
    Limit    int    // 每页数量
    Status   string // 状态筛选
    IsVip    *bool  // 是否VIP筛选
    OrderBy  string // 排序字段（sort_order、created_at、updated_at）
    OrderDir string // 排序方向（asc、desc）
}
```

### 3. 实现VideoEpisodeRepository接口

在同一个文件中实现VideoEpisodeRepository接口：

```go
// videoEpisodeRepository VideoEpisodeRepository的实现
type videoEpisodeRepository struct {
    db *gorm.DB
}

// NewVideoEpisodeRepository 创建VideoEpisodeRepository实例
func NewVideoEpisodeRepository(db *gorm.DB) VideoEpisodeRepository {
    return &videoEpisodeRepository{db: db}
}

// Create 创建视频分集
func (r *videoEpisodeRepository) Create(ctx context.Context, episode *models.VideoEpisode) error {
    if err := r.db.WithContext(ctx).Create(episode).Error; err != nil {
        return fmt.Errorf("创建视频分集失败: %w", err)
    }
    return nil
}

// GetByID 根据ID获取视频分集
func (r *videoEpisodeRepository) GetByID(ctx context.Context, id int64) (*models.VideoEpisode, error) {
    var episode models.VideoEpisode
    if err := r.db.WithContext(ctx).Where("id = ?", id).First(&episode).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, errors.New("视频分集不存在")
        }
        return nil, fmt.Errorf("查询视频分集失败: %w", err)
    }
    return &episode, nil
}

// GetByVideoID 根据视频ID获取分集列表
func (r *videoEpisodeRepository) GetByVideoID(ctx context.Context, videoID int64, params *VideoEpisodeQueryParams) ([]*models.VideoEpisode, int64, error) {
    var episodes []*models.VideoEpisode
    var total int64
    
    query := r.db.WithContext(ctx).Model(&models.VideoEpisode{}).Where("video_id = ?", videoID)
    
    // 应用筛选条件
    if params.Status != "" {
        query = query.Where("status = ?", params.Status)
    }
    if params.IsVip != nil {
        query = query.Where("is_vip = ?", *params.IsVip)
    }
    
    // 获取总数
    if err := query.Count(&total).Error; err != nil {
        return nil, 0, fmt.Errorf("查询视频分集总数失败: %w", err)
    }
    
    // 应用排序
    orderBy := "sort_order"
    if params.OrderBy != "" {
        validOrderBy := map[string]bool{
            "sort_order": true,
            "created_at": true,
            "updated_at": true,
        }
        if validOrderBy[params.OrderBy] {
            orderBy = params.OrderBy
        }
    }
    orderDir := "asc"
    if params.OrderDir == "desc" {
        orderDir = "desc"
    }
    query = query.Order(orderBy + " " + orderDir)
    
    // 应用分页
    page := params.Page
    if page < 1 {
        page = 1
    }
    limit := params.Limit
    if limit < 1 {
        limit = 20
    }
    if limit > 100 {
        limit = 100
    }
    offset := (page - 1) * limit
    query = query.Offset(offset).Limit(limit)
    
    // 执行查询
    if err := query.Find(&episodes).Error; err != nil {
        return nil, 0, fmt.Errorf("查询视频分集列表失败: %w", err)
    }
    
    return episodes, total, nil
}

// GetBySeasonID 根据分季ID获取分集列表
func (r *videoEpisodeRepository) GetBySeasonID(ctx context.Context, seasonID int64, params *VideoEpisodeQueryParams) ([]*models.VideoEpisode, int64, error) {
    var episodes []*models.VideoEpisode
    var total int64
    
    query := r.db.WithContext(ctx).Model(&models.VideoEpisode{}).Where("season_id = ?", seasonID)
    
    // 应用筛选条件
    if params.Status != "" {
        query = query.Where("status = ?", params.Status)
    }
    if params.IsVip != nil {
        query = query.Where("is_vip = ?", *params.IsVip)
    }
    
    // 获取总数
    if err := query.Count(&total).Error; err != nil {
        return nil, 0, fmt.Errorf("查询视频分集总数失败: %w", err)
    }
    
    // 应用排序
    orderBy := "sort_order"
    if params.OrderBy != "" {
        validOrderBy := map[string]bool{
            "sort_order": true,
            "created_at": true,
            "updated_at": true,
        }
        if validOrderBy[params.OrderBy] {
            orderBy = params.OrderBy
        }
    }
    orderDir := "asc"
    if params.OrderDir == "desc" {
        orderDir = "desc"
    }
    query = query.Order(orderBy + " " + orderDir)
    
    // 应用分页
    page := params.Page
    if page < 1 {
        page = 1
    }
    limit := params.Limit
    if limit < 1 {
        limit = 20
    }
    if limit > 100 {
        limit = 100
    }
    offset := (page - 1) * limit
    query = query.Offset(offset).Limit(limit)
    
    // 执行查询
    if err := query.Find(&episodes).Error; err != nil {
        return nil, 0, fmt.Errorf("查询视频分集列表失败: %w", err)
    }
    
    return episodes, total, nil
}

// Update 更新视频分集
func (r *videoEpisodeRepository) Update(ctx context.Context, episode *models.VideoEpisode) error {
    if err := r.db.WithContext(ctx).Save(episode).Error; err != nil {
        return fmt.Errorf("更新视频分集失败: %w", err)
    }
    return nil
}

// Delete 删除视频分集
func (r *videoEpisodeRepository) Delete(ctx context.Context, id int64) error {
    result := r.db.WithContext(ctx).Delete(&models.VideoEpisode{}, id)
    if result.Error != nil {
        return fmt.Errorf("删除视频分集失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return errors.New("视频分集不存在")
    }
    return nil
}

// UpdateStatus 更新视频分集状态
func (r *videoEpisodeRepository) UpdateStatus(ctx context.Context, id int64, status string) error {
    result := r.db.WithContext(ctx).Model(&models.VideoEpisode{}).
        Where("id = ?", id).
        Update("status", status)
    if result.Error != nil {
        return fmt.Errorf("更新视频分集状态失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return errors.New("视频分集不存在")
    }
    return nil
}
```

### 4. 添加必要的导入

```go
package repository

import (
    "context"
    "errors"
    "fmt"
    
    "gorm.io/gorm"
    "yourproject/internal/models"
)
```

### 5. 注意事项

- **错误处理**：所有错误消息必须使用中文
- **上下文传递**：所有数据库操作必须使用context.Context
- **分页验证**：验证分页参数，确保page >= 1，limit在1-100之间
- **排序安全**：验证排序字段，防止SQL注入
- **默认排序**：默认按sort_order升序排序，符合分集顺序
- **关联查询**：如果需要关联查询视频或分季信息，使用Preload

## 验收标准

1. **接口定义完整**
   - VideoEpisodeRepository接口包含所有必需方法
   - 方法签名正确，参数和返回值类型正确
   - VideoEpisodeQueryParams结构体定义完整

2. **实现完整**
   - 所有接口方法都已实现
   - 实现逻辑正确，错误处理完善

3. **查询功能**
   - GetByVideoID方法支持分页、筛选、排序
   - GetBySeasonID方法支持分页、筛选、排序
   - 筛选条件正确应用
   - 分页参数验证正确
   - 排序功能正确实现

4. **错误处理**
   - 所有错误消息使用中文
   - 正确处理记录不存在等错误

5. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK002/TASK002-30.md` - 视频分集表数据库设计文档
- `docs/TASKS/TASK007/TASK007-17.md` - VideoEpisode模型实现文档
- `docs/TASKS/TASK007/TASK007-31.md` - AudioEpisodeRepository实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/repository/video_episode_repository.go` - VideoEpisodeRepository接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:36:14 CST

