# TASK007-64: 创建ComicChapterHandler接口和实现

## 任务信息

**任务编号**: TASK007-64  
**父任务**: TASK007  
**任务名称**: 创建ComicChapterHandler接口和实现  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-04 00:01:47 CST

## 任务描述

创建漫画章节控制器，提供漫画章节管理的HTTP API处理。包括：1) 定义ComicChapterHandler接口；2) 实现章节的CRUD API端点；3) 调用ComicChapterService；4) 格式化响应（Envelope格式）。所有代码必须遵循API设计规范。

## 依赖任务

TASK007-46（创建ComicChapterService接口和实现）

## 实现指南

### 1. 创建ComicChapterHandler接口文件

在 `internal/handler/` 目录下创建 `comic_chapter_handler.go` 文件，定义ComicChapterHandler接口：

```go
package handler

import (
    "github.com/gin-gonic/gin"
)

// ComicChapterHandler 漫画章节控制器接口
// 提供漫画章节管理的HTTP API处理
type ComicChapterHandler interface {
    // GetChapters 获取章节列表（支持分页、排序）
    GetChapters(c *gin.Context)
    
    // GetChapter 根据ID获取章节
    GetChapter(c *gin.Context)
    
    // CreateChapter 创建章节（需要作者或管理员权限）
    CreateChapter(c *gin.Context)
    
    // UpdateChapter 更新章节（需要作者或管理员权限）
    UpdateChapter(c *gin.Context)
    
    // DeleteChapter 删除章节（需要作者或管理员权限）
    DeleteChapter(c *gin.Context)
    
    // UpdateChapterStatus 更新章节状态（需要作者或管理员权限）
    UpdateChapterStatus(c *gin.Context)
}
```

### 2. 实现ComicChapterHandler接口

在同一个文件中实现ComicChapterHandler接口：

```go
// comicChapterHandler ComicChapterHandler的实现
type comicChapterHandler struct {
    chapterSvc service.ComicChapterService
}

// NewComicChapterHandler 创建ComicChapterHandler实例
func NewComicChapterHandler(chapterSvc service.ComicChapterService) ComicChapterHandler {
    return &comicChapterHandler{
        chapterSvc: chapterSvc,
    }
}

// GetChapters 获取章节列表
func (h *comicChapterHandler) GetChapters(c *gin.Context) {
    comicIDStr := c.Query("comic_id")
    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    limit, _ := strconv.Atoi(c.DefaultQuery("limit", "20"))
    orderBy := c.DefaultQuery("order_by", "sort_order")
    orderDir := c.DefaultQuery("order_dir", "asc")
    
    if comicIDStr == "" {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_PARAM", "comic_id参数必填", "comic_id")
        return
    }
    
    comicID, err := strconv.ParseInt(comicIDStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_PARAM", "comic_id参数无效", "comic_id")
        return
    }
    
    ctx := c.Request.Context()
    
    params := &service.ComicChapterQueryParams{
        ComicID:  comicID,
        Page:     page,
        Limit:    limit,
        OrderBy:  orderBy,
        OrderDir: orderDir,
    }
    
    chapters, total, err := h.chapterSvc.GetChapters(ctx, params)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", "获取章节列表失败", "")
        return
    }
    
    response.BuildPaginatedResponse(c, chapters, page, limit, int(total))
}

// GetChapter 根据ID获取章节
func (h *comicChapterHandler) GetChapter(c *gin.Context) {
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "章节ID无效", "id")
        return
    }
    
    ctx := c.Request.Context()
    
    chapter, err := h.chapterSvc.GetChapter(ctx, id)
    if err != nil {
        if errors.Is(err, repository.ErrComicChapterNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "CHAPTER_NOT_FOUND", "章节不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", "获取章节失败", "")
        return
    }
    
    response.BuildSuccessResponse(c, chapter)
}

// CreateChapter 创建章节
func (h *comicChapterHandler) CreateChapter(c *gin.Context) {
    var req CreateComicChapterRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "VALIDATION_ERROR", "请求参数验证失败", "")
        return
    }
    
    ctx := c.Request.Context()
    
    // 权限验证（参考NovelHandler的实现）
    // ...
    
    chapter := &models.ComicChapter{
        ComicID:    req.ComicID,
        Title:      req.Title,
        Description: req.Description,
        SortOrder:  req.SortOrder,
        Status:     req.Status,
        IsVip:      req.IsVip,
    }
    
    if err := h.chapterSvc.CreateChapter(ctx, chapter); err != nil {
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("创建章节失败: %v", err), "")
        return
    }
    
    response.BuildSuccessResponse(c, chapter)
}

// UpdateChapter 更新章节
func (h *comicChapterHandler) UpdateChapter(c *gin.Context) {
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "章节ID无效", "id")
        return
    }
    
    var req UpdateComicChapterRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "VALIDATION_ERROR", "请求参数验证失败", "")
        return
    }
    
    ctx := c.Request.Context()
    
    // 权限验证（参考NovelHandler的实现）
    // ...
    
    chapter := &models.ComicChapter{
        ID:          id,
        ComicID:     req.ComicID,
        Title:       req.Title,
        Description: req.Description,
        SortOrder:   req.SortOrder,
        Status:      req.Status,
        IsVip:       req.IsVip,
    }
    
    if err := h.chapterSvc.UpdateChapter(ctx, chapter); err != nil {
        if errors.Is(err, repository.ErrComicChapterNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "CHAPTER_NOT_FOUND", "章节不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("更新章节失败: %v", err), "")
        return
    }
    
    response.BuildSuccessResponse(c, chapter)
}

// DeleteChapter 删除章节
func (h *comicChapterHandler) DeleteChapter(c *gin.Context) {
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "章节ID无效", "id")
        return
    }
    
    ctx := c.Request.Context()
    
    // 权限验证（参考NovelHandler的实现）
    // ...
    
    if err := h.chapterSvc.DeleteChapter(ctx, id); err != nil {
        if errors.Is(err, repository.ErrComicChapterNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "CHAPTER_NOT_FOUND", "章节不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("删除章节失败: %v", err), "")
        return
    }
    
    response.BuildSuccessResponse(c, nil)
}

// UpdateChapterStatus 更新章节状态
func (h *comicChapterHandler) UpdateChapterStatus(c *gin.Context) {
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "INVALID_ID", "章节ID无效", "id")
        return
    }
    
    var req UpdateComicChapterStatusRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BuildErrorResponse(c, http.StatusBadRequest, "VALIDATION_ERROR", "请求参数验证失败", "")
        return
    }
    
    ctx := c.Request.Context()
    
    // 权限验证（参考NovelHandler的实现）
    // ...
    
    if err := h.chapterSvc.UpdateStatus(ctx, id, req.Status); err != nil {
        if errors.Is(err, repository.ErrComicChapterNotFound) {
            response.BuildErrorResponse(c, http.StatusNotFound, "CHAPTER_NOT_FOUND", "章节不存在", "")
            return
        }
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", fmt.Sprintf("更新章节状态失败: %v", err), "")
        return
    }
    
    chapter, err := h.chapterSvc.GetChapter(ctx, id)
    if err != nil {
        response.BuildErrorResponse(c, http.StatusInternalServerError, "INTERNAL_ERROR", "获取章节失败", "")
        return
    }
    
    response.BuildSuccessResponse(c, chapter)
}
```

### 3. 定义请求结构体

在同一个文件中定义请求结构体：

```go
// CreateComicChapterRequest 创建章节请求
type CreateComicChapterRequest struct {
    ComicID     int64   `json:"comic_id" binding:"required"`
    Title       string  `json:"title" binding:"required"`
    Description *string `json:"description,omitempty"`
    SortOrder   int     `json:"sort_order"`
    Status      string  `json:"status"`
    IsVip       bool    `json:"is_vip"`
}

// UpdateComicChapterRequest 更新章节请求
type UpdateComicChapterRequest struct {
    ComicID     int64   `json:"comic_id" binding:"required"`
    Title       string  `json:"title" binding:"required"`
    Description *string `json:"description,omitempty"`
    SortOrder   int     `json:"sort_order"`
    Status      string  `json:"status"`
    IsVip       bool    `json:"is_vip"`
}

// UpdateComicChapterStatusRequest 更新章节状态请求
type UpdateComicChapterStatusRequest struct {
    Status string `json:"status" binding:"required"`
}
```

### 4. 添加必要的导入

```go
package handler

import (
    "errors"
    "fmt"
    "net/http"
    "strconv"
    
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/models"
    "yourproject/internal/repository"
    "yourproject/internal/response"
    "yourproject/internal/service"
)
```

### 5. 注意事项

- **API规范**：所有API必须遵循OpenAPI 3.1.1规范
- **响应格式**：所有响应必须使用Envelope格式
- **权限验证**：创建、更新、删除操作需要作者或管理员权限（参考NovelHandler的实现）
- **分页支持**：GetChapters方法支持分页，需要使用BuildPaginatedResponse
- **参数验证**：使用Gin的binding进行请求参数验证
- **错误处理**：所有错误消息必须使用中文

## 验收标准

1. **接口定义完整**
   - ComicChapterHandler接口包含所有必需方法
   - 方法签名正确

2. **请求处理完整**
   - 所有CRUD操作正确实现
   - 权限验证正确
   - 参数验证正确

3. **响应格式**
   - 所有响应使用Envelope格式
   - 成功响应格式正确
   - 错误响应格式正确

4. **错误处理**
   - 所有错误消息使用中文
   - HTTP状态码使用正确

5. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范

## 相关文件

- `docs/TASKS/TASK007/TASK007-46.md` - ComicChapterService实现文档
- `docs/TASKS/TASK007/TASK007-09.md` - ComicChapter模型实现文档
- `docs/TASKS/TASK007/TASK007-61.md` - NovelChapterHandler实现参考
- `.cursor/rules/api-design.mdc` - API设计规范
- `internal/handler/comic_chapter_handler.go` - ComicChapterHandler文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-04 00:01:47 CST

