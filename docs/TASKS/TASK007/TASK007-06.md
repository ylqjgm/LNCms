# TASK007-06: 创建NovelChapter模型

## 任务信息

**任务编号**: TASK007-06  
**父任务**: TASK007  
**任务名称**: 创建NovelChapter模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 22:57:58 CST

## 任务描述

创建小说章节管理的GORM模型，定义小说章节表结构。包括：1) 创建NovelChapter模型，定义字段（包含novel_id、volume_id、title、content、word_count、sort_order、status、is_vip等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范。注意：根据数据库设计，章节内容存储在独立的novel_chapter_contents表中，章节基本信息存储在novel_chapters表中。

## 依赖任务

TASK007-05（NovelVolume模型）

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-21.md` 文档，了解novel_chapters表和novel_chapter_contents表的完整设计：
- novel_chapters表结构：id、volume_id、chapter_name、chapter_order、word_count、is_published、is_vip、published_at、view_count、created_at、updated_at
- novel_chapter_contents表结构：chapter_id（主键）、content、created_at、updated_at
- 外键关联：volume_id 关联 novel_volumes 表
- 唯一约束：volume_id + chapter_order 必须唯一
- 索引：volume_id、chapter_order、is_published、is_vip、published_at

### 2. 创建NovelChapter模型文件

在 `internal/models/` 目录下创建 `novel_chapter.go` 文件，定义NovelChapter模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// NovelChapter 小说章节模型
// 存储小说章节基本信息（不包含章节内容）
// 章节内容存储在独立的NovelChapterContent模型中
type NovelChapter struct {
    ID            int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    VolumeID      int64          `gorm:"column:volume_id;type:BIGINT;not null;index:idx_novel_chapters_volume_id;uniqueIndex:uk_novel_chapters_volume_id_chapter_order" json:"volume_id"`
    ChapterName   string         `gorm:"column:chapter_name;type:VARCHAR(200);not null" json:"chapter_name"`
    ChapterOrder  int            `gorm:"column:chapter_order;type:INTEGER;not null;default:0;index:idx_novel_chapters_chapter_order;uniqueIndex:uk_novel_chapters_volume_id_chapter_order" json:"chapter_order"`
    WordCount     int            `gorm:"column:word_count;type:INTEGER;default:0" json:"word_count"`
    IsPublished   bool           `gorm:"column:is_published;type:BOOLEAN;default:false;index:idx_novel_chapters_is_published" json:"is_published"`
    IsVip         bool           `gorm:"column:is_vip;type:BOOLEAN;default:false;index:idx_novel_chapters_is_vip" json:"is_vip"`
    PublishedAt   *time.Time     `gorm:"column:published_at;type:TIMESTAMPTZ;index:idx_novel_chapters_published_at" json:"published_at,omitempty"`
    ViewCount     int64          `gorm:"column:view_count;type:BIGINT;default:0" json:"view_count"`
    CreatedAt     time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    UpdatedAt     time.Time      `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    Volume  *NovelVolume         `gorm:"foreignKey:VolumeID;references:ID" json:"volume,omitempty"`
    Content *NovelChapterContent `gorm:"foreignKey:ChapterID;references:ID" json:"content,omitempty"`
}

// TableName 指定表名
func (NovelChapter) TableName() string {
    return "novel_chapters"
}

// BeforeCreate 创建前钩子
func (nc *NovelChapter) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if nc.CreatedAt.IsZero() {
        nc.CreatedAt = now
    }
    if nc.UpdatedAt.IsZero() {
        nc.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (nc *NovelChapter) BeforeUpdate(tx *gorm.DB) error {
    nc.UpdatedAt = time.Now()
    return nil
}
```

### 3. 创建NovelChapterContent模型文件

在 `internal/models/` 目录下的 `novel_chapter.go` 文件中，同时定义NovelChapterContent模型：

```go
// NovelChapterContent 小说章节内容模型
// 存储小说章节正文内容（大文本数据）
// 与NovelChapter为一对一关系，通过chapter_id主键关联
type NovelChapterContent struct {
    ChapterID int64     `gorm:"primaryKey;column:chapter_id;type:BIGINT" json:"chapter_id"`
    Content   string    `gorm:"column:content;type:TEXT;not null" json:"content"`
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    Chapter *NovelChapter `gorm:"foreignKey:ChapterID;references:ID" json:"chapter,omitempty"`
}

// TableName 指定表名
func (NovelChapterContent) TableName() string {
    return "novel_chapter_contents"
}

// BeforeCreate 创建前钩子
func (ncc *NovelChapterContent) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if ncc.CreatedAt.IsZero() {
        ncc.CreatedAt = now
    }
    if ncc.UpdatedAt.IsZero() {
        ncc.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (ncc *NovelChapterContent) BeforeUpdate(tx *gorm.DB) error {
    ncc.UpdatedAt = time.Now()
    return nil
}
```

### 4. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// NovelChapter 小说章节模型
// 存储小说章节基本信息（不包含章节内容）
// 章节内容存储在独立的NovelChapterContent模型中，以优化性能
// 同一分卷的章节排序必须唯一
type NovelChapter struct {
    // ID 章节ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // VolumeID 分卷ID，外键关联novel_volumes表，必填字段
    VolumeID int64 `gorm:"column:volume_id;type:BIGINT;not null;index:idx_novel_chapters_volume_id;uniqueIndex:uk_novel_chapters_volume_id_chapter_order" json:"volume_id"`
    
    // ChapterName 章节名称，必填字段
    ChapterName string `gorm:"column:chapter_name;type:VARCHAR(200);not null" json:"chapter_name"`
    
    // ChapterOrder 章节排序，数字越小越靠前，用于排序显示，默认值为0
    // 同一分卷的章节排序必须唯一
    ChapterOrder int `gorm:"column:chapter_order;type:INTEGER;not null;default:0;index:idx_novel_chapters_chapter_order;uniqueIndex:uk_novel_chapters_volume_id_chapter_order" json:"chapter_order"`
    
    // WordCount 章节字数，默认值为0
    WordCount int `gorm:"column:word_count;type:INTEGER;default:0" json:"word_count"`
    
    // IsPublished 是否发布，TRUE-已发布，FALSE-未发布，默认值为FALSE
    IsPublished bool `gorm:"column:is_published;type:BOOLEAN;default:false;index:idx_novel_chapters_is_published" json:"is_published"`
    
    // IsVip 是否VIP章节，TRUE-VIP章节需要付费，FALSE-免费章节，默认值为FALSE
    IsVip bool `gorm:"column:is_vip;type:BOOLEAN;default:false;index:idx_novel_chapters_is_vip" json:"is_vip"`
    
    // PublishedAt 发布时间，可选字段
    PublishedAt *time.Time `gorm:"column:published_at;type:TIMESTAMPTZ;index:idx_novel_chapters_published_at" json:"published_at,omitempty"`
    
    // ViewCount 浏览次数，默认值为0
    ViewCount int64 `gorm:"column:view_count;type:BIGINT;default:0" json:"view_count"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    // Volume 分卷，多对一关系
    Volume *NovelVolume `gorm:"foreignKey:VolumeID;references:ID" json:"volume,omitempty"`
    
    // Content 章节内容，一对一关系
    Content *NovelChapterContent `gorm:"foreignKey:ChapterID;references:ID" json:"content,omitempty"`
}
```

### 5. 定义模型方法

为NovelChapter模型添加常用的辅助方法：

```go
// IsPublishedStatus 检查是否已发布
func (nc *NovelChapter) IsPublishedStatus() bool {
    return nc.IsPublished
}

// IsVipChapter 检查是否为VIP章节
func (nc *NovelChapter) IsVipChapter() bool {
    return nc.IsVip
}

// HasContent 检查是否有章节内容
func (nc *NovelChapter) HasContent() bool {
    return nc.Content != nil && nc.Content.Content != ""
}
```

### 6. 注意事项

- **表拆分设计**：章节基本信息与章节内容分离存储，章节内容存储在独立的NovelChapterContent模型中
- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **唯一索引**：volume_id + chapter_order 使用uniqueIndex标签定义复合唯一索引，确保同一分卷的章节排序唯一
- **索引定义**：在GORM标签中定义索引，包括唯一索引和普通索引
- **外键关联**：使用GORM的foreignKey和references标签定义关联关系
- **一对一关系**：NovelChapterContent与NovelChapter为一对一关系，通过chapter_id主键关联
- **JSON标签**：所有字段都应有JSON标签，可选字段使用omitempty
- **指针类型**：可选字段（如PublishedAt）使用指针类型，支持NULL值
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **性能优化**：章节内容分离存储，查询章节列表时不需要加载大文本内容

## 验收标准

1. **模型结构完整**
   - NovelChapter模型包含所有必需字段
   - NovelChapterContent模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 外键索引：volume_id
   - 普通索引：chapter_order、is_published、is_vip、published_at
   - 复合唯一索引：volume_id + chapter_order
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - Volume关联关系正确
   - Content一对一关联关系正确

4. **唯一约束正确**
   - volume_id + chapter_order 使用uniqueIndex标签，确保唯一性

5. **模型方法完整**
   - IsPublishedStatus方法实现正确
   - IsVipChapter方法实现正确
   - HasContent方法实现正确

6. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

7. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/TASK002-21.md` - 小说章节表数据库设计文档
- `docs/TASKS/TASK007/TASK007-05.md` - NovelVolume模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/novel_chapter.go` - NovelChapter模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 22:57:58 CST

