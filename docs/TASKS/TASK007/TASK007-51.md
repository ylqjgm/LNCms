# TASK007-51: 创建VideoService接口和实现 - 基础CRUD

## 任务信息

**任务编号**: TASK007-51  
**父任务**: TASK007  
**任务名称**: 创建VideoService接口和实现 - 基础CRUD  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:53:38 CST

## 任务描述

创建视频服务，提供视频管理的基础CRUD功能。包括：1) 定义VideoService接口（GetVideo、GetVideos、CreateVideo、UpdateVideo、DeleteVideo等方法）；2) 实现视频查询（单个视频、视频列表，支持分页、筛选、排序）；3) 实现视频创建、更新、删除；4) 实现分类、地区和标签关联处理。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK007-33（实现VideoRepository接口和实现）、TASK007-37（创建CategoryService接口和实现）、TASK007-38（创建RegionService接口和实现）、TASK007-39（创建TagService接口和实现）

## 实现指南

### 1. 创建VideoService接口文件

在 `internal/service/` 目录下创建 `video_service.go` 文件，定义VideoService接口：

```go
package service

import (
    "context"
    "yourproject/internal/models"
)

// VideoService 视频服务接口
// 提供视频管理的业务逻辑
type VideoService interface {
    // GetVideo 根据ID获取视频
    GetVideo(ctx context.Context, id int64) (*models.Video, error)
    
    // GetVideos 获取视频列表（支持分页、筛选、排序）
    GetVideos(ctx context.Context, params *VideoQueryParams) ([]*models.Video, int64, error)
    
    // CreateVideo 创建视频
    CreateVideo(ctx context.Context, video *models.Video) error
    
    // UpdateVideo 更新视频
    UpdateVideo(ctx context.Context, video *models.Video) error
    
    // DeleteVideo 删除视频
    DeleteVideo(ctx context.Context, id int64) error
}

// VideoQueryParams 视频查询参数
type VideoQueryParams struct {
    Page          int     // 页码，从1开始
    Limit         int     // 每页数量
    Title         string  // 标题筛选（模糊匹配）
    AuthorID      *int64  // 作者ID筛选
    CategoryIDs   []int64 // 分类ID筛选
    RegionID      *int64  // 地区ID筛选
    TagIDs        []int64 // 标签ID筛选
    Status        string  // 状态筛选
    SerialStatus  string  // 连载状态筛选
    IsActive      *bool   // 是否启用筛选
    OrderBy       string  // 排序字段（title、created_at、updated_at、duration、rating）
    OrderDir      string  // 排序方向（asc、desc）
}
```

### 2. 实现VideoService接口

在同一个文件中实现VideoService接口：

```go
// videoService VideoService的实现
type videoService struct {
    videoRepo    repository.VideoRepository
    categorySvc  CategoryService
    regionSvc    RegionService
    tagSvc       TagService
}

// NewVideoService 创建VideoService实例
func NewVideoService(
    videoRepo repository.VideoRepository,
    categorySvc CategoryService,
    regionSvc RegionService,
    tagSvc TagService,
) VideoService {
    return &videoService{
        videoRepo:   videoRepo,
        categorySvc: categorySvc,
        regionSvc:   regionSvc,
        tagSvc:      tagSvc,
    }
}

// GetVideo 根据ID获取视频
func (s *videoService) GetVideo(ctx context.Context, id int64) (*models.Video, error) {
    if id <= 0 {
        return nil, errors.New("视频ID无效")
    }
    
    video, err := s.videoRepo.GetByID(ctx, id)
    if err != nil {
        return nil, fmt.Errorf("获取视频失败: %w", err)
    }
    
    return video, nil
}

// GetVideos 获取视频列表
func (s *videoService) GetVideos(ctx context.Context, params *VideoQueryParams) ([]*models.Video, int64, error) {
    // 构建查询参数
    queryParams := &repository.VideoQueryParams{
        Page:         params.Page,
        Limit:        params.Limit,
        Title:        params.Title,
        AuthorID:     params.AuthorID,
        CategoryIDs:  params.CategoryIDs,
        RegionID:     params.RegionID,
        TagIDs:       params.TagIDs,
        Status:       params.Status,
        SerialStatus: params.SerialStatus,
        IsActive:     params.IsActive,
        OrderBy:      params.OrderBy,
        OrderDir:     params.OrderDir,
    }
    
    // 验证和设置默认值
    if queryParams.Page < 1 {
        queryParams.Page = 1
    }
    if queryParams.Limit < 1 {
        queryParams.Limit = 20
    }
    if queryParams.Limit > 100 {
        queryParams.Limit = 100
    }
    if queryParams.OrderBy == "" {
        queryParams.OrderBy = "created_at"
    }
    if queryParams.OrderDir == "" {
        queryParams.OrderDir = "desc"
    }
    
    videos, total, err := s.videoRepo.GetAll(ctx, queryParams)
    if err != nil {
        return nil, 0, fmt.Errorf("获取视频列表失败: %w", err)
    }
    
    return videos, total, nil
}

// CreateVideo 创建视频
func (s *videoService) CreateVideo(ctx context.Context, video *models.Video) error {
    // 业务验证
    if err := s.validateVideo(video); err != nil {
        return err
    }
    
    // 验证分类ID
    if len(video.CategoryIDs) > 0 {
        for _, categoryID := range video.CategoryIDs {
            category, err := s.categorySvc.GetCategory(ctx, categoryID)
            if err != nil {
                return fmt.Errorf("分类ID %d 不存在", categoryID)
            }
            // 验证分类类型
            if category.CategoryType != "video" {
                return fmt.Errorf("分类ID %d 不是视频分类", categoryID)
            }
        }
    }
    
    // 验证地区ID
    if video.RegionID != nil {
        _, err := s.regionSvc.GetRegion(ctx, *video.RegionID)
        if err != nil {
            return fmt.Errorf("地区ID %d 不存在", *video.RegionID)
        }
    }
    
    // 验证标签ID
    if len(video.TagIDs) > 0 {
        for _, tagID := range video.TagIDs {
            _, err := s.tagSvc.GetTag(ctx, tagID)
            if err != nil {
                return fmt.Errorf("标签ID %d 不存在", tagID)
            }
        }
    }
    
    // 设置默认值
    if video.Status == "" {
        video.Status = "draft"
    }
    if video.SerialStatus == "" {
        video.SerialStatus = "serializing"
    }
    if video.Duration == 0 {
        video.Duration = 0
    }
    if video.Rating == 0 {
        video.Rating = 0
    }
    if video.IsActive == nil {
        active := true
        video.IsActive = &active
    }
    
    // 创建视频
    if err := s.videoRepo.Create(ctx, video); err != nil {
        return fmt.Errorf("创建视频失败: %w", err)
    }
    
    return nil
}

// UpdateVideo 更新视频
func (s *videoService) UpdateVideo(ctx context.Context, video *models.Video) error {
    // 业务验证
    if err := s.validateVideo(video); err != nil {
        return err
    }
    
    // 检查视频是否存在
    existing, err := s.videoRepo.GetByID(ctx, video.ID)
    if err != nil {
        return errors.New("视频不存在")
    }
    
    // 验证分类ID
    if len(video.CategoryIDs) > 0 {
        for _, categoryID := range video.CategoryIDs {
            category, err := s.categorySvc.GetCategory(ctx, categoryID)
            if err != nil {
                return fmt.Errorf("分类ID %d 不存在", categoryID)
            }
            // 验证分类类型
            if category.CategoryType != "video" {
                return fmt.Errorf("分类ID %d 不是视频分类", categoryID)
            }
        }
    }
    
    // 验证地区ID
    if video.RegionID != nil {
        _, err := s.regionSvc.GetRegion(ctx, *video.RegionID)
        if err != nil {
            return fmt.Errorf("地区ID %d 不存在", *video.RegionID)
        }
    }
    
    // 验证标签ID
    if len(video.TagIDs) > 0 {
        for _, tagID := range video.TagIDs {
            _, err := s.tagSvc.GetTag(ctx, tagID)
            if err != nil {
                return fmt.Errorf("标签ID %d 不存在", tagID)
            }
        }
    }
    
    // 更新视频
    if err := s.videoRepo.Update(ctx, video); err != nil {
        return fmt.Errorf("更新视频失败: %w", err)
    }
    
    return nil
}

// DeleteVideo 删除视频
func (s *videoService) DeleteVideo(ctx context.Context, id int64) error {
    if id <= 0 {
        return errors.New("视频ID无效")
    }
    
    // 检查视频是否存在
    video, err := s.videoRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("视频不存在")
    }
    
    // 删除视频
    if err := s.videoRepo.Delete(ctx, id); err != nil {
        return fmt.Errorf("删除视频失败: %w", err)
    }
    
    return nil
}

// validateVideo 验证视频数据
func (s *videoService) validateVideo(video *models.Video) error {
    if video.Title == "" {
        return errors.New("视频标题不能为空")
    }
    if len(video.Title) > 200 {
        return errors.New("视频标题长度不能超过200个字符")
    }
    
    if video.AuthorID <= 0 {
        return errors.New("作者ID无效")
    }
    
    // 验证状态
    validStatuses := []string{"draft", "reviewing", "published", "archived"}
    if video.Status != "" {
        isValid := false
        for _, validStatus := range validStatuses {
            if video.Status == validStatus {
                isValid = true
                break
            }
        }
        if !isValid {
            return errors.New("无效的视频状态")
        }
    }
    
    // 验证连载状态
    validSerialStatuses := []string{"serializing", "completed", "suspended"}
    if video.SerialStatus != "" {
        isValid := false
        for _, validStatus := range validSerialStatuses {
            if video.SerialStatus == validStatus {
                isValid = true
                break
            }
        }
        if !isValid {
            return errors.New("无效的连载状态")
        }
    }
    
    return nil
}
```

### 3. 添加必要的导入

```go
package service

import (
    "context"
    "errors"
    "fmt"
    
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 4. 注意事项

- **业务验证**：在Service层进行业务逻辑验证，包括数据有效性、业务规则等
- **错误处理**：所有错误消息必须使用中文
- **上下文传递**：所有方法都接受context.Context参数
- **关联验证**：创建和更新时验证分类、地区和标签的存在性和类型一致性
- **默认值设置**：创建时设置合理的默认值
- **依赖注入**：通过构造函数注入CategoryService、RegionService和TagService

## 验收标准

1. **接口定义完整**
   - VideoService接口包含所有必需方法
   - 方法签名正确，参数和返回值类型正确
   - VideoQueryParams结构体定义完整

2. **实现完整**
   - 所有接口方法都已实现
   - 业务逻辑正确实现

3. **业务验证**
   - 视频数据验证正确
   - 分类、地区和标签验证正确
   - 状态验证正确

4. **查询功能**
   - GetVideos方法支持分页、筛选、排序
   - 分页参数验证正确

5. **关联处理**
   - 正确验证分类ID、地区ID和标签ID
   - 验证分类类型是否为"video"

6. **错误处理**
   - 所有错误消息使用中文
   - 错误处理完整、清晰

7. **代码规范**
   - 遵循Golang编码规范
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK007/TASK007-33.md` - VideoRepository实现文档
- `docs/TASKS/TASK007/TASK007-37.md` - CategoryService实现文档
- `docs/TASKS/TASK007/TASK007-38.md` - RegionService实现文档
- `docs/TASKS/TASK007/TASK007-39.md` - TagService实现文档
- `docs/TASKS/TASK007/TASK007-15.md` - Video模型实现文档
- `docs/TASKS/TASK007/TASK007-40.md` - NovelService实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/video_service.go` - VideoService接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:53:38 CST

