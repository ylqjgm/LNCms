# TASK007-48: 创建AudioService接口和实现 - 状态和时长管理

## 任务信息

**任务编号**: TASK007-48  
**父任务**: TASK007  
**任务名称**: 创建AudioService接口和实现 - 状态和时长管理  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:43:24 CST

## 任务描述

扩展音频服务，提供音频状态管理和时长统计功能。包括：1) 扩展AudioService接口（UpdateStatus、UpdateDuration等方法）；2) 实现状态更新；3) 实现时长统计（自动计算总时长）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK007-47（创建AudioService接口和实现 - 基础CRUD）、TASK007-32（实现AudioFileRepository接口和实现）

## 实现指南

### 1. 扩展AudioService接口

在 `internal/service/audio_service.go` 文件中扩展AudioService接口，添加状态管理和时长统计方法：

```go
// AudioService 音频服务接口
// 提供音频管理的业务逻辑
type AudioService interface {
    // ... 基础CRUD方法（已在TASK007-47中定义）
    
    // UpdateStatus 更新音频状态
    UpdateStatus(ctx context.Context, id int64, status string) error
    
    // UpdateDuration 更新音频时长（自动计算）
    UpdateDuration(ctx context.Context, id int64) error
}
```

### 2. 实现状态管理和时长统计方法

在 `audio_service.go` 文件中扩展 `audioService` 结构体，添加状态管理和时长统计方法实现：

```go
// UpdateStatus 更新音频状态
func (s *audioService) UpdateStatus(ctx context.Context, id int64, status string) error {
    if id <= 0 {
        return errors.New("音频ID无效")
    }
    
    // 验证状态
    validStatuses := []string{"draft", "reviewing", "published", "archived"}
    isValid := false
    for _, validStatus := range validStatuses {
        if status == validStatus {
            isValid = true
            break
        }
    }
    if !isValid {
        return errors.New("无效的音频状态")
    }
    
    // 检查音频是否存在
    _, err := s.audioRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("音频不存在")
    }
    
    // 更新状态
    if err := s.audioRepo.UpdateStatus(ctx, id, status); err != nil {
        return fmt.Errorf("更新音频状态失败: %w", err)
    }
    
    return nil
}

// UpdateDuration 更新音频时长（自动计算）
func (s *audioService) UpdateDuration(ctx context.Context, id int64) error {
    if id <= 0 {
        return errors.New("音频ID无效")
    }
    
    // 检查音频是否存在
    audio, err := s.audioRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("音频不存在")
    }
    
    // 获取所有已发布的分集
    episodeRepo := s.episodeRepo // 需要注入AudioEpisodeRepository
    episodes, _, err := episodeRepo.GetByAudioID(ctx, id, &repository.AudioEpisodeQueryParams{
        Page:     1,
        Limit:    10000, // 获取所有分集
        Status:   "published",
        OrderBy:  "sort_order",
        OrderDir: "asc",
    })
    if err != nil {
        return fmt.Errorf("查询分集失败: %w", err)
    }
    
    // 计算总时长
    var totalDuration int64
    for _, episode := range episodes {
        // 获取分集的所有音频文件
        audioFileRepo := s.audioFileRepo // 需要注入AudioFileRepository
        audioFiles, err := audioFileRepo.GetByEpisodeID(ctx, episode.ID)
        if err != nil {
            continue // 跳过错误的分集
        }
        
        // 累加分集的时长
        for _, audioFile := range audioFiles {
            totalDuration += audioFile.Duration
        }
    }
    
    // 更新音频时长
    if err := s.audioRepo.UpdateDuration(ctx, id, totalDuration); err != nil {
        return fmt.Errorf("更新音频时长失败: %w", err)
    }
    
    return nil
}
```

### 3. 更新audioService结构体

需要在 `audioService` 结构体中添加 `episodeRepo` 和 `audioFileRepo` 字段：

```go
// audioService AudioService的实现
type audioService struct {
    audioRepo     repository.AudioRepository
    episodeRepo   repository.AudioEpisodeRepository // 新增字段
    audioFileRepo repository.AudioFileRepository    // 新增字段
    categorySvc   CategoryService
    tagSvc        TagService
}

// NewAudioService 创建AudioService实例
func NewAudioService(
    audioRepo repository.AudioRepository,
    episodeRepo repository.AudioEpisodeRepository, // 新增参数
    audioFileRepo repository.AudioFileRepository,  // 新增参数
    categorySvc CategoryService,
    tagSvc TagService,
) AudioService {
    return &audioService{
        audioRepo:     audioRepo,
        episodeRepo:   episodeRepo,   // 新增字段赋值
        audioFileRepo: audioFileRepo, // 新增字段赋值
        categorySvc:   categorySvc,
        tagSvc:        tagSvc,
    }
}
```

### 4. 注意事项

- **状态验证**：更新状态前验证状态值是否有效
- **时长统计**：自动计算所有已发布分集的音频文件总时长
- **错误处理**：所有错误消息必须使用中文
- **依赖注入**：需要注入AudioEpisodeRepository和AudioFileRepository以查询分集和文件信息
- **性能考虑**：对于大量分集和文件，考虑使用数据库聚合查询优化性能

## 验收标准

1. **接口扩展完整**
   - AudioService接口已扩展状态管理和时长统计方法
   - 方法签名正确，参数和返回值类型正确

2. **状态管理实现**
   - UpdateStatus方法能正确更新音频状态
   - 状态验证逻辑正确
   - 错误处理完善

3. **时长统计实现**
   - UpdateDuration方法能自动计算总时长
   - 正确统计所有已发布分集的音频文件总时长
   - 更新操作正确执行

4. **错误处理**
   - 所有错误消息使用中文
   - 错误处理完整、清晰

5. **代码规范**
   - 遵循Golang编码规范
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK007/TASK007-47.md` - AudioService基础CRUD实现文档
- `docs/TASKS/TASK007/TASK007-32.md` - AudioFileRepository实现文档
- `docs/TASKS/TASK007/TASK007-31.md` - AudioEpisodeRepository实现文档
- `docs/TASKS/TASK007/TASK007-41.md` - NovelService状态和统计管理实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/audio_service.go` - AudioService接口和实现文件（待扩展）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:43:24 CST

