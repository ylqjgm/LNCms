# TASK007-11: 创建Audio模型

## 任务信息

**任务编号**: TASK007-11  
**父任务**: TASK007  
**任务名称**: 创建Audio模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:05:05 CST

## 任务描述

创建音频信息管理的GORM模型，定义音频表结构。包括：1) 创建Audio模型，定义字段（包含title、description、author_id、category_ids数组、tag_ids数组、cover_url、status、serial_status、rating、duration等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范和PostgreSQL数据库设计规范。

## 依赖任务

TASK007-01（创建Category模型）、TASK006-01（创建Author模型）

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/` 文档，了解audios表的完整设计：
- 表结构：id、title、description、author_id、category_ids、tag_ids、cover_url、status、serial_status、rating、duration、word_count、view_count、like_count、favorite_count、comment_count、created_at、updated_at
- 外键关联：author_id 关联 authors 表
- 数组字段：category_ids、tag_ids 使用 PostgreSQL 数组类型
- 索引：author_id、status、serial_status、rating、created_at、复合索引等

### 2. 创建Audio模型文件

在 `internal/models/` 目录下创建 `audio.go` 文件，定义Audio模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// Audio 音频模型
// 存储音频作品的基本信息，包括标题、描述、作者、分类、标签等
// 支持连载状态管理、评分统计、播放统计等功能
type Audio struct {
    ID                int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    Title             string         `gorm:"column:title;type:VARCHAR(200);not null;index:idx_audios_title" json:"title"`
    Description       *string        `gorm:"column:description;type:TEXT" json:"description,omitempty"`
    AuthorID          int64          `gorm:"column:author_id;type:BIGINT;not null;index:idx_audios_author_id" json:"author_id"`
    CategoryIDs       pq.Int64Array  `gorm:"column:category_ids;type:BIGINT[]" json:"category_ids,omitempty"`
    TagIDs            pq.Int64Array  `gorm:"column:tag_ids;type:BIGINT[]" json:"tag_ids,omitempty"`
    CoverURL          *string        `gorm:"column:cover_url;type:VARCHAR(500)" json:"cover_url,omitempty"`
    Status            string         `gorm:"column:status;type:VARCHAR(50);not null;default:'draft';index:idx_audios_status" json:"status"`
    SerialStatus      string         `gorm:"column:serial_status;type:VARCHAR(50);not null;default:'serializing';index:idx_audios_serial_status" json:"serial_status"`
    Rating            float64        `gorm:"column:rating;type:NUMERIC(3,2);default:0.00;index:idx_audios_rating" json:"rating"`
    Duration          int            `gorm:"column:duration;type:INTEGER;default:0" json:"duration"`
    WordCount         int            `gorm:"column:word_count;type:INTEGER;default:0" json:"word_count"`
    ViewCount         int64          `gorm:"column:view_count;type:BIGINT;default:0" json:"view_count"`
    LikeCount         int64          `gorm:"column:like_count;type:BIGINT;default:0" json:"like_count"`
    FavoriteCount     int64          `gorm:"column:favorite_count;type:BIGINT;default:0" json:"favorite_count"`
    CommentCount      int64          `gorm:"column:comment_count;type:BIGINT;default:0" json:"comment_count"`
    CreatedAt         time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP;index:idx_audios_created_at" json:"created_at"`
    UpdatedAt         time.Time      `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    Author    *Author    `gorm:"foreignKey:AuthorID;references:ID" json:"author,omitempty"`
}

// TableName 指定表名
func (Audio) TableName() string {
    return "audios"
}

// BeforeCreate 创建前钩子
func (a *Audio) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if a.CreatedAt.IsZero() {
        a.CreatedAt = now
    }
    if a.UpdatedAt.IsZero() {
        a.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (a *Audio) BeforeUpdate(tx *gorm.DB) error {
    a.UpdatedAt = time.Now()
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// Audio 音频模型
// 存储音频作品的基本信息，包括标题、描述、作者、分类、标签等
// 支持连载状态管理、评分统计、播放统计等功能
type Audio struct {
    // ID 音频ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // Title 音频标题，必填字段，最大长度200字符
    Title string `gorm:"column:title;type:VARCHAR(200);not null;index:idx_audios_title" json:"title"`
    
    // Description 音频描述，说明音频的内容和特点，可选字段
    Description *string `gorm:"column:description;type:TEXT" json:"description,omitempty"`
    
    // AuthorID 作者ID，外键关联authors表，必填字段
    AuthorID int64 `gorm:"column:author_id;type:BIGINT;not null;index:idx_audios_author_id" json:"author_id"`
    
    // CategoryIDs 分类ID数组，支持多个分类，使用PostgreSQL数组类型
    CategoryIDs pq.Int64Array `gorm:"column:category_ids;type:BIGINT[]" json:"category_ids,omitempty"`
    
    // TagIDs 标签ID数组，支持多个标签，使用PostgreSQL数组类型
    TagIDs pq.Int64Array `gorm:"column:tag_ids;type:BIGINT[]" json:"tag_ids,omitempty"`
    
    // CoverURL 封面图片URL，可选字段，最大长度500字符
    CoverURL *string `gorm:"column:cover_url;type:VARCHAR(500)" json:"cover_url,omitempty"`
    
    // Status 音频状态：draft-草稿、pending-审核中、published-已发布、archived-已归档
    // 必须符合检查约束，默认值为draft
    Status string `gorm:"column:status;type:VARCHAR(50);not null;default:'draft';index:idx_audios_status" json:"status"`
    
    // SerialStatus 连载状态：serializing-连载中、completed-已完结、suspended-已暂停
    // 必须符合检查约束，默认值为serializing
    SerialStatus string `gorm:"column:serial_status;type:VARCHAR(50);not null;default:'serializing';index:idx_audios_serial_status" json:"serial_status"`
    
    // Rating 评分，范围0.00-10.00，精确到小数点后2位，默认值为0.00
    Rating float64 `gorm:"column:rating;type:NUMERIC(3,2);default:0.00;index:idx_audios_rating" json:"rating"`
    
    // Duration 总时长（秒），默认值为0
    Duration int `gorm:"column:duration;type:INTEGER;default:0" json:"duration"`
    
    // WordCount 总字数，默认值为0
    WordCount int `gorm:"column:word_count;type:INTEGER;default:0" json:"word_count"`
    
    // ViewCount 播放次数，默认值为0
    ViewCount int64 `gorm:"column:view_count;type:BIGINT;default:0" json:"view_count"`
    
    // LikeCount 点赞次数，默认值为0
    LikeCount int64 `gorm:"column:like_count;type:BIGINT;default:0" json:"like_count"`
    
    // FavoriteCount 收藏次数，默认值为0
    FavoriteCount int64 `gorm:"column:favorite_count;type:BIGINT;default:0" json:"favorite_count"`
    
    // CommentCount 评论次数，默认值为0
    CommentCount int64 `gorm:"column:comment_count;type:BIGINT;default:0" json:"comment_count"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP;index:idx_audios_created_at" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    // Author 作者信息，外键关联authors表
    Author *Author `gorm:"foreignKey:AuthorID;references:ID" json:"author,omitempty"`
}
```

### 4. 导入必要的包

在文件开头添加必要的导入：

```go
package models

import (
    "time"
    "github.com/lib/pq"
    "gorm.io/gorm"
)
```

### 5. 定义模型方法

为Audio模型添加常用的辅助方法：

```go
// IsPublished 检查音频是否已发布
func (a *Audio) IsPublished() bool {
    return a.Status == "published"
}

// IsCompleted 检查音频是否已完结
func (a *Audio) IsCompleted() bool {
    return a.SerialStatus == "completed"
}

// HasCategory 检查音频是否包含指定分类
func (a *Audio) HasCategory(categoryID int64) bool {
    for _, id := range a.CategoryIDs {
        if id == categoryID {
            return true
        }
    }
    return false
}

// HasTag 检查音频是否包含指定标签
func (a *Audio) HasTag(tagID int64) bool {
    for _, id := range a.TagIDs {
        if id == tagID {
            return true
        }
    }
    return false
}

// ValidateStatus 验证状态值是否有效
func (a *Audio) ValidateStatus() bool {
    validStatuses := []string{"draft", "pending", "published", "archived"}
    for _, validStatus := range validStatuses {
        if a.Status == validStatus {
            return true
        }
    }
    return false
}

// ValidateSerialStatus 验证连载状态值是否有效
func (a *Audio) ValidateSerialStatus() bool {
    validStatuses := []string{"serializing", "completed", "suspended"}
    for _, validStatus := range validStatuses {
        if a.SerialStatus == validStatus {
            return true
        }
    }
    return false
}
```

### 6. 注意事项

- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **数组字段**：使用 `pq.Int64Array` 类型处理PostgreSQL数组字段
- **索引定义**：在GORM标签中定义索引，包括author_id、status、serial_status、rating、created_at等
- **外键关联**：使用GORM的foreignKey和references标签定义与Author的关联关系
- **JSON标签**：所有字段都应有JSON标签，可选字段使用omitempty
- **指针类型**：可选字段（如Description、CoverURL等）使用指针类型，支持NULL值
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **检查约束**：status和serial_status字段需要在应用层进行验证，确保符合数据库约束
- **统计字段**：view_count、like_count、favorite_count、comment_count等统计字段使用BIGINT类型

## 验收标准

1. **模型结构完整**
   - Audio模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 普通索引：title、author_id、status、serial_status、rating、created_at
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - Author外键关联关系正确

4. **模型方法完整**
   - IsPublished方法实现正确
   - IsCompleted方法实现正确
   - HasCategory方法实现正确
   - HasTag方法实现正确
   - ValidateStatus方法实现正确
   - ValidateSerialStatus方法实现正确

5. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/` - 音频表数据库设计文档
- `docs/TASKS/TASK006/TASK006-01.md` - Author模型实现参考
- `docs/TASKS/TASK007/TASK007-01.md` - Category模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/audio.go` - Audio模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:05:05 CST

