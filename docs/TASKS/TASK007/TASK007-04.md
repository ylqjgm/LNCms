# TASK007-04: 创建Novel模型

## 任务信息

**任务编号**: TASK007-04  
**父任务**: TASK007  
**任务名称**: 创建Novel模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 22:52:51 CST

## 任务描述

创建小说信息管理的GORM模型，定义小说表结构。包括：1) 创建Novel模型，定义字段（包含title、description、author_id、category_id、cover_url、status、serial_status、rating、word_count等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范。小说与分类为多对一关系（通过category_id），与标签为多对多关系（通过content_tags关联表）。

## 依赖任务

TASK007-01（Category模型）、TASK006-01（Author模型）

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-19.md` 文档，了解novels表的完整设计：
- 表结构：id、author_id、category_id、title、subtitle、description、cover_url、status、serial_status、is_published、is_shelved、published_at、word_count、view_count、favorite_count、rating、rating_count、created_at、updated_at
- 外键关联：author_id 关联 authors 表、category_id 关联 categories 表
- 检查约束：status 必须是 'draft'、'published'、'archived'、'deleted' 之一；serial_status 必须是 'serializing'、'completed'、'suspended' 之一
- 索引：author_id、category_id、title、status、serial_status、is_published、is_shelved、published_at、created_at、rating等

### 2. 创建Novel模型文件

在 `internal/models/` 目录下创建 `novel.go` 文件，定义Novel模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// Novel 小说模型
// 存储小说基本信息，包括标题、简介、封面、状态等
// 关联作者、分类等信息
type Novel struct {
    ID              int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    AuthorID        int64          `gorm:"column:author_id;type:BIGINT;not null;index:idx_novels_author_id;index:idx_novels_author_status" json:"author_id"`
    CategoryID      *int64         `gorm:"column:category_id;type:BIGINT;index:idx_novels_category_id;index:idx_novels_category_status" json:"category_id,omitempty"`
    Title           string         `gorm:"column:title;type:VARCHAR(200);not null;index:idx_novels_title" json:"title"`
    Subtitle        *string        `gorm:"column:subtitle;type:VARCHAR(200)" json:"subtitle,omitempty"`
    Description     *string        `gorm:"column:description;type:TEXT" json:"description,omitempty"`
    CoverURL        *string        `gorm:"column:cover_url;type:VARCHAR(500)" json:"cover_url,omitempty"`
    Status          string         `gorm:"column:status;type:VARCHAR(20);not null;default:'draft';index:idx_novels_status;index:idx_novels_author_status;index:idx_novels_category_status" json:"status"`
    SerialStatus    string         `gorm:"column:serial_status;type:VARCHAR(20);not null;default:'serializing';index:idx_novels_serial_status" json:"serial_status"`
    IsPublished     bool           `gorm:"column:is_published;type:BOOLEAN;default:false;index:idx_novels_is_published;index:idx_novels_published_created;index:idx_novels_shelved_published" json:"is_published"`
    IsShelved       bool           `gorm:"column:is_shelved;type:BOOLEAN;default:false;index:idx_novels_is_shelved;index:idx_novels_shelved_published" json:"is_shelved"`
    PublishedAt     *time.Time     `gorm:"column:published_at;type:TIMESTAMPTZ;index:idx_novels_published_at" json:"published_at,omitempty"`
    WordCount       int64          `gorm:"column:word_count;type:BIGINT;default:0" json:"word_count"`
    ViewCount       int64          `gorm:"column:view_count;type:BIGINT;default:0" json:"view_count"`
    FavoriteCount   int64          `gorm:"column:favorite_count;type:BIGINT;default:0" json:"favorite_count"`
    Rating          float64        `gorm:"column:rating;type:DECIMAL(3,2);default:0.00;index:idx_novels_rating" json:"rating"`
    RatingCount      int64          `gorm:"column:rating_count;type:BIGINT;default:0" json:"rating_count"`
    CreatedAt       time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP;index:idx_novels_created_at;index:idx_novels_published_created" json:"created_at"`
    UpdatedAt       time.Time      `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    Author          *Author        `gorm:"foreignKey:AuthorID;references:ID" json:"author,omitempty"`
    Category        *Category      `gorm:"foreignKey:CategoryID;references:ID" json:"category,omitempty"`
    Tags            []Tag          `gorm:"many2many:content_tags;joinForeignKey:content_id;joinReferences:tag_id;foreignKey:ID;references:ID" json:"tags,omitempty"`
}

// TableName 指定表名
func (Novel) TableName() string {
    return "novels"
}

// BeforeCreate 创建前钩子
func (n *Novel) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if n.CreatedAt.IsZero() {
        n.CreatedAt = now
    }
    if n.UpdatedAt.IsZero() {
        n.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (n *Novel) BeforeUpdate(tx *gorm.DB) error {
    n.UpdatedAt = time.Now()
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// Novel 小说模型
// 存储小说基本信息，包括标题、简介、封面、状态等
// 关联作者、分类等信息
// 与标签为多对多关系，通过content_tags关联表实现
type Novel struct {
    // ID 小说ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // AuthorID 作者ID，外键关联authors表，必填字段
    AuthorID int64 `gorm:"column:author_id;type:BIGINT;not null;index:idx_novels_author_id;index:idx_novels_author_status" json:"author_id"`
    
    // CategoryID 分类ID，外键关联categories表，一部小说只支持一个分类，可选字段
    CategoryID *int64 `gorm:"column:category_id;type:BIGINT;index:idx_novels_category_id;index:idx_novels_category_status" json:"category_id,omitempty"`
    
    // Title 小说标题，必填字段
    Title string `gorm:"column:title;type:VARCHAR(200);not null;index:idx_novels_title" json:"title"`
    
    // Subtitle 小说副标题，可选字段
    Subtitle *string `gorm:"column:subtitle;type:VARCHAR(200)" json:"subtitle,omitempty"`
    
    // Description 小说简介，可选字段
    Description *string `gorm:"column:description;type:TEXT" json:"description,omitempty"`
    
    // CoverURL 封面URL，小说封面图片地址，可选字段
    CoverURL *string `gorm:"column:cover_url;type:VARCHAR(500)" json:"cover_url,omitempty"`
    
    // Status 小说状态：draft-草稿、published-已发布、archived-已归档、deleted-已删除
    // 必须符合检查约束：IN ('draft', 'published', 'archived', 'deleted')
    // 默认值为'draft'
    Status string `gorm:"column:status;type:VARCHAR(20);not null;default:'draft';index:idx_novels_status;index:idx_novels_author_status;index:idx_novels_category_status" json:"status"`
    
    // SerialStatus 连载状态：serializing-连载中、completed-已完结、suspended-断更
    // 必须符合检查约束：IN ('serializing', 'completed', 'suspended')
    // 默认值为'serializing'
    SerialStatus string `gorm:"column:serial_status;type:VARCHAR(20);not null;default:'serializing';index:idx_novels_serial_status" json:"serial_status"`
    
    // IsPublished 是否发布，TRUE-已发布，FALSE-未发布，默认值为FALSE
    IsPublished bool `gorm:"column:is_published;type:BOOLEAN;default:false;index:idx_novels_is_published;index:idx_novels_published_created;index:idx_novels_shelved_published" json:"is_published"`
    
    // IsShelved 是否上架，TRUE-已上架（收费模式），FALSE-未上架（免费模式），默认值为FALSE
    IsShelved bool `gorm:"column:is_shelved;type:BOOLEAN;default:false;index:idx_novels_is_shelved;index:idx_novels_shelved_published" json:"is_shelved"`
    
    // PublishedAt 发布时间，可选字段
    PublishedAt *time.Time `gorm:"column:published_at;type:TIMESTAMPTZ;index:idx_novels_published_at" json:"published_at,omitempty"`
    
    // WordCount 总字数，默认值为0
    WordCount int64 `gorm:"column:word_count;type:BIGINT;default:0" json:"word_count"`
    
    // ViewCount 浏览次数，默认值为0
    ViewCount int64 `gorm:"column:view_count;type:BIGINT;default:0" json:"view_count"`
    
    // FavoriteCount 收藏次数，默认值为0
    FavoriteCount int64 `gorm:"column:favorite_count;type:BIGINT;default:0" json:"favorite_count"`
    
    // Rating 评分，范围0.00-10.00，默认值为0.00
    Rating float64 `gorm:"column:rating;type:DECIMAL(3,2);default:0.00;index:idx_novels_rating" json:"rating"`
    
    // RatingCount 评分人数，默认值为0
    RatingCount int64 `gorm:"column:rating_count;type:BIGINT;default:0" json:"rating_count"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP;index:idx_novels_created_at;index:idx_novels_published_created" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    // Author 作者，多对一关系
    Author *Author `gorm:"foreignKey:AuthorID;references:ID" json:"author,omitempty"`
    
    // Category 分类，多对一关系
    Category *Category `gorm:"foreignKey:CategoryID;references:ID" json:"category,omitempty"`
    
    // Tags 标签列表，多对多关系，通过content_tags关联表实现
    // 注意：content_tags表使用多态关联，需要在应用层处理content_type字段
    Tags []Tag `gorm:"many2many:content_tags;joinForeignKey:content_id;joinReferences:tag_id;foreignKey:ID;references:ID" json:"tags,omitempty"`
}
```

### 4. 定义模型方法

为Novel模型添加常用的辅助方法：

```go
// IsDraft 检查是否为草稿状态
func (n *Novel) IsDraft() bool {
    return n.Status == "draft"
}

// IsPublished 检查是否已发布
func (n *Novel) IsPublishedStatus() bool {
    return n.Status == "published"
}

// IsArchived 检查是否已归档
func (n *Novel) IsArchived() bool {
    return n.Status == "archived"
}

// IsDeleted 检查是否已删除
func (n *Novel) IsDeleted() bool {
    return n.Status == "deleted"
}

// IsSerializing 检查是否连载中
func (n *Novel) IsSerializing() bool {
    return n.SerialStatus == "serializing"
}

// IsCompleted 检查是否已完结
func (n *Novel) IsCompleted() bool {
    return n.SerialStatus == "completed"
}

// IsSuspended 检查是否断更
func (n *Novel) IsSuspended() bool {
    return n.SerialStatus == "suspended"
}

// ValidateStatus 验证状态是否有效
func (n *Novel) ValidateStatus() bool {
    validStatuses := []string{"draft", "published", "archived", "deleted"}
    for _, validStatus := range validStatuses {
        if n.Status == validStatus {
            return true
        }
    }
    return false
}

// ValidateSerialStatus 验证连载状态是否有效
func (n *Novel) ValidateSerialStatus() bool {
    validStatuses := []string{"serializing", "completed", "suspended"}
    for _, validStatus := range validStatuses {
        if n.SerialStatus == validStatus {
            return true
        }
    }
    return false
}
```

### 5. 注意事项

- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **索引定义**：在GORM标签中定义索引，包括普通索引和复合索引
- **外键关联**：使用GORM的foreignKey和references标签定义关联关系
- **多对多关联**：Tags字段使用many2many标签，但需要注意content_tags表使用多态关联（content_type字段），需要在应用层处理
- **JSON标签**：所有字段都应有JSON标签，可选字段使用omitempty
- **指针类型**：可选字段（如CategoryID、Subtitle、Description、CoverURL、PublishedAt等）使用指针类型，支持NULL值
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **检查约束**：status和serial_status字段需要在应用层进行验证，确保符合数据库约束
- **评分字段**：rating字段使用DECIMAL类型，在GORM中使用float64类型映射

## 验收标准

1. **模型结构完整**
   - Novel模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 外键索引：author_id、category_id
   - 普通索引：title、status、serial_status、is_published、is_shelved、published_at、created_at、rating
   - 复合索引：author_id + status、category_id + status、is_published + created_at、is_shelved + is_published
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - Author关联关系正确
   - Category关联关系正确
   - Tags多对多关联关系正确（注意content_tags表的多态关联）

4. **模型方法完整**
   - IsDraft方法实现正确
   - IsPublishedStatus方法实现正确
   - IsArchived方法实现正确
   - IsDeleted方法实现正确
   - IsSerializing方法实现正确
   - IsCompleted方法实现正确
   - IsSuspended方法实现正确
   - ValidateStatus方法实现正确
   - ValidateSerialStatus方法实现正确

5. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/TASK002-19.md` - 小说表数据库设计文档
- `docs/TASKS/TASK002/TASK002-32.md` - 内容标签关联表设计文档
- `docs/TASKS/TASK006/TASK006-01.md` - Author模型实现参考
- `docs/TASKS/TASK007/TASK007-01.md` - Category模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/novel.go` - Novel模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 22:52:51 CST

