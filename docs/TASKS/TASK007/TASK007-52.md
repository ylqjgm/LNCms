# TASK007-52: 创建VideoService接口和实现 - 状态和时长管理

## 任务信息

**任务编号**: TASK007-52  
**父任务**: TASK007  
**任务名称**: 创建VideoService接口和实现 - 状态和时长管理  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 23:53:38 CST

## 任务描述

扩展视频服务，提供视频状态管理和时长统计功能。包括：1) 扩展VideoService接口（UpdateStatus、UpdateDuration等方法）；2) 实现状态更新（草稿、审核中、已发布、已下架等）；3) 实现时长统计（自动计算总时长）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK007-51（创建VideoService接口和实现 - 基础CRUD）、TASK007-36（实现VideoFileRepository接口和实现）

## 实现指南

### 1. 扩展VideoService接口

在 `internal/service/video_service.go` 文件中扩展VideoService接口：

```go
// VideoService 视频服务接口
// 提供视频管理的业务逻辑
type VideoService interface {
    // GetVideo 根据ID获取视频
    GetVideo(ctx context.Context, id int64) (*models.Video, error)
    
    // GetVideos 获取视频列表（支持分页、筛选、排序）
    GetVideos(ctx context.Context, params *VideoQueryParams) ([]*models.Video, int64, error)
    
    // CreateVideo 创建视频
    CreateVideo(ctx context.Context, video *models.Video) error
    
    // UpdateVideo 更新视频
    UpdateVideo(ctx context.Context, video *models.Video) error
    
    // DeleteVideo 删除视频
    DeleteVideo(ctx context.Context, id int64) error
    
    // UpdateStatus 更新视频状态
    UpdateStatus(ctx context.Context, id int64, status string) error
    
    // UpdateDuration 更新视频总时长（自动计算）
    UpdateDuration(ctx context.Context, id int64) error
}
```

### 2. 实现状态更新方法

在 `videoService` 结构体中实现 `UpdateStatus` 方法：

```go
// UpdateStatus 更新视频状态
func (s *videoService) UpdateStatus(ctx context.Context, id int64, status string) error {
    if id <= 0 {
        return errors.New("视频ID无效")
    }
    
    // 验证状态
    validStatuses := []string{"draft", "reviewing", "published", "archived"}
    isValid := false
    for _, validStatus := range validStatuses {
        if status == validStatus {
            isValid = true
            break
        }
    }
    if !isValid {
        return errors.New("无效的视频状态")
    }
    
    // 检查视频是否存在
    video, err := s.videoRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("视频不存在")
    }
    
    // 更新状态
    if err := s.videoRepo.UpdateStatus(ctx, id, status); err != nil {
        return fmt.Errorf("更新视频状态失败: %w", err)
    }
    
    return nil
}
```

### 3. 实现时长统计方法

在 `videoService` 结构体中实现 `UpdateDuration` 方法：

```go
// UpdateDuration 更新视频总时长（自动计算）
func (s *videoService) UpdateDuration(ctx context.Context, id int64) error {
    if id <= 0 {
        return errors.New("视频ID无效")
    }
    
    // 检查视频是否存在
    video, err := s.videoRepo.GetByID(ctx, id)
    if err != nil {
        return errors.New("视频不存在")
    }
    
    // 获取所有已发布的分集
    episodes, _, err := s.videoEpisodeRepo.GetByVideoID(ctx, id, &repository.VideoEpisodeQueryParams{
        Page:     1,
        Limit:    10000,
        Status:   "published",
        OrderBy:  "sort_order",
        OrderDir: "asc",
    })
    if err != nil {
        return fmt.Errorf("获取视频分集失败: %w", err)
    }
    
    // 计算总时长
    totalDuration := int64(0)
    for _, episode := range episodes {
        // 获取分集的所有文件
        files, err := s.videoFileRepo.GetByEpisodeID(ctx, episode.ID)
        if err != nil {
            continue
        }
        
        // 累加分集文件时长
        for _, file := range files {
            if file.Duration > 0 {
                totalDuration += file.Duration
            }
        }
    }
    
    // 更新视频总时长
    if err := s.videoRepo.UpdateDuration(ctx, id, totalDuration); err != nil {
        return fmt.Errorf("更新视频总时长失败: %w", err)
    }
    
    return nil
}
```

### 4. 更新videoService结构体

需要在 `videoService` 结构体中添加 `videoEpisodeRepo` 和 `videoFileRepo` 依赖：

```go
// videoService VideoService的实现
type videoService struct {
    videoRepo        repository.VideoRepository
    videoEpisodeRepo repository.VideoEpisodeRepository
    videoFileRepo    repository.VideoFileRepository
    categorySvc      CategoryService
    regionSvc        RegionService
    tagSvc           TagService
}

// NewVideoService 创建VideoService实例
func NewVideoService(
    videoRepo repository.VideoRepository,
    videoEpisodeRepo repository.VideoEpisodeRepository,
    videoFileRepo repository.VideoFileRepository,
    categorySvc CategoryService,
    regionSvc RegionService,
    tagSvc TagService,
) VideoService {
    return &videoService{
        videoRepo:        videoRepo,
        videoEpisodeRepo: videoEpisodeRepo,
        videoFileRepo:    videoFileRepo,
        categorySvc:       categorySvc,
        regionSvc:        regionSvc,
        tagSvc:           tagSvc,
    }
}
```

### 5. 注意事项

- **状态验证**：更新状态前验证状态值是否有效
- **时长计算**：只计算已发布分集的时长
- **文件时长**：从VideoFile表中获取文件时长并累加
- **错误处理**：所有错误消息必须使用中文
- **依赖注入**：需要在构造函数中添加VideoEpisodeRepository和VideoFileRepository依赖

## 验收标准

1. **接口扩展完整**
   - VideoService接口包含UpdateStatus和UpdateDuration方法
   - 方法签名正确，参数和返回值类型正确

2. **状态更新实现**
   - UpdateStatus方法正确实现
   - 状态验证正确
   - 状态更新成功

3. **时长统计实现**
   - UpdateDuration方法正确实现
   - 只计算已发布分集的时长
   - 正确累加文件时长
   - 总时长更新成功

4. **依赖注入**
   - videoService结构体包含必要的Repository依赖
   - 构造函数正确注入所有依赖

5. **错误处理**
   - 所有错误消息使用中文
   - 错误处理完整、清晰

6. **代码规范**
   - 遵循Golang编码规范
   - 代码注释完整（使用中文）

## 相关文件

- `docs/TASKS/TASK007/TASK007-51.md` - VideoService基础CRUD实现文档
- `docs/TASKS/TASK007/TASK007-36.md` - VideoFileRepository实现文档
- `docs/TASKS/TASK007/TASK007-35.md` - VideoEpisodeRepository实现文档
- `docs/TASKS/TASK007/TASK007-41.md` - NovelService状态和统计管理实现参考
- `docs/TASKS/TASK007/TASK007-48.md` - AudioService状态和时长管理实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/video_service.go` - VideoService接口和实现文件（待扩展）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 23:53:38 CST

