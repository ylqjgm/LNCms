# TASK005-16: 创建UserService接口和实现 - 审核和密码管理

## 任务信息

**任务编号**: TASK005-16  
**父任务**: TASK005  
**任务名称**: 创建UserService接口和实现 - 审核和密码管理  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:26:31 CST

## 任务描述

扩展用户服务，提供用户审核和密码管理功能。包括：1) 扩展UserService接口（ApproveUser、RejectUser、ResetPassword方法）；2) 实现用户审核（如果注册需要审核，设置用户状态为已审核）；3) 实现密码重置（管理员重置用户密码）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK005-14（创建UserService接口和实现 - 基础CRUD）、TASK005-07（创建PasswordService接口和实现）

## 实现指南

### 1. 扩展UserService接口

在 `internal/service/user_service.go` 文件中，扩展UserService接口：

```go
// UserService 用户服务接口
// 提供用户管理的CRUD功能、状态管理功能、审核功能和密码管理功能
type UserService interface {
    // GetUser 根据ID获取用户
    GetUser(ctx context.Context, userID int64) (*dto.UserInfo, error)
    
    // GetUsers 获取用户列表，支持分页和筛选
    GetUsers(ctx context.Context, params *dto.UserQueryParams) (*dto.UserListResponse, error)
    
    // CreateUser 创建用户（管理员操作）
    CreateUser(ctx context.Context, req *dto.CreateUserRequest) (*dto.UserInfo, error)
    
    // UpdateUser 更新用户信息
    UpdateUser(ctx context.Context, userID int64, req *dto.UpdateUserRequest) (*dto.UserInfo, error)
    
    // DeleteUser 删除用户
    DeleteUser(ctx context.Context, userID int64) error
    
    // UpdateStatus 更新用户状态（激活/禁用）
    UpdateStatus(ctx context.Context, userID int64, isActive bool) (*dto.UserInfo, error)
    
    // BanUser 封禁用户
    BanUser(ctx context.Context, userID int64, req *dto.BanUserRequest) (*dto.UserInfo, error)
    
    // UnbanUser 解封用户
    UnbanUser(ctx context.Context, userID int64) (*dto.UserInfo, error)
    
    // ApproveUser 审核通过用户
    // 如果注册需要审核，设置用户状态为已审核（is_active为true）
    ApproveUser(ctx context.Context, userID int64) (*dto.UserInfo, error)
    
    // RejectUser 审核拒绝用户（可选）
    // 可以删除用户或设置用户状态为未激活
    RejectUser(ctx context.Context, userID int64, reason string) error
    
    // ResetPassword 重置用户密码（管理员操作）
    // 生成新密码并更新用户密码哈希
    ResetPassword(ctx context.Context, userID int64, req *dto.ResetPasswordRequest) error
}
```

### 2. 定义审核和密码管理DTO

在 `internal/dto/user_dto.go` 文件中，添加相关DTO：

```go
// ResetPasswordRequest 重置密码请求
type ResetPasswordRequest struct {
    NewPassword string `json:"new_password" binding:"required,min=8"` // 新密码
    // 或者使用自动生成密码
    AutoGenerate bool   `json:"auto_generate,omitempty"`              // 是否自动生成密码
}
```

### 3. 实现ApproveUser方法

```go
// ApproveUser 审核通过用户
func (s *userService) ApproveUser(ctx context.Context, userID int64) (*dto.UserInfo, error) {
    if userID <= 0 {
        return nil, errors.New("用户ID无效")
    }
    
    // 检查用户是否存在
    user, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return nil, fmt.Errorf("用户不存在: %w", err)
    }
    
    // 检查用户是否已经激活
    if user.IsActive {
        return nil, errors.New("用户已激活，无需审核")
    }
    
    // 激活用户（设置is_active为true）
    updateReq := &dto.UpdateUserRequest{
        IsActive: boolPtr(true),
    }
    
    userInfo, err := s.UpdateUser(ctx, userID, updateReq)
    if err != nil {
        return nil, fmt.Errorf("审核通过用户失败: %w", err)
    }
    
    // TODO: 可以在这里发送审核通过通知邮件
    // s.emailService.SendApprovalNotification(ctx, user.Email)
    
    return userInfo, nil
}
```

### 4. 实现RejectUser方法

```go
// RejectUser 审核拒绝用户
func (s *userService) RejectUser(ctx context.Context, userID int64, reason string) error {
    if userID <= 0 {
        return errors.New("用户ID无效")
    }
    
    // 检查用户是否存在
    user, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return fmt.Errorf("用户不存在: %w", err)
    }
    
    // 检查用户是否已经激活
    if user.IsActive {
        return errors.New("用户已激活，无法拒绝审核")
    }
    
    // 选项1：删除用户（推荐用于拒绝注册申请）
    if err := s.userRepo.Delete(ctx, userID); err != nil {
        return fmt.Errorf("删除用户失败: %w", err)
    }
    
    // 选项2：保持用户但设置为未激活（如果需要在数据库中保留记录）
    // updateReq := &dto.UpdateUserRequest{
    //     IsActive: boolPtr(false),
    // }
    // if _, err := s.UpdateUser(ctx, userID, updateReq); err != nil {
    //     return fmt.Errorf("拒绝审核失败: %w", err)
    // }
    
    // TODO: 可以在这里发送审核拒绝通知邮件
    // s.emailService.SendRejectionNotification(ctx, user.Email, reason)
    
    return nil
}
```

### 5. 实现ResetPassword方法

```go
// ResetPassword 重置用户密码（管理员操作）
func (s *userService) ResetPassword(ctx context.Context, userID int64, req *dto.ResetPasswordRequest) error {
    if userID <= 0 {
        return errors.New("用户ID无效")
    }
    
    // 检查用户是否存在
    user, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return fmt.Errorf("用户不存在: %w", err)
    }
    
    var newPassword string
    
    // 根据请求决定是使用提供的密码还是自动生成
    if req.AutoGenerate {
        // 自动生成密码
        generatedPassword, err := s.passwordService.GenerateRandomPassword(12)
        if err != nil {
            return fmt.Errorf("生成随机密码失败: %w", err)
        }
        newPassword = generatedPassword
    } else {
        // 使用提供的密码
        if req.NewPassword == "" {
            return errors.New("新密码不能为空")
        }
        
        // 验证密码强度
        if err := s.passwordService.ValidatePasswordStrength(req.NewPassword); err != nil {
            return fmt.Errorf("密码强度不符合要求: %w", err)
        }
        
        newPassword = req.NewPassword
    }
    
    // 哈希新密码
    passwordHash, err := s.passwordService.HashPassword(newPassword)
    if err != nil {
        return fmt.Errorf("密码加密失败: %w", err)
    }
    
    // 更新用户密码
    user.PasswordHash = passwordHash
    if err := s.userRepo.Update(ctx, user); err != nil {
        return fmt.Errorf("更新密码失败: %w", err)
    }
    
    // TODO: 如果自动生成密码，可以在这里发送邮件通知用户新密码
    // if req.AutoGenerate {
    //     s.emailService.SendPasswordResetNotification(ctx, user.Email, newPassword)
    // }
    
    return nil
}
```

### 6. 添加必要的导入

```go
package service

import (
    "context"
    "errors"
    "fmt"
    
    "yourproject/internal/dto"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 7. 注意事项

- **审核功能**：ApproveUser用于审核通过用户，RejectUser用于审核拒绝用户
- **密码重置**：ResetPassword支持管理员重置用户密码，可以自动生成或使用指定密码
- **密码强度**：重置密码时验证密码强度
- **通知功能**：审核和密码重置后可以发送通知邮件（可选）
- **错误处理**：所有错误消息使用中文，清晰描述问题
- **权限控制**：这些操作通常需要管理员权限，在API层进行权限验证

## 验收标准

1. **接口扩展完整**
   - UserService接口包含ApproveUser、RejectUser、ResetPassword方法
   - 方法签名正确，参数和返回值类型正确

2. **审核功能**
   - ApproveUser方法正确实现
   - 正确激活用户（设置is_active为true）
   - 检查用户状态，避免重复审核

3. **拒绝审核功能**
   - RejectUser方法正确实现
   - 正确删除用户或设置用户状态为未激活
   - 支持拒绝原因（可选）

4. **密码重置功能**
   - ResetPassword方法正确实现
   - 支持自动生成密码
   - 支持指定新密码
   - 验证密码强度
   - 正确更新用户密码哈希

5. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文
   - 状态检查正确

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循安全开发规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/user_service.go` - UserService接口和实现文件
- `internal/service/password_service.go` - PasswordService实现文件
- `internal/dto/user_dto.go` - 用户相关DTO文件
- `internal/repository/user_repository.go` - UserRepository实现文件
- `.cursor/rules/security.mdc` - 应用安全开发规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:26:31 CST

