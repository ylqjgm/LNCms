# TASK005-06: 编写UserRepository单元测试

## 任务信息

**任务编号**: TASK005-06  
**父任务**: TASK005  
**任务名称**: 编写UserRepository单元测试  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:06:59 CST

## 任务描述

编写用户仓储层单元测试。包括：1) 测试UserRepository的所有方法；2) 测试正常情况、边界情况和异常情况；3) 使用测试数据库或Mock进行测试；4) 确保测试覆盖率达标（80%以上）。所有测试用例描述和错误消息必须使用中文。

## 依赖任务

TASK005-04（实现UserRepository接口和实现）

## 实现指南

### 1. 创建测试文件

在 `internal/repository/` 目录下创建 `user_repository_test.go` 文件：

```go
package repository

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    "github.com/stretchr/testify/suite"
    "gorm.io/driver/postgres"
    "gorm.io/gorm"
    "yourproject/internal/models"
)
```

### 2. 创建测试套件

使用testify/suite创建测试套件，便于管理测试数据库和共享测试资源：

```go
// UserRepositoryTestSuite UserRepository测试套件
type UserRepositoryTestSuite struct {
    suite.Suite
    db     *gorm.DB
    repo   UserRepository
    ctx    context.Context
}

// SetupSuite 测试套件初始化
func (s *UserRepositoryTestSuite) SetupSuite() {
    // 连接测试数据库
    dsn := "host=localhost user=test password=test dbname=test_db port=5432 sslmode=disable"
    db, err := gorm.Open(postgres.Open(dsn), &gorm.Config{})
    require.NoError(s.T(), err, "连接测试数据库失败")
    
    s.db = db
    s.repo = NewUserRepository(db)
    s.ctx = context.Background()
    
    // 自动迁移
    err = db.AutoMigrate(&models.User{})
    require.NoError(s.T(), err, "数据库迁移失败")
}

// TearDownSuite 测试套件清理
func (s *UserRepositoryTestSuite) TearDownSuite() {
    // 清理测试数据
    s.db.Exec("TRUNCATE TABLE users CASCADE")
    
    // 关闭数据库连接
    sqlDB, _ := s.db.DB()
    sqlDB.Close()
}

// SetupTest 每个测试前的准备
func (s *UserRepositoryTestSuite) SetupTest() {
    // 清理测试数据
    s.db.Exec("TRUNCATE TABLE users CASCADE")
}

// TearDownTest 每个测试后的清理
func (s *UserRepositoryTestSuite) TearDownTest() {
    // 清理测试数据
    s.db.Exec("TRUNCATE TABLE users CASCADE")
}
```

### 3. 测试Create方法

```go
// TestUserRepository_Create 测试创建用户
func (s *UserRepositoryTestSuite) TestUserRepository_Create() {
    tests := []struct {
        name    string
        user    *models.User
        wantErr bool
        errMsg  string
    }{
        {
            name: "创建有效用户",
            user: &models.User{
                Username:     "testuser",
                Email:        "test@example.com",
                PasswordHash: "hashed_password",
                IsActive:     true,
            },
            wantErr: false,
        },
        {
            name: "创建重复用户名",
            user: &models.User{
                Username:     "testuser",
                Email:        "test2@example.com",
                PasswordHash: "hashed_password",
            },
            wantErr: true,
            errMsg:  "用户已存在",
        },
        {
            name: "创建重复邮箱",
            user: &models.User{
                Username:     "testuser2",
                Email:        "test@example.com",
                PasswordHash: "hashed_password",
            },
            wantErr: true,
            errMsg:  "用户已存在",
        },
    }

    for _, tt := range tests {
        s.Run(tt.name, func() {
            err := s.repo.Create(s.ctx, tt.user)
            if tt.wantErr {
                require.Error(s.T(), err, "期望返回错误")
                if tt.errMsg != "" {
                    assert.Contains(s.T(), err.Error(), tt.errMsg, "错误消息不匹配")
                }
            } else {
                require.NoError(s.T(), err, "创建用户失败")
                assert.NotZero(s.T(), tt.user.ID, "用户ID应该被设置")
                assert.False(s.T(), tt.user.CreatedAt.IsZero(), "创建时间应该被设置")
            }
        })
    }
}
```

### 4. 测试GetByID方法

```go
// TestUserRepository_GetByID 测试根据ID获取用户
func (s *UserRepositoryTestSuite) TestUserRepository_GetByID() {
    // 创建测试用户
    user := &models.User{
        Username:     "testuser",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
        IsActive:     true,
    }
    err := s.repo.Create(s.ctx, user)
    require.NoError(s.T(), err, "创建测试用户失败")
    
    tests := []struct {
        name    string
        id      int64
        wantErr bool
        errMsg  string
    }{
        {
            name:    "获取存在的用户",
            id:       user.ID,
            wantErr:  false,
        },
        {
            name:    "获取不存在的用户",
            id:       99999,
            wantErr:  true,
            errMsg:   "用户不存在",
        },
    }

    for _, tt := range tests {
        s.Run(tt.name, func() {
            got, err := s.repo.GetByID(s.ctx, tt.id)
            if tt.wantErr {
                require.Error(s.T(), err, "期望返回错误")
                assert.Nil(s.T(), got, "应该返回nil")
                if tt.errMsg != "" {
                    assert.Contains(s.T(), err.Error(), tt.errMsg, "错误消息不匹配")
                }
            } else {
                require.NoError(s.T(), err, "获取用户失败")
                require.NotNil(s.T(), got, "用户不应该为nil")
                assert.Equal(s.T(), tt.id, got.ID, "用户ID不匹配")
                assert.Equal(s.T(), "testuser", got.Username, "用户名不匹配")
            }
        })
    }
}
```

### 5. 测试GetByUsername和GetByEmail方法

```go
// TestUserRepository_GetByUsername 测试根据用户名获取用户
func (s *UserRepositoryTestSuite) TestUserRepository_GetByUsername() {
    // 创建测试用户
    user := &models.User{
        Username:     "testuser",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
    }
    err := s.repo.Create(s.ctx, user)
    require.NoError(s.T(), err, "创建测试用户失败")
    
    tests := []struct {
        name     string
        username string
        wantErr  bool
        errMsg   string
    }{
        {
            name:     "获取存在的用户名",
            username: "testuser",
            wantErr:  false,
        },
        {
            name:     "获取不存在的用户名",
            username: "nonexistent",
            wantErr:  true,
            errMsg:   "用户不存在",
        },
    }

    for _, tt := range tests {
        s.Run(tt.name, func() {
            got, err := s.repo.GetByUsername(s.ctx, tt.username)
            if tt.wantErr {
                require.Error(s.T(), err, "期望返回错误")
                assert.Nil(s.T(), got, "应该返回nil")
            } else {
                require.NoError(s.T(), err, "获取用户失败")
                require.NotNil(s.T(), got, "用户不应该为nil")
                assert.Equal(s.T(), tt.username, got.Username, "用户名不匹配")
            }
        })
    }
}

// TestUserRepository_GetByEmail 测试根据邮箱获取用户
func (s *UserRepositoryTestSuite) TestUserRepository_GetByEmail() {
    // 创建测试用户
    user := &models.User{
        Username:     "testuser",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
    }
    err := s.repo.Create(s.ctx, user)
    require.NoError(s.T(), err, "创建测试用户失败")
    
    tests := []struct {
        name    string
        email   string
        wantErr bool
        errMsg  string
    }{
        {
            name:    "获取存在的邮箱",
            email:   "test@example.com",
            wantErr: false,
        },
        {
            name:    "获取不存在的邮箱",
            email:   "nonexistent@example.com",
            wantErr: true,
            errMsg:  "用户不存在",
        },
    }

    for _, tt := range tests {
        s.Run(tt.name, func() {
            got, err := s.repo.GetByEmail(s.ctx, tt.email)
            if tt.wantErr {
                require.Error(s.T(), err, "期望返回错误")
                assert.Nil(s.T(), got, "应该返回nil")
            } else {
                require.NoError(s.T(), err, "获取用户失败")
                require.NotNil(s.T(), got, "用户不应该为nil")
                assert.Equal(s.T(), tt.email, got.Email, "邮箱不匹配")
            }
        })
    }
}
```

### 6. 测试GetAll方法

```go
// TestUserRepository_GetAll 测试获取用户列表
func (s *UserRepositoryTestSuite) TestUserRepository_GetAll() {
    // 创建测试用户
    users := []*models.User{
        {Username: "user1", Email: "user1@example.com", PasswordHash: "hash1", IsActive: true},
        {Username: "user2", Email: "user2@example.com", PasswordHash: "hash2", IsActive: true},
        {Username: "user3", Email: "user3@example.com", PasswordHash: "hash3", IsActive: false},
    }
    for _, user := range users {
        err := s.repo.Create(s.ctx, user)
        require.NoError(s.T(), err, "创建测试用户失败")
    }
    
    tests := []struct {
        name     string
        params   *UserQueryParams
        wantLen  int
        wantTotal int64
    }{
        {
            name: "获取所有用户",
            params: &UserQueryParams{
                Page:  1,
                Limit: 10,
            },
            wantLen:  3,
            wantTotal: 3,
        },
        {
            name: "分页查询第一页",
            params: &UserQueryParams{
                Page:  1,
                Limit: 2,
            },
            wantLen:  2,
            wantTotal: 3,
        },
        {
            name: "按激活状态筛选",
            params: &UserQueryParams{
                Page:     1,
                Limit:    10,
                IsActive: boolPtr(true),
            },
            wantLen:  2,
            wantTotal: 2,
        },
        {
            name: "按用户名模糊查询",
            params: &UserQueryParams{
                Page:     1,
                Limit:    10,
                Username: "user1",
            },
            wantLen:  1,
            wantTotal: 1,
        },
        {
            name: "按创建时间排序",
            params: &UserQueryParams{
                Page:     1,
                Limit:    10,
                SortBy:    "created_at",
                SortOrder: "asc",
            },
            wantLen:  3,
            wantTotal: 3,
        },
    }

    for _, tt := range tests {
        s.Run(tt.name, func() {
            got, total, err := s.repo.GetAll(s.ctx, tt.params)
            require.NoError(s.T(), err, "获取用户列表失败")
            assert.Equal(s.T(), tt.wantLen, len(got), "用户数量不匹配")
            assert.Equal(s.T(), tt.wantTotal, total, "总用户数不匹配")
        })
    }
}

func boolPtr(b bool) *bool {
    return &b
}
```

### 7. 测试Update和Delete方法

```go
// TestUserRepository_Update 测试更新用户
func (s *UserRepositoryTestSuite) TestUserRepository_Update() {
    // 创建测试用户
    user := &models.User{
        Username:     "testuser",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
        IsActive:     true,
    }
    err := s.repo.Create(s.ctx, user)
    require.NoError(s.T(), err, "创建测试用户失败")
    
    // 更新用户信息
    user.Email = "updated@example.com"
    user.IsActive = false
    err = s.repo.Update(s.ctx, user)
    require.NoError(s.T(), err, "更新用户失败")
    
    // 验证更新
    updated, err := s.repo.GetByID(s.ctx, user.ID)
    require.NoError(s.T(), err, "获取更新后的用户失败")
    assert.Equal(s.T(), "updated@example.com", updated.Email, "邮箱未更新")
    assert.False(s.T(), updated.IsActive, "激活状态未更新")
}

// TestUserRepository_Delete 测试删除用户
func (s *UserRepositoryTestSuite) TestUserRepository_Delete() {
    // 创建测试用户
    user := &models.User{
        Username:     "testuser",
        Email:      "test@example.com",
        PasswordHash: "hashed_password",
    }
    err := s.repo.Create(s.ctx, user)
    require.NoError(s.T(), err, "创建测试用户失败")
    
    // 删除用户
    err = s.repo.Delete(s.ctx, user.ID)
    require.NoError(s.T(), err, "删除用户失败")
    
    // 验证删除
    _, err = s.repo.GetByID(s.ctx, user.ID)
    require.Error(s.T(), err, "用户应该已被删除")
    assert.Contains(s.T(), err.Error(), "用户不存在", "错误消息不匹配")
}
```

### 8. 测试其他方法

```go
// TestUserRepository_UpdateStatus 测试更新用户状态
func (s *UserRepositoryTestSuite) TestUserRepository_UpdateStatus() {
    // 创建测试用户
    user := &models.User{
        Username:     "testuser",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
        IsActive:     true,
    }
    err := s.repo.Create(s.ctx, user)
    require.NoError(s.T(), err, "创建测试用户失败")
    
    // 更新状态
    err = s.repo.UpdateStatus(s.ctx, user.ID, false)
    require.NoError(s.T(), err, "更新用户状态失败")
    
    // 验证更新
    updated, err := s.repo.GetByID(s.ctx, user.ID)
    require.NoError(s.T(), err, "获取更新后的用户失败")
    assert.False(s.T(), updated.IsActive, "激活状态未更新")
}

// TestUserRepository_UpdateLastLoginAt 测试更新最后登录时间
func (s *UserRepositoryTestSuite) TestUserRepository_UpdateLastLoginAt() {
    // 创建测试用户
    user := &models.User{
        Username:     "testuser",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
    }
    err := s.repo.Create(s.ctx, user)
    require.NoError(s.T(), err, "创建测试用户失败")
    
    // 更新最后登录时间
    err = s.repo.UpdateLastLoginAt(s.ctx, user.ID)
    require.NoError(s.T(), err, "更新最后登录时间失败")
    
    // 验证更新
    updated, err := s.repo.GetByID(s.ctx, user.ID)
    require.NoError(s.T(), err, "获取更新后的用户失败")
    assert.NotNil(s.T(), updated.LastLoginAt, "最后登录时间应该被设置")
    assert.WithinDuration(s.T(), time.Now(), *updated.LastLoginAt, 5*time.Second, "最后登录时间应该在5秒内")
}

// TestUserRepository_ExistsByUsername 测试检查用户名是否存在
func (s *UserRepositoryTestSuite) TestUserRepository_ExistsByUsername() {
    // 创建测试用户
    user := &models.User{
        Username:     "testuser",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
    }
    err := s.repo.Create(s.ctx, user)
    require.NoError(s.T(), err, "创建测试用户失败")
    
    // 检查存在的用户名
    exists, err := s.repo.ExistsByUsername(s.ctx, "testuser")
    require.NoError(s.T(), err, "检查用户名是否存在失败")
    assert.True(s.T(), exists, "用户名应该存在")
    
    // 检查不存在的用户名
    exists, err = s.repo.ExistsByUsername(s.ctx, "nonexistent")
    require.NoError(s.T(), err, "检查用户名是否存在失败")
    assert.False(s.T(), exists, "用户名不应该存在")
}
```

### 9. 运行测试套件

```go
// TestUserRepositorySuite 运行测试套件
func TestUserRepositorySuite(t *testing.T) {
    suite.Run(t, new(UserRepositoryTestSuite))
}
```

### 10. 注意事项

- **测试数据库**：使用独立的测试数据库，避免影响生产数据
- **测试隔离**：每个测试应该独立，不依赖其他测试的执行顺序
- **数据清理**：在每个测试前后清理测试数据
- **覆盖率要求**：确保测试覆盖率达到80%以上
- **边界测试**：测试边界情况，如空值、最大值、最小值等
- **错误测试**：测试各种错误情况，确保错误处理正确
- **中文描述**：所有测试用例名称和错误消息使用中文

## 验收标准

1. **测试覆盖完整**
   - 所有UserRepository方法都有对应的测试
   - 测试覆盖正常情况、边界情况和异常情况
   - 测试覆盖率达到80%以上

2. **测试质量**
   - 测试用例独立，不依赖执行顺序
   - 测试数据正确清理
   - 测试用例名称清晰，使用中文

3. **测试工具使用**
   - 使用testify/suite管理测试套件
   - 使用testify/assert和testify/require进行断言
   - 使用测试数据库或Mock进行测试

4. **代码规范**
   - 遵循Golang编码规范
   - 遵循单元测试规范
   - 测试用例描述使用中文

## 相关文件

- `internal/repository/user_repository.go` - UserRepository实现文件
- `.cursor/rules/testing.mdc` - Golang单元测试规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/repository/user_repository_test.go` - UserRepository测试文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:06:59 CST

