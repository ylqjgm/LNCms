# TASK005-02: 创建UserSession模型

## 任务信息

**任务编号**: TASK005-02  
**父任务**: TASK005  
**任务名称**: 创建UserSession模型  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:06:59 CST

## 任务描述

创建用户会话管理的GORM模型，用于JWT token存储和黑名单管理。包括：1) 创建UserSession模型，定义字段（id、user_id、token、token_type、expires_at、created_at等）；2) 添加模型标签和索引定义；3) 添加表注释。所有代码必须遵循Golang编码规范。

## 依赖任务

无

## 实现指南

### 1. 设计UserSession表结构

UserSession表用于存储JWT token信息，支持token黑名单管理。表结构设计如下：

- **id**: BIGSERIAL主键
- **user_id**: BIGINT，外键关联users表
- **token**: TEXT，存储JWT token字符串
- **token_type**: VARCHAR(20)，token类型（如：access、refresh）
- **expires_at**: TIMESTAMPTZ，token过期时间
- **is_blacklisted**: BOOLEAN，是否在黑名单中
- **blacklisted_at**: TIMESTAMPTZ，加入黑名单的时间
- **created_at**: TIMESTAMPTZ，创建时间
- **updated_at**: TIMESTAMPTZ，更新时间

### 2. 创建UserSession模型文件

在 `internal/models/` 目录下创建 `user_session.go` 文件，定义UserSession模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// TokenType token类型常量
const (
    TokenTypeAccess  = "access"  // 访问token
    TokenTypeRefresh = "refresh" // 刷新token
)

// UserSession 用户会话模型
// 用于存储JWT token信息，支持token黑名单管理
type UserSession struct {
    ID            int64      `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    UserID        int64      `gorm:"column:user_id;type:BIGINT;not null;index:idx_user_sessions_user_id" json:"user_id"`
    Token         string     `gorm:"column:token;type:TEXT;not null;uniqueIndex:uk_user_sessions_token" json:"-"`
    TokenType     string     `gorm:"column:token_type;type:VARCHAR(20);not null;default:'access';index:idx_user_sessions_token_type" json:"token_type"`
    ExpiresAt     time.Time  `gorm:"column:expires_at;type:TIMESTAMPTZ;not null;index:idx_user_sessions_expires_at" json:"expires_at"`
    IsBlacklisted bool       `gorm:"column:is_blacklisted;type:BOOLEAN;default:false;index:idx_user_sessions_is_blacklisted" json:"is_blacklisted"`
    BlacklistedAt *time.Time `gorm:"column:blacklisted_at;type:TIMESTAMPTZ" json:"blacklisted_at,omitempty"`
    CreatedAt     time.Time  `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    UpdatedAt     time.Time  `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    User *User `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
}

// TableName 指定表名
func (UserSession) TableName() string {
    return "user_sessions"
}

// BeforeCreate 创建前钩子
func (us *UserSession) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if us.CreatedAt.IsZero() {
        us.CreatedAt = now
    }
    if us.UpdatedAt.IsZero() {
        us.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (us *UserSession) BeforeUpdate(tx *gorm.DB) error {
    us.UpdatedAt = time.Now()
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释：

```go
// UserSession 用户会话模型
// 用于存储JWT token信息，支持token黑名单管理
// 当用户登录时创建会话记录，登出时将token加入黑名单
type UserSession struct {
    // ID 会话ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // UserID 用户ID，外键关联users表
    UserID int64 `gorm:"column:user_id;type:BIGINT;not null;index:idx_user_sessions_user_id" json:"user_id"`
    
    // Token JWT token字符串，唯一标识符
    Token string `gorm:"column:token;type:TEXT;not null;uniqueIndex:uk_user_sessions_token" json:"-"`
    
    // TokenType token类型：access-访问token，refresh-刷新token
    TokenType string `gorm:"column:token_type;type:VARCHAR(20);not null;default:'access';index:idx_user_sessions_token_type" json:"token_type"`
    
    // ExpiresAt token过期时间
    ExpiresAt time.Time `gorm:"column:expires_at;type:TIMESTAMPTZ;not null;index:idx_user_sessions_expires_at" json:"expires_at"`
    
    // IsBlacklisted 是否在黑名单中，TRUE-已加入黑名单，FALSE-未加入黑名单
    IsBlacklisted bool `gorm:"column:is_blacklisted;type:BOOLEAN;default:false;index:idx_user_sessions_is_blacklisted" json:"is_blacklisted"`
    
    // BlacklistedAt 加入黑名单的时间
    BlacklistedAt *time.Time `gorm:"column:blacklisted_at;type:TIMESTAMPTZ" json:"blacklisted_at,omitempty"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // 关联关系
    User *User `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
}
```

### 4. 定义模型方法

为UserSession模型添加常用的辅助方法：

```go
// IsExpired 检查token是否已过期
func (us *UserSession) IsExpired() bool {
    return time.Now().After(us.ExpiresAt)
}

// IsValid 检查token是否有效（未过期且未加入黑名单）
func (us *UserSession) IsValid() bool {
    return !us.IsExpired() && !us.IsBlacklisted
}

// Blacklist 将token加入黑名单
func (us *UserSession) Blacklist() {
    now := time.Now()
    us.IsBlacklisted = true
    us.BlacklistedAt = &now
}

// Unblacklist 将token从黑名单移除
func (us *UserSession) Unblacklist() {
    us.IsBlacklisted = false
    us.BlacklistedAt = nil
}
```

### 5. 设计索引

- **主键索引**：`pk_user_sessions` (id) - 自动创建
- **唯一索引**：`uk_user_sessions_token` (token) - 确保token唯一
- **普通索引**：`idx_user_sessions_user_id` (user_id) - 用于查询用户的会话
- **普通索引**：`idx_user_sessions_token_type` (token_type) - 用于按类型查询
- **普通索引**：`idx_user_sessions_expires_at` (expires_at) - 用于查询过期token
- **普通索引**：`idx_user_sessions_is_blacklisted` (is_blacklisted) - 用于查询黑名单token

### 6. 注意事项

- **Token字段**：使用TEXT类型存储JWT token，因为token可能较长
- **唯一索引**：token字段必须唯一，确保每个token只对应一个会话
- **黑名单机制**：使用is_blacklisted字段标记黑名单，支持快速查询
- **过期时间**：expires_at字段用于判断token是否过期，支持自动清理过期token
- **JSON标签**：Token字段使用 `json:"-"` 避免序列化到JSON响应中
- **外键关联**：UserID关联users表，支持级联删除（可选）

## 验收标准

1. **模型结构完整**
   - UserSession模型包含所有必需字段
   - 字段类型与设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 唯一索引：token
   - 普通索引：user_id、token_type、expires_at、is_blacklisted
   - 索引名称规范

3. **关联关系正确**
   - User关联关系正确配置

4. **模型方法完整**
   - IsExpired方法实现正确
   - IsValid方法实现正确
   - Blacklist方法实现正确
   - Unblacklist方法实现正确

5. **常量定义**
   - TokenType常量定义正确
   - 常量值符合业务需求

6. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

7. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践

## 相关文件

- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/user_session.go` - UserSession模型文件（待创建）
- `internal/models/user.go` - User模型文件（关联关系）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:06:59 CST

