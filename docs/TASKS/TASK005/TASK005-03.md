# TASK005-03: 创建UserLoginLog模型

## 任务信息

**任务编号**: TASK005-03  
**父任务**: TASK005  
**任务名称**: 创建UserLoginLog模型  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:06:59 CST

## 任务描述

创建用户登录日志的GORM模型，用于记录用户登录历史。包括：1) 创建UserLoginLog模型，定义字段（id、user_id、ip_address、user_agent、login_at、status等）；2) 添加模型标签和索引定义；3) 添加表注释。所有代码必须遵循Golang编码规范。

## 依赖任务

无

## 实现指南

### 1. 设计UserLoginLog表结构

UserLoginLog表用于记录用户登录历史，支持登录审计和安全分析。表结构设计如下：

- **id**: BIGSERIAL主键
- **user_id**: BIGINT，外键关联users表
- **ip_address**: VARCHAR(45)，登录IP地址（支持IPv6）
- **user_agent**: TEXT，用户代理字符串
- **login_at**: TIMESTAMPTZ，登录时间
- **status**: VARCHAR(20)，登录状态（success、failed）
- **failure_reason**: TEXT，失败原因（仅失败时记录）
- **created_at**: TIMESTAMPTZ，创建时间

### 2. 创建UserLoginLog模型文件

在 `internal/models/` 目录下创建 `user_login_log.go` 文件，定义UserLoginLog模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// LoginStatus 登录状态常量
const (
    LoginStatusSuccess = "success" // 登录成功
    LoginStatusFailed  = "failed"  // 登录失败
)

// FailureReason 失败原因常量
const (
    FailureReasonInvalidCredentials = "invalid_credentials" // 用户名或密码错误
    FailureReasonUserLocked        = "user_locked"          // 用户已锁定
    FailureReasonUserInactive       = "user_inactive"        // 用户未激活
    FailureReasonEmailNotVerified    = "email_not_verified"   // 邮箱未验证
    FailureReasonTooManyAttempts     = "too_many_attempts"   // 登录尝试次数过多
)

// UserLoginLog 用户登录日志模型
// 用于记录用户登录历史，支持登录审计和安全分析
type UserLoginLog struct {
    ID            int64     `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    UserID        *int64    `gorm:"column:user_id;type:BIGINT;index:idx_user_login_logs_user_id" json:"user_id,omitempty"`
    IPAddress     string    `gorm:"column:ip_address;type:VARCHAR(45);not null;index:idx_user_login_logs_ip_address" json:"ip_address"`
    UserAgent     string    `gorm:"column:user_agent;type:TEXT" json:"user_agent"`
    LoginAt       time.Time `gorm:"column:login_at;type:TIMESTAMPTZ;not null;default:CURRENT_TIMESTAMP;index:idx_user_login_logs_login_at" json:"login_at"`
    Status        string    `gorm:"column:status;type:VARCHAR(20);not null;default:'success';index:idx_user_login_logs_status" json:"status"`
    FailureReason *string   `gorm:"column:failure_reason;type:TEXT" json:"failure_reason,omitempty"`
    CreatedAt     time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // 关联关系
    User *User `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
}

// TableName 指定表名
func (UserLoginLog) TableName() string {
    return "user_login_logs"
}

// BeforeCreate 创建前钩子
func (ull *UserLoginLog) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if ull.CreatedAt.IsZero() {
        ull.CreatedAt = now
    }
    if ull.LoginAt.IsZero() {
        ull.LoginAt = now
    }
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释：

```go
// UserLoginLog 用户登录日志模型
// 用于记录用户登录历史，支持登录审计和安全分析
// 记录每次登录尝试的详细信息，包括成功和失败的登录
type UserLoginLog struct {
    // ID 日志ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // UserID 用户ID，外键关联users表，登录失败时可能为NULL
    UserID *int64 `gorm:"column:user_id;type:BIGINT;index:idx_user_login_logs_user_id" json:"user_id,omitempty"`
    
    // IPAddress 登录IP地址，支持IPv4和IPv6（最大45字符）
    IPAddress string `gorm:"column:ip_address;type:VARCHAR(45);not null;index:idx_user_login_logs_ip_address" json:"ip_address"`
    
    // UserAgent 用户代理字符串，包含浏览器、操作系统等信息
    UserAgent string `gorm:"column:user_agent;type:TEXT" json:"user_agent"`
    
    // LoginAt 登录时间，记录登录发生的具体时间
    LoginAt time.Time `gorm:"column:login_at;type:TIMESTAMPTZ;not null;default:CURRENT_TIMESTAMP;index:idx_user_login_logs_login_at" json:"login_at"`
    
    // Status 登录状态：success-登录成功，failed-登录失败
    Status string `gorm:"column:status;type:VARCHAR(20);not null;default:'success';index:idx_user_login_logs_status" json:"status"`
    
    // FailureReason 失败原因，仅登录失败时记录
    // 可能的值：invalid_credentials-用户名或密码错误、user_locked-用户已锁定、
    // user_inactive-用户未激活、email_not_verified-邮箱未验证、too_many_attempts-登录尝试次数过多
    FailureReason *string `gorm:"column:failure_reason;type:TEXT" json:"failure_reason,omitempty"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // 关联关系
    User *User `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
}
```

### 4. 定义模型方法

为UserLoginLog模型添加常用的辅助方法：

```go
// IsSuccess 检查登录是否成功
func (ull *UserLoginLog) IsSuccess() bool {
    return ull.Status == LoginStatusSuccess
}

// IsFailed 检查登录是否失败
func (ull *UserLoginLog) IsFailed() bool {
    return ull.Status == LoginStatusFailed
}

// SetFailureReason 设置失败原因
func (ull *UserLoginLog) SetFailureReason(reason string) {
    ull.Status = LoginStatusFailed
    ull.FailureReason = &reason
}

// SetSuccess 设置为成功状态
func (ull *UserLoginLog) SetSuccess() {
    ull.Status = LoginStatusSuccess
    ull.FailureReason = nil
}
```

### 5. 设计索引

- **主键索引**：`pk_user_login_logs` (id) - 自动创建
- **普通索引**：`idx_user_login_logs_user_id` (user_id) - 用于查询用户的登录历史
- **普通索引**：`idx_user_login_logs_ip_address` (ip_address) - 用于按IP地址查询
- **普通索引**：`idx_user_login_logs_login_at` (login_at) - 用于按时间范围查询
- **普通索引**：`idx_user_login_logs_status` (status) - 用于按状态筛选
- **复合索引**：`idx_user_login_logs_user_id_login_at` (user_id, login_at) - 用于查询用户最近登录记录（可选）

### 6. 注意事项

- **UserID字段**：使用指针类型，因为登录失败时可能无法确定用户ID
- **IP地址字段**：使用VARCHAR(45)类型，支持IPv4（15字符）和IPv6（45字符）
- **UserAgent字段**：使用TEXT类型，因为user agent字符串可能较长
- **状态字段**：使用常量定义状态值，确保一致性
- **失败原因**：使用指针类型，仅失败时记录
- **时间字段**：login_at和created_at可以相同，但login_at更明确表示登录时间
- **外键关联**：UserID关联users表，支持级联删除（可选）

## 验收标准

1. **模型结构完整**
   - UserLoginLog模型包含所有必需字段
   - 字段类型与设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 普通索引：user_id、ip_address、login_at、status
   - 索引名称规范
   - 支持常用查询场景

3. **关联关系正确**
   - User关联关系正确配置
   - UserID使用指针类型，支持NULL值

4. **模型方法完整**
   - IsSuccess方法实现正确
   - IsFailed方法实现正确
   - SetFailureReason方法实现正确
   - SetSuccess方法实现正确

5. **常量定义**
   - LoginStatus常量定义正确
   - FailureReason常量定义正确
   - 常量值符合业务需求

6. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文
   - 常量注释使用中文

7. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践

## 相关文件

- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/user_login_log.go` - UserLoginLog模型文件（待创建）
- `internal/models/user.go` - User模型文件（关联关系）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:06:59 CST

