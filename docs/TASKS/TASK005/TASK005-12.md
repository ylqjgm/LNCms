# TASK005-12: 创建AuthService接口和实现 - 用户注册

## 任务信息

**任务编号**: TASK005-12  
**父任务**: TASK005  
**任务名称**: 创建AuthService接口和实现 - 用户注册  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:26:31 CST

## 任务描述

扩展认证服务，提供用户注册功能。包括：1) 扩展AuthService接口（Register方法）；2) 实现注册逻辑（验证注册配置、验证用户名和邮箱唯一性、验证密码强度、创建用户、生成JWT token、分配注册积分等）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK005-11（创建AuthService接口和实现 - 登录和登出）、TASK005-07（创建PasswordService接口和实现）

## 实现指南

### 1. 扩展AuthService接口

在 `internal/service/auth_service.go` 文件中，扩展AuthService接口：

```go
// AuthService 认证服务接口
// 提供用户注册、登录、登出功能
type AuthService interface {
    // Register 用户注册
    // 验证注册配置、验证用户名和邮箱唯一性、验证密码强度、创建用户、生成JWT token
    Register(ctx context.Context, req *dto.RegisterRequest) (*dto.RegisterResponse, error)
    
    // Login 用户登录
    // 支持用户名或邮箱登录
    // 返回用户信息和token对
    Login(ctx context.Context, req *dto.LoginRequest) (*dto.LoginResponse, error)
    
    // Logout 用户登出
    // 将token加入黑名单
    Logout(ctx context.Context, token string) error
}
```

### 2. 定义注册DTO

在 `internal/dto/auth_dto.go` 文件中，添加注册相关的DTO：

```go
// RegisterRequest 注册请求
type RegisterRequest struct {
    Username string `json:"username" binding:"required,min=3,max=50"` // 用户名
    Email    string `json:"email" binding:"required,email"`           // 邮箱
    Phone    string `json:"phone,omitempty" binding:"omitempty"`      // 手机号（可选）
    Password string `json:"password" binding:"required,min=8"`        // 密码
}

// RegisterResponse 注册响应
type RegisterResponse struct {
    User         *UserInfo  `json:"user"`          // 用户信息
    AccessToken  string     `json:"access_token"`  // Access token
    RefreshToken string     `json:"refresh_token"` // Refresh token
    ExpiresAt    time.Time  `json:"expires_at"`   // Token过期时间
    Message      string     `json:"message"`       // 提示消息（如需要审核）
}
```

### 3. 定义注册配置

在 `internal/config/` 目录下创建或扩展配置结构：

```go
// RegisterConfig 注册配置
type RegisterConfig struct {
    Enabled          bool  // 是否允许注册
    RequireEmailVerify bool // 是否需要邮箱验证
    RequireApproval  bool  // 是否需要审核
    DefaultRoleID    *int64 // 默认角色ID
    DefaultUserGroupID *int64 // 默认用户组ID
    DefaultLevelID   *int64 // 默认等级ID
    RegisterPoints   int64  // 注册积分
}
```

### 4. 实现Register方法

在 `internal/service/auth_service.go` 文件中，实现Register方法：

```go
// Register 用户注册
func (s *authService) Register(ctx context.Context, req *dto.RegisterRequest) (*dto.RegisterResponse, error) {
    // 1. 验证注册配置
    if !s.registerConfig.Enabled {
        return nil, errors.New("注册功能已关闭")
    }
    
    // 2. 验证输入参数
    if err := s.validateRegisterRequest(req); err != nil {
        return nil, err
    }
    
    // 3. 验证用户名唯一性
    exists, err := s.userRepo.ExistsByUsername(ctx, req.Username)
    if err != nil {
        return nil, fmt.Errorf("验证用户名失败: %w", err)
    }
    if exists {
        return nil, errors.New("用户名已被使用")
    }
    
    // 4. 验证邮箱唯一性
    exists, err = s.userRepo.ExistsByEmail(ctx, req.Email)
    if err != nil {
        return nil, fmt.Errorf("验证邮箱失败: %w", err)
    }
    if exists {
        return nil, errors.New("邮箱已被使用")
    }
    
    // 5. 验证手机号唯一性（如果提供）
    if req.Phone != "" {
        exists, err = s.userRepo.ExistsByPhone(ctx, req.Phone)
        if err != nil {
            return nil, fmt.Errorf("验证手机号失败: %w", err)
        }
        if exists {
            return nil, errors.New("手机号已被使用")
        }
    }
    
    // 6. 验证密码强度
    if err := s.passwordService.ValidatePasswordStrength(req.Password); err != nil {
        return nil, fmt.Errorf("密码强度不符合要求: %w", err)
    }
    
    // 7. 哈希密码
    passwordHash, err := s.passwordService.HashPassword(req.Password)
    if err != nil {
        return nil, fmt.Errorf("密码加密失败: %w", err)
    }
    
    // 8. 创建用户
    user := &models.User{
        Username:      req.Username,
        Email:         req.Email,
        Phone:         stringPtr(req.Phone),
        PasswordHash:  passwordHash,
        EmailVerified: !s.registerConfig.RequireEmailVerify, // 如果不需要验证，默认已验证
        PhoneVerified: false,
        IsActive:      !s.registerConfig.RequireApproval,     // 如果需要审核，默认未激活
        IsLocked:      false,
        RoleID:        s.registerConfig.DefaultRoleID,
        UserGroupID:   s.registerConfig.DefaultUserGroupID,
        LevelID:       s.registerConfig.DefaultLevelID,
    }
    
    if err := s.userRepo.Create(ctx, user); err != nil {
        return nil, fmt.Errorf("创建用户失败: %w", err)
    }
    
    // 9. 分配注册积分（如果配置了积分系统）
    if s.registerConfig.RegisterPoints > 0 {
        // TODO: 调用积分服务分配积分
        // s.pointsService.AddPoints(ctx, user.ID, s.registerConfig.RegisterPoints, "注册奖励")
    }
    
    // 10. 生成JWT token（如果不需要审核，直接登录）
    var tokenPair *TokenPair
    var err error
    
    if !s.registerConfig.RequireApproval {
        tokenPair, err = s.jwtService.GenerateToken(user.ID, user.Username, user.RoleID)
        if err != nil {
            return nil, fmt.Errorf("生成token失败: %w", err)
        }
    }
    
    // 11. 发送验证邮件（如果需要邮箱验证）
    if s.registerConfig.RequireEmailVerify {
        // TODO: 调用邮件服务发送验证邮件
        // s.emailService.SendVerificationEmail(ctx, user.Email, verificationToken)
    }
    
    // 12. 构建响应
    response := &dto.RegisterResponse{
        User: dto.ToUserInfo(user),
    }
    
    if tokenPair != nil {
        response.AccessToken = tokenPair.AccessToken
        response.RefreshToken = tokenPair.RefreshToken
        response.ExpiresAt = tokenPair.ExpiresAt
    }
    
    if s.registerConfig.RequireApproval {
        response.Message = "注册成功，请等待管理员审核"
    } else if s.registerConfig.RequireEmailVerify {
        response.Message = "注册成功，请验证邮箱"
    } else {
        response.Message = "注册成功"
    }
    
    return response, nil
}

// validateRegisterRequest 验证注册请求（辅助方法）
func (s *authService) validateRegisterRequest(req *dto.RegisterRequest) error {
    if req.Username == "" {
        return errors.New("用户名不能为空")
    }
    if len(req.Username) < 3 || len(req.Username) > 50 {
        return errors.New("用户名长度必须在3-50个字符之间")
    }
    
    if req.Email == "" {
        return errors.New("邮箱不能为空")
    }
    // 邮箱格式验证由binding标签处理
    
    if req.Password == "" {
        return errors.New("密码不能为空")
    }
    
    return nil
}

// stringPtr 字符串指针辅助函数
func stringPtr(s string) *string {
    if s == "" {
        return nil
    }
    return &s
}
```

### 5. 扩展authService结构体

```go
// authService AuthService的实现
type authService struct {
    userRepo        repository.UserRepository
    passwordService PasswordService
    jwtService      JWTService
    loginLogRepo    repository.LoginLogRepository
    registerConfig  *config.RegisterConfig // 注册配置
}
```

### 6. 更新NewAuthService构造函数

```go
// NewAuthService 创建AuthService实例
func NewAuthService(
    userRepo repository.UserRepository,
    passwordService PasswordService,
    jwtService JWTService,
    loginLogRepo repository.LoginLogRepository,
    registerConfig *config.RegisterConfig,
) AuthService {
    if registerConfig == nil {
        // 使用默认配置
        registerConfig = &config.RegisterConfig{
            Enabled:          true,
            RequireEmailVerify: false,
            RequireApproval:  false,
            RegisterPoints:   0,
        }
    }
    
    return &authService{
        userRepo:        userRepo,
        passwordService: passwordService,
        jwtService:      jwtService,
        loginLogRepo:    loginLogRepo,
        registerConfig:  registerConfig,
    }
}
```

### 7. 添加必要的导入

```go
package service

import (
    "context"
    "errors"
    "fmt"
    
    "yourproject/internal/config"
    "yourproject/internal/dto"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 8. 错误定义

```go
// 注册相关错误定义
var (
    ErrRegisterDisabled    = errors.New("注册功能已关闭")
    ErrUsernameExists      = errors.New("用户名已被使用")
    ErrEmailExists         = errors.New("邮箱已被使用")
    ErrPhoneExists         = errors.New("手机号已被使用")
    ErrPasswordWeak        = errors.New("密码强度不符合要求")
)
```

### 9. 注意事项

- **注册配置**：支持灵活的注册配置（是否允许注册、是否需要审核、是否需要邮箱验证等）
- **唯一性验证**：注册前验证用户名、邮箱、手机号的唯一性
- **密码强度**：使用PasswordService验证密码强度
- **用户状态**：根据配置设置用户初始状态（是否需要审核）
- **积分分配**：支持注册时分配积分（如果配置了积分系统）
- **邮箱验证**：如果需要邮箱验证，发送验证邮件
- **Token生成**：如果不需要审核，注册后直接生成token并登录
- **错误处理**：所有错误消息使用中文，清晰描述问题

## 验收标准

1. **接口扩展完整**
   - AuthService接口包含Register方法
   - 方法签名正确，参数和返回值类型正确

2. **注册功能完整**
   - Register方法正确实现
   - 验证注册配置
   - 验证用户名、邮箱、手机号唯一性
   - 验证密码强度
   - 正确创建用户
   - 根据配置设置用户状态
   - 正确生成JWT token（如果不需要审核）
   - 正确分配注册积分（如果配置了）

3. **配置支持**
   - 支持注册开关配置
   - 支持审核配置
   - 支持邮箱验证配置
   - 支持默认角色、用户组、等级配置

4. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文
   - 唯一性验证错误明确

5. **安全性**
   - 密码使用PasswordService加密
   - 密码强度验证正确
   - 用户状态设置正确

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循安全开发规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/auth_service.go` - AuthService接口和实现文件
- `internal/dto/auth_dto.go` - 认证相关DTO文件
- `internal/config/register_config.go` - 注册配置文件（待创建或扩展）
- `internal/service/password_service.go` - PasswordService实现文件
- `.cursor/rules/security.mdc` - 应用安全开发规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:26:31 CST

