# TASK005-01: 创建User模型

## 任务信息

**任务编号**: TASK005-01  
**父任务**: TASK005  
**任务名称**: 创建User模型  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:06:59 CST

## 任务描述

创建用户管理的GORM模型，定义用户表结构。包括：1) 创建User模型，定义字段（基于TASK002-10的users表设计）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范和PostgreSQL数据库设计规范。参考TASK002-10数据库设计任务。

## 依赖任务

无

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-10.md` 文档，了解users表的完整设计：
- 表结构：id、username、email、phone、password_hash、email_verified、phone_verified、is_active、is_locked、role_id、user_group_id、level_id、created_at、updated_at、last_login_at
- 外键关联：role_id 关联 roles 表、user_group_id 关联 user_groups 表、level_id 关联 levels 表
- 唯一约束：username、email 必须唯一
- 索引：username、email、phone、role_id、user_group_id、level_id、is_active、is_locked

### 2. 创建User模型文件

在 `internal/models/` 目录下创建 `user.go` 文件，定义User模型：

```go
package models

import (
    "time"
    "gorm.io/gorm"
)

// User 用户模型
type User struct {
    ID            int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    Username      string         `gorm:"column:username;type:VARCHAR(50);not null;uniqueIndex:uk_users_username" json:"username"`
    Email         string         `gorm:"column:email;type:VARCHAR(100);not null;uniqueIndex:uk_users_email" json:"email"`
    Phone         *string        `gorm:"column:phone;type:VARCHAR(20);index:idx_users_phone" json:"phone,omitempty"`
    PasswordHash  string         `gorm:"column:password_hash;type:VARCHAR(255);not null" json:"-"`
    EmailVerified bool           `gorm:"column:email_verified;type:BOOLEAN;default:false" json:"email_verified"`
    PhoneVerified bool           `gorm:"column:phone_verified;type:BOOLEAN;default:false" json:"phone_verified"`
    IsActive      bool           `gorm:"column:is_active;type:BOOLEAN;default:true;index:idx_users_is_active" json:"is_active"`
    IsLocked      bool           `gorm:"column:is_locked;type:BOOLEAN;default:false;index:idx_users_is_locked" json:"is_locked"`
    RoleID        *int64         `gorm:"column:role_id;type:BIGINT;index:idx_users_role_id" json:"role_id,omitempty"`
    UserGroupID   *int64         `gorm:"column:user_group_id;type:BIGINT;index:idx_users_user_group_id" json:"user_group_id,omitempty"`
    LevelID       *int64         `gorm:"column:level_id;type:BIGINT;index:idx_users_level_id" json:"level_id,omitempty"`
    CreatedAt     time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    UpdatedAt     time.Time      `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    LastLoginAt   *time.Time     `gorm:"column:last_login_at;type:TIMESTAMPTZ" json:"last_login_at,omitempty"`
    
    // 关联关系
    Role      *Role      `gorm:"foreignKey:RoleID;references:ID" json:"role,omitempty"`
    UserGroup *UserGroup `gorm:"foreignKey:UserGroupID;references:ID" json:"user_group,omitempty"`
    Level     *Level     `gorm:"foreignKey:LevelID;references:ID" json:"level,omitempty"`
}

// TableName 指定表名
func (User) TableName() string {
    return "users"
}

// BeforeCreate 创建前钩子
func (u *User) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if u.CreatedAt.IsZero() {
        u.CreatedAt = now
    }
    if u.UpdatedAt.IsZero() {
        u.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (u *User) BeforeUpdate(tx *gorm.DB) error {
    u.UpdatedAt = time.Now()
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// User 用户模型
// 存储用户基本信息和认证信息，包括用户名、邮箱、密码哈希、状态信息等
// 关联角色、用户组、等级等信息
type User struct {
    // ID 用户ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // Username 用户名，唯一标识符，用于登录
    Username string `gorm:"column:username;type:VARCHAR(50);not null;uniqueIndex:uk_users_username" json:"username"`
    
    // Email 邮箱地址，唯一标识符，用于登录和通知
    Email string `gorm:"column:email;type:VARCHAR(100);not null;uniqueIndex:uk_users_email" json:"email"`
    
    // Phone 手机号码，用于登录和通知，可选
    Phone *string `gorm:"column:phone;type:VARCHAR(20);index:idx_users_phone" json:"phone,omitempty"`
    
    // PasswordHash 密码哈希值，使用 bcrypt 算法，不能存储明文密码
    PasswordHash string `gorm:"column:password_hash;type:VARCHAR(255);not null" json:"-"`
    
    // EmailVerified 邮箱是否已验证，TRUE-已验证，FALSE-未验证
    EmailVerified bool `gorm:"column:email_verified;type:BOOLEAN;default:false" json:"email_verified"`
    
    // PhoneVerified 手机号是否已验证，TRUE-已验证，FALSE-未验证
    PhoneVerified bool `gorm:"column:phone_verified;type:BOOLEAN;default:false" json:"phone_verified"`
    
    // IsActive 用户是否激活，TRUE-激活，FALSE-未激活
    IsActive bool `gorm:"column:is_active;type:BOOLEAN;default:true;index:idx_users_is_active" json:"is_active"`
    
    // IsLocked 用户是否被锁定，TRUE-已锁定，FALSE-未锁定
    IsLocked bool `gorm:"column:is_locked;type:BOOLEAN;default:false;index:idx_users_is_locked" json:"is_locked"`
    
    // RoleID 角色ID，外键关联roles表
    RoleID *int64 `gorm:"column:role_id;type:BIGINT;index:idx_users_role_id" json:"role_id,omitempty"`
    
    // UserGroupID 用户组ID，外键关联user_groups表
    UserGroupID *int64 `gorm:"column:user_group_id;type:BIGINT;index:idx_users_user_group_id" json:"user_group_id,omitempty"`
    
    // LevelID 等级ID，外键关联levels表
    LevelID *int64 `gorm:"column:level_id;type:BIGINT;index:idx_users_level_id" json:"level_id,omitempty"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // LastLoginAt 最后登录时间
    LastLoginAt *time.Time `gorm:"column:last_login_at;type:TIMESTAMPTZ" json:"last_login_at,omitempty"`
    
    // 关联关系
    Role      *Role      `gorm:"foreignKey:RoleID;references:ID" json:"role,omitempty"`
    UserGroup *UserGroup `gorm:"foreignKey:UserGroupID;references:ID" json:"user_group,omitempty"`
    Level     *Level     `gorm:"foreignKey:LevelID;references:ID" json:"level,omitempty"`
}
```

### 4. 定义模型方法

为User模型添加常用的辅助方法：

```go
// IsValid 检查用户是否有效（激活且未锁定）
func (u *User) IsValid() bool {
    return u.IsActive && !u.IsLocked
}

// CanLogin 检查用户是否可以登录
func (u *User) CanLogin() bool {
    return u.IsValid() && u.EmailVerified
}

// UpdateLastLogin 更新最后登录时间
func (u *User) UpdateLastLogin() {
    now := time.Now()
    u.LastLoginAt = &now
}
```

### 5. 注意事项

- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **索引定义**：在GORM标签中定义索引，包括唯一索引和普通索引
- **外键关联**：使用GORM的foreignKey和references标签定义关联关系
- **JSON标签**：PasswordHash字段使用 `json:"-"` 避免序列化到JSON响应中
- **指针类型**：可选字段（如Phone、RoleID等）使用指针类型，支持NULL值
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致

## 验收标准

1. **模型结构完整**
   - User模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 唯一索引：username、email
   - 普通索引：phone、role_id、user_group_id、level_id、is_active、is_locked
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - Role关联关系正确
   - UserGroup关联关系正确
   - Level关联关系正确

4. **模型方法完整**
   - IsValid方法实现正确
   - CanLogin方法实现正确
   - UpdateLastLogin方法实现正确

5. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/TASK002-10.md` - 用户表数据库设计文档
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/user.go` - User模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:06:59 CST

