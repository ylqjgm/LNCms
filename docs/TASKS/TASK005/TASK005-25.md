# TASK005-25: 创建UserHandler接口和实现 - 用户审核和密码管理API

## 任务信息

**任务编号**: TASK005-25  
**父任务**: TASK005  
**任务名称**: 创建UserHandler接口和实现 - 用户审核和密码管理API  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:37:44 CST

## 任务描述

扩展用户控制器，提供用户审核和密码管理的HTTP API处理。包括：1) 扩展UserHandler接口（ApproveUser、RejectUser、ResetPassword方法）；2) 实现ApproveUser方法（处理PUT /api/v1/users/{id}/approve请求）；3) 实现RejectUser方法（处理PUT /api/v1/users/{id}/reject请求，可选）；4) 实现ResetPassword方法（处理PUT /api/v1/users/{id}/password请求）；5) 调用UserService；6) 格式化响应（Envelope格式）。所有代码必须遵循API设计规范。

## 依赖任务

TASK005-24（创建UserHandler接口和实现 - 用户封禁管理API）、TASK005-16（创建UserService接口和实现 - 审核和密码管理）

## 实现指南

### 1. 扩展UserHandler接口

在 `internal/handler/user_handler.go` 文件中，扩展UserHandler接口：

```go
// UserHandler 用户控制器接口
// 提供用户管理的HTTP API处理
type UserHandler interface {
    // Register 用户注册
    // POST /api/v1/users/register
    Register(c *gin.Context)
    
    // Login 用户登录
    // POST /api/v1/users/login
    Login(c *gin.Context)
    
    // Logout 用户登出
    // POST /api/v1/users/logout
    Logout(c *gin.Context)
    
    // GetUsers 获取用户列表
    // GET /api/v1/users
    GetUsers(c *gin.Context)
    
    // GetUser 获取用户详情
    // GET /api/v1/users/{id}
    GetUser(c *gin.Context)
    
    // CreateUser 创建用户（管理员）
    // POST /api/v1/users
    CreateUser(c *gin.Context)
    
    // UpdateUser 更新用户
    // PUT /api/v1/users/{id}
    UpdateUser(c *gin.Context)
    
    // UpdateUserStatus 更新用户状态
    // PUT /api/v1/users/{id}/status
    UpdateUserStatus(c *gin.Context)
    
    // BanUser 封禁用户
    // PUT /api/v1/users/{id}/ban
    BanUser(c *gin.Context)
    
    // UnbanUser 解封用户
    // PUT /api/v1/users/{id}/unban
    UnbanUser(c *gin.Context)
    
    // ApproveUser 审核通过用户
    // PUT /api/v1/users/{id}/approve
    ApproveUser(c *gin.Context)
    
    // RejectUser 审核拒绝用户（可选）
    // PUT /api/v1/users/{id}/reject
    RejectUser(c *gin.Context)
    
    // ResetPassword 重置用户密码
    // PUT /api/v1/users/{id}/password
    ResetPassword(c *gin.Context)
}
```

### 2. 实现ApproveUser方法

```go
// ApproveUser 审核通过用户
// @Summary 审核通过用户
// @Description 审核通过用户，设置用户状态为已审核
// @Tags 用户管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "用户ID"
// @Success 200 {object} response.Envelope{data=dto.UserResponse}
// @Failure 400 {object} response.Envelope
// @Failure 401 {object} response.Envelope
// @Failure 404 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/users/{id}/approve [put]
func (h *userHandler) ApproveUser(c *gin.Context) {
    // 1. 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BadRequest(c, "无效的用户ID", err)
        return
    }
    
    // 2. 调用UserService.ApproveUser
    user, err := h.userService.ApproveUser(c.Request.Context(), id)
    if err != nil {
        if isNotFoundError(err) {
            response.NotFound(c, "用户不存在", err)
            return
        }
        if isValidationError(err) {
            response.UnprocessableEntity(c, "验证失败", err)
            return
        }
        response.InternalServerError(c, "审核用户失败", err)
        return
    }
    
    // 3. 转换为响应DTO
    userResponse := dto.UserResponseFromModel(user)
    
    // 4. 格式化响应（Envelope格式）
    response.OK(c, userResponse, "审核通过成功")
}
```

### 3. 实现RejectUser方法

```go
// RejectUser 审核拒绝用户（可选）
// @Summary 审核拒绝用户
// @Description 审核拒绝用户，设置用户状态为已拒绝
// @Tags 用户管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "用户ID"
// @Param request body dto.RejectUserRequest true "拒绝用户请求" default({"reason":"不符合要求"})
// @Success 200 {object} response.Envelope{data=dto.UserResponse}
// @Failure 400 {object} response.Envelope
// @Failure 401 {object} response.Envelope
// @Failure 404 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/users/{id}/reject [put]
func (h *userHandler) RejectUser(c *gin.Context) {
    // 1. 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BadRequest(c, "无效的用户ID", err)
        return
    }
    
    // 2. 绑定请求参数（可选）
    var req dto.RejectUserRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        // 如果请求体为空，使用默认值
        req.Reason = "审核未通过"
    }
    
    // 3. 调用UserService.RejectUser
    user, err := h.userService.RejectUser(c.Request.Context(), id, req.Reason)
    if err != nil {
        if isNotFoundError(err) {
            response.NotFound(c, "用户不存在", err)
            return
        }
        if isValidationError(err) {
            response.UnprocessableEntity(c, "验证失败", err)
            return
        }
        response.InternalServerError(c, "审核拒绝失败", err)
        return
    }
    
    // 4. 转换为响应DTO
    userResponse := dto.UserResponseFromModel(user)
    
    // 5. 格式化响应（Envelope格式）
    response.OK(c, userResponse, "审核拒绝成功")
}
```

### 4. 实现ResetPassword方法

```go
// ResetPassword 重置用户密码
// @Summary 重置用户密码
// @Description 管理员重置用户密码
// @Tags 用户管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "用户ID"
// @Param request body dto.ResetPasswordRequest true "重置密码请求"
// @Success 200 {object} response.Envelope
// @Failure 400 {object} response.Envelope
// @Failure 401 {object} response.Envelope
// @Failure 404 {object} response.Envelope
// @Failure 422 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/users/{id}/password [put]
func (h *userHandler) ResetPassword(c *gin.Context) {
    // 1. 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BadRequest(c, "无效的用户ID", err)
        return
    }
    
    // 2. 绑定请求参数
    var req dto.ResetPasswordRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BadRequest(c, "请求参数错误", err)
        return
    }
    
    // 3. 调用UserService.ResetPassword
    err = h.userService.ResetPassword(c.Request.Context(), id, req.Password)
    if err != nil {
        if isNotFoundError(err) {
            response.NotFound(c, "用户不存在", err)
            return
        }
        if isValidationError(err) {
            response.UnprocessableEntity(c, "验证失败", err)
            return
        }
        response.InternalServerError(c, "重置密码失败", err)
        return
    }
    
    // 4. 格式化响应（Envelope格式）
    response.OK(c, nil, "重置密码成功")
}
```

### 5. 创建请求DTO

在 `internal/dto/user_dto.go` 文件中，创建请求结构：

```go
// RejectUserRequest 拒绝用户请求
type RejectUserRequest struct {
    Reason string `json:"reason" binding:"omitempty,max=500"`
}

// ResetPasswordRequest 重置密码请求
type ResetPasswordRequest struct {
    Password string `json:"password" binding:"required,min=8,max=128"`
}
```

### 6. 添加必要的导入

```go
package handler

import (
    "strconv"
    
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/dto"
    "yourproject/internal/service"
    "yourproject/pkg/response"
)
```

### 7. 注意事项

- **请求参数绑定**：ApproveUser不需要请求体，RejectUser支持可选的请求体（拒绝原因），ResetPassword需要请求体（新密码）
- **路径参数解析**：使用c.Param获取路径参数，并转换为int64类型
- **参数验证**：密码必须符合密码强度要求，拒绝原因可选，最大长度为500字符
- **错误处理**：区分不同的错误类型（未找到、验证失败、服务器错误）
- **响应格式**：使用Envelope格式，HTTP状态码200 OK
- **权限控制**：需要认证和管理员权限，在路由配置中应用JWT认证中间件和权限中间件
- **密码安全**：重置密码时使用密码服务进行哈希处理
- **审核逻辑**：ApproveUser设置用户状态为已审核，RejectUser设置用户状态为已拒绝（如果支持）

## 验收标准

1. **接口扩展完整**
   - UserHandler接口包含ApproveUser、RejectUser、ResetPassword方法
   - 方法签名正确

2. **请求参数处理**
   - ApproveUser方法不需要请求参数
   - RejectUser方法正确绑定可选请求参数
   - ResetPassword方法正确绑定请求参数
   - 参数验证正确

3. **路径参数处理**
   - 正确获取和解析路径参数
   - 验证参数有效性

4. **服务调用**
   - 正确调用UserService.ApproveUser、RejectUser、ResetPassword
   - 错误处理正确

5. **响应格式化**
   - 响应使用Envelope格式
   - HTTP状态码200 OK
   - 错误响应使用Envelope格式

6. **错误处理**
   - 参数错误时返回400 Bad Request
   - 验证失败时返回422 Unprocessable Entity
   - 用户不存在时返回404 Not Found
   - 认证失败时返回401 Unauthorized
   - 错误消息使用中文
   - 错误格式符合API设计规范

7. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范
   - 注释完整，使用中文

## 相关文件

- `internal/handler/user_handler.go` - UserHandler接口和实现文件
- `internal/service/user_service.go` - UserService实现文件
- `internal/dto/user_dto.go` - 用户DTO定义文件
- `pkg/response/response.go` - 响应格式化包
- `.cursor/rules/api-design.mdc` - API设计规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:37:44 CST

