# TASK005-18: 创建UserHandler接口和实现 - 用户注册API

## 任务信息

**任务编号**: TASK005-18  
**父任务**: TASK005  
**任务名称**: 创建UserHandler接口和实现 - 用户注册API  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:26:31 CST

## 任务描述

创建用户控制器，提供用户注册的HTTP API处理。包括：1) 定义UserHandler接口；2) 实现Register方法（处理POST /api/v1/users/register请求）；3) 实现请求参数绑定和验证；4) 调用AuthService.Register；5) 格式化响应（Envelope格式）。所有代码必须遵循Golang编码规范和API设计规范，错误消息使用中文。

## 依赖任务

TASK005-12（创建AuthService接口和实现 - 用户注册）

## 实现指南

### 1. 定义UserHandler接口

在 `internal/handler/` 目录下创建 `user_handler.go` 文件，定义UserHandler接口：

```go
package handler

import (
    "github.com/gin-gonic/gin"
)

// UserHandler 用户控制器接口
// 提供用户管理的HTTP API处理
type UserHandler interface {
    // Register 用户注册
    // POST /api/v1/users/register
    Register(c *gin.Context)
}
```

### 2. 定义请求和响应DTO

在 `internal/dto/` 目录下，确保已有注册相关的DTO（参考TASK005-12）。

### 3. 实现UserHandler接口

```go
package handler

import (
    "net/http"
    
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/dto"
    "yourproject/internal/service"
    "yourproject/pkg/response"
)

// userHandler UserHandler的实现
type userHandler struct {
    authService service.AuthService
}

// NewUserHandler 创建UserHandler实例
func NewUserHandler(authService service.AuthService) UserHandler {
    return &userHandler{
        authService: authService,
    }
}

// Register 用户注册
// @Summary 用户注册
// @Description 用户注册接口，支持用户名、邮箱、密码注册
// @Tags 用户管理
// @Accept json
// @Produce json
// @Param request body dto.RegisterRequest true "注册请求"
// @Success 201 {object} response.Envelope{data=dto.RegisterResponse}
// @Failure 400 {object} response.Envelope
// @Failure 422 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/users/register [post]
func (h *userHandler) Register(c *gin.Context) {
    // 1. 绑定请求参数
    var req dto.RegisterRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BadRequest(c, "请求参数错误", err)
        return
    }
    
    // 2. 获取客户端IP和User-Agent
    req.IPAddress = c.ClientIP()
    req.UserAgent = c.GetHeader("User-Agent")
    
    // 3. 调用AuthService.Register
    resp, err := h.authService.Register(c.Request.Context(), &req)
    if err != nil {
        // 根据错误类型返回不同的HTTP状态码
        if isValidationError(err) {
            response.UnprocessableEntity(c, "验证失败", err)
            return
        }
        if isConflictError(err) {
            response.Conflict(c, "资源冲突", err)
            return
        }
        response.InternalServerError(c, "注册失败", err)
        return
    }
    
    // 4. 格式化响应（Envelope格式）
    if resp.AccessToken != "" {
        // 注册成功且不需要审核，返回token
        response.Created(c, resp, "注册成功")
    } else {
        // 注册成功但需要审核，返回提示消息
        response.Created(c, resp, resp.Message)
    }
}
```

### 4. 实现错误判断辅助函数

```go
// isValidationError 判断是否为验证错误
func isValidationError(err error) bool {
    errMsg := err.Error()
    return contains(errMsg, "不能为空") ||
        contains(errMsg, "长度") ||
        contains(errMsg, "格式") ||
        contains(errMsg, "强度")
}

// isConflictError 判断是否为冲突错误
func isConflictError(err error) bool {
    errMsg := err.Error()
    return contains(errMsg, "已被使用") ||
        contains(errMsg, "已存在")
}

// contains 字符串包含判断（辅助函数）
func contains(s, substr string) bool {
    return len(s) >= len(substr) && (s == substr || len(substr) == 0 || 
        (len(s) > len(substr) && (s[:len(substr)] == substr || 
        s[len(s)-len(substr):] == substr || 
        indexOf(s, substr) >= 0)))
}

func indexOf(s, substr string) int {
    for i := 0; i <= len(s)-len(substr); i++ {
        if s[i:i+len(substr)] == substr {
            return i
        }
    }
    return -1
}
```

### 5. 使用response包格式化响应

确保 `pkg/response/` 包提供了Envelope格式的响应方法：

```go
// response包示例（如果不存在需要创建）
package response

import (
    "net/http"
    "github.com/gin-gonic/gin"
)

// Created 返回201 Created响应
func Created(c *gin.Context, data interface{}, message string) {
    envelope := buildEnvelope(c, http.StatusCreated, message, data, nil)
    c.JSON(http.StatusCreated, envelope)
}

// BadRequest 返回400 Bad Request响应
func BadRequest(c *gin.Context, message string, err error) {
    errors := []Error{{Code: "BAD_REQUEST", Message: err.Error()}}
    envelope := buildEnvelope(c, http.StatusBadRequest, message, nil, errors)
    c.JSON(http.StatusBadRequest, envelope)
}

// UnprocessableEntity 返回422 Unprocessable Entity响应
func UnprocessableEntity(c *gin.Context, message string, err error) {
    errors := []Error{{Code: "VALIDATION_ERROR", Message: err.Error()}}
    envelope := buildEnvelope(c, http.StatusUnprocessableEntity, message, nil, errors)
    c.JSON(http.StatusUnprocessableEntity, envelope)
}

// Conflict 返回409 Conflict响应
func Conflict(c *gin.Context, message string, err error) {
    errors := []Error{{Code: "CONFLICT", Message: err.Error()}}
    envelope := buildEnvelope(c, http.StatusConflict, message, nil, errors)
    c.JSON(http.StatusConflict, envelope)
}

// InternalServerError 返回500 Internal Server Error响应
func InternalServerError(c *gin.Context, message string, err error) {
    errors := []Error{{Code: "INTERNAL_ERROR", Message: err.Error()}}
    envelope := buildEnvelope(c, http.StatusInternalServerError, message, nil, errors)
    c.JSON(http.StatusInternalServerError, envelope)
}
```

### 6. 添加必要的导入

```go
package handler

import (
    "net/http"
    
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/dto"
    "yourproject/internal/service"
    "yourproject/pkg/response"
)
```

### 7. 注意事项

- **请求绑定**：使用Gin的ShouldBindJSON绑定JSON请求体
- **参数验证**：依赖Gin的binding标签进行参数验证
- **错误处理**：根据错误类型返回合适的HTTP状态码
- **响应格式**：所有响应使用Envelope格式
- **状态码**：注册成功返回201 Created
- **IP和User-Agent**：从请求中提取IP地址和User-Agent，传递给服务层
- **错误消息**：所有错误消息使用中文

## 验收标准

1. **接口定义完整**
   - UserHandler接口包含Register方法
   - 方法签名正确

2. **请求处理**
   - Register方法正确绑定请求参数
   - 正确提取IP地址和User-Agent
   - 参数验证正确

3. **服务调用**
   - 正确调用AuthService.Register
   - 错误处理正确

4. **响应格式化**
   - 成功响应使用Envelope格式
   - 错误响应使用Envelope格式
   - HTTP状态码正确（201 Created）

5. **错误处理**
   - 根据错误类型返回合适的HTTP状态码
   - 错误消息使用中文
   - 错误格式符合API设计规范

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/auth_service.go` - AuthService实现文件
- `internal/dto/auth_dto.go` - 认证相关DTO文件
- `pkg/response/response.go` - 响应格式化包（待创建或扩展）
- `.cursor/rules/api-design.mdc` - API设计规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/handler/user_handler.go` - UserHandler接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:26:31 CST

