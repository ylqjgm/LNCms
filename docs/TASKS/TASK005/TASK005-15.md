# TASK005-15: 创建UserService接口和实现 - 状态和封禁管理

## 任务信息

**任务编号**: TASK005-15  
**父任务**: TASK005  
**任务名称**: 创建UserService接口和实现 - 状态和封禁管理  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:26:31 CST

## 任务描述

扩展用户服务，提供用户状态管理和封禁管理功能。包括：1) 扩展UserService接口（UpdateStatus、BanUser、UnbanUser方法）；2) 实现状态更新（激活/禁用用户）；3) 实现用户封禁（设置is_locked为true，可以添加封禁原因和封禁期限）；4) 实现用户解封。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK005-14（创建UserService接口和实现 - 基础CRUD）

## 实现指南

### 1. 扩展UserService接口

在 `internal/service/user_service.go` 文件中，扩展UserService接口：

```go
// UserService 用户服务接口
// 提供用户管理的CRUD功能和状态管理功能
type UserService interface {
    // GetUser 根据ID获取用户
    GetUser(ctx context.Context, userID int64) (*dto.UserInfo, error)
    
    // GetUsers 获取用户列表，支持分页和筛选
    GetUsers(ctx context.Context, params *dto.UserQueryParams) (*dto.UserListResponse, error)
    
    // CreateUser 创建用户（管理员操作）
    CreateUser(ctx context.Context, req *dto.CreateUserRequest) (*dto.UserInfo, error)
    
    // UpdateUser 更新用户信息
    UpdateUser(ctx context.Context, userID int64, req *dto.UpdateUserRequest) (*dto.UserInfo, error)
    
    // DeleteUser 删除用户
    DeleteUser(ctx context.Context, userID int64) error
    
    // UpdateStatus 更新用户状态（激活/禁用）
    UpdateStatus(ctx context.Context, userID int64, isActive bool) (*dto.UserInfo, error)
    
    // BanUser 封禁用户
    // 设置is_locked为true，可以添加封禁原因和封禁期限
    BanUser(ctx context.Context, userID int64, req *dto.BanUserRequest) (*dto.UserInfo, error)
    
    // UnbanUser 解封用户
    // 设置is_locked为false，清除封禁原因和封禁期限
    UnbanUser(ctx context.Context, userID int64) (*dto.UserInfo, error)
}
```

### 2. 定义封禁相关DTO

在 `internal/dto/user_dto.go` 文件中，添加封禁相关的DTO：

```go
// BanUserRequest 封禁用户请求
type BanUserRequest struct {
    Reason      string     `json:"reason,omitempty"`       // 封禁原因
    ExpiresAt   *time.Time `json:"expires_at,omitempty"`  // 封禁期限（可选，nil表示永久封禁）
}
```

### 3. 扩展User模型（如果需要存储封禁信息）

如果需要在数据库中存储封禁原因和封禁期限，需要扩展User模型：

```go
// User 用户模型（扩展字段）
type User struct {
    // ... 现有字段
    
    // 封禁相关字段（可选，如果需要在数据库中存储）
    BanReason   *string    `gorm:"column:ban_reason;type:TEXT" json:"ban_reason,omitempty"`
    BanExpiresAt *time.Time `gorm:"column:ban_expires_at;type:TIMESTAMPTZ" json:"ban_expires_at,omitempty"`
}
```

### 4. 实现UpdateStatus方法

```go
// UpdateStatus 更新用户状态（激活/禁用）
func (s *userService) UpdateStatus(ctx context.Context, userID int64, isActive bool) (*dto.UserInfo, error) {
    if userID <= 0 {
        return nil, errors.New("用户ID无效")
    }
    
    // 检查用户是否存在
    user, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return nil, fmt.Errorf("用户不存在: %w", err)
    }
    
    // 更新状态
    if err := s.userRepo.UpdateStatus(ctx, userID, isActive); err != nil {
        return nil, fmt.Errorf("更新用户状态失败: %w", err)
    }
    
    // 更新本地对象
    user.IsActive = isActive
    
    return dto.ToUserInfo(user), nil
}
```

### 5. 实现BanUser方法

```go
// BanUser 封禁用户
func (s *userService) BanUser(ctx context.Context, userID int64, req *dto.BanUserRequest) (*dto.UserInfo, error) {
    if userID <= 0 {
        return nil, errors.New("用户ID无效")
    }
    
    // 检查用户是否存在
    user, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return nil, fmt.Errorf("用户不存在: %w", err)
    }
    
    // 检查用户是否已被封禁
    if user.IsLocked {
        return nil, errors.New("用户已被封禁")
    }
    
    // 构建更新请求
    updateReq := &dto.UpdateUserRequest{
        IsLocked: boolPtr(true),
    }
    
    // 如果提供了封禁原因，可以存储（如果模型支持）
    // 这里假设封禁原因和期限存储在User模型的扩展字段中
    // 如果需要在数据库中存储，需要扩展UserRepository的Update方法
    
    // 更新用户（设置is_locked为true）
    userInfo, err := s.UpdateUser(ctx, userID, updateReq)
    if err != nil {
        return nil, fmt.Errorf("封禁用户失败: %w", err)
    }
    
    // TODO: 如果需要在数据库中存储封禁原因和期限，可以在这里更新
    // 例如：s.userRepo.UpdateBanInfo(ctx, userID, req.Reason, req.ExpiresAt)
    
    return userInfo, nil
}
```

### 6. 实现UnbanUser方法

```go
// UnbanUser 解封用户
func (s *userService) UnbanUser(ctx context.Context, userID int64) (*dto.UserInfo, error) {
    if userID <= 0 {
        return nil, errors.New("用户ID无效")
    }
    
    // 检查用户是否存在
    user, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return nil, fmt.Errorf("用户不存在: %w", err)
    }
    
    // 检查用户是否已被封禁
    if !user.IsLocked {
        return nil, errors.New("用户未被封禁")
    }
    
    // 构建更新请求
    updateReq := &dto.UpdateUserRequest{
        IsLocked: boolPtr(false),
    }
    
    // 更新用户（设置is_locked为false）
    userInfo, err := s.UpdateUser(ctx, userID, updateReq)
    if err != nil {
        return nil, fmt.Errorf("解封用户失败: %w", err)
    }
    
    // TODO: 如果需要在数据库中清除封禁原因和期限，可以在这里更新
    // 例如：s.userRepo.ClearBanInfo(ctx, userID)
    
    return userInfo, nil
}
```

### 7. 添加辅助函数

```go
// boolPtr 布尔指针辅助函数
func boolPtr(b bool) *bool {
    return &b
}
```

### 8. 扩展UserRepository（如果需要存储封禁信息）

如果需要在数据库中存储封禁原因和期限，需要扩展UserRepository：

```go
// UserRepository 用户仓储接口（扩展方法）
type UserRepository interface {
    // ... 现有方法
    
    // UpdateBanInfo 更新封禁信息
    UpdateBanInfo(ctx context.Context, userID int64, reason *string, expiresAt *time.Time) error
    
    // ClearBanInfo 清除封禁信息
    ClearBanInfo(ctx context.Context, userID int64) error
}
```

### 9. 注意事项

- **状态管理**：UpdateStatus方法用于激活/禁用用户
- **封禁管理**：BanUser方法用于封禁用户，UnbanUser方法用于解封用户
- **封禁信息**：如果需要在数据库中存储封禁原因和期限，需要扩展User模型和UserRepository
- **状态检查**：封禁前检查用户是否已被封禁，解封前检查用户是否已被封禁
- **错误处理**：所有错误消息使用中文，清晰描述问题
- **权限控制**：这些操作通常需要管理员权限，在API层进行权限验证

## 验收标准

1. **接口扩展完整**
   - UserService接口包含UpdateStatus、BanUser、UnbanUser方法
   - 方法签名正确，参数和返回值类型正确

2. **状态更新功能**
   - UpdateStatus方法正确实现
   - 正确更新用户激活状态

3. **封禁功能**
   - BanUser方法正确实现
   - 正确设置is_locked为true
   - 支持封禁原因和期限（如果实现）

4. **解封功能**
   - UnbanUser方法正确实现
   - 正确设置is_locked为false
   - 清除封禁信息（如果实现）

5. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文
   - 状态检查正确

6. **代码规范**
   - 遵循Golang编码规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/user_service.go` - UserService接口和实现文件
- `internal/dto/user_dto.go` - 用户相关DTO文件
- `internal/repository/user_repository.go` - UserRepository实现文件（可能需要扩展）
- `internal/models/user.go` - User模型文件（可能需要扩展）
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/security.mdc` - 应用安全开发规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:26:31 CST

