# TASK005-17: 编写UserService单元测试

## 任务信息

**任务编号**: TASK005-17  
**父任务**: TASK005  
**任务名称**: 编写UserService单元测试  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:26:31 CST

## 任务描述

编写用户服务单元测试。包括：1) 测试所有CRUD方法；2) 测试状态管理和封禁管理功能；3) 测试审核和密码管理功能；4) 使用Mock Repository和Service进行测试；5) 确保测试覆盖率达标。所有测试用例描述必须使用中文。

## 依赖任务

TASK005-16（创建UserService接口和实现 - 审核和密码管理）

## 实现指南

### 1. 创建测试文件

在 `internal/service/` 目录下创建 `user_service_test.go` 文件。

### 2. 设置测试依赖

参考TASK005-13的测试文件结构，使用testify/mock创建Mock对象。

### 3. 测试GetUser方法

```go
func TestUserService_GetUser(t *testing.T) {
    tests := []struct {
        name       string
        setupMocks func(*MockUserRepository)
        userID     int64
        wantErr    bool
        errMsg     string
    }{
        {
            name: "正常获取用户",
            setupMocks: func(userRepo *MockUserRepository) {
                user := &models.User{
                    ID:       1,
                    Username: "testuser",
                    Email:    "test@example.com",
                }
                userRepo.On("GetByID", mock.Anything, int64(1)).Return(user, nil)
            },
            userID:  1,
            wantErr: false,
        },
        {
            name: "用户不存在",
            setupMocks: func(userRepo *MockUserRepository) {
                userRepo.On("GetByID", mock.Anything, int64(999)).Return(nil, errors.New("用户不存在"))
            },
            userID:  999,
            wantErr: true,
            errMsg:  "用户不存在",
        },
        {
            name: "用户ID无效",
            setupMocks: func(userRepo *MockUserRepository) {
                // 不需要设置Mock
            },
            userID:  0,
            wantErr: true,
            errMsg:  "用户ID无效",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockUserRepo := new(MockUserRepository)
            tt.setupMocks(mockUserRepo)
            
            service := NewUserService(mockUserRepo, nil)
            ctx := context.Background()
            userInfo, err := service.GetUser(ctx, tt.userID)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                assert.Nil(t, userInfo)
            } else {
                require.NoError(t, err)
                require.NotNil(t, userInfo)
                assert.Equal(t, tt.userID, userInfo.ID)
            }
            
            mockUserRepo.AssertExpectations(t)
        })
    }
}
```

### 4. 测试GetUsers方法

```go
func TestUserService_GetUsers(t *testing.T) {
    // 测试分页、筛选、排序功能
    // 参考TASK005-13的测试结构
}
```

### 5. 测试CreateUser方法

```go
func TestUserService_CreateUser(t *testing.T) {
    tests := []struct {
        name       string
        setupMocks func(*MockUserRepository, *MockPasswordService)
        req        *dto.CreateUserRequest
        wantErr    bool
        errMsg     string
    }{
        {
            name: "正常创建用户",
            setupMocks: func(userRepo *MockUserRepository, passwordService *MockPasswordService) {
                userRepo.On("ExistsByUsername", mock.Anything, "newuser").Return(false, nil)
                userRepo.On("ExistsByEmail", mock.Anything, "new@example.com").Return(false, nil)
                passwordService.On("ValidatePasswordStrength", "password123").Return(nil)
                passwordService.On("HashPassword", "password123").Return("hashed_password", nil)
                userRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.User")).Return(nil)
            },
            req: &dto.CreateUserRequest{
                Username: "newuser",
                Email:    "new@example.com",
                Password: "password123",
            },
            wantErr: false,
        },
        {
            name: "用户名已存在",
            setupMocks: func(userRepo *MockUserRepository, passwordService *MockPasswordService) {
                userRepo.On("ExistsByUsername", mock.Anything, "existinguser").Return(true, nil)
            },
            req: &dto.CreateUserRequest{
                Username: "existinguser",
                Email:    "new@example.com",
                Password: "password123",
            },
            wantErr: true,
            errMsg:  "用户名已被使用",
        },
        // 更多测试用例...
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockUserRepo := new(MockUserRepository)
            mockPasswordService := new(MockPasswordService)
            tt.setupMocks(mockUserRepo, mockPasswordService)
            
            service := NewUserService(mockUserRepo, mockPasswordService)
            ctx := context.Background()
            userInfo, err := service.CreateUser(ctx, tt.req)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                assert.Nil(t, userInfo)
            } else {
                require.NoError(t, err)
                require.NotNil(t, userInfo)
            }
            
            mockUserRepo.AssertExpectations(t)
            mockPasswordService.AssertExpectations(t)
        })
    }
}
```

### 6. 测试UpdateUser方法

```go
func TestUserService_UpdateUser(t *testing.T) {
    // 测试部分更新、唯一性验证等
    // 参考上面的测试结构
}
```

### 7. 测试DeleteUser方法

```go
func TestUserService_DeleteUser(t *testing.T) {
    // 测试删除功能
    // 参考上面的测试结构
}
```

### 8. 测试UpdateStatus方法

```go
func TestUserService_UpdateStatus(t *testing.T) {
    tests := []struct {
        name       string
        setupMocks func(*MockUserRepository)
        userID     int64
        isActive   bool
        wantErr    bool
        errMsg     string
    }{
        {
            name: "正常激活用户",
            setupMocks: func(userRepo *MockUserRepository) {
                user := &models.User{ID: 1, IsActive: false}
                userRepo.On("GetByID", mock.Anything, int64(1)).Return(user, nil)
                userRepo.On("UpdateStatus", mock.Anything, int64(1), true).Return(nil)
            },
            userID:   1,
            isActive: true,
            wantErr:  false,
        },
        // 更多测试用例...
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockUserRepo := new(MockUserRepository)
            tt.setupMocks(mockUserRepo)
            
            service := NewUserService(mockUserRepo, nil)
            ctx := context.Background()
            userInfo, err := service.UpdateStatus(ctx, tt.userID, tt.isActive)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                assert.Nil(t, userInfo)
            } else {
                require.NoError(t, err)
                require.NotNil(t, userInfo)
            }
            
            mockUserRepo.AssertExpectations(t)
        })
    }
}
```

### 9. 测试BanUser和UnbanUser方法

```go
func TestUserService_BanUser(t *testing.T) {
    // 测试封禁功能
    // 参考上面的测试结构
}

func TestUserService_UnbanUser(t *testing.T) {
    // 测试解封功能
    // 参考上面的测试结构
}
```

### 10. 测试ApproveUser和RejectUser方法

```go
func TestUserService_ApproveUser(t *testing.T) {
    // 测试审核通过功能
    // 参考上面的测试结构
}

func TestUserService_RejectUser(t *testing.T) {
    // 测试审核拒绝功能
    // 参考上面的测试结构
}
```

### 11. 测试ResetPassword方法

```go
func TestUserService_ResetPassword(t *testing.T) {
    tests := []struct {
        name       string
        setupMocks func(*MockUserRepository, *MockPasswordService)
        userID     int64
        req        *dto.ResetPasswordRequest
        wantErr    bool
        errMsg     string
    }{
        {
            name: "正常重置密码-指定密码",
            setupMocks: func(userRepo *MockUserRepository, passwordService *MockPasswordService) {
                user := &models.User{ID: 1, PasswordHash: "old_hash"}
                userRepo.On("GetByID", mock.Anything, int64(1)).Return(user, nil)
                passwordService.On("ValidatePasswordStrength", "newpassword123").Return(nil)
                passwordService.On("HashPassword", "newpassword123").Return("new_hash", nil)
                userRepo.On("Update", mock.Anything, mock.AnythingOfType("*models.User")).Return(nil)
            },
            userID: 1,
            req: &dto.ResetPasswordRequest{
                NewPassword: "newpassword123",
            },
            wantErr: false,
        },
        {
            name: "正常重置密码-自动生成",
            setupMocks: func(userRepo *MockUserRepository, passwordService *MockPasswordService) {
                user := &models.User{ID: 1, PasswordHash: "old_hash"}
                userRepo.On("GetByID", mock.Anything, int64(1)).Return(user, nil)
                passwordService.On("GenerateRandomPassword", 12).Return("generated_password", nil)
                passwordService.On("HashPassword", "generated_password").Return("new_hash", nil)
                userRepo.On("Update", mock.Anything, mock.AnythingOfType("*models.User")).Return(nil)
            },
            userID: 1,
            req: &dto.ResetPasswordRequest{
                AutoGenerate: true,
            },
            wantErr: false,
        },
        // 更多测试用例...
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockUserRepo := new(MockUserRepository)
            mockPasswordService := new(MockPasswordService)
            tt.setupMocks(mockUserRepo, mockPasswordService)
            
            service := NewUserService(mockUserRepo, mockPasswordService)
            ctx := context.Background()
            err := service.ResetPassword(ctx, tt.userID, tt.req)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
            } else {
                require.NoError(t, err)
            }
            
            mockUserRepo.AssertExpectations(t)
            mockPasswordService.AssertExpectations(t)
        })
    }
}
```

### 12. 注意事项

- **使用表驱动测试**：使用表驱动测试处理多个测试场景
- **Mock对象**：使用testify/mock创建Mock对象
- **测试覆盖**：覆盖所有方法、正常情况、边界情况和异常情况
- **测试描述**：所有测试用例名称和错误消息使用中文
- **测试独立性**：每个测试应该独立，不依赖其他测试
- **覆盖率要求**：确保测试覆盖率达标（80%以上）

## 验收标准

1. **测试文件完整**
   - 创建了user_service_test.go文件
   - 测试文件结构清晰，组织合理

2. **CRUD功能测试**
   - 测试GetUser方法
   - 测试GetUsers方法
   - 测试CreateUser方法
   - 测试UpdateUser方法
   - 测试DeleteUser方法

3. **状态管理测试**
   - 测试UpdateStatus方法
   - 测试BanUser方法
   - 测试UnbanUser方法

4. **审核和密码管理测试**
   - 测试ApproveUser方法
   - 测试RejectUser方法
   - 测试ResetPassword方法

5. **测试质量**
   - 使用Mock对象进行测试
   - 测试用例覆盖全面
   - 测试描述使用中文
   - 测试覆盖率达标（80%以上）

6. **代码规范**
   - 遵循Golang测试规范
   - 遵循单元测试规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/user_service.go` - UserService实现文件
- `.cursor/rules/testing.mdc` - Golang单元测试规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/user_service_test.go` - UserService测试文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:26:31 CST

