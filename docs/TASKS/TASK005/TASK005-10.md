# TASK005-10: 编写JWTService单元测试

## 任务信息

**任务编号**: TASK005-10  
**父任务**: TASK005  
**任务名称**: 编写JWTService单元测试  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:06:59 CST

## 任务描述

编写JWT服务单元测试。包括：1) 测试token生成和验证功能；2) 测试token刷新功能；3) 测试token黑名单功能；4) 测试过期token处理；5) 确保测试覆盖率达标。所有测试用例描述必须使用中文。

## 依赖任务

TASK005-09（创建JWTService接口和实现）

## 实现指南

### 1. 创建测试文件

在 `internal/service/` 目录下创建 `jwt_service_test.go` 文件：

```go
package service

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/require"
    "gorm.io/driver/postgres"
    "gorm.io/gorm"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 2. 创建Mock SessionRepository

```go
// MockSessionRepository Mock SessionRepository
type MockSessionRepository struct {
    mock.Mock
}

func (m *MockSessionRepository) Create(ctx context.Context, session *models.UserSession) error {
    args := m.Called(ctx, session)
    return args.Error(0)
}

func (m *MockSessionRepository) GetByToken(ctx context.Context, token string) (*models.UserSession, error) {
    args := m.Called(ctx, token)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*models.UserSession), args.Error(1)
}

func (m *MockSessionRepository) BlacklistToken(ctx context.Context, token string) error {
    args := m.Called(ctx, token)
    return args.Error(0)
}

func (m *MockSessionRepository) IsBlacklisted(ctx context.Context, token string) (bool, error) {
    args := m.Called(ctx, token)
    return args.Bool(0), args.Error(1)
}

func (m *MockSessionRepository) DeleteExpired(ctx context.Context) error {
    args := m.Called(ctx)
    return args.Error(0)
}

func (m *MockSessionRepository) DeleteByUserID(ctx context.Context, userID int64) error {
    args := m.Called(ctx, userID)
    return args.Error(0)
}

func (m *MockSessionRepository) DeleteByToken(ctx context.Context, token string) error {
    args := m.Called(ctx, token)
    return args.Error(0)
}
```

### 3. 测试GenerateToken方法

```go
// TestJWTService_GenerateToken 测试生成token
func TestJWTService_GenerateToken(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    userID := int64(1)
    username := "testuser"
    var roleID int64 = 2
    
    // 设置Mock期望
    mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.UserSession")).Return(nil).Times(2)
    
    // 生成token
    tokenPair, err := service.GenerateToken(userID, username, &roleID)
    
    // 验证结果
    require.NoError(t, err, "生成token失败")
    require.NotNil(t, tokenPair, "token对不应该为nil")
    assert.NotEmpty(t, tokenPair.AccessToken, "access token不应该为空")
    assert.NotEmpty(t, tokenPair.RefreshToken, "refresh token不应该为空")
    assert.False(t, tokenPair.ExpiresAt.IsZero(), "过期时间应该被设置")
    
    // 验证Mock调用
    mockRepo.AssertExpectations(t)
}

// TestJWTService_GenerateToken_Claims 测试token Claims
func TestJWTService_GenerateToken_Claims(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    userID := int64(1)
    username := "testuser"
    var roleID int64 = 2
    
    // 设置Mock期望
    mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.UserSession")).Return(nil).Times(2)
    
    // 生成token
    tokenPair, err := service.GenerateToken(userID, username, &roleID)
    require.NoError(t, err, "生成token失败")
    
    // 验证token Claims
    claims, err := service.ValidateToken(tokenPair.AccessToken)
    require.NoError(t, err, "验证token失败")
    assert.Equal(t, userID, claims.UserID, "用户ID不匹配")
    assert.Equal(t, username, claims.Username, "用户名不匹配")
    assert.NotNil(t, claims.RoleID, "角色ID不应该为nil")
    assert.Equal(t, roleID, *claims.RoleID, "角色ID不匹配")
}
```

### 4. 测试ValidateToken方法

```go
// TestJWTService_ValidateToken 测试验证token
func TestJWTService_ValidateToken(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    userID := int64(1)
    username := "testuser"
    
    // 设置Mock期望
    mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.UserSession")).Return(nil).Times(2)
    mockRepo.On("IsBlacklisted", mock.Anything, mock.AnythingOfType("string")).Return(false, nil)
    
    // 生成token
    tokenPair, err := service.GenerateToken(userID, username, nil)
    require.NoError(t, err, "生成token失败")
    
    // 验证token
    claims, err := service.ValidateToken(tokenPair.AccessToken)
    require.NoError(t, err, "验证token失败")
    require.NotNil(t, claims, "Claims不应该为nil")
    assert.Equal(t, userID, claims.UserID, "用户ID不匹配")
    assert.Equal(t, username, claims.Username, "用户名不匹配")
}

// TestJWTService_ValidateToken_InvalidToken 测试无效token
func TestJWTService_ValidateToken_InvalidToken(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    tests := []struct {
        name  string
        token string
    }{
        {
            name:  "空token",
            token: "",
        },
        {
            name:  "无效格式token",
            token: "invalid.token.string",
        },
        {
            name:  "错误签名的token",
            token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxfQ.invalid-signature",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            claims, err := service.ValidateToken(tt.token)
            require.Error(t, err, "期望返回错误")
            assert.Nil(t, claims, "Claims应该为nil")
        })
    }
}

// TestJWTService_ValidateToken_Blacklisted 测试黑名单token
func TestJWTService_ValidateToken_Blacklisted(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    userID := int64(1)
    username := "testuser"
    
    // 设置Mock期望
    mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.UserSession")).Return(nil).Times(2)
    mockRepo.On("IsBlacklisted", mock.Anything, mock.AnythingOfType("string")).Return(true, nil)
    
    // 生成token
    tokenPair, err := service.GenerateToken(userID, username, nil)
    require.NoError(t, err, "生成token失败")
    
    // 验证黑名单token
    claims, err := service.ValidateToken(tokenPair.AccessToken)
    require.Error(t, err, "期望返回错误")
    assert.Nil(t, claims, "Claims应该为nil")
    assert.Contains(t, err.Error(), "黑名单", "错误消息应该包含黑名单")
}
```

### 5. 测试RefreshToken方法

```go
// TestJWTService_RefreshToken 测试刷新token
func TestJWTService_RefreshToken(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    userID := int64(1)
    username := "testuser"
    
    // 设置Mock期望 - 生成token
    mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.UserSession")).Return(nil).Times(2)
    mockRepo.On("IsBlacklisted", mock.Anything, mock.AnythingOfType("string")).Return(false, nil)
    
    // 生成初始token
    tokenPair, err := service.GenerateToken(userID, username, nil)
    require.NoError(t, err, "生成token失败")
    
    // 设置Mock期望 - 刷新token
    refreshSession := &models.UserSession{
        UserID:    userID,
        Token:     tokenPair.RefreshToken,
        TokenType: models.TokenTypeRefresh,
        ExpiresAt: time.Now().Add(7 * 24 * time.Hour),
    }
    mockRepo.On("GetByToken", mock.Anything, tokenPair.RefreshToken).Return(refreshSession, nil)
    mockRepo.On("BlacklistToken", mock.Anything, tokenPair.RefreshToken).Return(nil)
    mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.UserSession")).Return(nil).Times(2)
    
    // 刷新token
    newTokenPair, err := service.RefreshToken(tokenPair.RefreshToken)
    
    // 验证结果
    require.NoError(t, err, "刷新token失败")
    require.NotNil(t, newTokenPair, "新token对不应该为nil")
    assert.NotEmpty(t, newTokenPair.AccessToken, "新access token不应该为空")
    assert.NotEmpty(t, newTokenPair.RefreshToken, "新refresh token不应该为空")
    assert.NotEqual(t, tokenPair.AccessToken, newTokenPair.AccessToken, "新access token应该不同")
    assert.NotEqual(t, tokenPair.RefreshToken, newTokenPair.RefreshToken, "新refresh token应该不同")
    
    // 验证旧refresh token被加入黑名单
    mockRepo.AssertExpectations(t)
}

// TestJWTService_RefreshToken_InvalidToken 测试无效refresh token
func TestJWTService_RefreshToken_InvalidToken(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    // 设置Mock期望
    mockRepo.On("IsBlacklisted", mock.Anything, mock.AnythingOfType("string")).Return(false, nil)
    
    // 尝试刷新无效token
    tokenPair, err := service.RefreshToken("invalid-token")
    require.Error(t, err, "期望返回错误")
    assert.Nil(t, tokenPair, "token对应该为nil")
}
```

### 6. 测试BlacklistToken和IsBlacklisted方法

```go
// TestJWTService_BlacklistToken 测试将token加入黑名单
func TestJWTService_BlacklistToken(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    token := "test-token-string"
    
    // 设置Mock期望
    mockRepo.On("BlacklistToken", mock.Anything, token).Return(nil)
    
    // 将token加入黑名单
    err := service.BlacklistToken(token)
    require.NoError(t, err, "将token加入黑名单失败")
    
    // 验证Mock调用
    mockRepo.AssertExpectations(t)
}

// TestJWTService_IsBlacklisted 测试检查token是否在黑名单中
func TestJWTService_IsBlacklisted(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    tests := []struct {
        name         string
        token        string
        isBlacklisted bool
    }{
        {
            name:         "token在黑名单中",
            token:        "blacklisted-token",
            isBlacklisted: true,
        },
        {
            name:         "token不在黑名单中",
            token:        "normal-token",
            isBlacklisted: false,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // 设置Mock期望
            mockRepo.On("IsBlacklisted", mock.Anything, tt.token).Return(tt.isBlacklisted, nil)
            
            // 检查黑名单状态
            isBlacklisted, err := service.IsBlacklisted(tt.token)
            require.NoError(t, err, "检查黑名单状态失败")
            assert.Equal(t, tt.isBlacklisted, isBlacklisted, "黑名单状态不匹配")
        })
    }
}
```

### 7. 测试过期token处理

```go
// TestJWTService_ValidateToken_Expired 测试过期token
func TestJWTService_ValidateToken_Expired(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    // 使用很短的过期时间进行测试
    config := &JWTConfig{
        SecretKey:          []byte(secretKey),
        AccessTokenExpiry:  1 * time.Second,
        RefreshTokenExpiry: 1 * time.Second,
        Issuer:             "lncms",
    }
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    userID := int64(1)
    username := "testuser"
    
    // 设置Mock期望
    mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.UserSession")).Return(nil).Times(2)
    mockRepo.On("IsBlacklisted", mock.Anything, mock.AnythingOfType("string")).Return(false, nil)
    
    // 生成token
    tokenPair, err := service.GenerateToken(userID, username, nil)
    require.NoError(t, err, "生成token失败")
    
    // 等待token过期
    time.Sleep(2 * time.Second)
    
    // 验证过期token
    claims, err := service.ValidateToken(tokenPair.AccessToken)
    require.Error(t, err, "期望返回错误")
    assert.Nil(t, claims, "Claims应该为nil")
    assert.Contains(t, err.Error(), "过期", "错误消息应该包含过期")
}
```

### 8. 集成测试

```go
// TestJWTService_Integration 测试JWT服务集成
func TestJWTService_Integration(t *testing.T) {
    secretKey := "test-secret-key-for-jwt-service-testing"
    config := DefaultJWTConfig(secretKey)
    mockRepo := new(MockSessionRepository)
    service := NewJWTService(config, mockRepo)
    
    userID := int64(1)
    username := "testuser"
    var roleID int64 = 2
    
    // 设置Mock期望
    mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*models.UserSession")).Return(nil).Times(4)
    mockRepo.On("IsBlacklisted", mock.Anything, mock.AnythingOfType("string")).Return(false, nil)
    
    // 1. 生成token
    tokenPair, err := service.GenerateToken(userID, username, &roleID)
    require.NoError(t, err, "生成token失败")
    
    // 2. 验证token
    claims, err := service.ValidateToken(tokenPair.AccessToken)
    require.NoError(t, err, "验证token失败")
    assert.Equal(t, userID, claims.UserID, "用户ID不匹配")
    
    // 3. 将token加入黑名单
    mockRepo.On("BlacklistToken", mock.Anything, tokenPair.AccessToken).Return(nil)
    mockRepo.On("IsBlacklisted", mock.Anything, tokenPair.AccessToken).Return(true, nil)
    err = service.BlacklistToken(tokenPair.AccessToken)
    require.NoError(t, err, "将token加入黑名单失败")
    
    // 4. 验证黑名单token
    claims, err = service.ValidateToken(tokenPair.AccessToken)
    require.Error(t, err, "期望返回错误")
    assert.Nil(t, claims, "Claims应该为nil")
}
```

### 9. 注意事项

- **Mock使用**：使用testify/mock创建Mock SessionRepository
- **测试覆盖**：确保测试覆盖所有方法和各种情况
- **边界测试**：测试边界情况，如空值、过期token等
- **错误测试**：测试各种错误情况，确保错误处理正确
- **集成测试**：测试多个方法的组合使用
- **中文描述**：所有测试用例名称使用中文

## 验收标准

1. **测试覆盖完整**
   - 所有JWTService方法都有对应的测试
   - 测试覆盖正常情况、边界情况和异常情况
   - 测试覆盖率达标

2. **测试质量**
   - 测试用例独立，不依赖执行顺序
   - 测试用例名称清晰，使用中文
   - 测试逻辑正确

3. **测试工具使用**
   - 使用testify/mock创建Mock对象
   - 使用testify/assert和testify/require进行断言
   - 使用表驱动测试处理多个测试场景

4. **代码规范**
   - 遵循Golang编码规范
   - 遵循单元测试规范
   - 测试用例描述使用中文

## 相关文件

- `internal/service/jwt_service.go` - JWTService实现文件
- `internal/repository/session_repository.go` - SessionRepository实现文件
- `.cursor/rules/testing.mdc` - Golang单元测试规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/jwt_service_test.go` - JWTService测试文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:06:59 CST

