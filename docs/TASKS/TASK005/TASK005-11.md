# TASK005-11: 创建AuthService接口和实现 - 登录和登出

## 任务信息

**任务编号**: TASK005-11  
**父任务**: TASK005  
**任务名称**: 创建AuthService接口和实现 - 登录和登出  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:26:31 CST

## 任务描述

创建认证服务，提供用户登录和登出功能。包括：1) 定义AuthService接口（Login、Logout方法）；2) 实现登录逻辑（验证用户名/邮箱和密码、生成JWT token、记录登录日志、更新最后登录时间）；3) 实现登出逻辑（将token加入黑名单）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK005-04（实现UserRepository接口和实现）、TASK005-07（创建PasswordService接口和实现）、TASK005-09（创建JWTService接口和实现）

## 实现指南

### 1. 定义AuthService接口

在 `internal/service/` 目录下创建 `auth_service.go` 文件，定义AuthService接口：

```go
package service

import (
    "context"
    "yourproject/internal/dto"
)

// AuthService 认证服务接口
// 提供用户登录、登出功能
type AuthService interface {
    // Login 用户登录
    // 支持用户名或邮箱登录
    // 返回用户信息和token对
    Login(ctx context.Context, req *dto.LoginRequest) (*dto.LoginResponse, error)
    
    // Logout 用户登出
    // 将token加入黑名单
    Logout(ctx context.Context, token string) error
}
```

### 2. 定义DTO结构

在 `internal/dto/` 目录下创建 `auth_dto.go` 文件，定义请求和响应DTO：

```go
package dto

import (
    "time"
    "yourproject/internal/models"
)

// LoginRequest 登录请求
type LoginRequest struct {
    UsernameOrEmail string `json:"username_or_email" binding:"required"` // 用户名或邮箱
    Password        string `json:"password" binding:"required"`           // 密码
    IPAddress       string `json:"ip_address,omitempty"`                  // IP地址
    UserAgent       string `json:"user_agent,omitempty"`                  // 用户代理
}

// LoginResponse 登录响应
type LoginResponse struct {
    User        *UserInfo   `json:"user"`         // 用户信息
    AccessToken string      `json:"access_token"` // Access token
    RefreshToken string     `json:"refresh_token"` // Refresh token
    ExpiresAt   time.Time  `json:"expires_at"`   // Token过期时间
}

// UserInfo 用户信息（登录响应中使用）
type UserInfo struct {
    ID            int64     `json:"id"`
    Username      string    `json:"username"`
    Email         string    `json:"email"`
    Phone         *string   `json:"phone,omitempty"`
    EmailVerified bool      `json:"email_verified"`
    PhoneVerified bool      `json:"phone_verified"`
    IsActive      bool      `json:"is_active"`
    IsLocked      bool      `json:"is_locked"`
    RoleID        *int64    `json:"role_id,omitempty"`
    UserGroupID   *int64    `json:"user_group_id,omitempty"`
    LevelID       *int64    `json:"level_id,omitempty"`
    CreatedAt     time.Time `json:"created_at"`
    LastLoginAt   *time.Time `json:"last_login_at,omitempty"`
}

// ToUserInfo 将User模型转换为UserInfo
func ToUserInfo(user *models.User) *UserInfo {
    return &UserInfo{
        ID:            user.ID,
        Username:      user.Username,
        Email:         user.Email,
        Phone:         user.Phone,
        EmailVerified: user.EmailVerified,
        PhoneVerified: user.PhoneVerified,
        IsActive:      user.IsActive,
        IsLocked:      user.IsLocked,
        RoleID:        user.RoleID,
        UserGroupID:   user.UserGroupID,
        LevelID:       user.LevelID,
        CreatedAt:     user.CreatedAt,
        LastLoginAt:   user.LastLoginAt,
    }
}
```

### 3. 实现AuthService接口

```go
package service

import (
    "context"
    "errors"
    "fmt"
    "strings"
    
    "yourproject/internal/dto"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)

// authService AuthService的实现
type authService struct {
    userRepo        repository.UserRepository
    passwordService PasswordService
    jwtService      JWTService
    loginLogRepo    repository.LoginLogRepository // 如果已实现
}

// NewAuthService 创建AuthService实例
func NewAuthService(
    userRepo repository.UserRepository,
    passwordService PasswordService,
    jwtService JWTService,
    loginLogRepo repository.LoginLogRepository,
) AuthService {
    return &authService{
        userRepo:        userRepo,
        passwordService: passwordService,
        jwtService:      jwtService,
        loginLogRepo:    loginLogRepo,
    }
}

// Login 用户登录
func (s *authService) Login(ctx context.Context, req *dto.LoginRequest) (*dto.LoginResponse, error) {
    // 1. 验证输入参数
    if req.UsernameOrEmail == "" {
        return nil, errors.New("用户名或邮箱不能为空")
    }
    if req.Password == "" {
        return nil, errors.New("密码不能为空")
    }
    
    // 2. 根据用户名或邮箱查找用户
    var user *models.User
    var err error
    
    // 判断是用户名还是邮箱
    if strings.Contains(req.UsernameOrEmail, "@") {
        // 包含@符号，认为是邮箱
        user, err = s.userRepo.GetByEmail(ctx, req.UsernameOrEmail)
    } else {
        // 不包含@符号，认为是用户名
        user, err = s.userRepo.GetByUsername(ctx, req.UsernameOrEmail)
    }
    
    if err != nil {
        // 记录登录失败日志
        s.recordLoginLog(ctx, 0, req.IPAddress, req.UserAgent, false, "用户不存在")
        return nil, errors.New("用户名或密码错误")
    }
    
    // 3. 检查用户状态
    if !user.IsActive {
        s.recordLoginLog(ctx, user.ID, req.IPAddress, req.UserAgent, false, "用户未激活")
        return nil, errors.New("用户未激活，无法登录")
    }
    
    if user.IsLocked {
        s.recordLoginLog(ctx, user.ID, req.IPAddress, req.UserAgent, false, "用户已锁定")
        return nil, errors.New("用户已被锁定，无法登录")
    }
    
    if !user.EmailVerified {
        s.recordLoginLog(ctx, user.ID, req.IPAddress, req.UserAgent, false, "邮箱未验证")
        return nil, errors.New("邮箱未验证，请先验证邮箱")
    }
    
    // 4. 验证密码
    if !s.passwordService.VerifyPassword(user.PasswordHash, req.Password) {
        // 记录登录失败日志
        s.recordLoginLog(ctx, user.ID, req.IPAddress, req.UserAgent, false, "密码错误")
        return nil, errors.New("用户名或密码错误")
    }
    
    // 5. 生成JWT token
    tokenPair, err := s.jwtService.GenerateToken(user.ID, user.Username, user.RoleID)
    if err != nil {
        s.recordLoginLog(ctx, user.ID, req.IPAddress, req.UserAgent, false, "生成token失败")
        return nil, fmt.Errorf("登录失败: %w", err)
    }
    
    // 6. 更新最后登录时间
    if err := s.userRepo.UpdateLastLoginAt(ctx, user.ID); err != nil {
        // 记录错误但不影响登录流程
        // 可以记录日志
    }
    
    // 7. 记录登录成功日志
    s.recordLoginLog(ctx, user.ID, req.IPAddress, req.UserAgent, true, "登录成功")
    
    // 8. 构建响应
    return &dto.LoginResponse{
        User:         dto.ToUserInfo(user),
        AccessToken:  tokenPair.AccessToken,
        RefreshToken: tokenPair.RefreshToken,
        ExpiresAt:    tokenPair.ExpiresAt,
    }, nil
}

// Logout 用户登出
func (s *authService) Logout(ctx context.Context, token string) error {
    if token == "" {
        return errors.New("token不能为空")
    }
    
    // 将token加入黑名单
    if err := s.jwtService.BlacklistToken(token); err != nil {
        return fmt.Errorf("登出失败: %w", err)
    }
    
    return nil
}

// recordLoginLog 记录登录日志（辅助方法）
func (s *authService) recordLoginLog(ctx context.Context, userID int64, ipAddress, userAgent string, success bool, message string) {
    if s.loginLogRepo == nil {
        // 如果LoginLogRepository未实现，跳过日志记录
        return
    }
    
    log := &models.UserLoginLog{
        UserID:    userID,
        IPAddress: ipAddress,
        UserAgent: userAgent,
        Status:    success,
        Message:   message,
    }
    
    // 忽略错误，不影响登录流程
    _ = s.loginLogRepo.Create(ctx, log)
}
```

### 4. 添加必要的导入

```go
package service

import (
    "context"
    "errors"
    "fmt"
    "strings"
    
    "yourproject/internal/dto"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 5. 错误定义

```go
// 认证服务错误定义
var (
    ErrLoginFailed          = errors.New("用户名或密码错误")
    ErrUserInactive         = errors.New("用户未激活，无法登录")
    ErrUserLocked           = errors.New("用户已被锁定，无法登录")
    ErrEmailNotVerified     = errors.New("邮箱未验证，请先验证邮箱")
    ErrTokenRequired        = errors.New("token不能为空")
)
```

### 6. 注意事项

- **安全性**：密码验证失败时，返回通用错误消息，不泄露用户是否存在
- **状态检查**：登录前检查用户状态（激活、锁定、邮箱验证）
- **登录日志**：记录所有登录尝试（成功和失败）
- **错误处理**：所有错误消息使用中文，清晰描述问题
- **Token管理**：登出时将token加入黑名单，防止token被继续使用
- **最后登录时间**：更新用户最后登录时间，用于统计和分析

## 验收标准

1. **接口定义完整**
   - AuthService接口包含Login和Logout方法
   - 方法签名正确，参数和返回值类型正确

2. **登录功能完整**
   - Login方法支持用户名或邮箱登录
   - 正确验证用户状态（激活、锁定、邮箱验证）
   - 正确验证密码
   - 正确生成JWT token
   - 正确更新最后登录时间
   - 正确记录登录日志

3. **登出功能完整**
   - Logout方法正确实现
   - 将token加入黑名单

4. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文
   - 密码错误时返回通用错误消息，不泄露用户是否存在

5. **安全性**
   - 密码验证使用PasswordService
   - Token生成使用JWTService
   - 登出时正确管理token黑名单

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循安全开发规范
   - 注释完整，使用中文

## 相关文件

- `internal/repository/user_repository.go` - UserRepository实现文件
- `internal/service/password_service.go` - PasswordService实现文件
- `internal/service/jwt_service.go` - JWTService实现文件
- `internal/dto/auth_dto.go` - 认证相关DTO文件（待创建）
- `.cursor/rules/security.mdc` - 应用安全开发规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/auth_service.go` - AuthService接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:26:31 CST

