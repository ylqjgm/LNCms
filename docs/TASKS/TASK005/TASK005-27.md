# TASK005-27: 创建JWT认证中间件

## 任务信息

**任务编号**: TASK005-27  
**父任务**: TASK005  
**任务名称**: 创建JWT认证中间件  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:37:44 CST

## 任务描述

创建JWT认证中间件，用于验证HTTP请求中的JWT token。包括：1) 创建JWTAuthMiddleware函数；2) 从请求头提取JWT token（Authorization: Bearer {token}）；3) 验证token（使用JWTService）；4) 将用户信息存储到上下文（context）中；5) 如果token无效，返回401错误。所有代码必须遵循Golang编码规范和API设计规范。

## 依赖任务

TASK005-09（创建JWTService接口和实现）

## 实现指南

### 1. 创建中间件文件

在 `internal/middleware/` 目录下创建 `jwt_auth.go` 文件：

```go
package middleware

import (
    "strings"
    
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/service"
    "yourproject/pkg/response"
)

// UserContextKey 用户上下文键
type UserContextKey string

const (
    // UserIDKey 用户ID上下文键
    UserIDKey UserContextKey = "user_id"
    // UsernameKey 用户名上下文键
    UsernameKey UserContextKey = "username"
    // RoleIDKey 角色ID上下文键
    RoleIDKey UserContextKey = "role_id"
)
```

### 2. 创建JWTAuthMiddleware函数

```go
// JWTAuthMiddleware JWT认证中间件
// 从请求头提取JWT token，验证token有效性，并将用户信息存储到上下文中
func JWTAuthMiddleware(jwtService service.JWTService) gin.HandlerFunc {
    return func(c *gin.Context) {
        // 1. 从请求头提取JWT token
        token := extractTokenFromHeader(c)
        if token == "" {
            response.Unauthorized(c, "缺少认证token", nil)
            c.Abort()
            return
        }
        
        // 2. 检查token是否在黑名单中
        isBlacklisted, err := jwtService.IsBlacklisted(token)
        if err != nil {
            response.InternalServerError(c, "验证token失败", err)
            c.Abort()
            return
        }
        if isBlacklisted {
            response.Unauthorized(c, "token已失效", nil)
            c.Abort()
            return
        }
        
        // 3. 验证token
        claims, err := jwtService.ValidateToken(token)
        if err != nil {
            response.Unauthorized(c, "token无效或已过期", err)
            c.Abort()
            return
        }
        
        // 4. 将用户信息存储到上下文中
        c.Set(string(UserIDKey), claims.UserID)
        c.Set(string(UsernameKey), claims.Username)
        if claims.RoleID != nil {
            c.Set(string(RoleIDKey), *claims.RoleID)
        }
        
        // 5. 继续处理请求
        c.Next()
    }
}
```

### 3. 实现Token提取函数

```go
// extractTokenFromHeader 从请求头提取JWT token
// 支持格式：Authorization: Bearer {token}
func extractTokenFromHeader(c *gin.Context) string {
    authHeader := c.GetHeader("Authorization")
    if authHeader == "" {
        return ""
    }
    
    // 检查Bearer前缀
    const bearerPrefix = "Bearer "
    if !strings.HasPrefix(authHeader, bearerPrefix) {
        return ""
    }
    
    // 提取token
    token := strings.TrimPrefix(authHeader, bearerPrefix)
    token = strings.TrimSpace(token)
    if token == "" {
        return ""
    }
    
    return token
}
```

### 4. 创建获取用户信息的辅助函数

```go
// GetUserID 从上下文获取用户ID
func GetUserID(c *gin.Context) (int64, bool) {
    userID, exists := c.Get(string(UserIDKey))
    if !exists {
        return 0, false
    }
    
    id, ok := userID.(int64)
    if !ok {
        return 0, false
    }
    
    return id, true
}

// GetUsername 从上下文获取用户名
func GetUsername(c *gin.Context) (string, bool) {
    username, exists := c.Get(string(UsernameKey))
    if !exists {
        return "", false
    }
    
    name, ok := username.(string)
    if !ok {
        return "", false
    }
    
    return name, true
}

// GetRoleID 从上下文获取角色ID
func GetRoleID(c *gin.Context) (*int64, bool) {
    roleID, exists := c.Get(string(RoleIDKey))
    if !exists {
        return nil, false
    }
    
    id, ok := roleID.(int64)
    if !ok {
        return nil, false
    }
    
    idPtr := &id
    return idPtr, true
}
```

### 5. 添加必要的导入

```go
package middleware

import (
    "strings"
    
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/service"
    "yourproject/pkg/response"
)
```

### 6. 注意事项

- **Token提取**：从Authorization请求头提取Bearer token
- **Token格式**：支持标准格式 `Authorization: Bearer {token}`
- **黑名单检查**：在验证token前，先检查token是否在黑名单中
- **Token验证**：使用JWTService.ValidateToken验证token
- **上下文存储**：将用户ID、用户名、角色ID存储到Gin上下文中
- **错误处理**：token缺失、无效或过期时返回401 Unauthorized
- **中间件调用**：使用c.Abort()中止请求处理，使用c.Next()继续处理请求
- **安全性**：所有错误消息使用通用消息，避免泄露系统信息

## 验收标准

1. **中间件函数创建**
   - JWTAuthMiddleware函数创建正确
   - 函数签名正确（返回gin.HandlerFunc）
   - 函数接受JWTService作为参数

2. **Token提取**
   - 正确从Authorization请求头提取token
   - 支持Bearer格式
   - 处理token缺失或格式错误的情况

3. **Token验证**
   - 正确调用JWTService.IsBlacklisted检查黑名单
   - 正确调用JWTService.ValidateToken验证token
   - 错误处理正确

4. **上下文存储**
   - 正确将用户ID存储到上下文
   - 正确将用户名存储到上下文
   - 正确将角色ID存储到上下文（如果存在）
   - 辅助函数GetUserID、GetUsername、GetRoleID实现正确

5. **错误处理**
   - Token缺失时返回401 Unauthorized
   - Token无效或过期时返回401 Unauthorized
   - Token在黑名单中时返回401 Unauthorized
   - 错误消息使用中文
   - 错误格式符合API设计规范（Envelope格式）

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范
   - 注释完整，使用中文
   - 中间件使用c.Abort()和c.Next()正确处理请求流程

## 相关文件

- `internal/middleware/jwt_auth.go` - JWT认证中间件文件（待创建）
- `internal/service/jwt_service.go` - JWTService实现文件
- `pkg/response/response.go` - 响应格式化包
- `.cursor/rules/api-design.mdc` - API设计规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/security.mdc` - 安全开发规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:37:44 CST

