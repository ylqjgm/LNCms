# TASK005-14: 创建UserService接口和实现 - 基础CRUD

## 任务信息

**任务编号**: TASK005-14  
**父任务**: TASK005  
**任务名称**: 创建UserService接口和实现 - 基础CRUD  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:26:31 CST

## 任务描述

创建用户服务，提供用户管理的基础CRUD功能。包括：1) 定义UserService接口（GetUser、GetUsers、CreateUser、UpdateUser、DeleteUser方法）；2) 实现用户查询（单个用户、用户列表，支持分页和筛选）；3) 实现用户创建（管理员创建用户）；4) 实现用户更新；5) 实现用户删除。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK005-04（实现UserRepository接口和实现）、TASK005-07（创建PasswordService接口和实现）

## 实现指南

### 1. 定义UserService接口

在 `internal/service/` 目录下创建 `user_service.go` 文件，定义UserService接口：

```go
package service

import (
    "context"
    "yourproject/internal/dto"
)

// UserService 用户服务接口
// 提供用户管理的CRUD功能
type UserService interface {
    // GetUser 根据ID获取用户
    GetUser(ctx context.Context, userID int64) (*dto.UserInfo, error)
    
    // GetUsers 获取用户列表，支持分页和筛选
    GetUsers(ctx context.Context, params *dto.UserQueryParams) (*dto.UserListResponse, error)
    
    // CreateUser 创建用户（管理员操作）
    CreateUser(ctx context.Context, req *dto.CreateUserRequest) (*dto.UserInfo, error)
    
    // UpdateUser 更新用户信息
    UpdateUser(ctx context.Context, userID int64, req *dto.UpdateUserRequest) (*dto.UserInfo, error)
    
    // DeleteUser 删除用户
    DeleteUser(ctx context.Context, userID int64) error
}
```

### 2. 定义DTO结构

在 `internal/dto/` 目录下创建或扩展 `user_dto.go` 文件：

```go
package dto

import (
    "time"
)

// UserQueryParams 用户查询参数
type UserQueryParams struct {
    Page        int     `form:"page"`         // 页码，从1开始
    Limit       int     `form:"limit"`        // 每页数量
    Username    string  `form:"username"`     // 用户名筛选（模糊匹配）
    Email       string  `form:"email"`        // 邮箱筛选（模糊匹配）
    Phone       string  `form:"phone"`        // 手机号筛选（模糊匹配）
    IsActive    *bool   `form:"is_active"`    // 激活状态筛选
    IsLocked    *bool   `form:"is_locked"`    // 锁定状态筛选
    RoleID      *int64  `form:"role_id"`      // 角色ID筛选
    UserGroupID *int64  `form:"user_group_id"` // 用户组ID筛选
    LevelID     *int64  `form:"level_id"`     // 等级ID筛选
    SortBy      string  `form:"sort_by"`      // 排序字段
    SortOrder   string  `form:"sort_order"`   // 排序方向：asc、desc
}

// UserListResponse 用户列表响应
type UserListResponse struct {
    Users      []*UserInfo `json:"users"`       // 用户列表
    Total      int64       `json:"total"`      // 总记录数
    Page       int         `json:"page"`        // 当前页码
    Limit      int         `json:"limit"`       // 每页数量
    TotalPages int         `json:"total_pages"` // 总页数
}

// CreateUserRequest 创建用户请求
type CreateUserRequest struct {
    Username      string  `json:"username" binding:"required,min=3,max=50"`
    Email         string  `json:"email" binding:"required,email"`
    Phone         *string `json:"phone,omitempty"`
    Password      string  `json:"password" binding:"required,min=8"`
    EmailVerified bool    `json:"email_verified,omitempty"`
    PhoneVerified bool    `json:"phone_verified,omitempty"`
    IsActive      bool    `json:"is_active,omitempty"`
    IsLocked      bool    `json:"is_locked,omitempty"`
    RoleID        *int64  `json:"role_id,omitempty"`
    UserGroupID   *int64  `json:"user_group_id,omitempty"`
    LevelID       *int64  `json:"level_id,omitempty"`
}

// UpdateUserRequest 更新用户请求
type UpdateUserRequest struct {
    Username      *string `json:"username,omitempty"`
    Email         *string `json:"email,omitempty"`
    Phone         *string `json:"phone,omitempty"`
    EmailVerified *bool   `json:"email_verified,omitempty"`
    PhoneVerified *bool   `json:"phone_verified,omitempty"`
    IsActive      *bool   `json:"is_active,omitempty"`
    IsLocked      *bool   `json:"is_locked,omitempty"`
    RoleID        *int64  `json:"role_id,omitempty"`
    UserGroupID   *int64  `json:"user_group_id,omitempty"`
    LevelID       *int64  `json:"level_id,omitempty"`
}
```

### 3. 实现UserService接口

```go
package service

import (
    "context"
    "errors"
    "fmt"
    "math"
    
    "yourproject/internal/dto"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)

// userService UserService的实现
type userService struct {
    userRepo        repository.UserRepository
    passwordService PasswordService
}

// NewUserService 创建UserService实例
func NewUserService(
    userRepo repository.UserRepository,
    passwordService PasswordService,
) UserService {
    return &userService{
        userRepo:        userRepo,
        passwordService: passwordService,
    }
}

// GetUser 根据ID获取用户
func (s *userService) GetUser(ctx context.Context, userID int64) (*dto.UserInfo, error) {
    if userID <= 0 {
        return nil, errors.New("用户ID无效")
    }
    
    user, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return nil, fmt.Errorf("获取用户失败: %w", err)
    }
    
    return dto.ToUserInfo(user), nil
}

// GetUsers 获取用户列表，支持分页和筛选
func (s *userService) GetUsers(ctx context.Context, params *dto.UserQueryParams) (*dto.UserListResponse, error) {
    // 构建查询参数
    queryParams := &repository.UserQueryParams{
        Page:        params.Page,
        Limit:       params.Limit,
        Username:    params.Username,
        Email:       params.Email,
        Phone:       params.Phone,
        IsActive:    params.IsActive,
        IsLocked:    params.IsLocked,
        RoleID:      params.RoleID,
        UserGroupID: params.UserGroupID,
        LevelID:     params.LevelID,
        SortBy:      params.SortBy,
        SortOrder:   params.SortOrder,
    }
    
    // 查询用户列表
    users, total, err := s.userRepo.GetAll(ctx, queryParams)
    if err != nil {
        return nil, fmt.Errorf("查询用户列表失败: %w", err)
    }
    
    // 转换为DTO
    userInfos := make([]*dto.UserInfo, len(users))
    for i, user := range users {
        userInfos[i] = dto.ToUserInfo(user)
    }
    
    // 计算总页数
    page := params.Page
    if page < 1 {
        page = 1
    }
    limit := params.Limit
    if limit < 1 {
        limit = 20
    }
    totalPages := int(math.Ceil(float64(total) / float64(limit)))
    
    return &dto.UserListResponse{
        Users:      userInfos,
        Total:      total,
        Page:       page,
        Limit:      limit,
        TotalPages: totalPages,
    }, nil
}

// CreateUser 创建用户（管理员操作）
func (s *userService) CreateUser(ctx context.Context, req *dto.CreateUserRequest) (*dto.UserInfo, error) {
    // 1. 验证输入参数
    if err := s.validateCreateUserRequest(req); err != nil {
        return nil, err
    }
    
    // 2. 验证用户名唯一性
    exists, err := s.userRepo.ExistsByUsername(ctx, req.Username)
    if err != nil {
        return nil, fmt.Errorf("验证用户名失败: %w", err)
    }
    if exists {
        return nil, errors.New("用户名已被使用")
    }
    
    // 3. 验证邮箱唯一性
    exists, err = s.userRepo.ExistsByEmail(ctx, req.Email)
    if err != nil {
        return nil, fmt.Errorf("验证邮箱失败: %w", err)
    }
    if exists {
        return nil, errors.New("邮箱已被使用")
    }
    
    // 4. 验证手机号唯一性（如果提供）
    if req.Phone != nil && *req.Phone != "" {
        exists, err = s.userRepo.ExistsByPhone(ctx, *req.Phone)
        if err != nil {
            return nil, fmt.Errorf("验证手机号失败: %w", err)
        }
        if exists {
            return nil, errors.New("手机号已被使用")
        }
    }
    
    // 5. 验证密码强度
    if err := s.passwordService.ValidatePasswordStrength(req.Password); err != nil {
        return nil, fmt.Errorf("密码强度不符合要求: %w", err)
    }
    
    // 6. 哈希密码
    passwordHash, err := s.passwordService.HashPassword(req.Password)
    if err != nil {
        return nil, fmt.Errorf("密码加密失败: %w", err)
    }
    
    // 7. 创建用户
    user := &models.User{
        Username:      req.Username,
        Email:         req.Email,
        Phone:         req.Phone,
        PasswordHash:  passwordHash,
        EmailVerified: req.EmailVerified,
        PhoneVerified: req.PhoneVerified,
        IsActive:      req.IsActive,
        IsLocked:      req.IsLocked,
        RoleID:        req.RoleID,
        UserGroupID:   req.UserGroupID,
        LevelID:       req.LevelID,
    }
    
    if err := s.userRepo.Create(ctx, user); err != nil {
        return nil, fmt.Errorf("创建用户失败: %w", err)
    }
    
    return dto.ToUserInfo(user), nil
}

// UpdateUser 更新用户信息
func (s *userService) UpdateUser(ctx context.Context, userID int64, req *dto.UpdateUserRequest) (*dto.UserInfo, error) {
    if userID <= 0 {
        return nil, errors.New("用户ID无效")
    }
    
    // 1. 获取现有用户
    user, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return nil, fmt.Errorf("用户不存在: %w", err)
    }
    
    // 2. 更新字段（只更新提供的字段）
    if req.Username != nil {
        // 验证用户名唯一性（如果更改）
        if *req.Username != user.Username {
            exists, err := s.userRepo.ExistsByUsername(ctx, *req.Username)
            if err != nil {
                return nil, fmt.Errorf("验证用户名失败: %w", err)
            }
            if exists {
                return nil, errors.New("用户名已被使用")
            }
        }
        user.Username = *req.Username
    }
    
    if req.Email != nil {
        // 验证邮箱唯一性（如果更改）
        if *req.Email != user.Email {
            exists, err := s.userRepo.ExistsByEmail(ctx, *req.Email)
            if err != nil {
                return nil, fmt.Errorf("验证邮箱失败: %w", err)
            }
            if exists {
                return nil, errors.New("邮箱已被使用")
            }
        }
        user.Email = *req.Email
    }
    
    if req.Phone != nil {
        // 验证手机号唯一性（如果更改）
        if *req.Phone != user.Phone {
            if *req.Phone != "" {
                exists, err := s.userRepo.ExistsByPhone(ctx, *req.Phone)
                if err != nil {
                    return nil, fmt.Errorf("验证手机号失败: %w", err)
                }
                if exists {
                    return nil, errors.New("手机号已被使用")
                }
            }
        }
        user.Phone = req.Phone
    }
    
    if req.EmailVerified != nil {
        user.EmailVerified = *req.EmailVerified
    }
    
    if req.PhoneVerified != nil {
        user.PhoneVerified = *req.PhoneVerified
    }
    
    if req.IsActive != nil {
        user.IsActive = *req.IsActive
    }
    
    if req.IsLocked != nil {
        user.IsLocked = *req.IsLocked
    }
    
    if req.RoleID != nil {
        user.RoleID = req.RoleID
    }
    
    if req.UserGroupID != nil {
        user.UserGroupID = req.UserGroupID
    }
    
    if req.LevelID != nil {
        user.LevelID = req.LevelID
    }
    
    // 3. 保存更新
    if err := s.userRepo.Update(ctx, user); err != nil {
        return nil, fmt.Errorf("更新用户失败: %w", err)
    }
    
    return dto.ToUserInfo(user), nil
}

// DeleteUser 删除用户
func (s *userService) DeleteUser(ctx context.Context, userID int64) error {
    if userID <= 0 {
        return errors.New("用户ID无效")
    }
    
    // 检查用户是否存在
    _, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return fmt.Errorf("用户不存在: %w", err)
    }
    
    // 删除用户
    if err := s.userRepo.Delete(ctx, userID); err != nil {
        return fmt.Errorf("删除用户失败: %w", err)
    }
    
    return nil
}

// validateCreateUserRequest 验证创建用户请求（辅助方法）
func (s *userService) validateCreateUserRequest(req *dto.CreateUserRequest) error {
    if req.Username == "" {
        return errors.New("用户名不能为空")
    }
    if len(req.Username) < 3 || len(req.Username) > 50 {
        return errors.New("用户名长度必须在3-50个字符之间")
    }
    
    if req.Email == "" {
        return errors.New("邮箱不能为空")
    }
    
    if req.Password == "" {
        return errors.New("密码不能为空")
    }
    
    return nil
}
```

### 4. 添加必要的导入

```go
package service

import (
    "context"
    "errors"
    "fmt"
    "math"
    
    "yourproject/internal/dto"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 5. 注意事项

- **参数验证**：所有输入参数都要进行验证
- **唯一性验证**：创建和更新时验证用户名、邮箱、手机号的唯一性
- **密码处理**：创建用户时验证密码强度并哈希密码
- **分页计算**：正确计算总页数
- **错误处理**：所有错误消息使用中文，清晰描述问题
- **部分更新**：UpdateUser方法支持部分更新，只更新提供的字段

## 验收标准

1. **接口定义完整**
   - UserService接口包含所有必需方法
   - 方法签名正确，参数和返回值类型正确

2. **查询功能完整**
   - GetUser方法正确实现
   - GetUsers方法支持分页、筛选、排序
   - 分页计算正确

3. **创建功能完整**
   - CreateUser方法正确实现
   - 验证用户名、邮箱、手机号唯一性
   - 验证密码强度
   - 正确创建用户

4. **更新功能完整**
   - UpdateUser方法正确实现
   - 支持部分更新
   - 验证唯一性（如果更改）

5. **删除功能完整**
   - DeleteUser方法正确实现
   - 删除前检查用户是否存在

6. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文

7. **代码规范**
   - 遵循Golang编码规范
   - 注释完整，使用中文

## 相关文件

- `internal/repository/user_repository.go` - UserRepository实现文件
- `internal/service/password_service.go` - PasswordService实现文件
- `internal/dto/user_dto.go` - 用户相关DTO文件（待创建或扩展）
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/user_service.go` - UserService接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:26:31 CST

