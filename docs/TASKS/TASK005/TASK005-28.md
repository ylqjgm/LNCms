# TASK005-28: 配置用户管理API路由

## 任务信息

**任务编号**: TASK005-28  
**父任务**: TASK005  
**任务名称**: 配置用户管理API路由  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:37:44 CST

## 任务描述

配置用户管理的API路由。包括：1) 在路由配置文件中定义用户管理路由；2) 配置公开路由（注册、登录）；3) 配置需要认证的路由（登出、用户信息查询等）；4) 配置需要管理员权限的路由（用户管理操作）；5) 配置JWT认证中间件和权限中间件（如果TASK004完成）。所有路由必须遵循OpenAPI 3.1.1规范，路径使用/api/v1/users前缀。

## 依赖任务

TASK005-26（创建UserHandler接口和实现 - 用户删除API）、TASK005-27（创建JWT认证中间件）、TASK004（权限管理系统，可选，如果完成则使用权限中间件）

## 实现指南

### 1. 创建路由配置文件

在 `internal/router/` 或 `internal/http/` 目录下创建或修改路由配置文件（如 `routes.go` 或 `user_routes.go`）：

```go
package router

import (
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/handler"
    "yourproject/internal/middleware"
    "yourproject/internal/service"
)

// SetupUserRoutes 配置用户管理路由
func SetupUserRoutes(router *gin.RouterGroup, userHandler handler.UserHandler, jwtService service.JWTService) {
    // 创建用户路由组
    userGroup := router.Group("/users")
    
    // 公开路由（不需要认证）
    userGroup.POST("/register", userHandler.Register)  // 用户注册
    userGroup.POST("/login", userHandler.Login)        // 用户登录
    
    // 需要认证的路由
    authRoutes := userGroup.Group("")
    authRoutes.Use(middleware.JWTAuthMiddleware(jwtService))
    {
        authRoutes.POST("/logout", userHandler.Logout)           // 用户登出
        authRoutes.GET("", userHandler.GetUsers)                 // 获取用户列表
        authRoutes.GET("/:id", userHandler.GetUser)              // 获取用户详情
    }
    
    // 需要管理员权限的路由（如果TASK004完成，使用权限中间件）
    adminRoutes := userGroup.Group("")
    adminRoutes.Use(middleware.JWTAuthMiddleware(jwtService))
    // 如果TASK004完成，添加权限中间件
    // adminRoutes.Use(middleware.RequirePermission("user:manage"))
    {
        adminRoutes.POST("", userHandler.CreateUser)                    // 创建用户
        adminRoutes.PUT("/:id", userHandler.UpdateUser)                 // 更新用户
        adminRoutes.PUT("/:id/status", userHandler.UpdateUserStatus)    // 更新用户状态
        adminRoutes.PUT("/:id/ban", userHandler.BanUser)                // 封禁用户
        adminRoutes.PUT("/:id/unban", userHandler.UnbanUser)            // 解封用户
        adminRoutes.PUT("/:id/approve", userHandler.ApproveUser)        // 审核通过用户
        adminRoutes.PUT("/:id/reject", userHandler.RejectUser)          // 审核拒绝用户
        adminRoutes.PUT("/:id/password", userHandler.ResetPassword)     // 重置用户密码
        adminRoutes.DELETE("/:id", userHandler.DeleteUser)              // 删除用户
    }
}
```

### 2. 在主路由中注册用户路由

在主路由文件（如 `router.go` 或 `main.go`）中注册用户路由：

```go
package router

import (
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/handler"
    "yourproject/internal/service"
)

// SetupRoutes 配置所有路由
func SetupRoutes(router *gin.Engine, userHandler handler.UserHandler, jwtService service.JWTService) {
    // API v1 路由组
    apiV1 := router.Group("/api/v1")
    
    // 配置用户管理路由
    SetupUserRoutes(apiV1, userHandler, jwtService)
    
    // 其他模块路由...
    // SetupArticleRoutes(apiV1, articleHandler, jwtService)
    // SetupCategoryRoutes(apiV1, categoryHandler, jwtService)
}
```

### 3. 路由路径规范

所有用户管理路由遵循以下规范：

- **基础路径**：`/api/v1/users`
- **公开路由**（不需要认证）：
  - `POST /api/v1/users/register` - 用户注册
  - `POST /api/v1/users/login` - 用户登录
- **认证路由**（需要JWT认证）：
  - `POST /api/v1/users/logout` - 用户登出
  - `GET /api/v1/users` - 获取用户列表
  - `GET /api/v1/users/:id` - 获取用户详情
- **管理员路由**（需要JWT认证和管理员权限）：
  - `POST /api/v1/users` - 创建用户
  - `PUT /api/v1/users/:id` - 更新用户
  - `PUT /api/v1/users/:id/status` - 更新用户状态
  - `PUT /api/v1/users/:id/ban` - 封禁用户
  - `PUT /api/v1/users/:id/unban` - 解封用户
  - `PUT /api/v1/users/:id/approve` - 审核通过用户
  - `PUT /api/v1/users/:id/reject` - 审核拒绝用户
  - `PUT /api/v1/users/:id/password` - 重置用户密码
  - `DELETE /api/v1/users/:id` - 删除用户

### 4. 中间件配置

#### JWT认证中间件

所有需要认证的路由使用JWT认证中间件：

```go
authRoutes.Use(middleware.JWTAuthMiddleware(jwtService))
```

#### 权限中间件（可选，如果TASK004完成）

如果TASK004权限管理系统已完成，可以使用权限中间件：

```go
adminRoutes.Use(middleware.RequirePermission("user:manage"))
```

### 5. 路由分组示例（完整版）

如果使用更细粒度的路由分组：

```go
// SetupUserRoutes 配置用户管理路由
func SetupUserRoutes(router *gin.RouterGroup, userHandler handler.UserHandler, jwtService service.JWTService) {
    // 创建用户路由组
    userGroup := router.Group("/users")
    
    // 公开路由（不需要认证）
    public := userGroup.Group("")
    {
        public.POST("/register", userHandler.Register)  // 用户注册
        public.POST("/login", userHandler.Login)        // 用户登录
    }
    
    // 需要认证的路由
    auth := userGroup.Group("")
    auth.Use(middleware.JWTAuthMiddleware(jwtService))
    {
        auth.POST("/logout", userHandler.Logout)           // 用户登出
        auth.GET("", userHandler.GetUsers)                 // 获取用户列表
        auth.GET("/:id", userHandler.GetUser)              // 获取用户详情
    }
    
    // 需要管理员权限的路由
    admin := userGroup.Group("")
    admin.Use(middleware.JWTAuthMiddleware(jwtService))
    // 如果TASK004完成，添加权限中间件
    // admin.Use(middleware.RequirePermission("user:manage"))
    // 或者使用角色中间件
    // admin.Use(middleware.RequireRole("admin"))
    {
        admin.POST("", userHandler.CreateUser)                    // 创建用户
        admin.PUT("/:id", userHandler.UpdateUser)                 // 更新用户
        admin.PUT("/:id/status", userHandler.UpdateUserStatus)    // 更新用户状态
        admin.PUT("/:id/ban", userHandler.BanUser)                // 封禁用户
        admin.PUT("/:id/unban", userHandler.UnbanUser)            // 解封用户
        admin.PUT("/:id/approve", userHandler.ApproveUser)        // 审核通过用户
        admin.PUT("/:id/reject", userHandler.RejectUser)          // 审核拒绝用户
        admin.PUT("/:id/password", userHandler.ResetPassword)     // 重置用户密码
        admin.DELETE("/:id", userHandler.DeleteUser)              // 删除用户
    }
}
```

### 6. 注意事项

- **路由前缀**：所有路由使用 `/api/v1/users` 前缀，遵循OpenAPI 3.1.1规范
- **HTTP方法**：使用标准HTTP方法（GET、POST、PUT、DELETE），遵循RESTful规范
- **路由分组**：按照权限需求进行路由分组（公开、认证、管理员）
- **中间件顺序**：JWT认证中间件必须在权限中间件之前
- **路径参数**：使用 `:id` 定义路径参数
- **路由顺序**：具体路由（如 `/:id/status`）应该在通用路由（如 `/:id`）之前定义（如果框架支持）
- **权限控制**：如果TASK004完成，使用权限中间件；否则仅使用JWT认证中间件
- **代码组织**：路由配置应该清晰、易于维护

## 验收标准

1. **路由配置完整**
   - 所有用户管理路由都已配置
   - 路由路径正确
   - HTTP方法正确

2. **路由分组正确**
   - 公开路由分组正确（注册、登录）
   - 认证路由分组正确（登出、查询）
   - 管理员路由分组正确（管理操作）

3. **中间件配置**
   - JWT认证中间件正确应用到需要认证的路由
   - 权限中间件正确应用到需要管理员权限的路由（如果TASK004完成）
   - 中间件顺序正确

4. **路由规范**
   - 路由路径遵循OpenAPI 3.1.1规范
   - 路由路径使用 `/api/v1/users` 前缀
   - HTTP方法遵循RESTful规范

5. **代码组织**
   - 路由配置代码清晰、易读
   - 路由分组合理
   - 注释完整，使用中文

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范
   - 代码结构清晰

## 相关文件

- `internal/router/routes.go` 或 `internal/router/user_routes.go` - 路由配置文件（待创建或修改）
- `internal/middleware/jwt_auth.go` - JWT认证中间件文件
- `internal/middleware/permission.go` - 权限中间件文件（如果TASK004完成）
- `internal/handler/user_handler.go` - UserHandler实现文件
- `.cursor/rules/api-design.mdc` - API设计规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:37:44 CST

