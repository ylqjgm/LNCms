# TASK005-08: 编写PasswordService单元测试

## 任务信息

**任务编号**: TASK005-08  
**父任务**: TASK005  
**任务名称**: 编写PasswordService单元测试  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:06:59 CST

## 任务描述

编写密码服务单元测试。包括：1) 测试密码哈希和验证功能；2) 测试密码强度验证功能；3) 测试各种密码规则（长度、字符类型等）；4) 确保测试覆盖率达标。所有测试用例描述必须使用中文。

## 依赖任务

TASK005-07（创建PasswordService接口和实现）

## 实现指南

### 1. 创建测试文件

在 `internal/service/` 目录下创建 `password_service_test.go` 文件：

```go
package service

import (
    "testing"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
)
```

### 2. 测试HashPassword方法

```go
// TestPasswordService_HashPassword 测试密码哈希
func TestPasswordService_HashPassword(t *testing.T) {
    service := NewPasswordService(nil)
    
    tests := []struct {
        name    string
        password string
        wantErr bool
    }{
        {
            name:     "哈希有效密码",
            password: "TestPassword123!",
            wantErr:  false,
        },
        {
            name:     "哈希空密码",
            password: "",
            wantErr:  true,
        },
        {
            name:     "哈希长密码",
            password: "VeryLongPassword123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890!",
            wantErr:  false,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            hash, err := service.HashPassword(tt.password)
            if tt.wantErr {
                require.Error(t, err, "期望返回错误")
                assert.Empty(t, hash, "哈希值应该为空")
            } else {
                require.NoError(t, err, "密码哈希失败")
                assert.NotEmpty(t, hash, "哈希值不应该为空")
                assert.NotEqual(t, tt.password, hash, "哈希值不应该等于原始密码")
                assert.True(t, len(hash) > 50, "bcrypt哈希值应该足够长")
            }
        })
    }
}

// TestPasswordService_HashPassword_Uniqueness 测试哈希唯一性
func TestPasswordService_HashPassword_Uniqueness(t *testing.T) {
    service := NewPasswordService(nil)
    password := "TestPassword123!"
    
    // 多次哈希同一密码，应该得到不同的哈希值（因为bcrypt使用随机盐）
    hash1, err1 := service.HashPassword(password)
    require.NoError(t, err1, "第一次哈希失败")
    
    hash2, err2 := service.HashPassword(password)
    require.NoError(t, err2, "第二次哈希失败")
    
    // 哈希值应该不同（因为使用了随机盐）
    assert.NotEqual(t, hash1, hash2, "两次哈希应该得到不同的结果")
    
    // 但都能验证原始密码
    assert.True(t, service.VerifyPassword(hash1, password), "第一次哈希应该能验证原始密码")
    assert.True(t, service.VerifyPassword(hash2, password), "第二次哈希应该能验证原始密码")
}
```

### 3. 测试VerifyPassword方法

```go
// TestPasswordService_VerifyPassword 测试密码验证
func TestPasswordService_VerifyPassword(t *testing.T) {
    service := NewPasswordService(nil)
    password := "TestPassword123!"
    
    // 生成哈希
    hash, err := service.HashPassword(password)
    require.NoError(t, err, "生成密码哈希失败")
    
    tests := []struct {
        name          string
        hashedPassword string
        password      string
        want          bool
    }{
        {
            name:          "验证正确密码",
            hashedPassword: hash,
            password:      password,
            want:          true,
        },
        {
            name:          "验证错误密码",
            hashedPassword: hash,
            password:      "WrongPassword123!",
            want:          false,
        },
        {
            name:          "验证空密码",
            hashedPassword: hash,
            password:      "",
            want:          false,
        },
        {
            name:          "验证空哈希",
            hashedPassword: "",
            password:      password,
            want:          false,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            got := service.VerifyPassword(tt.hashedPassword, tt.password)
            assert.Equal(t, tt.want, got, "密码验证结果不匹配")
        })
    }
}
```

### 4. 测试ValidatePasswordStrength方法

```go
// TestPasswordService_ValidatePasswordStrength 测试密码强度验证
func TestPasswordService_ValidatePasswordStrength(t *testing.T) {
    defaultConfig := DefaultPasswordStrengthConfig()
    service := NewPasswordService(defaultConfig)
    
    tests := []struct {
        name    string
        password string
        wantErr bool
        errMsg  string
    }{
        {
            name:    "有效密码",
            password: "TestPassword123!",
            wantErr: false,
        },
        {
            name:    "密码过短",
            password: "Short1!",
            wantErr: true,
            errMsg:  "密码长度不能少于",
        },
        {
            name:    "密码过长",
            password: strings.Repeat("A", 129) + "1!",
            wantErr: true,
            errMsg:  "密码长度不能超过",
        },
        {
            name:    "缺少大写字母",
            password: "testpassword123!",
            wantErr: true,
            errMsg:  "密码必须包含大写字母",
        },
        {
            name:    "缺少小写字母",
            password: "TESTPASSWORD123!",
            wantErr: true,
            errMsg:  "密码必须包含小写字母",
        },
        {
            name:    "缺少数字",
            password: "TestPassword!",
            wantErr: true,
            errMsg:  "密码必须包含数字",
        },
        {
            name:    "缺少特殊字符",
            password: "TestPassword123",
            wantErr: true,
            errMsg:  "密码必须包含特殊字符",
        },
        {
            name:    "空密码",
            password: "",
            wantErr: true,
            errMsg:  "密码不能为空",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := service.ValidatePasswordStrength(tt.password)
            if tt.wantErr {
                require.Error(t, err, "期望返回错误")
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg, "错误消息不匹配")
                }
            } else {
                require.NoError(t, err, "密码强度验证失败")
            }
        })
    }
}

// TestPasswordService_ValidatePasswordStrength_CustomConfig 测试自定义配置
func TestPasswordService_ValidatePasswordStrength_CustomConfig(t *testing.T) {
    customConfig := &PasswordStrengthConfig{
        MinLength:      6,
        MaxLength:      20,
        RequireUpper:   false,
        RequireLower:   true,
        RequireNumber:  false,
        RequireSpecial: false,
    }
    service := NewPasswordService(customConfig)
    
    tests := []struct {
        name    string
        password string
        wantErr bool
    }{
        {
            name:    "满足自定义要求（仅小写字母）",
            password: "simplepassword",
            wantErr: false,
        },
        {
            name:    "密码过短（小于6）",
            password: "short",
            wantErr: true,
        },
        {
            name:    "密码过长（大于20）",
            password: "verylongpassword123456",
            wantErr: true,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := service.ValidatePasswordStrength(tt.password)
            if tt.wantErr {
                require.Error(t, err, "期望返回错误")
            } else {
                require.NoError(t, err, "密码强度验证失败")
            }
        })
    }
}
```

### 5. 测试GenerateRandomPassword方法

```go
// TestPasswordService_GenerateRandomPassword 测试生成随机密码
func TestPasswordService_GenerateRandomPassword(t *testing.T) {
    defaultConfig := DefaultPasswordStrengthConfig()
    service := NewPasswordService(defaultConfig)
    
    tests := []struct {
        name   string
        length int
    }{
        {
            name:   "生成默认长度密码",
            length: 0, // 使用默认长度
        },
        {
            name:   "生成指定长度密码",
            length: 12,
        },
        {
            name:   "生成长密码",
            length: 20,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            password, err := service.GenerateRandomPassword(tt.length)
            require.NoError(t, err, "生成随机密码失败")
            assert.NotEmpty(t, password, "生成的密码不应该为空")
            
            // 验证密码强度
            err = service.ValidatePasswordStrength(password)
            assert.NoError(t, err, "生成的密码应该满足强度要求")
            
            // 验证密码长度
            if tt.length > 0 {
                assert.Equal(t, tt.length, len(password), "密码长度不匹配")
            } else {
                assert.GreaterOrEqual(t, len(password), defaultConfig.MinLength, "密码长度应该满足最小要求")
            }
        })
    }
}

// TestPasswordService_GenerateRandomPassword_Uniqueness 测试随机密码唯一性
func TestPasswordService_GenerateRandomPassword_Uniqueness(t *testing.T) {
    service := NewPasswordService(nil)
    
    // 生成多个随机密码，应该都不同
    passwords := make(map[string]bool)
    for i := 0; i < 10; i++ {
        password, err := service.GenerateRandomPassword(12)
        require.NoError(t, err, "生成随机密码失败")
        
        // 检查是否重复
        assert.False(t, passwords[password], "生成的密码不应该重复")
        passwords[password] = true
    }
}
```

### 6. 集成测试

```go
// TestPasswordService_Integration 测试密码服务集成
func TestPasswordService_Integration(t *testing.T) {
    service := NewPasswordService(nil)
    password := "TestPassword123!"
    
    // 1. 验证密码强度
    err := service.ValidatePasswordStrength(password)
    require.NoError(t, err, "密码强度验证失败")
    
    // 2. 哈希密码
    hash, err := service.HashPassword(password)
    require.NoError(t, err, "密码哈希失败")
    
    // 3. 验证密码
    isValid := service.VerifyPassword(hash, password)
    assert.True(t, isValid, "密码验证应该成功")
    
    // 4. 验证错误密码
    isValid = service.VerifyPassword(hash, "WrongPassword123!")
    assert.False(t, isValid, "错误密码验证应该失败")
}
```

### 7. 基准测试

```go
// BenchmarkPasswordService_HashPassword 基准测试密码哈希
func BenchmarkPasswordService_HashPassword(b *testing.B) {
    service := NewPasswordService(nil)
    password := "TestPassword123!"
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        _, _ = service.HashPassword(password)
    }
}

// BenchmarkPasswordService_VerifyPassword 基准测试密码验证
func BenchmarkPasswordService_VerifyPassword(b *testing.B) {
    service := NewPasswordService(nil)
    password := "TestPassword123!"
    hash, _ := service.HashPassword(password)
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        _ = service.VerifyPassword(hash, password)
    }
}
```

### 8. 注意事项

- **测试覆盖**：确保测试覆盖所有方法和各种情况
- **边界测试**：测试边界情况，如空值、最小值、最大值等
- **错误测试**：测试各种错误情况，确保错误处理正确
- **集成测试**：测试多个方法的组合使用
- **基准测试**：为性能关键的方法编写基准测试
- **中文描述**：所有测试用例名称使用中文

## 验收标准

1. **测试覆盖完整**
   - 所有PasswordService方法都有对应的测试
   - 测试覆盖正常情况、边界情况和异常情况
   - 测试覆盖率达标

2. **测试质量**
   - 测试用例独立，不依赖执行顺序
   - 测试用例名称清晰，使用中文
   - 测试逻辑正确

3. **测试工具使用**
   - 使用testify/assert和testify/require进行断言
   - 使用表驱动测试处理多个测试场景

4. **代码规范**
   - 遵循Golang编码规范
   - 遵循单元测试规范
   - 测试用例描述使用中文

## 相关文件

- `internal/service/password_service.go` - PasswordService实现文件
- `.cursor/rules/testing.mdc` - Golang单元测试规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/service/password_service_test.go` - PasswordService测试文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:06:59 CST

