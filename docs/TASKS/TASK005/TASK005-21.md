# TASK005-21: 创建UserHandler接口和实现 - 用户列表和详情API

## 任务信息

**任务编号**: TASK005-21  
**父任务**: TASK005  
**任务名称**: 创建UserHandler接口和实现 - 用户列表和详情API  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:37:44 CST

## 任务描述

扩展用户控制器，提供用户列表查询和详情查询的HTTP API处理。包括：1) 扩展UserHandler接口（GetUsers、GetUser方法）；2) 实现GetUsers方法（处理GET /api/v1/users请求，支持分页、筛选、排序）；3) 实现GetUser方法（处理GET /api/v1/users/{id}请求）；4) 调用UserService；5) 格式化响应（Envelope格式）。所有代码必须遵循API设计规范。

## 依赖任务

TASK005-20（创建UserHandler接口和实现 - 用户登出API）、TASK005-14（创建UserService接口和实现 - 基础CRUD）

## 实现指南

### 1. 扩展UserHandler接口

在 `internal/handler/user_handler.go` 文件中，扩展UserHandler接口：

```go
// UserHandler 用户控制器接口
// 提供用户管理的HTTP API处理
type UserHandler interface {
    // Register 用户注册
    // POST /api/v1/users/register
    Register(c *gin.Context)
    
    // Login 用户登录
    // POST /api/v1/users/login
    Login(c *gin.Context)
    
    // Logout 用户登出
    // POST /api/v1/users/logout
    Logout(c *gin.Context)
    
    // GetUsers 获取用户列表
    // GET /api/v1/users
    GetUsers(c *gin.Context)
    
    // GetUser 获取用户详情
    // GET /api/v1/users/{id}
    GetUser(c *gin.Context)
}
```

### 2. 实现GetUsers方法

```go
// GetUsers 获取用户列表
// @Summary 获取用户列表
// @Description 获取用户列表，支持分页、筛选、排序
// @Tags 用户管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param page query int false "页码" default(1)
// @Param limit query int false "每页数量" default(20)
// @Param username query string false "用户名筛选"
// @Param email query string false "邮箱筛选"
// @Param is_active query bool false "激活状态筛选"
// @Param is_locked query bool false "锁定状态筛选"
// @Param sort query string false "排序字段" default(created_at)
// @Param order query string false "排序方向" Enums(asc, desc) default(desc)
// @Success 200 {object} response.Envelope{data=[]dto.UserResponse,pagination=response.Pagination}
// @Failure 400 {object} response.Envelope
// @Failure 401 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/users [get]
func (h *userHandler) GetUsers(c *gin.Context) {
    // 1. 绑定查询参数
    var params dto.GetUsersParams
    if err := c.ShouldBindQuery(&params); err != nil {
        response.BadRequest(c, "请求参数错误", err)
        return
    }
    
    // 2. 验证和设置默认值
    if params.Page < 1 {
        params.Page = 1
    }
    if params.Limit < 1 {
        params.Limit = 20
    }
    if params.Limit > 100 {
        params.Limit = 100
    }
    
    // 3. 调用UserService.GetUsers
    users, total, err := h.userService.GetUsers(c.Request.Context(), &params)
    if err != nil {
        response.InternalServerError(c, "获取用户列表失败", err)
        return
    }
    
    // 4. 转换为响应DTO
    var userResponses []dto.UserResponse
    for _, user := range users {
        userResponses = append(userResponses, dto.UserResponseFromModel(user))
    }
    
    // 5. 格式化响应（Envelope格式，带分页信息）
    response.OKWithPagination(c, userResponses, total, params.Page, params.Limit, "获取用户列表成功")
}
```

### 3. 实现GetUser方法

```go
// GetUser 获取用户详情
// @Summary 获取用户详情
// @Description 根据用户ID获取用户详细信息
// @Tags 用户管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "用户ID"
// @Success 200 {object} response.Envelope{data=dto.UserResponse}
// @Failure 400 {object} response.Envelope
// @Failure 401 {object} response.Envelope
// @Failure 404 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/users/{id} [get]
func (h *userHandler) GetUser(c *gin.Context) {
    // 1. 获取路径参数
    idStr := c.Param("id")
    id, err := strconv.ParseInt(idStr, 10, 64)
    if err != nil {
        response.BadRequest(c, "无效的用户ID", err)
        return
    }
    
    // 2. 调用UserService.GetUser
    user, err := h.userService.GetUser(c.Request.Context(), id)
    if err != nil {
        if isNotFoundError(err) {
            response.NotFound(c, "用户不存在", err)
            return
        }
        response.InternalServerError(c, "获取用户详情失败", err)
        return
    }
    
    // 3. 转换为响应DTO
    userResponse := dto.UserResponseFromModel(user)
    
    // 4. 格式化响应（Envelope格式）
    response.OK(c, userResponse, "获取用户详情成功")
}
```

### 4. 实现错误判断辅助函数

在 `internal/handler/user_handler.go` 文件中，添加错误判断函数：

```go
// isNotFoundError 判断是否为未找到错误
func isNotFoundError(err error) bool {
    errMsg := err.Error()
    return contains(errMsg, "用户不存在") ||
        contains(errMsg, "not found")
}

// contains 检查字符串是否包含子字符串（忽略大小写）
func contains(s, substr string) bool {
    return strings.Contains(strings.ToLower(s), strings.ToLower(substr))
}
```

### 5. 创建查询参数DTO

在 `internal/dto/user_dto.go` 文件中，创建查询参数结构：

```go
// GetUsersParams 获取用户列表查询参数
type GetUsersParams struct {
    Page     int    `form:"page" json:"page"`
    Limit    int    `form:"limit" json:"limit"`
    Username string `form:"username" json:"username"`
    Email    string `form:"email" json:"email"`
    IsActive *bool  `form:"is_active" json:"is_active,omitempty"`
    IsLocked *bool  `form:"is_locked" json:"is_locked,omitempty"`
    Sort     string `form:"sort" json:"sort"`
    Order    string `form:"order" json:"order"`
}
```

### 6. 添加必要的导入

```go
package handler

import (
    "strconv"
    "strings"
    
    "github.com/gin-gonic/gin"
    
    "yourproject/internal/dto"
    "yourproject/internal/service"
    "yourproject/pkg/response"
)
```

### 7. 注意事项

- **分页参数验证**：page最小值为1，limit范围为1-100，默认值分别为1和20
- **查询参数绑定**：使用ShouldBindQuery绑定查询参数
- **路径参数解析**：使用c.Param获取路径参数，并转换为int64类型
- **错误处理**：区分不同的错误类型（未找到、参数错误、服务器错误）
- **响应格式**：列表查询使用Envelope格式并包含分页信息，详情查询使用Envelope格式
- **权限控制**：需要认证，在路由配置中应用JWT认证中间件
- **数据转换**：将Model转换为DTO，隐藏敏感信息（如密码哈希）

## 验收标准

1. **接口扩展完整**
   - UserHandler接口包含GetUsers和GetUser方法
   - 方法签名正确

2. **查询参数处理**
   - 正确绑定查询参数
   - 验证和设置默认值
   - 支持分页、筛选、排序

3. **路径参数处理**
   - 正确获取和解析路径参数
   - 验证参数有效性

4. **服务调用**
   - 正确调用UserService.GetUsers和GetUser
   - 错误处理正确

5. **响应格式化**
   - 列表响应使用Envelope格式并包含分页信息
   - 详情响应使用Envelope格式
   - HTTP状态码正确（200 OK、404 Not Found）

6. **错误处理**
   - 参数错误时返回400 Bad Request
   - 用户不存在时返回404 Not Found
   - 认证失败时返回401 Unauthorized
   - 错误消息使用中文
   - 错误格式符合API设计规范

7. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范
   - 注释完整，使用中文

## 相关文件

- `internal/handler/user_handler.go` - UserHandler接口和实现文件
- `internal/service/user_service.go` - UserService实现文件
- `internal/dto/user_dto.go` - 用户DTO定义文件
- `pkg/response/response.go` - 响应格式化包
- `.cursor/rules/api-design.mdc` - API设计规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:37:44 CST

