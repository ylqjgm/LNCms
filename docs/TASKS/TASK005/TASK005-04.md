# TASK005-04: 实现UserRepository接口和实现

## 任务信息

**任务编号**: TASK005-04  
**父任务**: TASK005  
**任务名称**: 实现UserRepository接口和实现  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:06:59 CST

## 任务描述

实现UserRepository接口，提供用户数据的CRUD操作。包括：1) 定义UserRepository接口（Create、GetByID、GetByUsername、GetByEmail、GetAll、Update、Delete、UpdateStatus、UpdateLastLoginAt等方法）；2) 实现UserRepository接口（使用GORM进行数据库操作）；3) 实现条件查询方法（支持分页、筛选、排序）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK005-01（创建User模型）

## 实现指南

### 1. 定义UserRepository接口

在 `internal/repository/` 目录下创建 `user_repository.go` 文件，定义UserRepository接口：

```go
package repository

import (
    "context"
    "yourproject/internal/models"
)

// UserRepository 用户仓储接口
// 提供用户数据的CRUD操作和查询方法
type UserRepository interface {
    // Create 创建用户
    Create(ctx context.Context, user *models.User) error
    
    // GetByID 根据ID获取用户
    GetByID(ctx context.Context, id int64) (*models.User, error)
    
    // GetByUsername 根据用户名获取用户
    GetByUsername(ctx context.Context, username string) (*models.User, error)
    
    // GetByEmail 根据邮箱获取用户
    GetByEmail(ctx context.Context, email string) (*models.User, error)
    
    // GetByPhone 根据手机号获取用户
    GetByPhone(ctx context.Context, phone string) (*models.User, error)
    
    // GetAll 获取用户列表，支持分页、筛选、排序
    GetAll(ctx context.Context, params *UserQueryParams) ([]*models.User, int64, error)
    
    // Update 更新用户信息
    Update(ctx context.Context, user *models.User) error
    
    // Delete 删除用户（软删除或硬删除）
    Delete(ctx context.Context, id int64) error
    
    // UpdateStatus 更新用户状态
    UpdateStatus(ctx context.Context, id int64, isActive bool) error
    
    // UpdateLastLoginAt 更新最后登录时间
    UpdateLastLoginAt(ctx context.Context, id int64) error
    
    // ExistsByUsername 检查用户名是否存在
    ExistsByUsername(ctx context.Context, username string) (bool, error)
    
    // ExistsByEmail 检查邮箱是否存在
    ExistsByEmail(ctx context.Context, email string) (bool, error)
    
    // ExistsByPhone 检查手机号是否存在
    ExistsByPhone(ctx context.Context, phone string) (bool, error)
}

// UserQueryParams 用户查询参数
type UserQueryParams struct {
    Page      int    // 页码，从1开始
    Limit     int    // 每页数量
    Username  string // 用户名筛选（模糊匹配）
    Email     string // 邮箱筛选（模糊匹配）
    Phone     string // 手机号筛选（模糊匹配）
    IsActive  *bool  // 激活状态筛选
    IsLocked  *bool  // 锁定状态筛选
    RoleID    *int64 // 角色ID筛选
    UserGroupID *int64 // 用户组ID筛选
    LevelID   *int64 // 等级ID筛选
    SortBy    string // 排序字段
    SortOrder string // 排序方向：asc、desc
}
```

### 2. 实现UserRepository接口

在同一个文件中实现UserRepository接口：

```go
// userRepository UserRepository的实现
type userRepository struct {
    db *gorm.DB
}

// NewUserRepository 创建UserRepository实例
func NewUserRepository(db *gorm.DB) UserRepository {
    return &userRepository{db: db}
}

// Create 创建用户
func (r *userRepository) Create(ctx context.Context, user *models.User) error {
    if err := r.db.WithContext(ctx).Create(user).Error; err != nil {
        if errors.Is(err, gorm.ErrDuplicatedKey) {
            return fmt.Errorf("用户已存在：用户名或邮箱已被使用")
        }
        return fmt.Errorf("创建用户失败: %w", err)
    }
    return nil
}

// GetByID 根据ID获取用户
func (r *userRepository) GetByID(ctx context.Context, id int64) (*models.User, error) {
    var user models.User
    if err := r.db.WithContext(ctx).Where("id = ?", id).First(&user).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, fmt.Errorf("用户不存在")
        }
        return nil, fmt.Errorf("查询用户失败: %w", err)
    }
    return &user, nil
}

// GetByUsername 根据用户名获取用户
func (r *userRepository) GetByUsername(ctx context.Context, username string) (*models.User, error) {
    var user models.User
    if err := r.db.WithContext(ctx).Where("username = ?", username).First(&user).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, fmt.Errorf("用户不存在")
        }
        return nil, fmt.Errorf("查询用户失败: %w", err)
    }
    return &user, nil
}

// GetByEmail 根据邮箱获取用户
func (r *userRepository) GetByEmail(ctx context.Context, email string) (*models.User, error) {
    var user models.User
    if err := r.db.WithContext(ctx).Where("email = ?", email).First(&user).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, fmt.Errorf("用户不存在")
        }
        return nil, fmt.Errorf("查询用户失败: %w", err)
    }
    return &user, nil
}

// GetByPhone 根据手机号获取用户
func (r *userRepository) GetByPhone(ctx context.Context, phone string) (*models.User, error) {
    var user models.User
    if err := r.db.WithContext(ctx).Where("phone = ?", phone).First(&user).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, fmt.Errorf("用户不存在")
        }
        return nil, fmt.Errorf("查询用户失败: %w", err)
    }
    return &user, nil
}

// GetAll 获取用户列表，支持分页、筛选、排序
func (r *userRepository) GetAll(ctx context.Context, params *UserQueryParams) ([]*models.User, int64, error) {
    var users []*models.User
    var total int64
    
    query := r.db.WithContext(ctx).Model(&models.User{})
    
    // 应用筛选条件
    if params.Username != "" {
        query = query.Where("username LIKE ?", "%"+params.Username+"%")
    }
    if params.Email != "" {
        query = query.Where("email LIKE ?", "%"+params.Email+"%")
    }
    if params.Phone != "" {
        query = query.Where("phone LIKE ?", "%"+params.Phone+"%")
    }
    if params.IsActive != nil {
        query = query.Where("is_active = ?", *params.IsActive)
    }
    if params.IsLocked != nil {
        query = query.Where("is_locked = ?", *params.IsLocked)
    }
    if params.RoleID != nil {
        query = query.Where("role_id = ?", *params.RoleID)
    }
    if params.UserGroupID != nil {
        query = query.Where("user_group_id = ?", *params.UserGroupID)
    }
    if params.LevelID != nil {
        query = query.Where("level_id = ?", *params.LevelID)
    }
    
    // 统计总数
    if err := query.Count(&total).Error; err != nil {
        return nil, 0, fmt.Errorf("统计用户数量失败: %w", err)
    }
    
    // 应用排序
    sortBy := params.SortBy
    if sortBy == "" {
        sortBy = "created_at"
    }
    sortOrder := params.SortOrder
    if sortOrder == "" || (sortOrder != "asc" && sortOrder != "desc") {
        sortOrder = "desc"
    }
    query = query.Order(sortBy + " " + sortOrder)
    
    // 应用分页
    page := params.Page
    if page < 1 {
        page = 1
    }
    limit := params.Limit
    if limit < 1 {
        limit = 20
    }
    if limit > 100 {
        limit = 100
    }
    offset := (page - 1) * limit
    query = query.Offset(offset).Limit(limit)
    
    // 执行查询
    if err := query.Find(&users).Error; err != nil {
        return nil, 0, fmt.Errorf("查询用户列表失败: %w", err)
    }
    
    return users, total, nil
}

// Update 更新用户信息
func (r *userRepository) Update(ctx context.Context, user *models.User) error {
    if err := r.db.WithContext(ctx).Save(user).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return fmt.Errorf("用户不存在")
        }
        return fmt.Errorf("更新用户失败: %w", err)
    }
    return nil
}

// Delete 删除用户
func (r *userRepository) Delete(ctx context.Context, id int64) error {
    result := r.db.WithContext(ctx).Delete(&models.User{}, id)
    if result.Error != nil {
        return fmt.Errorf("删除用户失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("用户不存在")
    }
    return nil
}

// UpdateStatus 更新用户状态
func (r *userRepository) UpdateStatus(ctx context.Context, id int64, isActive bool) error {
    result := r.db.WithContext(ctx).Model(&models.User{}).
        Where("id = ?", id).
        Update("is_active", isActive)
    if result.Error != nil {
        return fmt.Errorf("更新用户状态失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("用户不存在")
    }
    return nil
}

// UpdateLastLoginAt 更新最后登录时间
func (r *userRepository) UpdateLastLoginAt(ctx context.Context, id int64) error {
    now := time.Now()
    result := r.db.WithContext(ctx).Model(&models.User{}).
        Where("id = ?", id).
        Update("last_login_at", now)
    if result.Error != nil {
        return fmt.Errorf("更新最后登录时间失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("用户不存在")
    }
    return nil
}

// ExistsByUsername 检查用户名是否存在
func (r *userRepository) ExistsByUsername(ctx context.Context, username string) (bool, error) {
    var count int64
    if err := r.db.WithContext(ctx).Model(&models.User{}).
        Where("username = ?", username).
        Count(&count).Error; err != nil {
        return false, fmt.Errorf("检查用户名是否存在失败: %w", err)
    }
    return count > 0, nil
}

// ExistsByEmail 检查邮箱是否存在
func (r *userRepository) ExistsByEmail(ctx context.Context, email string) (bool, error) {
    var count int64
    if err := r.db.WithContext(ctx).Model(&models.User{}).
        Where("email = ?", email).
        Count(&count).Error; err != nil {
        return false, fmt.Errorf("检查邮箱是否存在失败: %w", err)
    }
    return count > 0, nil
}

// ExistsByPhone 检查手机号是否存在
func (r *userRepository) ExistsByPhone(ctx context.Context, phone string) (bool, error) {
    var count int64
    if err := r.db.WithContext(ctx).Model(&models.User{}).
        Where("phone = ?", phone).
        Count(&count).Error; err != nil {
        return false, fmt.Errorf("检查手机号是否存在失败: %w", err)
    }
    return count > 0, nil
}
```

### 3. 添加必要的导入

```go
package repository

import (
    "context"
    "errors"
    "fmt"
    "time"
    
    "gorm.io/gorm"
    "yourproject/internal/models"
)
```

### 4. 注意事项

- **错误处理**：所有错误消息必须使用中文
- **上下文传递**：所有方法都接受context.Context参数，支持超时和取消
- **参数验证**：在方法内部验证参数有效性
- **分页限制**：limit最大值为100，防止查询过多数据
- **模糊查询**：Username、Email、Phone支持模糊匹配（LIKE查询）
- **排序默认值**：默认按created_at降序排序
- **错误包装**：使用fmt.Errorf和%w动词包装错误，保留错误链
- **记录不存在**：当记录不存在时，返回明确的错误消息

## 验收标准

1. **接口定义完整**
   - UserRepository接口包含所有必需方法
   - 方法签名正确，参数和返回值类型正确
   - UserQueryParams结构体定义完整

2. **实现完整**
   - 所有接口方法都已实现
   - 实现逻辑正确，符合业务需求
   - 错误处理完善，错误消息使用中文

3. **查询功能**
   - GetAll方法支持分页、筛选、排序
   - 筛选条件正确应用
   - 分页参数验证正确
   - 排序功能正确实现

4. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文
   - 使用错误包装保留错误链

5. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 注释完整，使用中文

## 相关文件

- `internal/models/user.go` - User模型文件
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/repository/user_repository.go` - UserRepository接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:06:59 CST

