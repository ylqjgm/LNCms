# TASK005-19: 创建UserHandler接口和实现 - 用户登录API

## 任务信息

**任务编号**: TASK005-19  
**父任务**: TASK005  
**任务名称**: 创建UserHandler接口和实现 - 用户登录API  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:26:31 CST

## 任务描述

扩展用户控制器，提供用户登录的HTTP API处理。包括：1) 扩展UserHandler接口（Login方法）；2) 实现Login方法（处理POST /api/v1/users/login请求）；3) 实现请求参数绑定和验证；4) 调用AuthService.Login；5) 格式化响应（Envelope格式）。所有代码必须遵循API设计规范。

## 依赖任务

TASK005-18（创建UserHandler接口和实现 - 用户注册API）、TASK005-11（创建AuthService接口和实现 - 登录和登出）

## 实现指南

### 1. 扩展UserHandler接口

在 `internal/handler/user_handler.go` 文件中，扩展UserHandler接口：

```go
// UserHandler 用户控制器接口
// 提供用户管理的HTTP API处理
type UserHandler interface {
    // Register 用户注册
    // POST /api/v1/users/register
    Register(c *gin.Context)
    
    // Login 用户登录
    // POST /api/v1/users/login
    Login(c *gin.Context)
}
```

### 2. 实现Login方法

```go
// Login 用户登录
// @Summary 用户登录
// @Description 用户登录接口，支持用户名或邮箱登录
// @Tags 用户管理
// @Accept json
// @Produce json
// @Param request body dto.LoginRequest true "登录请求"
// @Success 200 {object} response.Envelope{data=dto.LoginResponse}
// @Failure 400 {object} response.Envelope
// @Failure 401 {object} response.Envelope
// @Failure 422 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/users/login [post]
func (h *userHandler) Login(c *gin.Context) {
    // 1. 绑定请求参数
    var req dto.LoginRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BadRequest(c, "请求参数错误", err)
        return
    }
    
    // 2. 获取客户端IP和User-Agent
    req.IPAddress = c.ClientIP()
    req.UserAgent = c.GetHeader("User-Agent")
    
    // 3. 调用AuthService.Login
    resp, err := h.authService.Login(c.Request.Context(), &req)
    if err != nil {
        // 根据错误类型返回不同的HTTP状态码
        if isValidationError(err) {
            response.UnprocessableEntity(c, "验证失败", err)
            return
        }
        if isUnauthorizedError(err) {
            response.Unauthorized(c, "认证失败", err)
            return
        }
        response.InternalServerError(c, "登录失败", err)
        return
    }
    
    // 4. 格式化响应（Envelope格式）
    response.OK(c, resp, "登录成功")
}
```

### 3. 实现错误判断辅助函数

在 `internal/handler/user_handler.go` 文件中，添加未授权错误判断：

```go
// isUnauthorizedError 判断是否为未授权错误
func isUnauthorizedError(err error) bool {
    errMsg := err.Error()
    return contains(errMsg, "用户名或密码错误") ||
        contains(errMsg, "用户未激活") ||
        contains(errMsg, "用户已被锁定") ||
        contains(errMsg, "邮箱未验证")
}
```

### 4. 扩展response包（如果需要）

确保 `pkg/response/` 包提供了OK和Unauthorized方法：

```go
// OK 返回200 OK响应
func OK(c *gin.Context, data interface{}, message string) {
    envelope := buildEnvelope(c, http.StatusOK, message, data, nil)
    c.JSON(http.StatusOK, envelope)
}

// Unauthorized 返回401 Unauthorized响应
func Unauthorized(c *gin.Context, message string, err error) {
    errors := []Error{{Code: "UNAUTHORIZED", Message: err.Error()}}
    envelope := buildEnvelope(c, http.StatusUnauthorized, message, nil, errors)
    c.JSON(http.StatusUnauthorized, envelope)
}
```

### 5. 注意事项

- **请求绑定**：使用Gin的ShouldBindJSON绑定JSON请求体
- **参数验证**：依赖Gin的binding标签进行参数验证
- **错误处理**：根据错误类型返回合适的HTTP状态码（401 Unauthorized用于认证失败）
- **响应格式**：所有响应使用Envelope格式
- **状态码**：登录成功返回200 OK
- **IP和User-Agent**：从请求中提取IP地址和User-Agent，传递给服务层
- **安全性**：密码错误时返回通用错误消息，不泄露用户是否存在

## 验收标准

1. **接口扩展完整**
   - UserHandler接口包含Login方法
   - 方法签名正确

2. **请求处理**
   - Login方法正确绑定请求参数
   - 正确提取IP地址和User-Agent
   - 参数验证正确

3. **服务调用**
   - 正确调用AuthService.Login
   - 错误处理正确

4. **响应格式化**
   - 成功响应使用Envelope格式
   - 错误响应使用Envelope格式
   - HTTP状态码正确（200 OK）

5. **错误处理**
   - 根据错误类型返回合适的HTTP状态码（401 Unauthorized）
   - 错误消息使用中文
   - 错误格式符合API设计规范

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范
   - 注释完整，使用中文

## 相关文件

- `internal/handler/user_handler.go` - UserHandler接口和实现文件
- `internal/service/auth_service.go` - AuthService实现文件
- `internal/dto/auth_dto.go` - 认证相关DTO文件
- `pkg/response/response.go` - 响应格式化包
- `.cursor/rules/api-design.mdc` - API设计规范
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 20:26:31 CST

