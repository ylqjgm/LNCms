# TASK002-71: 数据库设计 - 核心模块 - 作品推荐关联表

## 任务信息

**任务编号**: TASK002-71  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 作品推荐关联表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:10:08 CST

## 任务描述

设计核心模块的作品推荐关联表（content_recommendations），用于存储作品与推荐位的关联关系。支持将不同类型内容（小说、漫画、音频、视频）推荐到不同的推荐位，支持推荐时间段控制和推荐顺序。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-70（推荐位表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解作品推荐的详细需求：

**功能需求**：
- 编辑可将作品推荐至指定的推荐位
- 支持推荐时间段控制（推荐开始时间、推荐结束时间）
- 支持推荐顺序，控制推荐位中作品的显示顺序

### 2. 设计作品推荐关联表结构

设计 `content_recommendations` 表：

```sql
CREATE TABLE content_recommendations (
    id BIGSERIAL PRIMARY KEY,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    position_id BIGINT NOT NULL,
    recommend_order INTEGER DEFAULT 0,
    start_time TIMESTAMPTZ,
    end_time TIMESTAMPTZ,
    recommended_by BIGINT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_content_recommendations_position_id FOREIGN KEY (position_id) REFERENCES recommend_positions(id) ON DELETE CASCADE,
    CONSTRAINT fk_content_recommendations_recommended_by FOREIGN KEY (recommended_by) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT ck_content_recommendations_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_content_recommendations_end_time CHECK (end_time IS NULL OR end_time > start_time)
);

-- 创建索引
CREATE INDEX idx_content_recommendations_content_type ON content_recommendations(content_type);
CREATE INDEX idx_content_recommendations_content_id ON content_recommendations(content_id);
CREATE INDEX idx_content_recommendations_position_id ON content_recommendations(position_id);
CREATE INDEX idx_content_recommendations_recommend_order ON content_recommendations(recommend_order);
CREATE INDEX idx_content_recommendations_start_time ON content_recommendations(start_time);
CREATE INDEX idx_content_recommendations_end_time ON content_recommendations(end_time);
CREATE INDEX idx_content_recommendations_is_active ON content_recommendations(is_active);
CREATE INDEX idx_content_recommendations_recommended_by ON content_recommendations(recommended_by);
CREATE INDEX idx_content_recommendations_content_type_id ON content_recommendations(content_type, content_id);
CREATE INDEX idx_content_recommendations_position_active ON content_recommendations(position_id, is_active);
CREATE INDEX idx_content_recommendations_position_order ON content_recommendations(position_id, recommend_order);
CREATE INDEX idx_content_recommendations_time_range ON content_recommendations(start_time, end_time);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_content_recommendations_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_content_recommendations_updated_at
    BEFORE UPDATE ON content_recommendations
    FOR EACH ROW
    EXECUTE FUNCTION update_content_recommendations_updated_at();

-- 添加表注释
COMMENT ON TABLE content_recommendations IS '作品推荐关联表，存储作品与推荐位的关联关系，支持推荐时间段控制和推荐顺序';
COMMENT ON COLUMN content_recommendations.id IS '关联ID，自增主键';
COMMENT ON COLUMN content_recommendations.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN content_recommendations.content_id IS '内容ID，关联对应内容表（novels表、comics表、audios表、videos表）的主键';
COMMENT ON COLUMN content_recommendations.position_id IS '推荐位ID，外键关联recommend_positions表';
COMMENT ON COLUMN content_recommendations.recommend_order IS '推荐顺序，数值越大越靠前，用于控制推荐位中作品的显示顺序';
COMMENT ON COLUMN content_recommendations.start_time IS '推荐开始时间，为NULL表示立即生效。到达此时间后，作品开始在推荐位展示';
COMMENT ON COLUMN content_recommendations.end_time IS '推荐结束时间，为NULL表示永久推荐。到达此时间后，作品从推荐位中移除';
COMMENT ON COLUMN content_recommendations.recommended_by IS '推荐人员ID，外键关联users表，记录是谁推荐的作品';
COMMENT ON COLUMN content_recommendations.is_active IS '是否有效，TRUE-有效，FALSE-无效（如编辑手动取消推荐）';
COMMENT ON COLUMN content_recommendations.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN content_recommendations.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_content_recommendations` (id)
- **外键约束**：
  - `fk_content_recommendations_position_id`：position_id 关联 recommend_positions 表，删除推荐位时级联删除关联关系
  - `fk_content_recommendations_recommended_by`：recommended_by 关联 users 表，删除用户时设置为 NULL
- **非空约束**：content_type、content_id、position_id 必须非空
- **检查约束**：
  - `ck_content_recommendations_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_content_recommendations_end_time`：end_time 如果存在，必须大于 start_time
- **默认值**：
  - recommend_order 默认为 0
  - is_active 默认为 TRUE

### 4. 设计索引

- **主键索引**：`pk_content_recommendations` (id) - 自动创建
- **普通索引**：
  - `idx_content_recommendations_content_type` (content_type) - 用于按内容类型查询
  - `idx_content_recommendations_content_id` (content_id) - 用于查询作品的推荐记录
  - `idx_content_recommendations_position_id` (position_id) - 用于查询推荐位下的作品
  - `idx_content_recommendations_recommend_order` (recommend_order) - 用于排序
  - `idx_content_recommendations_start_time` (start_time) - 用于查询推荐开始时间
  - `idx_content_recommendations_end_time` (end_time) - 用于查询推荐结束时间
  - `idx_content_recommendations_is_active` (is_active) - 用于筛选有效的推荐
  - `idx_content_recommendations_recommended_by` (recommended_by) - 用于查询推荐人员推荐的记录
- **复合索引**：
  - `idx_content_recommendations_content_type_id` (content_type, content_id) - 用于查询作品的推荐记录
  - `idx_content_recommendations_position_active` (position_id, is_active) - 用于查询推荐位下有效的推荐
  - `idx_content_recommendations_position_order` (position_id, recommend_order) - 用于查询推荐位下的作品并按顺序排列
  - `idx_content_recommendations_time_range` (start_time, end_time) - 用于查询时间范围内的推荐

### 5. 考虑性能优化

- 为 position_id 创建索引，支持快速查询推荐位下的作品
- 创建复合索引 (position_id, is_active)，优化查询推荐位下有效推荐的性能
- 创建复合索引 (position_id, recommend_order)，优化查询推荐位下作品并按顺序排列的性能
- 创建复合索引 (start_time, end_time)，支持查询时间范围内的推荐
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**推荐流程**：
1. 编辑选择作品，选择推荐位，设置推荐顺序和推荐时间段
2. 系统创建推荐关联记录
3. 如果设置了 start_time，则在到达开始时间后，作品在推荐位展示
4. 如果设置了 end_time，则在到达结束时间后，作品从推荐位移除
5. 如果 start_time 和 end_time 都为 NULL，则立即生效且永久推荐

**推荐顺序**：
- recommend_order 数值越大，在推荐位中的位置越靠前
- 系统查询推荐位下的作品时，按 recommend_order 降序排列

**时间段控制**：
- start_time 为 NULL：立即生效
- end_time 为 NULL：永久推荐，直到手动取消
- 支持定时推荐和定时下架功能

**有效性控制**：
- is_active 为 TRUE：推荐有效
- is_active 为 FALSE：推荐无效，但不删除记录，保留历史信息

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按推荐位查询、按作品查询、按时间范围查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持推荐位和推荐人员关联
7. 检查约束正确设置，确保内容类型有效，结束时间大于开始时间
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 10.3 节 - 作品管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 10.3 节 - 作品管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:10:08 CST

