# TASK002-61: 数据库连接测试和验证

## 任务信息

**任务编号**: TASK002-61  
**父任务**: TASK002  
**任务名称**: 数据库连接测试和验证  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:33:13 CST

## 任务描述

编写数据库连接测试和验证脚本，包括数据库连接测试、表结构验证、数据完整性验证、索引验证等。必须遵循 PostgreSQL 数据库设计规范。

## 依赖任务

TASK002-55、TASK002-56、TASK002-57、TASK002-58、TASK002-59、TASK002-60（所有基础数据初始化脚本）

## 实现指南

### 1. 分析需求文档

阅读所有需求文档，了解数据库设计的完整需求：
- 数据库连接测试：验证数据库连接是否正常
- 表结构验证：验证所有表结构是否正确创建
- 数据完整性验证：验证基础数据是否完整
- 索引验证：验证所有索引是否正确创建

### 2. 创建测试脚本文件

创建测试脚本：
- Go 测试文件：`internal/database/verify_test.go`
- SQL 验证脚本：`migrations/verify/verify_database.sql`

### 3. 编写数据库连接测试

在 Go 测试文件中编写数据库连接测试：

```go
func TestDatabaseConnection(t *testing.T) {
    db, err := sql.Open("postgres", databaseURL)
    require.NoError(t, err)
    defer db.Close()
    
    err = db.Ping()
    require.NoError(t, err)
}
```

### 4. 编写表结构验证

在 SQL 验证脚本中验证所有表结构：

```sql
-- 验证表是否存在
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('configs', 'roles', 'users', ...);

-- 验证字段是否存在
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'users' 
AND column_name IN ('id', 'username', 'email', ...);
```

### 5. 编写数据完整性验证

在 SQL 验证脚本中验证基础数据：

```sql
-- 验证默认角色是否存在
SELECT COUNT(*) FROM roles WHERE name IN ('super_admin', 'admin', 'user');

-- 验证默认用户组是否存在
SELECT COUNT(*) FROM user_groups WHERE name IN ('vip', 'normal');

-- 验证默认等级是否存在
SELECT COUNT(*) FROM levels WHERE level_value BETWEEN 1 AND 5;
```

### 6. 编写索引验证

在 SQL 验证脚本中验证所有索引：

```sql
-- 验证索引是否存在
SELECT indexname 
FROM pg_indexes 
WHERE schemaname = 'public' 
AND tablename = 'users' 
AND indexname IN ('idx_users_username', 'idx_users_email', ...);
```

### 7. 运行测试和验证

- 运行 Go 测试，验证数据库连接
- 执行 SQL 验证脚本，验证表结构、数据和索引
- 生成验证报告

## 验收标准

1. 数据库连接测试可以成功执行
2. 所有表结构验证通过
3. 所有基础数据验证通过
4. 所有索引验证通过
5. 验证脚本可以成功执行，无错误
6. 生成完整的验证报告

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `docs/Requirements/Storage.md` - 存储模块需求文档
- `docs/Requirements/Log.md` - 日志模块需求文档
- `docs/Requirements/Crawler.md` - 采集模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-52.md` 到 `TASK002-55.md` - 数据库迁移脚本文档
- `docs/TASKS/TASK002/TASK002-56.md` 到 `TASK002-61.md` - 基础数据初始化脚本文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:33:13 CST

