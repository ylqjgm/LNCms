# TASK002-73: 数据库设计 - 核心模块 - 结算变更记录表

## 任务信息

**任务编号**: TASK002-73  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 结算变更记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:10:08 CST

## 任务描述

设计核心模块的结算变更记录表（settlement_changes），用于存储结算变更记录。编辑对作者结算进行变更后，需要作者确认，确认后进入组长进行审核。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-72（结算审核记录表）、TASK002-10（用户表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解结算变更的详细需求：

**功能需求**：
- 编辑对作者结算进行变更
- 变更后由作者进行确认
- 确认后进入组长进行审核
- 组长审核通过后，更新结算审核记录中的 settlement_amount

**变更类型**：
- 增加：增加结算金额
- 减少：减少结算金额

**确认状态**：
- 待确认：编辑提交变更，等待作者确认
- 已确认：作者已确认变更
- 已拒绝：作者拒绝变更

**审核状态**（作者确认后）：
- 待审核：作者确认后，等待组长审核
- 已通过：组长审核通过
- 已拒绝：组长审核拒绝

### 2. 设计结算变更记录表结构

设计 `settlement_changes` 表：

```sql
CREATE TABLE settlement_changes (
    id BIGSERIAL PRIMARY KEY,
    settlement_audit_id BIGINT NOT NULL,
    change_type VARCHAR(10) NOT NULL,
    change_amount NUMERIC(10, 2) NOT NULL,
    change_reason TEXT NOT NULL,
    changed_by BIGINT NOT NULL,
    confirm_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    confirmed_at TIMESTAMPTZ,
    confirmed_by BIGINT,
    rejection_reason TEXT,
    audit_status VARCHAR(20) DEFAULT 'pending',
    auditor_id BIGINT,
    audit_time TIMESTAMPTZ,
    audit_opinion TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_settlement_changes_settlement_audit_id FOREIGN KEY (settlement_audit_id) REFERENCES settlement_audits(id) ON DELETE CASCADE,
    CONSTRAINT fk_settlement_changes_changed_by FOREIGN KEY (changed_by) REFERENCES users(id) ON DELETE RESTRICT,
    CONSTRAINT fk_settlement_changes_confirmed_by FOREIGN KEY (confirmed_by) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT fk_settlement_changes_auditor_id FOREIGN KEY (auditor_id) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT ck_settlement_changes_change_type CHECK (change_type IN ('increase', 'decrease')),
    CONSTRAINT ck_settlement_changes_change_amount CHECK (change_amount > 0),
    CONSTRAINT ck_settlement_changes_confirm_status CHECK (confirm_status IN ('pending', 'confirmed', 'rejected')),
    CONSTRAINT ck_settlement_changes_audit_status CHECK (audit_status IN ('pending', 'approved', 'rejected'))
);

-- 创建索引
CREATE INDEX idx_settlement_changes_settlement_audit_id ON settlement_changes(settlement_audit_id);
CREATE INDEX idx_settlement_changes_change_type ON settlement_changes(change_type);
CREATE INDEX idx_settlement_changes_confirm_status ON settlement_changes(confirm_status);
CREATE INDEX idx_settlement_changes_audit_status ON settlement_changes(audit_status);
CREATE INDEX idx_settlement_changes_changed_by ON settlement_changes(changed_by);
CREATE INDEX idx_settlement_changes_confirmed_by ON settlement_changes(confirmed_by);
CREATE INDEX idx_settlement_changes_auditor_id ON settlement_changes(auditor_id);
CREATE INDEX idx_settlement_changes_confirmed_at ON settlement_changes(confirmed_at);
CREATE INDEX idx_settlement_changes_audit_time ON settlement_changes(audit_time);
CREATE INDEX idx_settlement_changes_created_at ON settlement_changes(created_at);
CREATE INDEX idx_settlement_changes_audit_confirm_status ON settlement_changes(settlement_audit_id, confirm_status);
CREATE INDEX idx_settlement_changes_confirm_audit_status ON settlement_changes(confirm_status, audit_status);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_settlement_changes_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_settlement_changes_updated_at
    BEFORE UPDATE ON settlement_changes
    FOR EACH ROW
    EXECUTE FUNCTION update_settlement_changes_updated_at();

-- 添加表注释
COMMENT ON TABLE settlement_changes IS '结算变更记录表，存储结算变更记录，编辑对作者结算进行变更后需要作者确认，确认后进入组长审核';
COMMENT ON COLUMN settlement_changes.id IS '变更ID，自增主键';
COMMENT ON COLUMN settlement_changes.settlement_audit_id IS '结算审核ID，外键关联settlement_audits表';
COMMENT ON COLUMN settlement_changes.change_type IS '变更类型：increase-增加、decrease-减少';
COMMENT ON COLUMN settlement_changes.change_amount IS '变更金额，单位：消费货币，必须大于0。增加时为正值，减少时也为正值（表示减少的金额）';
COMMENT ON COLUMN settlement_changes.change_reason IS '变更原因，编辑填写的变更原因说明';
COMMENT ON COLUMN settlement_changes.changed_by IS '变更人员ID，外键关联users表，记录执行变更操作的编辑，删除时限制删除（RESTRICT）以确保记录完整性';
COMMENT ON COLUMN settlement_changes.confirm_status IS '确认状态：pending-待确认、confirmed-已确认、rejected-已拒绝。作者确认后，audit_status变为pending等待组长审核';
COMMENT ON COLUMN settlement_changes.confirmed_at IS '确认时间，作者确认或拒绝变更的时间';
COMMENT ON COLUMN settlement_changes.confirmed_by IS '确认人员ID，外键关联users表，记录确认变更的作者（作者ID对应的用户ID）';
COMMENT ON COLUMN settlement_changes.rejection_reason IS '拒绝原因，作者拒绝变更时填写的拒绝原因';
COMMENT ON COLUMN settlement_changes.audit_status IS '审核状态：pending-待审核（作者确认后等待组长审核）、approved-已通过（组长审核通过）、rejected-已拒绝（组长审核拒绝）。当confirm_status为pending时，audit_status应为pending；当confirm_status为rejected时，audit_status保持pending不变；当confirm_status为confirmed时，audit_status变为pending等待组长审核';
COMMENT ON COLUMN settlement_changes.auditor_id IS '审核人员ID，外键关联users表，记录进行审核的组长';
COMMENT ON COLUMN settlement_changes.audit_time IS '审核时间，组长进行审核的时间';
COMMENT ON COLUMN settlement_changes.audit_opinion IS '审核意见，组长填写的审核意见和建议';
COMMENT ON COLUMN settlement_changes.created_at IS '创建时间，自动设置为当前时间，即变更记录创建的时间';
COMMENT ON COLUMN settlement_changes.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_settlement_changes` (id)
- **外键约束**：
  - `fk_settlement_changes_settlement_audit_id`：settlement_audit_id 关联 settlement_audits 表，删除结算审核记录时级联删除变更记录
  - `fk_settlement_changes_changed_by`：changed_by 关联 users 表，删除用户时限制删除（RESTRICT）以确保记录完整性
  - `fk_settlement_changes_confirmed_by`：confirmed_by 关联 users 表，删除用户时设置为 NULL
  - `fk_settlement_changes_auditor_id`：auditor_id 关联 users 表，删除用户时设置为 NULL
- **非空约束**：settlement_audit_id、change_type、change_amount、change_reason、changed_by、confirm_status 必须非空
- **检查约束**：
  - `ck_settlement_changes_change_type`：change_type 必须是预定义的值之一（increase、decrease）
  - `ck_settlement_changes_change_amount`：change_amount 必须大于 0
  - `ck_settlement_changes_confirm_status`：confirm_status 必须是预定义的值之一（pending、confirmed、rejected）
  - `ck_settlement_changes_audit_status`：audit_status 必须是预定义的值之一（pending、approved、rejected）
- **默认值**：
  - confirm_status 默认为 'pending'
  - audit_status 默认为 'pending'
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_settlement_changes` (id) - 自动创建
- **主键索引**：`pk_settlement_changes` (id) - 自动创建
- **普通索引**：
  - `idx_settlement_changes_settlement_audit_id` (settlement_audit_id) - 用于查询结算审核记录的变更记录
  - `idx_settlement_changes_change_type` (change_type) - 用于按变更类型查询
  - `idx_settlement_changes_confirm_status` (confirm_status) - 用于按确认状态查询
  - `idx_settlement_changes_audit_status` (audit_status) - 用于按审核状态查询
  - `idx_settlement_changes_changed_by` (changed_by) - 用于查询编辑提交的变更记录
  - `idx_settlement_changes_confirmed_by` (confirmed_by) - 用于查询作者确认的变更记录
  - `idx_settlement_changes_auditor_id` (auditor_id) - 用于查询组长审核的变更记录
  - `idx_settlement_changes_confirmed_at` (confirmed_at) - 用于按确认时间排序和查询
  - `idx_settlement_changes_audit_time` (audit_time) - 用于按审核时间排序和查询
  - `idx_settlement_changes_created_at` (created_at) - 用于按创建时间排序和查询
- **复合索引**：
  - `idx_settlement_changes_audit_confirm_status` (settlement_audit_id, confirm_status) - 用于查询结算审核记录特定确认状态的变更记录
  - `idx_settlement_changes_confirm_audit_status` (confirm_status, audit_status) - 用于查询特定确认状态和审核状态的变更记录（如已确认待审核的记录）

### 5. 考虑性能优化

- 为 settlement_audit_id 创建索引，支持快速查询结算审核记录的变更记录
- 创建复合索引 (settlement_audit_id, confirm_status)，优化查询特定确认状态变更记录的性能
- 创建复合索引 (confirm_status, audit_status)，优化查询特定确认状态和审核状态组合的变更记录性能（如已确认待审核的记录）
- 为 confirm_status 和 audit_status 创建索引，支持查询待确认、已确认、待审核、已通过、已拒绝的记录
- 为 auditor_id 创建索引，支持查询组长审核的变更记录
- 使用 NUMERIC 类型存储变更金额，确保精度
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**变更流程**：
1. **编辑提交变更**：
   - 编辑对结算审核记录进行变更，填写变更类型（增加或减少）、变更金额和变更原因
   - 系统创建变更记录，confirm_status 为 'pending'，audit_status 为 'pending'，等待作者确认

2. **作者确认/拒绝**：
   - 作者查看变更记录，可以选择确认或拒绝
   - **如果作者确认（confirmed）**：
     - 更新 confirm_status 为 'confirmed'
     - 记录 confirmed_at 和 confirmed_by（作者ID对应的用户ID）
     - audit_status 保持为 'pending'，变更进入组长审核流程
   - **如果作者拒绝（rejected）**：
     - 更新 confirm_status 为 'rejected'
     - 记录 confirmed_at、confirmed_by 和 rejection_reason
     - audit_status 保持为 'pending'（不变），变更记录保留，但不再进入审核流程

3. **组长审核**（仅当 confirm_status 为 'confirmed' 时）：
   - 组长查看待审核的变更记录（confirm_status='confirmed' AND audit_status='pending'）
   - 组长进行审核，可以选择通过或拒绝
   - **如果组长审核通过（approved）**：
     - 更新 audit_status 为 'approved'
     - 记录 auditor_id、audit_time 和 audit_opinion
     - 更新结算审核记录（settlement_audits）中的 settlement_amount：
       - 如果 change_type 为 'increase'，则 settlement_amount = settlement_amount + change_amount
       - 如果 change_type 为 'decrease'，则 settlement_amount = settlement_amount - change_amount
     - 重新计算 actual_payment_amount = settlement_amount / settlement_ratio
   - **如果组长审核拒绝（rejected）**：
     - 更新 audit_status 为 'rejected'
     - 记录 auditor_id、audit_time 和 audit_opinion（说明拒绝原因）
     - 不变更结算审核记录

**变更类型**：
- increase（增加）：增加结算金额，change_amount 为正值
- decrease（减少）：减少结算金额，change_amount 为正值（表示减少的金额）

**金额处理**：
- change_amount 始终为正值
- 变更类型为 'increase' 时，表示增加 change_amount 金额
- 变更类型为 'decrease' 时，表示减少 change_amount 金额

**状态流转**：
- confirm_status='pending'：等待作者确认，audit_status 保持 'pending'
- confirm_status='rejected'：作者拒绝，audit_status 保持 'pending'（不变），流程结束
- confirm_status='confirmed' + audit_status='pending'：作者已确认，等待组长审核
- confirm_status='confirmed' + audit_status='approved'：组长审核通过，变更生效
- confirm_status='confirmed' + audit_status='rejected'：组长审核拒绝，变更不生效

**审核记录关联**：
- 结算变更记录独立存储，有自己的审核流程
- 组长审核通过后，更新关联的结算审核记录（settlement_audits）中的 settlement_amount
- 这样可以完整追溯结算变更和审核的历史

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按结算审核记录查询、按确认状态查询、按审核状态查询、组合状态查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持结算审核记录和变更人员、确认人员、审核人员关联
7. 检查约束正确设置，确保变更类型、变更金额、确认状态和审核状态的值有效
8. 使用 NUMERIC 类型存储变更金额，确保精度
9. 使用 RESTRICT 约束保护变更人员记录完整性
10. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 10.4 节 - 结算管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 10.4 节 - 结算管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:10:08 CST

