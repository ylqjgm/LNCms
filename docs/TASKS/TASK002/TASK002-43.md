# TASK002-43: 数据库设计 - 存储模块 - 转码记录表

## 任务信息

**任务编号**: TASK002-43  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 存储模块 - 转码记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计存储模块的转码记录表（transcode_records），用于存储文件转码记录信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-42（文件表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Storage.md` 文档，了解文件转码的详细需求：
- 文件转码：支持图片、视频、音频等文件的转码处理
- 转码记录：记录转码任务ID、转码状态、转码进度等信息
- 转码完成后更新文件表

### 2. 设计转码记录表结构

设计 `transcode_records` 表，包含转码记录基本信息：

```sql
CREATE TABLE transcode_records (
    id BIGSERIAL PRIMARY KEY,
    file_id BIGINT NOT NULL,
    source_file_id BIGINT NOT NULL,
    transcode_type VARCHAR(20) NOT NULL,
    transcode_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    transcode_progress DECIMAL(5, 2) DEFAULT 0.00,
    transcode_params JSONB,
    error_message TEXT,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_transcode_records_file_id FOREIGN KEY (file_id) REFERENCES files(id) ON DELETE CASCADE,
    CONSTRAINT fk_transcode_records_source_file_id FOREIGN KEY (source_file_id) REFERENCES files(id) ON DELETE CASCADE,
    CONSTRAINT ck_transcode_records_transcode_type CHECK (transcode_type IN ('image', 'video', 'audio', 'document')),
    CONSTRAINT ck_transcode_records_transcode_status CHECK (transcode_status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')),
    CONSTRAINT ck_transcode_records_transcode_progress CHECK (transcode_progress >= 0 AND transcode_progress <= 100)
);

-- 创建索引
CREATE INDEX idx_transcode_records_file_id ON transcode_records(file_id);
CREATE INDEX idx_transcode_records_source_file_id ON transcode_records(source_file_id);
CREATE INDEX idx_transcode_records_transcode_type ON transcode_records(transcode_type);
CREATE INDEX idx_transcode_records_transcode_status ON transcode_records(transcode_status);
CREATE INDEX idx_transcode_records_created_at ON transcode_records(created_at);
CREATE INDEX idx_transcode_records_transcode_status_created ON transcode_records(transcode_status, created_at);
CREATE INDEX idx_transcode_records_source_status ON transcode_records(source_file_id, transcode_status);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_transcode_records_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_transcode_records_updated_at
    BEFORE UPDATE ON transcode_records
    FOR EACH ROW
    EXECUTE FUNCTION update_transcode_records_updated_at();

-- 添加表注释
COMMENT ON TABLE transcode_records IS '转码记录表，存储文件转码记录信息';
COMMENT ON COLUMN transcode_records.id IS '转码记录ID，自增主键';
COMMENT ON COLUMN transcode_records.file_id IS '转码后文件ID，外键关联files表';
COMMENT ON COLUMN transcode_records.source_file_id IS '源文件ID，外键关联files表，转码前的原始文件';
COMMENT ON COLUMN transcode_records.transcode_type IS '转码类型：image-图片转码、video-视频转码、audio-音频转码、document-文档转码';
COMMENT ON COLUMN transcode_records.transcode_status IS '转码状态：pending-待处理、processing-处理中、completed-已完成、failed-失败、cancelled-已取消';
COMMENT ON COLUMN transcode_records.transcode_progress IS '转码进度，单位：百分比，范围0-100';
COMMENT ON COLUMN transcode_records.transcode_params IS '转码参数，JSONB格式，存储转码配置信息（如分辨率、码率、格式等）';
COMMENT ON COLUMN transcode_records.error_message IS '错误消息，转码失败时的错误信息';
COMMENT ON COLUMN transcode_records.started_at IS '开始时间，转码开始处理的时间';
COMMENT ON COLUMN transcode_records.completed_at IS '完成时间，转码完成时的时间';
COMMENT ON COLUMN transcode_records.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN transcode_records.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_transcode_records` (id)
- **外键约束**：`fk_transcode_records_file_id` (file_id) 关联 files(id)，级联删除
- **外键约束**：`fk_transcode_records_source_file_id` (source_file_id) 关联 files(id)，级联删除
- **检查约束**：`ck_transcode_records_transcode_type` (transcode_type) - 确保转码类型是预定义的值
- **检查约束**：`ck_transcode_records_transcode_status` (transcode_status) - 确保转码状态是预定义的值
- **检查约束**：`ck_transcode_records_transcode_progress` (transcode_progress) - 确保转码进度在0-100之间
- **非空约束**：file_id、source_file_id、transcode_type、transcode_status 必须非空
- **默认值**：transcode_status 默认为 'pending'，transcode_progress 默认为 0.00
- **可选字段**：transcode_params、error_message、started_at、completed_at 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_transcode_records` (id) - 自动创建
- **外键索引**：`idx_transcode_records_file_id` (file_id) - 用于关联查询
- **外键索引**：`idx_transcode_records_source_file_id` (source_file_id) - 用于查询源文件的转码记录
- **普通索引**：`idx_transcode_records_transcode_type` (transcode_type) - 用于按转码类型筛选
- **普通索引**：`idx_transcode_records_transcode_status` (transcode_status) - 用于按转码状态筛选
- **普通索引**：`idx_transcode_records_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_transcode_records_transcode_status_created` (transcode_status, created_at) - 用于查询特定状态的转码记录并按时间排序
- **复合索引**：`idx_transcode_records_source_status` (source_file_id, transcode_status) - 用于查询源文件的特定状态转码记录

### 5. 考虑性能优化

- 为 file_id 和 source_file_id 创建索引，支持关联查询
- 为 transcode_type 和 transcode_status 创建索引，支持按类型和状态筛选查询
- 为 created_at 创建索引，支持时间排序查询
- 使用复合索引优化常用查询场景（如查询特定状态的转码记录并按时间排序、查询源文件的特定状态转码记录）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 files 表（转码后文件和源文件）
4. 检查约束正确，确保转码类型、转码状态、转码进度等是有效的值
5. 索引设计合理，支持常用查询场景（包括按文件查询、按转码状态查询、按转码类型查询）
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Storage.md` - 存储模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-42.md` - 文件表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

