# TASK002-38: 数据库设计 - 核心模块 - 作者收益表

## 任务信息

**任务编号**: TASK002-38  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 作者收益表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的作者收益表（author_earnings），用于存储作者收益记录信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-13（作者表）、TASK002-38（流水表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解作者收益管理的详细需求：
- 作者收益管理：收益计算、收益记录、收益统计、收益结算
- 作者收益关联作者表和流水表，记录收益来源
- 作者收益需要支持收益类型、收益金额、收益状态等

### 2. 设计作者收益表结构

设计 `author_earnings` 表，包含作者收益基本信息：

```sql
CREATE TABLE author_earnings (
    id BIGSERIAL PRIMARY KEY,
    author_id BIGINT NOT NULL,
    transaction_id BIGINT NOT NULL,
    earning_type VARCHAR(20) NOT NULL,
    earning_amount NUMERIC(10, 2) NOT NULL,
    commission_rate NUMERIC(5, 2) NOT NULL DEFAULT 0.00,
    commission_amount NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    net_amount NUMERIC(10, 2) NOT NULL,
    earning_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    settled_at TIMESTAMPTZ,
    settlement_period VARCHAR(20),
    remark TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_author_earnings_author_id FOREIGN KEY (author_id) REFERENCES authors(id) ON DELETE CASCADE,
    CONSTRAINT fk_author_earnings_transaction_id FOREIGN KEY (transaction_id) REFERENCES transactions(id) ON DELETE RESTRICT,
    CONSTRAINT ck_author_earnings_earning_type CHECK (earning_type IN ('content_sale', 'subscription', 'ad_revenue', 'other')),
    CONSTRAINT ck_author_earnings_earning_amount CHECK (earning_amount > 0),
    CONSTRAINT ck_author_earnings_commission_rate CHECK (commission_rate >= 0 AND commission_rate <= 100),
    CONSTRAINT ck_author_earnings_commission_amount CHECK (commission_amount >= 0),
    CONSTRAINT ck_author_earnings_net_amount CHECK (net_amount > 0),
    CONSTRAINT ck_author_earnings_earning_status CHECK (earning_status IN ('pending', 'settled', 'cancelled'))
);

-- 创建索引
CREATE INDEX idx_author_earnings_author_id ON author_earnings(author_id);
CREATE INDEX idx_author_earnings_transaction_id ON author_earnings(transaction_id);
CREATE INDEX idx_author_earnings_earning_type ON author_earnings(earning_type);
CREATE INDEX idx_author_earnings_earning_status ON author_earnings(earning_status);
CREATE INDEX idx_author_earnings_settled_at ON author_earnings(settled_at);
CREATE INDEX idx_author_earnings_settlement_period ON author_earnings(settlement_period);
CREATE INDEX idx_author_earnings_created_at ON author_earnings(created_at);
CREATE INDEX idx_author_earnings_author_status ON author_earnings(author_id, earning_status);
CREATE INDEX idx_author_earnings_author_settled ON author_earnings(author_id, settled_at);
CREATE INDEX idx_author_earnings_author_period ON author_earnings(author_id, settlement_period);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_author_earnings_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_author_earnings_updated_at
    BEFORE UPDATE ON author_earnings
    FOR EACH ROW
    EXECUTE FUNCTION update_author_earnings_updated_at();

-- 添加表注释
COMMENT ON TABLE author_earnings IS '作者收益表，存储作者收益记录信息';
COMMENT ON COLUMN author_earnings.id IS '收益ID，自增主键';
COMMENT ON COLUMN author_earnings.author_id IS '作者ID，外键关联authors表';
COMMENT ON COLUMN author_earnings.transaction_id IS '流水ID，外键关联transactions表，记录收益来源';
COMMENT ON COLUMN author_earnings.earning_type IS '收益类型：content_sale-内容销售、subscription-订阅、ad_revenue-广告收入、other-其他';
COMMENT ON COLUMN author_earnings.earning_amount IS '收益金额，单位：元，必须大于0';
COMMENT ON COLUMN author_earnings.commission_rate IS '佣金比例，单位：百分比，范围0-100';
COMMENT ON COLUMN author_earnings.commission_amount IS '佣金金额，单位：元，大于等于0';
COMMENT ON COLUMN author_earnings.net_amount IS '净收益金额，单位：元，收益金额减去佣金金额，必须大于0';
COMMENT ON COLUMN author_earnings.earning_status IS '收益状态：pending-待结算、settled-已结算、cancelled-已取消';
COMMENT ON COLUMN author_earnings.settled_at IS '结算时间，收益结算时的时间';
COMMENT ON COLUMN author_earnings.settlement_period IS '结算周期，格式：YYYY-MM，用于统计和查询';
COMMENT ON COLUMN author_earnings.remark IS '备注信息';
COMMENT ON COLUMN author_earnings.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN author_earnings.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_author_earnings` (id)
- **外键约束**：`fk_author_earnings_author_id` (author_id) 关联 authors(id)，级联删除
- **外键约束**：`fk_author_earnings_transaction_id` (transaction_id) 关联 transactions(id)，删除时禁止（RESTRICT）
- **检查约束**：`ck_author_earnings_earning_type` (earning_type) - 确保收益类型是预定义的值
- **检查约束**：`ck_author_earnings_earning_amount` (earning_amount) - 确保收益金额大于0
- **检查约束**：`ck_author_earnings_commission_rate` (commission_rate) - 确保佣金比例在0-100之间
- **检查约束**：`ck_author_earnings_commission_amount` (commission_amount) - 确保佣金金额大于等于0
- **检查约束**：`ck_author_earnings_net_amount` (net_amount) - 确保净收益金额大于0
- **检查约束**：`ck_author_earnings_earning_status` (earning_status) - 确保收益状态是预定义的值
- **非空约束**：author_id、transaction_id、earning_type、earning_amount、net_amount、earning_status 必须非空
- **默认值**：commission_rate 默认为 0.00，commission_amount 默认为 0.00，earning_status 默认为 'pending'
- **可选字段**：settled_at、settlement_period、remark 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_author_earnings` (id) - 自动创建
- **外键索引**：`idx_author_earnings_author_id` (author_id) - 用于查询作者的收益
- **外键索引**：`idx_author_earnings_transaction_id` (transaction_id) - 用于查询流水的收益记录
- **普通索引**：`idx_author_earnings_earning_type` (earning_type) - 用于按类型筛选
- **普通索引**：`idx_author_earnings_earning_status` (earning_status) - 用于按状态筛选
- **普通索引**：`idx_author_earnings_settled_at` (settled_at) - 用于按结算时间排序
- **普通索引**：`idx_author_earnings_settlement_period` (settlement_period) - 用于按结算周期查询
- **普通索引**：`idx_author_earnings_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_author_earnings_author_status` (author_id, earning_status) - 用于查询作者的特定状态收益
- **复合索引**：`idx_author_earnings_author_settled` (author_id, settled_at) - 用于查询作者的收益并按结算时间排序
- **复合索引**：`idx_author_earnings_author_period` (author_id, settlement_period) - 用于查询作者的特定周期收益

### 5. 考虑性能优化

- 为 author_id 创建索引，支持快速查询作者的收益
- 为 transaction_id 创建索引，支持查询流水的收益记录
- 为 earning_type 和 earning_status 创建索引，支持按类型和状态筛选查询
- 为 settled_at 和 settlement_period 创建索引，支持结算时间查询和周期统计
- 为 created_at 创建索引，支持时间排序查询
- 使用复合索引优化常用查询场景（如查询作者的特定状态收益、查询作者的特定周期收益、查询作者的收益并按结算时间排序）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 authors 表和 transactions 表
4. 检查约束正确，确保收益类型、收益金额、佣金比例、收益状态等是有效的值
5. 索引设计合理，支持常用查询场景（包括按作者查询、按类型查询、按状态查询、按结算周期查询）
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-13.md` - 作者表设计文档
- `docs/TASKS/TASK002/TASK002-38.md` - 流水表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

