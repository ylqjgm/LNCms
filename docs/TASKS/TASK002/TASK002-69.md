# TASK002-69: 数据库设计 - 核心模块 - 作品隐藏记录表

## 任务信息

**任务编号**: TASK002-69  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 作品隐藏记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:10:08 CST

## 任务描述

设计核心模块的作品隐藏记录表（content_hides），用于存储作品隐藏记录。支持隐藏不同类型内容（小说、漫画、音频、视频）的不同部分（基本信息、分卷/分季、章节/分集、附件等），记录隐藏说明、隐藏人员和解除信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解作品隐藏的详细需求：

**功能需求**：
- 可针对作品基本信息、分卷/分季、章节/分集、附件等进行信息隐藏
- 隐藏后前台不会展示，作者根据隐藏说明进行修改后可由编辑重新显示

**隐藏类型**：
- 基本信息隐藏：隐藏作品的基本信息，对应 content_id
- 分卷/分季隐藏：隐藏分卷或分季信息，需要记录具体的分卷ID或分季ID
- 章节/分集隐藏：隐藏章节或分集内容，需要记录具体的章节ID或分集ID
- 附件隐藏：隐藏作品附件，需要记录具体的附件ID

**隐藏对象**：
- content_id：作品基本信息ID，所有隐藏类型都需要
- detail_id：具体内容ID，根据隐藏类型不同而不同：
  - 基本信息隐藏：detail_id 可以为 NULL 或等于 content_id
  - 分卷/分季隐藏：detail_id 存储分卷ID（novel_volumes表）或分季ID（audio_seasons表、video_seasons表）
  - 章节/分集隐藏：detail_id 存储章节ID（novel_chapters表、comic_chapters表）或分集ID（audio_episodes表、video_episodes表）
  - 附件隐藏：detail_id 存储附件ID（novel_chapter_attachments表、comic_chapter_images表、audio_files表、video_files表等）

### 2. 设计作品隐藏记录表结构

设计 `content_hides` 表：

```sql
CREATE TABLE content_hides (
    id BIGSERIAL PRIMARY KEY,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    detail_id BIGINT,
    hide_type VARCHAR(30) NOT NULL,
    hide_reason TEXT NOT NULL,
    hidden_by BIGINT NOT NULL,
    hidden_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    unhidden_at TIMESTAMPTZ,
    unhidden_by BIGINT,
    is_hidden BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_content_hides_hidden_by FOREIGN KEY (hidden_by) REFERENCES users(id) ON DELETE RESTRICT,
    CONSTRAINT fk_content_hides_unhidden_by FOREIGN KEY (unhidden_by) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT ck_content_hides_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_content_hides_hide_type CHECK (hide_type IN ('basic_info', 'volume_season', 'chapter_episode', 'attachment', 'other'))
);

-- 创建索引
CREATE INDEX idx_content_hides_content_type ON content_hides(content_type);
CREATE INDEX idx_content_hides_content_id ON content_hides(content_id);
CREATE INDEX idx_content_hides_detail_id ON content_hides(detail_id);
CREATE INDEX idx_content_hides_hide_type ON content_hides(hide_type);
CREATE INDEX idx_content_hides_hidden_by ON content_hides(hidden_by);
CREATE INDEX idx_content_hides_hidden_at ON content_hides(hidden_at);
CREATE INDEX idx_content_hides_is_hidden ON content_hides(is_hidden);
CREATE INDEX idx_content_hides_content_type_id ON content_hides(content_type, content_id);
CREATE INDEX idx_content_hides_content_detail ON content_hides(content_type, content_id, detail_id);
CREATE INDEX idx_content_hides_type_detail ON content_hides(hide_type, detail_id);
CREATE INDEX idx_content_hides_content_hidden ON content_hides(content_type, content_id, is_hidden);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_content_hides_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_content_hides_updated_at
    BEFORE UPDATE ON content_hides
    FOR EACH ROW
    EXECUTE FUNCTION update_content_hides_updated_at();

-- 添加表注释
COMMENT ON TABLE content_hides IS '作品隐藏记录表，存储作品隐藏记录，支持隐藏不同类型内容的不同部分，记录作品基本信息和具体内容的隐藏';
COMMENT ON COLUMN content_hides.id IS '隐藏ID，自增主键';
COMMENT ON COLUMN content_hides.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN content_hides.content_id IS '内容ID，关联对应内容表（novels表、comics表、audios表、videos表）的主键，所有隐藏类型都需要';
COMMENT ON COLUMN content_hides.detail_id IS '具体内容ID，根据隐藏类型不同而不同：基本信息隐藏时可为NULL或等于content_id；分卷/分季隐藏时存储分卷ID（novel_volumes表）或分季ID（audio_seasons表、video_seasons表）；章节/分集隐藏时存储章节ID（novel_chapters表、comic_chapters表）或分集ID（audio_episodes表、video_episodes表）；附件隐藏时存储附件ID（novel_chapter_attachments表、comic_chapter_images表、audio_files表、video_files表等）';
COMMENT ON COLUMN content_hides.hide_type IS '隐藏类型：basic_info-基本信息、volume_season-分卷/分季、chapter_episode-章节/分集、attachment-附件、other-其他';
COMMENT ON COLUMN content_hides.hide_reason IS '隐藏说明，编辑填写的隐藏原因和建议，作者可根据此说明进行修改';
COMMENT ON COLUMN content_hides.hidden_by IS '隐藏人员ID，外键关联users表，记录执行隐藏操作的编辑或审核人员，删除时限制删除（RESTRICT）以确保记录完整性';
COMMENT ON COLUMN content_hides.hidden_at IS '隐藏时间，执行隐藏操作的时间';
COMMENT ON COLUMN content_hides.unhidden_at IS '解除隐藏时间，解除隐藏操作的时间';
COMMENT ON COLUMN content_hides.unhidden_by IS '解除隐藏人员ID，外键关联users表，记录执行解除隐藏操作的人员';
COMMENT ON COLUMN content_hides.is_hidden IS '是否隐藏中，TRUE-当前处于隐藏状态，FALSE-已解除隐藏';
COMMENT ON COLUMN content_hides.created_at IS '创建时间，自动设置为当前时间，即隐藏记录创建的时间';
COMMENT ON COLUMN content_hides.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_content_hides` (id)
- **外键约束**：
  - `fk_content_hides_hidden_by`：hidden_by 关联 users 表，删除用户时限制删除（RESTRICT）以确保记录完整性
  - `fk_content_hides_unhidden_by`：unhidden_by 关联 users 表，删除用户时设置为 NULL
- **非空约束**：content_type、content_id、hide_type、hide_reason、hidden_by 必须非空
- **检查约束**：
  - `ck_content_hides_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_content_hides_hide_type`：hide_type 必须是预定义的值之一（basic_info、volume_season、chapter_episode、attachment、other）
- **默认值**：
  - hidden_at 默认为当前时间
  - is_hidden 默认为 TRUE

### 4. 设计索引

- **主键索引**：`pk_content_hides` (id) - 自动创建
- **主键索引**：`pk_content_hides` (id) - 自动创建
- **普通索引**：
  - `idx_content_hides_content_type` (content_type) - 用于按内容类型查询
  - `idx_content_hides_content_id` (content_id) - 用于查询特定作品的隐藏记录
  - `idx_content_hides_detail_id` (detail_id) - 用于查询特定具体内容的隐藏记录（如章节、分卷、附件等）
  - `idx_content_hides_hide_type` (hide_type) - 用于按隐藏类型查询
  - `idx_content_hides_hidden_by` (hidden_by) - 用于查询隐藏人员执行的隐藏操作
  - `idx_content_hides_hidden_at` (hidden_at) - 用于按隐藏时间排序和查询
  - `idx_content_hides_is_hidden` (is_hidden) - 用于查询当前隐藏中的记录
- **复合索引**：
  - `idx_content_hides_content_type_id` (content_type, content_id) - 用于查询特定作品的隐藏记录
  - `idx_content_hides_content_detail` (content_type, content_id, detail_id) - 用于查询特定作品和具体内容的隐藏记录
  - `idx_content_hides_type_detail` (hide_type, detail_id) - 用于按隐藏类型查询特定具体内容的隐藏记录
  - `idx_content_hides_content_hidden` (content_type, content_id, is_hidden) - 用于查询特定作品当前是否隐藏

### 5. 考虑性能优化

- 为 content_type 和 content_id 创建索引，支持快速查询特定作品的隐藏记录
- 为 detail_id 创建索引，支持快速查询特定具体内容的隐藏记录（如章节、分卷、附件等）
- 创建复合索引 (content_type, content_id)，优化查询特定作品隐藏记录的性能
- 创建复合索引 (content_type, content_id, detail_id)，优化查询特定作品和具体内容隐藏记录的性能
- 创建复合索引 (hide_type, detail_id)，优化按隐藏类型查询特定具体内容隐藏记录的性能
- 创建复合索引 (content_type, content_id, is_hidden)，优化查询特定作品当前隐藏状态的性能
- 为 is_hidden 创建索引，支持查询当前隐藏中的记录
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**隐藏流程**：
1. 编辑发现作品内容有问题，执行隐藏操作
2. 根据隐藏类型，设置 content_id 和 detail_id：
   - 基本信息隐藏：content_id 为作品ID，detail_id 为 NULL 或等于 content_id
   - 分卷/分季隐藏：content_id 为作品ID，detail_id 为分卷ID或分季ID
   - 章节/分集隐藏：content_id 为作品ID，detail_id 为章节ID或分集ID
   - 附件隐藏：content_id 为作品ID，detail_id 为附件ID
3. 系统创建隐藏记录，设置 is_hidden 为 TRUE，记录 hidden_by 和 hidden_at
4. 填写 hide_reason（隐藏说明），告知作者需要修改的内容
5. 隐藏后，前台不会展示对应的内容

**解除隐藏流程**：
1. 作者根据隐藏说明修改内容后，编辑检查确认
2. 编辑执行解除隐藏操作
3. 更新 unhidden_at 和 unhidden_by，设置 is_hidden 为 FALSE
4. 解除隐藏后，内容重新在前台展示

**隐藏类型和detail_id对应关系**：
- basic_info（基本信息）：
  - content_id：作品ID（novels.id、comics.id、audios.id、videos.id）
  - detail_id：NULL 或等于 content_id
- volume_season（分卷/分季）：
  - content_id：作品ID
  - detail_id：分卷ID（novel_volumes.id）或分季ID（audio_seasons.id、video_seasons.id）
- chapter_episode（章节/分集）：
  - content_id：作品ID
  - detail_id：章节ID（novel_chapters.id、comic_chapters.id）或分集ID（audio_episodes.id、video_episodes.id）
- attachment（附件）：
  - content_id：作品ID
  - detail_id：附件ID（novel_chapter_attachments.id、comic_chapter_images.id、audio_files.id、video_files.id等）
- other（其他）：
  - content_id：作品ID
  - detail_id：根据具体情况确定

**数据完整性**：
- 使用 RESTRICT 约束确保隐藏人员（hidden_by）的记录完整性，避免误删导致无法追溯隐藏操作
- 解除隐藏人员（unhidden_by）可以使用 SET NULL，因为解除操作相对次要

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按作品查询、按具体内容查询、按隐藏状态查询、按隐藏人员查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持隐藏人员和解除隐藏人员关联，使用 RESTRICT 保护关键记录
7. 检查约束正确设置，确保内容类型和隐藏类型的值有效
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 10.3 节 - 作品管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 10.3 节 - 作品管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:10:08 CST

