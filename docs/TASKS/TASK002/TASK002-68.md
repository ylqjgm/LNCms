# TASK002-68: 数据库设计 - 核心模块 - 作品审核记录表

## 任务信息

**任务编号**: TASK002-68  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 作品审核记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:10:08 CST

## 任务描述

设计核心模块的作品审核记录表（content_audits），用于存储作品审核记录。支持不同类型内容（小说、漫画、音频、视频）的审核，支持多种审核类型（基本信息、分卷/分季、章节/分集、附件等），记录审核状态、审核人员和审核意见。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解作品审核的详细需求：

**功能需求**：
- 针对编辑名下作者提交的作品进行管理
- 作品审核依据作者等级，会出现基本信息审核、分卷/分季、章节/分集、附件等审核
- 所需审核内容，由作者等级进行确定

**审核类型**：
- 基本信息审核：审核作品的基本信息（名称、分类、标签、简介等），对应 content_id
- 分卷/分季审核：审核分卷或分季信息，需要记录具体的分卷ID或分季ID
- 章节/分集审核：审核章节或分集内容，需要记录具体的章节ID或分集ID
- 附件审核：审核作品附件，需要记录具体的附件ID

**审核对象**：
- content_id：作品基本信息ID，所有审核类型都需要
- detail_id：具体内容ID，根据审核类型不同而不同：
  - 基本信息审核：detail_id 可以为 NULL 或等于 content_id
  - 分卷/分季审核：detail_id 存储分卷ID（novel_volumes表）或分季ID（audio_seasons表、video_seasons表）
  - 章节/分集审核：detail_id 存储章节ID（novel_chapters表、comic_chapters表）或分集ID（audio_episodes表、video_episodes表）
  - 附件审核：detail_id 存储附件ID（novel_chapter_attachments表、audio_files表、video_files表等）

**审核状态**：
- 待审核：提交审核，等待审核
- 已通过：审核通过
- 已拒绝：审核被拒绝

### 2. 设计作品审核记录表结构

设计 `content_audits` 表：

```sql
CREATE TABLE content_audits (
    id BIGSERIAL PRIMARY KEY,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    detail_id BIGINT,
    audit_type VARCHAR(30) NOT NULL,
    audit_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    auditor_id BIGINT,
    audit_time TIMESTAMPTZ,
    audit_opinion TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_content_audits_auditor_id FOREIGN KEY (auditor_id) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT ck_content_audits_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_content_audits_audit_type CHECK (audit_type IN ('basic_info', 'volume_season', 'chapter_episode', 'attachment', 'other'))
);

-- 创建索引
CREATE INDEX idx_content_audits_content_type ON content_audits(content_type);
CREATE INDEX idx_content_audits_content_id ON content_audits(content_id);
CREATE INDEX idx_content_audits_detail_id ON content_audits(detail_id);
CREATE INDEX idx_content_audits_audit_type ON content_audits(audit_type);
CREATE INDEX idx_content_audits_audit_status ON content_audits(audit_status);
CREATE INDEX idx_content_audits_auditor_id ON content_audits(auditor_id);
CREATE INDEX idx_content_audits_audit_time ON content_audits(audit_time);
CREATE INDEX idx_content_audits_content_type_id ON content_audits(content_type, content_id);
CREATE INDEX idx_content_audits_content_detail ON content_audits(content_type, content_id, detail_id);
CREATE INDEX idx_content_audits_type_detail ON content_audits(audit_type, detail_id);
CREATE INDEX idx_content_audits_status_time ON content_audits(audit_status, audit_time);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_content_audits_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_content_audits_updated_at
    BEFORE UPDATE ON content_audits
    FOR EACH ROW
    EXECUTE FUNCTION update_content_audits_updated_at();

-- 添加表注释
COMMENT ON TABLE content_audits IS '作品审核记录表，存储作品审核记录，支持不同类型内容的多种审核类型，记录作品基本信息和具体内容的审核';
COMMENT ON COLUMN content_audits.id IS '审核ID，自增主键';
COMMENT ON COLUMN content_audits.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN content_audits.content_id IS '内容ID，关联对应内容表（novels表、comics表、audios表、videos表）的主键，所有审核类型都需要';
COMMENT ON COLUMN content_audits.detail_id IS '具体内容ID，根据审核类型不同而不同：基本信息审核时可为NULL或等于content_id；分卷/分季审核时存储分卷ID（novel_volumes表）或分季ID（audio_seasons表、video_seasons表）；章节/分集审核时存储章节ID（novel_chapters表、comic_chapters表）或分集ID（audio_episodes表、video_episodes表）；附件审核时存储附件ID（novel_chapter_attachments表、comic_chapter_images表、audio_files表、video_files表等）';
COMMENT ON COLUMN content_audits.audit_type IS '审核类型：basic_info-基本信息、volume_season-分卷/分季、chapter_episode-章节/分集、attachment-附件、other-其他';
COMMENT ON COLUMN content_audits.audit_status IS '审核状态：pending-待审核、approved-已通过、rejected-已拒绝';
COMMENT ON COLUMN content_audits.auditor_id IS '审核人员ID，外键关联users表，记录进行审核的人员';
COMMENT ON COLUMN content_audits.audit_time IS '审核时间，审核人员进行审核的时间';
COMMENT ON COLUMN content_audits.audit_opinion IS '审核意见，审核人员填写的审核意见和建议';
COMMENT ON COLUMN content_audits.created_at IS '创建时间，自动设置为当前时间，即提交审核的时间';
COMMENT ON COLUMN content_audits.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_content_audits` (id)
- **外键约束**：
  - `fk_content_audits_auditor_id`：auditor_id 关联 users 表，删除用户时设置为 NULL
- **非空约束**：content_type、content_id、audit_type、audit_status 必须非空
- **检查约束**：
  - `ck_content_audits_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_content_audits_audit_type`：audit_type 必须是预定义的值之一（basic_info、volume_season、chapter_episode、attachment、other）
  - `ck_content_audits_audit_status`：audit_status 必须是预定义的值之一（pending、approved、rejected）
- **默认值**：
  - audit_status 默认为 'pending'
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_content_audits` (id) - 自动创建
- **普通索引**：
  - `idx_content_audits_content_type` (content_type) - 用于按内容类型查询
  - `idx_content_audits_content_id` (content_id) - 用于查询特定作品的审核记录
  - `idx_content_audits_detail_id` (detail_id) - 用于查询特定具体内容的审核记录（如章节、分卷、附件等）
  - `idx_content_audits_audit_type` (audit_type) - 用于按审核类型查询
  - `idx_content_audits_audit_status` (audit_status) - 用于查询待审核、已通过、已拒绝的记录
  - `idx_content_audits_auditor_id` (auditor_id) - 用于查询审核人员的审核记录
  - `idx_content_audits_audit_time` (audit_time) - 用于按审核时间排序和查询
- **复合索引**：
  - `idx_content_audits_content_type_id` (content_type, content_id) - 用于查询特定作品的审核记录
  - `idx_content_audits_content_detail` (content_type, content_id, detail_id) - 用于查询特定作品和具体内容的审核记录
  - `idx_content_audits_type_detail` (audit_type, detail_id) - 用于按审核类型查询特定具体内容的审核记录
  - `idx_content_audits_status_time` (audit_status, audit_time) - 用于查询特定状态的审核记录并按时间排序

### 5. 考虑性能优化

- 为 content_type 和 content_id 创建索引，支持快速查询特定作品的审核记录
- 为 detail_id 创建索引，支持快速查询特定具体内容的审核记录（如章节、分卷、附件等）
- 创建复合索引 (content_type, content_id)，优化查询特定作品审核记录的性能
- 创建复合索引 (content_type, content_id, detail_id)，优化查询特定作品和具体内容审核记录的性能
- 创建复合索引 (audit_type, detail_id)，优化按审核类型查询特定具体内容审核记录的性能
- 为 audit_status 创建索引，支持查询待审核、已通过、已拒绝的记录
- 创建复合索引 (audit_status, audit_time)，优化按状态查询并按时间排序的性能
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**审核流程**：
1. 作者提交作品或内容后，系统创建审核记录，状态为 'pending'
2. 根据审核类型，设置 content_id 和 detail_id：
   - 基本信息审核：content_id 为作品ID，detail_id 为 NULL 或等于 content_id
   - 分卷/分季审核：content_id 为作品ID，detail_id 为分卷ID或分季ID
   - 章节/分集审核：content_id 为作品ID，detail_id 为章节ID或分集ID
   - 附件审核：content_id 为作品ID，detail_id 为附件ID
3. 编辑或审核人员查看待审核记录，进行审核
4. 审核完成后，更新 audit_status 为 'approved' 或 'rejected'
5. 记录 audit_time 和 audit_opinion

**多级审核**：
- 根据作者等级，可能需要多级审核
- 不同审核类型可能有不同的审核要求
- 可以通过多次审核记录实现多级审核流程

**审核类型和detail_id对应关系**：
- basic_info（基本信息）：
  - content_id：作品ID（novels.id、comics.id、audios.id、videos.id）
  - detail_id：NULL 或等于 content_id
- volume_season（分卷/分季）：
  - content_id：作品ID
  - detail_id：分卷ID（novel_volumes.id）或分季ID（audio_seasons.id、video_seasons.id）
- chapter_episode（章节/分集）：
  - content_id：作品ID
  - detail_id：章节ID（novel_chapters.id、comic_chapters.id）或分集ID（audio_episodes.id、video_episodes.id）
- attachment（附件）：
  - content_id：作品ID
  - detail_id：附件ID（novel_chapter_attachments.id、comic_chapter_images.id、audio_files.id、video_files.id等）
- other（其他）：
  - content_id：作品ID
  - detail_id：根据具体情况确定

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按作品查询、按具体内容查询、按状态查询、按审核人员查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持审核人员关联
7. 检查约束正确设置，确保内容类型、审核类型和审核状态的值有效
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 10.3 节 - 作品管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 10.3 节 - 作品管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:10:08 CST

