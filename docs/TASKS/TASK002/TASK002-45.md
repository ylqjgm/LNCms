# TASK002-45: 数据库设计 - 存储模块 - 预览记录表

## 任务信息

**任务编号**: TASK002-45  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 存储模块 - 预览记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计存储模块的预览记录表（preview_records），用于存储文件预览记录信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-42（文件表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Storage.md` 文档，了解文件预览的详细需求：
- 文件预览：支持生成预览链接，具有时效性
- 预览记录：记录预览Token、预览链接、有效期等信息
- 预览访问时进行安全验证

### 2. 设计预览记录表结构

设计 `preview_records` 表，包含预览记录基本信息：

```sql
CREATE TABLE preview_records (
    id BIGSERIAL PRIMARY KEY,
    file_id BIGINT NOT NULL,
    preview_token VARCHAR(64) NOT NULL UNIQUE,
    preview_url VARCHAR(500) NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    access_count INTEGER DEFAULT 0,
    last_accessed_at TIMESTAMPTZ,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_preview_records_file_id FOREIGN KEY (file_id) REFERENCES files(id) ON DELETE CASCADE,
    CONSTRAINT ck_preview_records_access_count CHECK (access_count >= 0),
    CONSTRAINT ck_preview_records_expires_at CHECK (expires_at > created_at)
);

-- 创建索引
CREATE UNIQUE INDEX uk_preview_records_preview_token ON preview_records(preview_token);
CREATE INDEX idx_preview_records_file_id ON preview_records(file_id);
CREATE INDEX idx_preview_records_expires_at ON preview_records(expires_at);
CREATE INDEX idx_preview_records_is_active ON preview_records(is_active);
CREATE INDEX idx_preview_records_created_at ON preview_records(created_at);
CREATE INDEX idx_preview_records_file_active ON preview_records(file_id, is_active);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_preview_records_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_preview_records_updated_at
    BEFORE UPDATE ON preview_records
    FOR EACH ROW
    EXECUTE FUNCTION update_preview_records_updated_at();

-- 添加表注释
COMMENT ON TABLE preview_records IS '预览记录表，存储文件预览记录信息';
COMMENT ON COLUMN preview_records.id IS '预览记录ID，自增主键';
COMMENT ON COLUMN preview_records.file_id IS '文件ID，外键关联files表';
COMMENT ON COLUMN preview_records.preview_token IS '预览Token，唯一标识符，用于安全验证';
COMMENT ON COLUMN preview_records.preview_url IS '预览链接，文件预览的访问地址';
COMMENT ON COLUMN preview_records.expires_at IS '过期时间，预览链接的有效期，必须大于创建时间';
COMMENT ON COLUMN preview_records.access_count IS '访问次数，大于等于0';
COMMENT ON COLUMN preview_records.last_accessed_at IS '最后访问时间，最后一次访问预览链接的时间';
COMMENT ON COLUMN preview_records.is_active IS '是否激活，TRUE-激活，FALSE-已失效';
COMMENT ON COLUMN preview_records.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN preview_records.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_preview_records` (id)
- **外键约束**：`fk_preview_records_file_id` (file_id) 关联 files(id)，级联删除
- **唯一约束**：`uk_preview_records_preview_token` (preview_token)
- **检查约束**：`ck_preview_records_access_count` (access_count) - 确保访问次数大于等于0
- **检查约束**：`ck_preview_records_expires_at` (expires_at, created_at) - 确保过期时间大于创建时间
- **非空约束**：file_id、preview_token、preview_url、expires_at 必须非空
- **默认值**：access_count 默认为 0，is_active 默认为 TRUE
- **可选字段**：last_accessed_at 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_preview_records` (id) - 自动创建
- **唯一索引**：`uk_preview_records_preview_token` (preview_token) - 确保预览Token唯一，同时支持快速查询
- **外键索引**：`idx_preview_records_file_id` (file_id) - 用于关联查询
- **普通索引**：`idx_preview_records_expires_at` (expires_at) - 用于查询过期记录
- **普通索引**：`idx_preview_records_is_active` (is_active) - 用于按激活状态筛选
- **普通索引**：`idx_preview_records_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_preview_records_file_active` (file_id, is_active) - 用于查询文件的激活预览记录

### 5. 考虑性能优化

- 为 preview_token 创建唯一索引，支持快速查询和唯一性检查
- 为 file_id 创建索引，支持关联查询
- 为 expires_at 创建索引，支持查询过期记录
- 为 is_active 创建索引，支持按激活状态筛选查询
- 为 created_at 创建索引，支持时间排序查询
- 使用复合索引优化常用查询场景（如查询文件的激活预览记录）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 files 表
4. 唯一约束正确，确保预览Token唯一
5. 检查约束正确，确保访问次数、过期时间等是有效的值
6. 索引设计合理，支持常用查询场景（包括按预览Token查询、按文件查询、查询过期记录）
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新 updated_at 字段
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Storage.md` - 存储模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-42.md` - 文件表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

