# TASK002-31: 数据库设计 - 核心模块 - 视频分集表

## 任务信息

**任务编号**: TASK002-31  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 视频分集表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的视频分集表（video_episodes），用于存储视频分集信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-30（视频分季表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解视频管理的详细需求：
- 视频分集管理：分集名称、分集描述、分集排序、分集文件等
- 分集属于分季，需要关联视频分季表

### 2. 设计视频分集表结构

设计 `video_episodes` 表，包含视频分集基本信息：

```sql
CREATE TABLE video_episodes (
    id BIGSERIAL PRIMARY KEY,
    season_id BIGINT NOT NULL,
    episode_name VARCHAR(200) NOT NULL,
    episode_description TEXT,
    episode_order INTEGER NOT NULL DEFAULT 0,
    file_id BIGINT NOT NULL,
    duration INTEGER DEFAULT 0,
    is_published BOOLEAN DEFAULT FALSE,
    is_vip BOOLEAN DEFAULT FALSE,
    published_at TIMESTAMPTZ,
    view_count BIGINT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_video_episodes_season_id FOREIGN KEY (season_id) REFERENCES video_seasons(id) ON DELETE CASCADE,
    CONSTRAINT fk_video_episodes_file_id FOREIGN KEY (file_id) REFERENCES files(id) ON DELETE CASCADE,
    CONSTRAINT uk_video_episodes_season_id_episode_order UNIQUE (season_id, episode_order)
);

-- 创建索引
CREATE INDEX idx_video_episodes_season_id ON video_episodes(season_id);
CREATE INDEX idx_video_episodes_file_id ON video_episodes(file_id);
CREATE INDEX idx_video_episodes_episode_order ON video_episodes(episode_order);
CREATE INDEX idx_video_episodes_is_published ON video_episodes(is_published);
CREATE INDEX idx_video_episodes_is_vip ON video_episodes(is_vip);
CREATE INDEX idx_video_episodes_published_at ON video_episodes(published_at);
CREATE UNIQUE INDEX uk_video_episodes_season_id_episode_order ON video_episodes(season_id, episode_order);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_video_episodes_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_video_episodes_updated_at
    BEFORE UPDATE ON video_episodes
    FOR EACH ROW
    EXECUTE FUNCTION update_video_episodes_updated_at();

-- 添加表注释
COMMENT ON TABLE video_episodes IS '视频分集表，存储视频分集信息';
COMMENT ON COLUMN video_episodes.id IS '分集ID，自增主键';
COMMENT ON COLUMN video_episodes.season_id IS '分季ID，外键关联video_seasons表';
COMMENT ON COLUMN video_episodes.episode_name IS '分集名称';
COMMENT ON COLUMN video_episodes.episode_description IS '分集描述';
COMMENT ON COLUMN video_episodes.episode_order IS '分集排序，数字越小越靠前，用于排序显示';
COMMENT ON COLUMN video_episodes.file_id IS '文件ID，外键关联files表（存储模块）';
COMMENT ON COLUMN video_episodes.duration IS '分集时长，单位：秒';
COMMENT ON COLUMN video_episodes.is_published IS '是否发布，TRUE-已发布，FALSE-未发布';
COMMENT ON COLUMN video_episodes.is_vip IS '是否VIP分集，TRUE-VIP分集需要付费，FALSE-免费分集';
COMMENT ON COLUMN video_episodes.published_at IS '发布时间';
COMMENT ON COLUMN video_episodes.view_count IS '播放次数';
COMMENT ON COLUMN video_episodes.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN video_episodes.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_video_episodes` (id)
- **外键约束**：`fk_video_episodes_season_id` (season_id) 关联 video_seasons(id)，级联删除
- **外键约束**：`fk_video_episodes_file_id` (file_id) 关联 files(id)，级联删除（files 表在存储模块）
- **唯一约束**：`uk_video_episodes_season_id_episode_order` (season_id, episode_order) - 确保同一分季的分集排序唯一
- **非空约束**：season_id、episode_name、episode_order、file_id 必须非空
- **默认值**：episode_order 默认为 0，duration、view_count 默认为 0，is_published、is_vip 默认为 FALSE

### 4. 设计索引

- **主键索引**：`pk_video_episodes` (id) - 自动创建
- **外键索引**：`idx_video_episodes_season_id` (season_id) - 用于查询分季的分集
- **外键索引**：`idx_video_episodes_file_id` (file_id) - 用于关联查询
- **普通索引**：`idx_video_episodes_episode_order` (episode_order) - 用于排序查询
- **普通索引**：`idx_video_episodes_is_published` (is_published) - 用于发布状态筛选
- **普通索引**：`idx_video_episodes_is_vip` (is_vip) - 用于VIP状态筛选
- **普通索引**：`idx_video_episodes_published_at` (published_at) - 用于按发布时间排序
- **唯一索引**：`uk_video_episodes_season_id_episode_order` (season_id, episode_order) - 确保唯一性

### 5. 考虑性能优化

- 为 season_id 创建索引，支持快速查询分季的分集
- 为 file_id 创建索引，支持关联查询
- 为 episode_order 创建索引，支持排序查询
- 为 is_published 和 is_vip 创建索引，支持状态筛选查询
- 使用复合唯一索引，确保同一分季的分集排序唯一
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 video_seasons 和 files 表
4. 唯一约束正确，确保同一分季的分集排序唯一
5. 索引设计合理，支持常用查询场景
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-30.md` - 视频分季表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

