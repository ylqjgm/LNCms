# TASK002-34: 数据库设计 - 核心模块 - 虚拟物品表

## 任务信息

**任务编号**: TASK002-34  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 虚拟物品表  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的虚拟物品表（virtual_items），用于存储虚拟物品信息（如虚拟币、积分、VIP会员等）。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Features/Core.md` 和 `docs/Requirements/Core.md` 文档，了解虚拟物品管理的详细需求：
- 虚拟物品管理：虚拟物品添加、虚拟物品修改、虚拟物品删除、虚拟物品状态管理
- 虚拟物品用于消费流水记录，标识消费类型
- 物品类型：勋章、头衔、打赏、特效等
- 内容类型：小说、漫画、音频、视频，或通用
- 物品包含图片、价格、过期时间等信息

### 2. 设计虚拟物品表结构

设计 `virtual_items` 表，包含虚拟物品基本信息：

```sql
CREATE TABLE virtual_items (
    id BIGSERIAL PRIMARY KEY,
    item_name VARCHAR(100) NOT NULL UNIQUE,
    item_code VARCHAR(50) NOT NULL UNIQUE,
    item_type VARCHAR(20) NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    item_image VARCHAR(500),
    item_price NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    item_description TEXT,
    expires_at TIMESTAMPTZ,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_virtual_items_item_type CHECK (item_type IN ('badge', 'title', 'reward', 'effect', 'other')),
    CONSTRAINT ck_virtual_items_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video', 'common')),
    CONSTRAINT ck_virtual_items_item_price CHECK (item_price >= 0)
);

-- 创建索引
CREATE UNIQUE INDEX uk_virtual_items_item_name ON virtual_items(item_name);
CREATE UNIQUE INDEX uk_virtual_items_item_code ON virtual_items(item_code);
CREATE INDEX idx_virtual_items_item_type ON virtual_items(item_type);
CREATE INDEX idx_virtual_items_content_type ON virtual_items(content_type);
CREATE INDEX idx_virtual_items_is_active ON virtual_items(is_active);
CREATE INDEX idx_virtual_items_expires_at ON virtual_items(expires_at) WHERE expires_at IS NOT NULL;

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_virtual_items_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_virtual_items_updated_at
    BEFORE UPDATE ON virtual_items
    FOR EACH ROW
    EXECUTE FUNCTION update_virtual_items_updated_at();

-- 添加表注释
COMMENT ON TABLE virtual_items IS '虚拟物品表，存储虚拟物品信息（如勋章、头衔、打赏、特效等）';
COMMENT ON COLUMN virtual_items.id IS '虚拟物品ID，自增主键';
COMMENT ON COLUMN virtual_items.item_name IS '物品名称，唯一标识符';
COMMENT ON COLUMN virtual_items.item_code IS '物品代码，唯一标识符，用于系统内部识别';
COMMENT ON COLUMN virtual_items.item_type IS '物品类型：badge-勋章、title-头衔、reward-打赏、effect-特效、other-其他';
COMMENT ON COLUMN virtual_items.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频、common-通用';
COMMENT ON COLUMN virtual_items.item_image IS '物品图片URL，用于展示物品图片';
COMMENT ON COLUMN virtual_items.item_price IS '物品价格，虚拟货币单位，用于计算消费金额';
COMMENT ON COLUMN virtual_items.item_description IS '物品描述，说明物品的用途和特点';
COMMENT ON COLUMN virtual_items.expires_at IS '过期时间，NULL表示永久有效，TIMESTAMP表示过期时间';
COMMENT ON COLUMN virtual_items.is_active IS '是否启用，TRUE-启用，FALSE-禁用';
COMMENT ON COLUMN virtual_items.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN virtual_items.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_virtual_items` (id)
- **唯一约束**：`uk_virtual_items_item_name` (item_name)、`uk_virtual_items_item_code` (item_code)
- **检查约束**：
  - `ck_virtual_items_item_type` (item_type) - 确保物品类型是预定义的值（badge、title、reward、effect、other）
  - `ck_virtual_items_content_type` (content_type) - 确保内容类型是预定义的值（novel、comic、audio、video、common）
  - `ck_virtual_items_item_price` (item_price) - 确保价格大于等于0
- **非空约束**：item_name、item_code、item_type、content_type、item_price 必须非空
- **默认值**：item_price 默认为 0.00，is_active 默认为 TRUE
- **可选字段**：item_image、item_description、expires_at 可为空

### 4. 设计索引

- **主键索引**：`pk_virtual_items` (id) - 自动创建
- **唯一索引**：`uk_virtual_items_item_name` (item_name) - 确保物品名称唯一
- **唯一索引**：`uk_virtual_items_item_code` (item_code) - 确保物品代码唯一
- **普通索引**：`idx_virtual_items_item_type` (item_type) - 用于按物品类型筛选
- **普通索引**：`idx_virtual_items_content_type` (content_type) - 用于按内容类型筛选
- **普通索引**：`idx_virtual_items_is_active` (is_active) - 用于状态筛选
- **部分索引**：`idx_virtual_items_expires_at` (expires_at) - 用于查询过期物品，仅索引非空值

### 5. 考虑性能优化

- 为 item_name 和 item_code 创建唯一索引，支持快速查询和唯一性检查
- 为 item_type 创建索引，支持按物品类型筛选查询
- 为 content_type 创建索引，支持按内容类型筛选查询
- 为 is_active 创建索引，支持状态筛选查询
- 为 expires_at 创建部分索引（仅索引非空值），支持查询过期物品
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段（物品名称、描述、图片、价格、类型、内容类型、过期时间）
2. 所有字段都有适当的类型、约束和默认值
3. 唯一约束正确，确保物品名称和物品代码唯一
4. 检查约束正确，确保物品类型和内容类型是预定义的值，价格大于等于0
5. 物品类型枚举值正确：badge（勋章）、title（头衔）、reward（打赏）、effect（特效）、other（其他）
6. 内容类型枚举值正确：novel（小说）、comic（漫画）、audio（音频）、video（视频）、common（通用）
7. 索引设计合理，支持常用查询场景（包括部分索引用于过期时间查询）
8. 表注释和字段注释完整，使用中文
9. 触发器正确创建，自动更新 updated_at 字段
10. 表设计符合 PostgreSQL 数据库设计规范
11. 表设计符合功能概述中的虚拟物品管理需求（包含图片、价格、类型、内容类型、过期时间等字段）

## 相关文件

- `docs/Features/Core.md` - 核心模块功能概述文档（8.2 虚拟物品管理）
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.2  
**最后更新**: 2026-01-03 08:30:53 CST

