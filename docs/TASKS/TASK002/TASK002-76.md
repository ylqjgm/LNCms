# TASK002-76: 数据库设计 - 核心模块 - 备份记录表

## 任务信息

**任务编号**: TASK002-76  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 备份记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 10:00:00 CST

## 任务描述

设计核心模块的备份记录表（backup_records），用于存储备份执行记录。记录每次备份的执行情况，包括备份类型、备份状态、备份文件信息、执行时间等。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-75（自动备份配置表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解备份记录的详细需求：

**功能需求**：
- 记录每次备份的执行情况
- 支持手动备份和自动备份
- 记录备份状态、文件信息、执行时间等
- 支持备份失败时的错误信息记录

**备份类型**：
- 手动备份（manual）：用户手动触发的备份
- 自动备份（automatic）：系统自动执行的备份（基于备份配置）

**备份状态**：
- 进行中（in_progress）：备份任务正在执行
- 已完成（completed）：备份任务成功完成
- 已失败（failed）：备份任务执行失败

**备份文件信息**：
- 备份文件路径：备份文件在渠道中的完整路径
- 备份文件大小：备份文件的大小（字节）

### 2. 设计备份记录表结构

设计 `backup_records` 表：

```sql
CREATE TABLE backup_records (
    id BIGSERIAL PRIMARY KEY,
    config_id BIGINT,
    backup_type VARCHAR(20) NOT NULL,
    backup_status VARCHAR(20) NOT NULL DEFAULT 'in_progress',
    backup_file_path VARCHAR(1000),
    backup_file_size BIGINT,
    backup_start_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    backup_end_time TIMESTAMPTZ,
    backup_description TEXT,
    error_message TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_backup_records_config_id FOREIGN KEY (config_id) REFERENCES backup_configs(id) ON DELETE SET NULL,
    CONSTRAINT ck_backup_records_backup_type CHECK (backup_type IN ('manual', 'automatic')),
    CONSTRAINT ck_backup_records_backup_status CHECK (backup_status IN ('in_progress', 'completed', 'failed')),
    CONSTRAINT ck_backup_records_backup_file_size CHECK (backup_file_size IS NULL OR backup_file_size >= 0),
    CONSTRAINT ck_backup_records_backup_time CHECK (backup_end_time IS NULL OR backup_end_time >= backup_start_time)
);

-- 创建索引
CREATE INDEX idx_backup_records_config_id ON backup_records(config_id);
CREATE INDEX idx_backup_records_backup_type ON backup_records(backup_type);
CREATE INDEX idx_backup_records_backup_status ON backup_records(backup_status);
CREATE INDEX idx_backup_records_backup_start_time ON backup_records(backup_start_time);
CREATE INDEX idx_backup_records_backup_end_time ON backup_records(backup_end_time);
CREATE INDEX idx_backup_records_created_at ON backup_records(created_at);
CREATE INDEX idx_backup_records_config_status ON backup_records(config_id, backup_status);
CREATE INDEX idx_backup_records_status_time ON backup_records(backup_status, backup_start_time);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_backup_records_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_backup_records_updated_at
    BEFORE UPDATE ON backup_records
    FOR EACH ROW
    EXECUTE FUNCTION update_backup_records_updated_at();

-- 添加表注释
COMMENT ON TABLE backup_records IS '备份记录表，存储备份执行记录，记录每次备份的执行情况';
COMMENT ON COLUMN backup_records.id IS '记录ID，自增主键';
COMMENT ON COLUMN backup_records.config_id IS '配置ID，外键关联backup_configs表，自动备份时关联备份配置，手动备份时可以为NULL';
COMMENT ON COLUMN backup_records.backup_type IS '备份类型：manual-手动备份、automatic-自动备份';
COMMENT ON COLUMN backup_records.backup_status IS '备份状态：in_progress-进行中、completed-已完成、failed-已失败';
COMMENT ON COLUMN backup_records.backup_file_path IS '备份文件路径，备份文件在渠道中的完整路径，备份完成后填充';
COMMENT ON COLUMN backup_records.backup_file_size IS '备份文件大小，单位：字节，备份完成后填充，必须大于等于0';
COMMENT ON COLUMN backup_records.backup_start_time IS '备份开始时间，备份任务开始执行的时间，默认为当前时间';
COMMENT ON COLUMN backup_records.backup_end_time IS '备份结束时间，备份任务完成或失败的时间，必须大于等于开始时间';
COMMENT ON COLUMN backup_records.backup_description IS '备份说明，用户填写的备份说明或系统自动生成的说明';
COMMENT ON COLUMN backup_records.error_message IS '错误信息，备份失败时记录的错误信息，包括错误代码和错误描述';
COMMENT ON COLUMN backup_records.created_at IS '创建时间，自动设置为当前时间，即备份记录创建的时间';
COMMENT ON COLUMN backup_records.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_backup_records` (id)
- **外键约束**：
  - `fk_backup_records_config_id`：config_id 关联 backup_configs 表，删除备份配置时设置为 NULL（保留备份记录）
- **非空约束**：backup_type、backup_status、backup_start_time 必须非空
- **检查约束**：
  - `ck_backup_records_backup_type`：backup_type 必须是预定义的值之一（manual、automatic）
  - `ck_backup_records_backup_status`：backup_status 必须是预定义的值之一（in_progress、completed、failed）
  - `ck_backup_records_backup_file_size`：backup_file_size 如果存在，必须大于等于 0
  - `ck_backup_records_backup_time`：backup_end_time 如果存在，必须大于等于 backup_start_time
- **默认值**：
  - backup_status 默认为 'in_progress'
  - backup_start_time 默认为当前时间
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_backup_records` (id) - 自动创建
- **普通索引**：
  - `idx_backup_records_config_id` (config_id) - 用于查询特定配置的备份记录
  - `idx_backup_records_backup_type` (backup_type) - 用于按备份类型查询
  - `idx_backup_records_backup_status` (backup_status) - 用于按备份状态查询
  - `idx_backup_records_backup_start_time` (backup_start_time) - 用于按开始时间排序和查询
  - `idx_backup_records_backup_end_time` (backup_end_time) - 用于按结束时间排序和查询
  - `idx_backup_records_created_at` (created_at) - 用于按创建时间排序和查询
- **复合索引**：
  - `idx_backup_records_config_status` (config_id, backup_status) - 用于查询特定配置特定状态的备份记录
  - `idx_backup_records_status_time` (backup_status, backup_start_time) - 用于查询特定状态并按时间排序（如查询进行中的备份、查询失败的备份等）

### 5. 考虑性能优化

- 为 config_id 创建索引，支持快速查询特定配置的备份记录
- 创建复合索引 (config_id, backup_status)，优化查询特定配置特定状态记录的性能
- 创建复合索引 (backup_status, backup_start_time)，优化查询特定状态并按时间排序的性能
- 为备份时间字段创建索引，支持按时间范围查询和排序
- 使用 BIGINT 类型存储文件大小，支持大文件
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**备份类型说明**：
- **manual（手动备份）**：用户手动触发的备份，config_id 可以为 NULL，需要用户指定备份参数
- **automatic（自动备份）**：系统根据备份配置自动执行的备份，config_id 关联备份配置

**备份状态流转**：
1. **创建备份记录**：
   - 备份任务开始时，创建备份记录
   - backup_status 设置为 'in_progress'
   - backup_start_time 设置为当前时间
   - backup_file_path 和 backup_file_size 为 NULL

2. **备份进行中**：
   - backup_status 保持为 'in_progress'
   - 系统执行备份操作

3. **备份完成**：
   - backup_status 更新为 'completed'
   - backup_end_time 设置为当前时间
   - backup_file_path 设置为备份文件的完整路径
   - backup_file_size 设置为备份文件的大小（字节）

4. **备份失败**：
   - backup_status 更新为 'failed'
   - backup_end_time 设置为当前时间
   - error_message 记录错误信息（包括错误代码和错误描述）
   - backup_file_path 和 backup_file_size 保持为 NULL

**备份文件路径**：
- 备份文件路径格式：`{storage_path}/{backup_type}/{YYYYMMDD_HHMMSS}_{config_name}.tar.gz`
- 例如：`/backups/daily/automatic/20260103_020000_daily_backup.tar.gz`

**备份保留机制**：
- 系统根据备份配置的 retention_count 自动清理旧备份
- 删除最旧的备份记录（按 backup_start_time 排序）
- 同时删除对应的备份文件

**错误信息格式**：
- error_message 可以包含错误代码和详细描述
- 格式示例：`ERROR_CODE: 错误描述信息`
- 例如：`BACKUP_FAILED: 无法连接到备份渠道，请检查渠道配置`

**备份说明**：
- 手动备份时，用户可以填写备份说明
- 自动备份时，系统自动生成说明，如：`自动备份 - 每日数据备份`

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按配置查询、按类型查询、按状态查询、按时间查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持备份配置关联（删除配置时保留记录）
7. 检查约束正确设置，确保备份类型、备份状态、文件大小和时间关系的值有效
8. 使用 BIGINT 类型存储文件大小，支持大文件
9. 创建复合索引优化查询性能
10. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 11.1 节 - 备份管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 11.1 节 - 备份管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 10:00:00 CST

