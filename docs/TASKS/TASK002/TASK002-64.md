# TASK002-64: 数据库设计 - 核心模块 - 收益规则表

## 任务信息

**任务编号**: TASK002-64  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 收益规则表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:05:36 CST

## 任务描述

设计核心模块的收益规则表（revenue_rules），用于存储作者收益配置规则。支持多种收益类型（全勤收益、订阅收益、阅读收益、收藏收益、票务收益、打赏收益、新手鼓励），每种收益类型支持多条规则，可针对不同内容类型。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解收益设置的详细需求：

**功能需求**：
- 对作者收益进行配置
- 支持多种收益类型，每种类型支持多条规则
- 支持多设定模式（可添加、修改、删除）
- 可针对不同内容类型设置不同的收益规则

**收益类型**：
1. **全勤收益**：针对作者全勤计算获取收益
   - 内容类型（小说、漫画、音频、视频）
   - 全勤类型（连续计算、范围计算等）
   - 全勤天数（若为连续计算，则表明必须在期限内必须每天更新，若为范围计算，则是在期限内进行更新数据计算）
   - 更新数量（小说按字数，漫画按图片数，音频、视频按时长）
   - 收益金额（达到全勤要求奖励多少消费货币）

2. **订阅收益**：针对读者进行作品订阅获取收益
   - 内容类型（小说、漫画、音频、视频）
   - 订阅起点（达到多少订阅后才开始进行收益计算）
   - 收益金额（每一个订阅转换为多少网站消费货币）

3. **阅读收益**：针对读者支付作品章节获取收益
   - 内容类型（小说、漫画、音频、视频）
   - 收益比例（即用户付费金额与消费货币转换比例）

4. **收藏收益**：针对用户收藏作品获取收益
   - 内容类型（小说、漫画、音频、视频）
   - 收藏起点（达到多少收藏后才开始进行收益计算）
   - 收益金额（每一个收藏转换为多少网站消费货币）

5. **票务收益**：针对用户对作品投票获取收益
   - 内容类型（小说、漫画、音频、视频）
   - 投票起点（达到多少投票后才开始进行收益计算）
   - 收益比例（每张票据应对价格与消费货币转换比例）

6. **打赏收益**：针对用户使用虚拟物品对作品打赏获取收益
   - 内容类型（小说、漫画、音频、视频）
   - 收益比例（即虚拟物品对应价格与消费货币转换比例）

7. **新手鼓励**：针对新作者进行的新手期收益设定
   - 内容类型（小说、漫画、音频、视频）
   - 期限类型（按时间、按作品数量、按章节数量等）
   - 期限数值（按时间则是天数）
   - 收益类型（全勤收益、订阅收益、阅读收益、收藏收益、票务收益、打赏收益）
   - 收益激励（在原有数值上提升多少百分比）

### 2. 设计收益规则表结构

设计 `revenue_rules` 表，使用 JSONB 存储不同收益类型的配置：

```sql
CREATE TABLE revenue_rules (
    id BIGSERIAL PRIMARY KEY,
    revenue_type VARCHAR(30) NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    rule_config JSONB NOT NULL,
    rule_name VARCHAR(100),
    rule_description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    priority INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_revenue_rules_revenue_type CHECK (revenue_type IN ('attendance', 'subscription', 'reading', 'favorite', 'vote', 'tip', 'novice')),
    CONSTRAINT ck_revenue_rules_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video'))
);

-- 创建索引
CREATE INDEX idx_revenue_rules_revenue_type ON revenue_rules(revenue_type);
CREATE INDEX idx_revenue_rules_content_type ON revenue_rules(content_type);
CREATE INDEX idx_revenue_rules_is_active ON revenue_rules(is_active);
CREATE INDEX idx_revenue_rules_priority ON revenue_rules(priority);
CREATE INDEX idx_revenue_rules_revenue_content ON revenue_rules(revenue_type, content_type);
CREATE INDEX idx_revenue_rules_content_active ON revenue_rules(content_type, is_active);
CREATE INDEX idx_revenue_rules_config ON revenue_rules USING GIN (rule_config);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_revenue_rules_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_revenue_rules_updated_at
    BEFORE UPDATE ON revenue_rules
    FOR EACH ROW
    EXECUTE FUNCTION update_revenue_rules_updated_at();

-- 添加表注释
COMMENT ON TABLE revenue_rules IS '收益规则表，存储作者收益配置规则，支持多种收益类型，每种类型支持多条规则';
COMMENT ON COLUMN revenue_rules.id IS '规则ID，自增主键';
COMMENT ON COLUMN revenue_rules.revenue_type IS '收益类型：attendance-全勤收益、subscription-订阅收益、reading-阅读收益、favorite-收藏收益、vote-票务收益、tip-打赏收益、novice-新手鼓励';
COMMENT ON COLUMN revenue_rules.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN revenue_rules.rule_config IS '规则配置，JSONB格式存储，根据不同的收益类型存储不同的配置项。全勤收益：{"attendance_type": "连续/范围", "days": 天数, "update_count": 更新数量, "reward_amount": 收益金额}；订阅收益：{"subscription_start": 订阅起点, "reward_amount": 收益金额}；阅读收益：{"reward_ratio": 收益比例}；收藏收益：{"favorite_start": 收藏起点, "reward_amount": 收益金额}；票务收益：{"vote_start": 投票起点, "reward_ratio": 收益比例}；打赏收益：{"reward_ratio": 收益比例}；新手鼓励：{"period_type": "时间/作品数量/章节数量", "period_value": 期限数值, "target_revenue_type": 收益类型, "reward_bonus": 收益激励百分比}';
COMMENT ON COLUMN revenue_rules.rule_name IS '规则名称，用于标识和管理收益规则';
COMMENT ON COLUMN revenue_rules.rule_description IS '规则描述，说明规则的用途和适用范围';
COMMENT ON COLUMN revenue_rules.is_active IS '是否启用，TRUE-启用，FALSE-禁用，禁用的规则不参与收益计算';
COMMENT ON COLUMN revenue_rules.priority IS '优先级，数值越大优先级越高，当存在多条规则时，按优先级生效，默认0';
COMMENT ON COLUMN revenue_rules.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN revenue_rules.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_revenue_rules` (id)
- **非空约束**：revenue_type、content_type、rule_config 必须非空
- **检查约束**：
  - `ck_revenue_rules_revenue_type`：revenue_type 必须是预定义的值之一（attendance、subscription、reading、favorite、vote、tip、novice）
  - `ck_revenue_rules_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
- **默认值**：
  - is_active 默认为 TRUE
  - priority 默认为 0

### 4. 设计索引

- **主键索引**：`pk_revenue_rules` (id) - 自动创建
- **普通索引**：
  - `idx_revenue_rules_revenue_type` (revenue_type) - 用于按收益类型查询
  - `idx_revenue_rules_content_type` (content_type) - 用于按内容类型查询
  - `idx_revenue_rules_is_active` (is_active) - 用于筛选启用的规则
  - `idx_revenue_rules_priority` (priority) - 用于按优先级排序
- **复合索引**：
  - `idx_revenue_rules_revenue_content` (revenue_type, content_type) - 用于按收益类型和内容类型组合查询
  - `idx_revenue_rules_content_active` (content_type, is_active) - 用于按内容类型查询启用的规则
- **GIN 索引**：
  - `idx_revenue_rules_config` (rule_config) - 用于 JSONB 字段的高效查询

### 5. 考虑性能优化

- 为 revenue_type 和 content_type 创建索引，支持快速查询特定收益类型或内容类型的规则
- 创建复合索引 (revenue_type, content_type)，优化按收益类型和内容类型组合查询的性能
- 创建复合索引 (content_type, is_active)，优化查询特定内容类型启用的规则
- 使用 GIN 索引优化 JSONB 字段的查询性能
- 使用 JSONB 类型存储规则配置，支持灵活的配置结构和高效查询
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**规则配置格式**：

1. **全勤收益（attendance）**：
```json
{
  "attendance_type": "连续/范围",
  "days": 30,
  "update_count": 10000,
  "reward_amount": 100.00
}
```

2. **订阅收益（subscription）**：
```json
{
  "subscription_start": 10,
  "reward_amount": 0.1
}
```

3. **阅读收益（reading）**：
```json
{
  "reward_ratio": 0.7
}
```

4. **收藏收益（favorite）**：
```json
{
  "favorite_start": 50,
  "reward_amount": 0.5
}
```

5. **票务收益（vote）**：
```json
{
  "vote_start": 100,
  "reward_ratio": 0.5
}
```

6. **打赏收益（tip）**：
```json
{
  "reward_ratio": 0.8
}
```

7. **新手鼓励（novice）**：
```json
{
  "period_type": "时间/作品数量/章节数量",
  "period_value": 30,
  "target_revenue_type": "favorite",
  "reward_bonus": 10
}
```

**规则匹配逻辑**：
1. 当作者产生收益时，系统根据收益类型和内容类型查找对应的收益规则
2. 如果存在多条规则，按照优先级（priority）排序，优先级高的规则优先生效
3. 只有 is_active 为 TRUE 的规则才会被使用
4. 根据 rule_config 中的配置计算实际收益

**新手鼓励逻辑**：
1. 新手鼓励规则会叠加在基础收益规则之上
2. 当作者符合新手期条件时（根据 period_type 和 period_value 判断）
3. 对 target_revenue_type 指定的收益类型，在原有收益基础上增加 reward_bonus 百分比的额外收益
4. 例如：基础收藏收益1消费货币，新手鼓励10%，最终收益 = 1 × (1 + 10%) = 1.1 消费货币

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按收益类型、内容类型查询，组合查询，JSONB查询）
4. 表注释和字段注释完整，使用中文，详细说明每种收益类型的配置格式
5. 触发器正确创建，自动更新 updated_at 字段
6. 检查约束正确设置，确保收益类型和内容类型的值有效
7. 使用 JSONB 类型存储规则配置，支持灵活的配置结构
8. 使用 GIN 索引优化 JSONB 字段的查询性能
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 3.2 节 - 收益设置）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 3.2 节 - 收益设置）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:05:36 CST

