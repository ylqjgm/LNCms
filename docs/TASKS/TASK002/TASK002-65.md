# TASK002-65: 数据库设计 - 核心模块 - 结算设置表

## 任务信息

**任务编号**: TASK002-65  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 结算设置表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:05:36 CST

## 任务描述

设计核心模块的结算设置表（settlement_configs），用于存储作者结算周期配置。支持按周期结算和按最低支付金额结算两种结算类型，可针对不同内容类型设置不同的结算规则。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解结算设置的详细需求：

**功能需求**：
- 针对作者结算周期进行设置
- 支持不同内容类型设置不同的结算规则
- 支持两种结算类型：按周期结算、按最低支付金额结算

**配置项**：
- 内容类型（小说、漫画、音频、视频）
- 结算类型（按周期结算、按最低支付金额结算）
- 结算时间（按周期结算时有效，可以使用 Cron 表达式或具体时间）
- 最低支付金额（按最低支付金额结算时有效，此处金额为消费货币）
- 结算比例（即每一元现实金额对应多少消费货币）

### 2. 设计结算设置表结构

设计 `settlement_configs` 表，使用 JSONB 存储结算时间配置：

```sql
CREATE TABLE settlement_configs (
    id BIGSERIAL PRIMARY KEY,
    content_type VARCHAR(20) NOT NULL UNIQUE,
    settlement_type VARCHAR(20) NOT NULL,
    settlement_time JSONB,
    min_payment_amount NUMERIC(10, 2),
    settlement_ratio NUMERIC(10, 4) NOT NULL DEFAULT 1.0,
    config_name VARCHAR(100),
    config_description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_settlement_configs_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_settlement_configs_settlement_type CHECK (settlement_type IN ('cycle', 'min_amount')),
    CONSTRAINT ck_settlement_configs_min_payment_amount CHECK (min_payment_amount IS NULL OR min_payment_amount >= 0),
    CONSTRAINT ck_settlement_configs_settlement_ratio CHECK (settlement_ratio > 0)
);

-- 创建索引
CREATE INDEX idx_settlement_configs_content_type ON settlement_configs(content_type);
CREATE INDEX idx_settlement_configs_settlement_type ON settlement_configs(settlement_type);
CREATE INDEX idx_settlement_configs_is_active ON settlement_configs(is_active);
CREATE UNIQUE INDEX uk_settlement_configs_content_type ON settlement_configs(content_type);
CREATE INDEX idx_settlement_configs_time ON settlement_configs USING GIN (settlement_time);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_settlement_configs_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_settlement_configs_updated_at
    BEFORE UPDATE ON settlement_configs
    FOR EACH ROW
    EXECUTE FUNCTION update_settlement_configs_updated_at();

-- 添加表注释
COMMENT ON TABLE settlement_configs IS '结算设置表，存储作者结算周期配置，支持按周期结算和按最低支付金额结算';
COMMENT ON COLUMN settlement_configs.id IS '配置ID，自增主键';
COMMENT ON COLUMN settlement_configs.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频，每种内容类型只能有一条结算配置';
COMMENT ON COLUMN settlement_configs.settlement_type IS '结算类型：cycle-按周期结算、min_amount-按最低支付金额结算';
COMMENT ON COLUMN settlement_configs.settlement_time IS '结算时间，JSONB格式存储。当结算类型为cycle时，存储结算时间配置，支持Cron表达式或具体时间：{"cron": "0 0 1 * *"} 或 {"time": "每月1日0点"}。当结算类型为min_amount时，此字段可为NULL';
COMMENT ON COLUMN settlement_configs.min_payment_amount IS '最低支付金额，当结算类型为min_amount时有效，单位：消费货币。当作者收益达到此金额时，可以申请结算。当结算类型为cycle时，此字段为NULL';
COMMENT ON COLUMN settlement_configs.settlement_ratio IS '结算比例，即每一元现实金额对应多少消费货币，默认1.0（1元=1消费货币）。例如：如果设置为1.5，则100消费货币=66.67元';
COMMENT ON COLUMN settlement_configs.config_name IS '配置名称，用于标识和管理结算配置';
COMMENT ON COLUMN settlement_configs.config_description IS '配置描述，说明配置的用途和适用范围';
COMMENT ON COLUMN settlement_configs.is_active IS '是否启用，TRUE-启用，FALSE-禁用，禁用的配置不参与结算';
COMMENT ON COLUMN settlement_configs.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN settlement_configs.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_settlement_configs` (id)
- **唯一约束**：`uk_settlement_configs_content_type` (content_type) - 确保每种内容类型只有一条结算配置
- **非空约束**：content_type、settlement_type、settlement_ratio 必须非空
- **检查约束**：
  - `ck_settlement_configs_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_settlement_configs_settlement_type`：settlement_type 必须是预定义的值之一（cycle、min_amount）
  - `ck_settlement_configs_min_payment_amount`：min_payment_amount 如果存在，必须大于等于 0
  - `ck_settlement_configs_settlement_ratio`：settlement_ratio 必须大于 0
- **业务约束**：
  - 当 settlement_type 为 'cycle' 时，settlement_time 不能为 NULL
  - 当 settlement_type 为 'min_amount' 时，min_payment_amount 不能为 NULL
  - 当 settlement_type 为 'cycle' 时，min_payment_amount 应为 NULL
  - 当 settlement_type 为 'min_amount' 时，settlement_time 可为 NULL
- **默认值**：
  - settlement_ratio 默认为 1.0
  - is_active 默认为 TRUE

### 4. 设计索引

- **主键索引**：`pk_settlement_configs` (id) - 自动创建
- **唯一索引**：`uk_settlement_configs_content_type` (content_type) - 确保每种内容类型只有一条结算配置
- **普通索引**：
  - `idx_settlement_configs_settlement_type` (settlement_type) - 用于按结算类型查询
  - `idx_settlement_configs_is_active` (is_active) - 用于筛选启用的配置
- **GIN 索引**：
  - `idx_settlement_configs_time` (settlement_time) - 用于 JSONB 字段的高效查询

### 5. 考虑性能优化

- 为 content_type 创建唯一索引，确保每种内容类型只有一条结算配置，并支持快速查询
- 为 settlement_type 创建索引，支持按结算类型查询
- 使用 GIN 索引优化 JSONB 字段的查询性能
- 使用 NUMERIC 类型存储金额和比例，确保精度和计算的准确性
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**结算类型**：

1. **按周期结算（cycle）**：
   - 系统按照 settlement_time 中配置的时间自动生成结算记录
   - settlement_time 支持 Cron 表达式格式，如 "0 0 1 * *" 表示每月1日0点
   - 也可以存储具体的时间描述，如 "每月1日0点"、"每周一0点" 等
   - 到结算时间时，系统自动汇总作者在该周期内的收益，生成结算审核记录

2. **按最低支付金额结算（min_amount）**：
   - 作者收益累计达到 min_payment_amount 时，可以主动申请结算
   - 作者提交结算申请后，系统生成结算审核记录
   - 需要等待编辑审核、组长审核、部长审核等流程

**结算比例**：
- settlement_ratio 表示每一元现实金额对应多少消费货币
- 例如：settlement_ratio = 1.5，表示 1.5 消费货币 = 1 元
- 计算公式：现实金额 = 消费货币 / settlement_ratio

**配置示例**：

1. **按周期结算（每月1日）**：
```json
{
  "content_type": "novel",
  "settlement_type": "cycle",
  "settlement_time": {
    "cron": "0 0 1 * *",
    "description": "每月1日0点"
  },
  "settlement_ratio": 1.0
}
```

2. **按最低支付金额结算（100消费货币）**：
```json
{
  "content_type": "novel",
  "settlement_type": "min_amount",
  "min_payment_amount": 100.00,
  "settlement_ratio": 1.5
}
```

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按内容类型、结算类型查询，JSONB查询）
4. 表注释和字段注释完整，使用中文，详细说明结算配置的使用方式
5. 触发器正确创建，自动更新 updated_at 字段
6. 检查约束正确设置，确保内容类型、结算类型、金额和比例的值有效
7. 唯一约束正确设置，确保每种内容类型只有一条结算配置
8. 业务约束正确实现，结算类型与对应字段的逻辑关系正确
9. 使用 NUMERIC 类型存储金额和比例，确保精度
10. 使用 JSONB 类型存储结算时间配置，支持灵活的配置结构
11. 使用 GIN 索引优化 JSONB 字段的查询性能
12. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 3.3 节 - 结算设置）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 3.3 节 - 结算设置）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:05:36 CST

