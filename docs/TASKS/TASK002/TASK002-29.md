# TASK002-29: 数据库设计 - 核心模块 - 视频表

## 任务信息

**任务编号**: TASK002-29  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 视频表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的视频表（videos），用于存储视频基本信息。同时设计演职员表（crew_members）和视频演职员关联表（video_crew），用于存储视频的演职员信息（导演、编剧、演员等），演员需要关联角色信息。演职员表独立设计，不依赖作者表，演职员不需要是作者，也不需要用户关联。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-13（作者表）、TASK002-16（分类表）、TASK002-17（地区表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解视频管理的详细需求：
- 视频管理：视频信息管理，包括视频标题、简介、封面、状态等
- 视频属于作者，需要关联作者表
- 视频需要关联地区，一部视频仅关联一个地区
- 视频需要支持连载状态（连载中、已完结、断更）
- 视频需要支持是否上架标识，用以标注视频是否为收费模式
- 视频需要包含演职员信息，包括多名导演、编剧、演员等，演职员不固定
- 演员需要关联角色信息（角色名称）

### 2. 设计视频表结构

设计 `videos` 表，包含视频基本信息：

```sql
CREATE TABLE videos (
    id BIGSERIAL PRIMARY KEY,
    author_id BIGINT NOT NULL,
    category_id BIGINT,
    region_id BIGINT,
    title VARCHAR(200) NOT NULL,
    subtitle VARCHAR(200),
    description TEXT,
    cover_url VARCHAR(500),
    status VARCHAR(20) NOT NULL DEFAULT 'draft',
    serial_status VARCHAR(20) NOT NULL DEFAULT 'serializing',
    is_published BOOLEAN DEFAULT FALSE,
    is_shelved BOOLEAN DEFAULT FALSE,
    published_at TIMESTAMPTZ,
    duration INTEGER DEFAULT 0,
    view_count BIGINT DEFAULT 0,
    favorite_count BIGINT DEFAULT 0,
    rating DECIMAL(3,2) DEFAULT 0.00,
    rating_count BIGINT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_videos_author_id FOREIGN KEY (author_id) REFERENCES authors(id) ON DELETE CASCADE,
    CONSTRAINT fk_videos_category_id FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL,
    CONSTRAINT fk_videos_region_id FOREIGN KEY (region_id) REFERENCES regions(id) ON DELETE SET NULL,
    CONSTRAINT ck_videos_status CHECK (status IN ('draft', 'published', 'archived', 'deleted')),
    CONSTRAINT ck_videos_serial_status CHECK (serial_status IN ('serializing', 'completed', 'suspended'))
);

-- 创建索引
CREATE INDEX idx_videos_author_id ON videos(author_id);
CREATE INDEX idx_videos_category_id ON videos(category_id);
CREATE INDEX idx_videos_region_id ON videos(region_id);
CREATE INDEX idx_videos_title ON videos(title);
CREATE INDEX idx_videos_status ON videos(status);
CREATE INDEX idx_videos_serial_status ON videos(serial_status);
CREATE INDEX idx_videos_is_published ON videos(is_published);
CREATE INDEX idx_videos_is_shelved ON videos(is_shelved);
CREATE INDEX idx_videos_published_at ON videos(published_at);
CREATE INDEX idx_videos_created_at ON videos(created_at);
CREATE INDEX idx_videos_rating ON videos(rating);
CREATE INDEX idx_videos_author_status ON videos(author_id, status);
CREATE INDEX idx_videos_category_status ON videos(category_id, status);
CREATE INDEX idx_videos_region_status ON videos(region_id, status);
CREATE INDEX idx_videos_published_created ON videos(is_published, created_at);
CREATE INDEX idx_videos_shelved_published ON videos(is_shelved, is_published);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_videos_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_videos_updated_at
    BEFORE UPDATE ON videos
    FOR EACH ROW
    EXECUTE FUNCTION update_videos_updated_at();

-- 添加表注释
COMMENT ON TABLE videos IS '视频表，存储视频基本信息';
COMMENT ON COLUMN videos.id IS '视频ID，自增主键';
COMMENT ON COLUMN videos.author_id IS '作者ID，外键关联authors表';
COMMENT ON COLUMN videos.category_id IS '分类ID，外键关联categories表，一部视频只支持一个分类';
COMMENT ON COLUMN videos.region_id IS '地区ID，外键关联regions表，一部视频仅关联一个地区';
COMMENT ON COLUMN videos.title IS '视频标题';
COMMENT ON COLUMN videos.subtitle IS '视频副标题';
COMMENT ON COLUMN videos.description IS '视频简介';
COMMENT ON COLUMN videos.cover_url IS '封面URL，视频封面图片地址';
COMMENT ON COLUMN videos.status IS '视频状态：draft-草稿、published-已发布、archived-已归档、deleted-已删除';
COMMENT ON COLUMN videos.serial_status IS '连载状态：serializing-连载中、completed-已完结、suspended-断更';
COMMENT ON COLUMN videos.is_published IS '是否发布，TRUE-已发布，FALSE-未发布';
COMMENT ON COLUMN videos.is_shelved IS '是否上架，TRUE-已上架（收费模式），FALSE-未上架（免费模式）';
COMMENT ON COLUMN videos.published_at IS '发布时间';
COMMENT ON COLUMN videos.duration IS '时长，单位：秒';
COMMENT ON COLUMN videos.view_count IS '播放次数';
COMMENT ON COLUMN videos.favorite_count IS '收藏次数';
COMMENT ON COLUMN videos.rating IS '评分，范围0.00-10.00';
COMMENT ON COLUMN videos.rating_count IS '评分人数';
COMMENT ON COLUMN videos.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN videos.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计演职员表结构

设计 `crew_members` 表，用于存储演职员基本信息：

```sql
CREATE TABLE crew_members (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    name_en VARCHAR(100),
    avatar_url VARCHAR(500),
    biography TEXT,
    birthday DATE,
    nationality VARCHAR(50),
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_crew_members_name ON crew_members(name);
CREATE INDEX idx_crew_members_name_en ON crew_members(name_en);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_crew_members_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_crew_members_updated_at
    BEFORE UPDATE ON crew_members
    FOR EACH ROW
    EXECUTE FUNCTION update_crew_members_updated_at();

-- 添加表注释
COMMENT ON TABLE crew_members IS '演职员表，存储演职员基本信息';
COMMENT ON COLUMN crew_members.id IS '演职员ID，自增主键';
COMMENT ON COLUMN crew_members.name IS '演职员姓名（中文）';
COMMENT ON COLUMN crew_members.name_en IS '演职员姓名（英文）';
COMMENT ON COLUMN crew_members.avatar_url IS '头像URL，演职员头像图片地址';
COMMENT ON COLUMN crew_members.biography IS '演职员简介';
COMMENT ON COLUMN crew_members.birthday IS '生日';
COMMENT ON COLUMN crew_members.nationality IS '国籍';
COMMENT ON COLUMN crew_members.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN crew_members.updated_at IS '更新时间，每次更新时自动更新';
```

### 4. 设计视频演职员关联表结构

设计 `video_crew` 表，用于存储视频的演职员信息，支持多名导演、编剧、演员等，演员需要关联角色信息：

```sql
CREATE TABLE video_crew (
    id BIGSERIAL PRIMARY KEY,
    video_id BIGINT NOT NULL,
    crew_member_id BIGINT NOT NULL,
    role VARCHAR(20) NOT NULL,
    character_name VARCHAR(100),
    display_order INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_video_crew_video_id FOREIGN KEY (video_id) REFERENCES videos(id) ON DELETE CASCADE,
    CONSTRAINT fk_video_crew_crew_member_id FOREIGN KEY (crew_member_id) REFERENCES crew_members(id) ON DELETE CASCADE,
    CONSTRAINT ck_video_crew_role CHECK (role IN ('director', 'writer', 'actor', 'producer', 'cinematographer', 'editor', 'composer', 'other'))
);

-- 创建索引
CREATE INDEX idx_video_crew_video_id ON video_crew(video_id);
CREATE INDEX idx_video_crew_crew_member_id ON video_crew(crew_member_id);
CREATE INDEX idx_video_crew_role ON video_crew(role);
CREATE INDEX idx_video_crew_video_role ON video_crew(video_id, role);
CREATE INDEX idx_video_crew_display_order ON video_crew(video_id, display_order);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_video_crew_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_video_crew_updated_at
    BEFORE UPDATE ON video_crew
    FOR EACH ROW
    EXECUTE FUNCTION update_video_crew_updated_at();

-- 添加表注释
COMMENT ON TABLE video_crew IS '视频演职员关联表，存储视频的演职员信息，支持多名导演、编剧、演员等';
COMMENT ON COLUMN video_crew.id IS '关联ID，自增主键';
COMMENT ON COLUMN video_crew.video_id IS '视频ID，外键关联videos表';
COMMENT ON COLUMN video_crew.crew_member_id IS '演职员ID，外键关联crew_members表';
COMMENT ON COLUMN video_crew.role IS '角色类型：director-导演、writer-编剧、actor-演员、producer-制片人、cinematographer-摄影师、editor-剪辑师、composer-作曲、other-其他';
COMMENT ON COLUMN video_crew.character_name IS '角色名称，仅对演员（role=actor）有效，其他角色类型可为NULL';
COMMENT ON COLUMN video_crew.display_order IS '显示顺序，用于控制演职员的显示顺序，数值越小越靠前';
COMMENT ON COLUMN video_crew.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN video_crew.updated_at IS '更新时间，每次更新时自动更新';
```

### 5. 设计约束

#### 5.1 视频表约束

- **主键约束**：`pk_videos` (id)
- **外键约束**：`fk_videos_author_id` (author_id) 关联 authors(id)，级联删除
- **外键约束**：`fk_videos_category_id` (category_id) 关联 categories(id)，删除时设置为 NULL
- **外键约束**：`fk_videos_region_id` (region_id) 关联 regions(id)，删除时设置为 NULL
- **检查约束**：`ck_videos_status` (status) - 确保状态是预定义的值
- **检查约束**：`ck_videos_serial_status` (serial_status) - 确保连载状态是预定义的值
- **非空约束**：author_id、title、status、serial_status 必须非空
- **可选字段**：region_id 可为 NULL
- **默认值**：status 默认为 'draft'，serial_status 默认为 'serializing'，is_published 默认为 FALSE，is_shelved 默认为 FALSE，duration、view_count、favorite_count、rating、rating_count 默认为 0

#### 5.2 演职员表约束

- **主键约束**：`pk_crew_members` (id)
- **非空约束**：name 必须非空
- **可选字段**：name_en、avatar_url、biography、birthday、nationality 可为 NULL

#### 5.3 视频演职员关联表约束

- **主键约束**：`pk_video_crew` (id)
- **外键约束**：`fk_video_crew_video_id` (video_id) 关联 videos(id)，级联删除
- **外键约束**：`fk_video_crew_crew_member_id` (crew_member_id) 关联 crew_members(id)，级联删除
- **检查约束**：`ck_video_crew_role` (role) - 确保角色类型是预定义的值
- **非空约束**：video_id、crew_member_id、role 必须非空
- **可选字段**：character_name 可为 NULL（仅对演员有效）
- **默认值**：display_order 默认为 0

### 6. 设计索引

#### 6.1 视频表索引

- **主键索引**：`pk_videos` (id) - 自动创建
- **外键索引**：`idx_videos_author_id` (author_id) - 用于查询作者的视频
- **外键索引**：`idx_videos_category_id` (category_id) - 用于查询分类的视频
- **外键索引**：`idx_videos_region_id` (region_id) - 用于查询地区的视频
- **普通索引**：`idx_videos_title` (title) - 用于标题搜索
- **普通索引**：`idx_videos_status` (status) - 用于状态筛选
- **普通索引**：`idx_videos_serial_status` (serial_status) - 用于连载状态筛选
- **普通索引**：`idx_videos_is_published` (is_published) - 用于发布状态筛选
- **普通索引**：`idx_videos_is_shelved` (is_shelved) - 用于上架状态筛选
- **普通索引**：`idx_videos_published_at` (published_at) - 用于按发布时间排序
- **普通索引**：`idx_videos_created_at` (created_at) - 用于按创建时间排序
- **普通索引**：`idx_videos_rating` (rating) - 用于按评分排序
- **复合索引**：`idx_videos_author_status` (author_id, status) - 用于查询作者的视频并按状态筛选
- **复合索引**：`idx_videos_category_status` (category_id, status) - 用于查询分类的视频并按状态筛选
- **复合索引**：`idx_videos_region_status` (region_id, status) - 用于查询地区的视频并按状态筛选
- **复合索引**：`idx_videos_published_created` (is_published, created_at) - 用于查询已发布的视频并按时间排序
- **复合索引**：`idx_videos_shelved_published` (is_shelved, is_published) - 用于查询上架且已发布的视频

#### 6.2 演职员表索引

- **主键索引**：`pk_crew_members` (id) - 自动创建
- **普通索引**：`idx_crew_members_name` (name) - 用于姓名搜索
- **普通索引**：`idx_crew_members_name_en` (name_en) - 用于英文姓名搜索

#### 6.3 视频演职员关联表索引

- **主键索引**：`pk_video_crew` (id) - 自动创建
- **外键索引**：`idx_video_crew_video_id` (video_id) - 用于查询视频的演职员列表
- **外键索引**：`idx_video_crew_crew_member_id` (crew_member_id) - 用于查询演职员的参与作品
- **普通索引**：`idx_video_crew_role` (role) - 用于按角色类型筛选
- **复合索引**：`idx_video_crew_video_role` (video_id, role) - 用于查询视频的特定角色类型演职员
- **复合索引**：`idx_video_crew_display_order` (video_id, display_order) - 用于按显示顺序排序查询

### 7. 考虑性能优化

#### 7.1 视频表性能优化

- 为 author_id 创建索引，支持快速查询作者的视频
- 为 category_id 创建索引，支持快速查询分类的视频
- 为 region_id 创建索引，支持快速查询地区的视频
- 为 status、serial_status、is_published、is_shelved 创建索引，支持状态筛选查询
- 为 published_at 和 created_at 创建索引，支持时间排序查询
- 为 rating 创建索引，支持按评分排序
- 使用复合索引优化常用查询场景（如按地区和状态查询、按上架和发布状态查询）
- 使用触发器自动更新 updated_at 字段

#### 7.2 演职员表性能优化

- 为 name 和 name_en 创建索引，支持快速搜索演职员
- 使用触发器自动更新 updated_at 字段

#### 7.3 视频演职员关联表性能优化

- 为 video_id 创建索引，支持快速查询视频的演职员列表
- 为 crew_member_id 创建索引，支持快速查询演职员的参与作品
- 为 role 创建索引，支持按角色类型筛选
- 使用复合索引优化常用查询场景（如查询视频的特定角色类型演职员、按显示顺序排序）
- 使用触发器自动更新 updated_at 字段

#### 7.4 演职员查询示例

```sql
-- 查询视频的所有演职员，按角色类型和显示顺序排序
SELECT vc.*, cm.name, cm.name_en, cm.avatar_url
FROM video_crew vc
JOIN crew_members cm ON vc.crew_member_id = cm.id
WHERE vc.video_id = 1
ORDER BY vc.role, vc.display_order, vc.id;

-- 查询视频的所有导演
SELECT vc.*, cm.name, cm.name_en, cm.avatar_url
FROM video_crew vc
JOIN crew_members cm ON vc.crew_member_id = cm.id
WHERE vc.video_id = 1 AND vc.role = 'director'
ORDER BY vc.display_order, vc.id;

-- 查询视频的所有演员（包含角色名称）
SELECT vc.*, cm.name, cm.name_en, cm.avatar_url, vc.character_name
FROM video_crew vc
JOIN crew_members cm ON vc.crew_member_id = cm.id
WHERE vc.video_id = 1 AND vc.role = 'actor'
ORDER BY vc.display_order, vc.id;

-- 查询演职员参与的所有视频
SELECT v.*, vc.role, vc.character_name
FROM videos v
JOIN video_crew vc ON v.id = vc.video_id
WHERE vc.crew_member_id = 1
ORDER BY v.created_at DESC;
```

## 验收标准

1. 视频表结构设计完整，包含所有必要字段
2. 演职员表结构设计完整，包含演职员基本信息字段
3. 视频演职员关联表结构设计完整，支持多名导演、编剧、演员等
4. 所有字段都有适当的类型、约束和默认值
5. 视频表外键约束正确，关联 authors 表、categories 表和 regions 表
6. 视频表支持地区关联，一部视频仅关联一个地区
7. 演职员表独立设计，不依赖 authors 表，不需要用户关联和认证信息
8. 视频演职员关联表外键约束正确，关联 videos 表和 crew_members 表
9. 检查约束正确，确保状态、连载状态和角色类型是预定义的值
10. 索引设计合理，支持常用查询场景（包括连载状态查询、上架状态查询、地区查询、演职员查询）
11. 表注释和字段注释完整，使用中文
12. 触发器正确创建，自动更新 updated_at 字段
13. 表设计符合 PostgreSQL 数据库设计规范
14. 视频支持连载状态（连载中、已完结、断更）
15. 视频支持是否上架标识，用于标注收费模式
16. 视频支持演职员信息，包括多名导演、编剧、演员等，演职员不固定
17. 演员支持关联角色信息（角色名称）
18. 演职员表独立设计，与作者表分离，演职员不需要是作者，也不需要用户关联

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-13.md` - 作者表设计文档
- `docs/TASKS/TASK002/TASK002-16.md` - 分类表设计文档
- `docs/TASKS/TASK002/TASK002-17.md` - 地区表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST
