# TASK002-84: 数据库设计 - 核心模块 - 阅读记录表

## 任务信息

**任务编号**: TASK002-84  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 阅读记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 11:00:00 CST

## 任务描述

设计核心模块的阅读记录表（reading_records），用于存储用户阅读作品内容的记录和阅读进度。支持小说、漫画、音频、视频等多种内容类型，记录用户阅读的具体章节/分集和阅读进度。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-19（小说表）、TASK002-21（小说章节表）、TASK002-23（漫画表）、TASK002-24（漫画章节表）、TASK002-26（音频表）、TASK002-28（音频分集表）、TASK002-29（视频表）、TASK002-31（视频分集表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解阅读记录的需求：

**功能需求**：
- 记录用户阅读过的作品内容（章节、分集等）
- 记录阅读进度（位置、百分比等）
- 记录最后阅读时间
- 支持不同内容类型的阅读进度记录

**内容类型**：
- 小说：记录章节ID，阅读位置（字符位置或百分比）
- 漫画：记录章节ID，阅读位置（图片索引或百分比）
- 音频：记录分集ID，阅读位置（播放时间或百分比）
- 视频：记录分集ID，阅读位置（播放时间或百分比）

**阅读进度**：
- 小说：字符位置（已读字符数）或百分比
- 漫画：图片索引（已读图片数）或百分比
- 音频：播放时间（已播放秒数）或百分比
- 视频：播放时间（已播放秒数）或百分比

### 2. 设计阅读记录表结构

设计 `reading_records` 表：

```sql
CREATE TABLE reading_records (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    chapter_type VARCHAR(20) NOT NULL,
    chapter_id BIGINT NOT NULL,
    reading_position BIGINT,
    reading_percentage NUMERIC(5, 2),
    reading_duration INTEGER DEFAULT 0,
    last_read_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    is_completed BOOLEAN DEFAULT FALSE,
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_reading_records_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT ck_reading_records_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_reading_records_chapter_type CHECK (chapter_type IN ('novel_chapter', 'comic_chapter', 'audio_episode', 'video_episode')),
    CONSTRAINT ck_reading_records_content_id CHECK (content_id > 0),
    CONSTRAINT ck_reading_records_chapter_id CHECK (chapter_id > 0),
    CONSTRAINT ck_reading_records_reading_position CHECK (reading_position IS NULL OR reading_position >= 0),
    CONSTRAINT ck_reading_records_reading_percentage CHECK (reading_percentage IS NULL OR (reading_percentage >= 0 AND reading_percentage <= 100)),
    CONSTRAINT ck_reading_records_reading_duration CHECK (reading_duration >= 0),
    CONSTRAINT uk_reading_records_user_content_chapter UNIQUE (user_id, content_type, content_id, chapter_type, chapter_id)
);

-- 创建索引
CREATE INDEX idx_reading_records_user_id ON reading_records(user_id);
CREATE INDEX idx_reading_records_content_type ON reading_records(content_type);
CREATE INDEX idx_reading_records_content_id ON reading_records(content_id);
CREATE INDEX idx_reading_records_chapter_type ON reading_records(chapter_type);
CREATE INDEX idx_reading_records_chapter_id ON reading_records(chapter_id);
CREATE INDEX idx_reading_records_last_read_time ON reading_records(last_read_time);
CREATE INDEX idx_reading_records_is_completed ON reading_records(is_completed);
CREATE INDEX idx_reading_records_created_at ON reading_records(created_at);
CREATE INDEX idx_reading_records_content_type_id ON reading_records(content_type, content_id);
CREATE INDEX idx_reading_records_user_content ON reading_records(user_id, content_type, content_id);
CREATE INDEX idx_reading_records_user_last_read ON reading_records(user_id, last_read_time);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_reading_records_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_reading_records_updated_at
    BEFORE UPDATE ON reading_records
    FOR EACH ROW
    EXECUTE FUNCTION update_reading_records_updated_at();

-- 添加表注释
COMMENT ON TABLE reading_records IS '阅读记录表，存储用户阅读作品内容的记录和阅读进度';
COMMENT ON COLUMN reading_records.id IS '记录ID，自增主键';
COMMENT ON COLUMN reading_records.user_id IS '用户ID，外键关联users表，删除用户时级联删除阅读记录';
COMMENT ON COLUMN reading_records.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN reading_records.content_id IS '内容ID，关联对应内容表（novels、comics、audios、videos），必须大于0';
COMMENT ON COLUMN reading_records.chapter_type IS '章节类型：novel_chapter-小说章节、comic_chapter-漫画章节、audio_episode-音频分集、video_episode-视频分集';
COMMENT ON COLUMN reading_records.chapter_id IS '章节/分集ID，关联对应章节表（novel_chapters、comic_chapters、audio_episodes、video_episodes），必须大于0';
COMMENT ON COLUMN reading_records.reading_position IS '阅读位置，根据内容类型不同：小说为字符位置（已读字符数）、漫画为图片索引（已读图片数）、音频/视频为播放时间（已播放秒数），可以为NULL';
COMMENT ON COLUMN reading_records.reading_percentage IS '阅读百分比，0-100，表示阅读进度百分比，可以为NULL';
COMMENT ON COLUMN reading_records.reading_duration IS '阅读时长，单位：秒，累计阅读该章节/分集的总时长，默认为0';
COMMENT ON COLUMN reading_records.last_read_time IS '最后阅读时间，用户最后一次阅读该章节/分集的时间，默认为当前时间';
COMMENT ON COLUMN reading_records.is_completed IS '是否已完成，TRUE表示已完成阅读，FALSE表示未完成，默认为FALSE';
COMMENT ON COLUMN reading_records.completed_at IS '完成时间，用户完成阅读该章节/分集的时间，未完成时为NULL';
COMMENT ON COLUMN reading_records.created_at IS '创建时间，自动设置为当前时间，即首次阅读该章节/分集的时间';
COMMENT ON COLUMN reading_records.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_reading_records` (id)
- **唯一约束**：`uk_reading_records_user_content_chapter` (user_id, content_type, content_id, chapter_type, chapter_id) - 确保同一用户对同一章节/分集只有一条阅读记录
- **外键约束**：
  - `fk_reading_records_user_id`：user_id 关联 users 表，删除用户时级联删除阅读记录
- **非空约束**：user_id、content_type、content_id、chapter_type、chapter_id、last_read_time 必须非空
- **检查约束**：
  - `ck_reading_records_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_reading_records_chapter_type`：chapter_type 必须是预定义的值之一（novel_chapter、comic_chapter、audio_episode、video_episode）
  - `ck_reading_records_content_id`：content_id 必须大于 0
  - `ck_reading_records_chapter_id`：chapter_id 必须大于 0
  - `ck_reading_records_reading_position`：reading_position 如果存在，必须大于等于 0
  - `ck_reading_records_reading_percentage`：reading_percentage 如果存在，必须在 0-100 之间
  - `ck_reading_records_reading_duration`：reading_duration 必须大于等于 0
- **默认值**：
  - reading_duration 默认为 0
  - last_read_time 默认为当前时间
  - is_completed 默认为 FALSE
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_reading_records` (id) - 自动创建
- **唯一索引**：`uk_reading_records_user_content_chapter` (user_id, content_type, content_id, chapter_type, chapter_id) - 自动创建
- **普通索引**：
  - `idx_reading_records_user_id` (user_id) - 用于查询用户的阅读记录
  - `idx_reading_records_content_type` (content_type) - 用于按内容类型查询
  - `idx_reading_records_content_id` (content_id) - 用于查询作品的阅读记录
  - `idx_reading_records_chapter_type` (chapter_type) - 用于按章节类型查询
  - `idx_reading_records_chapter_id` (chapter_id) - 用于查询章节/分集的阅读记录
  - `idx_reading_records_last_read_time` (last_read_time) - 用于按最后阅读时间排序和查询
  - `idx_reading_records_is_completed` (is_completed) - 用于查询已完成或未完成的阅读记录
  - `idx_reading_records_created_at` (created_at) - 用于按创建时间排序和查询
- **复合索引**：
  - `idx_reading_records_content_type_id` (content_type, content_id) - 用于查询特定作品的阅读记录
  - `idx_reading_records_user_content` (user_id, content_type, content_id) - 用于查询用户对特定作品的阅读记录（用于收藏记录关联）
  - `idx_reading_records_user_last_read` (user_id, last_read_time) - 用于查询用户最近阅读的记录

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户的阅读记录
- 创建复合索引 (content_type, content_id)，优化查询特定作品阅读记录的性能
- 创建复合索引 (user_id, content_type, content_id)，优化查询用户对特定作品阅读记录的性能（用于收藏记录关联）
- 创建复合索引 (user_id, last_read_time)，优化查询用户最近阅读记录的性能
- 使用唯一约束确保同一用户对同一章节/分集只有一条阅读记录
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**阅读记录流程**：
1. **用户开始阅读**：
   - 用户开始阅读章节/分集时，创建或更新阅读记录
   - 如果记录不存在，创建新记录
   - 如果记录已存在，更新阅读进度和最后阅读时间
   - last_read_time 更新为当前时间
   - is_completed 保持为 FALSE

2. **更新阅读进度**：
   - 用户阅读过程中，定期更新阅读进度
   - 更新 reading_position 或 reading_percentage
   - 累计 reading_duration（阅读时长）
   - 更新 last_read_time

3. **完成阅读**：
   - 用户完成阅读章节/分集时，更新阅读记录
   - is_completed 更新为 TRUE
   - completed_at 设置为当前时间
   - reading_percentage 设置为 100（如果使用百分比）

**阅读进度记录**：
- **小说**：
  - reading_position：字符位置（已读字符数）
  - reading_percentage：阅读百分比（0-100）
- **漫画**：
  - reading_position：图片索引（已读图片数）
  - reading_percentage：阅读百分比（0-100）
- **音频**：
  - reading_position：播放时间（已播放秒数）
  - reading_percentage：播放百分比（0-100）
- **视频**：
  - reading_position：播放时间（已播放秒数）
  - reading_percentage：播放百分比（0-100）

**章节类型与内容类型对应关系**：
- novel + novel_chapter → novel_chapters 表
- comic + comic_chapter → comic_chapters 表
- audio + audio_episode → audio_episodes 表
- video + video_episode → video_episodes 表

**内容关联**：
- content_type 和 content_id 组合关联对应的内容表：
  - novel + content_id → novels 表
  - comic + content_id → comics 表
  - audio + content_id → audios 表
  - video + content_id → videos 表

**唯一性约束**：
- 同一用户对同一章节/分集只能有一条阅读记录
- 用户多次阅读同一章节/分集时，更新现有记录而不是创建新记录

**收藏记录关联**：
- 收藏记录表可以通过查询阅读记录表获取收藏作品的当前阅读进度
- 查询方式：通过 user_id、content_type、content_id 查询阅读记录，按 last_read_time 排序获取最新的阅读记录

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按用户查询、按作品查询、按章节查询、收藏记录关联查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持用户关联
7. 唯一约束正确设置，确保同一用户对同一章节/分集只有一条阅读记录
8. 检查约束正确设置，确保内容类型、章节类型、阅读位置和百分比的值有效
9. 创建复合索引优化收藏记录关联查询性能
10. 支持不同内容类型的阅读进度记录（字符位置、图片索引、播放时间等）
11. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `docs/Features/Core.md` - 核心模块功能描述文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-79.md` - 收藏记录表设计文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 11:00:00 CST

