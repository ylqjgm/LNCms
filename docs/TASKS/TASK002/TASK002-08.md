# TASK002-08: 数据库设计 - 核心模块 - 角色权限关联表

## 任务信息

**任务编号**: TASK002-08  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 角色权限关联表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的角色权限关联表（role_permissions），用于存储角色和权限的多对多关系。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-02（角色表）、TASK002-07（权限表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解权限管理的详细需求：
- 角色权限关联：角色和权限是多对多关系，一个角色可以有多个权限，一个权限可以分配给多个角色
- 用于实现基于角色的访问控制（RBAC）

### 2. 设计角色权限关联表结构

设计 `role_permissions` 表，包含角色和权限的关联关系：

```sql
CREATE TABLE role_permissions (
    id BIGSERIAL PRIMARY KEY,
    role_id BIGINT NOT NULL,
    permission_id BIGINT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_role_permissions_role_id FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    CONSTRAINT fk_role_permissions_permission_id FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    CONSTRAINT uk_role_permissions_role_id_permission_id UNIQUE (role_id, permission_id)
);

-- 创建索引
CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);
CREATE UNIQUE INDEX uk_role_permissions_role_id_permission_id ON role_permissions(role_id, permission_id);

-- 添加表注释
COMMENT ON TABLE role_permissions IS '角色权限关联表，存储角色和权限的多对多关系';
COMMENT ON COLUMN role_permissions.id IS '关联ID，自增主键';
COMMENT ON COLUMN role_permissions.role_id IS '角色ID，外键关联roles表';
COMMENT ON COLUMN role_permissions.permission_id IS '权限ID，外键关联permissions表';
COMMENT ON COLUMN role_permissions.created_at IS '创建时间，自动设置为当前时间';
```

### 3. 设计约束

- **主键约束**：`pk_role_permissions` (id)
- **外键约束**：`fk_role_permissions_role_id` (role_id) 关联 roles(id)，级联删除
- **外键约束**：`fk_role_permissions_permission_id` (permission_id) 关联 permissions(id)，级联删除
- **唯一约束**：`uk_role_permissions_role_id_permission_id` (role_id, permission_id) - 确保同一角色和权限的组合唯一
- **非空约束**：role_id、permission_id 必须非空

### 4. 设计索引

- **主键索引**：`pk_role_permissions` (id) - 自动创建
- **外键索引**：`idx_role_permissions_role_id` (role_id) - 用于快速查询角色的权限
- **外键索引**：`idx_role_permissions_permission_id` (permission_id) - 用于快速查询权限的角色
- **唯一索引**：`uk_role_permissions_role_id_permission_id` (role_id, permission_id) - 确保唯一性

### 5. 考虑性能优化

- 为 role_id 和 permission_id 创建索引，支持快速查询
- 使用复合唯一索引，确保同一角色和权限的组合唯一
- 外键约束使用 CASCADE 删除，确保数据一致性

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 roles 和 permissions 表
4. 唯一约束正确，确保同一角色和权限的组合唯一
5. 索引设计合理，支持常用查询场景
6. 表注释和字段注释完整，使用中文
7. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-02.md` - 角色表设计文档
- `docs/TASKS/TASK002/TASK002-07.md` - 权限表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST
