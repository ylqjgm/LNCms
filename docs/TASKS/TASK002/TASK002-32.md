# TASK002-32: 数据库设计 - 核心模块 - 内容标签关联表

## 任务信息

**任务编号**: TASK002-32  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 内容标签关联表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的内容标签关联表（content_tags），用于存储内容与标签的多对多关联关系。支持小说、漫画、音频、视频等多种内容类型与标签的关联。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-18（标签表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解内容标签关联的详细需求：
- 内容标签关联：内容可以关联多个标签，标签可以关联多个内容
- 支持小说、漫画、音频、视频等多种内容类型
- 标签为通用标签，可用于所有内容类型

### 2. 设计内容标签关联表结构

设计 `content_tags` 表，使用多态关联设计，支持多种内容类型：

```sql
CREATE TABLE content_tags (
    id BIGSERIAL PRIMARY KEY,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_content_tags_tag_id FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
    CONSTRAINT ck_content_tags_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT uk_content_tags_content_type_content_id_tag_id UNIQUE (content_type, content_id, tag_id)
);

-- 创建索引
CREATE INDEX idx_content_tags_content_type ON content_tags(content_type);
CREATE INDEX idx_content_tags_content_id ON content_tags(content_id);
CREATE INDEX idx_content_tags_tag_id ON content_tags(tag_id);
CREATE INDEX idx_content_tags_content_type_content_id ON content_tags(content_type, content_id);
CREATE INDEX idx_content_tags_content_type_tag_id ON content_tags(content_type, tag_id);
CREATE UNIQUE INDEX uk_content_tags_content_type_content_id_tag_id ON content_tags(content_type, content_id, tag_id);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_content_tags_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_content_tags_updated_at
    BEFORE UPDATE ON content_tags
    FOR EACH ROW
    EXECUTE FUNCTION update_content_tags_updated_at();

-- 添加表注释
COMMENT ON TABLE content_tags IS '内容标签关联表，存储内容与标签的多对多关联关系，支持小说、漫画、音频、视频等多种内容类型';
COMMENT ON COLUMN content_tags.id IS '关联ID，自增主键';
COMMENT ON COLUMN content_tags.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN content_tags.content_id IS '内容ID，根据content_type关联对应的内容表（novels.id、comics.id、audios.id、videos.id）';
COMMENT ON COLUMN content_tags.tag_id IS '标签ID，外键关联tags表';
COMMENT ON COLUMN content_tags.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN content_tags.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_content_tags` (id)
- **外键约束**：`fk_content_tags_tag_id` (tag_id) 关联 tags(id)，级联删除
- **检查约束**：`ck_content_tags_content_type` (content_type) - 确保内容类型是预定义的值
- **唯一约束**：`uk_content_tags_content_type_content_id_tag_id` (content_type, content_id, tag_id) - 确保同一内容的同一标签只能关联一次
- **非空约束**：content_type、content_id、tag_id 必须非空
- **注意**：content_id 的外键约束需要在应用层验证，因为需要根据 content_type 关联不同的表

### 4. 设计索引

- **主键索引**：`pk_content_tags` (id) - 自动创建
- **外键索引**：`idx_content_tags_tag_id` (tag_id) - 用于查询标签关联的内容
- **普通索引**：`idx_content_tags_content_type` (content_type) - 用于按内容类型筛选
- **普通索引**：`idx_content_tags_content_id` (content_id) - 用于查询内容的标签
- **复合索引**：`idx_content_tags_content_type_content_id` (content_type, content_id) - 用于查询特定内容的标签列表
- **复合索引**：`idx_content_tags_content_type_tag_id` (content_type, tag_id) - 用于查询特定类型内容中关联了特定标签的内容
- **唯一索引**：`uk_content_tags_content_type_content_id_tag_id` (content_type, content_id, tag_id) - 确保唯一性

### 5. 考虑性能优化

- 为 tag_id 创建索引，支持快速查询标签关联的内容
- 为 content_type 和 content_id 创建复合索引，支持快速查询内容的标签列表
- 为 content_type 和 tag_id 创建复合索引，支持快速查询特定类型内容中关联了特定标签的内容
- 使用唯一索引，确保同一内容的同一标签只能关联一次
- 使用触发器自动更新 updated_at 字段
- 由于使用多态关联，content_id 的外键约束需要在应用层验证

### 6. 查询示例

```sql
-- 查询小说的所有标签
SELECT t.*
FROM content_tags ct
JOIN tags t ON ct.tag_id = t.id
WHERE ct.content_type = 'novel' AND ct.content_id = 1;

-- 查询标签关联的所有小说
SELECT n.*
FROM content_tags ct
JOIN novels n ON ct.content_id = n.id
WHERE ct.content_type = 'novel' AND ct.tag_id = 1;

-- 查询标签关联的所有内容（跨类型）
SELECT ct.content_type, ct.content_id, t.tag_name
FROM content_tags ct
JOIN tags t ON ct.tag_id = t.id
WHERE ct.tag_id = 1
ORDER BY ct.content_type, ct.content_id;
```

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 tags 表
4. 检查约束正确，确保内容类型是预定义的值
5. 唯一约束正确，确保同一内容的同一标签只能关联一次
6. 索引设计合理，支持常用查询场景（包括按内容查询标签、按标签查询内容、跨类型查询）
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新 updated_at 字段
9. 表设计符合 PostgreSQL 数据库设计规范
10. 支持小说、漫画、音频、视频等多种内容类型与标签的关联

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-18.md` - 标签表设计文档
- `docs/TASKS/TASK002/TASK002-19.md` - 小说表设计文档
- `docs/TASKS/TASK002/TASK002-23.md` - 漫画表设计文档
- `docs/TASKS/TASK002/TASK002-26.md` - 音频表设计文档
- `docs/TASKS/TASK002/TASK002-29.md` - 视频表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST
