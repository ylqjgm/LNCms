# TASK002-75: 数据库设计 - 核心模块 - 自动备份配置表

## 任务信息

**任务编号**: TASK002-75  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 自动备份配置表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 10:00:00 CST

## 任务描述

设计核心模块的自动备份配置表（backup_configs），用于存储自动备份配置信息。支持数据备份、文件备份、选择备份、全量备份等数据类型，支持一次性备份和定时备份，支持 Cron 格式的定时设定。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-74（备份渠道表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解自动备份的详细需求：

**功能需求**：
- 对网站数据进行自动备份
- 备份目标采用备份设定中的设定
- 支持多种数据类型和备份类型
- 支持定时备份和一次性备份
- 支持备份保留次数设定

**数据类型**：
- 数据备份（data）：仅备份数据库数据
- 文件备份（file）：仅备份文件数据
- 选择备份（selective）：选择性备份指定的数据或文件
- 全量备份（full）：备份所有数据和文件

**备份类型**：
- 一次性备份（once）：立即执行一次备份
- 定时备份（scheduled）：按照 Cron 表达式定时执行备份

**定时设定**：
- 仅定时备份有效
- 使用 Cron 格式设定（如：`0 2 * * *` 表示每天凌晨2点执行）

**备份保留**：
- 可设定保留多少次备份数据
- 超过保留次数的备份将被自动删除

### 2. 设计自动备份配置表结构

设计 `backup_configs` 表：

```sql
CREATE TABLE backup_configs (
    id BIGSERIAL PRIMARY KEY,
    config_name VARCHAR(100) NOT NULL,
    data_type VARCHAR(20) NOT NULL,
    backup_type VARCHAR(20) NOT NULL,
    schedule_config JSONB,
    selective_config JSONB,
    backup_channel_id BIGINT NOT NULL,
    storage_path VARCHAR(500) NOT NULL,
    retention_count INTEGER NOT NULL DEFAULT 1,
    config_status VARCHAR(20) NOT NULL DEFAULT 'active',
    last_backup_time TIMESTAMPTZ,
    next_backup_time TIMESTAMPTZ,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uk_backup_configs_config_name UNIQUE (config_name),
    CONSTRAINT fk_backup_configs_backup_channel_id FOREIGN KEY (backup_channel_id) REFERENCES backup_channels(id) ON DELETE RESTRICT,
    CONSTRAINT ck_backup_configs_data_type CHECK (data_type IN ('data', 'file', 'selective', 'full')),
    CONSTRAINT ck_backup_configs_backup_type CHECK (backup_type IN ('once', 'scheduled')),
    CONSTRAINT ck_backup_configs_config_status CHECK (config_status IN ('active', 'inactive')),
    CONSTRAINT ck_backup_configs_retention_count CHECK (retention_count > 0 AND retention_count <= 1000)
);

-- 创建索引
CREATE INDEX idx_backup_configs_data_type ON backup_configs(data_type);
CREATE INDEX idx_backup_configs_backup_type ON backup_configs(backup_type);
CREATE INDEX idx_backup_configs_backup_channel_id ON backup_configs(backup_channel_id);
CREATE INDEX idx_backup_configs_config_status ON backup_configs(config_status);
CREATE INDEX idx_backup_configs_next_backup_time ON backup_configs(next_backup_time);
CREATE INDEX idx_backup_configs_last_backup_time ON backup_configs(last_backup_time);
CREATE INDEX idx_backup_configs_created_at ON backup_configs(created_at);
CREATE INDEX idx_backup_configs_schedule_config ON backup_configs USING GIN (schedule_config);
CREATE INDEX idx_backup_configs_selective_config ON backup_configs USING GIN (selective_config);
CREATE INDEX idx_backup_configs_status_next_time ON backup_configs(config_status, next_backup_time);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_backup_configs_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_backup_configs_updated_at
    BEFORE UPDATE ON backup_configs
    FOR EACH ROW
    EXECUTE FUNCTION update_backup_configs_updated_at();

-- 添加表注释
COMMENT ON TABLE backup_configs IS '自动备份配置表，存储自动备份配置信息，支持多种数据类型和备份类型';
COMMENT ON COLUMN backup_configs.id IS '配置ID，自增主键';
COMMENT ON COLUMN backup_configs.config_name IS '配置名称，唯一标识，用于区分不同的备份配置';
COMMENT ON COLUMN backup_configs.data_type IS '数据类型：data-数据备份、file-文件备份、selective-选择备份、full-全量备份';
COMMENT ON COLUMN backup_configs.backup_type IS '备份类型：once-一次性备份、scheduled-定时备份';
COMMENT ON COLUMN backup_configs.schedule_config IS '定时设定，JSONB类型，仅定时备份有效。存储Cron表达式和时区信息，格式如：{"cron": "0 2 * * *", "timezone": "Asia/Shanghai"}。一次性备份时可以为NULL或空对象';
COMMENT ON COLUMN backup_configs.selective_config IS '选择配置，JSONB类型，仅选择备份（data_type=selective）有效。存储选择备份的详细选择信息，包括选择的数据库、数据表、文件路径等，格式见业务逻辑说明。非选择备份时可以为NULL或空对象';
COMMENT ON COLUMN backup_configs.backup_channel_id IS '备份渠道ID，外键关联backup_channels表，指定备份存储的渠道';
COMMENT ON COLUMN backup_configs.storage_path IS '存储路径，备份文件在渠道中的存储路径，如：/backups/daily/';
COMMENT ON COLUMN backup_configs.retention_count IS '备份保留次数，可设定保留多少次备份数据，范围：1-1000。超过保留次数的备份将被自动删除';
COMMENT ON COLUMN backup_configs.config_status IS '配置状态：active-启用、inactive-禁用。禁用的配置不会执行备份';
COMMENT ON COLUMN backup_configs.last_backup_time IS '最后备份时间，记录最后一次执行备份的时间';
COMMENT ON COLUMN backup_configs.next_backup_time IS '下次备份时间，定时备份时记录下次执行备份的时间，用于调度系统查询需要执行的备份任务';
COMMENT ON COLUMN backup_configs.description IS '配置描述，说明备份配置的用途和说明';
COMMENT ON COLUMN backup_configs.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN backup_configs.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_backup_configs` (id)
- **唯一约束**：`uk_backup_configs_config_name` (config_name) - 配置名称必须唯一
- **外键约束**：
  - `fk_backup_configs_backup_channel_id`：backup_channel_id 关联 backup_channels 表，删除备份渠道时限制删除（RESTRICT）以确保配置完整性
- **非空约束**：config_name、data_type、backup_type、backup_channel_id、storage_path、retention_count、config_status 必须非空
- **业务规则约束**（应用层实现）：
  - 当 data_type='selective' 时，selective_config 必须非空且包含有效的选择配置
  - 当 data_type='scheduled' 时，schedule_config 必须非空且包含有效的 Cron 表达式
- **检查约束**：
  - `ck_backup_configs_data_type`：data_type 必须是预定义的值之一（data、file、selective、full）
  - `ck_backup_configs_backup_type`：backup_type 必须是预定义的值之一（once、scheduled）
  - `ck_backup_configs_config_status`：config_status 必须是预定义的值之一（active、inactive）
  - `ck_backup_configs_retention_count`：retention_count 必须在 1-1000 之间
- **默认值**：
  - retention_count 默认为 1
  - config_status 默认为 'active'
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_backup_configs` (id) - 自动创建
- **唯一索引**：`uk_backup_configs_config_name` (config_name) - 自动创建
- **普通索引**：
  - `idx_backup_configs_data_type` (data_type) - 用于按数据类型查询
  - `idx_backup_configs_backup_type` (backup_type) - 用于按备份类型查询
  - `idx_backup_configs_backup_channel_id` (backup_channel_id) - 用于查询使用特定渠道的配置
  - `idx_backup_configs_config_status` (config_status) - 用于查询启用或禁用的配置
  - `idx_backup_configs_next_backup_time` (next_backup_time) - 用于查询需要执行的备份任务（调度系统使用）
  - `idx_backup_configs_last_backup_time` (last_backup_time) - 用于按最后备份时间排序和查询
  - `idx_backup_configs_created_at` (created_at) - 用于按创建时间排序和查询
- **GIN索引**：
  - `idx_backup_configs_schedule_config` (schedule_config) - 用于查询和过滤 JSONB 定时配置字段
  - `idx_backup_configs_selective_config` (selective_config) - 用于查询和过滤 JSONB 选择配置字段
- **复合索引**：
  - `idx_backup_configs_status_next_time` (config_status, next_backup_time) - 用于查询启用的配置中需要执行的备份任务（优化调度查询）

### 5. 考虑性能优化

- 为 backup_channel_id 创建索引，支持快速查询使用特定渠道的配置
- 为 next_backup_time 创建索引，支持调度系统快速查询需要执行的备份任务
- 创建复合索引 (config_status, next_backup_time)，优化查询启用配置中需要执行的备份任务
- 为 schedule_config 创建 GIN 索引，支持高效查询 JSONB 定时配置字段
- 为 selective_config 创建 GIN 索引，支持高效查询 JSONB 选择配置字段
- 使用 JSONB 类型存储定时配置和选择配置，灵活支持 Cron 表达式、时区信息和选择规则
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**数据类型说明**：
- **data（数据备份）**：仅备份数据库数据，不包括文件
- **file（文件备份）**：仅备份文件数据，不包括数据库
- **selective（选择备份）**：选择性备份指定的数据或文件，需要在 selective_config 中指定选择规则（包括选择的数据库、数据表、文件路径等）
- **full（全量备份）**：备份所有数据库数据和文件数据

**备份类型说明**：
- **once（一次性备份）**：配置创建后立即执行一次备份，执行完成后可以删除配置或转为定时备份
- **scheduled（定时备份）**：按照 Cron 表达式定时执行备份，需要设置 schedule_config

**定时配置格式**：

```json
// 定时备份配置示例
{
  "cron": "0 2 * * *",  // Cron表达式：每天凌晨2点执行
  "timezone": "Asia/Shanghai"  // 时区：Asia/Shanghai
}
```

**选择配置格式**（仅当 data_type='selective' 时有效）：

```json
// 选择备份配置示例（选择特定数据库和数据表）
{
  "databases": [
    {
      "database_name": "lncms_core",
      "tables": ["users", "authors", "novels"],
      "exclude_tables": ["temp_data"]
    },
    {
      "database_name": "lncms_storage",
      "tables": ["files", "file_metadata"]
    }
  ],
  "file_paths": [
    "/uploads/images",
    "/uploads/videos",
    "/uploads/documents"
  ],
  "exclude_paths": [
    "/uploads/temp",
    "/uploads/cache"
  ],
  "include_patterns": [
    "*.jpg",
    "*.png",
    "*.mp4"
  ],
  "exclude_patterns": [
    "*.tmp",
    "*.log"
  ]
}

// 仅选择数据库表（不包含文件）
{
  "databases": [
    {
      "database_name": "lncms_core",
      "tables": ["users", "authors"]
    }
  ]
}

// 仅选择文件路径（不包含数据库）
{
  "file_paths": [
    "/uploads/images",
    "/uploads/videos"
  ],
  "exclude_paths": [
    "/uploads/temp"
  ]
}
```

**选择配置字段说明**：
- `databases`：数组类型，指定要备份的数据库和表。每个数据库对象包含：
  - `database_name`：数据库名称（必填）
  - `tables`：要备份的表列表（可选，为空或null表示备份所有表）
  - `exclude_tables`：排除的表列表（可选）
- `file_paths`：数组类型，指定要备份的文件路径（可选）
- `exclude_paths`：数组类型，指定要排除的文件路径（可选）
- `include_patterns`：数组类型，指定要包含的文件匹配模式，支持通配符（可选）
- `exclude_patterns`：数组类型，指定要排除的文件匹配模式，支持通配符（可选）

**备份保留机制**：
- retention_count 设定保留的备份数量
- 当备份数量超过 retention_count 时，系统自动删除最旧的备份
- 删除操作在备份记录表（backup_records）中标记为已删除，或物理删除备份文件

**字段使用规则**：
- **schedule_config**：仅当 backup_type='scheduled' 时使用，存储定时备份的 Cron 表达式和时区信息
- **selective_config**：仅当 data_type='selective' 时使用，存储选择备份的详细选择信息（包括数据库、表、文件路径等）
- 两个字段可以同时使用：当 data_type='selective' 且 backup_type='scheduled' 时，schedule_config 存储定时信息，selective_config 存储选择信息

**备份执行流程**：
1. **一次性备份**：
   - 配置创建后，系统立即执行备份
   - 如果 data_type='selective'，根据 selective_config 中的选择规则进行备份
   - 备份完成后，更新 last_backup_time
   - next_backup_time 保持为 NULL

2. **定时备份**：
   - 调度系统定期查询 next_backup_time <= CURRENT_TIMESTAMP 且 config_status = 'active' 的配置
   - 执行备份任务
   - 如果 data_type='selective'，根据 selective_config 中的选择规则进行备份
   - 备份完成后，更新 last_backup_time
   - 根据 Cron 表达式计算下次备份时间，更新 next_backup_time

**配置状态**：
- active（启用）：配置可用，定时备份会按照设定执行
- inactive（禁用）：配置不可用，不会执行备份

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按数据类型查询、按备份类型查询、按渠道查询、调度查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持备份渠道关联
7. 唯一约束正确设置，确保配置名称唯一
8. 检查约束正确设置，确保数据类型、备份类型、状态和保留次数的值有效
9. 使用 JSONB 类型存储定时配置和选择配置，灵活支持 Cron 表达式、时区信息和选择规则
10. 为 JSONB 字段创建 GIN 索引，支持高效查询
11. 选择备份时必须设置 selective_config，包含选择的数据表、文件路径等信息
12. 创建复合索引优化调度查询性能
13. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 11.1.2 节 - 自动备份）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 11.1.2 节 - 自动备份）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.1  
**最后更新**: 2026-01-03 09:45:00 CST

