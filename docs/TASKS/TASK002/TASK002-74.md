# TASK002-74: 数据库设计 - 核心模块 - 备份渠道表

## 任务信息

**任务编号**: TASK002-74  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 备份渠道表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 10:00:00 CST

## 任务描述

设计核心模块的备份渠道表（backup_channels），用于存储备份渠道配置信息。支持多种备份渠道类型（本地存储、存储模块、云存储、FTP服务器、SMB共享服务器、Rsync同步服务器），每种渠道类型有不同的配置项。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解备份渠道的详细需求：

**功能需求**：
- 对备份的存储目标渠道进行设定
- 支持多种渠道类型
- 针对不同渠道类型进行不同的配置

**渠道类型**：
- 本地存储（local）：本地文件系统存储，无需额外配置
- 存储模块（storage_module）：通过存储模块进行备份
- 云存储（cloud_storage）：云存储服务（如阿里云OSS、腾讯云COS等）
- FTP服务器（ftp_server）：FTP服务器存储
- SMB共享服务器（smb_server）：SMB/CIFS共享存储
- Rsync同步服务器（rsync_server）：Rsync同步存储

**渠道配置**：
- 不同渠道类型需要不同的配置项
- 使用 JSONB 类型存储配置，灵活支持不同渠道的配置需求

### 2. 设计备份渠道表结构

设计 `backup_channels` 表：

```sql
CREATE TABLE backup_channels (
    id BIGSERIAL PRIMARY KEY,
    channel_name VARCHAR(100) NOT NULL,
    channel_type VARCHAR(30) NOT NULL,
    channel_config JSONB,
    channel_status VARCHAR(20) NOT NULL DEFAULT 'active',
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uk_backup_channels_channel_name UNIQUE (channel_name),
    CONSTRAINT ck_backup_channels_channel_type CHECK (channel_type IN ('local', 'storage_module', 'cloud_storage', 'ftp_server', 'smb_server', 'rsync_server')),
    CONSTRAINT ck_backup_channels_channel_status CHECK (channel_status IN ('active', 'inactive'))
);

-- 创建索引
CREATE INDEX idx_backup_channels_channel_type ON backup_channels(channel_type);
CREATE INDEX idx_backup_channels_channel_status ON backup_channels(channel_status);
CREATE INDEX idx_backup_channels_created_at ON backup_channels(created_at);
CREATE INDEX idx_backup_channels_channel_config ON backup_channels USING GIN (channel_config);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_backup_channels_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_backup_channels_updated_at
    BEFORE UPDATE ON backup_channels
    FOR EACH ROW
    EXECUTE FUNCTION update_backup_channels_updated_at();

-- 添加表注释
COMMENT ON TABLE backup_channels IS '备份渠道表，存储备份渠道配置信息，支持多种备份渠道类型';
COMMENT ON COLUMN backup_channels.id IS '渠道ID，自增主键';
COMMENT ON COLUMN backup_channels.channel_name IS '渠道名称，唯一标识，用于区分不同的备份渠道';
COMMENT ON COLUMN backup_channels.channel_type IS '渠道类型：local-本地存储、storage_module-存储模块、cloud_storage-云存储、ftp_server-FTP服务器、smb_server-SMB共享服务器、rsync_server-Rsync同步服务器';
COMMENT ON COLUMN backup_channels.channel_config IS '渠道配置，JSONB类型，根据不同渠道类型存储不同配置项。本地存储（local）无需配置，其他渠道类型需要相应配置：存储模块需要模块地址和认证信息；云存储需要访问密钥、区域、存储桶等；FTP服务器需要服务器地址、端口、用户名、密码等；SMB服务器需要服务器地址、共享路径、用户名、密码等；Rsync服务器需要服务器地址、端口、用户名、认证方式等';
COMMENT ON COLUMN backup_channels.channel_status IS '渠道状态：active-启用、inactive-禁用。禁用的渠道不能用于备份配置';
COMMENT ON COLUMN backup_channels.description IS '渠道描述，说明渠道的用途和配置说明';
COMMENT ON COLUMN backup_channels.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN backup_channels.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_backup_channels` (id)
- **唯一约束**：`uk_backup_channels_channel_name` (channel_name) - 渠道名称必须唯一
- **非空约束**：channel_name、channel_type、channel_status 必须非空
- **检查约束**：
  - `ck_backup_channels_channel_type`：channel_type 必须是预定义的值之一（local、storage_module、cloud_storage、ftp_server、smb_server、rsync_server）
  - `ck_backup_channels_channel_status`：channel_status 必须是预定义的值之一（active、inactive）
- **默认值**：
  - channel_status 默认为 'active'
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_backup_channels` (id) - 自动创建
- **唯一索引**：`uk_backup_channels_channel_name` (channel_name) - 自动创建
- **普通索引**：
  - `idx_backup_channels_channel_type` (channel_type) - 用于按渠道类型查询
  - `idx_backup_channels_channel_status` (channel_status) - 用于查询启用或禁用的渠道
  - `idx_backup_channels_created_at` (created_at) - 用于按创建时间排序和查询
- **GIN索引**：
  - `idx_backup_channels_channel_config` (channel_config) - 用于查询和过滤 JSONB 配置字段

### 5. 考虑性能优化

- 为 channel_type 创建索引，支持快速查询特定类型的渠道
- 为 channel_status 创建索引，支持快速查询启用或禁用的渠道
- 为 channel_config 创建 GIN 索引，支持高效查询 JSONB 配置字段
- 使用 JSONB 类型存储配置，灵活支持不同渠道类型的配置需求
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**渠道类型说明**：
- **local（本地存储）**：备份到本地文件系统，channel_config 可以为 NULL 或空对象
- **storage_module（存储模块）**：通过存储模块进行备份，channel_config 需要包含模块地址、认证信息等
- **cloud_storage（云存储）**：备份到云存储服务，channel_config 需要包含访问密钥、区域、存储桶、端点等配置
- **ftp_server（FTP服务器）**：备份到 FTP 服务器，channel_config 需要包含服务器地址、端口、用户名、密码、路径等
- **smb_server（SMB共享服务器）**：备份到 SMB/CIFS 共享，channel_config 需要包含服务器地址、共享名称、用户名、密码、路径等
- **rsync_server（Rsync同步服务器）**：通过 Rsync 同步备份，channel_config 需要包含服务器地址、端口、用户名、认证方式、路径等

**渠道配置示例**：

```json
// 存储模块配置
{
  "module_address": "grpc://storage-module:50051",
  "auth_token": "xxx",
  "storage_path": "/backups"
}

// 云存储配置（以阿里云OSS为例）
{
  "access_key_id": "xxx",
  "access_key_secret": "xxx",
  "endpoint": "oss-cn-hangzhou.aliyuncs.com",
  "bucket": "backup-bucket",
  "region": "cn-hangzhou",
  "path": "backups/"
}

// FTP服务器配置
{
  "host": "ftp.example.com",
  "port": 21,
  "username": "backup_user",
  "password": "xxx",
  "path": "/backups",
  "passive_mode": true
}

// SMB服务器配置
{
  "host": "smb.example.com",
  "share": "backups",
  "username": "backup_user",
  "password": "xxx",
  "path": "/backups",
  "domain": "WORKGROUP"
}

// Rsync服务器配置
{
  "host": "rsync.example.com",
  "port": 873,
  "username": "backup_user",
  "auth_method": "password",
  "password": "xxx",
  "path": "/backups",
  "ssh_key": null
}
```

**渠道状态**：
- active（启用）：渠道可用，可以用于备份配置
- inactive（禁用）：渠道不可用，不能用于备份配置

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按渠道类型查询、按状态查询、JSONB配置查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 唯一约束正确设置，确保渠道名称唯一
7. 检查约束正确设置，确保渠道类型和状态的值有效
8. 使用 JSONB 类型存储配置，灵活支持不同渠道类型的配置需求
9. 为 JSONB 字段创建 GIN 索引，支持高效查询
10. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 11.1.1 节 - 备份渠道）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 11.1.1 节 - 备份渠道）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 10:00:00 CST

