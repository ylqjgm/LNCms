# TASK002-10: 数据库设计 - 核心模块 - 用户表

## 任务信息

**任务编号**: TASK002-10  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 用户表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的用户表（users），用于存储用户基本信息和认证信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-03（用户组表）、TASK002-04（等级表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解用户管理的详细需求：
- 用户管理：用户添加、用户信息修改、用户状态管理、用户封禁管理、用户权限管理、用户审核、用户密码修改、用户删除
- 用户需要支持注册、登录、认证等功能

### 2. 设计用户表结构

设计 `users` 表，包含用户基本信息和认证信息：

```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    phone VARCHAR(20),
    password_hash VARCHAR(255) NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    phone_verified BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    is_locked BOOLEAN DEFAULT FALSE,
    role_id BIGINT,
    user_group_id BIGINT,
    level_id BIGINT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMPTZ,
    CONSTRAINT fk_users_role_id FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE SET NULL,
    CONSTRAINT fk_users_user_group_id FOREIGN KEY (user_group_id) REFERENCES user_groups(id) ON DELETE SET NULL,
    CONSTRAINT fk_users_level_id FOREIGN KEY (level_id) REFERENCES levels(id) ON DELETE SET NULL
);

-- 创建索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_role_id ON users(role_id);
CREATE INDEX idx_users_user_group_id ON users(user_group_id);
CREATE INDEX idx_users_level_id ON users(level_id);
CREATE INDEX idx_users_is_active ON users(is_active);
CREATE INDEX idx_users_is_locked ON users(is_locked);
CREATE UNIQUE INDEX uk_users_username ON users(username);
CREATE UNIQUE INDEX uk_users_email ON users(email);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_users_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_users_updated_at();

-- 添加表注释
COMMENT ON TABLE users IS '用户表，存储用户基本信息和认证信息';
COMMENT ON COLUMN users.id IS '用户ID，自增主键';
COMMENT ON COLUMN users.username IS '用户名，唯一标识符，用于登录';
COMMENT ON COLUMN users.email IS '邮箱地址，唯一标识符，用于登录和通知';
COMMENT ON COLUMN users.phone IS '手机号码，用于登录和通知';
COMMENT ON COLUMN users.password_hash IS '密码哈希值，使用 bcrypt 或类似算法，不能存储明文密码';
COMMENT ON COLUMN users.email_verified IS '邮箱是否已验证，TRUE-已验证，FALSE-未验证';
COMMENT ON COLUMN users.phone_verified IS '手机号是否已验证，TRUE-已验证，FALSE-未验证';
COMMENT ON COLUMN users.is_active IS '用户是否激活，TRUE-激活，FALSE-未激活';
COMMENT ON COLUMN users.is_locked IS '用户是否被锁定，TRUE-已锁定，FALSE-未锁定';
COMMENT ON COLUMN users.role_id IS '角色ID，外键关联roles表';
COMMENT ON COLUMN users.user_group_id IS '用户组ID，外键关联user_groups表';
COMMENT ON COLUMN users.level_id IS '等级ID，外键关联levels表';
COMMENT ON COLUMN users.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN users.updated_at IS '更新时间，每次更新时自动更新';
COMMENT ON COLUMN users.last_login_at IS '最后登录时间';
```

### 3. 设计约束

- **主键约束**：`pk_users` (id)
- **外键约束**：`fk_users_role_id` (role_id) 关联 roles(id)，删除时设置为 NULL
- **外键约束**：`fk_users_user_group_id` (user_group_id) 关联 user_groups(id)，删除时设置为 NULL
- **外键约束**：`fk_users_level_id` (level_id) 关联 levels(id)，删除时设置为 NULL
- **唯一约束**：`uk_users_username` (username)、`uk_users_email` (email)
- **非空约束**：username、email、password_hash 必须非空
- **默认值**：email_verified、phone_verified、is_active、is_locked 默认为 FALSE

### 4. 设计索引

- **主键索引**：`pk_users` (id) - 自动创建
- **唯一索引**：`uk_users_username` (username) - 确保用户名唯一
- **唯一索引**：`uk_users_email` (email) - 确保邮箱唯一
- **普通索引**：`idx_users_username` (username) - 用于快速查询
- **普通索引**：`idx_users_email` (email) - 用于快速查询
- **普通索引**：`idx_users_phone` (phone) - 用于快速查询
- **外键索引**：`idx_users_role_id` (role_id) - 用于关联查询
- **外键索引**：`idx_users_user_group_id` (user_group_id) - 用于关联查询
- **外键索引**：`idx_users_level_id` (level_id) - 用于关联查询
- **普通索引**：`idx_users_is_active` (is_active) - 用于状态筛选
- **普通索引**：`idx_users_is_locked` (is_locked) - 用于状态筛选

### 5. 考虑性能优化

- 为 username 和 email 创建唯一索引，支持快速查询和唯一性检查
- 为 phone 创建索引，支持快速查询
- 为外键字段创建索引，支持关联查询
- 为状态字段创建索引，支持状态筛选查询
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 roles、user_groups、levels 表
4. 唯一约束正确，确保用户名和邮箱唯一
5. 索引设计合理，支持常用查询场景
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 密码字段使用哈希存储，符合安全规范
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `.cursor/rules/security.mdc` - 应用安全开发规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-02.md` - 角色表设计文档
- `docs/TASKS/TASK002/TASK002-03.md` - 用户组表设计文档
- `docs/TASKS/TASK002/TASK002-04.md` - 等级表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST
