# TASK002-39: 数据库设计 - 核心模块 - 评论表

## 任务信息

**任务编号**: TASK002-39  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 评论表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的评论表（comments），用于存储用户对内容的评论信息。支持小说、漫画、音频、视频等多种内容类型的评论，支持多级回复。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解评论管理的详细需求：
- 评论管理：评论添加、评论修改、评论删除、评论审核、评论回复
- 评论属于用户，需要关联用户表
- 评论支持多种内容类型和目标级别：
  - 小说评论（作品级别）
  - 小说章节评论（章节级别）
  - 小说章节段评（段落级别，需要 paragraph_position 字段）
  - 漫画评论（作品级别）
  - 漫画章节评论（章节级别）
  - 音频评论（作品级别）
  - 音频分集评论（分集级别）
  - 视频评论（作品级别）
  - 视频分集评论（分集级别）
- 评论支持多级回复，通过 parent_id 实现树形结构
- 使用多态关联设计，通过 target_type 和 target_id 关联不同的内容表

### 2. 设计评论表结构

设计 `comments` 表，使用多态关联设计，支持多种内容类型、多种目标级别和多级回复：

```sql
CREATE TABLE comments (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    target_type VARCHAR(20) NOT NULL,
    target_id BIGINT NOT NULL,
    parent_id BIGINT,
    paragraph_position INTEGER,
    comment_content TEXT NOT NULL,
    comment_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    like_count BIGINT DEFAULT 0,
    reply_count BIGINT DEFAULT 0,
    is_top BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_comments_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_comments_parent_id FOREIGN KEY (parent_id) REFERENCES comments(id) ON DELETE CASCADE,
    CONSTRAINT ck_comments_target_type CHECK (target_type IN ('novel', 'novel_chapter', 'novel_paragraph', 'comic', 'comic_chapter', 'audio', 'audio_episode', 'video', 'video_episode')),
    CONSTRAINT ck_comments_comment_status CHECK (comment_status IN ('pending', 'approved', 'rejected', 'deleted')),
    CONSTRAINT ck_comments_paragraph_position CHECK (paragraph_position IS NULL OR (paragraph_position > 0 AND target_type = 'novel_paragraph')),
    CONSTRAINT ck_comments_like_count CHECK (like_count >= 0),
    CONSTRAINT ck_comments_reply_count CHECK (reply_count >= 0)
);

-- 创建索引
CREATE INDEX idx_comments_user_id ON comments(user_id);
CREATE INDEX idx_comments_parent_id ON comments(parent_id);
CREATE INDEX idx_comments_target_type ON comments(target_type);
CREATE INDEX idx_comments_target_id ON comments(target_id);
CREATE INDEX idx_comments_comment_status ON comments(comment_status);
CREATE INDEX idx_comments_is_top ON comments(is_top);
CREATE INDEX idx_comments_created_at ON comments(created_at);
CREATE INDEX idx_comments_target_type_target_id ON comments(target_type, target_id);
CREATE INDEX idx_comments_target_type_status ON comments(target_type, comment_status);
CREATE INDEX idx_comments_target_type_target_id_created ON comments(target_type, target_id, created_at);
CREATE INDEX idx_comments_target_type_target_id_status_created ON comments(target_type, target_id, comment_status, created_at);
CREATE INDEX idx_comments_parent_created ON comments(parent_id, created_at);
CREATE INDEX idx_comments_paragraph_position ON comments(target_id, paragraph_position) WHERE target_type = 'novel_paragraph';

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_comments_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_comments_updated_at
    BEFORE UPDATE ON comments
    FOR EACH ROW
    EXECUTE FUNCTION update_comments_updated_at();

-- 添加表注释
COMMENT ON TABLE comments IS '评论表，存储用户对内容的评论信息，支持小说、漫画、音频、视频等多种内容类型和多种目标级别（作品、章节、分集、段落），支持多级回复';
COMMENT ON COLUMN comments.id IS '评论ID，自增主键';
COMMENT ON COLUMN comments.user_id IS '用户ID，外键关联users表';
COMMENT ON COLUMN comments.target_type IS '评论目标类型：novel-小说作品、novel_chapter-小说章节、novel_paragraph-小说章节段落、comic-漫画作品、comic_chapter-漫画章节、audio-音频作品、audio_episode-音频分集、video-视频作品、video_episode-视频分集';
COMMENT ON COLUMN comments.target_id IS '评论目标ID，根据target_type关联对应的表（novels.id、novel_chapters.id、comics.id、comic_chapters.id、audios.id、audio_episodes.id、videos.id、video_episodes.id）';
COMMENT ON COLUMN comments.parent_id IS '父评论ID，外键关联comments表，NULL表示顶级评论，用于实现多级回复';
COMMENT ON COLUMN comments.paragraph_position IS '段落位置，仅当target_type为novel_paragraph时有效，表示评论对应的段落位置（从1开始）';
COMMENT ON COLUMN comments.comment_content IS '评论内容';
COMMENT ON COLUMN comments.comment_status IS '评论状态：pending-待审核、approved-已通过、rejected-已拒绝、deleted-已删除';
COMMENT ON COLUMN comments.like_count IS '点赞数，大于等于0';
COMMENT ON COLUMN comments.reply_count IS '回复数，大于等于0';
COMMENT ON COLUMN comments.is_top IS '是否置顶，TRUE-置顶，FALSE-不置顶';
COMMENT ON COLUMN comments.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN comments.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_comments` (id)
- **外键约束**：`fk_comments_user_id` (user_id) 关联 users(id)，级联删除
- **外键约束**：`fk_comments_parent_id` (parent_id) 关联 comments(id)，级联删除（自引用，实现多级回复）
- **检查约束**：`ck_comments_target_type` (target_type) - 确保评论目标类型是预定义的值（novel、novel_chapter、novel_paragraph、comic、comic_chapter、audio、audio_episode、video、video_episode）
- **检查约束**：`ck_comments_comment_status` (comment_status) - 确保评论状态是预定义的值
- **检查约束**：`ck_comments_paragraph_position` (paragraph_position) - 确保段落位置仅在段评时有效，且大于0
- **检查约束**：`ck_comments_like_count` (like_count) - 确保点赞数大于等于0
- **检查约束**：`ck_comments_reply_count` (reply_count) - 确保回复数大于等于0
- **非空约束**：user_id、target_type、target_id、comment_content、comment_status 必须非空
- **默认值**：comment_status 默认为 'pending'，like_count、reply_count 默认为 0，is_top 默认为 FALSE
- **可选字段**：parent_id 可为 NULL（顶级评论），paragraph_position 可为 NULL（非段评）
- **注意**：target_id 的外键约束需要在应用层验证，因为需要根据 target_type 关联不同的表（多态关联）

### 4. 设计索引

- **主键索引**：`pk_comments` (id) - 自动创建
- **外键索引**：`idx_comments_user_id` (user_id) - 用于查询用户的评论
- **外键索引**：`idx_comments_parent_id` (parent_id) - 用于查询评论的回复
- **普通索引**：`idx_comments_target_type` (target_type) - 用于按评论目标类型筛选
- **普通索引**：`idx_comments_target_id` (target_id) - 用于查询目标的评论
- **普通索引**：`idx_comments_comment_status` (comment_status) - 用于按状态筛选
- **普通索引**：`idx_comments_is_top` (is_top) - 用于查询置顶评论
- **普通索引**：`idx_comments_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_comments_target_type_target_id` (target_type, target_id) - 用于查询特定目标的评论列表（最常用）
- **复合索引**：`idx_comments_target_type_status` (target_type, comment_status) - 用于查询特定类型目标的特定状态评论
- **复合索引**：`idx_comments_target_type_target_id_created` (target_type, target_id, created_at) - 用于查询特定目标的评论并按时间排序
- **复合索引**：`idx_comments_target_type_target_id_status_created` (target_type, target_id, comment_status, created_at) - 用于查询特定目标的已审核评论并按时间排序（高效查询）
- **复合索引**：`idx_comments_parent_created` (parent_id, created_at) - 用于查询评论的回复并按时间排序
- **部分索引**：`idx_comments_paragraph_position` (target_id, paragraph_position) WHERE target_type = 'novel_paragraph' - 用于查询小说章节的段评，仅索引段评数据

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户的评论
- 为 parent_id 创建索引，支持快速查询评论的回复
- 为 target_type 和 target_id 创建复合索引，支持快速查询目标的评论列表（最常用查询场景）
- 为 comment_status 创建索引，支持按状态筛选查询
- 为 is_top 创建索引，支持查询置顶评论
- 为 created_at 创建索引，支持时间排序查询
- 使用复合索引优化常用查询场景（如查询特定目标的评论列表、查询特定类型目标的特定状态评论、查询评论的回复并按时间排序）
- 为段评创建部分索引，仅索引段评数据，提高查询效率
- 使用触发器自动更新 updated_at 字段
- 由于使用多态关联，target_id 的外键约束需要在应用层验证

### 6. 查询示例

```sql
-- 查询小说的所有顶级评论，按创建时间倒序
SELECT c.*, u.username
FROM comments c
JOIN users u ON c.user_id = u.id
WHERE c.target_type = 'novel' 
  AND c.target_id = 1 
  AND c.parent_id IS NULL
  AND c.comment_status = 'approved'
ORDER BY c.is_top DESC, c.created_at DESC;

-- 查询小说章节的所有顶级评论，按创建时间倒序
SELECT c.*, u.username
FROM comments c
JOIN users u ON c.user_id = u.id
WHERE c.target_type = 'novel_chapter' 
  AND c.target_id = 1 
  AND c.parent_id IS NULL
  AND c.comment_status = 'approved'
ORDER BY c.is_top DESC, c.created_at DESC;

-- 查询小说章节的段评，按段落位置排序
SELECT c.*, u.username
FROM comments c
JOIN users u ON c.user_id = u.id
WHERE c.target_type = 'novel_paragraph' 
  AND c.target_id = 1 
  AND c.comment_status = 'approved'
ORDER BY c.paragraph_position ASC, c.created_at ASC;

-- 查询评论的所有回复，按创建时间正序
SELECT c.*, u.username
FROM comments c
JOIN users u ON c.user_id = u.id
WHERE c.parent_id = 1
  AND c.comment_status = 'approved'
ORDER BY c.created_at ASC;

-- 查询用户的所有评论，按创建时间倒序
SELECT c.*
FROM comments c
WHERE c.user_id = 1
  AND c.comment_status != 'deleted'
ORDER BY c.created_at DESC;
```

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 users 表和 comments 表（自引用）
4. 检查约束正确，确保评论目标类型（novel、novel_chapter、novel_paragraph、comic、comic_chapter、audio、audio_episode、video、video_episode）、评论状态等是预定义的值
5. 索引设计合理，支持常用查询场景（包括按目标查询评论、按用户查询评论、多级回复查询、段评查询）
6. 表注释和字段注释完整，使用中文，明确说明多态关联和段评功能
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范
9. 支持小说、漫画、音频、视频等多种内容类型的评论
10. 支持作品级别、章节级别、分集级别、段落级别等多种目标级别的评论
11. 支持小说章节段评，通过 paragraph_position 字段标识段落位置
12. 支持多级回复，通过 parent_id 实现树形结构
13. 使用多态关联设计，通过 target_type 和 target_id 统一管理所有类型的评论，性能优化，符合数据库规范化原则

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-10.md` - 用户表设计文档
- `docs/TASKS/TASK002/TASK002-19.md` - 小说表设计文档
- `docs/TASKS/TASK002/TASK002-23.md` - 漫画表设计文档
- `docs/TASKS/TASK002/TASK002-26.md` - 音频表设计文档
- `docs/TASKS/TASK002/TASK002-29.md` - 视频表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

