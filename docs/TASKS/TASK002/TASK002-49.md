# TASK002-49: 数据库设计 - 采集模块 - 采集任务表

## 任务信息

**任务编号**: TASK002-49  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 采集模块 - 采集任务表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计采集模块的采集任务表（crawler_tasks），用于存储采集任务信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-49（采集规则表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Crawler.md` 文档，了解采集任务管理的详细需求：
- 任务管理：任务创建、任务编辑、任务删除、任务执行
- 任务配置：任务名称、采集规则、任务类型、采集目标等
- 任务类型：支持一次性任务、循环任务、定时任务
- 采集目标：支持单一ID、批量ID、范围ID、页面列表、分页列表
- 进度管理：支持进度查询、进度执行、进度暂停、进度终止

### 2. 设计采集任务表结构

设计 `crawler_tasks` 表，包含采集任务基本信息：

```sql
CREATE TABLE crawler_tasks (
    id BIGSERIAL PRIMARY KEY,
    task_name VARCHAR(200) NOT NULL,
    rule_id BIGINT NOT NULL,
    task_type VARCHAR(20) NOT NULL,
    target_type VARCHAR(20) NOT NULL,
    target_config JSONB NOT NULL,
    data_process VARCHAR(20) DEFAULT 'skip',
    file_process BOOLEAN DEFAULT FALSE,
    task_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    task_progress DECIMAL(5, 2) DEFAULT 0.00,
    processed_count BIGINT DEFAULT 0,
    total_count BIGINT,
    loop_interval INTEGER,
    schedule_expression VARCHAR(100),
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    error_message TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_crawler_tasks_rule_id FOREIGN KEY (rule_id) REFERENCES crawler_rules(id) ON DELETE RESTRICT,
    CONSTRAINT ck_crawler_tasks_task_type CHECK (task_type IN ('once', 'loop', 'schedule')),
    CONSTRAINT ck_crawler_tasks_target_type CHECK (target_type IN ('single_id', 'batch_id', 'range_id', 'page_list', 'pagination_list')),
    CONSTRAINT ck_crawler_tasks_data_process CHECK (data_process IN ('skip', 'clear_and_recollect')),
    CONSTRAINT ck_crawler_tasks_task_status CHECK (task_status IN ('pending', 'running', 'paused', 'completed', 'failed', 'cancelled')),
    CONSTRAINT ck_crawler_tasks_task_progress CHECK (task_progress >= 0 AND task_progress <= 100),
    CONSTRAINT ck_crawler_tasks_processed_count CHECK (processed_count >= 0),
    CONSTRAINT ck_crawler_tasks_total_count CHECK (total_count IS NULL OR total_count >= 0),
    CONSTRAINT ck_crawler_tasks_loop_interval CHECK (loop_interval IS NULL OR loop_interval > 0)
);

-- 创建索引
CREATE INDEX idx_crawler_tasks_task_name ON crawler_tasks(task_name);
CREATE INDEX idx_crawler_tasks_rule_id ON crawler_tasks(rule_id);
CREATE INDEX idx_crawler_tasks_task_type ON crawler_tasks(task_type);
CREATE INDEX idx_crawler_tasks_target_type ON crawler_tasks(target_type);
CREATE INDEX idx_crawler_tasks_task_status ON crawler_tasks(task_status);
CREATE INDEX idx_crawler_tasks_created_at ON crawler_tasks(created_at);
CREATE INDEX idx_crawler_tasks_started_at ON crawler_tasks(started_at);
CREATE INDEX idx_crawler_tasks_rule_status ON crawler_tasks(rule_id, task_status);
CREATE INDEX idx_crawler_tasks_type_status ON crawler_tasks(task_type, task_status);
CREATE INDEX idx_crawler_tasks_status_created ON crawler_tasks(task_status, created_at);

-- 为 JSONB 字段创建 GIN 索引（用于高效查询）
CREATE INDEX idx_crawler_tasks_target_config ON crawler_tasks USING GIN (target_config);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_crawler_tasks_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_crawler_tasks_updated_at
    BEFORE UPDATE ON crawler_tasks
    FOR EACH ROW
    EXECUTE FUNCTION update_crawler_tasks_updated_at();

-- 添加表注释
COMMENT ON TABLE crawler_tasks IS '采集任务表，存储采集任务信息';
COMMENT ON COLUMN crawler_tasks.id IS '任务ID，自增主键';
COMMENT ON COLUMN crawler_tasks.task_name IS '任务名称，长度限制1-200字符';
COMMENT ON COLUMN crawler_tasks.rule_id IS '采集规则ID，外键关联crawler_rules表';
COMMENT ON COLUMN crawler_tasks.task_type IS '任务类型：once-一次性任务、loop-循环任务、schedule-定时任务';
COMMENT ON COLUMN crawler_tasks.target_type IS '采集目标类型：single_id-单一ID、batch_id-批量ID、range_id-范围ID、page_list-页面列表、pagination_list-分页列表';
COMMENT ON COLUMN crawler_tasks.target_config IS '采集目标配置，JSONB格式，根据采集目标类型不同而不同';
COMMENT ON COLUMN crawler_tasks.data_process IS '数据处理：skip-跳过、clear_and_recollect-清空本地重新采集，默认skip';
COMMENT ON COLUMN crawler_tasks.file_process IS '文件处理，是否将远端文件下载至本地，默认FALSE';
COMMENT ON COLUMN crawler_tasks.task_status IS '任务状态：pending-待执行、running-执行中、paused-已暂停、completed-已完成、failed-失败、cancelled-已取消';
COMMENT ON COLUMN crawler_tasks.task_progress IS '任务进度，单位：百分比，范围0-100';
COMMENT ON COLUMN crawler_tasks.processed_count IS '已处理数量，大于等于0';
COMMENT ON COLUMN crawler_tasks.total_count IS '总数量，如果可确定，大于等于0，否则为NULL';
COMMENT ON COLUMN crawler_tasks.loop_interval IS '循环间隔，单位：秒，仅循环任务有效，必须大于0';
COMMENT ON COLUMN crawler_tasks.schedule_expression IS '定时表达式，如Cron表达式，仅定时任务有效';
COMMENT ON COLUMN crawler_tasks.started_at IS '开始时间，任务开始执行的时间';
COMMENT ON COLUMN crawler_tasks.completed_at IS '完成时间，任务完成时的时间';
COMMENT ON COLUMN crawler_tasks.error_message IS '错误消息，任务失败时的错误信息';
COMMENT ON COLUMN crawler_tasks.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN crawler_tasks.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_crawler_tasks` (id)
- **外键约束**：`fk_crawler_tasks_rule_id` (rule_id) 关联 crawler_rules(id)，删除时禁止（RESTRICT）
- **检查约束**：`ck_crawler_tasks_task_type` (task_type) - 确保任务类型是预定义的值
- **检查约束**：`ck_crawler_tasks_target_type` (target_type) - 确保采集目标类型是预定义的值
- **检查约束**：`ck_crawler_tasks_data_process` (data_process) - 确保数据处理方式是预定义的值
- **检查约束**：`ck_crawler_tasks_task_status` (task_status) - 确保任务状态是预定义的值
- **检查约束**：`ck_crawler_tasks_task_progress` (task_progress) - 确保任务进度在0-100之间
- **检查约束**：`ck_crawler_tasks_processed_count` (processed_count) - 确保已处理数量大于等于0
- **检查约束**：`ck_crawler_tasks_total_count` (total_count) - 确保总数量大于等于0（如果提供）
- **检查约束**：`ck_crawler_tasks_loop_interval` (loop_interval) - 确保循环间隔大于0（如果提供）
- **非空约束**：task_name、rule_id、task_type、target_type、target_config、task_status 必须非空
- **默认值**：data_process 默认为 'skip'，file_process 默认为 FALSE，task_status 默认为 'pending'，task_progress 默认为 0.00，processed_count 默认为 0
- **可选字段**：total_count、loop_interval、schedule_expression、started_at、completed_at、error_message 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_crawler_tasks` (id) - 自动创建
- **外键索引**：`idx_crawler_tasks_rule_id` (rule_id) - 用于关联查询
- **普通索引**：`idx_crawler_tasks_task_name` (task_name) - 用于任务名称搜索
- **普通索引**：`idx_crawler_tasks_task_type` (task_type) - 用于按任务类型筛选
- **普通索引**：`idx_crawler_tasks_target_type` (target_type) - 用于按采集目标类型筛选
- **普通索引**：`idx_crawler_tasks_task_status` (task_status) - 用于按任务状态筛选
- **普通索引**：`idx_crawler_tasks_created_at` (created_at) - 用于按创建时间排序
- **普通索引**：`idx_crawler_tasks_started_at` (started_at) - 用于按开始时间排序
- **GIN 索引**：`idx_crawler_tasks_target_config` (target_config) - 用于高效查询 JSONB 采集目标配置
- **复合索引**：`idx_crawler_tasks_rule_status` (rule_id, task_status) - 用于查询规则的特定状态任务
- **复合索引**：`idx_crawler_tasks_type_status` (task_type, task_status) - 用于按任务类型和状态筛选
- **复合索引**：`idx_crawler_tasks_status_created` (task_status, created_at) - 用于查询特定状态的任务并按时间排序

### 5. 考虑性能优化

- 为 rule_id 创建索引，支持关联查询
- 为 task_name 创建索引，支持任务名称搜索
- 为 task_type、target_type、task_status 创建索引，支持按类型、目标类型、状态筛选查询
- 为 created_at 和 started_at 创建索引，支持时间排序查询
- 为 target_config 创建 GIN 索引，支持高效查询 JSONB 采集目标配置
- 使用复合索引优化常用查询场景（如查询规则的特定状态任务、按任务类型和状态筛选、按任务状态和时间排序）
- 使用触发器自动更新 updated_at 字段

### 6. JSONB 字段结构示例

```json
// target_config 示例（根据 target_type 不同而不同）

// single_id
{
  "id": 123
}

// batch_id
{
  "ids": [1, 2, 3, 4, 5]
}

// range_id
{
  "start_id": 1,
  "end_id": 100
}

// page_list
{
  "list_url": "https://example.com/list",
  "list_rule": "{{**}}"
}

// pagination_list
{
  "url_template": "https://example.com/list?page={page}",
  "pagination_rule": "{{**}}",
  "max_pages": 10
}
```

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 crawler_rules 表
4. 检查约束正确，确保任务类型、采集目标类型、任务状态、任务进度等是有效的值
5. 索引设计合理，支持常用查询场景（包括按任务名称查询、按规则查询、按任务类型查询、按任务状态查询）
6. 为 JSONB 字段创建 GIN 索引，支持高效查询采集目标配置
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新 updated_at 字段
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Crawler.md` - 采集模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-49.md` - 采集规则表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

