# TASK002-70: 数据库设计 - 核心模块 - 推荐位表

## 任务信息

**任务编号**: TASK002-70  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 推荐位表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:10:08 CST

## 任务描述

设计核心模块的推荐位表（recommend_positions），用于存储推荐位信息。支持多种推荐位类型（首页推荐、分类推荐、排行榜等），每个推荐位有唯一标识代码。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解推荐位的详细需求：

**功能需求**：
- 编辑可将作品推荐至指定的推荐位
- 支持不同类型的推荐位，如首页推荐、分类推荐、排行榜等
- 每个推荐位有唯一标识代码
- 推荐位可以限制内容类型，部分推荐位仅针对某类内容（如小说推荐位、漫画推荐位），部分推荐位为通用（所有内容类型）

**内容类型限制**：
- 可以为推荐位设置内容类型限制
- 如果设置了内容类型，则该推荐位只能推荐对应类型的内容
- 如果内容类型为 NULL，则该推荐位为通用推荐位，可以推荐所有类型的内容

### 2. 设计推荐位表结构

设计 `recommend_positions` 表：

```sql
CREATE TABLE recommend_positions (
    id BIGSERIAL PRIMARY KEY,
    position_name VARCHAR(100) NOT NULL,
    position_code VARCHAR(50) NOT NULL UNIQUE,
    position_type VARCHAR(30) NOT NULL,
    content_type VARCHAR(20),
    position_description TEXT,
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_recommend_positions_position_type CHECK (position_type IN ('homepage', 'category', 'ranking', 'banner', 'sidebar', 'other')),
    CONSTRAINT ck_recommend_positions_content_type CHECK (content_type IS NULL OR content_type IN ('novel', 'comic', 'audio', 'video'))
);

-- 创建索引
CREATE INDEX idx_recommend_positions_position_name ON recommend_positions(position_name);
CREATE INDEX idx_recommend_positions_position_code ON recommend_positions(position_code);
CREATE INDEX idx_recommend_positions_position_type ON recommend_positions(position_type);
CREATE INDEX idx_recommend_positions_content_type ON recommend_positions(content_type);
CREATE INDEX idx_recommend_positions_sort_order ON recommend_positions(sort_order);
CREATE INDEX idx_recommend_positions_is_active ON recommend_positions(is_active);
CREATE UNIQUE INDEX uk_recommend_positions_position_code ON recommend_positions(position_code);
CREATE INDEX idx_recommend_positions_type_content ON recommend_positions(position_type, content_type);
CREATE INDEX idx_recommend_positions_content_active ON recommend_positions(content_type, is_active);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_recommend_positions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_recommend_positions_updated_at
    BEFORE UPDATE ON recommend_positions
    FOR EACH ROW
    EXECUTE FUNCTION update_recommend_positions_updated_at();

-- 添加表注释
COMMENT ON TABLE recommend_positions IS '推荐位表，存储推荐位信息，支持多种推荐位类型，可以按内容类型限制推荐位';
COMMENT ON COLUMN recommend_positions.id IS '推荐位ID，自增主键';
COMMENT ON COLUMN recommend_positions.position_name IS '推荐位名称，如"首页热门推荐"、"小说分类推荐"、"漫画排行榜"等';
COMMENT ON COLUMN recommend_positions.position_code IS '推荐位代码，唯一标识符，用于前端调用，如"homepage_hot"、"category_novel"、"ranking_weekly"等';
COMMENT ON COLUMN recommend_positions.position_type IS '推荐位类型：homepage-首页推荐、category-分类推荐、ranking-排行榜、banner-横幅推荐、sidebar-侧边栏推荐、other-其他';
COMMENT ON COLUMN recommend_positions.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频，为NULL表示通用推荐位（可以推荐所有类型的内容）。如果设置了内容类型，则该推荐位只能推荐对应类型的内容';
COMMENT ON COLUMN recommend_positions.position_description IS '推荐位描述，说明推荐位的用途和展示位置';
COMMENT ON COLUMN recommend_positions.sort_order IS '排序顺序，数值越大越靠前，用于控制推荐位的显示顺序';
COMMENT ON COLUMN recommend_positions.is_active IS '是否启用，TRUE-启用，FALSE-禁用，禁用的推荐位不展示';
COMMENT ON COLUMN recommend_positions.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN recommend_positions.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_recommend_positions` (id)
- **唯一约束**：`uk_recommend_positions_position_code` (position_code) - 确保推荐位代码唯一
- **非空约束**：position_name、position_code、position_type 必须非空
- **检查约束**：
  - `ck_recommend_positions_position_type`：position_type 必须是预定义的值之一（homepage、category、ranking、banner、sidebar、other）
  - `ck_recommend_positions_content_type`：content_type 如果存在，必须是预定义的值之一（novel、comic、audio、video）
- **默认值**：
  - sort_order 默认为 0
  - is_active 默认为 TRUE

### 4. 设计索引

- **主键索引**：`pk_recommend_positions` (id) - 自动创建
- **唯一索引**：`uk_recommend_positions_position_code` (position_code) - 确保推荐位代码唯一
- **普通索引**：
  - `idx_recommend_positions_position_name` (position_name) - 用于按名称查询
  - `idx_recommend_positions_position_type` (position_type) - 用于按推荐位类型查询
  - `idx_recommend_positions_content_type` (content_type) - 用于按内容类型查询
  - `idx_recommend_positions_sort_order` (sort_order) - 用于排序
  - `idx_recommend_positions_is_active` (is_active) - 用于筛选启用的推荐位
- **复合索引**：
  - `idx_recommend_positions_type_content` (position_type, content_type) - 用于按推荐位类型和内容类型组合查询
  - `idx_recommend_positions_content_active` (content_type, is_active) - 用于查询特定内容类型的启用推荐位

### 5. 考虑性能优化

- 为 position_code 创建唯一索引，支持快速查询和唯一性检查
- 为 position_type 创建索引，支持按推荐位类型查询
- 为 content_type 创建索引，支持按内容类型查询推荐位
- 创建复合索引 (position_type, content_type)，优化按推荐位类型和内容类型组合查询的性能
- 创建复合索引 (content_type, is_active)，优化查询特定内容类型的启用推荐位的性能
- 为 sort_order 创建索引，支持排序查询
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**推荐位类型**：
- homepage（首页推荐）：在首页展示的推荐位
- category（分类推荐）：在分类页面展示的推荐位
- ranking（排行榜）：排行榜类型的推荐位
- banner（横幅推荐）：横幅广告位
- sidebar（侧边栏推荐）：侧边栏展示的推荐位
- other（其他）：其他类型的推荐位

**推荐位代码规范**：
- 推荐位代码应该使用小写字母、数字和下划线
- 推荐位代码应该具有描述性，便于前端调用
- 例如：`homepage_hot`、`category_novel_top`、`ranking_weekly` 等

**内容类型限制**：
- content_type 为 NULL：通用推荐位，可以推荐所有类型的内容（小说、漫画、音频、视频）
- content_type 不为 NULL：专用推荐位，只能推荐对应类型的内容
- 例如：
  - "首页热门推荐"（content_type=NULL）：通用推荐位，可以推荐所有类型
  - "小说分类推荐"（content_type='novel'）：仅推荐小说
  - "漫画排行榜"（content_type='comic'）：仅推荐漫画
- 在作品推荐关联表中，系统应该验证作品的内容类型与推荐位的内容类型是否匹配

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按代码查询、按推荐位类型查询、按内容类型查询、组合查询、排序查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 唯一约束正确设置，确保推荐位代码唯一
7. 检查约束正确设置，确保推荐位类型和内容类型的值有效
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 10.3 节 - 作品管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 10.3 节 - 作品管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:10:08 CST

