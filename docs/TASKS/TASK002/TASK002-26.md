# TASK002-26: 数据库设计 - 核心模块 - 音频表

## 任务信息

**任务编号**: TASK002-26  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 音频表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的音频表（audios），用于存储音频基本信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-13（作者表）、TASK002-16（分类表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解音频管理的详细需求：
- 音频管理：音频信息管理，包括音频标题、简介、封面、状态等
- 音频属于作者，需要关联作者表
- 音频需要支持连载状态（连载中、已完结、断更）
- 音频需要支持是否上架标识，用以标注音频是否为收费模式
- 音频需要支持主播字段，用于标注主讲人/演播的作者

### 2. 设计音频表结构

设计 `audios` 表，包含音频基本信息：

```sql
CREATE TABLE audios (
    id BIGSERIAL PRIMARY KEY,
    author_id BIGINT NOT NULL,
    category_id BIGINT,
    narrator VARCHAR(100),
    title VARCHAR(200) NOT NULL,
    subtitle VARCHAR(200),
    description TEXT,
    cover_url VARCHAR(500),
    status VARCHAR(20) NOT NULL DEFAULT 'draft',
    serial_status VARCHAR(20) NOT NULL DEFAULT 'serializing',
    is_published BOOLEAN DEFAULT FALSE,
    is_shelved BOOLEAN DEFAULT FALSE,
    published_at TIMESTAMPTZ,
    duration INTEGER DEFAULT 0,
    view_count BIGINT DEFAULT 0,
    favorite_count BIGINT DEFAULT 0,
    rating DECIMAL(3,2) DEFAULT 0.00,
    rating_count BIGINT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_audios_author_id FOREIGN KEY (author_id) REFERENCES authors(id) ON DELETE CASCADE,
    CONSTRAINT fk_audios_category_id FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL,
    CONSTRAINT ck_audios_status CHECK (status IN ('draft', 'published', 'archived', 'deleted')),
    CONSTRAINT ck_audios_serial_status CHECK (serial_status IN ('serializing', 'completed', 'suspended'))
);

-- 创建索引
CREATE INDEX idx_audios_author_id ON audios(author_id);
CREATE INDEX idx_audios_category_id ON audios(category_id);
CREATE INDEX idx_audios_narrator ON audios(narrator);
CREATE INDEX idx_audios_title ON audios(title);
CREATE INDEX idx_audios_status ON audios(status);
CREATE INDEX idx_audios_serial_status ON audios(serial_status);
CREATE INDEX idx_audios_is_published ON audios(is_published);
CREATE INDEX idx_audios_is_shelved ON audios(is_shelved);
CREATE INDEX idx_audios_published_at ON audios(published_at);
CREATE INDEX idx_audios_created_at ON audios(created_at);
CREATE INDEX idx_audios_rating ON audios(rating);
CREATE INDEX idx_audios_author_status ON audios(author_id, status);
CREATE INDEX idx_audios_category_status ON audios(category_id, status);
CREATE INDEX idx_audios_published_created ON audios(is_published, created_at);
CREATE INDEX idx_audios_shelved_published ON audios(is_shelved, is_published);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_audios_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_audios_updated_at
    BEFORE UPDATE ON audios
    FOR EACH ROW
    EXECUTE FUNCTION update_audios_updated_at();

-- 添加表注释
COMMENT ON TABLE audios IS '音频表，存储音频基本信息';
COMMENT ON COLUMN audios.id IS '音频ID，自增主键';
COMMENT ON COLUMN audios.author_id IS '作者ID，外键关联authors表';
COMMENT ON COLUMN audios.category_id IS '分类ID，外键关联categories表，一部音频只支持一个分类';
COMMENT ON COLUMN audios.narrator IS '主播/主讲人，标注音频的演播作者或主讲人，字符串类型，无需关联其他表';
COMMENT ON COLUMN audios.title IS '音频标题';
COMMENT ON COLUMN audios.subtitle IS '音频副标题';
COMMENT ON COLUMN audios.description IS '音频简介';
COMMENT ON COLUMN audios.cover_url IS '封面URL，音频封面图片地址';
COMMENT ON COLUMN audios.status IS '音频状态：draft-草稿、published-已发布、archived-已归档、deleted-已删除';
COMMENT ON COLUMN audios.serial_status IS '连载状态：serializing-连载中、completed-已完结、suspended-断更';
COMMENT ON COLUMN audios.is_published IS '是否发布，TRUE-已发布，FALSE-未发布';
COMMENT ON COLUMN audios.is_shelved IS '是否上架，TRUE-已上架（收费模式），FALSE-未上架（免费模式）';
COMMENT ON COLUMN audios.published_at IS '发布时间';
COMMENT ON COLUMN audios.duration IS '时长，单位：秒';
COMMENT ON COLUMN audios.view_count IS '播放次数';
COMMENT ON COLUMN audios.favorite_count IS '收藏次数';
COMMENT ON COLUMN audios.rating IS '评分，范围0.00-10.00';
COMMENT ON COLUMN audios.rating_count IS '评分人数';
COMMENT ON COLUMN audios.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN audios.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_audios` (id)
- **外键约束**：`fk_audios_author_id` (author_id) 关联 authors(id)，级联删除
- **外键约束**：`fk_audios_category_id` (category_id) 关联 categories(id)，删除时设置为 NULL
- **检查约束**：`ck_audios_status` (status) - 确保状态是预定义的值
- **检查约束**：`ck_audios_serial_status` (serial_status) - 确保连载状态是预定义的值
- **非空约束**：author_id、title、status、serial_status 必须非空
- **默认值**：status 默认为 'draft'，serial_status 默认为 'serializing'，is_published 默认为 FALSE，is_shelved 默认为 FALSE，duration、view_count、favorite_count、rating、rating_count 默认为 0

### 4. 设计索引

- **主键索引**：`pk_audios` (id) - 自动创建
- **外键索引**：`idx_audios_author_id` (author_id) - 用于查询作者的音频
- **外键索引**：`idx_audios_category_id` (category_id) - 用于查询分类的音频
- **普通索引**：`idx_audios_narrator` (narrator) - 用于主播搜索
- **普通索引**：`idx_audios_title` (title) - 用于标题搜索
- **普通索引**：`idx_audios_status` (status) - 用于状态筛选
- **普通索引**：`idx_audios_serial_status` (serial_status) - 用于连载状态筛选
- **普通索引**：`idx_audios_is_published` (is_published) - 用于发布状态筛选
- **普通索引**：`idx_audios_is_shelved` (is_shelved) - 用于上架状态筛选
- **普通索引**：`idx_audios_published_at` (published_at) - 用于按发布时间排序
- **普通索引**：`idx_audios_created_at` (created_at) - 用于按创建时间排序
- **普通索引**：`idx_audios_rating` (rating) - 用于按评分排序
- **复合索引**：`idx_audios_author_status` (author_id, status) - 用于查询作者的音频并按状态筛选
- **复合索引**：`idx_audios_category_status` (category_id, status) - 用于查询分类的音频并按状态筛选
- **复合索引**：`idx_audios_published_created` (is_published, created_at) - 用于查询已发布的音频并按时间排序
- **复合索引**：`idx_audios_shelved_published` (is_shelved, is_published) - 用于查询上架且已发布的音频

### 5. 考虑性能优化

- 为 author_id 创建索引，支持快速查询作者的音频
- 为 category_id 创建索引，支持快速查询分类的音频
- 为 narrator 创建索引，支持主播搜索查询
- 为 status、serial_status、is_published、is_shelved 创建索引，支持状态筛选查询
- 为 published_at 和 created_at 创建索引，支持时间排序查询
- 为 rating 创建索引，支持按评分排序
- 使用复合索引优化常用查询场景（如按上架和发布状态查询）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 authors 表和 categories 表
4. 检查约束正确，确保状态和连载状态是预定义的值
5. 索引设计合理，支持常用查询场景（包括连载状态查询、上架状态查询、主播搜索）
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范
9. 音频支持连载状态（连载中、已完结、断更）
10. 音频支持是否上架标识，用于标注收费模式
11. 音频支持主播字段，用于标注主讲人/演播的作者，字符串类型，无需关联其他表

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-13.md` - 作者表设计文档
- `docs/TASKS/TASK002/TASK002-16.md` - 分类表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

