# TASK002-44: 数据库设计 - 存储模块 - 迁移记录表

## 任务信息

**任务编号**: TASK002-44  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 存储模块 - 迁移记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计存储模块的迁移记录表（migration_records），用于存储文件迁移记录信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Storage.md` 文档，了解文件迁移的详细需求：
- 文件迁移：支持远端到本地、本地到远端的文件迁移
- 迁移记录：记录迁移ID、迁移类型、迁移状态、迁移进度等信息
- 迁移支持批量文件迁移，支持进度查询

### 2. 设计迁移记录表结构

设计 `migration_records` 表，包含迁移记录基本信息：

```sql
CREATE TABLE migration_records (
    id BIGSERIAL PRIMARY KEY,
    migration_id VARCHAR(64) NOT NULL UNIQUE,
    migration_type VARCHAR(20) NOT NULL,
    remote_connection JSONB NOT NULL,
    remote_database JSONB NOT NULL,
    file_list JSONB NOT NULL,
    total_files INTEGER NOT NULL DEFAULT 0,
    migrated_files INTEGER NOT NULL DEFAULT 0,
    failed_files INTEGER NOT NULL DEFAULT 0,
    migration_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    migration_progress DECIMAL(5, 2) DEFAULT 0.00,
    transcode_enabled BOOLEAN DEFAULT FALSE,
    transcode_mode VARCHAR(20),
    error_message TEXT,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_migration_records_migration_type CHECK (migration_type IN ('remote_to_local', 'local_to_remote')),
    CONSTRAINT ck_migration_records_total_files CHECK (total_files >= 0),
    CONSTRAINT ck_migration_records_migrated_files CHECK (migrated_files >= 0 AND migrated_files <= total_files),
    CONSTRAINT ck_migration_records_failed_files CHECK (failed_files >= 0),
    CONSTRAINT ck_migration_records_migration_status CHECK (migration_status IN ('pending', 'connecting', 'migrating', 'transcoding', 'completed', 'failed', 'cancelled')),
    CONSTRAINT ck_migration_records_migration_progress CHECK (migration_progress >= 0 AND migration_progress <= 100),
    CONSTRAINT ck_migration_records_transcode_mode CHECK (transcode_mode IS NULL OR transcode_mode IN ('sync', 'async'))
);

-- 创建索引
CREATE UNIQUE INDEX uk_migration_records_migration_id ON migration_records(migration_id);
CREATE INDEX idx_migration_records_migration_type ON migration_records(migration_type);
CREATE INDEX idx_migration_records_migration_status ON migration_records(migration_status);
CREATE INDEX idx_migration_records_created_at ON migration_records(created_at);
CREATE INDEX idx_migration_records_migration_status_created ON migration_records(migration_status, created_at);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_migration_records_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_migration_records_updated_at
    BEFORE UPDATE ON migration_records
    FOR EACH ROW
    EXECUTE FUNCTION update_migration_records_updated_at();

-- 添加表注释
COMMENT ON TABLE migration_records IS '迁移记录表，存储文件迁移记录信息';
COMMENT ON COLUMN migration_records.id IS '迁移记录ID，自增主键';
COMMENT ON COLUMN migration_records.migration_id IS '迁移ID，唯一标识符，用于系统内部识别';
COMMENT ON COLUMN migration_records.migration_type IS '迁移类型：remote_to_local-远端到本地、local_to_remote-本地到远端';
COMMENT ON COLUMN migration_records.remote_connection IS '远端连接信息，JSONB格式，包含连接地址、端口、协议等';
COMMENT ON COLUMN migration_records.remote_database IS '远端数据库信息，JSONB格式，包含数据库类型、连接字符串、认证信息等';
COMMENT ON COLUMN migration_records.file_list IS '迁移文件列表，JSONB格式，包含文件ID列表';
COMMENT ON COLUMN migration_records.total_files IS '总文件数，大于等于0';
COMMENT ON COLUMN migration_records.migrated_files IS '已迁移文件数，大于等于0且小于等于总文件数';
COMMENT ON COLUMN migration_records.failed_files IS '失败文件数，大于等于0';
COMMENT ON COLUMN migration_records.migration_status IS '迁移状态：pending-待处理、connecting-连接中、migrating-迁移中、transcoding-转码中、completed-已完成、failed-失败、cancelled-已取消';
COMMENT ON COLUMN migration_records.migration_progress IS '迁移进度，单位：百分比，范围0-100';
COMMENT ON COLUMN migration_records.transcode_enabled IS '是否转码，TRUE-启用转码，FALSE-不转码，仅远端到本地有效';
COMMENT ON COLUMN migration_records.transcode_mode IS '转码方式：sync-同步转码、async-迁移后转码，仅转码启用时有效';
COMMENT ON COLUMN migration_records.error_message IS '错误消息，迁移失败时的错误信息';
COMMENT ON COLUMN migration_records.started_at IS '开始时间，迁移开始处理的时间';
COMMENT ON COLUMN migration_records.completed_at IS '完成时间，迁移完成时的时间';
COMMENT ON COLUMN migration_records.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN migration_records.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_migration_records` (id)
- **唯一约束**：`uk_migration_records_migration_id` (migration_id)
- **检查约束**：`ck_migration_records_migration_type` (migration_type) - 确保迁移类型是预定义的值
- **检查约束**：`ck_migration_records_total_files` (total_files) - 确保总文件数大于等于0
- **检查约束**：`ck_migration_records_migrated_files` (migrated_files) - 确保已迁移文件数在有效范围内
- **检查约束**：`ck_migration_records_failed_files` (failed_files) - 确保失败文件数大于等于0
- **检查约束**：`ck_migration_records_migration_status` (migration_status) - 确保迁移状态是预定义的值
- **检查约束**：`ck_migration_records_migration_progress` (migration_progress) - 确保迁移进度在0-100之间
- **检查约束**：`ck_migration_records_transcode_mode` (transcode_mode) - 确保转码方式是预定义的值（如果提供）
- **非空约束**：migration_id、migration_type、remote_connection、remote_database、file_list、migration_status 必须非空
- **默认值**：total_files、migrated_files、failed_files 默认为 0，migration_status 默认为 'pending'，migration_progress 默认为 0.00，transcode_enabled 默认为 FALSE
- **可选字段**：transcode_mode、error_message、started_at、completed_at 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_migration_records` (id) - 自动创建
- **唯一索引**：`uk_migration_records_migration_id` (migration_id) - 确保迁移ID唯一
- **普通索引**：`idx_migration_records_migration_type` (migration_type) - 用于按迁移类型筛选
- **普通索引**：`idx_migration_records_migration_status` (migration_status) - 用于按迁移状态筛选
- **普通索引**：`idx_migration_records_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_migration_records_migration_status_created` (migration_status, created_at) - 用于查询特定状态的迁移记录并按时间排序

### 5. 考虑性能优化

- 为 migration_id 创建唯一索引，支持快速查询和唯一性检查
- 为 migration_type 和 migration_status 创建索引，支持按类型和状态筛选查询
- 为 created_at 创建索引，支持时间排序查询
- 使用复合索引优化常用查询场景（如查询特定状态的迁移记录并按时间排序）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 唯一约束正确，确保迁移ID唯一
4. 检查约束正确，确保迁移类型、迁移状态、文件数量、迁移进度等是有效的值
5. 索引设计合理，支持常用查询场景（包括按迁移ID查询、按迁移状态查询、按迁移类型查询）
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Storage.md` - 存储模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

