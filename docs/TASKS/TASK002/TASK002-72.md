# TASK002-72: 数据库设计 - 核心模块 - 结算审核记录表

## 任务信息

**任务编号**: TASK002-72  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 结算审核记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:10:08 CST

## 任务描述

设计核心模块的结算审核记录表（settlement_audits），用于存储作者结算审核记录。支持多级审核流程（编辑审核、组长审核、部长审核），记录结算周期、结算金额、审核状态和审核意见。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-13（作者表）、TASK002-10（用户表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解结算审核的详细需求：

**功能需求**：
- 根据系统设置的结算模式进行审核
- 若为周期结算，则自动生成收益结果提交审核
- 若为最低支付结算，则由作者提交结算审核
- 编辑审核完成后，组长层级会进行编辑汇总审核，部长进行小组汇总审核

**审核级别**：
- 编辑审核：编辑对单个作者的结算进行审核
- 组长审核：组长对编辑汇总的结算进行审核
- 部长审核：部长对小组汇总的结算进行审核

**审核状态**：
- 待审核：提交审核，等待审核
- 编辑已审核：编辑已审核完成
- 组长已审核：组长已审核完成
- 部长已审核：部长已审核完成
- 已支付：结算已支付完成

### 2. 设计结算审核记录表结构

设计 `settlement_audits` 表：

```sql
CREATE TABLE settlement_audits (
    id BIGSERIAL PRIMARY KEY,
    author_id BIGINT NOT NULL,
    settlement_period_start TIMESTAMPTZ NOT NULL,
    settlement_period_end TIMESTAMPTZ NOT NULL,
    settlement_amount NUMERIC(10, 2) NOT NULL DEFAULT 0,
    actual_payment_amount NUMERIC(10, 2) NOT NULL DEFAULT 0,
    audit_level VARCHAR(20) NOT NULL,
    audit_status VARCHAR(30) NOT NULL DEFAULT 'pending',
    auditor_id BIGINT,
    audit_time TIMESTAMPTZ,
    audit_opinion TEXT,
    payment_time TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_settlement_audits_author_id FOREIGN KEY (author_id) REFERENCES authors(id) ON DELETE CASCADE,
    CONSTRAINT fk_settlement_audits_auditor_id FOREIGN KEY (auditor_id) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT ck_settlement_audits_audit_level CHECK (audit_level IN ('editor', 'group_leader', 'department_head')),
    CONSTRAINT ck_settlement_audits_audit_status CHECK (audit_status IN ('pending', 'editor_approved', 'group_leader_approved', 'department_head_approved', 'paid')),
    CONSTRAINT ck_settlement_audits_settlement_amount CHECK (settlement_amount >= 0),
    CONSTRAINT ck_settlement_audits_actual_payment_amount CHECK (actual_payment_amount >= 0),
    CONSTRAINT ck_settlement_audits_period CHECK (settlement_period_end > settlement_period_start)
);

-- 创建索引
CREATE INDEX idx_settlement_audits_author_id ON settlement_audits(author_id);
CREATE INDEX idx_settlement_audits_audit_level ON settlement_audits(audit_level);
CREATE INDEX idx_settlement_audits_audit_status ON settlement_audits(audit_status);
CREATE INDEX idx_settlement_audits_auditor_id ON settlement_audits(auditor_id);
CREATE INDEX idx_settlement_audits_settlement_period_start ON settlement_audits(settlement_period_start);
CREATE INDEX idx_settlement_audits_settlement_period_end ON settlement_audits(settlement_period_end);
CREATE INDEX idx_settlement_audits_audit_time ON settlement_audits(audit_time);
CREATE INDEX idx_settlement_audits_payment_time ON settlement_audits(payment_time);
CREATE INDEX idx_settlement_audits_author_status ON settlement_audits(author_id, audit_status);
CREATE INDEX idx_settlement_audits_level_status ON settlement_audits(audit_level, audit_status);
CREATE INDEX idx_settlement_audits_period_range ON settlement_audits(settlement_period_start, settlement_period_end);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_settlement_audits_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_settlement_audits_updated_at
    BEFORE UPDATE ON settlement_audits
    FOR EACH ROW
    EXECUTE FUNCTION update_settlement_audits_updated_at();

-- 添加表注释
COMMENT ON TABLE settlement_audits IS '结算审核记录表，存储作者结算审核记录，支持多级审核流程';
COMMENT ON COLUMN settlement_audits.id IS '审核ID，自增主键';
COMMENT ON COLUMN settlement_audits.author_id IS '作者ID，外键关联authors表';
COMMENT ON COLUMN settlement_audits.settlement_period_start IS '结算周期开始时间，结算收益统计的起始时间';
COMMENT ON COLUMN settlement_audits.settlement_period_end IS '结算周期结束时间，结算收益统计的结束时间，必须大于开始时间';
COMMENT ON COLUMN settlement_audits.settlement_amount IS '结算金额，单位：消费货币，作者在该结算周期内的总收益';
COMMENT ON COLUMN settlement_audits.actual_payment_amount IS '实际支付金额，单位：现实货币，根据结算比例计算后的实际支付金额';
COMMENT ON COLUMN settlement_audits.audit_level IS '审核级别：editor-编辑审核、group_leader-组长审核、department_head-部长审核';
COMMENT ON COLUMN settlement_audits.audit_status IS '审核状态：pending-待审核、editor_approved-编辑已审核、group_leader_approved-组长已审核、department_head_approved-部长已审核、paid-已支付';
COMMENT ON COLUMN settlement_audits.auditor_id IS '审核人员ID，外键关联users表，记录进行审核的人员';
COMMENT ON COLUMN settlement_audits.audit_time IS '审核时间，审核人员进行审核的时间';
COMMENT ON COLUMN settlement_audits.audit_opinion IS '审核意见，审核人员填写的审核意见和建议';
COMMENT ON COLUMN settlement_audits.payment_time IS '支付时间，结算支付完成的时间';
COMMENT ON COLUMN settlement_audits.created_at IS '创建时间，自动设置为当前时间，即结算审核记录创建的时间';
COMMENT ON COLUMN settlement_audits.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_settlement_audits` (id)
- **外键约束**：
  - `fk_settlement_audits_author_id`：author_id 关联 authors 表，删除作者时级联删除结算记录
  - `fk_settlement_audits_auditor_id`：auditor_id 关联 users 表，删除用户时设置为 NULL
- **非空约束**：author_id、settlement_period_start、settlement_period_end、audit_level、audit_status 必须非空
- **检查约束**：
  - `ck_settlement_audits_audit_level`：audit_level 必须是预定义的值之一（editor、group_leader、department_head）
  - `ck_settlement_audits_audit_status`：audit_status 必须是预定义的值之一（pending、editor_approved、group_leader_approved、department_head_approved、paid）
  - `ck_settlement_audits_settlement_amount`：settlement_amount 必须大于等于 0
  - `ck_settlement_audits_actual_payment_amount`：actual_payment_amount 必须大于等于 0
  - `ck_settlement_audits_period`：settlement_period_end 必须大于 settlement_period_start
- **默认值**：
  - settlement_amount 默认为 0
  - actual_payment_amount 默认为 0
  - audit_status 默认为 'pending'

### 4. 设计索引

- **主键索引**：`pk_settlement_audits` (id) - 自动创建
- **普通索引**：
  - `idx_settlement_audits_author_id` (author_id) - 用于查询作者的结算审核记录
  - `idx_settlement_audits_audit_level` (audit_level) - 用于按审核级别查询
  - `idx_settlement_audits_audit_status` (audit_status) - 用于按审核状态查询
  - `idx_settlement_audits_auditor_id` (auditor_id) - 用于查询审核人员的审核记录
  - `idx_settlement_audits_settlement_period_start` (settlement_period_start) - 用于按结算周期查询
  - `idx_settlement_audits_settlement_period_end` (settlement_period_end) - 用于按结算周期查询
  - `idx_settlement_audits_audit_time` (audit_time) - 用于按审核时间排序和查询
  - `idx_settlement_audits_payment_time` (payment_time) - 用于按支付时间查询
- **复合索引**：
  - `idx_settlement_audits_author_status` (author_id, audit_status) - 用于查询作者特定状态的结算审核记录
  - `idx_settlement_audits_level_status` (audit_level, audit_status) - 用于查询特定级别特定状态的审核记录
  - `idx_settlement_audits_period_range` (settlement_period_start, settlement_period_end) - 用于查询时间范围内的结算记录

### 5. 考虑性能优化

- 为 author_id 创建索引，支持快速查询作者的结算审核记录
- 创建复合索引 (author_id, audit_status)，优化查询作者特定状态记录的性能
- 创建复合索引 (audit_level, audit_status)，优化查询特定级别特定状态记录的性能
- 创建复合索引 (settlement_period_start, settlement_period_end)，支持查询时间范围内的结算记录
- 使用 NUMERIC 类型存储金额，确保精度和计算的准确性
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**结算流程**：
1. **周期结算**：系统按照结算设置中的周期自动生成结算记录，状态为 'pending'
2. **最低支付金额结算**：作者收益达到最低支付金额时，主动提交结算申请，创建结算记录，状态为 'pending'

**多级审核流程**：
1. **编辑审核**：编辑对单个作者的结算进行审核，审核完成后状态更新为 'editor_approved'
2. **组长审核**：组长对编辑汇总的结算进行审核，审核完成后状态更新为 'group_leader_approved'
3. **部长审核**：部长对小组汇总的结算进行审核，审核完成后状态更新为 'department_head_approved'
4. **支付**：审核全部通过后，进行支付，状态更新为 'paid'，记录 payment_time

**金额计算**：
- settlement_amount：作者在该结算周期内的总收益（消费货币）
- actual_payment_amount：根据结算设置中的结算比例计算，实际支付金额（现实货币）
- 计算公式：actual_payment_amount = settlement_amount / settlement_ratio

**审核级别说明**：
- editor（编辑审核）：编辑对单个作者的结算进行审核
- group_leader（组长审核）：组长对编辑汇总的结算进行审核
- department_head（部长审核）：部长对小组汇总的结算进行审核

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按作者查询、按审核状态查询、按结算周期查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持作者和审核人员关联
7. 检查约束正确设置，确保审核级别、审核状态、金额和周期时间的值有效
8. 使用 NUMERIC 类型存储金额，确保精度
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 10.4 节 - 结算管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 10.4 节 - 结算管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:10:08 CST

