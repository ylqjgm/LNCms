# TASK002-48: 数据库设计 - 采集模块 - 采集规则表

## 任务信息

**任务编号**: TASK002-48  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 采集模块 - 采集规则表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计采集模块的采集规则表（crawler_rules），用于存储采集规则信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Crawler.md` 文档，了解采集规则管理的详细需求：
- 规则管理：规则创建、规则编辑、规则删除、规则验证
- 规则配置：规则名称、网站名称、网站地址、规则步骤等
- 规则步骤：支持三种类型（发起请求、数据处理、文件下载），按顺序执行
- 标签处理：支持标签定义和使用，通过 `{$xxx}` 格式进行数据替换
- 数据匹配：支持多种占位符进行数据匹配和获取

### 2. 设计采集规则表结构

设计 `crawler_rules` 表，包含采集规则基本信息：

```sql
CREATE TABLE crawler_rules (
    id BIGSERIAL PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL UNIQUE,
    site_name VARCHAR(200) NOT NULL,
    site_url VARCHAR(500) NOT NULL,
    rule_steps JSONB NOT NULL,
    rule_tags JSONB,
    rule_status VARCHAR(20) NOT NULL DEFAULT 'draft',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_crawler_rules_rule_status CHECK (rule_status IN ('draft', 'validating', 'confirmed', 'active', 'inactive')),
    CONSTRAINT ck_crawler_rules_site_url CHECK (site_url ~ '^https?://')
);

-- 创建索引
CREATE UNIQUE INDEX uk_crawler_rules_rule_name ON crawler_rules(rule_name);
CREATE INDEX idx_crawler_rules_site_name ON crawler_rules(site_name);
CREATE INDEX idx_crawler_rules_rule_status ON crawler_rules(rule_status);
CREATE INDEX idx_crawler_rules_is_active ON crawler_rules(is_active);
CREATE INDEX idx_crawler_rules_created_at ON crawler_rules(created_at);
CREATE INDEX idx_crawler_rules_status_active ON crawler_rules(rule_status, is_active);

-- 为 JSONB 字段创建 GIN 索引（用于高效查询）
CREATE INDEX idx_crawler_rules_rule_steps ON crawler_rules USING GIN (rule_steps);
CREATE INDEX idx_crawler_rules_rule_tags ON crawler_rules USING GIN (rule_tags);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_crawler_rules_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_crawler_rules_updated_at
    BEFORE UPDATE ON crawler_rules
    FOR EACH ROW
    EXECUTE FUNCTION update_crawler_rules_updated_at();

-- 添加表注释
COMMENT ON TABLE crawler_rules IS '采集规则表，存储采集规则信息';
COMMENT ON COLUMN crawler_rules.id IS '规则ID，自增主键';
COMMENT ON COLUMN crawler_rules.rule_name IS '规则名称，唯一标识符，长度限制1-100字符';
COMMENT ON COLUMN crawler_rules.site_name IS '网站名称，长度限制1-200字符';
COMMENT ON COLUMN crawler_rules.site_url IS '网站地址，URL格式，必须以http://或https://开头';
COMMENT ON COLUMN crawler_rules.rule_steps IS '规则步骤，JSONB格式，存储规则步骤数组，每个步骤包含步骤类型（request、process、download）、步骤顺序、步骤配置等';
COMMENT ON COLUMN crawler_rules.rule_tags IS '规则标签，JSONB格式，存储标签定义，标签名称和对应的数据';
COMMENT ON COLUMN crawler_rules.rule_status IS '规则状态：draft-草稿、validating-验证中、confirmed-已确认、active-已激活、inactive-已停用';
COMMENT ON COLUMN crawler_rules.is_active IS '是否启用，TRUE-启用，FALSE-禁用';
COMMENT ON COLUMN crawler_rules.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN crawler_rules.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_crawler_rules` (id)
- **唯一约束**：`uk_crawler_rules_rule_name` (rule_name)
- **检查约束**：`ck_crawler_rules_rule_status` (rule_status) - 确保规则状态是预定义的值
- **检查约束**：`ck_crawler_rules_site_url` (site_url) - 确保网站地址是有效的URL格式
- **非空约束**：rule_name、site_name、site_url、rule_steps、rule_status 必须非空
- **默认值**：rule_status 默认为 'draft'，is_active 默认为 TRUE
- **可选字段**：rule_tags 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_crawler_rules` (id) - 自动创建
- **唯一索引**：`uk_crawler_rules_rule_name` (rule_name) - 确保规则名称唯一
- **普通索引**：`idx_crawler_rules_site_name` (site_name) - 用于网站名称搜索
- **普通索引**：`idx_crawler_rules_rule_status` (rule_status) - 用于按规则状态筛选
- **普通索引**：`idx_crawler_rules_is_active` (is_active) - 用于按启用状态筛选
- **普通索引**：`idx_crawler_rules_created_at` (created_at) - 用于按创建时间排序
- **GIN 索引**：`idx_crawler_rules_rule_steps` (rule_steps) - 用于高效查询 JSONB 规则步骤
- **GIN 索引**：`idx_crawler_rules_rule_tags` (rule_tags) - 用于高效查询 JSONB 规则标签
- **复合索引**：`idx_crawler_rules_status_active` (rule_status, is_active) - 用于按规则状态和启用状态筛选

### 5. 考虑性能优化

- 为 rule_name 创建唯一索引，支持快速查询和唯一性检查
- 为 site_name 创建索引，支持网站名称搜索
- 为 rule_status 和 is_active 创建索引，支持状态筛选查询
- 为 created_at 创建索引，支持时间排序查询
- 为 rule_steps 和 rule_tags 创建 GIN 索引，支持高效查询 JSONB 数据
- 使用复合索引优化常用查询场景（如按规则状态和启用状态筛选）
- 使用触发器自动更新 updated_at 字段

### 6. JSONB 字段结构示例

```json
// rule_steps 示例
[
  {
    "step_order": 1,
    "step_type": "request",
    "step_config": {
      "url": "https://example.com/list",
      "method": "GET",
      "headers": {}
    }
  },
  {
    "step_order": 2,
    "step_type": "process",
    "step_config": {
      "pattern": "{{**}}",
      "extract_field": "title"
    }
  }
]

// rule_tags 示例
{
  "tag1": "value1",
  "tag2": "{$previous_step_result}"
}
```

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 唯一约束正确，确保规则名称唯一
4. 检查约束正确，确保规则状态、网站地址等是有效的值
5. 索引设计合理，支持常用查询场景（包括按规则名称查询、按网站名称搜索、按规则状态筛选）
6. 为 JSONB 字段创建 GIN 索引，支持高效查询规则步骤和标签
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新 updated_at 字段
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Crawler.md` - 采集模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

