# TASK002-78: 数据库设计 - 核心模块 - 订阅记录表

## 任务信息

**任务编号**: TASK002-78  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 订阅记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 10:30:00 CST

## 任务描述

设计核心模块的订阅记录表（subscriptions），用于存储用户订阅作品记录。订阅记录用于收益计算，支持订阅收益统计。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解订阅功能的详细需求：

**功能需求**：
- 用户可以对作品进行订阅
- 订阅记录用于收益计算（订阅收益）
- 支持订阅和取消订阅
- 记录订阅的开始和结束时间

**订阅收益规则**：
- 内容类型：小说、漫画、音频、视频
- 订阅起点：达到多少订阅后才开始进行收益计算
- 收益金额：每一个订阅转换为多少网站消费货币

**订阅状态**：
- 已订阅（subscribed）：用户已订阅作品
- 已取消（cancelled）：用户已取消订阅

### 2. 设计订阅记录表结构

设计 `subscriptions` 表：

```sql
CREATE TABLE subscriptions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    subscription_status VARCHAR(20) NOT NULL DEFAULT 'subscribed',
    subscription_start_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    subscription_end_time TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_subscriptions_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT ck_subscriptions_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_subscriptions_subscription_status CHECK (subscription_status IN ('subscribed', 'cancelled')),
    CONSTRAINT ck_subscriptions_content_id CHECK (content_id > 0),
    CONSTRAINT uk_subscriptions_user_content UNIQUE (user_id, content_type, content_id)
);

-- 创建索引
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_content_type ON subscriptions(content_type);
CREATE INDEX idx_subscriptions_content_id ON subscriptions(content_id);
CREATE INDEX idx_subscriptions_subscription_status ON subscriptions(subscription_status);
CREATE INDEX idx_subscriptions_subscription_start_time ON subscriptions(subscription_start_time);
CREATE INDEX idx_subscriptions_subscription_end_time ON subscriptions(subscription_end_time);
CREATE INDEX idx_subscriptions_created_at ON subscriptions(created_at);
CREATE INDEX idx_subscriptions_content_type_id ON subscriptions(content_type, content_id);
CREATE INDEX idx_subscriptions_user_status ON subscriptions(user_id, subscription_status);
CREATE INDEX idx_subscriptions_status_time ON subscriptions(subscription_status, subscription_start_time);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_subscriptions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_subscriptions_updated_at
    BEFORE UPDATE ON subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION update_subscriptions_updated_at();

-- 添加表注释
COMMENT ON TABLE subscriptions IS '订阅记录表，存储用户订阅作品记录，用于收益计算';
COMMENT ON COLUMN subscriptions.id IS '订阅ID，自增主键';
COMMENT ON COLUMN subscriptions.user_id IS '用户ID，外键关联users表，删除用户时级联删除订阅记录';
COMMENT ON COLUMN subscriptions.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN subscriptions.content_id IS '内容ID，关联对应内容表（novels、comics、audios、videos），必须大于0';
COMMENT ON COLUMN subscriptions.subscription_status IS '订阅状态：subscribed-已订阅、cancelled-已取消';
COMMENT ON COLUMN subscriptions.subscription_start_time IS '订阅开始时间，用户订阅作品的时间，默认为当前时间';
COMMENT ON COLUMN subscriptions.subscription_end_time IS '订阅结束时间，用户取消订阅的时间，取消订阅时填充';
COMMENT ON COLUMN subscriptions.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN subscriptions.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_subscriptions` (id)
- **唯一约束**：`uk_subscriptions_user_content` (user_id, content_type, content_id) - 确保同一用户对同一作品只能有一条订阅记录
- **外键约束**：
  - `fk_subscriptions_user_id`：user_id 关联 users 表，删除用户时级联删除订阅记录
- **非空约束**：user_id、content_type、content_id、subscription_status、subscription_start_time 必须非空
- **检查约束**：
  - `ck_subscriptions_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_subscriptions_subscription_status`：subscription_status 必须是预定义的值之一（subscribed、cancelled）
  - `ck_subscriptions_content_id`：content_id 必须大于 0
- **默认值**：
  - subscription_status 默认为 'subscribed'
  - subscription_start_time 默认为当前时间
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_subscriptions` (id) - 自动创建
- **唯一索引**：`uk_subscriptions_user_content` (user_id, content_type, content_id) - 自动创建
- **普通索引**：
  - `idx_subscriptions_user_id` (user_id) - 用于查询用户的订阅记录
  - `idx_subscriptions_content_type` (content_type) - 用于按内容类型查询
  - `idx_subscriptions_content_id` (content_id) - 用于查询作品的订阅记录
  - `idx_subscriptions_subscription_status` (subscription_status) - 用于按订阅状态查询
  - `idx_subscriptions_subscription_start_time` (subscription_start_time) - 用于按订阅开始时间排序和查询
  - `idx_subscriptions_subscription_end_time` (subscription_end_time) - 用于按订阅结束时间查询
  - `idx_subscriptions_created_at` (created_at) - 用于按创建时间排序和查询
- **复合索引**：
  - `idx_subscriptions_content_type_id` (content_type, content_id) - 用于查询特定作品的订阅记录（用于收益计算）
  - `idx_subscriptions_user_status` (user_id, subscription_status) - 用于查询用户特定状态的订阅记录
  - `idx_subscriptions_status_time` (subscription_status, subscription_start_time) - 用于查询特定状态并按时间排序（用于收益统计）

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户的订阅记录
- 创建复合索引 (content_type, content_id)，优化查询特定作品订阅记录的性能（用于收益计算）
- 创建复合索引 (user_id, subscription_status)，优化查询用户特定状态订阅记录的性能
- 创建复合索引 (subscription_status, subscription_start_time)，优化收益统计查询性能
- 使用唯一约束确保同一用户对同一作品只有一条订阅记录
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**订阅流程**：
1. **用户订阅**：
   - 用户订阅作品时，创建订阅记录
   - subscription_status 设置为 'subscribed'
   - subscription_start_time 设置为当前时间
   - subscription_end_time 为 NULL

2. **用户取消订阅**：
   - 用户取消订阅时，更新订阅记录
   - subscription_status 更新为 'cancelled'
   - subscription_end_time 设置为当前时间

**收益计算**：
- 订阅收益计算时，查询 subscription_status='subscribed' 且 subscription_start_time 在结算周期内的记录
- 统计每个作品的订阅数量，用于计算订阅收益
- 订阅起点：达到设定的订阅数量后才开始计算收益
- 收益金额：每个订阅转换为设定的消费货币金额

**内容关联**：
- content_type 和 content_id 组合关联对应的内容表：
  - novel + content_id → novels 表
  - comic + content_id → comics 表
  - audio + content_id → audios 表
  - video + content_id → videos 表

**唯一性约束**：
- 同一用户对同一作品只能有一条订阅记录
- 如果用户取消订阅后再次订阅，更新现有记录而不是创建新记录

**订阅自动消费记录**：
- **记录位置**：
  - 订阅记录表（subscriptions）仅记录用户订阅了哪个作品，不记录订阅后自动消费的具体内容
  - 订阅后自动消费的具体内容（章节、分集等）记录在**流水表（transactions）**和**流水详情表（transaction_details）**中
- **记录方式**：
  1. **流水表（transactions）**：记录订阅自动消费的流水，transaction_type='consume'，description 中可以标注"订阅自动消费"
  2. **流水详情表（transaction_details）**：记录消费的具体内容（章节、分集等），related_type 为 'novel_chapter'、'comic_chapter'、'audio_episode'、'video_episode' 等
  3. **关联订阅信息**：流水详情表的 snapshot_data 中应包含订阅信息，用于关联查询：
     ```json
     {
       "chapter_name": "第一章",
       "novel_name": "小说名称",
       "novel_id": 123,
       "subscription_id": 456,  // 关联的订阅ID，用于查询订阅自动消费记录
       "auto_consumed": true,   // 标识为订阅自动消费
       "subscription_start_time": "2026-01-01T00:00:00Z"  // 订阅开始时间
     }
     ```
- **查询方式**：
  - **通过订阅ID查询**：在流水详情表的 snapshot_data 中查询包含该订阅ID的记录（使用 JSONB 查询：`snapshot_data->>'subscription_id' = '456'`）
  - **通过用户和作品查询**：先查询订阅记录获取订阅ID，再在流水详情表中查询包含该订阅ID的消费记录
  - **通过时间范围查询**：结合订阅开始时间和结束时间，查询该时间段内的自动消费记录
- **收益计算**：
  - **订阅收益**：基于订阅记录表统计订阅数量，用于计算订阅收益（每个订阅转换为设定的消费货币金额）
  - **阅读收益**：基于流水表统计订阅自动消费产生的阅读收益（用户通过订阅自动消费章节/分集产生的收益）
- **故障排查**：
  - 通过订阅记录表可以查询用户订阅了哪些作品
  - 通过流水详情表可以查询订阅后自动消费了哪些具体内容（章节、分集等）
  - 通过 snapshot_data 中的 subscription_id 可以关联订阅记录和消费记录，便于完整追踪订阅消费历史

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按用户查询、按作品查询、按状态查询、收益计算查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持用户关联
7. 唯一约束正确设置，确保同一用户对同一作品只有一条订阅记录
8. 检查约束正确设置，确保内容类型、订阅状态和内容ID的值有效
9. 创建复合索引优化收益计算和统计查询性能
10. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 3.2.2 节 - 订阅收益）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 3.2.2 节 - 订阅收益）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-37.md` - 流水表设计文档（订阅自动消费记录在流水表中）
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.1  
**最后更新**: 2026-01-03 10:45:00 CST

