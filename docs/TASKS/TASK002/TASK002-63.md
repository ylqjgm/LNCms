# TASK002-63: 数据库设计 - 核心模块 - 付费规则表

## 任务信息

**任务编号**: TASK002-63  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 付费规则表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:05:36 CST

## 任务描述

设计核心模块的付费规则表（pricing_rules），用于存储读者阅读时的收费标准配置。支持多设定模式（可添加、修改、删除），针对不同内容类型和收费类型设置不同的收费标准。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解付费设置的详细需求：

**功能需求**：
- 对读者阅读时的收费标准进行配置
- 支持多设定模式（可添加、修改、删除）
- 针对不同内容类型设置不同的收费标准

**配置项**：
- 内容类型：小说、漫画、音频、视频
- 收费类型：按字数、按章节、按图片、按时长等
- 收费标准：依据类型而决定
  - 字数为每千字收费标准
  - 章节为每章节收费标准
  - 图片为每张图片收费标准
  - 时长为每分钟收费标准
  - 所有费用单位均为网站中的一个消费货币，可为小数点

### 2. 设计付费规则表结构

设计 `pricing_rules` 表，包含付费规则配置：

```sql
CREATE TABLE pricing_rules (
    id BIGSERIAL PRIMARY KEY,
    content_type VARCHAR(20) NOT NULL,
    pricing_type VARCHAR(20) NOT NULL,
    pricing_value NUMERIC(10, 2) NOT NULL,
    rule_name VARCHAR(100),
    rule_description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    priority INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_pricing_rules_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_pricing_rules_pricing_type CHECK (pricing_type IN ('word', 'chapter', 'image', 'duration')),
    CONSTRAINT ck_pricing_rules_pricing_value CHECK (pricing_value >= 0)
);

-- 创建索引
CREATE INDEX idx_pricing_rules_content_type ON pricing_rules(content_type);
CREATE INDEX idx_pricing_rules_pricing_type ON pricing_rules(pricing_type);
CREATE INDEX idx_pricing_rules_is_active ON pricing_rules(is_active);
CREATE INDEX idx_pricing_rules_priority ON pricing_rules(priority);
CREATE INDEX idx_pricing_rules_content_pricing ON pricing_rules(content_type, pricing_type);
CREATE INDEX idx_pricing_rules_content_active ON pricing_rules(content_type, is_active);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_pricing_rules_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_pricing_rules_updated_at
    BEFORE UPDATE ON pricing_rules
    FOR EACH ROW
    EXECUTE FUNCTION update_pricing_rules_updated_at();

-- 添加表注释
COMMENT ON TABLE pricing_rules IS '付费规则表，存储读者阅读时的收费标准配置，支持多设定模式';
COMMENT ON COLUMN pricing_rules.id IS '规则ID，自增主键';
COMMENT ON COLUMN pricing_rules.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN pricing_rules.pricing_type IS '收费类型：word-按字数（每千字）、chapter-按章节（每章节）、image-按图片（每张图片）、duration-按时长（每分钟）';
COMMENT ON COLUMN pricing_rules.pricing_value IS '收费标准，数值类型，单位：消费货币，支持小数点，如每千字0.1消费货币、每章节1.5消费货币等';
COMMENT ON COLUMN pricing_rules.rule_name IS '规则名称，用于标识和管理付费规则';
COMMENT ON COLUMN pricing_rules.rule_description IS '规则描述，说明规则的用途和适用范围';
COMMENT ON COLUMN pricing_rules.is_active IS '是否启用，TRUE-启用，FALSE-禁用，禁用的规则不参与计费';
COMMENT ON COLUMN pricing_rules.priority IS '优先级，数值越大优先级越高，当存在多条规则时，按优先级生效，默认0';
COMMENT ON COLUMN pricing_rules.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN pricing_rules.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_pricing_rules` (id)
- **非空约束**：content_type、pricing_type、pricing_value 必须非空
- **检查约束**：
  - `ck_pricing_rules_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_pricing_rules_pricing_type`：pricing_type 必须是预定义的值之一（word、chapter、image、duration）
  - `ck_pricing_rules_pricing_value`：pricing_value 必须大于等于 0
- **默认值**：
  - is_active 默认为 TRUE
  - priority 默认为 0

### 4. 设计索引

- **主键索引**：`pk_pricing_rules` (id) - 自动创建
- **普通索引**：
  - `idx_pricing_rules_content_type` (content_type) - 用于按内容类型查询
  - `idx_pricing_rules_pricing_type` (pricing_type) - 用于按收费类型查询
  - `idx_pricing_rules_is_active` (is_active) - 用于筛选启用的规则
  - `idx_pricing_rules_priority` (priority) - 用于按优先级排序
- **复合索引**：
  - `idx_pricing_rules_content_pricing` (content_type, pricing_type) - 用于按内容类型和收费类型组合查询，常用查询场景
  - `idx_pricing_rules_content_active` (content_type, is_active) - 用于按内容类型查询启用的规则

### 5. 考虑性能优化

- 为 content_type 和 pricing_type 创建索引，支持快速查询特定内容类型或收费类型的规则
- 创建复合索引 (content_type, pricing_type)，优化按内容和收费类型组合查询的性能
- 创建复合索引 (content_type, is_active)，优化查询特定内容类型启用的规则
- 使用 NUMERIC 类型存储收费标准，确保精度和计算的准确性
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**规则匹配逻辑**：
1. 当读者阅读内容时，系统根据内容类型查找对应的付费规则
2. 如果存在多条规则，按照优先级（priority）排序，优先级高的规则优先生效
3. 只有 is_active 为 TRUE 的规则才会被使用
4. 根据 pricing_type 和 pricing_value 计算实际费用：
   - word（按字数）：费用 = (字数 / 1000) × pricing_value
   - chapter（按章节）：费用 = pricing_value
   - image（按图片）：费用 = 图片数量 × pricing_value
   - duration（按时长）：费用 = (时长（分钟）) × pricing_value

**规则管理**：
1. 管理员可以创建、修改、删除付费规则
2. 支持为同一内容类型和收费类型创建多条规则，通过优先级控制生效顺序
3. 可以通过 is_active 字段启用或禁用规则，无需删除

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按内容类型、收费类型查询，组合查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 检查约束正确设置，确保内容类型、收费类型和收费标准的值有效
7. 使用 NUMERIC 类型存储收费标准，确保精度
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 3.1 节 - 付费设置）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 3.1 节 - 付费设置）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:05:36 CST

