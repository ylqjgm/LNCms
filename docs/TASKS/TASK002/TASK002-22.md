# TASK002-22: 数据库设计 - 核心模块 - 小说章节附件表

## 任务信息

**任务编号**: TASK002-22  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 小说章节附件表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的小说章节附件表（novel_chapter_attachments），用于存储小说章节附件信息。附件表关联核心模块的files表（而非存储模块的files表），以支持存储模块可选性，确保系统在未使用存储模块时也能正常工作。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-21（小说章节表）、核心模块files表（需要确认是否存在相关设计任务）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解小说管理的详细需求：
- 小说章节附件管理：章节附件，包括图片、音频等附件
- 附件属于章节，需要关联章节表
- 附件关联文件，需要关联核心模块的files表（而非存储模块的files表）
- 文件资源存在唯一性原则，会进行去重操作
- 附件的存储、调用基于文件编号（file_id），文件URL通过files表的storage_url字段获取

### 2. 设计小说章节附件表结构

**设计说明**：
- 附件表关联核心模块的files表（而非存储模块的files表）
- 这样设计可以支持存储模块可选性，无论是否使用存储模块，系统都能正常工作
- 如果使用存储模块，文件信息通过gRPC同步到核心模块的files表
- 文件URL通过files表的storage_url字段获取，不在附件表中重复存储

设计 `novel_chapter_attachments` 表，包含小说章节附件信息：

```sql
CREATE TABLE novel_chapter_attachments (
    id BIGSERIAL PRIMARY KEY,
    chapter_id BIGINT NOT NULL,
    file_id BIGINT NOT NULL,
    attachment_type VARCHAR(50) NOT NULL,
    attachment_order INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_novel_chapter_attachments_chapter_id FOREIGN KEY (chapter_id) REFERENCES novel_chapters(id) ON DELETE CASCADE,
    CONSTRAINT fk_novel_chapter_attachments_file_id FOREIGN KEY (file_id) REFERENCES files(id) ON DELETE CASCADE,
    CONSTRAINT ck_novel_chapter_attachments_attachment_type CHECK (attachment_type IN ('image', 'audio', 'video', 'document'))
);

-- 创建索引
CREATE INDEX idx_novel_chapter_attachments_chapter_id ON novel_chapter_attachments(chapter_id);
CREATE INDEX idx_novel_chapter_attachments_file_id ON novel_chapter_attachments(file_id);
CREATE INDEX idx_novel_chapter_attachments_attachment_type ON novel_chapter_attachments(attachment_type);
CREATE INDEX idx_novel_chapter_attachments_attachment_order ON novel_chapter_attachments(attachment_order);
CREATE INDEX idx_novel_chapter_attachments_chapter_order ON novel_chapter_attachments(chapter_id, attachment_order);

-- 添加表注释
COMMENT ON TABLE novel_chapter_attachments IS '小说章节附件表，存储小说章节附件信息';
COMMENT ON COLUMN novel_chapter_attachments.id IS '附件ID，自增主键';
COMMENT ON COLUMN novel_chapter_attachments.chapter_id IS '章节ID，外键关联novel_chapters表';
COMMENT ON COLUMN novel_chapter_attachments.file_id IS '文件ID，外键关联核心模块files表';
COMMENT ON COLUMN novel_chapter_attachments.attachment_type IS '附件类型：image-图片、audio-音频、video-视频、document-文档';
COMMENT ON COLUMN novel_chapter_attachments.attachment_order IS '附件排序，数字越小越靠前，用于排序显示';
COMMENT ON COLUMN novel_chapter_attachments.created_at IS '创建时间，自动设置为当前时间';
```

### 3. 设计约束

- **主键约束**：`pk_novel_chapter_attachments` (id)
- **外键约束**：`fk_novel_chapter_attachments_chapter_id` (chapter_id) 关联 novel_chapters(id)，级联删除
- **外键约束**：`fk_novel_chapter_attachments_file_id` (file_id) 关联核心模块 files(id)，级联删除
- **检查约束**：`ck_novel_chapter_attachments_attachment_type` (attachment_type) - 确保附件类型是预定义的值
- **非空约束**：chapter_id、file_id、attachment_type 必须非空
- **默认值**：attachment_order 默认为 0

### 4. 设计索引

- **主键索引**：`pk_novel_chapter_attachments` (id) - 自动创建
- **外键索引**：`idx_novel_chapter_attachments_chapter_id` (chapter_id) - 用于查询章节的附件
- **外键索引**：`idx_novel_chapter_attachments_file_id` (file_id) - 用于关联查询
- **普通索引**：`idx_novel_chapter_attachments_attachment_type` (attachment_type) - 用于按类型筛选
- **普通索引**：`idx_novel_chapter_attachments_attachment_order` (attachment_order) - 用于排序查询
- **复合索引**：`idx_novel_chapter_attachments_chapter_order` (chapter_id, attachment_order) - 用于查询章节的附件并按排序显示

### 5. 考虑性能优化

- 为 chapter_id 创建索引，支持快速查询章节的附件
- 为 file_id 创建索引，支持关联查询核心模块files表
- 为 attachment_type 创建索引，支持按类型筛选
- 使用复合索引优化按章节和排序的查询
- 外键约束使用 CASCADE 删除，确保数据一致性
- **设计优势**：
  - 支持存储模块可选性，无论是否使用存储模块，系统都能正常工作
  - 核心模块统一管理文件信息，保证数据一致性
  - 文件URL通过files表的storage_url字段获取，不在附件表中重复存储
  - 如果使用存储模块，文件信息通过gRPC同步到核心模块files表

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 novel_chapters 和核心模块 files 表
4. 检查约束正确，确保附件类型是预定义的值
5. 索引设计合理，支持常用查询场景
6. 表注释和字段注释完整，使用中文
7. 设计支持存储模块可选性，关联核心模块files表而非存储模块files表
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-21.md` - 小说章节表设计文档
- 核心模块files表设计文档（需要确认是否存在相关设计任务）
- `docs/TASKS/TASK002/TASK002-22-ANALYSIS.md` - 设计合理性分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 00:38:54 CST

