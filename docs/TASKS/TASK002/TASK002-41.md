# TASK002-41: 数据库设计 - 存储模块 - 文件表

## 任务信息

**任务编号**: TASK002-41  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 存储模块 - 文件表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计存储模块的文件表（files），用于存储文件基本信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Storage.md` 文档，了解文件管理的详细需求：
- 文件管理：文件上传、文件查询、文件删除、文件统计
- 文件需要支持唯一性检测（通过哈希值）
- 文件需要支持文件类型、文件大小、存储路径等信息
- 文件需要支持存储类型（本地存储、云存储等）

### 2. 设计文件表结构

设计 `files` 表，包含文件基本信息：

```sql
CREATE TABLE files (
    id BIGSERIAL PRIMARY KEY,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    mime_type VARCHAR(100),
    file_hash VARCHAR(64) NOT NULL UNIQUE,
    storage_type VARCHAR(20) NOT NULL DEFAULT 'local',
    storage_path VARCHAR(500),
    width INTEGER,
    height INTEGER,
    duration INTEGER,
    file_status VARCHAR(20) NOT NULL DEFAULT 'normal',
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_files_file_size CHECK (file_size > 0),
    CONSTRAINT ck_files_storage_type CHECK (storage_type IN ('local', 'remote', 'cloud')),
    CONSTRAINT ck_files_file_status CHECK (file_status IN ('normal', 'transcoding', 'transcode_failed', 'deleted'))
);

-- 创建索引
CREATE UNIQUE INDEX uk_files_file_hash ON files(file_hash);
CREATE INDEX idx_files_file_name ON files(file_name);
CREATE INDEX idx_files_file_type ON files(file_type);
CREATE INDEX idx_files_storage_type ON files(storage_type);
CREATE INDEX idx_files_file_status ON files(file_status);
CREATE INDEX idx_files_created_at ON files(created_at);
CREATE INDEX idx_files_file_type_status ON files(file_type, file_status);
CREATE INDEX idx_files_storage_type_status ON files(storage_type, file_status);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_files_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_files_updated_at
    BEFORE UPDATE ON files
    FOR EACH ROW
    EXECUTE FUNCTION update_files_updated_at();

-- 添加表注释
COMMENT ON TABLE files IS '文件表，存储文件基本信息';
COMMENT ON COLUMN files.id IS '文件ID，自增主键';
COMMENT ON COLUMN files.file_name IS '文件名，原始文件名';
COMMENT ON COLUMN files.file_path IS '文件路径，文件在存储系统中的路径';
COMMENT ON COLUMN files.file_size IS '文件大小，单位：字节，必须大于0';
COMMENT ON COLUMN files.file_type IS '文件类型，如：image、video、audio、document等';
COMMENT ON COLUMN files.mime_type IS 'MIME类型，如：image/jpeg、video/mp4等';
COMMENT ON COLUMN files.file_hash IS '文件哈希值，SHA256格式，64字符，用于文件去重，唯一标识符';
COMMENT ON COLUMN files.storage_type IS '存储类型：local-本地存储、remote-远程存储、cloud-云存储';
COMMENT ON COLUMN files.storage_path IS '存储路径，文件在存储系统中的完整路径';
COMMENT ON COLUMN files.width IS '宽度，单位：像素，仅对图片和视频有效';
COMMENT ON COLUMN files.height IS '高度，单位：像素，仅对图片和视频有效';
COMMENT ON COLUMN files.duration IS '时长，单位：秒，仅对视频和音频有效';
COMMENT ON COLUMN files.file_status IS '文件状态：normal-正常、transcoding-转码中、transcode_failed-转码失败、deleted-已删除';
COMMENT ON COLUMN files.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN files.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_files` (id)
- **唯一约束**：`uk_files_file_hash` (file_hash) - 确保文件哈希值唯一，实现文件去重
- **检查约束**：`ck_files_file_size` (file_size) - 确保文件大小大于0
- **检查约束**：`ck_files_storage_type` (storage_type) - 确保存储类型是预定义的值
- **检查约束**：`ck_files_file_status` (file_status) - 确保文件状态是预定义的值
- **非空约束**：file_name、file_path、file_size、file_type、file_hash、storage_type、file_status 必须非空
- **默认值**：storage_type 默认为 'local'，file_status 默认为 'normal'
- **可选字段**：mime_type、storage_path、width、height、duration 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_files` (id) - 自动创建
- **唯一索引**：`uk_files_file_hash` (file_hash) - 确保文件哈希值唯一，同时支持快速查询和文件去重
- **普通索引**：`idx_files_file_name` (file_name) - 用于文件名搜索
- **普通索引**：`idx_files_file_type` (file_type) - 用于按文件类型筛选
- **普通索引**：`idx_files_storage_type` (storage_type) - 用于按存储类型筛选
- **普通索引**：`idx_files_file_status` (file_status) - 用于按文件状态筛选
- **普通索引**：`idx_files_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_files_file_type_status` (file_type, file_status) - 用于按文件类型和状态筛选
- **复合索引**：`idx_files_storage_type_status` (storage_type, file_status) - 用于按存储类型和状态筛选

### 5. 考虑性能优化

- 为 file_hash 创建唯一索引，支持快速查询和文件去重
- 为 file_name 创建索引，支持文件名搜索
- 为 file_type、storage_type、file_status 创建索引，支持状态筛选查询
- 为 created_at 创建索引，支持时间排序查询
- 使用复合索引优化常用查询场景（如按文件类型和状态筛选、按存储类型和状态筛选）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 唯一约束正确，确保文件哈希值唯一，实现文件去重
4. 检查约束正确，确保文件大小、存储类型、文件状态等是有效的值
5. 索引设计合理，支持常用查询场景（包括按文件名搜索、按文件类型筛选、按存储类型筛选、按文件状态筛选）
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Storage.md` - 存储模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

