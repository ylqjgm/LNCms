# TASK002-37: 数据库设计 - 核心模块 - 流水表

## 任务信息

**任务编号**: TASK002-37  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 流水表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的流水表（transactions），用于存储用户消费和充值流水记录。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-34（渠道表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解流水管理的详细需求：
- 流水管理：充值流水、消费流水、流水查询、流水统计
- 流水属于用户，需要关联用户表
- 流水需要关联渠道，标识支付来源
- 流水需要支持流水类型（充值、消费）、流水状态等

### 2. 设计流水表结构

设计 `transactions` 表，包含流水基本信息：

```sql
CREATE TABLE transactions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    channel_id BIGINT,
    transaction_type VARCHAR(20) NOT NULL,
    transaction_code VARCHAR(50) NOT NULL UNIQUE,
    amount NUMERIC(10, 2) NOT NULL,
    balance_before NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    balance_after NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    transaction_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    description TEXT,
    external_transaction_id VARCHAR(100),
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_transactions_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_transactions_channel_id FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE SET NULL,
    CONSTRAINT ck_transactions_transaction_type CHECK (transaction_type IN ('recharge', 'consume', 'refund', 'other')),
    CONSTRAINT ck_transactions_amount CHECK (amount != 0),
    CONSTRAINT ck_transactions_transaction_status CHECK (transaction_status IN ('pending', 'processing', 'completed', 'failed', 'cancelled'))
);

-- 创建索引
CREATE INDEX idx_transactions_user_id ON transactions(user_id);
CREATE INDEX idx_transactions_channel_id ON transactions(channel_id);
CREATE UNIQUE INDEX uk_transactions_transaction_code ON transactions(transaction_code);
CREATE INDEX idx_transactions_transaction_type ON transactions(transaction_type);
CREATE INDEX idx_transactions_transaction_status ON transactions(transaction_status);
CREATE INDEX idx_transactions_completed_at ON transactions(completed_at);
CREATE INDEX idx_transactions_created_at ON transactions(created_at);
CREATE INDEX idx_transactions_external_transaction_id ON transactions(external_transaction_id);
CREATE INDEX idx_transactions_user_type ON transactions(user_id, transaction_type);
CREATE INDEX idx_transactions_user_status ON transactions(user_id, transaction_status);
CREATE INDEX idx_transactions_user_created ON transactions(user_id, created_at);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_transactions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_transactions_updated_at
    BEFORE UPDATE ON transactions
    FOR EACH ROW
    EXECUTE FUNCTION update_transactions_updated_at();

-- 添加表注释
COMMENT ON TABLE transactions IS '流水表，存储用户消费和充值流水记录';
COMMENT ON COLUMN transactions.id IS '流水ID，自增主键';
COMMENT ON COLUMN transactions.user_id IS '用户ID，外键关联users表';
COMMENT ON COLUMN transactions.channel_id IS '渠道ID，外键关联channels表，标识支付来源';
COMMENT ON COLUMN transactions.transaction_type IS '流水类型：recharge-充值、consume-消费、refund-退费、other-其他';
COMMENT ON COLUMN transactions.transaction_code IS '流水代码，唯一标识符，用于系统内部识别';
COMMENT ON COLUMN transactions.amount IS '流水金额，单位：元，正数表示收入（充值），负数表示支出（消费），不能为0';
COMMENT ON COLUMN transactions.balance_before IS '操作前余额，单位：元';
COMMENT ON COLUMN transactions.balance_after IS '操作后余额，单位：元';
COMMENT ON COLUMN transactions.transaction_status IS '流水状态：pending-待处理、processing-处理中、completed-已完成、failed-失败、cancelled-已取消';
COMMENT ON COLUMN transactions.description IS '流水描述，说明流水的用途和内容';
COMMENT ON COLUMN transactions.external_transaction_id IS '外部流水ID，第三方支付平台的流水ID';
COMMENT ON COLUMN transactions.completed_at IS '完成时间，流水完成时的时间';
COMMENT ON COLUMN transactions.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN transactions.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_transactions` (id)
- **外键约束**：`fk_transactions_user_id` (user_id) 关联 users(id)，级联删除
- **外键约束**：`fk_transactions_channel_id` (channel_id) 关联 channels(id)，删除时设置为 NULL
- **唯一约束**：`uk_transactions_transaction_code` (transaction_code)
- **检查约束**：`ck_transactions_transaction_type` (transaction_type) - 确保流水类型是预定义的值
- **检查约束**：`ck_transactions_amount` (amount) - 确保金额不为0
- **检查约束**：`ck_transactions_transaction_status` (transaction_status) - 确保流水状态是预定义的值
- **非空约束**：user_id、transaction_type、transaction_code、amount、transaction_status 必须非空
- **默认值**：balance_before、balance_after 默认为 0.00，transaction_status 默认为 'pending'
- **可选字段**：channel_id、description、external_transaction_id、completed_at 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_transactions` (id) - 自动创建
- **外键索引**：`idx_transactions_user_id` (user_id) - 用于查询用户的流水
- **外键索引**：`idx_transactions_channel_id` (channel_id) - 用于查询渠道的流水
- **唯一索引**：`uk_transactions_transaction_code` (transaction_code) - 确保流水代码唯一
- **普通索引**：`idx_transactions_transaction_type` (transaction_type) - 用于按类型筛选
- **普通索引**：`idx_transactions_transaction_status` (transaction_status) - 用于按状态筛选
- **普通索引**：`idx_transactions_completed_at` (completed_at) - 用于按完成时间排序
- **普通索引**：`idx_transactions_created_at` (created_at) - 用于按创建时间排序
- **普通索引**：`idx_transactions_external_transaction_id` (external_transaction_id) - 用于查询外部流水
- **复合索引**：`idx_transactions_user_type` (user_id, transaction_type) - 用于查询用户的特定类型流水
- **复合索引**：`idx_transactions_user_status` (user_id, transaction_status) - 用于查询用户的特定状态流水
- **复合索引**：`idx_transactions_user_created` (user_id, created_at) - 用于查询用户的流水并按时间排序

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户的流水
- 为 channel_id 创建索引，支持查询渠道的流水
- 为 transaction_code 创建唯一索引，支持快速查询和唯一性检查
- 为 transaction_type 和 transaction_status 创建索引，支持按类型和状态筛选查询
- 为 completed_at 和 created_at 创建索引，支持时间排序查询
- 为 external_transaction_id 创建索引，支持查询外部流水
- 使用复合索引优化常用查询场景（如查询用户的特定类型流水、查询用户的特定状态流水、查询用户的流水并按时间排序）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 users 表和 channels 表
4. 唯一约束正确，确保流水代码唯一
5. 检查约束正确，确保流水类型、金额、流水状态等是有效的值
6. 索引设计合理，支持常用查询场景（包括按用户查询、按类型查询、按状态查询、按时间排序）
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新 updated_at 字段
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-10.md` - 用户表设计文档
- `docs/TASKS/TASK002/TASK002-34.md` - 渠道表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

