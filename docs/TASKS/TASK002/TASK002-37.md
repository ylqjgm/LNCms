# TASK002-37: 数据库设计 - 核心模块 - 流水表

## 任务信息

**任务编号**: TASK002-37  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 流水表  
**版本信息**: v2.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

设计核心模块的流水表（transactions）和流水详情表（transaction_details），用于存储用户消费和充值流水记录及其详细信息快照。流水表存储基本信息，流水详情表存储关联对象的详细信息快照，确保即使关联对象被删除也能继续查询和统计。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-33（渠道表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Features/Core.md` 和 `docs/Requirements/Core.md` 文档，了解流水管理的详细需求：
- 流水管理：充值流水、消费流水、流水查询、流水统计
- 流水属于用户，需要关联用户表
- 流水需要关联渠道，标识支付来源
- 流水需要支持流水类型（充值、消费）、流水状态等
- 流水需要同时记录实际现金金额和虚拟货币金额
- 流水需要关联消费对象，如购买虚拟物品、购买内容章节等，以便更好地统计查询
- 流水需要存储关联对象的详细信息快照，确保即使原对象被删除，也能继续查询和统计

### 2. 设计流水表结构

设计 `transactions` 表（流水主表）和 `transaction_details` 表（流水详情表），流水主表存储基本信息，流水详情表存储关联对象的详细信息快照。

#### 2.1 流水主表（transactions）

设计 `transactions` 表，包含流水基本信息：

```sql
CREATE TABLE transactions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    channel_id BIGINT,
    transaction_type VARCHAR(20) NOT NULL,
    transaction_code VARCHAR(50) NOT NULL UNIQUE,
    amount NUMERIC(10, 2) NOT NULL,
    balance_before NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    balance_after NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    virtual_currency_amount NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    virtual_currency_balance_before NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    virtual_currency_balance_after NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    transaction_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    description TEXT,
    external_transaction_id VARCHAR(100),
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_transactions_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_transactions_channel_id FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE SET NULL,
    CONSTRAINT ck_transactions_transaction_type CHECK (transaction_type IN ('recharge', 'consume', 'refund', 'other')),
    CONSTRAINT ck_transactions_amount CHECK (amount != 0),
    CONSTRAINT ck_transactions_transaction_status CHECK (transaction_status IN ('pending', 'processing', 'completed', 'failed', 'cancelled'))
);

-- 创建索引
CREATE INDEX idx_transactions_user_id ON transactions(user_id);
CREATE INDEX idx_transactions_channel_id ON transactions(channel_id);
CREATE UNIQUE INDEX uk_transactions_transaction_code ON transactions(transaction_code);
CREATE INDEX idx_transactions_transaction_type ON transactions(transaction_type);
CREATE INDEX idx_transactions_transaction_status ON transactions(transaction_status);
CREATE INDEX idx_transactions_completed_at ON transactions(completed_at);
CREATE INDEX idx_transactions_created_at ON transactions(created_at);
CREATE INDEX idx_transactions_external_transaction_id ON transactions(external_transaction_id);
CREATE INDEX idx_transactions_user_type ON transactions(user_id, transaction_type);
CREATE INDEX idx_transactions_user_status ON transactions(user_id, transaction_status);
CREATE INDEX idx_transactions_user_created ON transactions(user_id, created_at);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_transactions_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_transactions_updated_at
    BEFORE UPDATE ON transactions
    FOR EACH ROW
    EXECUTE FUNCTION update_transactions_updated_at();

-- 添加表注释
COMMENT ON TABLE transactions IS '流水主表，存储用户消费和充值流水的基本信息，关联对象的详细信息存储在transaction_details表中';
COMMENT ON COLUMN transactions.id IS '流水ID，自增主键';
COMMENT ON COLUMN transactions.user_id IS '用户ID，外键关联users表';
COMMENT ON COLUMN transactions.channel_id IS '渠道ID，外键关联channels表，标识支付来源';
COMMENT ON COLUMN transactions.transaction_type IS '流水类型：recharge-充值、consume-消费、refund-退费、other-其他';
COMMENT ON COLUMN transactions.transaction_code IS '流水代码，唯一标识符，用于系统内部识别';
COMMENT ON COLUMN transactions.amount IS '流水金额，实际现金金额，单位：元，正数表示收入（充值），负数表示支出（消费），不能为0';
COMMENT ON COLUMN transactions.balance_before IS '操作前余额，实际现金余额，单位：元';
COMMENT ON COLUMN transactions.balance_after IS '操作后余额，实际现金余额，单位：元';
COMMENT ON COLUMN transactions.virtual_currency_amount IS '虚拟货币金额，虚拟货币单位，正数表示收入，负数表示支出，可以为0';
COMMENT ON COLUMN transactions.virtual_currency_balance_before IS '操作前虚拟货币余额，虚拟货币单位';
COMMENT ON COLUMN transactions.virtual_currency_balance_after IS '操作后虚拟货币余额，虚拟货币单位';
COMMENT ON COLUMN transactions.transaction_status IS '流水状态：pending-待处理、processing-处理中、completed-已完成、failed-失败、cancelled-已取消';
COMMENT ON COLUMN transactions.description IS '流水描述，说明流水的用途和内容';
COMMENT ON COLUMN transactions.external_transaction_id IS '外部流水ID，第三方支付平台的流水ID';
COMMENT ON COLUMN transactions.completed_at IS '完成时间，流水完成时的时间';
COMMENT ON COLUMN transactions.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN transactions.updated_at IS '更新时间，每次更新时自动更新';
```

#### 2.2 流水详情表（transaction_details）

设计 `transaction_details` 表，存储流水关联对象的详细信息快照：

```sql
CREATE TABLE transaction_details (
    id BIGSERIAL PRIMARY KEY,
    transaction_id BIGINT NOT NULL,
    related_type VARCHAR(20) NOT NULL,
    related_id BIGINT,
    snapshot_data JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_transaction_details_transaction_id FOREIGN KEY (transaction_id) REFERENCES transactions(id) ON DELETE CASCADE,
    CONSTRAINT ck_transaction_details_related_type CHECK (related_type IN ('novel_chapter', 'comic_chapter', 'audio_episode', 'video_episode', 'virtual_item', 'ticket', 'other'))
);

-- 创建索引
CREATE INDEX idx_transaction_details_transaction_id ON transaction_details(transaction_id);
CREATE INDEX idx_transaction_details_related_type ON transaction_details(related_type);
CREATE INDEX idx_transaction_details_related_id ON transaction_details(related_id);
CREATE INDEX idx_transaction_details_related ON transaction_details(related_type, related_id);
CREATE INDEX idx_transaction_details_snapshot_data ON transaction_details USING GIN (snapshot_data);

-- 添加表注释
COMMENT ON TABLE transaction_details IS '流水详情表，存储流水关联对象的详细信息快照，确保即使原对象被删除也能继续查询和统计';
COMMENT ON COLUMN transaction_details.id IS '详情ID，自增主键';
COMMENT ON COLUMN transaction_details.transaction_id IS '流水ID，外键关联transactions表，级联删除';
COMMENT ON COLUMN transaction_details.related_type IS '关联类型：novel_chapter-小说章节、comic_chapter-漫画章节、audio_episode-音频分集、video_episode-视频分集、virtual_item-虚拟物品、ticket-票务、other-其他';
COMMENT ON COLUMN transaction_details.related_id IS '关联ID，关联对象的ID，用于记录消费关联的具体对象（即使对象被删除，此ID仍保留）';
COMMENT ON COLUMN transaction_details.snapshot_data IS '快照数据，JSON格式，存储关联对象的详细信息快照，包括：虚拟物品（名称、类型、价格等）、内容章节（章节名称、作品名称、作者等）、票务（名称、用途、价格等）等';
COMMENT ON COLUMN transaction_details.created_at IS '创建时间，自动设置为当前时间';

-- 快照数据示例结构说明
-- 虚拟物品快照：
-- {
--   "item_name": "打赏道具",
--   "item_type": "reward",
--   "item_price": 10.00,
--   "content_type": "novel"
-- }
-- 
-- 小说章节快照：
-- {
--   "chapter_name": "第一章",
--   "novel_name": "小说名称",
--   "novel_id": 123,
--   "author_name": "作者名称",
--   "author_id": 456
-- }
-- 
-- 票务快照：
-- {
--   "ticket_name": "打赏票",
--   "ticket_usage": "reward",
--   "ticket_price": 5.00
-- }
```

### 3. 设计约束

#### 3.1 流水主表约束

- **主键约束**：`pk_transactions` (id)
- **外键约束**：
  - `fk_transactions_user_id` (user_id) 关联 users(id)，级联删除
  - `fk_transactions_channel_id` (channel_id) 关联 channels(id)，删除时设置为 NULL
- **唯一约束**：`uk_transactions_transaction_code` (transaction_code)
- **检查约束**：
  - `ck_transactions_transaction_type` (transaction_type) - 确保流水类型是预定义的值（recharge、consume、refund、other）
  - `ck_transactions_amount` (amount) - 确保实际现金金额不为0
  - `ck_transactions_transaction_status` (transaction_status) - 确保流水状态是预定义的值
- **非空约束**：user_id、transaction_type、transaction_code、amount、virtual_currency_amount、virtual_currency_balance_before、virtual_currency_balance_after、transaction_status 必须非空
- **默认值**：balance_before、balance_after、virtual_currency_amount、virtual_currency_balance_before、virtual_currency_balance_after 默认为 0.00，transaction_status 默认为 'pending'
- **可选字段**：channel_id、description、external_transaction_id、completed_at 可为 NULL
- **关联信息**：关联对象的详细信息（虚拟物品、内容章节、票务等）存储在 transaction_details 表中

#### 3.2 流水详情表约束

- **主键约束**：`pk_transaction_details` (id)
- **外键约束**：`fk_transaction_details_transaction_id` (transaction_id) 关联 transactions(id)，级联删除
- **检查约束**：`ck_transaction_details_related_type` (related_type) - 确保关联类型是预定义的值（novel_chapter、comic_chapter、audio_episode、video_episode、virtual_item、ticket、other）
- **非空约束**：transaction_id、related_type、snapshot_data 必须非空
- **可选字段**：related_id 可为 NULL（某些关联类型可能不需要ID）

### 4. 设计索引

#### 4.1 流水主表索引

- **主键索引**：`pk_transactions` (id) - 自动创建
- **外键索引**：
  - `idx_transactions_user_id` (user_id) - 用于查询用户的流水
  - `idx_transactions_channel_id` (channel_id) - 用于查询渠道的流水
- **唯一索引**：`uk_transactions_transaction_code` (transaction_code) - 确保流水代码唯一
- **普通索引**：
  - `idx_transactions_transaction_type` (transaction_type) - 用于按类型筛选
  - `idx_transactions_transaction_status` (transaction_status) - 用于按状态筛选
  - `idx_transactions_completed_at` (completed_at) - 用于按完成时间排序
  - `idx_transactions_created_at` (created_at) - 用于按创建时间排序
  - `idx_transactions_external_transaction_id` (external_transaction_id) - 用于查询外部流水
- **复合索引**：
  - `idx_transactions_user_type` (user_id, transaction_type) - 用于查询用户的特定类型流水
  - `idx_transactions_user_status` (user_id, transaction_status) - 用于查询用户的特定状态流水
  - `idx_transactions_user_created` (user_id, created_at) - 用于查询用户的流水并按时间排序

#### 4.2 流水详情表索引

- **主键索引**：`pk_transaction_details` (id) - 自动创建
- **外键索引**：`idx_transaction_details_transaction_id` (transaction_id) - 用于查询流水的详细信息
- **普通索引**：
  - `idx_transaction_details_related_type` (related_type) - 用于按关联类型筛选
  - `idx_transaction_details_related_id` (related_id) - 用于按关联ID查询
- **复合索引**：`idx_transaction_details_related` (related_type, related_id) - 用于查询特定关联对象的流水详情
- **GIN 索引**：`idx_transaction_details_snapshot_data` (snapshot_data) - 用于 JSONB 快照数据的高效查询和过滤

### 5. 考虑性能优化

#### 5.1 流水主表性能优化

- 为 user_id 创建索引，支持快速查询用户的流水
- 为 channel_id 创建索引，支持查询渠道的流水
- 为 transaction_code 创建唯一索引，支持快速查询和唯一性检查
- 为 transaction_type 和 transaction_status 创建索引，支持按类型和状态筛选查询
- 为 completed_at 和 created_at 创建索引，支持时间排序查询
- 为 external_transaction_id 创建索引，支持查询外部流水
- 使用复合索引优化常用查询场景（如查询用户的特定类型流水、查询用户的特定状态流水、查询用户的流水并按时间排序）
- 使用触发器自动更新 updated_at 字段
- 关联对象的查询和统计通过 transaction_details 表进行

#### 5.2 流水详情表性能优化

- 为 transaction_id 创建索引，支持快速查询流水的详细信息
- 为 related_type 和 related_id 创建索引，支持按关联对象查询和统计
- 为 snapshot_data 创建 GIN 索引，支持 JSONB 字段的高效查询和过滤
- 使用复合索引优化常用查询场景（如查询特定关联对象的流水详情）

#### 5.3 表拆分优势

- **数据完整性**：即使关联对象被删除，快照数据仍然保留，可以继续查询和统计
- **查询性能**：流水主表保持简洁，查询性能更好；详情表独立存储，可按需查询
- **存储优化**：只有需要详细信息的流水才创建详情记录，节省存储空间
- **扩展性**：快照数据使用 JSONB 格式，可以灵活存储不同类型的详细信息

## 验收标准

1. 表结构设计完整，包含流水主表和流水详情表
2. 流水主表包含核心流水信息（用户、渠道、金额、余额、状态等），结构简洁
3. 流水详情表包含关联对象的详细信息快照，确保数据完整性
4. 所有字段都有适当的类型、约束和默认值
5. 外键约束正确，流水主表关联 users 表和 channels 表，流水详情表关联流水主表
6. 唯一约束正确，确保流水代码唯一
7. 检查约束正确，确保流水类型、金额、流水状态等是有效的值
8. 同时记录实际现金金额和虚拟货币金额，支持双重货币体系
9. 关联对象的详细信息（虚拟物品、内容章节、票务等）存储在流水详情表中，包含快照数据
10. 流水详情表使用 JSONB 格式存储快照数据，支持灵活的详细信息存储
11. 快照数据包含关联对象的关键信息（名称、类型、价格等），确保即使原对象被删除也能查询和统计
12. 关联类型支持：小说章节、漫画章节、音频分集、视频分集、虚拟物品、票务等
13. 索引设计合理，流水主表支持常用查询场景（按用户查询、按类型查询、按状态查询、按时间排序），流水详情表支持关联对象查询和统计
14. 两个表的信息记录准确、完整，流水主表存储核心信息，流水详情表存储详细信息快照
15. 表注释和字段注释完整，使用中文
16. 触发器正确创建，自动更新 updated_at 字段
17. 表设计符合 PostgreSQL 数据库设计规范
18. 表拆分设计合理，流水主表简洁高效，流水详情表保证数据完整性

## 相关文件

- `docs/Features/Core.md` - 核心模块功能概述文档（8.5 流水管理）
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-10.md` - 用户表设计文档
- `docs/TASKS/TASK002/TASK002-33.md` - 渠道表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 2.1  
**最后更新**: 2026-01-03 08:40:35 CST

