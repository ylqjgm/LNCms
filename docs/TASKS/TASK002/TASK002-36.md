# TASK002-36: 数据库设计 - 核心模块 - 退费表

## 任务信息

**任务编号**: TASK002-36  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 退费表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的退费表（refunds），用于存储退费记录信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-38（流水表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解退费管理的详细需求：
- 退费管理：退费申请、退费审核、退费处理、退费状态管理
- 退费关联流水表，记录退费对应的原始流水
- 退费需要支持退费原因、退费金额、退费状态等

### 2. 设计退费表结构

设计 `refunds` 表，包含退费基本信息：

```sql
CREATE TABLE refunds (
    id BIGSERIAL PRIMARY KEY,
    transaction_id BIGINT NOT NULL,
    refund_amount NUMERIC(10, 2) NOT NULL,
    refund_reason TEXT,
    refund_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    refunded_at TIMESTAMPTZ,
    processed_by BIGINT,
    processed_at TIMESTAMPTZ,
    remark TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_refunds_transaction_id FOREIGN KEY (transaction_id) REFERENCES transactions(id) ON DELETE RESTRICT,
    CONSTRAINT fk_refunds_processed_by FOREIGN KEY (processed_by) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT ck_refunds_refund_amount CHECK (refund_amount > 0),
    CONSTRAINT ck_refunds_refund_status CHECK (refund_status IN ('pending', 'approved', 'rejected', 'completed', 'cancelled'))
);

-- 创建索引
CREATE INDEX idx_refunds_transaction_id ON refunds(transaction_id);
CREATE INDEX idx_refunds_processed_by ON refunds(processed_by);
CREATE INDEX idx_refunds_refund_status ON refunds(refund_status);
CREATE INDEX idx_refunds_refunded_at ON refunds(refunded_at);
CREATE INDEX idx_refunds_created_at ON refunds(created_at);
CREATE INDEX idx_refunds_transaction_status ON refunds(transaction_id, refund_status);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_refunds_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_refunds_updated_at
    BEFORE UPDATE ON refunds
    FOR EACH ROW
    EXECUTE FUNCTION update_refunds_updated_at();

-- 添加表注释
COMMENT ON TABLE refunds IS '退费表，存储退费记录信息';
COMMENT ON COLUMN refunds.id IS '退费ID，自增主键';
COMMENT ON COLUMN refunds.transaction_id IS '流水ID，外键关联transactions表';
COMMENT ON COLUMN refunds.refund_amount IS '退费金额，单位：元，必须大于0';
COMMENT ON COLUMN refunds.refund_reason IS '退费原因';
COMMENT ON COLUMN refunds.refund_status IS '退费状态：pending-待审核、approved-已批准、rejected-已拒绝、completed-已完成、cancelled-已取消';
COMMENT ON COLUMN refunds.refunded_at IS '退费时间，退费完成时的时间';
COMMENT ON COLUMN refunds.processed_by IS '处理人ID，外键关联users表（管理员）';
COMMENT ON COLUMN refunds.processed_at IS '处理时间，审核或处理的时间';
COMMENT ON COLUMN refunds.remark IS '备注信息';
COMMENT ON COLUMN refunds.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN refunds.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_refunds` (id)
- **外键约束**：`fk_refunds_transaction_id` (transaction_id) 关联 transactions(id)，删除时禁止（RESTRICT）
- **外键约束**：`fk_refunds_processed_by` (processed_by) 关联 users(id)，删除时设置为 NULL
- **检查约束**：`ck_refunds_refund_amount` (refund_amount) - 确保退费金额大于0
- **检查约束**：`ck_refunds_refund_status` (refund_status) - 确保退费状态是预定义的值
- **非空约束**：transaction_id、refund_amount、refund_status 必须非空
- **默认值**：refund_status 默认为 'pending'
- **可选字段**：refund_reason、refunded_at、processed_by、processed_at、remark 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_refunds` (id) - 自动创建
- **外键索引**：`idx_refunds_transaction_id` (transaction_id) - 用于查询流水的退费记录
- **外键索引**：`idx_refunds_processed_by` (processed_by) - 用于查询处理人的退费记录
- **普通索引**：`idx_refunds_refund_status` (refund_status) - 用于按状态筛选
- **普通索引**：`idx_refunds_refunded_at` (refunded_at) - 用于按退费时间排序
- **普通索引**：`idx_refunds_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_refunds_transaction_status` (transaction_id, refund_status) - 用于查询流水的特定状态退费记录

### 5. 考虑性能优化

- 为 transaction_id 创建索引，支持快速查询流水的退费记录
- 为 processed_by 创建索引，支持查询处理人的退费记录
- 为 refund_status 创建索引，支持按状态筛选查询
- 为 refunded_at 和 created_at 创建索引，支持时间排序查询
- 使用复合索引优化常用查询场景（如查询流水的特定状态退费记录）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 transactions 表和 users 表
4. 检查约束正确，确保退费金额大于0，退费状态是预定义的值
5. 索引设计合理，支持常用查询场景（包括按流水查询、按状态查询、按时间排序）
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-38.md` - 流水表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

