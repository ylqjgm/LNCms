# TASK002-16: 数据库设计 - 核心模块 - 分类表

## 任务信息

**任务编号**: TASK002-16  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 分类表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的分类表（categories），用于存储内容分类信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。支持树形结构，支持多级分类。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解分类管理的详细需求：
- 分类管理：分类添加（分类名称、分类描述、上级分类、分类类型、分类排序）、分类修改、分类删除
- 分类支持树形结构，支持多级分类
- 分类类型：小说、漫画、音频、视频等

### 2. 设计分类表结构

设计 `categories` 表，包含分类基本信息，支持树形结构：

```sql
CREATE TABLE categories (
    id BIGSERIAL PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    category_description TEXT,
    parent_id BIGINT,
    category_type VARCHAR(50) NOT NULL,
    category_order INTEGER NOT NULL DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_categories_parent_id FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE SET NULL,
    CONSTRAINT ck_categories_category_type CHECK (category_type IN ('novel', 'comic', 'audio', 'video'))
);

-- 创建索引
CREATE INDEX idx_categories_category_name ON categories(category_name);
CREATE INDEX idx_categories_parent_id ON categories(parent_id);
CREATE INDEX idx_categories_category_type ON categories(category_type);
CREATE INDEX idx_categories_category_order ON categories(category_order);
CREATE INDEX idx_categories_is_active ON categories(is_active);
CREATE INDEX idx_categories_type_parent ON categories(category_type, parent_id);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_categories_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_categories_updated_at
    BEFORE UPDATE ON categories
    FOR EACH ROW
    EXECUTE FUNCTION update_categories_updated_at();

-- 添加表注释
COMMENT ON TABLE categories IS '分类表，存储内容分类信息，支持树形结构';
COMMENT ON COLUMN categories.id IS '分类ID，自增主键';
COMMENT ON COLUMN categories.category_name IS '分类名称';
COMMENT ON COLUMN categories.category_description IS '分类描述，说明分类的用途和范围';
COMMENT ON COLUMN categories.parent_id IS '上级分类ID，外键关联categories表，支持树形结构，NULL表示顶级分类';
COMMENT ON COLUMN categories.category_type IS '分类类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN categories.category_order IS '分类排序，数字越小越靠前，用于排序显示';
COMMENT ON COLUMN categories.is_active IS '是否启用，TRUE-启用，FALSE-禁用';
COMMENT ON COLUMN categories.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN categories.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_categories` (id)
- **外键约束**：`fk_categories_parent_id` (parent_id) 关联 categories(id)，删除时设置为 NULL（自引用）
- **检查约束**：`ck_categories_category_type` (category_type) - 确保分类类型是预定义的值
- **非空约束**：category_name、category_type 必须非空
- **默认值**：category_order 默认为 0，is_active 默认为 TRUE

### 4. 设计索引

- **主键索引**：`pk_categories` (id) - 自动创建
- **外键索引**：`idx_categories_parent_id` (parent_id) - 用于查询子分类
- **普通索引**：`idx_categories_category_name` (category_name) - 用于快速查询
- **普通索引**：`idx_categories_category_type` (category_type) - 用于按类型查询
- **普通索引**：`idx_categories_category_order` (category_order) - 用于排序查询
- **普通索引**：`idx_categories_is_active` (is_active) - 用于状态筛选
- **复合索引**：`idx_categories_type_parent` (category_type, parent_id) - 用于按类型和父分类查询

### 5. 考虑性能优化

- 为 parent_id 创建索引，支持树形结构查询
- 为 category_type 创建索引，支持按类型筛选
- 使用复合索引优化按类型和父分类的查询
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，支持自引用（树形结构）
4. 检查约束正确，确保分类类型是预定义的值
5. 索引设计合理，支持常用查询场景（包括树形结构查询）
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

