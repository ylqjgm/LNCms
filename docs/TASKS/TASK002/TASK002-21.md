# TASK002-21: 数据库设计 - 核心模块 - 小说章节表

## 任务信息

**任务编号**: TASK002-21  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 小说章节表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的小说章节表（novel_chapters）和小说章节内容表（novel_chapter_contents），用于存储小说章节信息。由于章节内容为大文本数据，为优化性能，将章节基本信息与章节内容分离存储。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-20（小说分卷表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解小说管理的详细需求：
- 小说章节管理：章节名称、章节内容、章节排序等
- 章节属于分卷，需要关联分卷表

### 2. 设计小说章节表结构

由于章节内容为大文本数据，为优化性能并减少章节信息表的负担，将章节表拆分为两个表：
- `novel_chapters`：存储章节基本信息（不包含内容）
- `novel_chapter_contents`：存储章节内容（大文本数据）

#### 2.1 小说章节基本信息表

设计 `novel_chapters` 表，包含小说章节基本信息（不包含章节内容）：

```sql
CREATE TABLE novel_chapters (
    id BIGSERIAL PRIMARY KEY,
    volume_id BIGINT NOT NULL,
    chapter_name VARCHAR(200) NOT NULL,
    chapter_order INTEGER NOT NULL DEFAULT 0,
    word_count INTEGER DEFAULT 0,
    is_published BOOLEAN DEFAULT FALSE,
    is_vip BOOLEAN DEFAULT FALSE,
    published_at TIMESTAMPTZ,
    view_count BIGINT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_novel_chapters_volume_id FOREIGN KEY (volume_id) REFERENCES novel_volumes(id) ON DELETE CASCADE,
    CONSTRAINT uk_novel_chapters_volume_id_chapter_order UNIQUE (volume_id, chapter_order)
);

-- 创建索引
CREATE INDEX idx_novel_chapters_volume_id ON novel_chapters(volume_id);
CREATE INDEX idx_novel_chapters_chapter_order ON novel_chapters(chapter_order);
CREATE INDEX idx_novel_chapters_is_published ON novel_chapters(is_published);
CREATE INDEX idx_novel_chapters_is_vip ON novel_chapters(is_vip);
CREATE INDEX idx_novel_chapters_published_at ON novel_chapters(published_at);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_novel_chapters_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_novel_chapters_updated_at
    BEFORE UPDATE ON novel_chapters
    FOR EACH ROW
    EXECUTE FUNCTION update_novel_chapters_updated_at();

-- 添加表注释
COMMENT ON TABLE novel_chapters IS '小说章节表，存储小说章节基本信息（不包含章节内容）';
COMMENT ON COLUMN novel_chapters.id IS '章节ID，自增主键';
COMMENT ON COLUMN novel_chapters.volume_id IS '分卷ID，外键关联novel_volumes表';
COMMENT ON COLUMN novel_chapters.chapter_name IS '章节名称';
COMMENT ON COLUMN novel_chapters.chapter_order IS '章节排序，数字越小越靠前，用于排序显示';
COMMENT ON COLUMN novel_chapters.word_count IS '章节字数';
COMMENT ON COLUMN novel_chapters.is_published IS '是否发布，TRUE-已发布，FALSE-未发布';
COMMENT ON COLUMN novel_chapters.is_vip IS '是否VIP章节，TRUE-VIP章节需要付费，FALSE-免费章节';
COMMENT ON COLUMN novel_chapters.published_at IS '发布时间';
COMMENT ON COLUMN novel_chapters.view_count IS '浏览次数';
COMMENT ON COLUMN novel_chapters.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN novel_chapters.updated_at IS '更新时间，每次更新时自动更新';
```

#### 2.2 小说章节内容表

设计 `novel_chapter_contents` 表，存储章节正文内容：

```sql
CREATE TABLE novel_chapter_contents (
    chapter_id BIGINT PRIMARY KEY,
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_novel_chapter_contents_chapter_id FOREIGN KEY (chapter_id) REFERENCES novel_chapters(id) ON DELETE CASCADE
);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_novel_chapter_contents_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_novel_chapter_contents_updated_at
    BEFORE UPDATE ON novel_chapter_contents
    FOR EACH ROW
    EXECUTE FUNCTION update_novel_chapter_contents_updated_at();

-- 添加表注释
COMMENT ON TABLE novel_chapter_contents IS '小说章节内容表，存储小说章节正文内容（大文本数据）';
COMMENT ON COLUMN novel_chapter_contents.chapter_id IS '章节ID，主键，外键关联novel_chapters表';
COMMENT ON COLUMN novel_chapter_contents.content IS '章节内容，TEXT类型存储章节正文';
COMMENT ON COLUMN novel_chapter_contents.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN novel_chapter_contents.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

#### 3.1 novel_chapters 表约束

- **主键约束**：`pk_novel_chapters` (id)
- **外键约束**：`fk_novel_chapters_volume_id` (volume_id) 关联 novel_volumes(id)，级联删除
- **唯一约束**：`uk_novel_chapters_volume_id_chapter_order` (volume_id, chapter_order) - 确保同一分卷的章节排序唯一
- **非空约束**：volume_id、chapter_name 必须非空
- **默认值**：chapter_order 默认为 0，word_count、view_count 默认为 0，is_published、is_vip 默认为 FALSE

#### 3.2 novel_chapter_contents 表约束

- **主键约束**：`pk_novel_chapter_contents` (chapter_id)
- **外键约束**：`fk_novel_chapter_contents_chapter_id` (chapter_id) 关联 novel_chapters(id)，级联删除
- **非空约束**：chapter_id、content 必须非空
- **一对一关系**：一个章节对应一个内容记录（通过主键 chapter_id 实现）

### 4. 设计索引

#### 4.1 novel_chapters 表索引

- **主键索引**：`pk_novel_chapters` (id) - 自动创建
- **外键索引**：`idx_novel_chapters_volume_id` (volume_id) - 用于查询分卷的章节
- **普通索引**：`idx_novel_chapters_chapter_order` (chapter_order) - 用于排序查询
- **普通索引**：`idx_novel_chapters_is_published` (is_published) - 用于发布状态筛选
- **普通索引**：`idx_novel_chapters_is_vip` (is_vip) - 用于VIP状态筛选
- **普通索引**：`idx_novel_chapters_published_at` (published_at) - 用于按发布时间排序
- **唯一索引**：`uk_novel_chapters_volume_id_chapter_order` (volume_id, chapter_order) - 确保唯一性

#### 4.2 novel_chapter_contents 表索引

- **主键索引**：`pk_novel_chapter_contents` (chapter_id) - 自动创建
- **外键索引**：通过主键实现，无需额外创建外键索引
- **说明**：章节内容表主要用于存储大文本数据，查询通常通过章节ID进行，主键索引已满足需求

### 5. 考虑性能优化

#### 5.1 表拆分优势

- **分离大文本数据**：将章节内容从章节信息表中分离，减少章节信息表的数据量
- **提高查询性能**：查询章节列表时不需要加载大文本内容，查询速度更快
- **按需加载**：仅在需要查看章节内容时才查询内容表，减少内存占用
- **独立优化**：可以对内容表进行单独的优化策略（如分区表、TOAST 存储等）

#### 5.2 索引优化

- 为 volume_id 创建索引，支持快速查询分卷的章节
- 为 chapter_order 创建索引，支持排序查询
- 为 is_published 和 is_vip 创建索引，支持状态筛选查询
- 使用复合唯一索引，确保同一分卷的章节排序唯一
- 章节内容表使用主键索引，支持快速通过章节ID查询内容

#### 5.3 其他优化

- 使用触发器自动更新 updated_at 字段
- 章节内容表使用一对一关系，通过主键关联，查询效率高
- 删除章节时自动级联删除内容，保证数据一致性

## 验收标准

1. 表结构设计完整，包含章节基本信息表和章节内容表两个表
2. 所有字段都有适当的类型、约束和默认值
3. novel_chapters 表外键约束正确，关联 novel_volumes 表
4. novel_chapter_contents 表外键约束正确，关联 novel_chapters 表，实现一对一关系
5. 唯一约束正确，确保同一分卷的章节排序唯一
6. 索引设计合理，支持常用查询场景
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新两个表的 updated_at 字段
9. 表拆分设计合理，章节内容表独立存储大文本数据
10. 级联删除配置正确，删除章节时自动删除对应的内容记录
11. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-20.md` - 小说分卷表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 10:30:00 CST

