# TASK002-79: 数据库设计 - 核心模块 - 收藏记录表

## 任务信息

**任务编号**: TASK002-79  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 收藏记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 10:30:00 CST

## 任务描述

设计核心模块的收藏记录表（favorites），用于存储用户收藏作品记录。收藏记录用于收益计算，支持收藏收益统计。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解收藏功能的详细需求：

**功能需求**：
- 用户可以对作品进行收藏
- 收藏记录用于收益计算（收藏收益）
- 记录收藏时间

**收藏收益规则**：
- 内容类型：小说、漫画、音频、视频
- 收藏起点：达到多少收藏后才开始进行收益计算
- 收益金额：每一个收藏转换为多少网站消费货币

### 2. 设计收藏记录表结构

设计 `favorites` 表：

```sql
CREATE TABLE favorites (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    current_chapter_type VARCHAR(20),
    current_chapter_id BIGINT,
    current_reading_percentage NUMERIC(5, 2),
    favorite_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_read_time TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_favorites_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT ck_favorites_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_favorites_content_id CHECK (content_id > 0),
    CONSTRAINT ck_favorites_chapter_type CHECK (current_chapter_type IS NULL OR current_chapter_type IN ('novel_chapter', 'comic_chapter', 'audio_episode', 'video_episode')),
    CONSTRAINT ck_favorites_chapter_id CHECK (current_chapter_id IS NULL OR current_chapter_id > 0),
    CONSTRAINT ck_favorites_reading_percentage CHECK (current_reading_percentage IS NULL OR (current_reading_percentage >= 0 AND current_reading_percentage <= 100)),
    CONSTRAINT uk_favorites_user_content UNIQUE (user_id, content_type, content_id)
);

-- 创建索引
CREATE INDEX idx_favorites_user_id ON favorites(user_id);
CREATE INDEX idx_favorites_content_type ON favorites(content_type);
CREATE INDEX idx_favorites_content_id ON favorites(content_id);
CREATE INDEX idx_favorites_favorite_time ON favorites(favorite_time);
CREATE INDEX idx_favorites_created_at ON favorites(created_at);
CREATE INDEX idx_favorites_content_type_id ON favorites(content_type, content_id);
CREATE INDEX idx_favorites_user_time ON favorites(user_id, favorite_time);
CREATE INDEX idx_favorites_last_read_time ON favorites(last_read_time);
CREATE INDEX idx_favorites_current_chapter ON favorites(current_chapter_type, current_chapter_id);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_favorites_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_favorites_updated_at
    BEFORE UPDATE ON favorites
    FOR EACH ROW
    EXECUTE FUNCTION update_favorites_updated_at();

-- 添加表注释
COMMENT ON TABLE favorites IS '收藏记录表，存储用户收藏作品记录，用于收益计算';
COMMENT ON COLUMN favorites.id IS '收藏ID，自增主键';
COMMENT ON COLUMN favorites.user_id IS '用户ID，外键关联users表，删除用户时级联删除收藏记录';
COMMENT ON COLUMN favorites.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN favorites.content_id IS '内容ID，关联对应内容表（novels、comics、audios、videos），必须大于0';
COMMENT ON COLUMN favorites.current_chapter_type IS '当前阅读章节类型：novel_chapter-小说章节、comic_chapter-漫画章节、audio_episode-音频分集、video_episode-视频分集，从阅读记录表同步，可以为NULL（未开始阅读）';
COMMENT ON COLUMN favorites.current_chapter_id IS '当前阅读章节/分集ID，关联对应章节表（novel_chapters、comic_chapters、audio_episodes、video_episodes），从阅读记录表同步，可以为NULL（未开始阅读）';
COMMENT ON COLUMN favorites.current_reading_percentage IS '当前阅读进度百分比，0-100，从阅读记录表同步，可以为NULL（未开始阅读）';
COMMENT ON COLUMN favorites.favorite_time IS '收藏时间，用户收藏作品的时间，默认为当前时间';
COMMENT ON COLUMN favorites.last_read_time IS '最后阅读时间，用户最后一次阅读该作品的时间，从阅读记录表同步，可以为NULL（未开始阅读）';
COMMENT ON COLUMN favorites.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN favorites.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_favorites` (id)
- **唯一约束**：`uk_favorites_user_content` (user_id, content_type, content_id) - 确保同一用户对同一作品只能有一条收藏记录
- **外键约束**：
  - `fk_favorites_user_id`：user_id 关联 users 表，删除用户时级联删除收藏记录
- **非空约束**：user_id、content_type、content_id、favorite_time 必须非空
- **检查约束**：
  - `ck_favorites_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_favorites_content_id`：content_id 必须大于 0
  - `ck_favorites_chapter_type`：current_chapter_type 如果存在，必须是预定义的值之一（novel_chapter、comic_chapter、audio_episode、video_episode）
  - `ck_favorites_chapter_id`：current_chapter_id 如果存在，必须大于 0
  - `ck_favorites_reading_percentage`：current_reading_percentage 如果存在，必须在 0-100 之间
- **默认值**：
  - favorite_time 默认为当前时间
  - created_at 默认为当前时间
- **业务规则约束**（应用层实现）：
  - current_chapter_type 和 current_chapter_id 必须同时存在或同时为 NULL
  - 阅读进度信息应从阅读记录表（reading_records）同步更新

### 4. 设计索引

- **主键索引**：`pk_favorites` (id) - 自动创建
- **唯一索引**：`uk_favorites_user_content` (user_id, content_type, content_id) - 自动创建
- **普通索引**：
  - `idx_favorites_user_id` (user_id) - 用于查询用户的收藏记录
  - `idx_favorites_content_type` (content_type) - 用于按内容类型查询
  - `idx_favorites_content_id` (content_id) - 用于查询作品的收藏记录
  - `idx_favorites_favorite_time` (favorite_time) - 用于按收藏时间排序和查询
  - `idx_favorites_created_at` (created_at) - 用于按创建时间排序和查询
- **复合索引**：
  - `idx_favorites_content_type_id` (content_type, content_id) - 用于查询特定作品的收藏记录（用于收益计算）
  - `idx_favorites_user_time` (user_id, favorite_time) - 用于查询用户收藏记录并按时间排序
- **普通索引**：
  - `idx_favorites_last_read_time` (last_read_time) - 用于按最后阅读时间排序和查询
  - `idx_favorites_current_chapter` (current_chapter_type, current_chapter_id) - 用于查询当前阅读特定章节的收藏记录

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户的收藏记录
- 创建复合索引 (content_type, content_id)，优化查询特定作品收藏记录的性能（用于收益计算）
- 创建复合索引 (user_id, favorite_time)，优化用户收藏记录查询性能
- 为 last_read_time 创建索引，支持按最后阅读时间排序和查询
- 为 current_chapter_type 和 current_chapter_id 创建复合索引，支持查询当前阅读特定章节的收藏记录
- 使用唯一约束确保同一用户对同一作品只有一条收藏记录
- 使用触发器自动更新 updated_at 字段
- 阅读进度信息应从阅读记录表同步更新

### 6. 业务逻辑说明

**收藏流程**：
1. **用户收藏**：
   - 用户收藏作品时，创建收藏记录
   - favorite_time 设置为当前时间
   - 如果用户已收藏过该作品，则不创建新记录（由唯一约束保证）

2. **用户取消收藏**：
   - 用户取消收藏时，删除收藏记录
   - 不保留取消收藏的历史记录

**收益计算**：
- 收藏收益计算时，查询 favorite_time 在结算周期内的记录
- 统计每个作品的收藏数量，用于计算收藏收益
- 收藏起点：达到设定的收藏数量后才开始计算收益
- 收益金额：每个收藏转换为设定的消费货币金额

**内容关联**：
- content_type 和 content_id 组合关联对应的内容表：
  - novel + content_id → novels 表
  - comic + content_id → comics 表
  - audio + content_id → audios 表
  - video + content_id → videos 表

**唯一性约束**：
- 同一用户对同一作品只能有一条收藏记录
- 如果用户取消收藏后再次收藏，创建新记录（因为取消收藏时已删除记录）

**阅读记录关联**：
- **阅读进度字段**：
  - current_chapter_type：当前阅读的章节类型（从阅读记录表同步）
  - current_chapter_id：当前阅读的章节/分集ID（从阅读记录表同步）
  - current_reading_percentage：当前阅读进度百分比（从阅读记录表同步）
  - last_read_time：最后阅读时间（从阅读记录表同步）
- **同步机制**：
  - 阅读进度信息应从阅读记录表（reading_records）同步更新
  - 查询用户对收藏作品的阅读记录：通过 user_id、content_type、content_id 查询阅读记录表
  - 获取最新阅读记录：按 last_read_time 排序，取最新的一条记录
  - 更新收藏记录的阅读进度：将最新阅读记录的章节信息、阅读进度、最后阅读时间同步到收藏记录表
- **同步时机**：
  - 用户阅读时：实时或定期同步阅读进度到收藏记录表
  - 查询收藏列表时：可以实时查询阅读记录表获取最新阅读进度
  - 后台任务：定期批量同步阅读进度到收藏记录表
- **查询方式**：
  - **查询收藏作品的当前阅读进度**：
    ```sql
    -- 方式1：从收藏记录表直接获取（已同步）
    SELECT current_chapter_type, current_chapter_id, current_reading_percentage, last_read_time
    FROM favorites
    WHERE user_id = ? AND content_type = ? AND content_id = ?;
    
    -- 方式2：从阅读记录表实时查询（最新数据）
    SELECT chapter_type, chapter_id, reading_percentage, last_read_time
    FROM reading_records
    WHERE user_id = ? AND content_type = ? AND content_id = ?
    ORDER BY last_read_time DESC
    LIMIT 1;
    ```
- **业务场景**：
  - 收藏列表展示：显示收藏作品的当前阅读进度
  - 继续阅读：根据收藏记录中的当前阅读章节，跳转到对应位置
  - 阅读统计：统计用户收藏作品的阅读情况

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按用户查询、按作品查询、收益计算查询）
4. 表注释和字段注释完整，使用中文
5. 外键约束正确设置，支持用户关联
6. 唯一约束正确设置，确保同一用户对同一作品只有一条收藏记录
7. 检查约束正确设置，确保内容类型、内容ID、章节类型、章节ID和阅读百分比的值有效
8. 阅读进度字段（current_chapter_type、current_chapter_id、current_reading_percentage、last_read_time）应从阅读记录表同步更新
9. 创建复合索引优化收益计算查询性能
10. 触发器正确创建，自动更新 updated_at 字段
11. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 3.2.4 节 - 收藏收益）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 3.2.4 节 - 收藏收益）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-84.md` - 阅读记录表设计文档（阅读进度记录）
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.1  
**最后更新**: 2026-01-03 11:00:00 CST

