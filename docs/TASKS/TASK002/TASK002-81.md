# TASK002-81: 数据库设计 - 核心模块 - 打赏记录表

## 任务信息

**任务编号**: TASK002-81  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 打赏记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 10:30:00 CST

## 任务描述

设计核心模块的打赏记录表（tips），用于存储用户打赏记录。打赏记录用于收益计算，支持打赏收益统计。用户使用虚拟物品对作品进行打赏。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-34（虚拟物品表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解打赏功能的详细需求：

**功能需求**：
- 用户可以使用虚拟物品对作品进行打赏
- 打赏记录用于收益计算（打赏收益）
- 记录打赏的虚拟物品、数量和金额

**打赏收益规则**：
- 内容类型：小说、漫画、音频、视频
- 收益比例：虚拟物品对应价格与消费货币转换比例

**打赏方式**：
- 用户使用虚拟物品（如鲜花、礼物等）对作品进行打赏
- 每个虚拟物品有对应的价格
- 打赏金额 = 虚拟物品价格 × 打赏数量

### 2. 设计打赏记录表结构

设计 `tips` 表：

```sql
CREATE TABLE tips (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    virtual_item_id BIGINT NOT NULL,
    tip_count INTEGER NOT NULL DEFAULT 1,
    tip_amount NUMERIC(10, 2) NOT NULL,
    tip_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_tips_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_tips_virtual_item_id FOREIGN KEY (virtual_item_id) REFERENCES virtual_items(id) ON DELETE RESTRICT,
    CONSTRAINT ck_tips_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_tips_content_id CHECK (content_id > 0),
    CONSTRAINT ck_tips_tip_count CHECK (tip_count > 0 AND tip_count <= 10000),
    CONSTRAINT ck_tips_tip_amount CHECK (tip_amount > 0)
);

-- 创建索引
CREATE INDEX idx_tips_user_id ON tips(user_id);
CREATE INDEX idx_tips_content_type ON tips(content_type);
CREATE INDEX idx_tips_content_id ON tips(content_id);
CREATE INDEX idx_tips_virtual_item_id ON tips(virtual_item_id);
CREATE INDEX idx_tips_tip_time ON tips(tip_time);
CREATE INDEX idx_tips_tip_amount ON tips(tip_amount);
CREATE INDEX idx_tips_created_at ON tips(created_at);
CREATE INDEX idx_tips_content_type_id ON tips(content_type, content_id);
CREATE INDEX idx_tips_user_time ON tips(user_id, tip_time);
CREATE INDEX idx_tips_content_time ON tips(content_type, content_id, tip_time);
CREATE INDEX idx_tips_virtual_item_time ON tips(virtual_item_id, tip_time);

-- 添加表注释
COMMENT ON TABLE tips IS '打赏记录表，存储用户打赏记录，用于收益计算';
COMMENT ON COLUMN tips.id IS '打赏ID，自增主键';
COMMENT ON COLUMN tips.user_id IS '用户ID，外键关联users表，删除用户时级联删除打赏记录';
COMMENT ON COLUMN tips.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN tips.content_id IS '内容ID，关联对应内容表（novels、comics、audios、videos），必须大于0';
COMMENT ON COLUMN tips.virtual_item_id IS '虚拟物品ID，外键关联virtual_items表，指定打赏使用的虚拟物品，删除虚拟物品时限制删除（RESTRICT）以确保记录完整性';
COMMENT ON COLUMN tips.tip_count IS '打赏数量，用户本次打赏的虚拟物品数量，范围：1-10000，默认为1';
COMMENT ON COLUMN tips.tip_amount IS '打赏金额，单位：消费货币，根据虚拟物品价格和打赏数量计算，必须大于0';
COMMENT ON COLUMN tips.tip_time IS '打赏时间，用户打赏的时间，默认为当前时间';
COMMENT ON COLUMN tips.created_at IS '创建时间，自动设置为当前时间';
```

### 3. 设计约束

- **主键约束**：`pk_tips` (id)
- **外键约束**：
  - `fk_tips_user_id`：user_id 关联 users 表，删除用户时级联删除打赏记录
  - `fk_tips_virtual_item_id`：virtual_item_id 关联 virtual_items 表，删除虚拟物品时限制删除（RESTRICT）以确保记录完整性
- **非空约束**：user_id、content_type、content_id、virtual_item_id、tip_count、tip_amount、tip_time 必须非空
- **检查约束**：
  - `ck_tips_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_tips_content_id`：content_id 必须大于 0
  - `ck_tips_tip_count`：tip_count 必须在 1-10000 之间
  - `ck_tips_tip_amount`：tip_amount 必须大于 0
- **默认值**：
  - tip_count 默认为 1
  - tip_time 默认为当前时间
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_tips` (id) - 自动创建
- **普通索引**：
  - `idx_tips_user_id` (user_id) - 用于查询用户的打赏记录
  - `idx_tips_content_type` (content_type) - 用于按内容类型查询
  - `idx_tips_content_id` (content_id) - 用于查询作品的打赏记录
  - `idx_tips_virtual_item_id` (virtual_item_id) - 用于查询使用特定虚拟物品的打赏记录
  - `idx_tips_tip_time` (tip_time) - 用于按打赏时间排序和查询
  - `idx_tips_tip_amount` (tip_amount) - 用于按打赏金额查询和统计
  - `idx_tips_created_at` (created_at) - 用于按创建时间排序和查询
- **复合索引**：
  - `idx_tips_content_type_id` (content_type, content_id) - 用于查询特定作品的打赏记录（用于收益计算）
  - `idx_tips_user_time` (user_id, tip_time) - 用于查询用户打赏记录并按时间排序
  - `idx_tips_content_time` (content_type, content_id, tip_time) - 用于查询特定作品在时间范围内的打赏记录（用于收益统计）
  - `idx_tips_virtual_item_time` (virtual_item_id, tip_time) - 用于查询特定虚拟物品在时间范围内的打赏记录

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户的打赏记录
- 创建复合索引 (content_type, content_id)，优化查询特定作品打赏记录的性能（用于收益计算）
- 创建复合索引 (content_type, content_id, tip_time)，优化收益统计查询性能（按时间范围统计打赏金额）
- 为 virtual_item_id 创建索引，支持查询使用特定虚拟物品的打赏记录
- 为 tip_amount 创建索引，支持按金额查询和统计
- 使用 NUMERIC 类型存储打赏金额，确保精度
- 打赏记录支持多次打赏，不设置唯一约束

### 6. 业务逻辑说明

**打赏流程**：
1. **用户打赏**：
   - 用户使用虚拟物品对作品进行打赏时，创建打赏记录
   - tip_time 设置为当前时间
   - tip_count 记录本次打赏的虚拟物品数量
   - virtual_item_id 关联虚拟物品表
   - tip_amount 根据虚拟物品价格和打赏数量计算：tip_amount = virtual_item.price × tip_count

2. **多次打赏**：
   - 同一用户可以对同一作品进行多次打赏
   - 每次打赏创建一条新记录
   - 可以使用不同的虚拟物品进行打赏
   - 不限制打赏次数

**收益计算**：
- 打赏收益计算时，查询 tip_time 在结算周期内的记录
- 统计每个作品的打赏金额（tip_amount 求和），用于计算打赏收益
- 收益比例：虚拟物品对应价格与消费货币转换比例
- 打赏金额已经转换为消费货币，直接用于收益计算

**虚拟物品关联**：
- virtual_item_id 关联虚拟物品表
- 删除虚拟物品时限制删除（RESTRICT），确保打赏记录完整性
- 虚拟物品价格变化不影响历史打赏记录

**内容关联**：
- content_type 和 content_id 组合关联对应的内容表：
  - novel + content_id → novels 表
  - comic + content_id → comics 表
  - audio + content_id → audios 表
  - video + content_id → videos 表

**打赏金额计算**：
- tip_amount = virtual_item.price × tip_count
- tip_amount 在创建记录时计算并存储
- 使用 NUMERIC 类型确保金额精度

**打赏数量限制**：
- tip_count 范围：1-10000
- 单次打赏最多10000个虚拟物品
- 支持批量打赏场景

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按用户查询、按作品查询、按虚拟物品查询、收益计算查询）
4. 表注释和字段注释完整，使用中文
5. 外键约束正确设置，支持用户和虚拟物品关联
6. 检查约束正确设置，确保内容类型、内容ID、打赏数量和打赏金额的值有效
7. 使用 NUMERIC 类型存储打赏金额，确保精度
8. 创建复合索引优化收益计算和统计查询性能
9. 支持多次打赏，不设置唯一约束
10. 使用 RESTRICT 约束保护虚拟物品记录完整性
11. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 3.2.6 节 - 打赏收益）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 3.2.6 节 - 打赏收益）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 10:30:00 CST

