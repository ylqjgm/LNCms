# TASK002-57: 基础数据初始化 - 默认权限

## 任务信息

**任务编号**: TASK002-57  
**父任务**: TASK002  
**任务名称**: 基础数据初始化 - 默认权限  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

编写默认权限的基础数据初始化脚本，使用 golang-migrate 工具创建权限表和角色权限关联表的初始化数据脚本。必须遵循 PostgreSQL 数据库设计规范。

## 依赖任务

TASK002-52（数据库迁移脚本 - 核心模块）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解权限管理的详细需求：
- 权限管理：权限名称、权限描述、权限类型等
- 角色权限关联：角色与权限的多对多关联
- 默认权限：系统管理权限、内容管理权限、用户管理权限等

### 2. 创建初始化脚本文件

使用 golang-migrate 工具创建初始化脚本：
- 初始化脚本目录：`migrations/core/seeds/`
- 初始化脚本命名：`YYYYMMDDHHMMSS_seed_default_permissions.up.sql` 和 `YYYYMMDDHHMMSS_seed_default_permissions.down.sql`

### 3. 编写初始化脚本

#### 3.1 升级脚本（up.sql）

插入默认权限数据和角色权限关联数据：

```sql
-- 插入默认权限
INSERT INTO permissions (permission_name, permission_description, permission_type, created_at) VALUES
('system.config.view', '查看系统配置', 'system', CURRENT_TIMESTAMP),
('system.config.edit', '编辑系统配置', 'system', CURRENT_TIMESTAMP),
('content.novel.create', '创建小说', 'content', CURRENT_TIMESTAMP),
('content.novel.edit', '编辑小说', 'content', CURRENT_TIMESTAMP),
('content.novel.delete', '删除小说', 'content', CURRENT_TIMESTAMP),
('user.view', '查看用户', 'user', CURRENT_TIMESTAMP),
('user.edit', '编辑用户', 'user', CURRENT_TIMESTAMP),
('user.delete', '删除用户', 'user', CURRENT_TIMESTAMP)
ON CONFLICT (permission_name) DO NOTHING;

-- 插入角色权限关联（超级管理员拥有所有权限）
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.role_name = 'super_admin'
ON CONFLICT (role_id, permission_id) DO NOTHING;

-- 插入角色权限关联（管理员拥有部分权限）
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.role_name = 'admin'
  AND p.permission_type IN ('content', 'user')
ON CONFLICT (role_id, permission_id) DO NOTHING;
```

#### 3.2 回滚脚本（down.sql）

删除默认权限数据和角色权限关联数据：

```sql
-- 删除角色权限关联
DELETE FROM role_permissions WHERE role_id IN (
    SELECT id FROM roles WHERE role_name IN ('super_admin', 'admin', 'user')
);

-- 删除默认权限
DELETE FROM permissions WHERE permission_name IN (
    'system.config.view', 'system.config.edit',
    'content.novel.create', 'content.novel.edit', 'content.novel.delete',
    'user.view', 'user.edit', 'user.delete'
);
```

### 4. 初始化脚本要求

- **幂等性**：初始化脚本应该是幂等的，可以安全地重复执行
- **使用 INSERT ... ON CONFLICT**：使用 `ON CONFLICT DO NOTHING` 确保幂等性
- **可回滚**：每个升级脚本必须有对应的回滚脚本
- **数据完整性**：确保插入的数据符合表约束和业务规则
- **关联数据**：先插入权限数据，再插入角色权限关联数据

### 5. 验证初始化脚本

- 使用 golang-migrate 工具验证初始化脚本语法
- 测试升级和回滚操作
- 确保所有权限数据和角色权限关联数据都正确插入

## 验收标准

1. 初始化脚本文件命名符合 golang-migrate 规范
2. 所有默认权限数据都包含在初始化脚本中
3. 所有角色权限关联数据都包含在初始化脚本中
4. 初始化脚本遵循幂等性原则
5. 升级脚本和回滚脚本都正确编写
6. 初始化脚本可以成功执行，无错误
7. 回滚脚本可以成功执行，无错误
8. 插入的数据符合业务规则和表约束

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-03.md` - 权限表设计文档
- `docs/TASKS/TASK002/TASK002-04.md` - 角色权限关联表设计文档
- `docs/TASKS/TASK002/TASK002-52.md` - 数据库迁移脚本文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

