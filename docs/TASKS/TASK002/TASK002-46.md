# TASK002-46: 数据库设计 - 日志模块 - 日志表

## 任务信息

**任务编号**: TASK002-46  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 日志模块 - 日志表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计日志模块的日志表（logs），用于存储系统日志信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Log.md` 文档，了解日志管理的详细需求：
- 日志存储：支持多种日志类型（系统日志、操作日志、错误日志、访问日志）
- 日志级别：支持多种日志级别（debug、info、warn、error、fatal）
- 日志查询：支持按模块、类型、级别、时间等条件查询
- 日志归档：支持自动归档过期日志

### 2. 设计日志表结构

设计 `logs` 表，包含日志基本信息：

```sql
CREATE TABLE logs (
    id BIGSERIAL PRIMARY KEY,
    log_id UUID NOT NULL UNIQUE,
    module_name VARCHAR(50) NOT NULL,
    log_type VARCHAR(20) NOT NULL,
    log_level VARCHAR(20) NOT NULL,
    log_title VARCHAR(200) NOT NULL,
    log_content TEXT NOT NULL,
    user_id BIGINT,
    request_id VARCHAR(64),
    ip_address VARCHAR(45),
    user_agent VARCHAR(500),
    extra_data JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_logs_module_name CHECK (module_name ~ '^[a-zA-Z0-9_]+$'),
    CONSTRAINT ck_logs_log_type CHECK (log_type IN ('system', 'operation', 'error', 'access')),
    CONSTRAINT ck_logs_log_level CHECK (log_level IN ('debug', 'info', 'warn', 'error', 'fatal'))
);

-- 创建索引
CREATE UNIQUE INDEX uk_logs_log_id ON logs(log_id);
CREATE INDEX idx_logs_module_name ON logs(module_name);
CREATE INDEX idx_logs_log_type ON logs(log_type);
CREATE INDEX idx_logs_log_level ON logs(log_level);
CREATE INDEX idx_logs_user_id ON logs(user_id);
CREATE INDEX idx_logs_request_id ON logs(request_id);
CREATE INDEX idx_logs_created_at ON logs(created_at);
CREATE INDEX idx_logs_module_type ON logs(module_name, log_type);
CREATE INDEX idx_logs_type_level ON logs(log_type, log_level);
CREATE INDEX idx_logs_module_created ON logs(module_name, created_at);
CREATE INDEX idx_logs_type_created ON logs(log_type, created_at);
CREATE INDEX idx_logs_level_created ON logs(log_level, created_at);
CREATE INDEX idx_logs_request_created ON logs(request_id, created_at);

-- 为 JSONB 字段创建 GIN 索引（用于高效查询）
CREATE INDEX idx_logs_extra_data ON logs USING GIN (extra_data);

-- 添加表注释
COMMENT ON TABLE logs IS '日志表，存储系统日志信息';
COMMENT ON COLUMN logs.id IS '日志ID，自增主键';
COMMENT ON COLUMN logs.log_id IS '日志唯一标识符，UUID格式，由日志模块生成';
COMMENT ON COLUMN logs.module_name IS '模块名称，标识日志来源模块（如core、storage、crawler），只能包含字母、数字和下划线';
COMMENT ON COLUMN logs.log_type IS '日志类型：system-系统日志、operation-操作日志、error-错误日志、access-访问日志';
COMMENT ON COLUMN logs.log_level IS '日志级别：debug-调试、info-信息、warn-警告、error-错误、fatal-致命';
COMMENT ON COLUMN logs.log_title IS '日志标题，长度限制1-200字符';
COMMENT ON COLUMN logs.log_content IS '日志内容，长度限制0-10000字符';
COMMENT ON COLUMN logs.user_id IS '用户ID，关联用户ID（操作日志和访问日志必填）';
COMMENT ON COLUMN logs.request_id IS '请求ID，关联请求唯一标识符，相同请求ID的日志可以关联查询';
COMMENT ON COLUMN logs.ip_address IS 'IP地址，IPv4或IPv6格式';
COMMENT ON COLUMN logs.user_agent IS '用户代理，长度限制0-500字符';
COMMENT ON COLUMN logs.extra_data IS '扩展数据，JSONB格式，存储额外的结构化数据，支持高效查询';
COMMENT ON COLUMN logs.created_at IS '创建时间，自动设置为当前时间';
```

### 3. 设计约束

- **主键约束**：`pk_logs` (id)
- **唯一约束**：`uk_logs_log_id` (log_id)
- **检查约束**：`ck_logs_module_name` (module_name) - 确保模块名称只包含字母、数字和下划线
- **检查约束**：`ck_logs_log_type` (log_type) - 确保日志类型是预定义的值
- **检查约束**：`ck_logs_log_level` (log_level) - 确保日志级别是预定义的值
- **非空约束**：log_id、module_name、log_type、log_level、log_title、log_content 必须非空
- **可选字段**：user_id、request_id、ip_address、user_agent、extra_data 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_logs` (id) - 自动创建
- **唯一索引**：`uk_logs_log_id` (log_id) - 确保日志唯一标识符唯一
- **普通索引**：`idx_logs_module_name` (module_name) - 用于按模块名称筛选
- **普通索引**：`idx_logs_log_type` (log_type) - 用于按日志类型筛选
- **普通索引**：`idx_logs_log_level` (log_level) - 用于按日志级别筛选
- **普通索引**：`idx_logs_user_id` (user_id) - 用于查询用户的日志
- **普通索引**：`idx_logs_request_id` (request_id) - 用于查询相同请求ID的日志
- **普通索引**：`idx_logs_created_at` (created_at) - 用于按创建时间排序和查询
- **GIN 索引**：`idx_logs_extra_data` (extra_data) - 用于高效查询 JSONB 扩展数据
- **复合索引**：`idx_logs_module_type` (module_name, log_type) - 用于按模块和类型筛选
- **复合索引**：`idx_logs_type_level` (log_type, log_level) - 用于按类型和级别筛选
- **复合索引**：`idx_logs_module_created` (module_name, created_at) - 用于查询模块的日志并按时间排序
- **复合索引**：`idx_logs_type_created` (log_type, created_at) - 用于查询类型的日志并按时间排序
- **复合索引**：`idx_logs_level_created` (log_level, created_at) - 用于查询级别的日志并按时间排序
- **复合索引**：`idx_logs_request_created` (request_id, created_at) - 用于查询相同请求ID的日志并按时间排序

### 5. 考虑性能优化

- 为 log_id 创建唯一索引，支持快速查询和唯一性检查
- 为 module_name、log_type、log_level 创建索引，支持按模块、类型、级别筛选查询
- 为 user_id 和 request_id 创建索引，支持关联查询
- 为 created_at 创建索引，支持时间排序和查询
- 为 extra_data 创建 GIN 索引，支持高效查询 JSONB 扩展数据
- 使用复合索引优化常用查询场景（如按模块和类型筛选、按类型和级别筛选、按时间排序）
- 日志表数据量大，考虑使用分区表（按时间分区）

### 6. 查询示例

```sql
-- 查询模块的错误日志，按时间倒序
SELECT * FROM logs
WHERE module_name = 'core' 
  AND log_type = 'error'
ORDER BY created_at DESC
LIMIT 100;

-- 查询相同请求ID的所有日志
SELECT * FROM logs
WHERE request_id = 'req_abc123'
ORDER BY created_at ASC;

-- 查询用户的操作日志
SELECT * FROM logs
WHERE user_id = 1 
  AND log_type = 'operation'
ORDER BY created_at DESC;
```

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 唯一约束正确，确保日志唯一标识符唯一
4. 检查约束正确，确保模块名称、日志类型、日志级别等是有效的值
5. 索引设计合理，支持常用查询场景（包括按模块查询、按类型查询、按级别查询、按时间排序、按请求ID查询）
6. 为 JSONB 字段创建 GIN 索引，支持高效查询扩展数据
7. 表注释和字段注释完整，使用中文
8. 表设计符合 PostgreSQL 数据库设计规范
9. 考虑日志表数据量大，建议使用分区表（按时间分区）

## 相关文件

- `docs/Requirements/Log.md` - 日志模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

