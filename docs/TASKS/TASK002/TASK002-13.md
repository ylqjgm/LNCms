# TASK002-13: 数据库设计 - 核心模块 - 作者表

## 任务信息

**任务编号**: TASK002-13  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 作者表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的作者表（authors），用于存储作者基本信息和认证信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-05（作者类型表）、TASK002-06（作者等级表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解作者管理的详细需求：
- 作者管理：作者添加、作者信息修改、作者状态管理、作者封禁管理、作者审核、作者奖励、作者惩罚、作者删除
- 作者需要支持注册、登录、认证等功能
- 作者与用户可能是同一实体，也可能是不同实体

### 2. 设计作者表结构

设计 `authors` 表，包含作者基本信息和认证信息：

```sql
CREATE TABLE authors (
    id BIGSERIAL PRIMARY KEY,
    author_name VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    phone VARCHAR(20),
    password_hash VARCHAR(255) NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    phone_verified BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    is_locked BOOLEAN DEFAULT FALSE,
    author_type_ids INTEGER[] NOT NULL DEFAULT '{}',
    author_level_id BIGINT,
    user_id BIGINT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMPTZ,
    CONSTRAINT fk_authors_author_level_id FOREIGN KEY (author_level_id) REFERENCES author_levels(id) ON DELETE SET NULL,
    CONSTRAINT fk_authors_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

-- 创建索引
CREATE INDEX idx_authors_author_name ON authors(author_name);
CREATE INDEX idx_authors_email ON authors(email);
CREATE INDEX idx_authors_phone ON authors(phone);
CREATE INDEX idx_authors_author_level_id ON authors(author_level_id);
CREATE INDEX idx_authors_user_id ON authors(user_id);
CREATE INDEX idx_authors_is_active ON authors(is_active);
CREATE INDEX idx_authors_is_locked ON authors(is_locked);
CREATE UNIQUE INDEX uk_authors_author_name ON authors(author_name);
CREATE UNIQUE INDEX uk_authors_email ON authors(email);

-- 创建数组字段的 GIN 索引（用于数组查询优化）
CREATE INDEX idx_authors_author_type_ids ON authors USING GIN (author_type_ids);

-- 创建函数索引（用于特定类型查询优化）
CREATE INDEX idx_authors_has_novel ON authors USING GIN (author_type_ids) WHERE 1 = ANY(author_type_ids);
CREATE INDEX idx_authors_has_comic ON authors USING GIN (author_type_ids) WHERE 2 = ANY(author_type_ids);
CREATE INDEX idx_authors_has_audio ON authors USING GIN (author_type_ids) WHERE 3 = ANY(author_type_ids);
CREATE INDEX idx_authors_has_video ON authors USING GIN (author_type_ids) WHERE 4 = ANY(author_type_ids);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_authors_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_authors_updated_at
    BEFORE UPDATE ON authors
    FOR EACH ROW
    EXECUTE FUNCTION update_authors_updated_at();

-- 添加表注释
COMMENT ON TABLE authors IS '作者表，存储作者基本信息和认证信息';
COMMENT ON COLUMN authors.id IS '作者ID，自增主键';
COMMENT ON COLUMN authors.author_name IS '作者名称，唯一标识符，用于登录';
COMMENT ON COLUMN authors.email IS '邮箱地址，唯一标识符，用于登录和通知';
COMMENT ON COLUMN authors.phone IS '手机号码，用于登录和通知';
COMMENT ON COLUMN authors.password_hash IS '密码哈希值，使用 bcrypt 或类似算法，不能存储明文密码';
COMMENT ON COLUMN authors.email_verified IS '邮箱是否已验证，TRUE-已验证，FALSE-未验证';
COMMENT ON COLUMN authors.phone_verified IS '手机号是否已验证，TRUE-已验证，FALSE-未验证';
COMMENT ON COLUMN authors.is_active IS '作者是否激活，TRUE-激活，FALSE-未激活';
COMMENT ON COLUMN authors.is_locked IS '作者是否被锁定，TRUE-已锁定，FALSE-未锁定';
COMMENT ON COLUMN authors.author_type_ids IS '作者类型ID数组，存储作者可以创作的内容类型ID，引用author_types表的id字段，使用PostgreSQL数组类型，支持一个作者拥有多个类型';
COMMENT ON COLUMN authors.author_level_id IS '作者等级ID，外键关联author_levels表';
COMMENT ON COLUMN authors.user_id IS '用户ID，外键关联users表，用于关联用户和作者（如果作者和用户是同一人）';
COMMENT ON COLUMN authors.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN authors.updated_at IS '更新时间，每次更新时自动更新';
COMMENT ON COLUMN authors.last_login_at IS '最后登录时间';
```

### 3. 设计约束

- **主键约束**：`pk_authors` (id)
- **外键约束**：`fk_authors_author_level_id` (author_level_id) 关联 author_levels(id)，删除时设置为 NULL
- **外键约束**：`fk_authors_user_id` (user_id) 关联 users(id)，删除时设置为 NULL
- **唯一约束**：`uk_authors_author_name` (author_name)、`uk_authors_email` (email)
- **非空约束**：author_name、email、password_hash、author_type_ids 必须非空
- **默认值**：email_verified、phone_verified、is_active、is_locked 默认为 FALSE，author_type_ids 默认为空数组 '{}'
- **数组约束**：author_type_ids 数组中的值应在应用层验证，确保引用有效的 author_types.id

### 4. 设计索引

- **主键索引**：`pk_authors` (id) - 自动创建
- **唯一索引**：`uk_authors_author_name` (author_name) - 确保作者名称唯一
- **唯一索引**：`uk_authors_email` (email) - 确保邮箱唯一
- **普通索引**：`idx_authors_author_name` (author_name) - 用于快速查询
- **普通索引**：`idx_authors_email` (email) - 用于快速查询
- **普通索引**：`idx_authors_phone` (phone) - 用于快速查询
- **外键索引**：`idx_authors_author_level_id` (author_level_id) - 用于关联查询
- **外键索引**：`idx_authors_user_id` (user_id) - 用于关联查询
- **普通索引**：`idx_authors_is_active` (is_active) - 用于状态筛选
- **普通索引**：`idx_authors_is_locked` (is_locked) - 用于状态筛选
- **GIN 索引**：`idx_authors_author_type_ids` (author_type_ids) - 用于数组查询优化
- **函数索引**：`idx_authors_has_novel`、`idx_authors_has_comic`、`idx_authors_has_audio`、`idx_authors_has_video` - 用于特定类型查询优化

### 5. 考虑性能优化

- 为 author_name 和 email 创建唯一索引，支持快速查询和唯一性检查
- 为 phone 创建索引，支持快速查询
- 为外键字段创建索引，支持关联查询
- 为状态字段创建索引，支持状态筛选查询
- 为 author_type_ids 数组字段创建 GIN 索引，支持高效的数组查询（ANY、@>、&& 等操作符）
- 为特定类型创建函数索引，优化常见查询场景（如查询所有小说作者）
- 使用触发器自动更新 updated_at 字段

### 6. 数组查询示例

PostgreSQL 数组查询示例：

```sql
-- 查询包含小说作者（类型ID=1）的所有作者
SELECT * FROM authors WHERE 1 = ANY(author_type_ids);

-- 查询包含小说或漫画作者的所有作者
SELECT * FROM authors WHERE author_type_ids && ARRAY[1, 2];

-- 查询同时包含小说和漫画作者的所有作者
SELECT * FROM authors WHERE author_type_ids @> ARRAY[1, 2];

-- 查询只包含小说作者（不包含其他类型）的所有作者
SELECT * FROM authors WHERE author_type_ids = ARRAY[1];
```

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 author_levels、users 表
4. 唯一约束正确，确保作者名称和邮箱唯一
5. author_type_ids 使用 PostgreSQL 数组类型（INTEGER[]），支持多类型存储
6. 索引设计合理，包括 GIN 索引和函数索引，支持常用查询场景
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新 updated_at 字段
9. 密码字段使用哈希存储，符合安全规范
10. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `.cursor/rules/security.mdc` - 应用安全开发规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-05.md` - 作者类型表设计文档
- `docs/TASKS/TASK002/TASK002-06.md` - 作者等级表设计文档
- `docs/TASKS/TASK002/TASK002-10.md` - 用户表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

