# TASK002-67: 数据库设计 - 核心模块 - 作者架构关联表

## 任务信息

**任务编号**: TASK002-67  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 作者架构关联表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:10:08 CST

## 任务描述

设计核心模块的作者架构关联表（author_organizations），用于存储作者与组织架构的关联关系。支持将作者划归于不同的架构中，记录分配时间和分配人员。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-13（作者表）、TASK002-66（组织架构表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解作者架构关联的详细需求：

**功能需求**：
- 作者审核通过后，可将作者划归于下级架构中，如：小说编辑一组
- 编辑一组组长可将作者划归于小组中编辑名下
- 作者归属于具体的编辑进行管理
- 记录分配时间和分配人员

**业务场景**：
- 架构所属类型下所有作者申请均在此进行审核，如小说只出现在小说类型架构下
- 审核通过后，可将作者划归于下级架构中
- 作者需要归属到具体的编辑名下进行管理
- 一个作者可以属于多个架构（如果业务需要），或者只能属于一个架构（需要在业务逻辑中控制）
- 一个作者可以归属于多个编辑（如果业务需要），或者只能归属于一个编辑（需要在业务逻辑中控制）

### 2. 设计作者架构关联表结构

设计 `author_organizations` 表：

```sql
CREATE TABLE author_organizations (
    id BIGSERIAL PRIMARY KEY,
    author_id BIGINT NOT NULL,
    organization_id BIGINT NOT NULL,
    editor_id BIGINT,
    assigned_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    assigned_by BIGINT,
    notes TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_author_organizations_author_id FOREIGN KEY (author_id) REFERENCES authors(id) ON DELETE CASCADE,
    CONSTRAINT fk_author_organizations_organization_id FOREIGN KEY (organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
    CONSTRAINT fk_author_organizations_editor_id FOREIGN KEY (editor_id) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT fk_author_organizations_assigned_by FOREIGN KEY (assigned_by) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT uk_author_organizations_author_org_editor UNIQUE (author_id, organization_id, editor_id)
);

-- 创建索引
CREATE INDEX idx_author_organizations_author_id ON author_organizations(author_id);
CREATE INDEX idx_author_organizations_organization_id ON author_organizations(organization_id);
CREATE INDEX idx_author_organizations_editor_id ON author_organizations(editor_id);
CREATE INDEX idx_author_organizations_assigned_by ON author_organizations(assigned_by);
CREATE INDEX idx_author_organizations_assigned_at ON author_organizations(assigned_at);
CREATE INDEX idx_author_organizations_is_active ON author_organizations(is_active);
CREATE INDEX idx_author_organizations_org_editor ON author_organizations(organization_id, editor_id);
CREATE INDEX idx_author_organizations_editor_active ON author_organizations(editor_id, is_active);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_author_organizations_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_author_organizations_updated_at
    BEFORE UPDATE ON author_organizations
    FOR EACH ROW
    EXECUTE FUNCTION update_author_organizations_updated_at();

-- 添加表注释
COMMENT ON TABLE author_organizations IS '作者架构关联表，存储作者与组织架构的关联关系，支持将作者划归于不同的架构中，并归属到具体的编辑名下进行管理';
COMMENT ON COLUMN author_organizations.id IS '关联ID，自增主键';
COMMENT ON COLUMN author_organizations.author_id IS '作者ID，外键关联authors表';
COMMENT ON COLUMN author_organizations.organization_id IS '架构ID，外键关联organizations表';
COMMENT ON COLUMN author_organizations.editor_id IS '编辑ID，外键关联users表，记录作者归属的具体编辑。为NULL表示作者仅归属于架构，不归属于具体编辑';
COMMENT ON COLUMN author_organizations.assigned_at IS '分配时间，作者被分配到该架构或编辑的时间';
COMMENT ON COLUMN author_organizations.assigned_by IS '分配人员ID，外键关联users表，记录是谁分配的作者（如组长分配作者给编辑）';
COMMENT ON COLUMN author_organizations.notes IS '备注，记录分配的说明或其他信息';
COMMENT ON COLUMN author_organizations.is_active IS '是否有效，TRUE-有效，FALSE-无效（如作者被移出该架构或编辑）';
COMMENT ON COLUMN author_organizations.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN author_organizations.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_author_organizations` (id)
- **外键约束**：
  - `fk_author_organizations_author_id`：author_id 关联 authors 表，删除作者时级联删除关联关系
  - `fk_author_organizations_organization_id`：organization_id 关联 organizations 表，删除架构时级联删除关联关系
  - `fk_author_organizations_editor_id`：editor_id 关联 users 表，删除用户时设置为 NULL
  - `fk_author_organizations_assigned_by`：assigned_by 关联 users 表，删除用户时设置为 NULL
- **唯一约束**：`uk_author_organizations_author_org_editor` (author_id, organization_id, editor_id) - 确保同一作者不能重复分配到同一架构的同一编辑名下
- **非空约束**：author_id、organization_id 必须非空
- **默认值**：
  - assigned_at 默认为当前时间
  - is_active 默认为 TRUE

### 4. 设计索引

- **主键索引**：`pk_author_organizations` (id) - 自动创建
- **唯一索引**：`uk_author_organizations_author_org_editor` (author_id, organization_id, editor_id) - 确保同一作者不能重复分配到同一架构的同一编辑名下
- **普通索引**：
  - `idx_author_organizations_author_id` (author_id) - 用于查询作者所属的架构和编辑
  - `idx_author_organizations_organization_id` (organization_id) - 用于查询架构下的作者
  - `idx_author_organizations_editor_id` (editor_id) - 用于查询编辑管理的作者
  - `idx_author_organizations_assigned_by` (assigned_by) - 用于查询分配人员分配的作者
  - `idx_author_organizations_assigned_at` (assigned_at) - 用于按分配时间排序和查询
  - `idx_author_organizations_is_active` (is_active) - 用于筛选有效的关联关系
- **复合索引**：
  - `idx_author_organizations_org_editor` (organization_id, editor_id) - 用于查询架构下特定编辑管理的作者
  - `idx_author_organizations_editor_active` (editor_id, is_active) - 用于查询编辑管理的有效作者

### 5. 考虑性能优化

- 为 author_id 和 organization_id 创建索引，支持双向查询（查询作者所属架构、查询架构下的作者）
- 为 editor_id 创建索引，支持查询编辑管理的作者
- 创建唯一索引 (author_id, organization_id, editor_id)，确保数据完整性并支持快速查询
- 创建复合索引 (organization_id, editor_id)，优化查询架构下特定编辑管理的作者的性能
- 创建复合索引 (editor_id, is_active)，优化查询编辑管理的有效作者的性能
- 为 assigned_at 创建索引，支持按分配时间排序和查询
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**分配逻辑**：
1. 作者审核通过后，编辑或组长可以将作者分配到对应的架构中
2. 编辑一组组长可将作者划归于小组中编辑名下，设置 editor_id 字段
3. 系统记录分配时间（assigned_at）和分配人员（assigned_by）
4. 一个作者可以属于多个架构，也可以归属于多个编辑，但同一作者不能重复分配到同一架构的同一编辑名下（通过唯一约束保证）

**架构层级分配**：
- 作者可以被分配到不同层级的架构中
- 例如：作者可以被分配到"小说部"，也可以被分配到"小说编辑一组"
- 如果作者同时属于父架构和子架构，需要在业务逻辑中处理显示和权限问题

**编辑归属**：
- 作者可以归属于具体的编辑进行管理
- editor_id 为 NULL 表示作者仅归属于架构，不归属于具体编辑
- 例如：作者归属于"小说编辑一组"下的"编辑A"，则 organization_id 为"小说编辑一组"的ID，editor_id 为"编辑A"的用户ID
- 编辑可以管理其名下的所有作者，包括作品管理、结算管理等

**关联状态管理**：
- 使用 is_active 字段控制关联关系的有效性
- 当作者被移出架构或编辑时，可以设置 is_active 为 FALSE，而不是删除记录，保留历史信息
- 或者直接删除记录，通过 is_active 字段可以进行软删除

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（查询作者所属架构和编辑、查询架构下的作者、查询编辑管理的作者）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持级联删除和关联查询
7. 唯一约束正确设置，确保同一作者不能重复分配到同一架构
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 10.2 节 - 作者管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 10.2 节 - 作者管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:10:08 CST

