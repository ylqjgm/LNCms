# TASK002-01: 数据库设计 - 核心模块 - 系统配置表

## 任务信息

**任务编号**: TASK002-01  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 系统配置表  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的系统配置表（configs），用于存储网站设置、注册设置、站群设置、积分配置、附件设置、邮箱设置、屏蔽设置等配置项。表结构使用 JSONB 存储配置值，支持灵活的配置管理和分组操作。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解系统配置的详细需求：
- 网站设置：网站名称、网站地址、网站关键字、网站描述、版权申明、网站开关、关闭提示
- 注册设置：注册开关、验证码开关、用户密码要求、重复注册设置
- 站群设置：主站设置、集群管理
- 积分设置：积分名称、注册积分、登录积分、评论积分、充值积分、消费积分
- 附件设置：存储渠道、图片附件、音频附件、视频附件
- 邮箱设置：SMTP服务器、SMTP端口、TLS开关、登录用户名、登录密码、发件人邮箱
- 屏蔽设置：黑名单设置、禁用词汇列表

**配置键命名规范**：
- 配置键格式：`模块.功能.名称`，如 `site.basic.name`、`register.security.enabled`、`points.reward.login` 等
- 配置键必须全局唯一，使用点号分隔层级关系
- 分组字段用于查询和管理，不参与唯一性约束

### 2. 设计系统配置表结构

设计 `configs` 表，使用 JSONB 存储配置项：

```sql
CREATE TABLE configs (
    id BIGSERIAL PRIMARY KEY,
    config_group VARCHAR(50) NOT NULL,
    config_key VARCHAR(200) NOT NULL,
    config_value JSONB,
    default_value JSONB,
    config_type VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uk_configs_config_key UNIQUE (config_key)
);

-- 创建索引
CREATE INDEX idx_configs_config_group ON configs(config_group);
CREATE UNIQUE INDEX uk_configs_config_key ON configs(config_key);
CREATE INDEX idx_configs_config_type ON configs(config_type);
CREATE INDEX idx_configs_group_type ON configs(config_group, config_type);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_configs_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_configs_updated_at
    BEFORE UPDATE ON configs
    FOR EACH ROW
    EXECUTE FUNCTION update_configs_updated_at();

-- 添加表注释
COMMENT ON TABLE configs IS '系统配置表，存储网站设置、注册设置、站群设置、积分配置、附件设置、邮箱设置、屏蔽设置等配置项，支持分组管理和默认配置';
COMMENT ON COLUMN configs.id IS '配置ID，自增主键';
COMMENT ON COLUMN configs.config_group IS '配置分组，用于对配置进行分类管理和查询，如 site-网站设置、register-注册设置、cluster-站群设置、points-积分设置、attachment-附件设置、email-邮箱设置、block-屏蔽设置';
COMMENT ON COLUMN configs.config_key IS '配置键，全局唯一标识符，格式为"模块.功能.名称"，如 site.basic.name、register.security.enabled、points.reward.login 等';
COMMENT ON COLUMN configs.config_value IS '配置值，JSONB格式存储，支持灵活的配置结构。当为NULL时，将使用default_value作为配置值';
COMMENT ON COLUMN configs.default_value IS '默认配置值，JSONB格式存储。当config_value为NULL时，系统将使用此默认值';
COMMENT ON COLUMN configs.config_type IS '配置类型：string-字符串、number-数值、boolean-布尔值、object-对象、array-数组';
COMMENT ON COLUMN configs.description IS '配置描述，说明配置的用途和含义';
COMMENT ON COLUMN configs.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN configs.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_configs` (id)
- **唯一约束**：`uk_configs_config_key` (config_key) - 确保配置键全局唯一
- **非空约束**：config_group、config_key、config_type 必须非空；config_value 和 default_value 可以为空，但至少有一个不为空
- **检查约束**：config_type 必须是预定义的值之一（string、number、boolean、object、array）
- **业务约束**：当 config_value 为 NULL 时，系统使用 default_value 作为配置值；如果两者都为 NULL，则需要应用层处理

### 4. 设计索引

- **主键索引**：`pk_configs` (id) - 自动创建
- **唯一索引**：`uk_configs_config_key` (config_key) - 确保配置键全局唯一，支持快速查询配置键
- **普通索引**：`idx_configs_config_group` (config_group) - 用于按分组查询，支持分组管理和批量操作
- **普通索引**：`idx_configs_config_type` (config_type) - 用于按类型查询
- **复合索引**：`idx_configs_group_type` (config_group, config_type) - 用于按分组和类型组合查询

### 5. 考虑性能优化

- 使用 JSONB 类型存储配置值和默认值，支持高效的 JSON 查询和索引
- 为 config_key 创建唯一索引，支持快速查询和唯一性验证
- 为 config_group 创建索引，支持按分组查询和批量操作
- 创建复合索引 (config_group, config_type)，支持按分组和类型组合查询
- 使用触发器自动更新 updated_at 字段
- 支持默认配置机制，当配置值为空时自动使用默认值，减少数据冗余

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.2  
**最后更新**: 2026-01-02 22:42:04 CST
