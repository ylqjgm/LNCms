# TASK002-66: 数据库设计 - 核心模块 - 组织架构表

## 任务信息

**任务编号**: TASK002-66  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 组织架构表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:10:08 CST

## 任务描述

设计核心模块的组织架构表（organizations），用于存储管理组织架构信息。支持树形结构，可按照内容类型进行划分（如小说部、漫画部、音频部等），每个架构可设置负责人。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解组织架构管理的详细需求：

**功能需求**：
- 对网站管理进行组织架构管理，可按照内容类型进行划分，例如：小说部、漫画部、音频部等
- 每一个部门根据角色权限定义，拥有一位部长类型角色，可进行组织架构管理
- 例如：小说部部长，可以设定小说编辑一组、小说编辑二组等，并设定组长，组长等角色权限，均由管理员在权限管理处事先进行权限划分

**配置项**：
- 架构名称
- 所属上级（支持树形结构）
- 架构描述
- 架构负责人
- 内容类型（小说、漫画、音频、视频，可为空表示通用）

### 2. 设计组织架构表结构

设计 `organizations` 表，支持树形结构：

```sql
CREATE TABLE organizations (
    id BIGSERIAL PRIMARY KEY,
    organization_name VARCHAR(100) NOT NULL,
    parent_id BIGINT,
    organization_type VARCHAR(20) NOT NULL,
    content_type VARCHAR(20),
    manager_id BIGINT,
    organization_description TEXT,
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_organizations_parent_id FOREIGN KEY (parent_id) REFERENCES organizations(id) ON DELETE SET NULL,
    CONSTRAINT fk_organizations_manager_id FOREIGN KEY (manager_id) REFERENCES users(id) ON DELETE SET NULL,
    CONSTRAINT ck_organizations_organization_type CHECK (organization_type IN ('department', 'group', 'individual')),
    CONSTRAINT ck_organizations_content_type CHECK (content_type IS NULL OR content_type IN ('novel', 'comic', 'audio', 'video'))
);

-- 创建索引
CREATE INDEX idx_organizations_parent_id ON organizations(parent_id);
CREATE INDEX idx_organizations_manager_id ON organizations(manager_id);
CREATE INDEX idx_organizations_organization_type ON organizations(organization_type);
CREATE INDEX idx_organizations_content_type ON organizations(content_type);
CREATE INDEX idx_organizations_is_active ON organizations(is_active);
CREATE INDEX idx_organizations_sort_order ON organizations(sort_order);
CREATE INDEX idx_organizations_parent_sort ON organizations(parent_id, sort_order);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_organizations_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_organizations_updated_at
    BEFORE UPDATE ON organizations
    FOR EACH ROW
    EXECUTE FUNCTION update_organizations_updated_at();

-- 添加表注释
COMMENT ON TABLE organizations IS '组织架构表，存储管理组织架构信息，支持树形结构，可按照内容类型进行划分';
COMMENT ON COLUMN organizations.id IS '架构ID，自增主键';
COMMENT ON COLUMN organizations.organization_name IS '架构名称，如"小说部"、"漫画部"、"小说编辑一组"等';
COMMENT ON COLUMN organizations.parent_id IS '所属上级架构ID，外键关联organizations表，支持树形结构。为NULL表示顶级架构';
COMMENT ON COLUMN organizations.organization_type IS '架构类型：department-部门、group-小组、individual-个人';
COMMENT ON COLUMN organizations.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频，为NULL表示通用架构。用于限制该架构下只能管理对应类型的内容';
COMMENT ON COLUMN organizations.manager_id IS '架构负责人ID，外键关联users表，记录该架构的负责人（如部长、组长等）';
COMMENT ON COLUMN organizations.organization_description IS '架构描述，说明架构的用途和职责范围';
COMMENT ON COLUMN organizations.sort_order IS '排序顺序，数值越大越靠前，用于控制架构的显示顺序';
COMMENT ON COLUMN organizations.is_active IS '是否启用，TRUE-启用，FALSE-禁用，禁用的架构不参与管理';
COMMENT ON COLUMN organizations.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN organizations.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_organizations` (id)
- **外键约束**：
  - `fk_organizations_parent_id`：parent_id 关联 organizations 表，支持树形结构，删除时设置为 NULL
  - `fk_organizations_manager_id`：manager_id 关联 users 表，删除时设置为 NULL
- **非空约束**：organization_name、organization_type 必须非空
- **检查约束**：
  - `ck_organizations_organization_type`：organization_type 必须是预定义的值之一（department、group、individual）
  - `ck_organizations_content_type`：content_type 如果存在，必须是预定义的值之一（novel、comic、audio、video）
- **默认值**：
  - sort_order 默认为 0
  - is_active 默认为 TRUE

### 4. 设计索引

- **主键索引**：`pk_organizations` (id) - 自动创建
- **普通索引**：
  - `idx_organizations_parent_id` (parent_id) - 用于查询子架构，支持树形结构查询
  - `idx_organizations_manager_id` (manager_id) - 用于查询负责人管理的架构
  - `idx_organizations_organization_type` (organization_type) - 用于按类型查询
  - `idx_organizations_content_type` (content_type) - 用于按内容类型查询
  - `idx_organizations_is_active` (is_active) - 用于筛选启用的架构
  - `idx_organizations_sort_order` (sort_order) - 用于排序
- **复合索引**：
  - `idx_organizations_parent_sort` (parent_id, sort_order) - 用于按父架构查询并按排序顺序排列子架构

### 5. 考虑性能优化

- 为 parent_id 创建索引，支持高效的树形结构查询
- 创建复合索引 (parent_id, sort_order)，优化按父架构查询并按排序顺序排列的性能
- 为 manager_id 创建索引，支持查询负责人管理的架构
- 为 content_type 创建索引，支持按内容类型筛选架构
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**树形结构**：
- 使用 parent_id 字段实现树形结构，支持多层级架构
- 顶级架构的 parent_id 为 NULL
- 例如：小说部（parent_id=NULL） -> 小说编辑一组（parent_id=小说部ID） -> 编辑A（parent_id=小说编辑一组ID）

**架构类型**：
- department（部门）：如小说部、漫画部等，通常是顶级架构或第二级架构
- group（小组）：如小说编辑一组、小说编辑二组等，通常是部门的子架构
- individual（个人）：如具体的编辑个人，通常是小组的子架构

**内容类型限制**：
- content_type 为 NULL 表示通用架构，可以管理所有类型的内容
- content_type 不为 NULL 的架构，只能管理对应类型的内容
- 子架构的内容类型应该继承父架构的内容类型，或为空（通用）

**权限管理**：
- 架构负责人（manager_id）拥有该架构的管理权限
- 负责人可以根据角色权限进行组织架构管理、作者管理、作品管理等操作

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（树形查询、按负责人查询、按内容类型查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持树形结构和负责人关联
7. 检查约束正确设置，确保架构类型和内容类型的值有效
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 10.1 节 - 组织架构）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 10.1 节 - 组织架构）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:10:08 CST

