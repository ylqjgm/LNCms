# TASK002-83: 数据库设计 - 核心模块 - 用户虚拟物品表

## 任务信息

**任务编号**: TASK002-83  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 用户虚拟物品表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 11:15:00 CST

## 任务描述

设计核心模块的用户虚拟物品表（user_virtual_items），用于存储用户拥有的虚拟物品记录。记录用户获取虚拟物品的方式、时间、过期时间、使用状态等信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-34（虚拟物品表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解用户虚拟物品的详细需求：

**功能需求**：
- 记录用户拥有的虚拟物品
- 记录虚拟物品的获取方式（购买、赠送等）
- 记录虚拟物品的获取时间、过期时间
- 记录虚拟物品的使用状态（未使用、已使用、已过期）
- 记录虚拟物品的使用时间

**获取方式**：
- 购买（purchase）：用户通过购买获得虚拟物品
- 赠送（gift）：其他用户或系统赠送的虚拟物品
- 兑换（exchange）：用户通过积分或其他方式兑换的虚拟物品
- 其他（other）：其他方式获取

**使用状态**：
- 未使用（unused）：虚拟物品尚未使用
- 已使用（used）：虚拟物品已被使用
- 已过期（expired）：虚拟物品已过期

### 2. 设计用户虚拟物品表结构

设计 `user_virtual_items` 表：

```sql
CREATE TABLE user_virtual_items (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    virtual_item_id BIGINT NOT NULL,
    item_price NUMERIC(10, 2) NOT NULL,
    acquisition_method VARCHAR(20) NOT NULL,
    acquisition_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMPTZ,
    usage_status VARCHAR(20) NOT NULL DEFAULT 'unused',
    used_time TIMESTAMPTZ,
    used_for_type VARCHAR(20),
    used_for_id BIGINT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_user_virtual_items_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_user_virtual_items_virtual_item_id FOREIGN KEY (virtual_item_id) REFERENCES virtual_items(id) ON DELETE RESTRICT,
    CONSTRAINT ck_user_virtual_items_item_price CHECK (item_price >= 0),
    CONSTRAINT ck_user_virtual_items_acquisition_method CHECK (acquisition_method IN ('purchase', 'gift', 'exchange', 'other')),
    CONSTRAINT ck_user_virtual_items_usage_status CHECK (usage_status IN ('unused', 'used', 'expired')),
    CONSTRAINT ck_user_virtual_items_used_for_type CHECK (used_for_type IS NULL OR used_for_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_user_virtual_items_used_for_id CHECK (used_for_id IS NULL OR used_for_id > 0),
    CONSTRAINT ck_user_virtual_items_expires_at CHECK (expires_at IS NULL OR expires_at > acquisition_time)
);

-- 创建索引
CREATE INDEX idx_user_virtual_items_user_id ON user_virtual_items(user_id);
CREATE INDEX idx_user_virtual_items_virtual_item_id ON user_virtual_items(virtual_item_id);
CREATE INDEX idx_user_virtual_items_acquisition_method ON user_virtual_items(acquisition_method);
CREATE INDEX idx_user_virtual_items_usage_status ON user_virtual_items(usage_status);
CREATE INDEX idx_user_virtual_items_acquisition_time ON user_virtual_items(acquisition_time);
CREATE INDEX idx_user_virtual_items_expires_at ON user_virtual_items(expires_at);
CREATE INDEX idx_user_virtual_items_used_time ON user_virtual_items(used_time);
CREATE INDEX idx_user_virtual_items_created_at ON user_virtual_items(created_at);
CREATE INDEX idx_user_virtual_items_user_status ON user_virtual_items(user_id, usage_status);
CREATE INDEX idx_user_virtual_items_user_item ON user_virtual_items(user_id, virtual_item_id);
CREATE INDEX idx_user_virtual_items_status_expires ON user_virtual_items(usage_status, expires_at);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_user_virtual_items_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_user_virtual_items_updated_at
    BEFORE UPDATE ON user_virtual_items
    FOR EACH ROW
    EXECUTE FUNCTION update_user_virtual_items_updated_at();

-- 添加表注释
COMMENT ON TABLE user_virtual_items IS '用户虚拟物品表，存储用户拥有的虚拟物品记录';
COMMENT ON COLUMN user_virtual_items.id IS '记录ID，自增主键';
COMMENT ON COLUMN user_virtual_items.user_id IS '用户ID，外键关联users表，删除用户时级联删除虚拟物品记录';
COMMENT ON COLUMN user_virtual_items.virtual_item_id IS '虚拟物品ID，外键关联virtual_items表，指定虚拟物品类型，删除虚拟物品时限制删除（RESTRICT）以确保记录完整性';
COMMENT ON COLUMN user_virtual_items.item_price IS '虚拟物品价格，记录用户获取虚拟物品时的实际价格（单位：消费货币），用于避免因虚拟物品被删除或修改后导致的价格不明状况，必须非空';
COMMENT ON COLUMN user_virtual_items.acquisition_method IS '获取方式：purchase-购买、gift-赠送、exchange-兑换、other-其他';
COMMENT ON COLUMN user_virtual_items.acquisition_time IS '获取时间，用户获得虚拟物品的时间，默认为当前时间';
COMMENT ON COLUMN user_virtual_items.expires_at IS '过期时间，虚拟物品的过期时间，可以为NULL（永不过期），如果存在则必须大于获取时间';
COMMENT ON COLUMN user_virtual_items.usage_status IS '使用状态：unused-未使用、used-已使用、expired-已过期，默认为unused';
COMMENT ON COLUMN user_virtual_items.used_time IS '使用时间，用户使用虚拟物品的时间，使用虚拟物品时填充';
COMMENT ON COLUMN user_virtual_items.used_for_type IS '使用对象类型：novel-小说、comic-漫画、audio-音频、video-视频，使用虚拟物品时记录用于哪个内容类型，可以为NULL';
COMMENT ON COLUMN user_virtual_items.used_for_id IS '使用对象ID，使用虚拟物品时记录用于哪个内容（作品ID），可以为NULL';
COMMENT ON COLUMN user_virtual_items.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN user_virtual_items.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_user_virtual_items` (id)
- **外键约束**：
  - `fk_user_virtual_items_user_id`：user_id 关联 users 表，删除用户时级联删除虚拟物品记录
  - `fk_user_virtual_items_virtual_item_id`：virtual_item_id 关联 virtual_items 表，删除虚拟物品时限制删除（RESTRICT）以确保记录完整性
- **非空约束**：user_id、virtual_item_id、item_price、acquisition_method、acquisition_time、usage_status 必须非空
- **检查约束**：
  - `ck_user_virtual_items_item_price`：item_price 必须大于等于 0
  - `ck_user_virtual_items_acquisition_method`：acquisition_method 必须是预定义的值之一（purchase、gift、exchange、other）
  - `ck_user_virtual_items_usage_status`：usage_status 必须是预定义的值之一（unused、used、expired）
  - `ck_user_virtual_items_used_for_type`：used_for_type 如果存在，必须是预定义的值之一（novel、comic、audio、video）
  - `ck_user_virtual_items_used_for_id`：used_for_id 如果存在，必须大于 0
  - `ck_user_virtual_items_expires_at`：expires_at 如果存在，必须大于 acquisition_time
- **默认值**：
  - acquisition_time 默认为当前时间
  - usage_status 默认为 'unused'
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_user_virtual_items` (id) - 自动创建
- **普通索引**：
  - `idx_user_virtual_items_user_id` (user_id) - 用于查询用户拥有的虚拟物品
  - `idx_user_virtual_items_virtual_item_id` (virtual_item_id) - 用于查询特定虚拟物品的用户记录
  - `idx_user_virtual_items_acquisition_method` (acquisition_method) - 用于按获取方式查询
  - `idx_user_virtual_items_usage_status` (usage_status) - 用于按使用状态查询
  - `idx_user_virtual_items_acquisition_time` (acquisition_time) - 用于按获取时间排序和查询
  - `idx_user_virtual_items_expires_at` (expires_at) - 用于查询过期虚拟物品
  - `idx_user_virtual_items_used_time` (used_time) - 用于按使用时间排序和查询
  - `idx_user_virtual_items_created_at` (created_at) - 用于按创建时间排序和查询
- **复合索引**：
  - `idx_user_virtual_items_user_status` (user_id, usage_status) - 用于查询用户特定状态的虚拟物品（如未使用的虚拟物品）
  - `idx_user_virtual_items_user_item` (user_id, virtual_item_id) - 用于查询用户拥有的特定类型虚拟物品
  - `idx_user_virtual_items_status_expires` (usage_status, expires_at) - 用于查询特定状态且未过期的虚拟物品（如未使用且未过期的虚拟物品）

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户拥有的虚拟物品
- 创建复合索引 (user_id, usage_status)，优化查询用户特定状态虚拟物品的性能
- 创建复合索引 (user_id, virtual_item_id)，优化查询用户拥有的特定类型虚拟物品的性能
- 创建复合索引 (usage_status, expires_at)，优化查询可用虚拟物品的性能（未使用且未过期）
- 为 expires_at 创建索引，支持查询过期虚拟物品和定时任务
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**虚拟物品获取流程**：
1. **购买获取**：
   - 用户购买虚拟物品时，创建用户虚拟物品记录
   - acquisition_method 设置为 'purchase'
   - item_price 设置为虚拟物品表（virtual_items）中的 item_price 值，记录获取时的实际价格
   - acquisition_time 设置为当前时间
   - expires_at 根据虚拟物品配置设置（如果虚拟物品有过期时间）
   - usage_status 设置为 'unused'

2. **赠送获取**：
   - 其他用户或系统赠送虚拟物品时，创建用户虚拟物品记录
   - acquisition_method 设置为 'gift'
   - item_price 设置为虚拟物品表（virtual_items）中的 item_price 值，记录获取时的实际价格（即使赠送，也记录虚拟物品本身的价格）
   - acquisition_time 设置为当前时间
   - expires_at 根据虚拟物品配置设置
   - usage_status 设置为 'unused'

3. **兑换获取**：
   - 用户通过积分或其他方式兑换虚拟物品时，创建用户虚拟物品记录
   - acquisition_method 设置为 'exchange'
   - item_price 设置为虚拟物品表（virtual_items）中的 item_price 值，记录获取时的实际价格
   - acquisition_time 设置为当前时间
   - expires_at 根据虚拟物品配置设置
   - usage_status 设置为 'unused'

**虚拟物品使用流程**：
1. **使用虚拟物品**：
   - 用户使用虚拟物品时（如打赏），更新用户虚拟物品记录
   - usage_status 更新为 'used'
   - used_time 设置为当前时间
   - used_for_type 和 used_for_id 记录使用对象（如果适用，如打赏的作品）

2. **虚拟物品过期**：
   - 系统定期检查过期虚拟物品，更新状态
   - 如果 expires_at <= CURRENT_TIMESTAMP 且 usage_status = 'unused'，更新为 'expired'
   - 可以通过定时任务或触发器实现

**使用状态流转**：
- unused（未使用）→ used（已使用）：用户使用虚拟物品时
- unused（未使用）→ expired（已过期）：虚拟物品过期时
- used（已使用）和 expired（已过期）状态不可逆转

**过期时间处理**：
- 如果虚拟物品配置中有过期时间，expires_at 设置为获取时间 + 过期时长
- 如果虚拟物品配置中无过期时间，expires_at 为 NULL（永不过期）
- 过期时间必须大于获取时间

**使用对象记录**：
- used_for_type 和 used_for_id 记录虚拟物品用于哪个内容（作品）
- 例如：用于打赏时，记录打赏的作品类型和ID
- 用于特效时，记录特效应用的作品类型和ID

**与打赏记录表的关联**：
- 当用户使用虚拟物品进行打赏时，会创建 `tips` 表记录（TASK002-81）
- `tips` 表中的 `virtual_item_id` 关联 `virtual_items` 表
- `user_virtual_items` 表中的 `used_for_type` 和 `used_for_id` 可以与 `tips` 表中的 `content_type` 和 `content_id` 关联，用于追踪打赏记录

**价格记录说明**：
- item_price 字段记录用户获取虚拟物品时的实际价格（单位：消费货币）
- 该字段在用户获取虚拟物品时从虚拟物品表（virtual_items）中复制，用于保存历史价格信息
- 即使后续虚拟物品被删除或价格被修改，该字段仍保留获取时的价格，确保财务记录和收益计算的准确性
- 对于赠送或兑换的虚拟物品，也记录虚拟物品本身的价格，用于收益计算和审计

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按用户查询、按虚拟物品查询、按状态查询、查询可用虚拟物品）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持用户和虚拟物品关联
7. 检查约束正确设置，确保价格、获取方式、使用状态、使用对象和过期时间的值有效
8. 创建复合索引优化查询性能
9. 支持虚拟物品过期状态自动更新（通过定时任务或触发器）
10. 使用 RESTRICT 约束保护虚拟物品记录完整性
11. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 8.2 节 - 虚拟物品管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 8.2 节 - 虚拟物品管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-34.md` - 虚拟物品表设计文档
- `docs/TASKS/TASK002/TASK002-81.md` - 打赏记录表设计文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 11:15:00 CST

