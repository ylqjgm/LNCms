# TASK002-77: 数据库设计 - 核心模块 - 恢复记录表

## 任务信息

**任务编号**: TASK002-77  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 恢复记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 10:00:00 CST

## 任务描述

设计核心模块的恢复记录表（restore_records），用于存储数据恢复记录。记录每次恢复操作的执行情况，包括恢复类型、恢复目标、恢复状态、执行时间等。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-76（备份记录表）、TASK002-10（用户表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解恢复管理的详细需求：

**功能需求**：
- 对网站进行数据恢复
- 支持多种恢复类型
- 支持选择备份来源
- 支持恢复目标设定
- 记录恢复操作和结果

**恢复类型**：
- 数据恢复（data）：仅恢复数据库数据
- 文件恢复（file）：仅恢复文件数据
- 选择恢复（selective）：选择性恢复指定的数据或文件
- 全量恢复（full）：恢复所有数据和文件

**恢复目标**：
- 根据恢复类型不同进行设定
- 数据恢复：可指定恢复的数据库目标或当前数据库
- 文件恢复：可设定要恢复的数据库、存储目标等
- 选择恢复：可指定恢复的数据表和文件路径
- 全量恢复：恢复所有数据和文件到指定目标

**恢复状态**：
- 进行中（in_progress）：恢复任务正在执行
- 已完成（completed）：恢复任务成功完成
- 已失败（failed）：恢复任务执行失败

### 2. 设计恢复记录表结构

设计 `restore_records` 表：

```sql
CREATE TABLE restore_records (
    id BIGSERIAL PRIMARY KEY,
    backup_record_id BIGINT NOT NULL,
    restore_type VARCHAR(20) NOT NULL,
    restore_target JSONB NOT NULL,
    restore_selection JSONB NOT NULL,
    restore_status VARCHAR(20) NOT NULL DEFAULT 'in_progress',
    restore_start_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    restore_end_time TIMESTAMPTZ,
    restore_description TEXT,
    error_message TEXT,
    operator_id BIGINT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_restore_records_backup_record_id FOREIGN KEY (backup_record_id) REFERENCES backup_records(id) ON DELETE RESTRICT,
    CONSTRAINT fk_restore_records_operator_id FOREIGN KEY (operator_id) REFERENCES users(id) ON DELETE RESTRICT,
    CONSTRAINT ck_restore_records_restore_type CHECK (restore_type IN ('data', 'file', 'selective', 'full')),
    CONSTRAINT ck_restore_records_restore_status CHECK (restore_status IN ('in_progress', 'completed', 'failed')),
    CONSTRAINT ck_restore_records_restore_time CHECK (restore_end_time IS NULL OR restore_end_time >= restore_start_time)
);

-- 创建索引
CREATE INDEX idx_restore_records_backup_record_id ON restore_records(backup_record_id);
CREATE INDEX idx_restore_records_restore_type ON restore_records(restore_type);
CREATE INDEX idx_restore_records_restore_status ON restore_records(restore_status);
CREATE INDEX idx_restore_records_operator_id ON restore_records(operator_id);
CREATE INDEX idx_restore_records_restore_start_time ON restore_records(restore_start_time);
CREATE INDEX idx_restore_records_restore_end_time ON restore_records(restore_end_time);
CREATE INDEX idx_restore_records_created_at ON restore_records(created_at);
CREATE INDEX idx_restore_records_restore_target ON restore_records USING GIN (restore_target);
CREATE INDEX idx_restore_records_restore_selection ON restore_records USING GIN (restore_selection);
CREATE INDEX idx_restore_records_status_time ON restore_records(restore_status, restore_start_time);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_restore_records_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_restore_records_updated_at
    BEFORE UPDATE ON restore_records
    FOR EACH ROW
    EXECUTE FUNCTION update_restore_records_updated_at();

-- 添加表注释
COMMENT ON TABLE restore_records IS '恢复记录表，存储数据恢复记录，记录每次恢复操作的执行情况';
COMMENT ON COLUMN restore_records.id IS '记录ID，自增主键';
COMMENT ON COLUMN restore_records.backup_record_id IS '备份记录ID，外键关联backup_records表，指定恢复使用的备份来源，删除备份记录时限制删除（RESTRICT）以确保恢复记录完整性';
COMMENT ON COLUMN restore_records.restore_type IS '恢复类型：data-数据恢复、file-文件恢复、selective-选择恢复、full-全量恢复';
COMMENT ON COLUMN restore_records.restore_target IS '恢复目标，JSONB类型，根据恢复类型不同存储不同的目标配置。数据恢复时存储数据库目标配置；文件恢复时存储存储目标配置；选择恢复时存储选择的数据表和文件路径；全量恢复时存储恢复目标配置';
COMMENT ON COLUMN restore_records.restore_selection IS '恢复选择信息，JSONB类型，记录本次恢复选择了哪些数据库、表、文件路径等，用于故障排查和审计。所有恢复类型都应该记录选择信息，包括全量恢复（记录"全部"）。格式见业务逻辑说明';
COMMENT ON COLUMN restore_records.restore_status IS '恢复状态：in_progress-进行中、completed-已完成、failed-已失败';
COMMENT ON COLUMN restore_records.restore_start_time IS '恢复开始时间，恢复任务开始执行的时间，默认为当前时间';
COMMENT ON COLUMN restore_records.restore_end_time IS '恢复结束时间，恢复任务完成或失败的时间，必须大于等于开始时间';
COMMENT ON COLUMN restore_records.restore_description IS '恢复说明，操作人员填写的恢复说明';
COMMENT ON COLUMN restore_records.error_message IS '错误信息，恢复失败时记录的错误信息，包括错误代码和错误描述';
COMMENT ON COLUMN restore_records.operator_id IS '操作人员ID，外键关联users表，记录执行恢复操作的管理员，删除用户时限制删除（RESTRICT）以确保记录完整性';
COMMENT ON COLUMN restore_records.created_at IS '创建时间，自动设置为当前时间，即恢复记录创建的时间';
COMMENT ON COLUMN restore_records.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_restore_records` (id)
- **外键约束**：
  - `fk_restore_records_backup_record_id`：backup_record_id 关联 backup_records 表，删除备份记录时限制删除（RESTRICT）以确保恢复记录完整性
  - `fk_restore_records_operator_id`：operator_id 关联 users 表，删除用户时限制删除（RESTRICT）以确保记录完整性
- **非空约束**：backup_record_id、restore_type、restore_target、restore_selection、restore_status、restore_start_time、operator_id 必须非空
- **检查约束**：
  - `ck_restore_records_restore_type`：restore_type 必须是预定义的值之一（data、file、selective、full）
  - `ck_restore_records_restore_status`：restore_status 必须是预定义的值之一（in_progress、completed、failed）
  - `ck_restore_records_restore_time`：restore_end_time 如果存在，必须大于等于 restore_start_time
- **默认值**：
  - restore_status 默认为 'in_progress'
  - restore_start_time 默认为当前时间
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_restore_records` (id) - 自动创建
- **普通索引**：
  - `idx_restore_records_backup_record_id` (backup_record_id) - 用于查询特定备份的恢复记录
  - `idx_restore_records_restore_type` (restore_type) - 用于按恢复类型查询
  - `idx_restore_records_restore_status` (restore_status) - 用于按恢复状态查询
  - `idx_restore_records_operator_id` (operator_id) - 用于查询操作人员的恢复记录
  - `idx_restore_records_restore_start_time` (restore_start_time) - 用于按开始时间排序和查询
  - `idx_restore_records_restore_end_time` (restore_end_time) - 用于按结束时间排序和查询
  - `idx_restore_records_created_at` (created_at) - 用于按创建时间排序和查询
- **GIN索引**：
  - `idx_restore_records_restore_target` (restore_target) - 用于查询和过滤 JSONB 恢复目标字段
  - `idx_restore_records_restore_selection` (restore_selection) - 用于查询和过滤 JSONB 恢复选择信息字段，支持故障排查和审计查询
- **复合索引**：
  - `idx_restore_records_status_time` (restore_status, restore_start_time) - 用于查询特定状态并按时间排序（如查询进行中的恢复、查询失败的恢复等）

### 5. 考虑性能优化

- 为 backup_record_id 创建索引，支持快速查询特定备份的恢复记录
- 为 operator_id 创建索引，支持快速查询操作人员的恢复记录
- 创建复合索引 (restore_status, restore_start_time)，优化查询特定状态并按时间排序的性能
- 为 restore_target 创建 GIN 索引，支持高效查询 JSONB 恢复目标字段
- 为 restore_selection 创建 GIN 索引，支持高效查询 JSONB 恢复选择信息字段，便于故障排查和审计
- 为恢复时间字段创建索引，支持按时间范围查询和排序
- 使用触发器自动更新 updated_at 字段

### 6. 业务逻辑说明

**恢复类型说明**：
- **data（数据恢复）**：仅恢复数据库数据，不包括文件
- **file（文件恢复）**：仅恢复文件数据，不包括数据库
- **selective（选择恢复）**：选择性恢复指定的数据或文件
- **full（全量恢复）**：恢复所有数据库数据和文件数据

**恢复目标配置格式**（restore_target）：

```json
// 数据恢复目标配置
{
  "database": {
    "type": "current",  // current-当前数据库、specific-指定数据库
    "database_name": "lncms_core",  // 指定数据库时有效
    "tables": ["users", "authors"],  // 选择恢复时指定表，全量恢复时为null
    "exclude_tables": ["temp_data"]  // 排除的表
  }
}

// 文件恢复目标配置
{
  "storage": {
    "type": "current",  // current-当前存储、specific-指定存储
    "storage_id": 1,  // 指定存储时有效
    "paths": ["/uploads/images", "/uploads/videos"],  // 选择恢复时指定路径，全量恢复时为null
    "exclude_paths": ["/uploads/temp"]  // 排除的路径
  }
}

// 选择恢复目标配置
{
  "database": {
    "type": "current",
    "tables": ["users", "authors"]
  },
  "storage": {
    "type": "current",
    "paths": ["/uploads/images"]
  }
}

// 全量恢复目标配置
{
  "database": {
    "type": "current"
  },
  "storage": {
    "type": "current"
  }
}
```

**恢复选择信息格式**（restore_selection）：

```json
// 数据恢复选择信息（仅恢复数据库）
{
  "databases": [
    {
      "database_name": "lncms_core",
      "tables": ["users", "authors", "novels"],
      "exclude_tables": ["temp_data"],
      "restored_count": 3  // 实际恢复的表数量
    }
  ],
  "files": null
}

// 文件恢复选择信息（仅恢复文件）
{
  "databases": null,
  "files": {
    "paths": [
      "/uploads/images",
      "/uploads/videos"
    ],
    "exclude_paths": [
      "/uploads/temp"
    ],
    "include_patterns": [
      "*.jpg",
      "*.png",
      "*.mp4"
    ],
    "exclude_patterns": [
      "*.tmp"
    ],
    "restored_count": 1250,  // 实际恢复的文件数量
    "restored_size": 5368709120  // 实际恢复的文件总大小（字节）
  }
}

// 选择恢复选择信息（选择性恢复）
{
  "databases": [
    {
      "database_name": "lncms_core",
      "tables": ["users", "authors"],
      "exclude_tables": [],
      "restored_count": 2
    }
  ],
  "files": {
    "paths": ["/uploads/images"],
    "exclude_paths": [],
    "include_patterns": null,
    "exclude_patterns": null,
    "restored_count": 500,
    "restored_size": 2147483648
  }
}

// 全量恢复选择信息（恢复所有）
{
  "databases": [
    {
      "database_name": "lncms_core",
      "tables": "all",  // 表示所有表
      "exclude_tables": [],
      "restored_count": 50
    },
    {
      "database_name": "lncms_storage",
      "tables": "all",
      "exclude_tables": [],
      "restored_count": 20
    }
  ],
  "files": {
    "paths": "all",  // 表示所有路径
    "exclude_paths": [],
    "include_patterns": null,
    "exclude_patterns": null,
    "restored_count": 10000,
    "restored_size": 107374182400
  }
}
```

**恢复选择信息字段说明**：
- `databases`：数组类型，记录恢复的数据库和表信息。每个数据库对象包含：
  - `database_name`：数据库名称（必填）
  - `tables`：恢复的表列表，或字符串 "all" 表示所有表（必填）
  - `exclude_tables`：排除的表列表（可选）
  - `restored_count`：实际恢复的表数量（恢复完成后填充）
- `files`：对象类型，记录恢复的文件信息。包含：
  - `paths`：恢复的文件路径列表，或字符串 "all" 表示所有路径（可选）
  - `exclude_paths`：排除的路径列表（可选）
  - `include_patterns`：包含的文件匹配模式（可选）
  - `exclude_patterns`：排除的文件匹配模式（可选）
  - `restored_count`：实际恢复的文件数量（恢复完成后填充）
  - `restored_size`：实际恢复的文件总大小，单位：字节（恢复完成后填充）

**字段使用说明**：
- `restore_target`：存储"恢复到哪里"的信息，即恢复目标配置
- `restore_selection`：存储"恢复什么"的信息，即恢复选择信息，用于记录和审计
- 两个字段配合使用，完整记录恢复操作的详细信息，便于故障排查和审计

**恢复状态流转**：
1. **创建恢复记录**：
   - 恢复任务开始时，创建恢复记录
   - restore_status 设置为 'in_progress'
   - restore_start_time 设置为当前时间
   - operator_id 记录执行恢复操作的管理员
   - restore_selection 记录恢复选择信息（根据恢复类型和用户选择填充）

2. **恢复进行中**：
   - restore_status 保持为 'in_progress'
   - 系统执行恢复操作
   - 实时更新 restore_selection 中的 restored_count 和 restored_size（如果适用）

3. **恢复完成**：
   - restore_status 更新为 'completed'
   - restore_end_time 设置为当前时间
   - restore_selection 更新最终的实际恢复数量（restored_count）和大小（restored_size）

4. **恢复失败**：
   - restore_status 更新为 'failed'
   - restore_end_time 设置为当前时间
   - error_message 记录错误信息（包括错误代码和错误描述）
   - restore_selection 保留已恢复的部分信息（如果有）

**权限要求**：
- 恢复操作需要管理员权限
- operator_id 必须关联具有管理员权限的用户

**恢复安全**：
- 恢复操作会覆盖现有数据，需要谨慎操作
- 建议在恢复前进行数据备份
- 恢复操作应该记录详细的操作日志

**错误信息格式**：
- error_message 可以包含错误代码和详细描述
- 格式示例：`ERROR_CODE: 错误描述信息`
- 例如：`RESTORE_FAILED: 备份文件损坏，无法恢复`

**恢复说明**：
- 操作人员可以填写恢复说明，说明恢复的原因和目的
- 例如：`恢复2026-01-01的数据库备份，修复数据错误`

**故障排查和审计**：
- `restore_selection` 字段记录详细的恢复选择信息，包括：
  - 选择了哪些数据库和表
  - 选择了哪些文件路径
  - 实际恢复的数量和大小
- 这些信息有助于：
  - 故障排查：了解恢复操作的具体内容，定位问题
  - 审计追踪：记录恢复操作的详细历史
  - 性能分析：分析恢复操作的数据量和耗时
  - 合规要求：满足数据恢复操作的审计要求

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按备份记录查询、按类型查询、按状态查询、按操作人员查询、按时间查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 外键约束正确设置，支持备份记录和操作人员关联（删除时限制删除以确保记录完整性）
7. 检查约束正确设置，确保恢复类型、恢复状态和时间关系的值有效
8. 使用 JSONB 类型存储恢复目标和恢复选择信息，灵活支持不同恢复类型的配置需求
9. 为 JSONB 字段创建 GIN 索引，支持高效查询和故障排查
10. 恢复选择信息必须完整记录，包括所有恢复类型（全量恢复也应记录"全部"）
11. 恢复完成后，restore_selection 应包含实际恢复的数量和大小信息
12. 创建复合索引优化查询性能
13. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 11.2 节 - 恢复管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 11.2 节 - 恢复管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.1  
**最后更新**: 2026-01-03 09:50:00 CST

