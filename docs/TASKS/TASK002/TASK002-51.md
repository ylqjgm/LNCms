# TASK002-51: 数据库迁移脚本 - 核心模块

## 任务信息

**任务编号**: TASK002-51  
**父任务**: TASK002  
**任务名称**: 数据库迁移脚本 - 核心模块  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

编写核心模块的数据库迁移脚本，使用 golang-migrate 工具创建所有核心模块数据库表的迁移脚本。必须遵循 PostgreSQL 数据库设计规范和 golang-migrate 工具规范。

## 依赖任务

TASK002-41（弹幕表）

## 实现指南

### 1. 分析需求文档

阅读所有核心模块相关的数据库设计文档，了解所有表结构：
- 系统配置表（TASK002-01）
- 权限管理相关表（TASK002-02 到 TASK002-09）
- 用户管理相关表（TASK002-10 到 TASK002-12）
- 作者管理相关表（TASK002-13 到 TASK002-15）
- 内容管理相关表（TASK002-16 到 TASK002-33）
- 消费管理相关表（TASK002-34 到 TASK002-39）
- 互动管理相关表（TASK002-40 到 TASK002-41）

### 2. 创建迁移脚本文件

使用 golang-migrate 工具创建迁移脚本：
- 迁移脚本目录：`migrations/core/`
- 迁移脚本命名：`YYYYMMDDHHMMSS_description.up.sql` 和 `YYYYMMDDHHMMSS_description.down.sql`
- 示例：`20260102120000_create_core_tables.up.sql` 和 `20260102120000_create_core_tables.down.sql`

### 3. 编写迁移脚本

#### 3.1 升级脚本（up.sql）

按照依赖关系顺序创建所有表：

```sql
-- 系统配置表
-- 权限管理相关表
-- 用户管理相关表
-- 作者管理相关表
-- 内容管理相关表
-- 消费管理相关表
-- 互动管理相关表
```

#### 3.2 回滚脚本（down.sql）

按照相反顺序删除所有表：

```sql
-- 互动管理相关表
-- 消费管理相关表
-- 内容管理相关表
-- 作者管理相关表
-- 用户管理相关表
-- 权限管理相关表
-- 系统配置表
```

### 4. 迁移脚本要求

- **遵循依赖关系**：按照表之间的依赖关系顺序创建表
- **事务性**：每个迁移脚本应该在一个事务中执行
- **幂等性**：迁移脚本应该是幂等的，可以安全地重复执行
- **可回滚**：每个升级脚本必须有对应的回滚脚本
- **使用 IF NOT EXISTS**：创建表时使用 `CREATE TABLE IF NOT EXISTS`
- **使用 IF EXISTS**：删除表时使用 `DROP TABLE IF EXISTS`

### 5. 验证迁移脚本

- 使用 golang-migrate 工具验证迁移脚本语法
- 测试升级和回滚操作
- 确保所有表、索引、约束、触发器都正确创建

## 验收标准

1. 迁移脚本文件命名符合 golang-migrate 规范
2. 所有核心模块的表都包含在迁移脚本中
3. 迁移脚本按照依赖关系顺序创建表
4. 升级脚本和回滚脚本都正确编写
5. 迁移脚本遵循事务性、幂等性、可回滚原则
6. 迁移脚本可以成功执行，无错误
7. 回滚脚本可以成功执行，无错误

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-01.md` 到 `TASK002-41.md` - 核心模块数据库设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

