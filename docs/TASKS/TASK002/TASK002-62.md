# TASK002-62: 数据库设计 - 核心模块 - 模块表

## 任务信息

**任务编号**: TASK002-62  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 模块表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 09:03:10 CST

## 任务描述

设计核心模块的模块表（modules），用于存储系统模块信息，支持模块注册、启用、禁用和健康检查功能。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解模块管理的详细需求：
- **模块注册**：存储模块基本信息，包括模块名称、模块类型、模块标识、模块地址等
- **模块启用**：支持启用已注册的模块
- **模块禁用**：支持禁用已注册的模块
- **模块健康检查**：支持检查模块健康状态，需要记录最后心跳时间

**模块类型**：
- 存储模块（Storage Module）
- 日志模块（Log Module）
- 采集模块（Crawler Module）
- 其他可扩展模块类型

**模块状态**：
- 已注册（registered）：模块已注册但未启用
- 已启用（enabled）：模块已启用，正常服务
- 已禁用（disabled）：模块已被禁用
- 未连接（disconnected）：模块注册但无法连接
- 异常（error）：模块状态异常

### 2. 设计模块表结构

设计 `modules` 表，包含模块基本信息：

```sql
CREATE TABLE modules (
    id BIGSERIAL PRIMARY KEY,
    module_name VARCHAR(100) NOT NULL,
    module_type VARCHAR(50) NOT NULL,
    module_code VARCHAR(100) NOT NULL UNIQUE,
    module_url VARCHAR(500) NOT NULL,
    module_version VARCHAR(50),
    module_status VARCHAR(20) NOT NULL DEFAULT 'registered',
    module_description TEXT,
    registered_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    last_heartbeat_at TIMESTAMPTZ,
    config JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_modules_module_type CHECK (module_type IN ('storage', 'log', 'crawler', 'other')),
    CONSTRAINT ck_modules_module_status CHECK (module_status IN ('registered', 'enabled', 'disabled', 'disconnected', 'error'))
);

-- 创建索引
CREATE INDEX idx_modules_module_name ON modules(module_name);
CREATE INDEX idx_modules_module_type ON modules(module_type);
CREATE INDEX idx_modules_module_code ON modules(module_code);
CREATE INDEX idx_modules_module_status ON modules(module_status);
CREATE INDEX idx_modules_last_heartbeat_at ON modules(last_heartbeat_at);
CREATE UNIQUE INDEX uk_modules_module_code ON modules(module_code);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_modules_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_modules_updated_at
    BEFORE UPDATE ON modules
    FOR EACH ROW
    EXECUTE FUNCTION update_modules_updated_at();

-- 添加表注释
COMMENT ON TABLE modules IS '模块表，存储系统模块信息，支持模块注册、启用、禁用和健康检查';
COMMENT ON COLUMN modules.id IS '模块ID，自增主键';
COMMENT ON COLUMN modules.module_name IS '模块名称，如"存储模块"、"日志模块"、"采集模块"等';
COMMENT ON COLUMN modules.module_type IS '模块类型：storage-存储模块、log-日志模块、crawler-采集模块、other-其他模块';
COMMENT ON COLUMN modules.module_code IS '模块标识，唯一标识符，用于模块间的通信和识别，如"storage_module_001"、"log_module_001"等';
COMMENT ON COLUMN modules.module_url IS '模块地址，gRPC服务地址，格式如"grpc://localhost:50051"或"grpc://192.168.1.100:50051"';
COMMENT ON COLUMN modules.module_version IS '模块版本，如"v1.0.0"、"v1.2.3"等';
COMMENT ON COLUMN modules.module_status IS '模块状态：registered-已注册、enabled-已启用、disabled-已禁用、disconnected-未连接、error-异常';
COMMENT ON COLUMN modules.module_description IS '模块描述，说明模块的用途和功能';
COMMENT ON COLUMN modules.registered_at IS '注册时间，模块首次注册到系统的时间';
COMMENT ON COLUMN modules.last_heartbeat_at IS '最后心跳时间，模块最后一次发送心跳信号的时间，用于健康检查';
COMMENT ON COLUMN modules.config IS '模块配置，JSONB格式存储模块的额外配置信息，如超时时间、重试次数等';
COMMENT ON COLUMN modules.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN modules.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_modules` (id)
- **唯一约束**：`uk_modules_module_code` (module_code) - 确保模块标识唯一
- **非空约束**：module_name、module_type、module_code、module_url、module_status 必须非空
- **检查约束**：
  - `ck_modules_module_type`：module_type 必须是预定义的值之一（storage、log、crawler、other）
  - `ck_modules_module_status`：module_status 必须是预定义的值之一（registered、enabled、disabled、disconnected、error）
- **默认值**：
  - module_status 默认为 'registered'
  - registered_at 默认为当前时间
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_modules` (id) - 自动创建
- **唯一索引**：`uk_modules_module_code` (module_code) - 确保模块标识唯一，支持快速查询和识别
- **普通索引**：
  - `idx_modules_module_name` (module_name) - 用于按名称查询
  - `idx_modules_module_type` (module_type) - 用于按类型查询，支持筛选特定类型的模块
  - `idx_modules_module_status` (module_status) - 用于按状态查询，支持筛选已启用、已禁用等状态的模块
  - `idx_modules_last_heartbeat_at` (last_heartbeat_at) - 用于健康检查查询，支持查找长时间未心跳的模块

### 5. 考虑性能优化

- 为 module_code 创建唯一索引，支持快速查询和唯一性检查
- 为 module_type 和 module_status 创建索引，支持按类型和状态筛选查询
- 为 last_heartbeat_at 创建索引，支持健康检查时快速查找长时间未心跳的模块
- 使用触发器自动更新 updated_at 字段
- 使用 JSONB 类型存储模块配置，支持灵活的配置管理和高效查询
- 考虑创建复合索引 (module_type, module_status)，用于按类型和状态组合查询

### 6. 业务逻辑说明

**模块注册流程**：
1. 管理员通过 API 注册模块，提供模块基本信息（名称、类型、标识、地址等）
2. 系统将模块信息存储到 modules 表，状态设置为 'registered'
3. 系统尝试连接模块的 gRPC 服务，如果连接成功，状态更新为 'enabled'

**模块启用/禁用**：
1. 管理员通过 API 启用或禁用模块
2. 系统更新 modules 表的 module_status 字段为 'enabled' 或 'disabled'
3. 状态为 'disabled' 的模块，系统将不再调用其 gRPC 服务

**模块健康检查**：
1. 模块需要定期向核心模块发送心跳信号
2. 核心模块收到心跳后，更新 modules 表的 last_heartbeat_at 字段
3. 如果 last_heartbeat_at 超过设定的阈值（如5分钟），系统将模块状态更新为 'disconnected'
4. 如果模块连续多次无法连接，系统将状态更新为 'error'

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按名称、类型、状态查询，健康检查查询）
4. 表注释和字段注释完整，使用中文
5. 触发器正确创建，自动更新 updated_at 字段
6. 检查约束正确设置，确保模块类型和状态的值有效
7. 唯一约束正确设置，确保模块标识唯一
8. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 2 节 - 模块管理）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 2 节 - 模块管理）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 09:03:10 CST

