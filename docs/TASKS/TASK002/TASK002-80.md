# TASK002-80: 数据库设计 - 核心模块 - 投票记录表

## 任务信息

**任务编号**: TASK002-80  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 投票记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 10:30:00 CST

## 任务描述

设计核心模块的投票记录表（votes），用于存储用户投票记录。投票记录用于收益计算，支持票务收益统计。支持使用票务进行投票。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-35（票务表）、TASK002-19（小说表）、TASK002-23（漫画表）、TASK002-26（音频表）、TASK002-29（视频表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 和 `docs/Features/Core.md` 文档，了解投票功能的详细需求：

**功能需求**：
- 用户可以对作品进行投票
- 投票记录用于收益计算（票务收益）
- 支持使用票务进行投票
- 记录投票数量和投票时间

**票务收益规则**：
- 内容类型：小说、漫画、音频、视频
- 投票起点：达到多少投票后才开始进行收益计算
- 收益比例：每张票据对应价格与消费货币转换比例

**投票方式**：
- 可以使用票务进行投票（需要关联票务表）
- 也可以不使用票务进行投票（票务ID为NULL）

### 2. 设计投票记录表结构

设计 `votes` 表：

```sql
CREATE TABLE votes (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    ticket_id BIGINT,
    vote_count INTEGER NOT NULL DEFAULT 1,
    vote_time TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_votes_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_votes_ticket_id FOREIGN KEY (ticket_id) REFERENCES tickets(id) ON DELETE SET NULL,
    CONSTRAINT ck_votes_content_type CHECK (content_type IN ('novel', 'comic', 'audio', 'video')),
    CONSTRAINT ck_votes_content_id CHECK (content_id > 0),
    CONSTRAINT ck_votes_vote_count CHECK (vote_count > 0 AND vote_count <= 10000)
);

-- 创建索引
CREATE INDEX idx_votes_user_id ON votes(user_id);
CREATE INDEX idx_votes_content_type ON votes(content_type);
CREATE INDEX idx_votes_content_id ON votes(content_id);
CREATE INDEX idx_votes_ticket_id ON votes(ticket_id);
CREATE INDEX idx_votes_vote_time ON votes(vote_time);
CREATE INDEX idx_votes_created_at ON votes(created_at);
CREATE INDEX idx_votes_content_type_id ON votes(content_type, content_id);
CREATE INDEX idx_votes_user_time ON votes(user_id, vote_time);
CREATE INDEX idx_votes_content_time ON votes(content_type, content_id, vote_time);

-- 添加表注释
COMMENT ON TABLE votes IS '投票记录表，存储用户投票记录，用于收益计算';
COMMENT ON COLUMN votes.id IS '投票ID，自增主键';
COMMENT ON COLUMN votes.user_id IS '用户ID，外键关联users表，删除用户时级联删除投票记录';
COMMENT ON COLUMN votes.content_type IS '内容类型：novel-小说、comic-漫画、audio-音频、video-视频';
COMMENT ON COLUMN votes.content_id IS '内容ID，关联对应内容表（novels、comics、audios、videos），必须大于0';
COMMENT ON COLUMN votes.ticket_id IS '票务ID，外键关联tickets表，如果使用票务投票则关联票务，否则为NULL，删除票务时设置为NULL';
COMMENT ON COLUMN votes.vote_count IS '投票数量，用户本次投票的票数，范围：1-10000，默认为1';
COMMENT ON COLUMN votes.vote_time IS '投票时间，用户投票的时间，默认为当前时间';
COMMENT ON COLUMN votes.created_at IS '创建时间，自动设置为当前时间';
```

### 3. 设计约束

- **主键约束**：`pk_votes` (id)
- **外键约束**：
  - `fk_votes_user_id`：user_id 关联 users 表，删除用户时级联删除投票记录
  - `fk_votes_ticket_id`：ticket_id 关联 tickets 表，删除票务时设置为 NULL
- **非空约束**：user_id、content_type、content_id、vote_count、vote_time 必须非空
- **检查约束**：
  - `ck_votes_content_type`：content_type 必须是预定义的值之一（novel、comic、audio、video）
  - `ck_votes_content_id`：content_id 必须大于 0
  - `ck_votes_vote_count`：vote_count 必须在 1-10000 之间
- **默认值**：
  - vote_count 默认为 1
  - vote_time 默认为当前时间
  - created_at 默认为当前时间

### 4. 设计索引

- **主键索引**：`pk_votes` (id) - 自动创建
- **普通索引**：
  - `idx_votes_user_id` (user_id) - 用于查询用户的投票记录
  - `idx_votes_content_type` (content_type) - 用于按内容类型查询
  - `idx_votes_content_id` (content_id) - 用于查询作品的投票记录
  - `idx_votes_ticket_id` (ticket_id) - 用于查询使用特定票务的投票记录
  - `idx_votes_vote_time` (vote_time) - 用于按投票时间排序和查询
  - `idx_votes_created_at` (created_at) - 用于按创建时间排序和查询
- **复合索引**：
  - `idx_votes_content_type_id` (content_type, content_id) - 用于查询特定作品的投票记录（用于收益计算）
  - `idx_votes_user_time` (user_id, vote_time) - 用于查询用户投票记录并按时间排序
  - `idx_votes_content_time` (content_type, content_id, vote_time) - 用于查询特定作品在时间范围内的投票记录（用于收益统计）

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户的投票记录
- 创建复合索引 (content_type, content_id)，优化查询特定作品投票记录的性能（用于收益计算）
- 创建复合索引 (content_type, content_id, vote_time)，优化收益统计查询性能（按时间范围统计投票数量）
- 为 ticket_id 创建索引，支持查询使用特定票务的投票记录
- 投票记录支持多次投票，不设置唯一约束

### 6. 业务逻辑说明

**投票流程**：
1. **用户投票**：
   - 用户对作品进行投票时，创建投票记录
   - vote_time 设置为当前时间
   - vote_count 记录本次投票的票数
   - 如果使用票务投票，ticket_id 关联票务表

2. **多次投票**：
   - 同一用户可以对同一作品进行多次投票
   - 每次投票创建一条新记录
   - 不限制投票次数

**收益计算**：
- 票务收益计算时，查询 vote_time 在结算周期内的记录
- 统计每个作品的投票数量（vote_count 求和），用于计算票务收益
- 投票起点：达到设定的投票数量后才开始计算收益
- 收益比例：每张票据对应价格与消费货币转换比例

**票务关联**：
- 如果使用票务投票，ticket_id 关联票务表
- 如果直接投票（不使用票务），ticket_id 为 NULL
- 删除票务时，投票记录保留，ticket_id 设置为 NULL

**内容关联**：
- content_type 和 content_id 组合关联对应的内容表：
  - novel + content_id → novels 表
  - comic + content_id → comics 表
  - audio + content_id → audios 表
  - video + content_id → videos 表

**投票数量限制**：
- vote_count 范围：1-10000
- 单次投票最多10000票
- 支持批量投票场景

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 索引设计合理，支持常用查询场景（按用户查询、按作品查询、按票务查询、收益计算查询）
4. 表注释和字段注释完整，使用中文
5. 外键约束正确设置，支持用户和票务关联
6. 检查约束正确设置，确保内容类型、内容ID和投票数量的值有效
7. 创建复合索引优化收益计算和统计查询性能
8. 支持多次投票，不设置唯一约束
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档（第 3.2.5 节 - 票务收益）
- `docs/Features/Core.md` - 核心模块功能描述文档（第 3.2.5 节 - 票务收益）
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/Analysis/TASK002-MISSING-TABLES.md` - 缺失数据库设计任务分析报告

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0.0  
**最后更新**: 2026-01-03 10:30:00 CST

