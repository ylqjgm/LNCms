# TASK002-40: 数据库设计 - 核心模块 - 弹幕表

## 任务信息

**任务编号**: TASK002-40  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 弹幕表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的弹幕表（danmaku），用于存储用户对视频和漫画章节的弹幕信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）、TASK002-24（漫画章节表）、TASK002-30（视频分季表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解弹幕管理的详细需求：
- 弹幕管理：弹幕添加、弹幕修改、弹幕删除、弹幕审核
- 弹幕属于用户，需要关联用户表
- 弹幕支持视频分集和漫画章节两种内容类型
- 弹幕需要支持时间轴位置、弹幕内容、弹幕类型、弹幕颜色等

### 2. 设计弹幕表结构

设计 `danmaku` 表，使用多态关联设计，支持视频分集和漫画章节：

```sql
CREATE TABLE danmaku (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content_type VARCHAR(20) NOT NULL,
    content_id BIGINT NOT NULL,
    time_offset DECIMAL(10, 3) NOT NULL,
    danmaku_type VARCHAR(20) NOT NULL DEFAULT 'scroll',
    danmaku_content TEXT NOT NULL,
    danmaku_color VARCHAR(20) NOT NULL DEFAULT '#FFFFFF',
    font_size INTEGER NOT NULL DEFAULT 25,
    danmaku_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_danmaku_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT ck_danmaku_content_type CHECK (content_type IN ('video_episode', 'comic_chapter')),
    CONSTRAINT ck_danmaku_danmaku_type CHECK (danmaku_type IN ('scroll', 'top', 'bottom')),
    CONSTRAINT ck_danmaku_time_offset CHECK (time_offset >= 0),
    CONSTRAINT ck_danmaku_font_size CHECK (font_size >= 12 AND font_size <= 50),
    CONSTRAINT ck_danmaku_danmaku_status CHECK (danmaku_status IN ('pending', 'approved', 'rejected', 'deleted'))
);

-- 创建索引
CREATE INDEX idx_danmaku_user_id ON danmaku(user_id);
CREATE INDEX idx_danmaku_content_type ON danmaku(content_type);
CREATE INDEX idx_danmaku_content_id ON danmaku(content_id);
CREATE INDEX idx_danmaku_time_offset ON danmaku(time_offset);
CREATE INDEX idx_danmaku_danmaku_status ON danmaku(danmaku_status);
CREATE INDEX idx_danmaku_created_at ON danmaku(created_at);
CREATE INDEX idx_danmaku_content_type_content_id ON danmaku(content_type, content_id);
CREATE INDEX idx_danmaku_content_type_time ON danmaku(content_type, content_id, time_offset);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_danmaku_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_danmaku_updated_at
    BEFORE UPDATE ON danmaku
    FOR EACH ROW
    EXECUTE FUNCTION update_danmaku_updated_at();

-- 添加表注释
COMMENT ON TABLE danmaku IS '弹幕表，存储用户对视频分集和漫画章节的弹幕信息';
COMMENT ON COLUMN danmaku.id IS '弹幕ID，自增主键';
COMMENT ON COLUMN danmaku.user_id IS '用户ID，外键关联users表';
COMMENT ON COLUMN danmaku.content_type IS '内容类型：video_episode-视频分集、comic_chapter-漫画章节';
COMMENT ON COLUMN danmaku.content_id IS '内容ID，根据content_type关联对应的内容表（video_episodes.id、comic_chapters.id）';
COMMENT ON COLUMN danmaku.time_offset IS '时间轴位置，单位：秒，精确到毫秒，用于视频分集；对于漫画章节，表示页面位置（页码或百分比）';
COMMENT ON COLUMN danmaku.danmaku_type IS '弹幕类型：scroll-滚动弹幕、top-顶部弹幕、bottom-底部弹幕';
COMMENT ON COLUMN danmaku.danmaku_content IS '弹幕内容';
COMMENT ON COLUMN danmaku.danmaku_color IS '弹幕颜色，十六进制颜色值，如#FFFFFF';
COMMENT ON COLUMN danmaku.font_size IS '字体大小，范围12-50，单位：像素';
COMMENT ON COLUMN danmaku.danmaku_status IS '弹幕状态：pending-待审核、approved-已通过、rejected-已拒绝、deleted-已删除';
COMMENT ON COLUMN danmaku.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN danmaku.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_danmaku` (id)
- **外键约束**：`fk_danmaku_user_id` (user_id) 关联 users(id)，级联删除
- **检查约束**：`ck_danmaku_content_type` (content_type) - 确保内容类型是预定义的值
- **检查约束**：`ck_danmaku_danmaku_type` (danmaku_type) - 确保弹幕类型是预定义的值
- **检查约束**：`ck_danmaku_time_offset` (time_offset) - 确保时间轴位置大于等于0
- **检查约束**：`ck_danmaku_font_size` (font_size) - 确保字体大小在12-50之间
- **检查约束**：`ck_danmaku_danmaku_status` (danmaku_status) - 确保弹幕状态是预定义的值
- **非空约束**：user_id、content_type、content_id、time_offset、danmaku_content、danmaku_status 必须非空
- **默认值**：danmaku_type 默认为 'scroll'，danmaku_color 默认为 '#FFFFFF'，font_size 默认为 25，danmaku_status 默认为 'pending'
- **注意**：content_id 的外键约束需要在应用层验证，因为需要根据 content_type 关联不同的表

### 4. 设计索引

- **主键索引**：`pk_danmaku` (id) - 自动创建
- **外键索引**：`idx_danmaku_user_id` (user_id) - 用于查询用户的弹幕
- **普通索引**：`idx_danmaku_content_type` (content_type) - 用于按内容类型筛选
- **普通索引**：`idx_danmaku_content_id` (content_id) - 用于查询内容的弹幕
- **普通索引**：`idx_danmaku_time_offset` (time_offset) - 用于按时间轴位置查询
- **普通索引**：`idx_danmaku_danmaku_status` (danmaku_status) - 用于按状态筛选
- **普通索引**：`idx_danmaku_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_danmaku_content_type_content_id` (content_type, content_id) - 用于查询特定内容的弹幕列表
- **复合索引**：`idx_danmaku_content_type_time` (content_type, content_id, time_offset) - 用于查询特定内容的弹幕并按时间轴位置排序

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户的弹幕
- 为 content_type 和 content_id 创建复合索引，支持快速查询内容的弹幕列表
- 为 time_offset 创建索引，支持按时间轴位置查询
- 为 danmaku_status 创建索引，支持按状态筛选查询
- 使用复合索引优化常用查询场景（如查询特定内容的弹幕并按时间轴位置排序）
- 使用触发器自动更新 updated_at 字段
- 由于使用多态关联，content_id 的外键约束需要在应用层验证

### 6. 查询示例

```sql
-- 查询视频分集的所有弹幕，按时间轴位置排序
SELECT d.*, u.username
FROM danmaku d
JOIN users u ON d.user_id = u.id
WHERE d.content_type = 'video_episode' 
  AND d.content_id = 1
  AND d.danmaku_status = 'approved'
ORDER BY d.time_offset ASC;

-- 查询漫画章节的所有弹幕，按时间轴位置排序
SELECT d.*, u.username
FROM danmaku d
JOIN users u ON d.user_id = u.id
WHERE d.content_type = 'comic_chapter' 
  AND d.content_id = 1
  AND d.danmaku_status = 'approved'
ORDER BY d.time_offset ASC;

-- 查询用户的所有弹幕，按创建时间倒序
SELECT d.*
FROM danmaku d
WHERE d.user_id = 1
  AND d.danmaku_status != 'deleted'
ORDER BY d.created_at DESC;
```

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 users 表
4. 检查约束正确，确保内容类型、弹幕类型、时间轴位置、字体大小、弹幕状态等是有效的值
5. 索引设计合理，支持常用查询场景（包括按内容查询弹幕、按用户查询弹幕、按时间轴位置排序）
6. 表注释和字段注释完整，使用中文
7. 触发器正确创建，自动更新 updated_at 字段
8. 表设计符合 PostgreSQL 数据库设计规范
9. 支持视频分集和漫画章节两种内容类型的弹幕
10. 支持弹幕类型（滚动、顶部、底部）、弹幕颜色、字体大小等属性

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-10.md` - 用户表设计文档
- `docs/TASKS/TASK002/TASK002-24.md` - 漫画章节表设计文档
- `docs/TASKS/TASK002/TASK002-30.md` - 视频分季表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

