# TASK002-33: 数据库设计 - 核心模块 - 渠道表

## 任务信息

**任务编号**: TASK002-33  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 渠道表  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的渠道表（channels），用于存储支付渠道信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Features/Core.md` 和 `docs/Requirements/Core.md` 文档，了解渠道管理的详细需求：
- 渠道管理：渠道添加、渠道配置、渠道删除、渠道状态管理
- 渠道用途：充值渠道、提现渠道
- 渠道用于支付流水记录，标识支付来源
- 不同渠道类型需要不同的配置信息（如支付宝、微信、银行等）

### 2. 设计渠道表结构

设计 `channels` 表，包含渠道基本信息：

```sql
CREATE TABLE channels (
    id BIGSERIAL PRIMARY KEY,
    channel_name VARCHAR(100) NOT NULL UNIQUE,
    channel_code VARCHAR(50) NOT NULL UNIQUE,
    channel_type VARCHAR(20) NOT NULL,
    channel_usage VARCHAR(20) NOT NULL,
    channel_config JSONB,
    channel_description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_channels_channel_type CHECK (channel_type IN ('alipay', 'wechat', 'bank', 'other')),
    CONSTRAINT ck_channels_channel_usage CHECK (channel_usage IN ('recharge', 'withdraw', 'both'))
);

-- 创建索引
CREATE UNIQUE INDEX uk_channels_channel_name ON channels(channel_name);
CREATE UNIQUE INDEX uk_channels_channel_code ON channels(channel_code);
CREATE INDEX idx_channels_channel_type ON channels(channel_type);
CREATE INDEX idx_channels_channel_usage ON channels(channel_usage);
CREATE INDEX idx_channels_is_active ON channels(is_active);
CREATE INDEX idx_channels_config ON channels USING GIN (channel_config);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_channels_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_channels_updated_at
    BEFORE UPDATE ON channels
    FOR EACH ROW
    EXECUTE FUNCTION update_channels_updated_at();

-- 添加表注释
COMMENT ON TABLE channels IS '渠道表，存储充值渠道和提现渠道信息';
COMMENT ON COLUMN channels.id IS '渠道ID，自增主键';
COMMENT ON COLUMN channels.channel_name IS '渠道名称，唯一标识符';
COMMENT ON COLUMN channels.channel_code IS '渠道代码，唯一标识符，用于系统内部识别';
COMMENT ON COLUMN channels.channel_type IS '渠道类型：alipay-支付宝、wechat-微信、bank-银行、other-其他';
COMMENT ON COLUMN channels.channel_usage IS '渠道用途：recharge-充值渠道、withdraw-提现渠道、both-充值和提现';
COMMENT ON COLUMN channels.channel_config IS '渠道配置信息，JSON格式，存储不同渠道类型的具体配置参数（如API密钥、商户号、回调地址等）';
COMMENT ON COLUMN channels.channel_description IS '渠道描述，说明渠道的用途和特点';
COMMENT ON COLUMN channels.is_active IS '是否启用，TRUE-启用，FALSE-禁用';
COMMENT ON COLUMN channels.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN channels.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_channels` (id)
- **唯一约束**：`uk_channels_channel_name` (channel_name)、`uk_channels_channel_code` (channel_code)
- **检查约束**：
  - `ck_channels_channel_type` (channel_type) - 确保渠道类型是预定义的值（alipay、wechat、bank、other）
  - `ck_channels_channel_usage` (channel_usage) - 确保渠道用途是预定义的值（recharge、withdraw、both）
- **非空约束**：channel_name、channel_code、channel_type、channel_usage 必须非空
- **默认值**：is_active 默认为 TRUE

### 4. 设计索引

- **主键索引**：`pk_channels` (id) - 自动创建
- **唯一索引**：`uk_channels_channel_name` (channel_name) - 确保渠道名称唯一
- **唯一索引**：`uk_channels_channel_code` (channel_code) - 确保渠道代码唯一
- **普通索引**：`idx_channels_channel_type` (channel_type) - 用于按类型筛选
- **普通索引**：`idx_channels_channel_usage` (channel_usage) - 用于按用途筛选（充值、提现）
- **普通索引**：`idx_channels_is_active` (is_active) - 用于状态筛选
- **GIN 索引**：`idx_channels_config` (channel_config) - 用于 JSONB 配置字段的快速查询

### 5. 考虑性能优化

- 为 channel_name 和 channel_code 创建唯一索引，支持快速查询和唯一性检查
- 为 channel_type 创建索引，支持按类型筛选查询
- 为 channel_usage 创建索引，支持按用途筛选查询（充值、提现）
- 为 is_active 创建索引，支持状态筛选查询
- 为 channel_config 创建 GIN 索引，支持 JSONB 字段的高效查询和过滤
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段（包括渠道配置和渠道用途）
2. 所有字段都有适当的类型、约束和默认值
3. 唯一约束正确，确保渠道名称和渠道代码唯一
4. 检查约束正确，确保渠道类型和渠道用途是预定义的值
5. 渠道配置字段使用 JSONB 类型，支持灵活的配置信息存储
6. 索引设计合理，支持常用查询场景（包括 JSONB 字段的 GIN 索引）
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新 updated_at 字段
9. 表设计符合 PostgreSQL 数据库设计规范
10. 表设计符合功能概述中的渠道管理需求（支持渠道配置、区分充值渠道和提现渠道）

## 相关文件

- `docs/Features/Core.md` - 核心模块功能概述文档（8.1 渠道管理）
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 08:28:12 CST

