# TASK002-47: 数据库设计 - 日志模块 - 日志归档表

## 任务信息

**任务编号**: TASK002-47  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 日志模块 - 日志归档表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计日志模块的日志归档表（log_archives），用于存储归档日志信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Log.md` 文档，了解日志归档的详细需求：
- 日志归档：根据日志配置要求，自动将过期日志进行归档处理
- 归档记录：记录归档文件路径、归档时间、归档策略等信息
- 归档文件管理：支持归档文件的查询、下载、删除等操作

### 2. 设计日志归档表结构

设计 `log_archives` 表，包含日志归档基本信息：

```sql
CREATE TABLE log_archives (
    id BIGSERIAL PRIMARY KEY,
    archive_name VARCHAR(200) NOT NULL,
    archive_path VARCHAR(500) NOT NULL,
    archive_type VARCHAR(20) NOT NULL,
    archive_period VARCHAR(20) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    log_count BIGINT NOT NULL DEFAULT 0,
    file_size BIGINT NOT NULL DEFAULT 0,
    archive_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    archived_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_log_archives_archive_type CHECK (archive_type IN ('system', 'operation', 'error', 'access', 'all')),
    CONSTRAINT ck_log_archives_archive_period CHECK (archive_period IN ('daily', 'weekly', 'monthly', 'yearly')),
    CONSTRAINT ck_log_archives_log_count CHECK (log_count >= 0),
    CONSTRAINT ck_log_archives_file_size CHECK (file_size >= 0),
    CONSTRAINT ck_log_archives_archive_status CHECK (archive_status IN ('pending', 'archiving', 'completed', 'failed', 'deleted')),
    CONSTRAINT ck_log_archives_date_range CHECK (end_date >= start_date)
);

-- 创建索引
CREATE INDEX idx_log_archives_archive_type ON log_archives(archive_type);
CREATE INDEX idx_log_archives_archive_period ON log_archives(archive_period);
CREATE INDEX idx_log_archives_start_date ON log_archives(start_date);
CREATE INDEX idx_log_archives_end_date ON log_archives(end_date);
CREATE INDEX idx_log_archives_archive_status ON log_archives(archive_status);
CREATE INDEX idx_log_archives_archived_at ON log_archives(archived_at);
CREATE INDEX idx_log_archives_created_at ON log_archives(created_at);
CREATE INDEX idx_log_archives_type_period ON log_archives(archive_type, archive_period);
CREATE INDEX idx_log_archives_date_range ON log_archives(start_date, end_date);
CREATE INDEX idx_log_archives_status_archived ON log_archives(archive_status, archived_at);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_log_archives_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_log_archives_updated_at
    BEFORE UPDATE ON log_archives
    FOR EACH ROW
    EXECUTE FUNCTION update_log_archives_updated_at();

-- 添加表注释
COMMENT ON TABLE log_archives IS '日志归档表，存储归档日志信息';
COMMENT ON COLUMN log_archives.id IS '归档记录ID，自增主键';
COMMENT ON COLUMN log_archives.archive_name IS '归档名称，归档文件的名称';
COMMENT ON COLUMN log_archives.archive_path IS '归档路径，归档文件在存储系统中的路径';
COMMENT ON COLUMN log_archives.archive_type IS '归档类型：system-系统日志、operation-操作日志、error-错误日志、access-访问日志、all-全部日志';
COMMENT ON COLUMN log_archives.archive_period IS '归档周期：daily-按日归档、weekly-按周归档、monthly-按月归档、yearly-按年归档';
COMMENT ON COLUMN log_archives.start_date IS '开始日期，归档日志的开始日期';
COMMENT ON COLUMN log_archives.end_date IS '结束日期，归档日志的结束日期，必须大于等于开始日期';
COMMENT ON COLUMN log_archives.log_count IS '日志数量，归档文件包含的日志条数，大于等于0';
COMMENT ON COLUMN log_archives.file_size IS '文件大小，单位：字节，大于等于0';
COMMENT ON COLUMN log_archives.archive_status IS '归档状态：pending-待归档、archiving-归档中、completed-已完成、failed-失败、deleted-已删除';
COMMENT ON COLUMN log_archives.archived_at IS '归档时间，归档完成时的时间';
COMMENT ON COLUMN log_archives.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN log_archives.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_log_archives` (id)
- **检查约束**：`ck_log_archives_archive_type` (archive_type) - 确保归档类型是预定义的值
- **检查约束**：`ck_log_archives_archive_period` (archive_period) - 确保归档周期是预定义的值
- **检查约束**：`ck_log_archives_log_count` (log_count) - 确保日志数量大于等于0
- **检查约束**：`ck_log_archives_file_size` (file_size) - 确保文件大小大于等于0
- **检查约束**：`ck_log_archives_archive_status` (archive_status) - 确保归档状态是预定义的值
- **检查约束**：`ck_log_archives_date_range` (end_date, start_date) - 确保结束日期大于等于开始日期
- **非空约束**：archive_name、archive_path、archive_type、archive_period、start_date、end_date、archive_status 必须非空
- **默认值**：log_count、file_size 默认为 0，archive_status 默认为 'pending'
- **可选字段**：archived_at 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_log_archives` (id) - 自动创建
- **普通索引**：`idx_log_archives_archive_type` (archive_type) - 用于按归档类型筛选
- **普通索引**：`idx_log_archives_archive_period` (archive_period) - 用于按归档周期筛选
- **普通索引**：`idx_log_archives_start_date` (start_date) - 用于按开始日期查询
- **普通索引**：`idx_log_archives_end_date` (end_date) - 用于按结束日期查询
- **普通索引**：`idx_log_archives_archive_status` (archive_status) - 用于按归档状态筛选
- **普通索引**：`idx_log_archives_archived_at` (archived_at) - 用于按归档时间排序
- **普通索引**：`idx_log_archives_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_log_archives_type_period` (archive_type, archive_period) - 用于按归档类型和周期筛选
- **复合索引**：`idx_log_archives_date_range` (start_date, end_date) - 用于按日期范围查询
- **复合索引**：`idx_log_archives_status_archived` (archive_status, archived_at) - 用于查询特定状态的归档记录并按时间排序

### 5. 考虑性能优化

- 为 archive_type 和 archive_period 创建索引，支持按类型和周期筛选查询
- 为 start_date 和 end_date 创建索引，支持按日期范围查询
- 为 archive_status 创建索引，支持按归档状态筛选查询
- 为 archived_at 和 created_at 创建索引，支持时间排序查询
- 使用复合索引优化常用查询场景（如按归档类型和周期筛选、按日期范围查询、按归档状态和时间排序）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 检查约束正确，确保归档类型、归档周期、归档状态、日期范围等是有效的值
4. 索引设计合理，支持常用查询场景（包括按归档类型查询、按归档周期查询、按日期范围查询、按归档状态查询）
5. 表注释和字段注释完整，使用中文
6. 触发器正确创建，自动更新 updated_at 字段
7. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Log.md` - 日志模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

