# TASK002-35: 数据库设计 - 核心模块 - 票务表

## 任务信息

**任务编号**: TASK002-35  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 票务表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的票务表（tickets），用于存储用户票务信息（如VIP会员、阅读券等）。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-10（用户表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Core.md` 文档，了解票务管理的详细需求：
- 票务管理：票务购买、票务使用、票务过期、票务状态管理
- 票务属于用户，需要关联用户表
- 票务需要支持有效期管理

### 2. 设计票务表结构

设计 `tickets` 表，包含票务基本信息：

```sql
CREATE TABLE tickets (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    ticket_type VARCHAR(20) NOT NULL,
    ticket_name VARCHAR(100) NOT NULL,
    ticket_code VARCHAR(50) NOT NULL UNIQUE,
    quantity INTEGER NOT NULL DEFAULT 1,
    used_quantity INTEGER NOT NULL DEFAULT 0,
    valid_from TIMESTAMPTZ NOT NULL,
    valid_until TIMESTAMPTZ NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_tickets_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT ck_tickets_ticket_type CHECK (ticket_type IN ('vip', 'read', 'watch', 'listen', 'other')),
    CONSTRAINT ck_tickets_quantity CHECK (quantity > 0),
    CONSTRAINT ck_tickets_used_quantity CHECK (used_quantity >= 0 AND used_quantity <= quantity),
    CONSTRAINT ck_tickets_valid_period CHECK (valid_until > valid_from)
);

-- 创建索引
CREATE INDEX idx_tickets_user_id ON tickets(user_id);
CREATE UNIQUE INDEX uk_tickets_ticket_code ON tickets(ticket_code);
CREATE INDEX idx_tickets_ticket_type ON tickets(ticket_type);
CREATE INDEX idx_tickets_is_active ON tickets(is_active);
CREATE INDEX idx_tickets_valid_from ON tickets(valid_from);
CREATE INDEX idx_tickets_valid_until ON tickets(valid_until);
CREATE INDEX idx_tickets_user_type ON tickets(user_id, ticket_type);
CREATE INDEX idx_tickets_user_valid ON tickets(user_id, valid_from, valid_until);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_tickets_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_tickets_updated_at
    BEFORE UPDATE ON tickets
    FOR EACH ROW
    EXECUTE FUNCTION update_tickets_updated_at();

-- 添加表注释
COMMENT ON TABLE tickets IS '票务表，存储用户票务信息（如VIP会员、阅读券等）';
COMMENT ON COLUMN tickets.id IS '票务ID，自增主键';
COMMENT ON COLUMN tickets.user_id IS '用户ID，外键关联users表';
COMMENT ON COLUMN tickets.ticket_type IS '票务类型：vip-VIP会员、read-阅读券、watch-观看券、listen-收听券、other-其他';
COMMENT ON COLUMN tickets.ticket_name IS '票务名称';
COMMENT ON COLUMN tickets.ticket_code IS '票务代码，唯一标识符，用于系统内部识别';
COMMENT ON COLUMN tickets.quantity IS '票务数量，大于0';
COMMENT ON COLUMN tickets.used_quantity IS '已使用数量，大于等于0且小于等于数量';
COMMENT ON COLUMN tickets.valid_from IS '有效期开始时间';
COMMENT ON COLUMN tickets.valid_until IS '有效期结束时间，必须大于开始时间';
COMMENT ON COLUMN tickets.is_active IS '是否启用，TRUE-启用，FALSE-禁用';
COMMENT ON COLUMN tickets.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN tickets.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_tickets` (id)
- **外键约束**：`fk_tickets_user_id` (user_id) 关联 users(id)，级联删除
- **唯一约束**：`uk_tickets_ticket_code` (ticket_code)
- **检查约束**：`ck_tickets_ticket_type` (ticket_type) - 确保票务类型是预定义的值
- **检查约束**：`ck_tickets_quantity` (quantity) - 确保数量大于0
- **检查约束**：`ck_tickets_used_quantity` (used_quantity) - 确保已使用数量大于等于0且小于等于数量
- **检查约束**：`ck_tickets_valid_period` (valid_until, valid_from) - 确保结束时间大于开始时间
- **非空约束**：user_id、ticket_type、ticket_name、ticket_code、quantity、used_quantity、valid_from、valid_until 必须非空
- **默认值**：quantity 默认为 1，used_quantity 默认为 0，is_active 默认为 TRUE

### 4. 设计索引

- **主键索引**：`pk_tickets` (id) - 自动创建
- **外键索引**：`idx_tickets_user_id` (user_id) - 用于查询用户的票务
- **唯一索引**：`uk_tickets_ticket_code` (ticket_code) - 确保票务代码唯一
- **普通索引**：`idx_tickets_ticket_type` (ticket_type) - 用于按类型筛选
- **普通索引**：`idx_tickets_is_active` (is_active) - 用于状态筛选
- **普通索引**：`idx_tickets_valid_from` (valid_from) - 用于有效期查询
- **普通索引**：`idx_tickets_valid_until` (valid_until) - 用于有效期查询
- **复合索引**：`idx_tickets_user_type` (user_id, ticket_type) - 用于查询用户的特定类型票务
- **复合索引**：`idx_tickets_user_valid` (user_id, valid_from, valid_until) - 用于查询用户的有效票务

### 5. 考虑性能优化

- 为 user_id 创建索引，支持快速查询用户的票务
- 为 ticket_code 创建唯一索引，支持快速查询和唯一性检查
- 为 ticket_type 创建索引，支持按类型筛选查询
- 为 valid_from 和 valid_until 创建索引，支持有效期查询
- 使用复合索引优化常用查询场景（如查询用户的有效票务、查询用户的特定类型票务）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 users 表
4. 唯一约束正确，确保票务代码唯一
5. 检查约束正确，确保票务类型、数量、有效期等是有效的值
6. 索引设计合理，支持常用查询场景（包括按用户查询、按类型查询、有效期查询）
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新 updated_at 字段
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-10.md` - 用户表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

