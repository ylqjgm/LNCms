# TASK002-35: 数据库设计 - 核心模块 - 票务表

## 任务信息

**任务编号**: TASK002-35  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 核心模块 - 票务表  
**版本信息**: v1.1.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计核心模块的票务表（tickets），用于存储票务物品定义信息（如打赏票、投票票等）。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

无

## 实现指南

### 1. 分析需求文档

阅读 `docs/Features/Core.md` 和 `docs/Requirements/Core.md` 文档，了解票务管理的详细需求：
- 票务管理：票务添加、票务修改、票务删除、票务状态管理
- 票务定义包含：名称、描述、获取渠道、用途、价格、获取权限、获取时间、过期时间
- 获取渠道：购买、自动获取等
- 票务用途：打赏、投票等
- 票务价格：代表票据在作者方所能替代的收益价格，若渠道为购买，同时也是购买的价格（虚拟货币单位）
- 获取权限：针对哪些用户组可以获取
- 获取时间：可为循环时间、间隔时间等

### 2. 设计票务表结构

设计 `tickets` 表，包含票务基本信息：

```sql
CREATE TABLE tickets (
    id BIGSERIAL PRIMARY KEY,
    ticket_name VARCHAR(100) NOT NULL UNIQUE,
    ticket_code VARCHAR(50) NOT NULL UNIQUE,
    ticket_description TEXT,
    acquisition_channel VARCHAR(20) NOT NULL,
    ticket_usage VARCHAR(20) NOT NULL,
    ticket_price NUMERIC(10, 2) NOT NULL DEFAULT 0.00,
    user_group_ids BIGINT[],
    acquisition_time_config JSONB,
    expires_at TIMESTAMPTZ,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT ck_tickets_acquisition_channel CHECK (acquisition_channel IN ('purchase', 'auto', 'other')),
    CONSTRAINT ck_tickets_ticket_usage CHECK (ticket_usage IN ('reward', 'vote', 'other')),
    CONSTRAINT ck_tickets_ticket_price CHECK (ticket_price >= 0)
);

-- 创建索引
CREATE UNIQUE INDEX uk_tickets_ticket_name ON tickets(ticket_name);
CREATE UNIQUE INDEX uk_tickets_ticket_code ON tickets(ticket_code);
CREATE INDEX idx_tickets_acquisition_channel ON tickets(acquisition_channel);
CREATE INDEX idx_tickets_ticket_usage ON tickets(ticket_usage);
CREATE INDEX idx_tickets_is_active ON tickets(is_active);
CREATE INDEX idx_tickets_expires_at ON tickets(expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX idx_tickets_user_group_ids ON tickets USING GIN (user_group_ids);
CREATE INDEX idx_tickets_acquisition_time_config ON tickets USING GIN (acquisition_time_config);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_tickets_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_tickets_updated_at
    BEFORE UPDATE ON tickets
    FOR EACH ROW
    EXECUTE FUNCTION update_tickets_updated_at();

-- 添加表注释
COMMENT ON TABLE tickets IS '票务表，存储票务物品定义信息（如打赏票、投票票等）';
COMMENT ON COLUMN tickets.id IS '票务ID，自增主键';
COMMENT ON COLUMN tickets.ticket_name IS '票务名称，唯一标识符';
COMMENT ON COLUMN tickets.ticket_code IS '票务代码，唯一标识符，用于系统内部识别';
COMMENT ON COLUMN tickets.ticket_description IS '票务描述，说明票务的用途和特点';
COMMENT ON COLUMN tickets.acquisition_channel IS '获取渠道：purchase-购买、auto-自动获取、other-其他';
COMMENT ON COLUMN tickets.ticket_usage IS '票务用途：reward-打赏、vote-投票、other-其他';
COMMENT ON COLUMN tickets.ticket_price IS '票务价格，虚拟货币单位，代表票据在作者方所能替代的收益价格，若渠道为购买，同时也是购买的价格';
COMMENT ON COLUMN tickets.user_group_ids IS '获取权限，用户组ID数组，针对哪些用户组可以获取，NULL表示所有用户组都可以获取';
COMMENT ON COLUMN tickets.acquisition_time_config IS '获取时间配置，JSON格式，可为循环时间、间隔时间等（如：{"type":"interval","value":86400}表示每24小时获取一次）';
COMMENT ON COLUMN tickets.expires_at IS '过期时间，NULL表示永久有效，TIMESTAMP表示过期时间';
COMMENT ON COLUMN tickets.is_active IS '是否启用，TRUE-启用，FALSE-禁用';
COMMENT ON COLUMN tickets.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN tickets.updated_at IS '更新时间，每次更新时自动更新';
```

### 3. 设计约束

- **主键约束**：`pk_tickets` (id)
- **唯一约束**：`uk_tickets_ticket_name` (ticket_name)、`uk_tickets_ticket_code` (ticket_code)
- **检查约束**：
  - `ck_tickets_acquisition_channel` (acquisition_channel) - 确保获取渠道是预定义的值（purchase、auto、other）
  - `ck_tickets_ticket_usage` (ticket_usage) - 确保票务用途是预定义的值（reward、vote、other）
  - `ck_tickets_ticket_price` (ticket_price) - 确保价格大于等于0
- **非空约束**：ticket_name、ticket_code、acquisition_channel、ticket_usage、ticket_price 必须非空
- **默认值**：ticket_price 默认为 0.00，is_active 默认为 TRUE
- **可选字段**：ticket_description、user_group_ids、acquisition_time_config、expires_at 可为空

### 4. 设计索引

- **主键索引**：`pk_tickets` (id) - 自动创建
- **唯一索引**：`uk_tickets_ticket_name` (ticket_name) - 确保票务名称唯一
- **唯一索引**：`uk_tickets_ticket_code` (ticket_code) - 确保票务代码唯一
- **普通索引**：`idx_tickets_acquisition_channel` (acquisition_channel) - 用于按获取渠道筛选
- **普通索引**：`idx_tickets_ticket_usage` (ticket_usage) - 用于按用途筛选
- **普通索引**：`idx_tickets_is_active` (is_active) - 用于状态筛选
- **部分索引**：`idx_tickets_expires_at` (expires_at) - 用于查询过期票务，仅索引非空值
- **GIN 索引**：`idx_tickets_user_group_ids` (user_group_ids) - 用于数组字段的快速查询
- **GIN 索引**：`idx_tickets_acquisition_time_config` (acquisition_time_config) - 用于 JSONB 配置字段的快速查询

### 5. 考虑性能优化

- 为 ticket_name 和 ticket_code 创建唯一索引，支持快速查询和唯一性检查
- 为 acquisition_channel 创建索引，支持按获取渠道筛选查询
- 为 ticket_usage 创建索引，支持按用途筛选查询
- 为 is_active 创建索引，支持状态筛选查询
- 为 expires_at 创建部分索引（仅索引非空值），支持查询过期票务
- 为 user_group_ids 创建 GIN 索引，支持数组字段的高效查询和过滤
- 为 acquisition_time_config 创建 GIN 索引，支持 JSONB 配置字段的高效查询
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段（名称、描述、获取渠道、用途、价格、获取权限、获取时间、过期时间）
2. 所有字段都有适当的类型、约束和默认值
3. 唯一约束正确，确保票务名称和票务代码唯一
4. 检查约束正确，确保获取渠道、票务用途是预定义的值，价格大于等于0
5. 获取渠道枚举值正确：purchase（购买）、auto（自动获取）、other（其他）
6. 票务用途枚举值正确：reward（打赏）、vote（投票）、other（其他）
7. 获取权限使用数组类型存储用户组ID，支持多个用户组
8. 获取时间使用 JSONB 类型存储配置，支持灵活的获取时间规则
9. 索引设计合理，支持常用查询场景（包括按渠道查询、按用途查询、过期时间查询、数组和JSONB字段查询）
10. 表注释和字段注释完整，使用中文
11. 触发器正确创建，自动更新 updated_at 字段
12. 表设计符合 PostgreSQL 数据库设计规范
13. 表设计符合功能概述中的票务管理需求（包含名称、描述、获取渠道、用途、价格、获取权限、获取时间、过期时间等字段）

## 相关文件

- `docs/Features/Core.md` - 核心模块功能概述文档（8.3 票务管理）
- `docs/Requirements/Core.md` - 核心模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.1  
**最后更新**: 2026-01-03 08:32:04 CST

