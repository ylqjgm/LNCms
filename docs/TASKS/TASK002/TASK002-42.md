# TASK002-42: 数据库设计 - 存储模块 - 上传记录表

## 任务信息

**任务编号**: TASK002-42  
**父任务**: TASK002  
**任务名称**: 数据库设计 - 存储模块 - 上传记录表  
**版本信息**: v1.0.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-02 22:13:54 CST

## 任务描述

设计存储模块的上传记录表（upload_records），用于存储文件上传记录信息。必须遵循 PostgreSQL 数据库设计规范，包含完整的字段定义、约束、索引、注释等。

## 依赖任务

TASK002-42（文件表）

## 实现指南

### 1. 分析需求文档

阅读 `docs/Requirements/Storage.md` 文档，了解文件上传的详细需求：
- 文件上传：支持小文件上传和分片上传
- 上传记录：记录上传ID、上传状态、上传进度等信息
- 上传完成后关联文件表

### 2. 设计上传记录表结构

设计 `upload_records` 表，包含上传记录基本信息：

```sql
CREATE TABLE upload_records (
    id BIGSERIAL PRIMARY KEY,
    upload_id VARCHAR(64) NOT NULL UNIQUE,
    file_id BIGINT,
    file_name VARCHAR(255) NOT NULL,
    file_size BIGINT NOT NULL,
    file_hash VARCHAR(64) NOT NULL,
    upload_type VARCHAR(20) NOT NULL,
    upload_status VARCHAR(20) NOT NULL DEFAULT 'pending',
    chunk_count INTEGER DEFAULT 0,
    uploaded_chunks INTEGER DEFAULT 0,
    upload_progress DECIMAL(5, 2) DEFAULT 0.00,
    error_message TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMPTZ,
    CONSTRAINT fk_upload_records_file_id FOREIGN KEY (file_id) REFERENCES files(id) ON DELETE SET NULL,
    CONSTRAINT ck_upload_records_file_size CHECK (file_size > 0),
    CONSTRAINT ck_upload_records_upload_type CHECK (upload_type IN ('small', 'chunk')),
    CONSTRAINT ck_upload_records_upload_status CHECK (upload_status IN ('pending', 'uploading', 'merging', 'validating', 'transcoding', 'completed', 'failed', 'cancelled')),
    CONSTRAINT ck_upload_records_chunk_count CHECK (chunk_count >= 0),
    CONSTRAINT ck_upload_records_uploaded_chunks CHECK (uploaded_chunks >= 0 AND uploaded_chunks <= chunk_count),
    CONSTRAINT ck_upload_records_upload_progress CHECK (upload_progress >= 0 AND upload_progress <= 100)
);

-- 创建索引
CREATE UNIQUE INDEX uk_upload_records_upload_id ON upload_records(upload_id);
CREATE INDEX idx_upload_records_file_id ON upload_records(file_id);
CREATE INDEX idx_upload_records_file_hash ON upload_records(file_hash);
CREATE INDEX idx_upload_records_upload_type ON upload_records(upload_type);
CREATE INDEX idx_upload_records_upload_status ON upload_records(upload_status);
CREATE INDEX idx_upload_records_created_at ON upload_records(created_at);
CREATE INDEX idx_upload_records_upload_status_created ON upload_records(upload_status, created_at);

-- 创建触发器自动更新 updated_at
CREATE OR REPLACE FUNCTION update_upload_records_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_upload_records_updated_at
    BEFORE UPDATE ON upload_records
    FOR EACH ROW
    EXECUTE FUNCTION update_upload_records_updated_at();

-- 添加表注释
COMMENT ON TABLE upload_records IS '上传记录表，存储文件上传记录信息';
COMMENT ON COLUMN upload_records.id IS '记录ID，自增主键';
COMMENT ON COLUMN upload_records.upload_id IS '上传ID，唯一标识符，用于系统内部识别';
COMMENT ON COLUMN upload_records.file_id IS '文件ID，外键关联files表，上传完成后关联';
COMMENT ON COLUMN upload_records.file_name IS '文件名，原始文件名';
COMMENT ON COLUMN upload_records.file_size IS '文件大小，单位：字节，必须大于0';
COMMENT ON COLUMN upload_records.file_hash IS '文件哈希值，SHA256格式，64字符，用于文件去重';
COMMENT ON COLUMN upload_records.upload_type IS '上传类型：small-小文件上传、chunk-分片上传';
COMMENT ON COLUMN upload_records.upload_status IS '上传状态：pending-待上传、uploading-上传中、merging-合并中、validating-校验中、transcoding-转码中、completed-已完成、failed-失败、cancelled-已取消';
COMMENT ON COLUMN upload_records.chunk_count IS '分片数量，仅分片上传有效，大于等于0';
COMMENT ON COLUMN upload_records.uploaded_chunks IS '已上传分片数量，仅分片上传有效，大于等于0且小于等于分片数量';
COMMENT ON COLUMN upload_records.upload_progress IS '上传进度，单位：百分比，范围0-100';
COMMENT ON COLUMN upload_records.error_message IS '错误消息，上传失败时的错误信息';
COMMENT ON COLUMN upload_records.created_at IS '创建时间，自动设置为当前时间';
COMMENT ON COLUMN upload_records.updated_at IS '更新时间，每次更新时自动更新';
COMMENT ON COLUMN upload_records.completed_at IS '完成时间，上传完成时的时间';
```

### 3. 设计约束

- **主键约束**：`pk_upload_records` (id)
- **外键约束**：`fk_upload_records_file_id` (file_id) 关联 files(id)，删除时设置为 NULL
- **唯一约束**：`uk_upload_records_upload_id` (upload_id)
- **检查约束**：`ck_upload_records_file_size` (file_size) - 确保文件大小大于0
- **检查约束**：`ck_upload_records_upload_type` (upload_type) - 确保上传类型是预定义的值
- **检查约束**：`ck_upload_records_upload_status` (upload_status) - 确保上传状态是预定义的值
- **检查约束**：`ck_upload_records_chunk_count` (chunk_count) - 确保分片数量大于等于0
- **检查约束**：`ck_upload_records_uploaded_chunks` (uploaded_chunks) - 确保已上传分片数量在有效范围内
- **检查约束**：`ck_upload_records_upload_progress` (upload_progress) - 确保上传进度在0-100之间
- **非空约束**：upload_id、file_name、file_size、file_hash、upload_type、upload_status 必须非空
- **默认值**：upload_type 默认为 'small'，upload_status 默认为 'pending'，chunk_count、uploaded_chunks 默认为 0，upload_progress 默认为 0.00
- **可选字段**：file_id、error_message、completed_at 可为 NULL

### 4. 设计索引

- **主键索引**：`pk_upload_records` (id) - 自动创建
- **唯一索引**：`uk_upload_records_upload_id` (upload_id) - 确保上传ID唯一
- **外键索引**：`idx_upload_records_file_id` (file_id) - 用于关联查询
- **普通索引**：`idx_upload_records_file_hash` (file_hash) - 用于文件去重查询
- **普通索引**：`idx_upload_records_upload_type` (upload_type) - 用于按上传类型筛选
- **普通索引**：`idx_upload_records_upload_status` (upload_status) - 用于按上传状态筛选
- **普通索引**：`idx_upload_records_created_at` (created_at) - 用于按创建时间排序
- **复合索引**：`idx_upload_records_upload_status_created` (upload_status, created_at) - 用于查询特定状态的上传记录并按时间排序

### 5. 考虑性能优化

- 为 upload_id 创建唯一索引，支持快速查询和唯一性检查
- 为 file_hash 创建索引，支持文件去重查询
- 为 upload_type 和 upload_status 创建索引，支持按类型和状态筛选查询
- 为 created_at 创建索引，支持时间排序查询
- 使用复合索引优化常用查询场景（如查询特定状态的上传记录并按时间排序）
- 使用触发器自动更新 updated_at 字段

## 验收标准

1. 表结构设计完整，包含所有必要字段
2. 所有字段都有适当的类型、约束和默认值
3. 外键约束正确，关联 files 表
4. 唯一约束正确，确保上传ID唯一
5. 检查约束正确，确保文件大小、上传类型、上传状态、分片数量、上传进度等是有效的值
6. 索引设计合理，支持常用查询场景（包括按上传ID查询、按文件哈希查询、按上传状态查询）
7. 表注释和字段注释完整，使用中文
8. 触发器正确创建，自动更新 updated_at 字段
9. 表设计符合 PostgreSQL 数据库设计规范

## 相关文件

- `docs/Requirements/Storage.md` - 存储模块需求文档
- `.cursor/rules/database.mdc` - PostgreSQL 数据库设计规范
- `docs/TASKS/TASK002/TASK002.md` - 主任务文档
- `docs/TASKS/TASK002/TASK002-42.md` - 文件表设计文档

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-02 22:13:54 CST

