# TASK006-24: 创建AuthorHandler接口和实现 - 作者审核、奖励和惩罚API

## 任务信息

**任务编号**: TASK006-24  
**父任务**: TASK006  
**任务名称**: 创建AuthorHandler接口和实现 - 作者审核、奖励和惩罚API  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

扩展作者控制器，提供作者审核、奖励和惩罚的HTTP API处理。包括：1) 扩展AuthorHandler接口（ApproveAuthor、RejectAuthor、RewardAuthor、PunishAuthor方法）；2) 实现ApproveAuthor方法（处理PUT /api/v1/authors/{id}/approve请求）；3) 实现RejectAuthor方法（处理PUT /api/v1/authors/{id}/reject请求，可选）；4) 实现RewardAuthor方法（处理PUT /api/v1/authors/{id}/reward请求）；5) 实现PunishAuthor方法（处理PUT /api/v1/authors/{id}/punish请求）；6) 调用AuthorService；7) 格式化响应（Envelope格式）。所有代码必须遵循API设计规范。参考TASK005-25用户审核和密码管理API实现。

## 依赖任务

TASK006-23（创建AuthorHandler接口和实现 - 作者封禁管理API）、TASK006-15（创建AuthorService接口和实现 - 审核、奖励和惩罚）

## 实现指南

### 1. 扩展AuthorHandler接口

在 `internal/handler/author_handler.go` 文件中，扩展AuthorHandler接口：

```go
// AuthorHandler 作者控制器接口（扩展）
type AuthorHandler interface {
    Register(c *gin.Context)
    Login(c *gin.Context)
    Logout(c *gin.Context)
    GetAuthors(c *gin.Context)
    GetAuthor(c *gin.Context)
    CreateAuthor(c *gin.Context)
    UpdateAuthor(c *gin.Context)
    UpdateAuthorStatus(c *gin.Context)
    BanAuthor(c *gin.Context)
    UnbanAuthor(c *gin.Context)
    
    // ApproveAuthor 审核通过作者
    // PUT /api/v1/authors/{id}/approve
    ApproveAuthor(c *gin.Context)
    
    // RejectAuthor 审核拒绝作者
    // PUT /api/v1/authors/{id}/reject
    RejectAuthor(c *gin.Context)
    
    // RewardAuthor 奖励作者
    // PUT /api/v1/authors/{id}/reward
    RewardAuthor(c *gin.Context)
    
    // PunishAuthor 惩罚作者
    // PUT /api/v1/authors/{id}/punish
    PunishAuthor(c *gin.Context)
}
```

### 2. 实现ApproveAuthor方法

在authorHandler实现中添加ApproveAuthor方法：

```go
// ApproveAuthor 审核通过作者
// @Summary 审核通过作者
// @Description 管理员审核通过作者，激活作者账号
// @Tags 作者管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "作者ID"
// @Success 200 {object} response.Envelope
// @Failure 400 {object} response.Envelope
// @Failure 404 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/authors/{id}/approve [put]
func (h *authorHandler) ApproveAuthor(c *gin.Context) {
    // 1. 获取路径参数
    authorID, err := strconv.ParseInt(c.Param("id"), 10, 64)
    if err != nil {
        response.BadRequest(c, "无效的作者ID", err)
        return
    }
    
    // 2. 调用AuthorService.ApproveAuthor
    if err := h.authorService.ApproveAuthor(c.Request.Context(), authorID); err != nil {
        if strings.Contains(err.Error(), "不存在") {
            response.NotFound(c, err.Error(), nil)
            return
        }
        if strings.Contains(err.Error(), "已经激活") {
            response.Conflict(c, err.Error(), nil)
            return
        }
        response.InternalServerError(c, "审核通过失败", err)
        return
    }
    
    // 3. 格式化响应（Envelope格式）
    response.Success(c, http.StatusOK, map[string]string{
        "message": "作者审核通过",
    })
}
```

### 3. 实现RejectAuthor方法

在authorHandler实现中添加RejectAuthor方法：

```go
// RejectAuthor 审核拒绝作者
// @Summary 审核拒绝作者
// @Description 管理员审核拒绝作者，可以添加拒绝原因
// @Tags 作者管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "作者ID"
// @Param request body dto.RejectAuthorRequest true "拒绝请求"
// @Success 200 {object} response.Envelope
// @Failure 400 {object} response.Envelope
// @Failure 404 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/authors/{id}/reject [put]
func (h *authorHandler) RejectAuthor(c *gin.Context) {
    // 1. 获取路径参数
    authorID, err := strconv.ParseInt(c.Param("id"), 10, 64)
    if err != nil {
        response.BadRequest(c, "无效的作者ID", err)
        return
    }
    
    // 2. 绑定请求参数
    var req dto.RejectAuthorRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BadRequest(c, "请求参数错误", err)
        return
    }
    
    // 3. 调用AuthorService.RejectAuthor
    if err := h.authorService.RejectAuthor(c.Request.Context(), authorID, req.Reason); err != nil {
        if strings.Contains(err.Error(), "不存在") {
            response.NotFound(c, err.Error(), nil)
            return
        }
        if strings.Contains(err.Error(), "已经激活") {
            response.Conflict(c, err.Error(), nil)
            return
        }
        response.InternalServerError(c, "审核拒绝失败", err)
        return
    }
    
    // 4. 格式化响应（Envelope格式）
    response.Success(c, http.StatusOK, map[string]string{
        "message": "作者审核已拒绝",
    })
}
```

### 4. 实现RewardAuthor方法

在authorHandler实现中添加RewardAuthor方法：

```go
// RewardAuthor 奖励作者
// @Summary 奖励作者
// @Description 管理员奖励作者，支持积分、货币、等级提升等奖励类型
// @Tags 作者管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "作者ID"
// @Param request body dto.RewardAuthorRequest true "奖励请求"
// @Success 200 {object} response.Envelope
// @Failure 400 {object} response.Envelope
// @Failure 404 {object} response.Envelope
// @Failure 422 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/authors/{id}/reward [put]
func (h *authorHandler) RewardAuthor(c *gin.Context) {
    // 1. 获取路径参数
    authorID, err := strconv.ParseInt(c.Param("id"), 10, 64)
    if err != nil {
        response.BadRequest(c, "无效的作者ID", err)
        return
    }
    
    // 2. 绑定请求参数
    var req dto.RewardAuthorRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BadRequest(c, "请求参数错误", err)
        return
    }
    
    // 3. 调用AuthorService.RewardAuthor
    if err := h.authorService.RewardAuthor(c.Request.Context(), authorID, &req); err != nil {
        if strings.Contains(err.Error(), "不存在") {
            response.NotFound(c, err.Error(), nil)
            return
        }
        if strings.Contains(err.Error(), "不支持的奖励类型") {
            response.UnprocessableEntity(c, err.Error(), nil)
            return
        }
        response.InternalServerError(c, "奖励作者失败", err)
        return
    }
    
    // 4. 格式化响应（Envelope格式）
    response.Success(c, http.StatusOK, map[string]string{
        "message": "作者奖励成功",
    })
}
```

### 5. 实现PunishAuthor方法

在authorHandler实现中添加PunishAuthor方法：

```go
// PunishAuthor 惩罚作者
// @Summary 惩罚作者
// @Description 管理员惩罚作者，支持扣除积分、降低等级、封禁等惩罚类型
// @Tags 作者管理
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "作者ID"
// @Param request body dto.PunishAuthorRequest true "惩罚请求"
// @Success 200 {object} response.Envelope
// @Failure 400 {object} response.Envelope
// @Failure 404 {object} response.Envelope
// @Failure 422 {object} response.Envelope
// @Failure 500 {object} response.Envelope
// @Router /api/v1/authors/{id}/punish [put]
func (h *authorHandler) PunishAuthor(c *gin.Context) {
    // 1. 获取路径参数
    authorID, err := strconv.ParseInt(c.Param("id"), 10, 64)
    if err != nil {
        response.BadRequest(c, "无效的作者ID", err)
        return
    }
    
    // 2. 绑定请求参数
    var req dto.PunishAuthorRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.BadRequest(c, "请求参数错误", err)
        return
    }
    
    // 3. 调用AuthorService.PunishAuthor
    if err := h.authorService.PunishAuthor(c.Request.Context(), authorID, &req); err != nil {
        if strings.Contains(err.Error(), "不存在") {
            response.NotFound(c, err.Error(), nil)
            return
        }
        if strings.Contains(err.Error(), "不支持的惩罚类型") {
            response.UnprocessableEntity(c, err.Error(), nil)
            return
        }
        response.InternalServerError(c, "惩罚作者失败", err)
        return
    }
    
    // 4. 格式化响应（Envelope格式）
    response.Success(c, http.StatusOK, map[string]string{
        "message": "作者惩罚成功",
    })
}
```

### 6. 注意事项

- **权限控制**：所有操作都需要管理员权限
- **请求验证**：验证请求参数
- **错误处理**：根据错误类型返回合适的HTTP状态码
- **响应格式**：使用Envelope格式返回响应

## 验收标准

1. **接口扩展完整**
   - AuthorHandler接口包含ApproveAuthor、RejectAuthor、RewardAuthor、PunishAuthor方法
   - 方法签名正确

2. **实现完整**
   - 所有方法都正确实现
   - 错误处理完善
   - 响应格式正确

3. **API规范**
   - 遵循OpenAPI 3.1.1规范
   - 使用Envelope响应格式

4. **代码规范**
   - 遵循Golang编码规范
   - 遵循API设计规范

## 相关文件

- `internal/handler/author_handler.go` - AuthorHandler接口和实现文件（需要扩展）
- `docs/TASKS/TASK005/TASK005-25.md` - 用户审核和密码管理API实现参考
- `.cursor/rules/api-design.mdc` - API设计规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

