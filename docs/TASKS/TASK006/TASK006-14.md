# TASK006-14: 创建AuthorService接口和实现 - 状态和封禁管理

## 任务信息

**任务编号**: TASK006-14  
**父任务**: TASK006  
**任务名称**: 创建AuthorService接口和实现 - 状态和封禁管理  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

扩展作者服务，提供作者状态管理和封禁管理功能。包括：1) 扩展AuthorService接口（UpdateStatus、BanAuthor、UnbanAuthor方法）；2) 实现状态更新（激活/禁用作者）；3) 实现作者封禁（设置is_locked为true，可以添加封禁原因和封禁期限）；4) 实现作者解封。所有代码必须遵循Golang编码规范，错误消息使用中文。参考TASK005-15用户状态和封禁管理实现。

## 依赖任务

TASK006-13（创建AuthorService接口和实现 - 基础CRUD）

## 实现指南

### 1. 扩展AuthorService接口

在 `internal/service/author_service.go` 文件中，扩展AuthorService接口：

```go
// AuthorService 作者服务接口（扩展）
// 提供作者管理的CRUD功能、状态管理和封禁管理
type AuthorService interface {
    // 基础CRUD方法（已存在）
    GetAuthor(ctx context.Context, authorID int64) (*dto.AuthorInfo, error)
    GetAuthors(ctx context.Context, params *dto.AuthorQueryParams) (*dto.AuthorListResponse, error)
    CreateAuthor(ctx context.Context, req *dto.CreateAuthorRequest) (*dto.AuthorInfo, error)
    UpdateAuthor(ctx context.Context, authorID int64, req *dto.UpdateAuthorRequest) (*dto.AuthorInfo, error)
    DeleteAuthor(ctx context.Context, authorID int64) error
    
    // 状态和封禁管理方法（新增）
    // UpdateStatus 更新作者状态（激活/禁用）
    UpdateStatus(ctx context.Context, authorID int64, isActive bool) error
    
    // BanAuthor 封禁作者
    // reason: 封禁原因
    // duration: 封禁期限（可选，nil表示永久封禁）
    BanAuthor(ctx context.Context, authorID int64, reason string, duration *time.Duration) error
    
    // UnbanAuthor 解封作者
    UnbanAuthor(ctx context.Context, authorID int64) error
}
```

### 2. 定义封禁相关DTO

在 `internal/dto/author_dto.go` 文件中，添加封禁相关的DTO：

```go
// BanAuthorRequest 封禁作者请求
type BanAuthorRequest struct {
    Reason   string         `json:"reason" binding:"required"`   // 封禁原因
    Duration *time.Duration `json:"duration,omitempty"`          // 封禁期限（可选，nil表示永久封禁）
}
```

### 3. 实现UpdateStatus方法

在authorService实现中添加UpdateStatus方法：

```go
// UpdateStatus 更新作者状态（激活/禁用）
func (s *authorService) UpdateStatus(ctx context.Context, authorID int64, isActive bool) error {
    // 检查作者是否存在
    author, err := s.authorRepo.GetByID(ctx, authorID)
    if err != nil {
        return err
    }
    
    // 更新状态
    if err := s.authorRepo.UpdateStatus(ctx, authorID, isActive); err != nil {
        return fmt.Errorf("更新作者状态失败: %w", err)
    }
    
    // 记录操作日志（可选）
    log.Printf("作者 %d 状态已更新为: %v", authorID, isActive)
    
    return nil
}
```

### 4. 实现BanAuthor方法

在authorService实现中添加BanAuthor方法：

```go
// BanAuthor 封禁作者
func (s *authorService) BanAuthor(ctx context.Context, authorID int64, reason string, duration *time.Duration) error {
    // 检查作者是否存在
    author, err := s.authorRepo.GetByID(ctx, authorID)
    if err != nil {
        return err
    }
    
    // 检查作者是否已被封禁
    if author.IsLocked {
        return fmt.Errorf("作者已被封禁")
    }
    
    // 更新作者状态为锁定
    author.IsLocked = true
    if err := s.authorRepo.Update(ctx, author); err != nil {
        return fmt.Errorf("封禁作者失败: %w", err)
    }
    
    // 如果有封禁期限，可以在这里实现定时解封逻辑
    // 例如：使用定时任务或Redis过期键
    if duration != nil {
        // 记录封禁到期时间（可以在数据库中存储，或使用Redis）
        // 这里暂时省略，后续可以扩展
        log.Printf("作者 %d 被封禁，原因: %s，期限: %v", authorID, reason, *duration)
    } else {
        log.Printf("作者 %d 被永久封禁，原因: %s", authorID, reason)
    }
    
    return nil
}
```

### 5. 实现UnbanAuthor方法

在authorService实现中添加UnbanAuthor方法：

```go
// UnbanAuthor 解封作者
func (s *authorService) UnbanAuthor(ctx context.Context, authorID int64) error {
    // 检查作者是否存在
    author, err := s.authorRepo.GetByID(ctx, authorID)
    if err != nil {
        return err
    }
    
    // 检查作者是否已被封禁
    if !author.IsLocked {
        return fmt.Errorf("作者未被封禁")
    }
    
    // 更新作者状态为未锁定
    author.IsLocked = false
    if err := s.authorRepo.Update(ctx, author); err != nil {
        return fmt.Errorf("解封作者失败: %w", err)
    }
    
    log.Printf("作者 %d 已解封", authorID)
    
    return nil
}
```

### 6. 添加必要的导入

```go
package service

import (
    "context"
    "fmt"
    "log"
    "time"
    
    "yourproject/internal/dto"
    "yourproject/internal/repository"
)
```

### 7. 注意事项

- **状态检查**：封禁前检查作者是否已被封禁，解封前检查作者是否被封禁
- **封禁原因**：记录封禁原因，便于后续查询和审计
- **封禁期限**：支持永久封禁和临时封禁，临时封禁需要实现定时解封逻辑
- **错误处理**：所有错误消息必须使用中文
- **操作日志**：记录状态变更和封禁操作日志（可选）

## 验收标准

1. **接口扩展完整**
   - AuthorService接口包含UpdateStatus、BanAuthor、UnbanAuthor方法
   - 方法签名正确

2. **DTO定义完整**
   - BanAuthorRequest结构体定义完整

3. **实现完整**
   - UpdateStatus方法正确实现
   - BanAuthor方法正确实现
   - UnbanAuthor方法正确实现
   - 状态检查逻辑正确

4. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文

5. **代码规范**
   - 遵循Golang编码规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/author_service.go` - AuthorService接口和实现文件（需要扩展）
- `internal/dto/author_dto.go` - 作者DTO文件（需要扩展）
- `docs/TASKS/TASK005/TASK005-15.md` - 用户状态和封禁管理实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

