# TASK006-05: 实现AuthorSessionRepository接口和实现

## 任务信息

**任务编号**: TASK006-05  
**父任务**: TASK006  
**任务名称**: 实现AuthorSessionRepository接口和实现  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

实现AuthorSessionRepository接口，提供作者会话数据的存储和查询操作。包括：1) 定义AuthorSessionRepository接口（Create、GetByToken、BlacklistToken、IsBlacklisted、DeleteExpired等方法）；2) 实现AuthorSessionRepository接口（可以使用数据库或Redis）；3) 实现token黑名单管理。所有代码必须遵循Golang编码规范。参考TASK005-05会话仓储层实现。

## 依赖任务

TASK006-02（创建AuthorSession模型）

## 实现指南

### 1. 定义AuthorSessionRepository接口

在 `internal/repository/` 目录下创建 `author_session_repository.go` 文件，定义AuthorSessionRepository接口：

```go
package repository

import (
    "context"
    "time"
    "yourproject/internal/models"
)

// AuthorSessionRepository 作者会话仓储接口
// 提供作者会话数据的存储和查询操作，支持token黑名单管理
type AuthorSessionRepository interface {
    // Create 创建会话
    Create(ctx context.Context, session *models.AuthorSession) error
    
    // GetByToken 根据token获取会话
    GetByToken(ctx context.Context, token string) (*models.AuthorSession, error)
    
    // GetByAuthorID 根据作者ID获取会话列表
    GetByAuthorID(ctx context.Context, authorID int64, limit int) ([]*models.AuthorSession, error)
    
    // BlacklistToken 将token加入黑名单
    BlacklistToken(ctx context.Context, token string) error
    
    // IsBlacklisted 检查token是否在黑名单中
    IsBlacklisted(ctx context.Context, token string) (bool, error)
    
    // DeleteExpired 删除过期的会话
    DeleteExpired(ctx context.Context) error
    
    // DeleteByAuthorID 删除作者的所有会话
    DeleteByAuthorID(ctx context.Context, authorID int64) error
    
    // DeleteByToken 删除指定token的会话
    DeleteByToken(ctx context.Context, token string) error
}
```

### 2. 实现AuthorSessionRepository接口（数据库实现）

在同一个文件中实现AuthorSessionRepository接口，使用GORM进行数据库操作：

```go
// authorSessionRepository AuthorSessionRepository的实现（数据库）
type authorSessionRepository struct {
    db *gorm.DB
}

// NewAuthorSessionRepository 创建AuthorSessionRepository实例
func NewAuthorSessionRepository(db *gorm.DB) AuthorSessionRepository {
    return &authorSessionRepository{db: db}
}

// Create 创建会话
func (r *authorSessionRepository) Create(ctx context.Context, session *models.AuthorSession) error {
    if err := r.db.WithContext(ctx).Create(session).Error; err != nil {
        if errors.Is(err, gorm.ErrDuplicatedKey) {
            return fmt.Errorf("会话已存在：token已被使用")
        }
        return fmt.Errorf("创建会话失败: %w", err)
    }
    return nil
}

// GetByToken 根据token获取会话
func (r *authorSessionRepository) GetByToken(ctx context.Context, token string) (*models.AuthorSession, error) {
    var session models.AuthorSession
    if err := r.db.WithContext(ctx).Where("token = ?", token).First(&session).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, fmt.Errorf("会话不存在")
        }
        return nil, fmt.Errorf("查询会话失败: %w", err)
    }
    return &session, nil
}

// GetByAuthorID 根据作者ID获取会话列表
func (r *authorSessionRepository) GetByAuthorID(ctx context.Context, authorID int64, limit int) ([]*models.AuthorSession, error) {
    var sessions []*models.AuthorSession
    query := r.db.WithContext(ctx).Where("author_id = ?", authorID).
        Order("created_at DESC")
    
    if limit > 0 {
        if limit > 100 {
            limit = 100
        }
        query = query.Limit(limit)
    }
    
    if err := query.Find(&sessions).Error; err != nil {
        return nil, fmt.Errorf("查询作者会话列表失败: %w", err)
    }
    return sessions, nil
}

// BlacklistToken 将token加入黑名单
func (r *authorSessionRepository) BlacklistToken(ctx context.Context, token string) error {
    now := time.Now()
    result := r.db.WithContext(ctx).Model(&models.AuthorSession{}).
        Where("token = ?", token).
        Updates(map[string]interface{}{
            "is_blacklisted": true,
            "blacklisted_at": now,
        })
    if result.Error != nil {
        return fmt.Errorf("将token加入黑名单失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("会话不存在")
    }
    return nil
}

// IsBlacklisted 检查token是否在黑名单中
func (r *authorSessionRepository) IsBlacklisted(ctx context.Context, token string) (bool, error) {
    var session models.AuthorSession
    if err := r.db.WithContext(ctx).
        Where("token = ? AND is_blacklisted = ?", token, true).
        First(&session).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return false, nil
        }
        return false, fmt.Errorf("检查token黑名单状态失败: %w", err)
    }
    return true, nil
}

// DeleteExpired 删除过期的会话
func (r *authorSessionRepository) DeleteExpired(ctx context.Context) error {
    now := time.Now()
    result := r.db.WithContext(ctx).
        Where("expires_at < ?", now).
        Delete(&models.AuthorSession{})
    if result.Error != nil {
        return fmt.Errorf("删除过期会话失败: %w", result.Error)
    }
    return nil
}

// DeleteByAuthorID 删除作者的所有会话
func (r *authorSessionRepository) DeleteByAuthorID(ctx context.Context, authorID int64) error {
    result := r.db.WithContext(ctx).
        Where("author_id = ?", authorID).
        Delete(&models.AuthorSession{})
    if result.Error != nil {
        return fmt.Errorf("删除作者会话失败: %w", result.Error)
    }
    return nil
}

// DeleteByToken 删除指定token的会话
func (r *authorSessionRepository) DeleteByToken(ctx context.Context, token string) error {
    result := r.db.WithContext(ctx).
        Where("token = ?", token).
        Delete(&models.AuthorSession{})
    if result.Error != nil {
        return fmt.Errorf("删除会话失败: %w", result.Error)
    }
    if result.RowsAffected == 0 {
        return fmt.Errorf("会话不存在")
    }
    return nil
}
```

### 3. 可选：Redis实现（高级功能）

如果需要使用Redis实现AuthorSessionRepository以提高性能，可以创建另一个实现。实现方式与TASK005-05类似，但使用AuthorSession模型和author_id字段。

### 4. 添加必要的导入

```go
package repository

import (
    "context"
    "errors"
    "fmt"
    "time"
    
    "gorm.io/gorm"
    "yourproject/internal/models"
)
```

### 5. 注意事项

- **实现选择**：根据项目需求选择数据库实现或Redis实现，或两者结合
- **错误处理**：所有错误消息必须使用中文
- **上下文传递**：所有方法都接受context.Context参数
- **黑名单机制**：使用is_blacklisted字段标记黑名单，支持快速查询
- **过期清理**：定期调用DeleteExpired方法清理过期会话
- **性能优化**：如果使用Redis，可以提高查询性能，但需要处理数据一致性
- **错误包装**：使用fmt.Errorf和%w动词包装错误

## 验收标准

1. **接口定义完整**
   - AuthorSessionRepository接口包含所有必需方法
   - 方法签名正确，参数和返回值类型正确

2. **实现完整**
   - 所有接口方法都已实现
   - 实现逻辑正确，符合业务需求
   - 错误处理完善，错误消息使用中文

3. **黑名单功能**
   - BlacklistToken方法正确实现
   - IsBlacklisted方法正确实现
   - 黑名单状态正确更新

4. **查询功能**
   - GetByToken方法正确实现
   - GetByAuthorID方法支持限制数量
   - 查询逻辑正确

5. **清理功能**
   - DeleteExpired方法正确实现
   - DeleteByAuthorID方法正确实现
   - DeleteByToken方法正确实现

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 注释完整，使用中文

## 相关文件

- `internal/models/author_session.go` - AuthorSession模型文件
- `docs/TASKS/TASK005/TASK005-05.md` - 会话仓储层实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `internal/repository/author_session_repository.go` - AuthorSessionRepository接口和实现文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

