# TASK006-01: 创建Author模型

## 任务信息

**任务编号**: TASK006-01  
**父任务**: TASK006  
**任务名称**: 创建Author模型  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

创建作者管理的GORM模型，定义作者表结构。包括：1) 创建Author模型，定义字段（基于TASK002-13的authors表设计，包含author_name、email、phone、password_hash、email_verified、phone_verified、is_active、is_locked、author_type_ids数组、author_level_id、user_id等）；2) 添加模型标签和索引定义；3) 添加表注释和字段注释。所有代码必须遵循Golang编码规范和PostgreSQL数据库设计规范。参考TASK002-13数据库设计任务和TASK005-01用户模型实现。

## 依赖任务

无

## 实现指南

### 1. 参考数据库设计文档

阅读 `docs/TASKS/TASK002/TASK002-13.md` 文档，了解authors表的完整设计：
- 表结构：id、author_name、email、phone、password_hash、email_verified、phone_verified、is_active、is_locked、author_type_ids（数组）、author_level_id、user_id、created_at、updated_at、last_login_at
- 外键关联：author_level_id 关联 author_levels 表、user_id 关联 users 表
- 唯一约束：author_name、email 必须唯一
- 索引：author_name、email、phone、author_level_id、user_id、is_active、is_locked、author_type_ids（GIN索引）

### 2. 创建Author模型文件

在 `internal/models/` 目录下创建 `author.go` 文件，定义Author模型：

```go
package models

import (
    "time"
    "github.com/lib/pq"
    "gorm.io/gorm"
)

// Author 作者模型
// 存储作者基本信息和认证信息，包括作者名、邮箱、密码哈希、状态信息等
// 关联作者等级、用户等信息
type Author struct {
    ID            int64          `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    AuthorName    string         `gorm:"column:author_name;type:VARCHAR(100);not null;uniqueIndex:uk_authors_author_name" json:"author_name"`
    Email         string         `gorm:"column:email;type:VARCHAR(100);not null;uniqueIndex:uk_authors_email" json:"email"`
    Phone         *string        `gorm:"column:phone;type:VARCHAR(20);index:idx_authors_phone" json:"phone,omitempty"`
    PasswordHash  string         `gorm:"column:password_hash;type:VARCHAR(255);not null" json:"-"`
    EmailVerified bool           `gorm:"column:email_verified;type:BOOLEAN;default:false" json:"email_verified"`
    PhoneVerified bool           `gorm:"column:phone_verified;type:BOOLEAN;default:false" json:"phone_verified"`
    IsActive      bool           `gorm:"column:is_active;type:BOOLEAN;default:true;index:idx_authors_is_active" json:"is_active"`
    IsLocked      bool           `gorm:"column:is_locked;type:BOOLEAN;default:false;index:idx_authors_is_locked" json:"is_locked"`
    AuthorTypeIDs pq.Int32Array  `gorm:"column:author_type_ids;type:INTEGER[];not null;default:'{}'" json:"author_type_ids"`
    AuthorLevelID *int64         `gorm:"column:author_level_id;type:BIGINT;index:idx_authors_author_level_id" json:"author_level_id,omitempty"`
    UserID        *int64         `gorm:"column:user_id;type:BIGINT;index:idx_authors_user_id" json:"user_id,omitempty"`
    CreatedAt     time.Time      `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    UpdatedAt     time.Time      `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    LastLoginAt   *time.Time     `gorm:"column:last_login_at;type:TIMESTAMPTZ" json:"last_login_at,omitempty"`
    
    // 关联关系
    AuthorLevel *AuthorLevel `gorm:"foreignKey:AuthorLevelID;references:ID" json:"author_level,omitempty"`
    User        *User        `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
}

// TableName 指定表名
func (Author) TableName() string {
    return "authors"
}

// BeforeCreate 创建前钩子
func (a *Author) BeforeCreate(tx *gorm.DB) error {
    now := time.Now()
    if a.CreatedAt.IsZero() {
        a.CreatedAt = now
    }
    if a.UpdatedAt.IsZero() {
        a.UpdatedAt = now
    }
    return nil
}

// BeforeUpdate 更新前钩子
func (a *Author) BeforeUpdate(tx *gorm.DB) error {
    a.UpdatedAt = time.Now()
    return nil
}
```

### 3. 添加模型注释

在模型文件中添加详细的中文注释，说明每个字段的用途：

```go
// Author 作者模型
// 存储作者基本信息和认证信息，包括作者名、邮箱、密码哈希、状态信息等
// 关联作者等级、用户等信息
// author_type_ids使用PostgreSQL数组类型，支持一个作者拥有多个类型
type Author struct {
    // ID 作者ID，自增主键
    ID int64 `gorm:"primaryKey;column:id;type:BIGSERIAL" json:"id"`
    
    // AuthorName 作者名称，唯一标识符，用于登录
    AuthorName string `gorm:"column:author_name;type:VARCHAR(100);not null;uniqueIndex:uk_authors_author_name" json:"author_name"`
    
    // Email 邮箱地址，唯一标识符，用于登录和通知
    Email string `gorm:"column:email;type:VARCHAR(100);not null;uniqueIndex:uk_authors_email" json:"email"`
    
    // Phone 手机号码，用于登录和通知，可选
    Phone *string `gorm:"column:phone;type:VARCHAR(20);index:idx_authors_phone" json:"phone,omitempty"`
    
    // PasswordHash 密码哈希值，使用 bcrypt 算法，不能存储明文密码
    PasswordHash string `gorm:"column:password_hash;type:VARCHAR(255);not null" json:"-"`
    
    // EmailVerified 邮箱是否已验证，TRUE-已验证，FALSE-未验证
    EmailVerified bool `gorm:"column:email_verified;type:BOOLEAN;default:false" json:"email_verified"`
    
    // PhoneVerified 手机号是否已验证，TRUE-已验证，FALSE-未验证
    PhoneVerified bool `gorm:"column:phone_verified;type:BOOLEAN;default:false" json:"phone_verified"`
    
    // IsActive 作者是否激活，TRUE-激活，FALSE-未激活
    IsActive bool `gorm:"column:is_active;type:BOOLEAN;default:true;index:idx_authors_is_active" json:"is_active"`
    
    // IsLocked 作者是否被锁定，TRUE-已锁定，FALSE-未锁定
    IsLocked bool `gorm:"column:is_locked;type:BOOLEAN;default:false;index:idx_authors_is_locked" json:"is_locked"`
    
    // AuthorTypeIDs 作者类型ID数组，存储作者可以创作的内容类型ID
    // 引用author_types表的id字段，使用PostgreSQL数组类型
    // 支持一个作者拥有多个类型（如：小说作者、漫画作者等）
    AuthorTypeIDs pq.Int32Array `gorm:"column:author_type_ids;type:INTEGER[];not null;default:'{}'" json:"author_type_ids"`
    
    // AuthorLevelID 作者等级ID，外键关联author_levels表
    AuthorLevelID *int64 `gorm:"column:author_level_id;type:BIGINT;index:idx_authors_author_level_id" json:"author_level_id,omitempty"`
    
    // UserID 用户ID，外键关联users表，用于关联用户和作者（如果作者和用户是同一人）
    // 可以为NULL，支持作者和用户是不同实体
    UserID *int64 `gorm:"column:user_id;type:BIGINT;index:idx_authors_user_id" json:"user_id,omitempty"`
    
    // CreatedAt 创建时间，自动设置为当前时间
    CreatedAt time.Time `gorm:"column:created_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"created_at"`
    
    // UpdatedAt 更新时间，每次更新时自动更新
    UpdatedAt time.Time `gorm:"column:updated_at;type:TIMESTAMPTZ;default:CURRENT_TIMESTAMP" json:"updated_at"`
    
    // LastLoginAt 最后登录时间
    LastLoginAt *time.Time `gorm:"column:last_login_at;type:TIMESTAMPTZ" json:"last_login_at,omitempty"`
    
    // 关联关系
    AuthorLevel *AuthorLevel `gorm:"foreignKey:AuthorLevelID;references:ID" json:"author_level,omitempty"`
    User        *User        `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
}
```

### 4. 定义模型方法

为Author模型添加常用的辅助方法：

```go
// IsValid 检查作者是否有效（激活且未锁定）
func (a *Author) IsValid() bool {
    return a.IsActive && !a.IsLocked
}

// CanLogin 检查作者是否可以登录
func (a *Author) CanLogin() bool {
    return a.IsValid() && a.EmailVerified
}

// UpdateLastLogin 更新最后登录时间
func (a *Author) UpdateLastLogin() {
    now := time.Now()
    a.LastLoginAt = &now
}

// HasAuthorType 检查作者是否拥有指定类型
func (a *Author) HasAuthorType(typeID int32) bool {
    for _, id := range a.AuthorTypeIDs {
        if id == typeID {
            return true
        }
    }
    return false
}

// AddAuthorType 添加作者类型
func (a *Author) AddAuthorType(typeID int32) {
    if !a.HasAuthorType(typeID) {
        a.AuthorTypeIDs = append(a.AuthorTypeIDs, typeID)
    }
}

// RemoveAuthorType 移除作者类型
func (a *Author) RemoveAuthorType(typeID int32) {
    var newTypes pq.Int32Array
    for _, id := range a.AuthorTypeIDs {
        if id != typeID {
            newTypes = append(newTypes, id)
        }
    }
    a.AuthorTypeIDs = newTypes
}
```

### 5. 注意事项

- **字段类型映射**：确保GORM标签中的类型与PostgreSQL数据库类型一致
- **数组类型处理**：author_type_ids使用pq.Int32Array类型，需要导入github.com/lib/pq包
- **索引定义**：在GORM标签中定义索引，包括唯一索引和普通索引
- **外键关联**：使用GORM的foreignKey和references标签定义关联关系
- **JSON标签**：PasswordHash字段使用 `json:"-"` 避免序列化到JSON响应中
- **指针类型**：可选字段（如Phone、AuthorLevelID、UserID等）使用指针类型，支持NULL值
- **时间字段**：使用time.Time类型，支持PostgreSQL的TIMESTAMPTZ类型
- **默认值**：在GORM标签中设置默认值，与数据库设计保持一致
- **数组默认值**：author_type_ids默认值为空数组'{}'

## 验收标准

1. **模型结构完整**
   - Author模型包含所有必需字段
   - 字段类型与数据库设计一致
   - GORM标签正确配置

2. **索引定义正确**
   - 唯一索引：author_name、email
   - 普通索引：phone、author_level_id、user_id、is_active、is_locked
   - 索引名称与数据库设计一致

3. **关联关系正确**
   - AuthorLevel关联关系正确
   - User关联关系正确

4. **数组类型处理正确**
   - author_type_ids使用pq.Int32Array类型
   - 数组操作方法实现正确

5. **模型方法完整**
   - IsValid方法实现正确
   - CanLogin方法实现正确
   - UpdateLastLogin方法实现正确
   - HasAuthorType方法实现正确
   - AddAuthorType方法实现正确
   - RemoveAuthorType方法实现正确

6. **注释完整**
   - 模型注释使用中文
   - 字段注释使用中文
   - 方法注释使用中文

7. **代码规范**
   - 遵循Golang编码规范
   - 遵循GORM最佳实践
   - 错误消息使用中文（如适用）

## 相关文件

- `docs/TASKS/TASK002/TASK002-13.md` - 作者表数据库设计文档
- `docs/TASKS/TASK005/TASK005-01.md` - 用户模型实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/database.mdc` - PostgreSQL数据库设计规范
- `internal/models/author.go` - Author模型文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

