# TASK006-10: 创建AuthService扩展 - 作者登录和登出

## 任务信息

**任务编号**: TASK006-10  
**父任务**: TASK006  
**任务名称**: 创建AuthService扩展 - 作者登录和登出  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

扩展TASK005-11实现的AuthService，提供作者登录和登出功能。包括：1) 扩展AuthService接口（AuthorLogin、AuthorLogout方法）；2) 实现作者登录逻辑（验证作者名/邮箱和密码、生成JWT token、记录登录日志、更新最后登录时间）；3) 实现作者登出逻辑（将token加入黑名单）。所有代码必须遵循Golang编码规范，错误消息使用中文。参考TASK005-11认证服务实现。

## 依赖任务

TASK006-04（实现AuthorRepository接口和实现）、TASK006-07（复用PasswordService）、TASK006-08（扩展JWTService支持作者token）

## 实现指南

### 1. 扩展AuthService接口

在 `internal/service/auth_service.go` 文件中，扩展AuthService接口：

```go
package service

import (
    "context"
    "yourproject/internal/dto"
)

// AuthService 认证服务接口（扩展）
// 提供用户和作者登录、登出功能
type AuthService interface {
    // 用户认证方法（已存在）
    Login(ctx context.Context, req *dto.LoginRequest) (*dto.LoginResponse, error)
    Logout(ctx context.Context, token string) error
    
    // 作者认证方法（新增）
    // AuthorLogin 作者登录
    // 支持作者名或邮箱登录
    // 返回作者信息和token对
    AuthorLogin(ctx context.Context, req *dto.AuthorLoginRequest) (*dto.AuthorLoginResponse, error)
    
    // AuthorLogout 作者登出
    // 将token加入黑名单
    AuthorLogout(ctx context.Context, token string) error
}
```

### 2. 定义作者登录DTO

在 `internal/dto/` 目录下创建或扩展 `auth_dto.go` 文件，定义作者登录请求和响应DTO：

```go
package dto

import (
    "time"
    "github.com/lib/pq"
    "yourproject/internal/models"
)

// AuthorLoginRequest 作者登录请求
type AuthorLoginRequest struct {
    AuthorNameOrEmail string `json:"author_name_or_email" binding:"required"` // 作者名或邮箱
    Password          string `json:"password" binding:"required"`               // 密码
    IPAddress         string `json:"ip_address,omitempty"`                      // IP地址
    UserAgent         string `json:"user_agent,omitempty"`                      // 用户代理
}

// AuthorLoginResponse 作者登录响应
type AuthorLoginResponse struct {
    Author      *AuthorInfo `json:"author"`        // 作者信息
    AccessToken string      `json:"access_token"`  // Access token
    RefreshToken string     `json:"refresh_token"` // Refresh token
    ExpiresAt   time.Time  `json:"expires_at"`    // Token过期时间
}

// AuthorInfo 作者信息（登录响应中使用）
type AuthorInfo struct {
    ID            int64         `json:"id"`
    AuthorName    string        `json:"author_name"`
    Email         string        `json:"email"`
    Phone         *string       `json:"phone,omitempty"`
    EmailVerified bool         `json:"email_verified"`
    PhoneVerified bool         `json:"phone_verified"`
    IsActive      bool         `json:"is_active"`
    IsLocked      bool         `json:"is_locked"`
    AuthorTypeIDs pq.Int32Array `json:"author_type_ids"`
    AuthorLevelID *int64       `json:"author_level_id,omitempty"`
    UserID        *int64       `json:"user_id,omitempty"`
    CreatedAt     time.Time    `json:"created_at"`
    LastLoginAt   *time.Time   `json:"last_login_at,omitempty"`
}

// ToAuthorInfo 将Author模型转换为AuthorInfo
func ToAuthorInfo(author *models.Author) *AuthorInfo {
    return &AuthorInfo{
        ID:            author.ID,
        AuthorName:    author.AuthorName,
        Email:         author.Email,
        Phone:         author.Phone,
        EmailVerified: author.EmailVerified,
        PhoneVerified: author.PhoneVerified,
        IsActive:      author.IsActive,
        IsLocked:      author.IsLocked,
        AuthorTypeIDs: author.AuthorTypeIDs,
        AuthorLevelID: author.AuthorLevelID,
        UserID:        author.UserID,
        CreatedAt:     author.CreatedAt,
        LastLoginAt:   author.LastLoginAt,
    }
}
```

### 3. 实现AuthorLogin方法

在authService实现中添加AuthorLogin方法：

```go
// AuthorLogin 作者登录
func (s *authService) AuthorLogin(ctx context.Context, req *dto.AuthorLoginRequest) (*dto.AuthorLoginResponse, error) {
    // 1. 根据作者名或邮箱查找作者
    var author *models.Author
    var err error
    
    // 判断是作者名还是邮箱
    if strings.Contains(req.AuthorNameOrEmail, "@") {
        author, err = s.authorRepo.GetByEmail(ctx, req.AuthorNameOrEmail)
    } else {
        author, err = s.authorRepo.GetByAuthorName(ctx, req.AuthorNameOrEmail)
    }
    
    if err != nil {
        return nil, fmt.Errorf("作者不存在或密码错误")
    }
    
    // 2. 检查作者状态
    if !author.IsActive {
        // 记录登录失败日志
        s.recordAuthorLoginLog(ctx, author.ID, req.IPAddress, req.UserAgent, false, "作者未激活")
        return nil, fmt.Errorf("作者未激活，无法登录")
    }
    
    if author.IsLocked {
        // 记录登录失败日志
        s.recordAuthorLoginLog(ctx, author.ID, req.IPAddress, req.UserAgent, false, "作者已锁定")
        return nil, fmt.Errorf("作者已被锁定，无法登录")
    }
    
    if !author.EmailVerified {
        // 记录登录失败日志
        s.recordAuthorLoginLog(ctx, author.ID, req.IPAddress, req.UserAgent, false, "邮箱未验证")
        return nil, fmt.Errorf("邮箱未验证，请先验证邮箱")
    }
    
    // 3. 验证密码
    if !s.passwordService.VerifyPassword(author.PasswordHash, req.Password) {
        // 记录登录失败日志
        s.recordAuthorLoginLog(ctx, author.ID, req.IPAddress, req.UserAgent, false, "密码错误")
        return nil, fmt.Errorf("作者不存在或密码错误")
    }
    
    // 4. 生成JWT token
    tokenPair, err := s.jwtService.GenerateAuthorToken(
        author.ID,
        author.AuthorName,
        author.AuthorTypeIDs,
        author.AuthorLevelID,
        author.UserID,
    )
    if err != nil {
        return nil, fmt.Errorf("生成token失败: %w", err)
    }
    
    // 5. 更新最后登录时间
    if err := s.authorRepo.UpdateLastLoginAt(ctx, author.ID); err != nil {
        // 记录错误但不影响登录流程
        log.Printf("更新作者最后登录时间失败: %v", err)
    }
    
    // 6. 记录登录成功日志
    s.recordAuthorLoginLog(ctx, author.ID, req.IPAddress, req.UserAgent, true, "")
    
    // 7. 返回响应
    return &dto.AuthorLoginResponse{
        Author:       dto.ToAuthorInfo(author),
        AccessToken:  tokenPair.AccessToken,
        RefreshToken: tokenPair.RefreshToken,
        ExpiresAt:    tokenPair.ExpiresAt,
    }, nil
}

// recordAuthorLoginLog 记录作者登录日志
func (s *authService) recordAuthorLoginLog(ctx context.Context, authorID int64, ipAddress, userAgent string, success bool, failureReason string) {
    log := &models.AuthorLoginLog{
        AuthorID:  &authorID,
        IPAddress: ipAddress,
        UserAgent: userAgent,
        Status:    models.LoginStatusSuccess,
    }
    
    if !success {
        log.Status = models.LoginStatusFailed
        log.FailureReason = &failureReason
    }
    
    // 异步记录日志，不阻塞登录流程
    go func() {
        if err := s.authorLoginLogRepo.Create(context.Background(), log); err != nil {
            log.Printf("记录作者登录日志失败: %v", err)
        }
    }()
}
```

### 4. 实现AuthorLogout方法

在authService实现中添加AuthorLogout方法：

```go
// AuthorLogout 作者登出
func (s *authService) AuthorLogout(ctx context.Context, token string) error {
    // 将token加入黑名单
    if err := s.jwtService.BlacklistToken(token); err != nil {
        return fmt.Errorf("登出失败: %w", err)
    }
    
    return nil
}
```

### 5. 扩展authService结构体

在authService结构体中添加作者相关的依赖：

```go
// authService AuthService的实现
type authService struct {
    userRepo          repository.UserRepository
    authorRepo        repository.AuthorRepository          // 新增
    passwordService   PasswordService
    jwtService        JWTService
    loginLogRepo      repository.LoginLogRepository
    authorLoginLogRepo repository.AuthorLoginLogRepository // 新增
}

// NewAuthService 创建AuthService实例（扩展）
func NewAuthService(
    userRepo repository.UserRepository,
    authorRepo repository.AuthorRepository, // 新增参数
    passwordService PasswordService,
    jwtService JWTService,
    loginLogRepo repository.LoginLogRepository,
    authorLoginLogRepo repository.AuthorLoginLogRepository, // 新增参数
) AuthService {
    return &authService{
        userRepo:          userRepo,
        authorRepo:        authorRepo,
        passwordService: passwordService,
        jwtService:        jwtService,
        loginLogRepo:      loginLogRepo,
        authorLoginLogRepo: authorLoginLogRepo,
    }
}
```

### 6. 添加必要的导入

```go
package service

import (
    "context"
    "fmt"
    "log"
    "strings"
    
    "yourproject/internal/dto"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 7. 注意事项

- **错误处理**：所有错误消息必须使用中文
- **状态检查**：登录前检查作者状态（激活、锁定、邮箱验证）
- **密码验证**：使用PasswordService验证密码
- **Token生成**：使用JWTService生成作者token
- **登录日志**：记录登录成功和失败的日志
- **异步日志**：登录日志记录使用异步方式，不阻塞登录流程
- **最后登录时间**：登录成功后更新最后登录时间

## 验收标准

1. **接口扩展完整**
   - AuthService接口包含AuthorLogin和AuthorLogout方法
   - 方法签名正确

2. **DTO定义完整**
   - AuthorLoginRequest结构体定义完整
   - AuthorLoginResponse结构体定义完整
   - AuthorInfo结构体定义完整
   - ToAuthorInfo转换函数正确

3. **实现完整**
   - AuthorLogin方法正确实现
   - AuthorLogout方法正确实现
   - 状态检查逻辑正确
   - 密码验证逻辑正确
   - Token生成逻辑正确
   - 登录日志记录正确

4. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文

5. **代码规范**
   - 遵循Golang编码规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/auth_service.go` - AuthService接口和实现文件（需要扩展）
- `internal/dto/auth_dto.go` - 认证DTO文件（需要扩展）
- `docs/TASKS/TASK005/TASK005-11.md` - 认证服务实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

