# TASK006-16: 编写AuthorService单元测试

## 任务信息

**任务编号**: TASK006-16  
**父任务**: TASK006  
**任务名称**: 编写AuthorService单元测试  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

编写作者服务单元测试。包括：1) 测试所有CRUD方法；2) 测试状态管理和封禁管理功能；3) 测试审核、奖励、惩罚功能；4) 使用Mock Repository和Service进行测试；5) 确保测试覆盖率达标。所有测试用例描述必须使用中文。参考TASK005-17用户服务单元测试。

## 依赖任务

TASK006-15（创建AuthorService接口和实现 - 审核、奖励和惩罚）

## 实现指南

### 1. 创建测试文件

在 `internal/service/` 目录下创建 `author_service_test.go` 文件。

### 2. 设置测试依赖

```go
package service

import (
    "context"
    "testing"
    
    "github.com/lib/pq"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/require"
    
    "yourproject/internal/dto"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 3. 定义Mock结构

```go
// MockAuthorRepository Mock AuthorRepository
type MockAuthorRepository struct {
    mock.Mock
}

func (m *MockAuthorRepository) GetByID(ctx context.Context, id int64) (*models.Author, error) {
    args := m.Called(ctx, id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*models.Author), args.Error(1)
}

func (m *MockAuthorRepository) GetAll(ctx context.Context, params *repository.AuthorQueryParams) ([]*models.Author, int64, error) {
    args := m.Called(ctx, params)
    return args.Get(0).([]*models.Author), args.Get(1).(int64), args.Error(2)
}

func (m *MockAuthorRepository) Create(ctx context.Context, author *models.Author) error {
    args := m.Called(ctx, author)
    return args.Error(0)
}

func (m *MockAuthorRepository) Update(ctx context.Context, author *models.Author) error {
    args := m.Called(ctx, author)
    return args.Error(0)
}

func (m *MockAuthorRepository) Delete(ctx context.Context, id int64) error {
    args := m.Called(ctx, id)
    return args.Error(0)
}

func (m *MockAuthorRepository) UpdateStatus(ctx context.Context, id int64, isActive bool) error {
    args := m.Called(ctx, id, isActive)
    return args.Error(0)
}

func (m *MockAuthorRepository) ExistsByAuthorName(ctx context.Context, authorName string) (bool, error) {
    args := m.Called(ctx, authorName)
    return args.Bool(0), args.Error(1)
}

func (m *MockAuthorRepository) ExistsByEmail(ctx context.Context, email string) (bool, error) {
    args := m.Called(ctx, email)
    return args.Bool(0), args.Error(1)
}

func (m *MockAuthorRepository) ExistsByPhone(ctx context.Context, phone string) (bool, error) {
    args := m.Called(ctx, phone)
    return args.Bool(0), args.Error(1)
}

// MockPasswordService Mock PasswordService
type MockPasswordService struct {
    mock.Mock
}

func (m *MockPasswordService) HashPassword(password string) (string, error) {
    args := m.Called(password)
    return args.String(0), args.Error(1)
}

func (m *MockPasswordService) VerifyPassword(hashedPassword, password string) bool {
    args := m.Called(hashedPassword, password)
    return args.Bool(0)
}

func (m *MockPasswordService) ValidatePasswordStrength(password string) error {
    args := m.Called(password)
    return args.Error(0)
}
```

### 4. 测试GetAuthor方法

```go
// TestAuthorService_GetAuthor 测试获取作者
func TestAuthorService_GetAuthor(t *testing.T) {
    mockAuthorRepo := new(MockAuthorRepository)
    mockPasswordService := new(MockPasswordService)
    service := NewAuthorService(mockAuthorRepo, mockPasswordService)
    
    author := &models.Author{
        ID:            1,
        AuthorName:    "testauthor",
        Email:         "test@example.com",
        AuthorTypeIDs: pq.Int32Array{1, 2},
    }
    
    mockAuthorRepo.On("GetByID", mock.Anything, int64(1)).Return(author, nil)
    
    result, err := service.GetAuthor(context.Background(), 1)
    
    require.NoError(t, err)
    assert.NotNil(t, result)
    assert.Equal(t, int64(1), result.ID)
    assert.Equal(t, "testauthor", result.AuthorName)
}
```

### 5. 测试GetAuthors方法

```go
// TestAuthorService_GetAuthors 测试获取作者列表
func TestAuthorService_GetAuthors(t *testing.T) {
    mockAuthorRepo := new(MockAuthorRepository)
    mockPasswordService := new(MockPasswordService)
    service := NewAuthorService(mockAuthorRepo, mockPasswordService)
    
    authors := []*models.Author{
        {ID: 1, AuthorName: "author1", Email: "author1@example.com"},
        {ID: 2, AuthorName: "author2", Email: "author2@example.com"},
    }
    
    params := &dto.AuthorQueryParams{
        Page:  1,
        Limit: 20,
    }
    
    repoParams := &repository.AuthorQueryParams{
        Page:  1,
        Limit: 20,
    }
    
    mockAuthorRepo.On("GetAll", mock.Anything, repoParams).Return(authors, int64(2), nil)
    
    result, err := service.GetAuthors(context.Background(), params)
    
    require.NoError(t, err)
    assert.NotNil(t, result)
    assert.Len(t, result.Authors, 2)
    assert.Equal(t, int64(2), result.Total)
}
```

### 6. 测试CreateAuthor方法

```go
// TestAuthorService_CreateAuthor 测试创建作者
func TestAuthorService_CreateAuthor(t *testing.T) {
    tests := []struct {
        name    string
        req     *dto.CreateAuthorRequest
        setup   func(*MockAuthorRepository, *MockPasswordService)
        wantErr bool
        errMsg  string
    }{
        {
            name: "正常创建作者",
            req: &dto.CreateAuthorRequest{
                AuthorName:    "newauthor",
                Email:         "new@example.com",
                Password:      "password123",
                AuthorTypeIDs: []int32{1},
            },
            setup: func(authorRepo *MockAuthorRepository, passwordService *MockPasswordService) {
                authorRepo.On("ExistsByAuthorName", mock.Anything, "newauthor").Return(false, nil)
                authorRepo.On("ExistsByEmail", mock.Anything, "new@example.com").Return(false, nil)
                passwordService.On("ValidatePasswordStrength", "password123").Return(nil)
                passwordService.On("HashPassword", "password123").Return("hashed_password", nil)
                authorRepo.On("Create", mock.Anything, mock.Anything).Return(nil)
            },
            wantErr: false,
        },
        {
            name: "重复作者名",
            req: &dto.CreateAuthorRequest{
                AuthorName:    "existingauthor",
                Email:         "new@example.com",
                Password:      "password123",
                AuthorTypeIDs: []int32{1},
            },
            setup: func(authorRepo *MockAuthorRepository, passwordService *MockPasswordService) {
                authorRepo.On("ExistsByAuthorName", mock.Anything, "existingauthor").Return(true, nil)
            },
            wantErr: true,
            errMsg:  "作者名已被使用",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockAuthorRepo := new(MockAuthorRepository)
            mockPasswordService := new(MockPasswordService)
            service := NewAuthorService(mockAuthorRepo, mockPasswordService)
            
            if tt.setup != nil {
                tt.setup(mockAuthorRepo, mockPasswordService)
            }
            
            result, err := service.CreateAuthor(context.Background(), tt.req)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
                assert.Nil(t, result)
            } else {
                require.NoError(t, err)
                assert.NotNil(t, result)
            }
        })
    }
}
```

### 7. 测试UpdateStatus、BanAuthor、UnbanAuthor方法

```go
// TestAuthorService_UpdateStatus 测试更新作者状态
func TestAuthorService_UpdateStatus(t *testing.T) {
    mockAuthorRepo := new(MockAuthorRepository)
    mockPasswordService := new(MockPasswordService)
    service := NewAuthorService(mockAuthorRepo, mockPasswordService)
    
    author := &models.Author{ID: 1, IsActive: false}
    mockAuthorRepo.On("GetByID", mock.Anything, int64(1)).Return(author, nil)
    mockAuthorRepo.On("UpdateStatus", mock.Anything, int64(1), true).Return(nil)
    
    err := service.UpdateStatus(context.Background(), 1, true)
    require.NoError(t, err)
}

// TestAuthorService_BanAuthor 测试封禁作者
func TestAuthorService_BanAuthor(t *testing.T) {
    mockAuthorRepo := new(MockAuthorRepository)
    mockPasswordService := new(MockPasswordService)
    service := NewAuthorService(mockAuthorRepo, mockPasswordService)
    
    author := &models.Author{ID: 1, IsLocked: false}
    mockAuthorRepo.On("GetByID", mock.Anything, int64(1)).Return(author, nil)
    mockAuthorRepo.On("Update", mock.Anything, mock.Anything).Return(nil)
    
    err := service.BanAuthor(context.Background(), 1, "违规行为", nil)
    require.NoError(t, err)
}

// TestAuthorService_UnbanAuthor 测试解封作者
func TestAuthorService_UnbanAuthor(t *testing.T) {
    mockAuthorRepo := new(MockAuthorRepository)
    mockPasswordService := new(MockPasswordService)
    service := NewAuthorService(mockAuthorRepo, mockPasswordService)
    
    author := &models.Author{ID: 1, IsLocked: true}
    mockAuthorRepo.On("GetByID", mock.Anything, int64(1)).Return(author, nil)
    mockAuthorRepo.On("Update", mock.Anything, mock.Anything).Return(nil)
    
    err := service.UnbanAuthor(context.Background(), 1)
    require.NoError(t, err)
}
```

### 8. 测试ApproveAuthor、RejectAuthor、RewardAuthor、PunishAuthor方法

```go
// TestAuthorService_ApproveAuthor 测试审核通过作者
func TestAuthorService_ApproveAuthor(t *testing.T) {
    mockAuthorRepo := new(MockAuthorRepository)
    mockPasswordService := new(MockPasswordService)
    service := NewAuthorService(mockAuthorRepo, mockPasswordService)
    
    author := &models.Author{ID: 1, IsActive: false}
    mockAuthorRepo.On("GetByID", mock.Anything, int64(1)).Return(author, nil)
    mockAuthorRepo.On("UpdateStatus", mock.Anything, int64(1), true).Return(nil)
    
    err := service.ApproveAuthor(context.Background(), 1)
    require.NoError(t, err)
}

// TestAuthorService_RewardAuthor 测试奖励作者
func TestAuthorService_RewardAuthor(t *testing.T) {
    mockAuthorRepo := new(MockAuthorRepository)
    mockPasswordService := new(MockPasswordService)
    service := NewAuthorService(mockAuthorRepo, mockPasswordService)
    
    author := &models.Author{ID: 1}
    mockAuthorRepo.On("GetByID", mock.Anything, int64(1)).Return(author, nil)
    
    req := &dto.RewardAuthorRequest{
        Type:        "points",
        Amount:      100,
        Description: "优秀作品奖励",
    }
    
    err := service.RewardAuthor(context.Background(), 1, req)
    require.NoError(t, err)
}
```

### 9. 注意事项

- **Mock使用**：使用Mock Repository和Service进行测试，避免依赖真实数据库
- **测试覆盖**：确保测试覆盖所有方法
- **边界情况**：测试各种错误场景和边界情况
- **测试描述**：所有测试用例名称使用中文

## 验收标准

1. **测试覆盖完整**
   - 所有AuthorService方法都有测试用例
   - 测试覆盖正常情况、边界情况、异常情况

2. **测试覆盖率**
   - 测试覆盖率达到80%以上
   - 使用go test -cover检查覆盖率

3. **测试描述**
   - 所有测试用例名称使用中文
   - 错误消息使用中文

4. **代码规范**
   - 遵循Golang测试规范
   - 使用testify进行断言
   - 使用Mock进行依赖隔离

## 相关文件

- `internal/service/author_service.go` - AuthorService接口和实现文件
- `docs/TASKS/TASK005/TASK005-17.md` - 用户服务单元测试参考
- `.cursor/rules/testing.mdc` - Golang单元测试规范
- `internal/service/author_service_test.go` - AuthorService单元测试文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

