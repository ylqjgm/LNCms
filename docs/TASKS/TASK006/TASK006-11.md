# TASK006-11: 创建AuthService扩展 - 作者注册

## 任务信息

**任务编号**: TASK006-11  
**父任务**: TASK006  
**任务名称**: 创建AuthService扩展 - 作者注册  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

扩展TASK005-12实现的AuthService，提供作者注册功能。包括：1) 扩展AuthService接口（AuthorRegister方法）；2) 实现注册逻辑（验证注册配置、验证作者名和邮箱唯一性、验证密码强度、创建作者、生成JWT token、分配注册积分等）。所有代码必须遵循Golang编码规范，错误消息使用中文。参考TASK005-12用户注册实现。

## 依赖任务

TASK006-10（创建AuthService扩展 - 作者登录和登出）、TASK006-07（复用PasswordService）

## 实现指南

### 1. 扩展AuthService接口

在 `internal/service/auth_service.go` 文件中，扩展AuthService接口：

```go
// AuthService 认证服务接口（扩展）
// 提供用户和作者注册、登录、登出功能
type AuthService interface {
    // 用户认证方法（已存在）
    Register(ctx context.Context, req *dto.RegisterRequest) (*dto.RegisterResponse, error)
    Login(ctx context.Context, req *dto.LoginRequest) (*dto.LoginResponse, error)
    Logout(ctx context.Context, token string) error
    
    // 作者认证方法（已存在）
    AuthorLogin(ctx context.Context, req *dto.AuthorLoginRequest) (*dto.AuthorLoginResponse, error)
    AuthorLogout(ctx context.Context, token string) error
    
    // 作者注册方法（新增）
    // AuthorRegister 作者注册
    // 验证注册配置、验证作者名和邮箱唯一性、验证密码强度、创建作者、生成JWT token
    AuthorRegister(ctx context.Context, req *dto.AuthorRegisterRequest) (*dto.AuthorRegisterResponse, error)
}
```

### 2. 定义作者注册DTO

在 `internal/dto/auth_dto.go` 文件中，添加作者注册相关的DTO：

```go
// AuthorRegisterRequest 作者注册请求
type AuthorRegisterRequest struct {
    AuthorName    string   `json:"author_name" binding:"required,min=3,max=100"` // 作者名
    Email         string   `json:"email" binding:"required,email"`                // 邮箱
    Phone         string   `json:"phone,omitempty" binding:"omitempty"`           // 手机号（可选）
    Password      string   `json:"password" binding:"required,min=8"`              // 密码
    AuthorTypeIDs []int32  `json:"author_type_ids" binding:"required,min=1"`     // 作者类型ID数组
    UserID        *int64   `json:"user_id,omitempty"`                             // 关联用户ID（可选）
}

// AuthorRegisterResponse 作者注册响应
type AuthorRegisterResponse struct {
    Author       *AuthorInfo `json:"author"`        // 作者信息
    AccessToken  string      `json:"access_token"`  // Access token
    RefreshToken string      `json:"refresh_token"` // Refresh token
    ExpiresAt    time.Time  `json:"expires_at"`   // Token过期时间
    Message      string      `json:"message"`       // 提示消息（如需要审核）
}
```

### 3. 定义作者注册配置

在 `internal/config/` 目录下创建或扩展配置结构：

```go
// AuthorRegisterConfig 作者注册配置
type AuthorRegisterConfig struct {
    Enabled           bool    // 是否允许注册
    RequireEmailVerify bool   // 是否需要邮箱验证
    RequireApproval   bool    // 是否需要审核
    DefaultAuthorLevelID *int64 // 默认作者等级ID
    DefaultAuthorTypeIDs []int32 // 默认作者类型ID数组
    RegistrationReward int64  // 注册奖励积分（可选）
}
```

### 4. 实现AuthorRegister方法

在authService实现中添加AuthorRegister方法：

```go
// AuthorRegister 作者注册
func (s *authService) AuthorRegister(ctx context.Context, req *dto.AuthorRegisterRequest) (*dto.AuthorRegisterResponse, error) {
    // 1. 验证注册配置
    if !s.authorRegisterConfig.Enabled {
        return nil, fmt.Errorf("作者注册功能已关闭")
    }
    
    // 2. 验证作者名唯一性
    exists, err := s.authorRepo.ExistsByAuthorName(ctx, req.AuthorName)
    if err != nil {
        return nil, fmt.Errorf("检查作者名失败: %w", err)
    }
    if exists {
        return nil, fmt.Errorf("作者名已被使用")
    }
    
    // 3. 验证邮箱唯一性
    exists, err = s.authorRepo.ExistsByEmail(ctx, req.Email)
    if err != nil {
        return nil, fmt.Errorf("检查邮箱失败: %w", err)
    }
    if exists {
        return nil, fmt.Errorf("邮箱已被使用")
    }
    
    // 4. 验证手机号唯一性（如果提供）
    if req.Phone != "" {
        exists, err = s.authorRepo.ExistsByPhone(ctx, req.Phone)
        if err != nil {
            return nil, fmt.Errorf("检查手机号失败: %w", err)
        }
        if exists {
            return nil, fmt.Errorf("手机号已被使用")
        }
    }
    
    // 5. 验证密码强度
    if err := s.passwordService.ValidatePasswordStrength(req.Password); err != nil {
        return nil, fmt.Errorf("密码强度不符合要求: %w", err)
    }
    
    // 6. 验证作者类型ID（如果配置了默认类型，使用默认类型；否则使用请求中的类型）
    authorTypeIDs := req.AuthorTypeIDs
    if len(s.authorRegisterConfig.DefaultAuthorTypeIDs) > 0 {
        authorTypeIDs = s.authorRegisterConfig.DefaultAuthorTypeIDs
    }
    
    // 7. 哈希密码
    passwordHash, err := s.passwordService.HashPassword(req.Password)
    if err != nil {
        return nil, fmt.Errorf("密码加密失败: %w", err)
    }
    
    // 8. 创建作者
    author := &models.Author{
        AuthorName:    req.AuthorName,
        Email:         req.Email,
        PasswordHash:  passwordHash,
        AuthorTypeIDs: pq.Int32Array(authorTypeIDs),
        IsActive:      !s.authorRegisterConfig.RequireApproval, // 如果需要审核，则初始状态为未激活
        EmailVerified: !s.authorRegisterConfig.RequireEmailVerify, // 如果需要邮箱验证，则初始状态为未验证
        UserID:        req.UserID,
    }
    
    if req.Phone != "" {
        author.Phone = &req.Phone
    }
    
    if s.authorRegisterConfig.DefaultAuthorLevelID != nil {
        author.AuthorLevelID = s.authorRegisterConfig.DefaultAuthorLevelID
    }
    
    if err := s.authorRepo.Create(ctx, author); err != nil {
        return nil, fmt.Errorf("创建作者失败: %w", err)
    }
    
    // 9. 生成JWT token（如果不需要审核，直接生成token）
    var tokenPair *service.TokenPair
    var message string
    
    if !s.authorRegisterConfig.RequireApproval {
        tokenPair, err = s.jwtService.GenerateAuthorToken(
            author.ID,
            author.AuthorName,
            author.AuthorTypeIDs,
            author.AuthorLevelID,
            author.UserID,
        )
        if err != nil {
            return nil, fmt.Errorf("生成token失败: %w", err)
        }
    } else {
        message = "注册成功，等待管理员审核"
    }
    
    // 10. 分配注册奖励（如果配置了）
    if s.authorRegisterConfig.RegistrationReward > 0 {
        // 这里可以调用积分服务分配积分
        // 暂时省略，后续任务实现
    }
    
    // 11. 返回响应
    response := &dto.AuthorRegisterResponse{
        Author: dto.ToAuthorInfo(author),
        Message: message,
    }
    
    if tokenPair != nil {
        response.AccessToken = tokenPair.AccessToken
        response.RefreshToken = tokenPair.RefreshToken
        response.ExpiresAt = tokenPair.ExpiresAt
    }
    
    return response, nil
}
```

### 5. 扩展authService结构体

在authService结构体中添加作者注册配置：

```go
// authService AuthService的实现
type authService struct {
    userRepo            repository.UserRepository
    authorRepo          repository.AuthorRepository
    passwordService     PasswordService
    jwtService          JWTService
    loginLogRepo        repository.LoginLogRepository
    authorLoginLogRepo  repository.AuthorLoginLogRepository
    authorRegisterConfig *config.AuthorRegisterConfig // 新增
}

// NewAuthService 创建AuthService实例（扩展）
func NewAuthService(
    userRepo repository.UserRepository,
    authorRepo repository.AuthorRepository,
    passwordService PasswordService,
    jwtService JWTService,
    loginLogRepo repository.LoginLogRepository,
    authorLoginLogRepo repository.AuthorLoginLogRepository,
    authorRegisterConfig *config.AuthorRegisterConfig, // 新增参数
) AuthService {
    return &authService{
        userRepo:            userRepo,
        authorRepo:          authorRepo,
        passwordService:     passwordService,
        jwtService:          jwtService,
        loginLogRepo:        loginLogRepo,
        authorLoginLogRepo:  authorLoginLogRepo,
        authorRegisterConfig: authorRegisterConfig,
    }
}
```

### 6. 添加必要的导入

```go
package service

import (
    "context"
    "fmt"
    
    "github.com/lib/pq"
    "yourproject/internal/config"
    "yourproject/internal/dto"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 7. 注意事项

- **注册配置**：支持配置是否允许注册、是否需要审核、是否需要邮箱验证等
- **唯一性验证**：验证作者名、邮箱、手机号的唯一性
- **密码强度**：使用PasswordService验证密码强度
- **作者类型**：支持配置默认作者类型，或使用请求中的类型
- **审核机制**：如果需要审核，注册后作者状态为未激活，不生成token
- **邮箱验证**：如果需要邮箱验证，注册后邮箱状态为未验证
- **注册奖励**：支持配置注册奖励积分（可选功能）

## 验收标准

1. **接口扩展完整**
   - AuthService接口包含AuthorRegister方法
   - 方法签名正确

2. **DTO定义完整**
   - AuthorRegisterRequest结构体定义完整
   - AuthorRegisterResponse结构体定义完整

3. **配置完整**
   - AuthorRegisterConfig结构体定义完整
   - 配置项合理

4. **实现完整**
   - AuthorRegister方法正确实现
   - 唯一性验证逻辑正确
   - 密码强度验证逻辑正确
   - 作者创建逻辑正确
   - Token生成逻辑正确（根据审核配置）

5. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文

6. **代码规范**
   - 遵循Golang编码规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/auth_service.go` - AuthService接口和实现文件（需要扩展）
- `internal/dto/auth_dto.go` - 认证DTO文件（需要扩展）
- `internal/config/config.go` - 配置文件（需要扩展）
- `docs/TASKS/TASK005/TASK005-12.md` - 用户注册实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

