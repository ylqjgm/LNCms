# TASK006-08: 扩展JWTService支持作者token

## 任务信息

**任务编号**: TASK006-08  
**父任务**: TASK006  
**任务名称**: 扩展JWTService支持作者token  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

扩展TASK005-09实现的JWTService，支持作者类型的token。包括：1) 定义AuthorClaims结构体（包含author_id、author_name、author_type_ids等）；2) 扩展JWTService接口（GenerateAuthorToken、ValidateAuthorToken等方法）；3) 实现作者token生成和验证。所有代码必须遵循Golang编码规范和安全规范。参考TASK005-09 JWT服务实现。

## 依赖任务

TASK006-05（实现AuthorSessionRepository接口和实现）

## 实现指南

### 1. 定义AuthorClaims结构体

在 `internal/service/jwt_service.go` 文件中，添加AuthorClaims结构体：

```go
package service

import (
    "time"
    "github.com/lib/pq"
    "github.com/golang-jwt/jwt/v5"
)

// AuthorClaims 作者JWT Claims结构
type AuthorClaims struct {
    AuthorID     int64         `json:"author_id"`
    AuthorName   string        `json:"author_name"`
    AuthorTypeIDs pq.Int32Array `json:"author_type_ids"`
    AuthorLevelID *int64        `json:"author_level_id,omitempty"`
    UserID       *int64         `json:"user_id,omitempty"`
    jwt.RegisteredClaims
}
```

### 2. 扩展JWTService接口

在JWTService接口中添加作者token相关方法：

```go
// JWTService JWT服务接口（扩展）
// 提供token生成、验证和刷新功能，支持用户和作者两种类型
type JWTService interface {
    // 用户token方法（已存在）
    GenerateToken(userID int64, username string, roleID *int64) (*TokenPair, error)
    ValidateToken(tokenString string) (*JWTClaims, error)
    RefreshToken(refreshToken string) (*TokenPair, error)
    BlacklistToken(token string) error
    IsBlacklisted(token string) (bool, error)
    
    // 作者token方法（新增）
    // GenerateAuthorToken 生成作者JWT token
    // 返回access token和refresh token
    GenerateAuthorToken(authorID int64, authorName string, authorTypeIDs pq.Int32Array, authorLevelID *int64, userID *int64) (*TokenPair, error)
    
    // ValidateAuthorToken 验证作者JWT token
    // 返回AuthorClaims和是否有效
    ValidateAuthorToken(tokenString string) (*AuthorClaims, error)
    
    // RefreshAuthorToken 刷新作者token
    // 使用refresh token生成新的token对
    RefreshAuthorToken(refreshToken string) (*TokenPair, error)
}
```

### 3. 实现GenerateAuthorToken方法

在jwtService实现中添加GenerateAuthorToken方法：

```go
// GenerateAuthorToken 生成作者JWT token
func (s *jwtService) GenerateAuthorToken(authorID int64, authorName string, authorTypeIDs pq.Int32Array, authorLevelID *int64, userID *int64) (*TokenPair, error) {
    now := time.Now()
    
    // 生成access token
    accessClaims := AuthorClaims{
        AuthorID:     authorID,
        AuthorName:   authorName,
        AuthorTypeIDs: authorTypeIDs,
        AuthorLevelID: authorLevelID,
        UserID:       userID,
        RegisteredClaims: jwt.RegisteredClaims{
            ExpiresAt: jwt.NewNumericDate(now.Add(s.config.AccessTokenExpiry)),
            IssuedAt:  jwt.NewNumericDate(now),
            NotBefore: jwt.NewNumericDate(now),
            Issuer:    s.config.Issuer,
            Subject:   fmt.Sprintf("author:%d", authorID),
        },
    }
    
    accessToken := jwt.NewWithClaims(jwt.SigningMethodHS256, accessClaims)
    accessTokenString, err := accessToken.SignedString(s.config.SecretKey)
    if err != nil {
        return nil, fmt.Errorf("生成access token失败: %w", err)
    }
    
    // 生成refresh token
    refreshClaims := AuthorClaims{
        AuthorID:     authorID,
        AuthorName:   authorName,
        AuthorTypeIDs: authorTypeIDs,
        AuthorLevelID: authorLevelID,
        UserID:       userID,
        RegisteredClaims: jwt.RegisteredClaims{
            ExpiresAt: jwt.NewNumericDate(now.Add(s.config.RefreshTokenExpiry)),
            IssuedAt:  jwt.NewNumericDate(now),
            NotBefore: jwt.NewNumericDate(now),
            Issuer:    s.config.Issuer,
            Subject:   fmt.Sprintf("author:%d", authorID),
        },
    }
    
    refreshToken := jwt.NewWithClaims(jwt.SigningMethodHS256, refreshClaims)
    refreshTokenString, err := refreshToken.SignedString(s.config.SecretKey)
    if err != nil {
        return nil, fmt.Errorf("生成refresh token失败: %w", err)
    }
    
    // 存储会话到数据库
    expiresAt := now.Add(s.config.AccessTokenExpiry)
    session := &models.AuthorSession{
        AuthorID:  authorID,
        Token:     accessTokenString,
        TokenType: models.TokenTypeAccess,
        ExpiresAt: expiresAt,
    }
    if err := s.authorSessionRepo.Create(context.Background(), session); err != nil {
        return nil, fmt.Errorf("存储会话失败: %w", err)
    }
    
    return &TokenPair{
        AccessToken:  accessTokenString,
        RefreshToken: refreshTokenString,
        ExpiresAt:    expiresAt,
    }, nil
}
```

### 4. 实现ValidateAuthorToken方法

在jwtService实现中添加ValidateAuthorToken方法：

```go
// ValidateAuthorToken 验证作者JWT token
func (s *jwtService) ValidateAuthorToken(tokenString string) (*AuthorClaims, error) {
    // 检查token是否在黑名单中
    isBlacklisted, err := s.authorSessionRepo.IsBlacklisted(context.Background(), tokenString)
    if err != nil {
        return nil, fmt.Errorf("检查token黑名单状态失败: %w", err)
    }
    if isBlacklisted {
        return nil, fmt.Errorf("token已被加入黑名单")
    }
    
    // 解析token
    token, err := jwt.ParseWithClaims(tokenString, &AuthorClaims{}, func(token *jwt.Token) (interface{}, error) {
        if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
            return nil, fmt.Errorf("不支持的签名方法: %v", token.Header["alg"])
        }
        return s.config.SecretKey, nil
    })
    
    if err != nil {
        return nil, fmt.Errorf("解析token失败: %w", err)
    }
    
    if claims, ok := token.Claims.(*AuthorClaims); ok && token.Valid {
        // 验证Subject格式
        if !strings.HasPrefix(claims.Subject, "author:") {
            return nil, fmt.Errorf("无效的token类型：不是作者token")
        }
        return claims, nil
    }
    
    return nil, fmt.Errorf("无效的token")
}
```

### 5. 实现RefreshAuthorToken方法

在jwtService实现中添加RefreshAuthorToken方法：

```go
// RefreshAuthorToken 刷新作者token
func (s *jwtService) RefreshAuthorToken(refreshToken string) (*TokenPair, error) {
    // 验证refresh token
    claims, err := s.ValidateAuthorToken(refreshToken)
    if err != nil {
        return nil, fmt.Errorf("验证refresh token失败: %w", err)
    }
    
    // 将旧的refresh token加入黑名单
    if err := s.authorSessionRepo.BlacklistToken(context.Background(), refreshToken); err != nil {
        return nil, fmt.Errorf("将旧token加入黑名单失败: %w", err)
    }
    
    // 生成新的token对
    return s.GenerateAuthorToken(
        claims.AuthorID,
        claims.AuthorName,
        claims.AuthorTypeIDs,
        claims.AuthorLevelID,
        claims.UserID,
    )
}
```

### 6. 扩展jwtService结构体

在jwtService结构体中添加authorSessionRepo字段：

```go
// jwtService JWTService的实现
type jwtService struct {
    config            *JWTConfig
    sessionRepo       repository.SessionRepository      // 用户会话仓储
    authorSessionRepo repository.AuthorSessionRepository // 作者会话仓储（新增）
}

// NewJWTService 创建JWTService实例（扩展）
func NewJWTService(
    config *JWTConfig,
    sessionRepo repository.SessionRepository,
    authorSessionRepo repository.AuthorSessionRepository, // 新增参数
) JWTService {
    if config == nil {
        panic("JWT配置不能为空")
    }
    if sessionRepo == nil {
        panic("SessionRepository不能为空")
    }
    if authorSessionRepo == nil {
        panic("AuthorSessionRepository不能为空")
    }
    
    return &jwtService{
        config:            config,
        sessionRepo:       sessionRepo,
        authorSessionRepo: authorSessionRepo,
    }
}
```

### 7. 添加必要的导入

```go
package service

import (
    "context"
    "errors"
    "fmt"
    "strings"
    "time"
    
    "github.com/lib/pq"
    "github.com/golang-jwt/jwt/v5"
    "yourproject/internal/models"
    "yourproject/internal/repository"
)
```

### 8. 注意事项

- **Token类型区分**：通过Subject字段区分用户token和作者token（用户token: "user:123"，作者token: "author:123"）
- **Claims结构**：AuthorClaims包含author_type_ids数组，需要正确处理
- **黑名单管理**：使用AuthorSessionRepository管理作者token黑名单
- **错误处理**：所有错误消息必须使用中文
- **安全性**：使用相同的密钥和算法，确保安全性一致
- **向后兼容**：扩展接口时保持原有用户token方法不变

## 验收标准

1. **接口扩展完整**
   - AuthorClaims结构体定义正确
   - JWTService接口包含所有作者token方法
   - 方法签名正确

2. **实现完整**
   - GenerateAuthorToken方法正确实现
   - ValidateAuthorToken方法正确实现
   - RefreshAuthorToken方法正确实现
   - 黑名单管理正确集成

3. **Token类型区分**
   - 通过Subject字段正确区分用户token和作者token
   - ValidateAuthorToken验证token类型

4. **数组处理**
   - author_type_ids数组正确序列化和反序列化
   - 数组数据在Claims中正确存储

5. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文

6. **代码规范**
   - 遵循Golang编码规范
   - 遵循安全规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/jwt_service.go` - JWTService接口和实现文件（需要扩展）
- `internal/repository/author_session_repository.go` - AuthorSessionRepository接口和实现文件
- `docs/TASKS/TASK005/TASK005-09.md` - JWT服务实现参考
- `.cursor/rules/coding-standards.mdc` - Golang编码规范
- `.cursor/rules/security.mdc` - 安全开发规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

