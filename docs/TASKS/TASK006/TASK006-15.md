# TASK006-15: 创建AuthorService接口和实现 - 审核、奖励和惩罚

## 任务信息

**任务编号**: TASK006-15  
**父任务**: TASK006  
**任务名称**: 创建AuthorService接口和实现 - 审核、奖励和惩罚  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

扩展作者服务，提供作者审核、奖励和惩罚功能。包括：1) 扩展AuthorService接口（ApproveAuthor、RejectAuthor、RewardAuthor、PunishAuthor方法）；2) 实现作者审核（审核通过/拒绝）；3) 实现作者奖励（管理员奖励作者，可能涉及积分或货币操作）；4) 实现作者惩罚（管理员惩罚作者）。所有代码必须遵循Golang编码规范，错误消息使用中文。

## 依赖任务

TASK006-14（创建AuthorService接口和实现 - 状态和封禁管理）

## 实现指南

### 1. 扩展AuthorService接口

在 `internal/service/author_service.go` 文件中，扩展AuthorService接口：

```go
// AuthorService 作者服务接口（扩展）
// 提供作者管理的CRUD功能、状态管理、封禁管理、审核、奖励和惩罚功能
type AuthorService interface {
    // 基础CRUD方法（已存在）
    GetAuthor(ctx context.Context, authorID int64) (*dto.AuthorInfo, error)
    GetAuthors(ctx context.Context, params *dto.AuthorQueryParams) (*dto.AuthorListResponse, error)
    CreateAuthor(ctx context.Context, req *dto.CreateAuthorRequest) (*dto.AuthorInfo, error)
    UpdateAuthor(ctx context.Context, authorID int64, req *dto.UpdateAuthorRequest) (*dto.AuthorInfo, error)
    DeleteAuthor(ctx context.Context, authorID int64) error
    
    // 状态和封禁管理方法（已存在）
    UpdateStatus(ctx context.Context, authorID int64, isActive bool) error
    BanAuthor(ctx context.Context, authorID int64, reason string, duration *time.Duration) error
    UnbanAuthor(ctx context.Context, authorID int64) error
    
    // 审核、奖励和惩罚方法（新增）
    // ApproveAuthor 审核通过作者
    // 将作者状态设置为激活
    ApproveAuthor(ctx context.Context, authorID int64) error
    
    // RejectAuthor 审核拒绝作者
    // 可以添加拒绝原因
    RejectAuthor(ctx context.Context, authorID int64, reason string) error
    
    // RewardAuthor 奖励作者
    // 可能涉及积分或货币操作
    RewardAuthor(ctx context.Context, authorID int64, req *dto.RewardAuthorRequest) error
    
    // PunishAuthor 惩罚作者
    // 可能涉及扣除积分、降低等级等操作
    PunishAuthor(ctx context.Context, authorID int64, req *dto.PunishAuthorRequest) error
}
```

### 2. 定义审核、奖励和惩罚相关DTO

在 `internal/dto/author_dto.go` 文件中，添加相关DTO：

```go
// RejectAuthorRequest 审核拒绝作者请求
type RejectAuthorRequest struct {
    Reason string `json:"reason" binding:"required"` // 拒绝原因
}

// RewardAuthorRequest 奖励作者请求
type RewardAuthorRequest struct {
    Type        string `json:"type" binding:"required"`        // 奖励类型：points-积分、currency-货币、level-等级提升
    Amount      int64  `json:"amount" binding:"required"`      // 奖励数量
    Description string `json:"description,omitempty"`          // 奖励描述
}

// PunishAuthorRequest 惩罚作者请求
type PunishAuthorRequest struct {
    Type        string `json:"type" binding:"required"`        // 惩罚类型：points-扣除积分、level-降低等级、ban-封禁
    Amount      int64  `json:"amount,omitempty"`              // 惩罚数量（如扣除积分数量）
    Reason      string `json:"reason" binding:"required"`      // 惩罚原因
    Description string `json:"description,omitempty"`          // 惩罚描述
}
```

### 3. 实现ApproveAuthor方法

在authorService实现中添加ApproveAuthor方法：

```go
// ApproveAuthor 审核通过作者
func (s *authorService) ApproveAuthor(ctx context.Context, authorID int64) error {
    // 检查作者是否存在
    author, err := s.authorRepo.GetByID(ctx, authorID)
    if err != nil {
        return err
    }
    
    // 检查作者是否已经激活
    if author.IsActive {
        return fmt.Errorf("作者已经激活，无需重复审核")
    }
    
    // 激活作者
    if err := s.authorRepo.UpdateStatus(ctx, authorID, true); err != nil {
        return fmt.Errorf("审核通过失败: %w", err)
    }
    
    log.Printf("作者 %d 审核通过", authorID)
    
    return nil
}
```

### 4. 实现RejectAuthor方法

在authorService实现中添加RejectAuthor方法：

```go
// RejectAuthor 审核拒绝作者
func (s *authorService) RejectAuthor(ctx context.Context, authorID int64, reason string) error {
    // 检查作者是否存在
    author, err := s.authorRepo.GetByID(ctx, authorID)
    if err != nil {
        return err
    }
    
    // 检查作者是否已经激活
    if author.IsActive {
        return fmt.Errorf("作者已经激活，无法拒绝审核")
    }
    
    // 可以在这里实现拒绝逻辑，例如：
    // 1. 记录拒绝原因（可以在数据库中存储）
    // 2. 发送通知给作者
    // 3. 删除作者（可选）
    
    log.Printf("作者 %d 审核被拒绝，原因: %s", authorID, reason)
    
    // 如果需要删除被拒绝的作者，可以调用Delete方法
    // if err := s.authorRepo.Delete(ctx, authorID); err != nil {
    //     return fmt.Errorf("删除被拒绝的作者失败: %w", err)
    // }
    
    return nil
}
```

### 5. 实现RewardAuthor方法

在authorService实现中添加RewardAuthor方法：

```go
// RewardAuthor 奖励作者
func (s *authorService) RewardAuthor(ctx context.Context, authorID int64, req *dto.RewardAuthorRequest) error {
    // 检查作者是否存在
    author, err := s.authorRepo.GetByID(ctx, authorID)
    if err != nil {
        return err
    }
    
    // 根据奖励类型执行不同的奖励逻辑
    switch req.Type {
    case "points":
        // 奖励积分（需要积分服务，暂时省略）
        // if err := s.pointsService.AddPoints(ctx, authorID, req.Amount, req.Description); err != nil {
        //     return fmt.Errorf("奖励积分失败: %w", err)
        // }
        log.Printf("作者 %d 获得 %d 积分奖励，描述: %s", authorID, req.Amount, req.Description)
        
    case "currency":
        // 奖励货币（需要货币服务，暂时省略）
        // if err := s.currencyService.AddCurrency(ctx, authorID, req.Amount, req.Description); err != nil {
        //     return fmt.Errorf("奖励货币失败: %w", err)
        // }
        log.Printf("作者 %d 获得 %d 货币奖励，描述: %s", authorID, req.Amount, req.Description)
        
    case "level":
        // 提升等级（需要等级服务，暂时省略）
        // if err := s.levelService.UpgradeLevel(ctx, authorID); err != nil {
        //     return fmt.Errorf("提升等级失败: %w", err)
        // }
        log.Printf("作者 %d 等级提升，描述: %s", authorID, req.Description)
        
    default:
        return fmt.Errorf("不支持的奖励类型: %s", req.Type)
    }
    
    return nil
}
```

### 6. 实现PunishAuthor方法

在authorService实现中添加PunishAuthor方法：

```go
// PunishAuthor 惩罚作者
func (s *authorService) PunishAuthor(ctx context.Context, authorID int64, req *dto.PunishAuthorRequest) error {
    // 检查作者是否存在
    author, err := s.authorRepo.GetByID(ctx, authorID)
    if err != nil {
        return err
    }
    
    // 根据惩罚类型执行不同的惩罚逻辑
    switch req.Type {
    case "points":
        // 扣除积分（需要积分服务，暂时省略）
        // if err := s.pointsService.DeductPoints(ctx, authorID, req.Amount, req.Reason); err != nil {
        //     return fmt.Errorf("扣除积分失败: %w", err)
        // }
        log.Printf("作者 %d 被扣除 %d 积分，原因: %s", authorID, req.Amount, req.Reason)
        
    case "level":
        // 降低等级（需要等级服务，暂时省略）
        // if err := s.levelService.DowngradeLevel(ctx, authorID); err != nil {
        //     return fmt.Errorf("降低等级失败: %w", err)
        // }
        log.Printf("作者 %d 等级降低，原因: %s", authorID, req.Reason)
        
    case "ban":
        // 封禁作者
        if err := s.BanAuthor(ctx, authorID, req.Reason, nil); err != nil {
            return fmt.Errorf("封禁作者失败: %w", err)
        }
        log.Printf("作者 %d 被封禁，原因: %s", authorID, req.Reason)
        
    default:
        return fmt.Errorf("不支持的惩罚类型: %s", req.Type)
    }
    
    return nil
}
```

### 7. 添加必要的导入

```go
package service

import (
    "context"
    "fmt"
    "log"
    
    "yourproject/internal/dto"
    "yourproject/internal/repository"
)
```

### 8. 注意事项

- **审核逻辑**：审核通过激活作者，审核拒绝可以记录原因或删除作者
- **奖励类型**：支持积分、货币、等级提升等多种奖励类型
- **惩罚类型**：支持扣除积分、降低等级、封禁等多种惩罚类型
- **服务依赖**：奖励和惩罚功能可能需要依赖其他服务（积分服务、货币服务、等级服务等），暂时使用日志记录，后续任务实现
- **错误处理**：所有错误消息必须使用中文
- **操作日志**：记录所有审核、奖励、惩罚操作日志

## 验收标准

1. **接口扩展完整**
   - AuthorService接口包含ApproveAuthor、RejectAuthor、RewardAuthor、PunishAuthor方法
   - 方法签名正确

2. **DTO定义完整**
   - RejectAuthorRequest结构体定义完整
   - RewardAuthorRequest结构体定义完整
   - PunishAuthorRequest结构体定义完整

3. **实现完整**
   - ApproveAuthor方法正确实现
   - RejectAuthor方法正确实现
   - RewardAuthor方法正确实现
   - PunishAuthor方法正确实现

4. **错误处理**
   - 所有错误都被正确处理
   - 错误消息清晰、具体，使用中文

5. **代码规范**
   - 遵循Golang编码规范
   - 注释完整，使用中文

## 相关文件

- `internal/service/author_service.go` - AuthorService接口和实现文件（需要扩展）
- `internal/dto/author_dto.go` - 作者DTO文件（需要扩展）
- `.cursor/rules/coding-standards.mdc` - Golang编码规范

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

