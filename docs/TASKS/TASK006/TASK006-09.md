# TASK006-09: 编写JWTService扩展单元测试

## 任务信息

**任务编号**: TASK006-09  
**父任务**: TASK006  
**任务名称**: 编写JWTService扩展单元测试  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

编写JWT服务扩展的单元测试。包括：1) 测试作者token生成和验证功能；2) 测试token黑名单功能；3) 测试过期token处理；4) 确保测试覆盖率达标。所有测试用例描述必须使用中文。参考TASK005-10 JWT服务单元测试。

## 依赖任务

TASK006-08（扩展JWTService支持作者token）

## 实现指南

### 1. 创建测试文件

在 `internal/service/` 目录下创建或扩展 `jwt_service_test.go` 文件，添加作者token相关测试。

### 2. 测试GenerateAuthorToken方法

```go
// TestJWTService_GenerateAuthorToken 测试生成作者token
func TestJWTService_GenerateAuthorToken(t *testing.T) {
    tests := []struct {
        name          string
        authorID      int64
        authorName    string
        authorTypeIDs pq.Int32Array
        wantErr       bool
    }{
        {
            name:          "生成有效作者token",
            authorID:      1,
            authorName:    "testauthor",
            authorTypeIDs: pq.Int32Array{1, 2},
            wantErr:       false,
        },
        {
            name:          "生成空类型数组token",
            authorID:      2,
            authorName:    "testauthor2",
            authorTypeIDs: pq.Int32Array{},
            wantErr:       false,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // 设置测试环境
            config := DefaultJWTConfig("test_secret_key")
            mockAuthorSessionRepo := new(MockAuthorSessionRepository)
            service := NewJWTService(config, nil, mockAuthorSessionRepo)
            
            // 设置Mock期望
            mockAuthorSessionRepo.On("Create", mock.Anything, mock.Anything).Return(nil)
            
            // 执行测试
            tokenPair, err := service.GenerateAuthorToken(
                tt.authorID,
                tt.authorName,
                tt.authorTypeIDs,
                nil,
                nil,
            )
            
            if tt.wantErr {
                require.Error(t, err)
            } else {
                require.NoError(t, err)
                assert.NotEmpty(t, tokenPair.AccessToken)
                assert.NotEmpty(t, tokenPair.RefreshToken)
                assert.False(t, tokenPair.ExpiresAt.IsZero())
            }
        })
    }
}
```

### 3. 测试ValidateAuthorToken方法

```go
// TestJWTService_ValidateAuthorToken 测试验证作者token
func TestJWTService_ValidateAuthorToken(t *testing.T) {
    config := DefaultJWTConfig("test_secret_key")
    mockAuthorSessionRepo := new(MockAuthorSessionRepository)
    service := NewJWTService(config, nil, mockAuthorSessionRepo)
    
    // 生成测试token
    tokenPair, err := service.GenerateAuthorToken(
        1,
        "testauthor",
        pq.Int32Array{1, 2},
        nil,
        nil,
    )
    require.NoError(t, err)
    
    tests := []struct {
        name    string
        token   string
        wantErr bool
        errMsg  string
    }{
        {
            name:    "验证有效token",
            token:   tokenPair.AccessToken,
            wantErr: false,
        },
        {
            name:    "验证无效token",
            token:   "invalid_token",
            wantErr: true,
            errMsg:  "解析token失败",
        },
        {
            name:    "验证黑名单token",
            token:   tokenPair.AccessToken,
            wantErr: true,
            errMsg:  "token已被加入黑名单",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            if tt.name == "验证黑名单token" {
                // 设置黑名单
                mockAuthorSessionRepo.On("IsBlacklisted", mock.Anything, tt.token).Return(true, nil)
            } else {
                mockAuthorSessionRepo.On("IsBlacklisted", mock.Anything, tt.token).Return(false, nil)
            }
            
            claims, err := service.ValidateAuthorToken(tt.token)
            
            if tt.wantErr {
                require.Error(t, err)
                if tt.errMsg != "" {
                    assert.Contains(t, err.Error(), tt.errMsg)
                }
            } else {
                require.NoError(t, err)
                assert.NotNil(t, claims)
                assert.Equal(t, int64(1), claims.AuthorID)
                assert.Equal(t, "testauthor", claims.AuthorName)
            }
        })
    }
}
```

### 4. 测试RefreshAuthorToken方法

```go
// TestJWTService_RefreshAuthorToken 测试刷新作者token
func TestJWTService_RefreshAuthorToken(t *testing.T) {
    config := DefaultJWTConfig("test_secret_key")
    mockAuthorSessionRepo := new(MockAuthorSessionRepository)
    service := NewJWTService(config, nil, mockAuthorSessionRepo)
    
    // 生成测试refresh token
    tokenPair, err := service.GenerateAuthorToken(
        1,
        "testauthor",
        pq.Int32Array{1, 2},
        nil,
        nil,
    )
    require.NoError(t, err)
    
    // 设置Mock期望
    mockAuthorSessionRepo.On("IsBlacklisted", mock.Anything, tokenPair.RefreshToken).Return(false, nil)
    mockAuthorSessionRepo.On("BlacklistToken", mock.Anything, tokenPair.RefreshToken).Return(nil)
    mockAuthorSessionRepo.On("Create", mock.Anything, mock.Anything).Return(nil)
    
    // 执行测试
    newTokenPair, err := service.RefreshAuthorToken(tokenPair.RefreshToken)
    
    require.NoError(t, err)
    assert.NotEmpty(t, newTokenPair.AccessToken)
    assert.NotEmpty(t, newTokenPair.RefreshToken)
    assert.NotEqual(t, tokenPair.AccessToken, newTokenPair.AccessToken)
}
```

### 5. 测试token黑名单功能

```go
// TestJWTService_AuthorTokenBlacklist 测试作者token黑名单
func TestJWTService_AuthorTokenBlacklist(t *testing.T) {
    config := DefaultJWTConfig("test_secret_key")
    mockAuthorSessionRepo := new(MockAuthorSessionRepository)
    service := NewJWTService(config, nil, mockAuthorSessionRepo)
    
    // 生成测试token
    tokenPair, err := service.GenerateAuthorToken(
        1,
        "testauthor",
        pq.Int32Array{1},
        nil,
        nil,
    )
    require.NoError(t, err)
    
    // 测试加入黑名单
    mockAuthorSessionRepo.On("BlacklistToken", mock.Anything, tokenPair.AccessToken).Return(nil)
    err = service.BlacklistToken(tokenPair.AccessToken)
    require.NoError(t, err)
    
    // 测试检查黑名单
    mockAuthorSessionRepo.On("IsBlacklisted", mock.Anything, tokenPair.AccessToken).Return(true, nil)
    isBlacklisted, err := service.IsBlacklisted(tokenPair.AccessToken)
    require.NoError(t, err)
    assert.True(t, isBlacklisted)
}
```

### 6. 测试过期token处理

```go
// TestJWTService_ExpiredAuthorToken 测试过期作者token
func TestJWTService_ExpiredAuthorToken(t *testing.T) {
    // 创建短期过期的配置
    config := &JWTConfig{
        SecretKey:          []byte("test_secret_key"),
        AccessTokenExpiry: 1 * time.Millisecond,
        RefreshTokenExpiry: 1 * time.Millisecond,
        Issuer:            "test",
    }
    mockAuthorSessionRepo := new(MockAuthorSessionRepository)
    service := NewJWTService(config, nil, mockAuthorSessionRepo)
    
    // 生成token
    mockAuthorSessionRepo.On("Create", mock.Anything, mock.Anything).Return(nil)
    tokenPair, err := service.GenerateAuthorToken(
        1,
        "testauthor",
        pq.Int32Array{1},
        nil,
        nil,
    )
    require.NoError(t, err)
    
    // 等待token过期
    time.Sleep(10 * time.Millisecond)
    
    // 验证过期token
    mockAuthorSessionRepo.On("IsBlacklisted", mock.Anything, tokenPair.AccessToken).Return(false, nil)
    _, err = service.ValidateAuthorToken(tokenPair.AccessToken)
    require.Error(t, err)
    assert.Contains(t, err.Error(), "token已过期")
}
```

### 7. 注意事项

- **Mock使用**：使用Mock Repository进行测试，避免依赖真实数据库
- **测试覆盖**：确保测试覆盖所有新增的方法和场景
- **边界情况**：测试空数组、nil值等边界情况
- **错误处理**：测试各种错误场景
- **测试描述**：所有测试用例名称使用中文

## 验收标准

1. **测试覆盖完整**
   - GenerateAuthorToken方法有完整测试
   - ValidateAuthorToken方法有完整测试
   - RefreshAuthorToken方法有完整测试
   - 黑名单功能有完整测试

2. **测试覆盖率**
   - 测试覆盖率达到80%以上
   - 使用go test -cover检查覆盖率

3. **测试描述**
   - 所有测试用例名称使用中文
   - 错误消息使用中文

4. **代码规范**
   - 遵循Golang测试规范
   - 使用testify进行断言
   - 使用Mock进行依赖隔离

## 相关文件

- `internal/service/jwt_service.go` - JWTService接口和实现文件
- `docs/TASKS/TASK005/TASK005-10.md` - JWT服务单元测试参考
- `.cursor/rules/testing.mdc` - Golang单元测试规范
- `internal/service/jwt_service_test.go` - JWTService单元测试文件（需要扩展）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

