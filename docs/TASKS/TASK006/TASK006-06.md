# TASK006-06: 编写AuthorRepository单元测试

## 任务信息

**任务编号**: TASK006-06  
**父任务**: TASK006  
**任务名称**: 编写AuthorRepository单元测试  
**版本信息**: v1.2.0  
**当前状态**: 计划中  
**创建时间**: 2026-01-03 20:48:19 CST

## 任务描述

编写作者仓储层单元测试。包括：1) 测试AuthorRepository的所有方法；2) 测试正常情况、边界情况和异常情况；3) 测试数组查询（author_type_ids）；4) 使用测试数据库或Mock进行测试；5) 确保测试覆盖率达标（80%以上）。所有测试用例描述和错误消息必须使用中文。参考TASK005-06用户仓储层单元测试。

## 依赖任务

TASK006-04（实现AuthorRepository接口和实现）

## 实现指南

### 1. 创建测试文件

在 `internal/repository/` 目录下创建 `author_repository_test.go` 文件：

```go
package repository

import (
    "context"
    "testing"
    "time"
    
    "github.com/lib/pq"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    "github.com/stretchr/testify/suite"
    "gorm.io/driver/postgres"
    "gorm.io/gorm"
    "yourproject/internal/models"
)
```

### 2. 创建测试套件

使用testify/suite创建测试套件，便于管理测试数据库和共享测试资源：

```go
// AuthorRepositoryTestSuite AuthorRepository测试套件
type AuthorRepositoryTestSuite struct {
    suite.Suite
    db     *gorm.DB
    repo   AuthorRepository
    ctx    context.Context
}

// SetupSuite 测试套件初始化
func (s *AuthorRepositoryTestSuite) SetupSuite() {
    // 连接测试数据库
    dsn := "host=localhost user=test password=test dbname=test_db port=5432 sslmode=disable"
    db, err := gorm.Open(postgres.Open(dsn), &gorm.Config{})
    require.NoError(s.T(), err, "连接测试数据库失败")
    
    s.db = db
    s.repo = NewAuthorRepository(db)
    s.ctx = context.Background()
    
    // 自动迁移
    err = db.AutoMigrate(&models.Author{})
    require.NoError(s.T(), err, "数据库迁移失败")
}

// TearDownSuite 测试套件清理
func (s *AuthorRepositoryTestSuite) TearDownSuite() {
    // 清理测试数据
    s.db.Exec("TRUNCATE TABLE authors CASCADE")
    
    // 关闭数据库连接
    sqlDB, _ := s.db.DB()
    sqlDB.Close()
}

// SetupTest 每个测试前的准备
func (s *AuthorRepositoryTestSuite) SetupTest() {
    // 清理测试数据
    s.db.Exec("TRUNCATE TABLE authors CASCADE")
}

// TearDownTest 每个测试后的清理
func (s *AuthorRepositoryTestSuite) TearDownTest() {
    // 清理测试数据
    s.db.Exec("TRUNCATE TABLE authors CASCADE")
}
```

### 3. 测试Create方法

```go
// TestAuthorRepository_Create 测试创建作者
func (s *AuthorRepositoryTestSuite) TestAuthorRepository_Create() {
    tests := []struct {
        name    string
        author  *models.Author
        wantErr bool
        errMsg  string
    }{
        {
            name: "创建有效作者",
            author: &models.Author{
                AuthorName:   "testauthor",
                Email:        "test@example.com",
                PasswordHash: "hashed_password",
                AuthorTypeIDs: pq.Int32Array{1, 2},
                IsActive:     true,
            },
            wantErr: false,
        },
        {
            name: "创建重复作者名",
            author: &models.Author{
                AuthorName:   "testauthor",
                Email:        "test2@example.com",
                PasswordHash: "hashed_password",
                AuthorTypeIDs: pq.Int32Array{1},
            },
            wantErr: true,
            errMsg:  "作者已存在",
        },
        {
            name: "创建重复邮箱",
            author: &models.Author{
                AuthorName:   "testauthor2",
                Email:        "test@example.com",
                PasswordHash: "hashed_password",
                AuthorTypeIDs: pq.Int32Array{1},
            },
            wantErr: true,
            errMsg:  "作者已存在",
        },
    }

    for _, tt := range tests {
        s.Run(tt.name, func() {
            err := s.repo.Create(s.ctx, tt.author)
            if tt.wantErr {
                require.Error(s.T(), err)
                if tt.errMsg != "" {
                    assert.Contains(s.T(), err.Error(), tt.errMsg)
                }
            } else {
                require.NoError(s.T(), err)
                assert.NotZero(s.T(), tt.author.ID)
            }
        })
    }
}
```

### 4. 测试GetByID方法

```go
// TestAuthorRepository_GetByID 测试根据ID获取作者
func (s *AuthorRepositoryTestSuite) TestAuthorRepository_GetByID() {
    // 创建测试作者
    author := &models.Author{
        AuthorName:   "testauthor",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
        AuthorTypeIDs: pq.Int32Array{1, 2},
    }
    err := s.repo.Create(s.ctx, author)
    require.NoError(s.T(), err)

    tests := []struct {
        name    string
        id      int64
        wantErr bool
        errMsg  string
    }{
        {
            name:    "获取存在的作者",
            id:      author.ID,
            wantErr: false,
        },
        {
            name:    "获取不存在的作者",
            id:      99999,
            wantErr: true,
            errMsg:  "作者不存在",
        },
    }

    for _, tt := range tests {
        s.Run(tt.name, func() {
            got, err := s.repo.GetByID(s.ctx, tt.id)
            if tt.wantErr {
                require.Error(s.T(), err)
                assert.Nil(s.T(), got)
                if tt.errMsg != "" {
                    assert.Contains(s.T(), err.Error(), tt.errMsg)
                }
            } else {
                require.NoError(s.T(), err)
                assert.NotNil(s.T(), got)
                assert.Equal(s.T(), tt.id, got.ID)
            }
        })
    }
}
```

### 5. 测试GetAll方法（包括数组查询）

```go
// TestAuthorRepository_GetAll 测试获取作者列表
func (s *AuthorRepositoryTestSuite) TestAuthorRepository_GetAll() {
    // 创建测试数据
    authors := []*models.Author{
        {
            AuthorName:   "author1",
            Email:        "author1@example.com",
            PasswordHash: "hash1",
            AuthorTypeIDs: pq.Int32Array{1}, // 小说作者
            IsActive:     true,
        },
        {
            AuthorName:   "author2",
            Email:        "author2@example.com",
            PasswordHash: "hash2",
            AuthorTypeIDs: pq.Int32Array{2}, // 漫画作者
            IsActive:     true,
        },
        {
            AuthorName:   "author3",
            Email:        "author3@example.com",
            PasswordHash: "hash3",
            AuthorTypeIDs: pq.Int32Array{1, 2}, // 小说和漫画作者
            IsActive:     false,
        },
    }
    
    for _, author := range authors {
        err := s.repo.Create(s.ctx, author)
        require.NoError(s.T(), err)
    }

    tests := []struct {
        name     string
        params   *AuthorQueryParams
        wantLen  int
        wantErr  bool
    }{
        {
            name: "获取所有作者",
            params: &AuthorQueryParams{
                Page:  1,
                Limit: 10,
            },
            wantLen: 3,
            wantErr: false,
        },
        {
            name: "按作者名筛选",
            params: &AuthorQueryParams{
                Page:       1,
                Limit:      10,
                AuthorName: "author1",
            },
            wantLen: 1,
            wantErr: false,
        },
        {
            name: "按激活状态筛选",
            params: &AuthorQueryParams{
                Page:     1,
                Limit:    10,
                IsActive: func() *bool { b := true; return &b }(),
            },
            wantLen: 2,
            wantErr: false,
        },
        {
            name: "按作者类型筛选（包含类型1）",
            params: &AuthorQueryParams{
                Page:         1,
                Limit:        10,
                AuthorTypeIDs: []int32{1},
            },
            wantLen: 2, // author1和author3都包含类型1
            wantErr: false,
        },
        {
            name: "按作者类型筛选（包含类型2）",
            params: &AuthorQueryParams{
                Page:         1,
                Limit:        10,
                AuthorTypeIDs: []int32{2},
            },
            wantLen: 2, // author2和author3都包含类型2
            wantErr: false,
        },
        {
            name: "分页测试",
            params: &AuthorQueryParams{
                Page:  1,
                Limit: 2,
            },
            wantLen: 2,
            wantErr: false,
        },
    }

    for _, tt := range tests {
        s.Run(tt.name, func() {
            got, total, err := s.repo.GetAll(s.ctx, tt.params)
            if tt.wantErr {
                require.Error(s.T(), err)
            } else {
                require.NoError(s.T(), err)
                assert.Len(s.T(), got, tt.wantLen)
                assert.GreaterOrEqual(s.T(), total, int64(tt.wantLen))
            }
        })
    }
}
```

### 6. 测试Update方法

```go
// TestAuthorRepository_Update 测试更新作者
func (s *AuthorRepositoryTestSuite) TestAuthorRepository_Update() {
    // 创建测试作者
    author := &models.Author{
        AuthorName:   "testauthor",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
        AuthorTypeIDs: pq.Int32Array{1},
    }
    err := s.repo.Create(s.ctx, author)
    require.NoError(s.T(), err)

    // 更新作者信息
    author.AuthorName = "updatedauthor"
    author.AuthorTypeIDs = pq.Int32Array{1, 2}
    err = s.repo.Update(s.ctx, author)
    require.NoError(s.T(), err)

    // 验证更新
    updated, err := s.repo.GetByID(s.ctx, author.ID)
    require.NoError(s.T(), err)
    assert.Equal(s.T(), "updatedauthor", updated.AuthorName)
    assert.Equal(s.T(), pq.Int32Array{1, 2}, updated.AuthorTypeIDs)
}
```

### 7. 测试Delete方法

```go
// TestAuthorRepository_Delete 测试删除作者
func (s *AuthorRepositoryTestSuite) TestAuthorRepository_Delete() {
    // 创建测试作者
    author := &models.Author{
        AuthorName:   "testauthor",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
        AuthorTypeIDs: pq.Int32Array{1},
    }
    err := s.repo.Create(s.ctx, author)
    require.NoError(s.T(), err)

    // 删除作者
    err = s.repo.Delete(s.ctx, author.ID)
    require.NoError(s.T(), err)

    // 验证删除
    _, err = s.repo.GetByID(s.ctx, author.ID)
    require.Error(s.T(), err)
    assert.Contains(s.T(), err.Error(), "作者不存在")
}
```

### 8. 测试ExistsByAuthorName、ExistsByEmail、ExistsByPhone方法

```go
// TestAuthorRepository_ExistsByAuthorName 测试检查作者名是否存在
func (s *AuthorRepositoryTestSuite) TestAuthorRepository_ExistsByAuthorName() {
    // 创建测试作者
    author := &models.Author{
        AuthorName:   "testauthor",
        Email:        "test@example.com",
        PasswordHash: "hashed_password",
        AuthorTypeIDs: pq.Int32Array{1},
    }
    err := s.repo.Create(s.ctx, author)
    require.NoError(s.T(), err)

    // 测试存在的作者名
    exists, err := s.repo.ExistsByAuthorName(s.ctx, "testauthor")
    require.NoError(s.T(), err)
    assert.True(s.T(), exists)

    // 测试不存在的作者名
    exists, err = s.repo.ExistsByAuthorName(s.ctx, "nonexistent")
    require.NoError(s.T(), err)
    assert.False(s.T(), exists)
}
```

### 9. 运行测试套件

```go
// TestAuthorRepositoryTestSuite 运行测试套件
func TestAuthorRepositoryTestSuite(t *testing.T) {
    suite.Run(t, new(AuthorRepositoryTestSuite))
}
```

### 10. 注意事项

- **测试数据库**：使用独立的测试数据库，避免影响生产数据
- **数据清理**：每个测试前后清理测试数据，确保测试独立性
- **数组查询测试**：特别注意测试author_type_ids数组查询的各种场景
- **覆盖率要求**：确保测试覆盖率达到80%以上
- **测试用例描述**：所有测试用例名称和错误消息使用中文
- **边界情况**：测试空值、无效ID、数组为空等边界情况

## 验收标准

1. **测试覆盖完整**
   - 所有AuthorRepository方法都有测试用例
   - 测试覆盖正常情况、边界情况、异常情况

2. **数组查询测试**
   - 测试author_type_ids数组查询的各种场景
   - 测试包含、不包含、多个类型等查询

3. **测试覆盖率**
   - 测试覆盖率达到80%以上
   - 使用go test -cover检查覆盖率

4. **测试独立性**
   - 每个测试用例独立，不依赖其他测试
   - 测试前后清理数据

5. **测试描述**
   - 所有测试用例名称使用中文
   - 错误消息使用中文

6. **代码规范**
   - 遵循Golang测试规范
   - 使用testify进行断言
   - 使用表驱动测试

## 相关文件

- `internal/repository/author_repository.go` - AuthorRepository接口和实现文件
- `docs/TASKS/TASK005/TASK005-06.md` - 用户仓储层单元测试参考
- `.cursor/rules/testing.mdc` - Golang单元测试规范
- `internal/repository/author_repository_test.go` - AuthorRepository单元测试文件（待创建）

## Git 提交信息任务

任务完成后，需要生成 Git 提交信息。请根据实际修改内容生成合适的提交信息。

---

**文档版本**: 1.0  
**最后更新**: 2026-01-03 20:48:19 CST

