# 日志模块需求文档

## 文档说明

本文档为 LNCms 项目日志模块的详细需求文档，基于功能描述文档编写，遵循项目开发规范。

**文档版本**: 1.0  
**最后更新**: 2026-01-02 20:19:00 CST  
**编写依据**: [日志模块功能概述](../Features/Log.md)

## 目录

- [概述](#概述)
- [功能需求](#功能需求)
- [非功能需求](#非功能需求)
- [接口需求](#接口需求)
- [数据需求](#数据需求)
- [安全需求](#安全需求)
- [验收标准](#验收标准)

## 概述

### 模块概述

日志模块（Log）为程序日志模块，负责提供项目日志记录、查询、分析功能。日志模块支持日志写入、日志归档、日志查询、日志统计、日志导出和健康检查等功能，为系统运行监控和问题排查提供支持。

### 技术栈

- **开发语言**: Golang 1.24+
- **开发框架**: Gin
- **数据库**: PostgreSQL
- **缓存**: Redis
- **API 规范**: OpenAPI 3.1.1

### 模块通信

#### gRPC 通信

- 对外提供 gRPC 接口服务
- 核心模块、存储模块、采集模块通过 gRPC 接口与日志模块进行通信
- 模块间使用 gRPC 均支持双向通信
- gRPC 接口用于模块间日志写入和日志查询等操作

## 功能需求

### 1. 日志存储

日志存储功能提供日志写入和日志归档等核心功能，支持多种日志级别、日志分类和自动归档等特性。

#### 1.1 日志写入

**功能描述**: 各模块通过 gRPC 接口将统一格式的日志信息写入日志模块，日志模块负责接收、验证、存储日志数据。

**业务流程**:

1. **日志接收**: 各模块通过 gRPC 接口提交日志信息到日志模块
2. **日志验证**: 日志模块验证日志数据的完整性和格式正确性
3. **日志分类**: 根据日志类型、日志级别、模块来源等信息对日志进行分类
4. **缓存写入**: 将日志信息写入 Redis 缓存，提高写入性能
5. **数据库写入**: 将日志信息异步写入 PostgreSQL 数据库
6. **写入确认**: 返回写入结果给调用模块

**日志字段**:

- **日志ID** (log_id): UUID 类型，唯一标识符，由日志模块生成
- **模块名称** (module_name): 字符串类型，必填，标识日志来源模块（如 core、storage、crawler）
- **日志类型** (log_type): 枚举类型，必填，可选值：system（系统日志）、operation（操作日志）、error（错误日志）、access（访问日志）
- **日志级别** (log_level): 枚举类型，必填，可选值：debug、info、warn、error、fatal
- **日志标题** (log_title): 字符串类型，必填，长度限制 1-200 字符
- **日志内容** (log_content): 文本类型，必填，长度限制 0-10000 字符
- **用户ID** (user_id): 整数类型，可选，关联用户ID（操作日志和访问日志必填）
- **请求ID** (request_id): 字符串类型，可选，关联请求唯一标识符
- **IP地址** (ip_address): 字符串类型，可选，IPv4 或 IPv6 格式
- **用户代理** (user_agent): 字符串类型，可选，长度限制 0-500 字符
- **扩展数据** (extra_data): JSONB 类型，可选，存储额外的结构化数据
- **创建时间** (created_at): 时间戳类型，必填，自动设置为当前时间

**数据验证**:

- 模块名称：字符串类型，必填，长度限制 1-50 字符，只能包含字母、数字和下划线
- 日志类型：枚举类型，必填，必须是预定义的值之一
- 日志级别：枚举类型，必填，必须是预定义的值之一
- 日志标题：字符串类型，必填，长度限制 1-200 字符，不能为空
- 日志内容：文本类型，必填，长度限制 0-10000 字符
- IP地址：字符串类型，可选，必须是有效的 IPv4 或 IPv6 格式
- 用户代理：字符串类型，可选，长度限制 0-500 字符

**业务规则**:

- 日志ID由日志模块自动生成，使用 UUID v4 格式
- 日志写入采用异步方式，先写入 Redis 缓存，再异步写入数据库
- 相同请求ID的日志可以关联查询
- 扩展数据使用 JSONB 格式存储，支持高效查询
- 日志写入失败时，应记录错误信息但不影响调用模块的正常运行

#### 1.2 日志归档

**功能描述**: 日志模块根据日志配置要求，自动将过期日志进行归档处理，支持归档策略配置和归档文件管理。

**业务流程**:

1. **归档策略检查**: 定时任务检查日志归档策略配置
2. **过期日志识别**: 根据归档策略识别需要归档的日志（如超过30天的日志）
3. **归档文件生成**: 将过期日志导出为归档文件（如 CSV、JSON 格式）
4. **归档文件存储**: 将归档文件存储到指定位置（本地文件系统或远程存储）
5. **数据库清理**: 归档完成后，从数据库中删除已归档的日志记录
6. **归档记录**: 记录归档操作信息，包括归档时间、归档文件路径、归档记录数等

**归档策略配置**:

- **归档周期** (archive_interval): 整数类型，必填，归档任务执行周期（单位：小时），默认 24 小时
- **保留天数** (retention_days): 整数类型，必填，日志保留天数，超过此天数的日志将被归档，默认 30 天
- **归档格式** (archive_format): 枚举类型，必填，可选值：csv、json、jsonl，默认 jsonl
- **归档路径** (archive_path): 字符串类型，必填，归档文件存储路径
- **压缩开关** (compress_enabled): 布尔类型，必填，是否压缩归档文件，默认 true
- **压缩格式** (compress_format): 枚举类型，可选，可选值：gzip、zip，默认 gzip（仅在压缩开关为 true 时有效）

**数据验证**:

- 归档周期：整数类型，必填，范围 1-168 小时（1小时到7天）
- 保留天数：整数类型，必填，范围 1-3650 天（1天到10年）
- 归档格式：枚举类型，必填，必须是预定义的值之一
- 归档路径：字符串类型，必填，必须是有效的文件系统路径
- 压缩格式：枚举类型，可选，必须是预定义的值之一

**业务规则**:

- 归档任务通过定时任务自动执行，执行周期可配置
- 归档操作应在系统低峰期执行，避免影响正常业务
- 归档文件命名格式：`logs_YYYYMMDD_HHMMSS.format[.compress]`（如 `logs_20260102_120000.jsonl.gz`）
- 归档完成后，应验证归档文件的完整性
- 归档记录应包含归档统计信息（归档记录数、归档文件大小等）
- 归档失败时，应记录错误信息并通知管理员

### 2. 日志查询

日志查询功能提供核心模块进行日志查询的功能，支持日志列表、分类日志、日志筛选、日志查询和日志导出等功能。

#### 2.1 日志列表

**功能描述**: 提供分页查询日志列表的功能，支持按时间、模块、类型、级别等条件筛选。

**查询参数**:

- **页码** (page): 整数类型，可选，默认 1，范围 1-10000
- **每页数量** (limit): 整数类型，可选，默认 20，范围 1-100
- **模块名称** (module_name): 字符串类型，可选，筛选指定模块的日志
- **日志类型** (log_type): 枚举类型，可选，筛选指定类型的日志
- **日志级别** (log_level): 枚举类型，可选，筛选指定级别的日志
- **开始时间** (start_time): 时间戳类型，可选，筛选创建时间大于等于此时间的日志
- **结束时间** (end_time): 时间戳类型，可选，筛选创建时间小于等于此时间的日志
- **用户ID** (user_id): 整数类型，可选，筛选指定用户的日志
- **排序字段** (sort_by): 字符串类型，可选，排序字段，可选值：created_at、log_level，默认 created_at
- **排序方向** (sort_order): 枚举类型，可选，排序方向，可选值：asc、desc，默认 desc

**数据验证**:

- 页码：整数类型，可选，默认 1，最小值 1
- 每页数量：整数类型，可选，默认 20，范围 1-100
- 模块名称：字符串类型，可选，长度限制 1-50 字符
- 日志类型：枚举类型，可选，必须是预定义的值之一
- 日志级别：枚举类型，可选，必须是预定义的值之一
- 开始时间：时间戳类型，可选，必须是有效的 ISO 8601 格式
- 结束时间：时间戳类型，可选，必须是有效的 ISO 8601 格式，且必须大于等于开始时间
- 用户ID：整数类型，可选，必须是有效的正整数
- 排序字段：字符串类型，可选，必须是预定义的字段之一
- 排序方向：枚举类型，可选，必须是 asc 或 desc

**业务规则**:

- 查询结果按创建时间倒序排列（最新的在前）
- 支持分页查询，使用标准分页参数（page、limit）
- 查询结果包含日志的基本信息（ID、标题、内容、级别、时间等）
- 查询性能优化：对常用查询字段建立索引
- 查询结果使用 Envelope 格式返回，包含分页信息

#### 2.2 分类日志

**功能描述**: 提供按日志类型、日志级别、模块名称等维度分类查询日志的功能。

**查询维度**:

- **按日志类型分类**: 统计各类型日志的数量和列表（系统日志、操作日志、错误日志、访问日志）
- **按日志级别分类**: 统计各级别日志的数量和列表（debug、info、warn、error、fatal）
- **按模块名称分类**: 统计各模块日志的数量和列表
- **按时间分类**: 按小时、天、周、月等时间维度统计日志数量

**查询参数**:

- **分类维度** (dimension): 枚举类型，必填，可选值：type（日志类型）、level（日志级别）、module（模块名称）、time（时间维度）
- **时间维度** (time_dimension): 枚举类型，可选，可选值：hour（小时）、day（天）、week（周）、month（月），仅在分类维度为 time 时有效
- **开始时间** (start_time): 时间戳类型，可选，统计开始时间
- **结束时间** (end_time): 时间戳类型，可选，统计结束时间

**数据验证**:

- 分类维度：枚举类型，必填，必须是预定义的值之一
- 时间维度：枚举类型，可选，必须是预定义的值之一
- 开始时间：时间戳类型，可选，必须是有效的 ISO 8601 格式
- 结束时间：时间戳类型，可选，必须是有效的 ISO 8601 格式，且必须大于等于开始时间

**业务规则**:

- 分类统计结果包含各分类的数量和占比
- 支持多维度组合查询（如按模块和类型同时分类）
- 统计结果支持排序（按数量降序或升序）
- 查询性能优化：使用聚合查询和索引优化

#### 2.3 日志筛选

**功能描述**: 提供高级筛选功能，支持多条件组合筛选日志。

**筛选条件**:

- **关键词搜索** (keyword): 字符串类型，可选，在日志标题和内容中搜索关键词
- **模块名称** (module_name): 字符串类型，可选，精确匹配模块名称
- **日志类型** (log_type): 枚举类型，可选，精确匹配日志类型
- **日志级别** (log_level): 枚举类型，可选，精确匹配日志级别，支持多选
- **用户ID** (user_id): 整数类型，可选，精确匹配用户ID
- **请求ID** (request_id): 字符串类型，可选，精确匹配请求ID
- **IP地址** (ip_address): 字符串类型，可选，精确匹配或模糊匹配IP地址
- **时间范围** (time_range): 对象类型，可选，包含开始时间和结束时间
- **扩展数据筛选** (extra_filter): JSON 对象类型，可选，根据扩展数据中的字段进行筛选

**数据验证**:

- 关键词：字符串类型，可选，长度限制 1-100 字符
- 模块名称：字符串类型，可选，长度限制 1-50 字符
- 日志类型：枚举类型，可选，必须是预定义的值之一
- 日志级别：数组类型，可选，数组元素必须是预定义的级别值之一
- 用户ID：整数类型，可选，必须是有效的正整数
- 请求ID：字符串类型，可选，长度限制 1-100 字符
- IP地址：字符串类型，可选，必须是有效的 IPv4 或 IPv6 格式
- 时间范围：对象类型，可选，必须包含有效的开始时间和结束时间
- 扩展数据筛选：JSON 对象类型，可选，必须是有效的 JSON 格式

**业务规则**:

- 支持多条件组合筛选，条件之间为 AND 关系
- 关键词搜索支持全文检索（如果数据库支持）
- 日志级别支持多选，使用 OR 关系
- 扩展数据筛选支持嵌套字段查询
- 筛选结果支持分页和排序
- 复杂筛选查询应优化性能，避免全表扫描

#### 2.4 日志查询

**功能描述**: 提供根据日志ID、请求ID等唯一标识符查询单条日志详情的功能。

**查询方式**:

- **按日志ID查询**: 根据日志ID查询单条日志的详细信息
- **按请求ID查询**: 根据请求ID查询关联的所有日志（支持分页）

**查询参数**:

- **日志ID** (log_id): UUID 类型，必填（按日志ID查询时）
- **请求ID** (request_id): 字符串类型，必填（按请求ID查询时）
- **页码** (page): 整数类型，可选，默认 1（按请求ID查询时）
- **每页数量** (limit): 整数类型，可选，默认 20（按请求ID查询时）

**数据验证**:

- 日志ID：UUID 类型，必填，必须是有效的 UUID 格式
- 请求ID：字符串类型，必填，长度限制 1-100 字符
- 页码：整数类型，可选，默认 1，最小值 1
- 每页数量：整数类型，可选，默认 20，范围 1-100

**业务规则**:

- 按日志ID查询返回单条日志的完整信息
- 按请求ID查询返回关联的所有日志列表（支持分页）
- 查询结果包含日志的所有字段信息
- 查询不存在的日志时，返回 404 错误

#### 2.5 日志导出

**功能描述**: 提供将查询结果导出为文件的功能，支持多种导出格式。

**导出格式**:

- **CSV 格式**: 导出为 CSV 文件，适合 Excel 等工具打开
- **JSON 格式**: 导出为 JSON 文件，保持数据结构
- **JSONL 格式**: 导出为 JSON Lines 文件，每行一个 JSON 对象

**导出参数**:

- **导出格式** (format): 枚举类型，必填，可选值：csv、json、jsonl
- **查询条件**: 使用与日志列表查询相同的查询参数
- **导出字段** (fields): 数组类型，可选，指定要导出的字段，默认导出所有字段
- **文件名称** (filename): 字符串类型，可选，导出文件名称，默认使用时间戳生成

**数据验证**:

- 导出格式：枚举类型，必填，必须是预定义的值之一
- 导出字段：数组类型，可选，数组元素必须是有效的字段名
- 文件名称：字符串类型，可选，长度限制 1-255 字符，不能包含路径分隔符

**业务规则**:

- 导出操作异步执行，先创建导出任务，完成后通知用户下载
- 导出文件大小限制：单次导出不超过 100MB（约 100 万条记录）
- 导出文件临时存储，保留 24 小时后自动删除
- 导出任务支持进度查询
- 导出文件命名格式：`logs_YYYYMMDD_HHMMSS.format`（如 `logs_20260102_120000.csv`）
- 大量数据导出时，应分批处理，避免内存溢出

### 3. 日志统计

日志统计功能提供核心模块进行日志统计的功能，支持日志统计和日志分析等功能。

#### 3.1 日志统计

**功能描述**: 提供日志数量、分布、趋势等统计信息。

**统计维度**:

- **总体统计**: 日志总数、各类型日志数量、各级别日志数量
- **时间统计**: 按小时、天、周、月统计日志数量趋势
- **模块统计**: 各模块日志数量分布
- **级别统计**: 各级别日志数量分布
- **错误统计**: 错误日志数量、错误率、错误趋势

**统计参数**:

- **统计维度** (dimension): 枚举类型，必填，可选值：overall（总体）、time（时间）、module（模块）、level（级别）、error（错误）
- **时间维度** (time_dimension): 枚举类型，可选，可选值：hour（小时）、day（天）、week（周）、month（月），仅在统计维度为 time 时有效
- **开始时间** (start_time): 时间戳类型，可选，统计开始时间
- **结束时间** (end_time): 时间戳类型，可选，统计结束时间
- **模块名称** (module_name): 字符串类型，可选，筛选指定模块的统计

**数据验证**:

- 统计维度：枚举类型，必填，必须是预定义的值之一
- 时间维度：枚举类型，可选，必须是预定义的值之一
- 开始时间：时间戳类型，可选，必须是有效的 ISO 8601 格式
- 结束时间：时间戳类型，可选，必须是有效的 ISO 8601 格式，且必须大于等于开始时间
- 模块名称：字符串类型，可选，长度限制 1-50 字符

**业务规则**:

- 统计结果包含数量、占比、趋势等信息
- 时间统计支持图表数据格式（时间序列数据）
- 统计查询应优化性能，使用聚合查询和缓存
- 大量数据统计时，应使用采样或预聚合数据
- 统计结果支持导出为图表数据格式（JSON）

#### 3.2 日志分析

**功能描述**: 提供日志深度分析功能，包括错误分析、性能分析、用户行为分析等。

**分析类型**:

- **错误分析**: 分析错误日志的类型、频率、趋势、关联关系
- **性能分析**: 分析访问日志的响应时间、吞吐量、慢请求等
- **用户行为分析**: 分析用户操作日志的行为模式、热点功能等
- **异常检测**: 检测异常日志模式，如突增、突降、异常峰值等

**分析参数**:

- **分析类型** (analysis_type): 枚举类型，必填，可选值：error（错误分析）、performance（性能分析）、behavior（用户行为分析）、anomaly（异常检测）
- **开始时间** (start_time): 时间戳类型，可选，分析开始时间
- **结束时间** (end_time): 时间戳类型，可选，分析结束时间
- **分析深度** (depth): 枚举类型，可选，可选值：basic（基础）、detailed（详细）、deep（深度），默认 basic
- **模块名称** (module_name): 字符串类型，可选，筛选指定模块的分析

**数据验证**:

- 分析类型：枚举类型，必填，必须是预定义的值之一
- 开始时间：时间戳类型，可选，必须是有效的 ISO 8601 格式
- 结束时间：时间戳类型，可选，必须是有效的 ISO 8601 格式，且必须大于等于开始时间
- 分析深度：枚举类型，可选，必须是预定义的值之一
- 模块名称：字符串类型，可选，长度限制 1-50 字符

**业务规则**:

- 分析操作可能耗时较长，应异步执行
- 分析结果包含分析报告、图表数据、建议等
- 深度分析应使用机器学习或统计分析算法
- 分析结果支持导出和分享
- 异常检测应支持告警功能

### 4. 健康检查

健康检查功能提供核心模块健康检查接口，支持运行状态和连接数值查询等功能。

#### 4.1 运行状态

**功能描述**: 提供日志模块的运行状态信息，包括服务状态、版本信息、启动时间等。

**状态信息**:

- **服务状态** (status): 枚举类型，可选值：running（运行中）、stopped（已停止）、error（错误）
- **版本信息** (version): 字符串类型，服务版本号
- **启动时间** (start_time): 时间戳类型，服务启动时间
- **运行时长** (uptime): 整数类型，服务运行时长（单位：秒）
- **最后心跳时间** (last_heartbeat): 时间戳类型，最后心跳时间

**业务规则**:

- 服务状态实时更新，反映当前服务运行情况
- 心跳机制定期更新最后心跳时间
- 服务异常时，状态应更新为 error

#### 4.2 连接数值

**功能描述**: 提供日志模块的连接数值信息，包括数据库连接数、Redis 连接数、gRPC 连接数等。

**连接信息**:

- **数据库连接数** (db_connections): 对象类型，包含：
  - 当前连接数 (current): 整数类型
  - 最大连接数 (max): 整数类型
  - 空闲连接数 (idle): 整数类型
- **Redis 连接数** (redis_connections): 对象类型，包含：
  - 当前连接数 (current): 整数类型
  - 最大连接数 (max): 整数类型
  - 空闲连接数 (idle): 整数类型
- **gRPC 连接数** (grpc_connections): 对象类型，包含：
  - 当前连接数 (current): 整数类型
  - 活跃连接数 (active): 整数类型

**业务规则**:

- 连接数值实时更新，反映当前连接使用情况
- 连接数超过阈值时，应记录告警信息
- 连接信息用于监控和性能优化

## 非功能需求

### 性能需求

- **日志写入性能**: 支持每秒至少 10000 条日志写入（单机）
- **日志查询性能**: 单次查询响应时间不超过 500ms（正常情况）
- **日志统计性能**: 统计查询响应时间不超过 2s（正常情况）
- **并发处理**: 支持至少 1000 个并发 gRPC 连接

### 可用性需求

- **服务可用性**: 服务可用性达到 99.9% 以上
- **数据可靠性**: 日志数据不丢失，支持数据备份和恢复
- **故障恢复**: 服务故障后能在 5 分钟内自动恢复

### 可扩展性需求

- **水平扩展**: 支持多实例部署，通过负载均衡分发请求
- **存储扩展**: 支持日志数据分库分表，应对大数据量
- **功能扩展**: 支持插件化扩展，便于添加新的日志处理功能

### 可维护性需求

- **日志记录**: 日志模块自身操作应记录详细日志
- **监控告警**: 支持监控指标采集和告警功能
- **配置管理**: 支持配置热更新，无需重启服务

## 接口需求

### gRPC 接口

日志模块通过 gRPC 接口对外提供服务，所有接口遵循 gRPC 规范。

#### 日志写入接口

- **服务名**: `log.LogService`
- **方法名**: `WriteLog`
- **请求参数**: `WriteLogRequest`
  - `module_name` (string): 模块名称
  - `log_type` (enum): 日志类型
  - `log_level` (enum): 日志级别
  - `log_title` (string): 日志标题
  - `log_content` (string): 日志内容
  - `user_id` (int64, optional): 用户ID
  - `request_id` (string, optional): 请求ID
  - `ip_address` (string, optional): IP地址
  - `user_agent` (string, optional): 用户代理
  - `extra_data` (map<string, any>, optional): 扩展数据
- **响应参数**: `WriteLogResponse`
  - `log_id` (string): 日志ID
  - `success` (bool): 是否成功
  - `message` (string): 响应消息

#### 日志查询接口

- **服务名**: `log.LogService`
- **方法名**: `QueryLogs`
- **请求参数**: `QueryLogsRequest`
  - `page` (int32, optional): 页码
  - `limit` (int32, optional): 每页数量
  - `module_name` (string, optional): 模块名称
  - `log_type` (enum, optional): 日志类型
  - `log_level` (enum, optional): 日志级别
  - `start_time` (timestamp, optional): 开始时间
  - `end_time` (timestamp, optional): 结束时间
  - `user_id` (int64, optional): 用户ID
  - `sort_by` (string, optional): 排序字段
  - `sort_order` (enum, optional): 排序方向
- **响应参数**: `QueryLogsResponse`
  - `logs` (repeated Log): 日志列表
  - `total` (int64): 总记录数
  - `page` (int32): 当前页码
  - `limit` (int32): 每页数量

#### 日志统计接口

- **服务名**: `log.LogService`
- **方法名**: `GetLogStatistics`
- **请求参数**: `GetLogStatisticsRequest`
  - `dimension` (enum): 统计维度
  - `time_dimension` (enum, optional): 时间维度
  - `start_time` (timestamp, optional): 开始时间
  - `end_time` (timestamp, optional): 结束时间
  - `module_name` (string, optional): 模块名称
- **响应参数**: `GetLogStatisticsResponse`
  - `statistics` (map<string, any>): 统计结果
  - `timestamp` (timestamp): 统计时间

#### 健康检查接口

- **服务名**: `log.LogService`
- **方法名**: `HealthCheck`
- **请求参数**: `HealthCheckRequest`（空）
- **响应参数**: `HealthCheckResponse`
  - `status` (enum): 服务状态
  - `version` (string): 版本信息
  - `start_time` (timestamp): 启动时间
  - `uptime` (int64): 运行时长
  - `connections` (Connections): 连接信息

## 数据需求

### 数据库设计

#### 日志表 (logs)

**表名**: `logs`

**字段定义**:

- `id` (BIGSERIAL): 主键，自增
- `log_id` (UUID): 日志唯一标识符，唯一索引
- `module_name` (VARCHAR(50)): 模块名称，索引
- `log_type` (VARCHAR(20)): 日志类型，索引
- `log_level` (VARCHAR(20)): 日志级别，索引
- `log_title` (VARCHAR(200)): 日志标题
- `log_content` (TEXT): 日志内容
- `user_id` (BIGINT, nullable): 用户ID，索引
- `request_id` (VARCHAR(100), nullable): 请求ID，索引
- `ip_address` (VARCHAR(45), nullable): IP地址
- `user_agent` (VARCHAR(500), nullable): 用户代理
- `extra_data` (JSONB, nullable): 扩展数据
- `created_at` (TIMESTAMPTZ): 创建时间，索引
- `archived_at` (TIMESTAMPTZ, nullable): 归档时间

**索引设计**:

- 主键索引: `pk_logs` (id)
- 唯一索引: `uk_logs_log_id` (log_id)
- 普通索引: `idx_logs_module_name` (module_name)
- 普通索引: `idx_logs_log_type` (log_type)
- 普通索引: `idx_logs_log_level` (log_level)
- 普通索引: `idx_logs_user_id` (user_id)
- 普通索引: `idx_logs_request_id` (request_id)
- 普通索引: `idx_logs_created_at` (created_at)
- 复合索引: `idx_logs_module_type_level` (module_name, log_type, log_level)
- 复合索引: `idx_logs_created_at_level` (created_at, log_level)
- GIN 索引: `idx_logs_extra_data` (extra_data) - 用于 JSONB 字段查询

**表注释**:

```sql
COMMENT ON TABLE logs IS '日志表，存储系统所有模块的日志信息';
COMMENT ON COLUMN logs.id IS '主键ID';
COMMENT ON COLUMN logs.log_id IS '日志唯一标识符，UUID格式';
COMMENT ON COLUMN logs.module_name IS '模块名称，标识日志来源模块';
COMMENT ON COLUMN logs.log_type IS '日志类型：system-系统日志，operation-操作日志，error-错误日志，access-访问日志';
COMMENT ON COLUMN logs.log_level IS '日志级别：debug、info、warn、error、fatal';
COMMENT ON COLUMN logs.log_title IS '日志标题，简要描述日志内容';
COMMENT ON COLUMN logs.log_content IS '日志内容，详细描述日志信息';
COMMENT ON COLUMN logs.user_id IS '用户ID，关联用户表，操作日志和访问日志必填';
COMMENT ON COLUMN logs.request_id IS '请求唯一标识符，用于关联同一请求的多个日志';
COMMENT ON COLUMN logs.ip_address IS 'IP地址，IPv4或IPv6格式';
COMMENT ON COLUMN logs.user_agent IS '用户代理，浏览器或客户端信息';
COMMENT ON COLUMN logs.extra_data IS '扩展数据，JSON格式，存储额外的结构化数据';
COMMENT ON COLUMN logs.created_at IS '日志创建时间';
COMMENT ON COLUMN logs.archived_at IS '日志归档时间，归档后设置此字段';
```

#### 归档记录表 (log_archives)

**表名**: `log_archives`

**字段定义**:

- `id` (BIGSERIAL): 主键，自增
- `archive_id` (UUID): 归档唯一标识符，唯一索引
- `archive_path` (VARCHAR(500)): 归档文件路径
- `archive_format` (VARCHAR(20)): 归档格式
- `archive_size` (BIGINT): 归档文件大小（字节）
- `record_count` (BIGINT): 归档记录数
- `start_time` (TIMESTAMPTZ): 归档开始时间
- `end_time` (TIMESTAMPTZ): 归档结束时间
- `created_at` (TIMESTAMPTZ): 创建时间

**索引设计**:

- 主键索引: `pk_log_archives` (id)
- 唯一索引: `uk_log_archives_archive_id` (archive_id)
- 普通索引: `idx_log_archives_created_at` (created_at)

**表注释**:

```sql
COMMENT ON TABLE log_archives IS '日志归档记录表，记录日志归档操作信息';
COMMENT ON COLUMN log_archives.id IS '主键ID';
COMMENT ON COLUMN log_archives.archive_id IS '归档唯一标识符，UUID格式';
COMMENT ON COLUMN log_archives.archive_path IS '归档文件存储路径';
COMMENT ON COLUMN log_archives.archive_format IS '归档格式：csv、json、jsonl';
COMMENT ON COLUMN log_archives.archive_size IS '归档文件大小，单位字节';
COMMENT ON COLUMN log_archives.record_count IS '归档记录数';
COMMENT ON COLUMN log_archives.start_time IS '归档开始时间（归档的日志时间范围开始）';
COMMENT ON COLUMN log_archives.end_time IS '归档结束时间（归档的日志时间范围结束）';
COMMENT ON COLUMN log_archives.created_at IS '归档记录创建时间';
```

### 缓存设计

#### Redis 数据结构

**日志写入缓存**:

- **键名格式**: `log:write:{log_id}`
- **数据类型**: Hash
- **字段**: 与日志表字段对应
- **过期时间**: 1 小时（写入数据库后删除）

**日志查询缓存**:

- **键名格式**: `log:query:{hash}`（hash 为查询参数的哈希值）
- **数据类型**: String（JSON 格式）
- **内容**: 查询结果
- **过期时间**: 5 分钟

**统计结果缓存**:

- **键名格式**: `log:stats:{dimension}:{hash}`
- **数据类型**: String（JSON 格式）
- **内容**: 统计结果
- **过期时间**: 10 分钟

## 安全需求

### 数据安全

- **数据加密**: 敏感日志数据（如用户密码、Token 等）应进行脱敏处理，不在日志中记录明文
- **访问控制**: 日志查询和统计功能需要权限验证，普通用户只能查看自己的操作日志
- **数据备份**: 定期备份日志数据，防止数据丢失

### 接口安全

- **gRPC 认证**: gRPC 接口使用 TLS 加密传输，支持 mTLS 双向认证
- **请求验证**: 验证请求来源，防止未授权访问
- **限流保护**: 对日志写入和查询接口实施限流，防止滥用

### 日志安全

- **敏感信息过滤**: 自动过滤日志中的敏感信息（密码、Token、身份证号等）
- **日志完整性**: 确保日志不被篡改，支持日志签名验证
- **访问审计**: 记录日志查询和导出操作，便于审计

## 验收标准

### 功能验收

- [ ] 日志写入功能正常，支持所有日志类型和级别
- [ ] 日志归档功能正常，按配置自动执行归档
- [ ] 日志查询功能正常，支持所有查询方式
- [ ] 日志统计功能正常，统计结果准确
- [ ] 日志导出功能正常，支持所有导出格式
- [ ] 健康检查功能正常，状态信息准确

### 性能验收

- [ ] 日志写入性能达到 10000 条/秒（单机）
- [ ] 日志查询响应时间不超过 500ms（正常情况）
- [ ] 日志统计响应时间不超过 2s（正常情况）
- [ ] 支持至少 1000 个并发 gRPC 连接

### 安全验收

- [ ] gRPC 接口使用 TLS 加密
- [ ] 敏感信息自动脱敏
- [ ] 访问控制功能正常
- [ ] 日志数据不被篡改

### 可用性验收

- [ ] 服务可用性达到 99.9% 以上
- [ ] 故障恢复时间不超过 5 分钟
- [ ] 数据备份和恢复功能正常

---

**文档结束**

